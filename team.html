
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>My Carers</title>
  
    <!-- favicon links -->
    <link rel="icon" type="image/png" sizes="16x16" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-32x32.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <style>
        
        :root {
            --primary-color: #004990;
            --primary-dark: #003670;
            --primary-light: #0056b3;
            --success-color: #88a542;
            --info-color: #359dca;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f8f9fa;
            --bg-dark: #1a2332;
            --border-color: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 70px; /* Space for mobile nav */
        }

        /* Header with Profile Banner */
        .header {
            background: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .profile-banner {
    position: relative;
    height: 150px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    cursor: pointer;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

/* Add a class when banner has an image */
.profile-banner.has-image .banner-overlay {
    opacity: 0;
}

.profile-banner.has-image:hover .banner-overlay {
    opacity: 0.7;  /* Show on hover to allow changing */
}

.banner-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.5);
    color: white;
    opacity: 0.7;  /* Show by default when no image */
    transition: opacity 0.3s;
}
        .profile-info {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .user-details h2 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .user-role {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        .search-dropdown {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-dropdown-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}

.search-dropdown-item:hover {
    background: #f5f5f5;
}

.search-dropdown-item.selected {
    background: #e3f2fd;
}
        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: var(--text-light);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item .badge {
            position: absolute;
            top: 4px;
            right: calc(50% - 20px);
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 16px;
        }

        /* Content Sections */
        .content-section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .dashboard-header {
            margin-bottom: 20px;
        }

        .greeting {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .date-display {
            color: var(--text-light);
            font-size: 14px;
        }

        .shift-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .shift-card:active {
            transform: scale(0.98);
        }

        .shift-card-header {
            padding: 20px;
            position: relative;
        }

        .shift-time {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .shift-participant {
            font-size: 16px;
            opacity: 0.95;
            margin-bottom: 4px;
        }

        .shift-location {
            font-size: 14px;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shift-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .shift-expand-icon {
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .shift-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(255,255,255,0.95);
            color: var(--text-dark);
        }

        .shift-card.expanded .shift-details {
            max-height: 500px;
        }

        .shift-card.expanded .shift-expand-icon {
            transform: rotate(180deg);
        }

        .handover-section {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .handover-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .handover-note {
            background: var(--bg-light);
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .handover-author {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .quick-action-btn:active {
            transform: scale(0.95);
            background: var(--bg-light);
        }

        .quick-action-btn .icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        /* Requests Summary */
        .requests-summary {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .requests-summary h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-dark);
        }

        .request-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-type {
            font-size: 14px;
            font-weight: 500;
        }

        .request-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-denied {
            background: #f8d7da;
            color: #721c24;
        }

        /* Timesheet View */
        .period-selector {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .period-display {
            text-align: center;
            flex: 1;
        }

        .period-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .period-dates {
            font-size: 16px;
            font-weight: 600;
        }

        .period-nav {
            padding: 8px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
        }

        /* Timesheet Summary */
        .timesheet-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .timesheet-summary h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        .hours-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .hour-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: var(--radius-md);
        }

        .hour-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .hour-value {
            font-size: 20px;
            font-weight: 600;
        }

        .total-section {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 16px;
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 600;
        }

        /* Shift List */
        .shift-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .shift-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .shift-list-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-list-item:last-child {
            border-bottom: none;
        }

        .shift-info {
            flex: 1;
        }

        .shift-date-time {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .shift-client {
            font-size: 14px;
            color: var(--text-light);
        }

        .shift-hours {
            text-align: right;
        }

        .btn {
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
}

.btn-secondary:hover {
    background: #d0d0d0;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 12px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-dark);
}

.btn-outline:hover {
    background: var(--bg-light);
}

        .shift-hours-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .shift-pay {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Schedule View */
        .calendar-header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .participant-filter {
            margin-bottom: 12px;
        }

        .participant-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: white;
        }

        .date-range-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-light);
            margin-top: 12px;
        }

        .schedule-grid {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .day-section {
            border-bottom: 1px solid var(--border-color);
        }

        .day-section:last-child {
            border-bottom: none;
        }

        .day-header {
            background: var(--bg-light);
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-date {
            font-size: 14px;
        }

        .fortnight-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--border-color);
    margin-top: 20px;
}

.schedule-day {
    background: white;
    min-height: 100px;
    padding: 8px;
}

.schedule-day.weekend {
    background: #f8f9fa;
}

.schedule-day.today {
    background: #e3f2fd;
}

.day-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border-color);
}

.day-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--text-light);
}

.day-date {
    font-weight: 600;
    font-size: 14px;
}

.shift-block {
    background: var(--primary-color);
    color: white;
    padding: 4px 6px;
    border-radius: 4px;
    margin-bottom: 4px;
    font-size: 11px;
}

.no-shift {
    color: var(--text-light);
    font-size: 11px;
    text-align: center;
    margin-top: 10px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}



        .day-shift-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .day-shifts {
            padding: 8px;
        }

        .schedule-shift {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-shift:last-child {
            margin-bottom: 0;
        }

        .schedule-shift-time {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .schedule-shift-staff {
            font-size: 13px;
            color: var(--text-light);
        }

        .schedule-shift-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .action-btn.secondary {
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        /* Transfers View */
        .transfer-tabs {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 16px;
            display: flex;
            box-shadow: var(--shadow-sm);
        }

        .transfer-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            font-weight: 500;
            transition: all 0.3s;
        }

        .transfer-tab:last-child {
            border-right: none;
        }

        .transfer-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .transfer-list {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .transfer-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .transfer-item:last-child {
            margin-bottom: 0;
        }

        .transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .transfer-date {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .transfer-time {
            font-size: 14px;
            color: var(--text-light);
        }

        .transfer-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .transfer-from {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .transfer-reason {
            font-size: 13px;
            color: var(--text-light);
            font-style: italic;
            padding: 8px;
            background: white;
            border-radius: var(--radius-sm);
            margin-top: 8px;
        }

        .transfer-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .transfer-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .transfer-btn.accept {
            background: var(--success-color);
            color: white;
        }

        .transfer-btn.decline {
            background: white;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        /* Profile View */
        .profile-section {
            background: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .profile-section-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-btn {
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .profile-content {
            padding: 16px;
        }

        .profile-field {
            margin-bottom: 16px;
        }

        .profile-field:last-child {
            margin-bottom: 0;
        }

        .field-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .field-value {
            font-size: 16px;
            color: var(--text-dark);
        }

        .field-value input,
        .field-value select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 16px;
        }

        /* Documents Section */
        .document-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .document-upload-area:hover {
            border-color: var(--primary-color);
            background: var(--bg-light);
        }

        .document-list {
            display: grid;
            gap: 12px;
        }

        .document-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 12px;
            color: var(--text-light);
        }

        .document-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Availability Pattern */
        .availability-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 16px;
        }

        .availability-day {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .availability-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .day-name {
            font-weight: 600;
        }

        .availability-toggle {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .availability-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        .availability-toggle input:checked + .toggle-slider {
            background: var(--success-color);
        }

        .availability-toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .availability-times {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .time-slot {
            padding: 8px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Modal System */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 73, 144, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Image Upload for Notes */
        .image-upload-area {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        .add-image-btn {
            width: 60px;
            height: 60px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-light);
        }

        /* Notifications */
        .notification-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .notification-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.unread {
            background: #f0f8ff;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-icon.info {
            background: #cce5ff;
            color: #004085;
        }

        .notification-icon.success {
            background: #d4edda;
            color: #155724;
        }

        .notification-icon.warning {
            background: #fff3cd;
            color: #856404;
        }

        .notification-content {
            flex: 1;
        }

        .notification-message {
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            animation: slideUp 0.3s ease-out;
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* Desktop Responsiveness */
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }

            .mobile-nav {
                display: none;
            }

            .desktop-nav {
                display: flex;
                background: white;
                border-bottom: 1px solid var(--border-color);
                padding: 0 20px;
            }

            .desktop-nav .nav-item {
                padding: 16px 24px;
                border-bottom: 3px solid transparent;
                transition: all 0.3s;
            }

            .desktop-nav .nav-item.active {
                border-bottom-color: var(--primary-color);
            }

            .content-section {
                max-width: 1200px;
                margin: 0 auto;
                padding: 40px;
            }

            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }

            .hours-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .document-list {
                grid-template-columns: repeat(2, 1fr);
            }

            .availability-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 600; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .p-2 { padding: 16px; }
        .hidden { display: none; }

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.form-legend {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--text-dark);
    border: none;
    padding: 0;
}

.form-help {
    display: block;
    margin-top: 4px;
    font-size: 12px;
    color: var(--text-light);
}

.error-message {
    display: none;
    margin-top: 4px;
    font-size: 12px;
    color: var(--danger-color);
    font-weight: 500;
}

.error-message.show {
    display: block;
}

.form-control:invalid {
    border-color: var(--danger-color);
}

.form-control:invalid + .error-message {
    display: block;
}

/* Navigation improvements */
.nav-item {
    border: none;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s;
}

.nav-item:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

.nav-item[aria-selected="true"] {
    color: var(--primary-color);
}

/* Modal improvements */
.modal[aria-hidden="true"] {
    display: none;
}

.modal[aria-hidden="false"] {
    display: flex;
}

.modal-close:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* Header improvements */
.header {
    background: white;
    border-bottom: 1px solid var(--border-color);
    padding: 0;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.logo img {
    max-height: 40px;
    width: auto;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-name {
    font-weight: 500;
    color: var(--text-dark);
}

.user-role {
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
}

/* Image upload improvements */
.add-image-btn {
    width: 60px;
    height: 60px;
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 24px;
    color: var(--text-light);
}

.add-image-btn:hover,
.add-image-btn:focus {
    border-color: var(--primary-color);
    color: var(--primary-color);
    outline: none;
}

.image-upload-area {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 8px;
}

#imagePreviewContainer {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.image-preview {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius-md);
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
}

.image-preview:hover {
    border-color: var(--danger-color);
    opacity: 0.8;
}

.weekly-schedule {
    background: white;
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.day-section {
    border-bottom: 1px solid var(--border-color);
}

.day-section:last-child {
    border-bottom: none;
}

.day-section.today {
    background: #f0f8ff;
}

.day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--bg-light);
    border-bottom: 1px solid var(--border-color);
}

.day-name {
    font-weight: 600;
    font-size: 16px;
}

.shift-count {
    background: var(--primary-color);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.shift-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light);
    transition: background 0.2s;
}

.shift-item:hover {
    background: var(--bg-light);
}

.shift-item:last-child {
    border-bottom: none;
}

.no-shifts {
    padding: 20px;
    text-align: center;
    color: var(--text-light);
    font-style: italic;
}

.shift-history-item {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
}

.shift-date-header {
    font-weight: 600;
    margin-bottom: 8px;
}
    </style>

    
</head>
<body>
     <!-- Header with Profile Banner -->
     <header class="header">
        <div class="profile-info">
            <div class="user-details">
                <h2 id="userName">Loading...</h2>
                <span class="user-role" id="userRole">Staff</span>
            </div>
            <button class="btn btn-sm btn-outline" data-action="logout">Logout</button>
        </div>
    </header>

    <!-- Desktop Navigation (hidden on mobile) -->
    <nav class="desktop-nav hidden">
        <button class="nav-item" data-section="dashboard" 
                aria-label="Navigate to dashboard" 
                role="tab" 
                aria-selected="true">
            <div class="icon"><i class="fa-solid fa-house" aria-hidden="true"></i></div>
            <div>Home</div>
        </button>
        <div class="nav-item" data-section="timesheet">
            <span>Timesheet</span>
        </div>
        <div class="nav-item" data-section="schedule">
            <span>Schedule</span>
        </div>
        <div class="nav-item" data-section="transfers">
            <span>Transfers</span>
        </div>
        <div class="nav-item" data-section="profile">
            <span>Profile</span>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboard" class="content-section active">
        <div class="dashboard-header">
            <div class="greeting" id="greeting">Good morning!</div>
            <div class="date-display" id="currentDate">Monday, 5 January 2025</div>
        </div>

        <!-- Current/Upcoming Shift -->
        <div id="currentShift">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action-btn" data-action="showAddShiftModal">
                <span class="icon"><i class="fa-solid fa-plus"></i></span>
                <span>Add Shift</span>
            </div>
            <div class="quick-action-btn" data-action="showTransferModal">
                <span class="icon"><i class="fa-solid fa-arrow-right-arrow-left"></i></span>
                <span>Transfer Shift</span>
            </div>
            <div class="quick-action-btn" data-action="showAdjustmentModal">
                <span class="icon"><i class="fa-solid fa-clock"></i></span>
                <span>Adjust Time</span>
            </div>
            <div class="quick-action-btn" data-action="showLeaveModal">
                <span class="icon"><i class="fa-solid fa-umbrella-beach"></i></span>
                <span>Request Leave</span>
            </div>
        </div>
    
        <!-- Pending Requests Summary -->
        <div class="requests-summary">
            <h3>Pending Requests</h3>
            <div id="pendingRequestsList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Recent Notifications -->
        <div class="requests-summary">
            <h3>Recent Updates</h3>
            <div id="recentNotifications">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Timesheet Section -->
    <div id="timesheet" class="content-section">
        <div class="period-selector">
            <button class="period-nav" id="prevPeriodBtn">â—€</button>
            <div class="period-display">
                <div class="period-label">Pay Period</div>
                <div class="period-dates" id="periodDates">Loading...</div>
            </div>
            <button class="period-nav" id="nextPeriodBtn">â–¶</button>
        </div>
        <!-- Hours Summary -->
        <div class="timesheet-summary">
            <h3>Hours Breakdown</h3>
            <div class="hours-grid" id="hoursGrid">
                <!-- Will be populated dynamically -->
            </div>
            <div class="total-section">
                <span>Total Hours</span>
                <span id="totalHours">0.0h</span>
            </div>
        </div>

        <!-- Shift List with Toggle -->
        <div class="shift-list">
            <div class="shift-list-header">
                <h3>Shifts</h3>
                <div class="view-toggle">
                    <button class="toggle-btn active" data-timesheet-view="date">By Date</button>
                    <button class="toggle-btn" data-timesheet-view="participant">By Client</button>
                </div>
            </div>
            <div id="timesheetShifts">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Schedule Section -->
    <div id="schedule" class="content-section">
        <div class="calendar-header">
            <div class="participant-filter">
                <label class="field-label">Filter by Client</label>
                <select class="participant-select" id="participantFilter" onchange="filterSchedule()">
                    <option value="">All My Clients</option>
                </select>
            </div>
            <div class="date-range-info">
                <span>ðŸ“…</span>
                <span>Showing 2 weeks before and after today</span>
            </div>
        </div>

        <div class="schedule-grid" id="scheduleGrid">
            <!-- Will be populated dynamically -->
        </div>
    </div>

    <!-- Transfers Section -->
    <div id="transfers" class="content-section">
        <div class="transfer-tabs">
            <div class="transfer-tab active" data-transfer-tab="incoming">
                Incoming Requests
                <span class="badge" id="incomingCount">0</span>
            </div>
            <div class="transfer-tab" data-transfer-tab="outgoing">
                My Requests
            </div>
            <div class="transfer-tab" data-transfer-tab="available">
                Available Shifts
            </div>
        </div>

        <div id="incomingTransfers" class="transfer-content active">
            <div class="transfer-list" id="incomingList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <div id="outgoingTransfers" class="transfer-content">
            <div class="transfer-list" id="outgoingList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <div id="availableTransfers" class="transfer-content">
            <div class="transfer-list" id="availableList">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Profile Section -->
    <div id="profile" class="content-section">
        <div class="profile-banner" id="profileBanner" onclick="document.getElementById('bannerUpload').click()">
            <div class="banner-overlay">
                <i class="fas fa-camera"></i>
                <span>Tap to upload photo</span>
            </div>
            <input type="file" id="bannerUpload" accept="image/*" capture="environment" style="display: none;">
        </div>        
        
        <!-- Personal Information -->
        <div class="profile-section">
            <div class="profile-section-header">
                Personal Information
                <button class="edit-btn" data-action="editPersonalInfo">Edit</button>
            </div>
            <div class="profile-content" id="personalInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Contact Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Contact Details
                <button class="edit-btn" data-action="editContactInfo">Edit</button>
            </div>
            <div class="profile-content" id="contactInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Banking Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Banking & Super
                <button class="edit-btn" onclick="editBankingInfo()">Edit</button>
            </div>
            <div class="profile-content" id="bankingInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Documents -->
        <div class="profile-section">
            <div class="profile-section-header">
                Documents
            </div>
            <div class="profile-content">
                <div class="document-upload-area" onclick="showDocumentUploadModal()">
                    <div>ðŸ“Ž Upload Document</div>
                    <div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                        Click to upload certifications, ID, checks, etc.
                    </div>
                </div>
                <div class="document-list" id="documentList">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Availability Pattern -->
        <div class="profile-section">
            <div class="profile-section-header">
                Weekly Availability
                <button class="edit-btn" data-action="saveAvailability">Save</button>
            </div>
            <div class="profile-content">
                <div class="availability-grid" id="availabilityGrid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav" role="tablist" aria-label="Main navigation">
        <button class="nav-item active" 
                data-section="dashboard" 
                aria-label="Navigate to dashboard" 
                role="tab" 
                aria-selected="true"
                id="nav-dashboard">
            <div class="icon"><i class="fa-solid fa-house" aria-hidden="true"></i></div>
            <div>Home</div>
            <span class="badge hidden" id="homeBadge" aria-label="pending items">1</span>
        </button>
        
        <button class="nav-item" 
                data-section="timesheet" 
                aria-label="Navigate to timesheet" 
                role="tab" 
                aria-selected="false"
                id="nav-timesheet">
            <div class="icon"><i class="fa-solid fa-chart-bar" aria-hidden="true"></i></div>
            <div>Timesheet</div>
        </button>
        
        <button class="nav-item" 
                data-section="schedule" 
                aria-label="Navigate to schedule" 
                role="tab" 
                aria-selected="false"
                id="nav-schedule">
            <div class="icon"><i class="fa-solid fa-calendar-days" aria-hidden="true"></i></div>
            <div>Schedule</div>
        </button>
        
        <button class="nav-item" 
                onclick="switchSection('transfers')" 
                aria-label="Navigate to transfers" 
                role="tab" 
                aria-selected="false"
                id="nav-transfers">
            <div class="icon"><i class="fa-solid fa-arrow-right-arrow-left" aria-hidden="true"></i></div>
            <div>Transfers</div>
            <span class="badge hidden" id="transferBadge" aria-label="pending transfers">0</span>
        </button>
        
        <button class="nav-item" 
                data-section="profile" 
                aria-label="Navigate to profile" 
                role="tab" 
                aria-selected="false"
                id="nav-profile">
            <div class="icon"><i class="fa-solid fa-user" aria-hidden="true"></i></div>
            <div>Profile</div>
        </button>
    </nav>

    <!-- MODALS SECTION -->

    <!-- Profile Photo Editor Modal -->
<div id="photoEditorModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">Adjust Profile Banner</h3>
            <button class="modal-close" onclick="closePhotoEditor()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="cropperContainer" style="max-height: 400px;">
                <img id="imageToCrop" style="max-width: 100%;">
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="rotateCropper(-90)" class="edit-btn" style="background: var(--text-secondary);">
                    <i class="fas fa-rotate-left"></i> Rotate Left
                </button>
                <button onclick="rotateCropper(90)" class="edit-btn" style="background: var(--text-secondary);">
                    <i class="fas fa-rotate-right"></i> Rotate Right
                </button>
                <button onclick="resetCropper()" class="edit-btn" style="background: var(--text-secondary);">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="edit-btn" style="background: var(--text-secondary);" onclick="closePhotoEditor()">Cancel</button>
            <button class="edit-btn" onclick="saveCroppedImage()">Save Banner</button>
        </div>
    </div>
</div>

    <!-- Add Shift Modal -->
    <div id="addShiftModal" class="modal" role="dialog" aria-labelledby="addShiftTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="addShiftTitle" class="modal-title">Add New Shift</h3>
                <button class="modal-close" 
                        onclick="closeModal('addShiftModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="addShiftForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Shift Details</legend>
                        
                        <div class="form-group">
                            <label for="shiftDate" class="form-label">Date *</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="shiftDate" 
                                   name="shiftDate"
                                   required 
                                   aria-describedby="shiftDate-error">
                            <div id="shiftDate-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        <div class="form-group">
                            <label for="shiftParticipant" class="form-label">Client *</label>
                            <select class="form-control" 
                                    id="shiftParticipant" 
                                    name="shiftParticipant"
                                    required 
                                    onchange="onParticipantSelect('shiftParticipant', 'shiftLocation')"
                                    aria-describedby="shiftParticipant-error">
                                <option value="">Select Client</option>
                            </select>
                            <div id="shiftParticipant-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="shiftLocation" class="form-label">Location *</label>
                            <select class="form-control" 
                                    id="shiftLocation" 
                                    name="shiftLocation"
                                    required 
                                    aria-describedby="shiftLocation-error">
                                <option value="">Select Location</option>
                            </select>
                            <div id="shiftLocation-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="shiftDutyType" class="form-label">Shift Type *</label>
                            <select class="form-control" 
                                    id="shiftDutyType" 
                                    name="shiftDutyType"
                                    required 
                                    onchange="toggleTimeFields()"
                                    aria-describedby="shiftDutyType-error">
                                <option value="">Select Type</option>
                            </select>
                            <div id="shiftDutyType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset id="timeFields">
                            <legend class="sr-only">Shift Times</legend>
                            
                            <div class="form-group">
                                <label for="shiftStartTime" class="form-label">Start Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="shiftStartTime" 
                                       name="shiftStartTime"
                                       aria-describedby="shiftStartTime-help">
                                <small id="shiftStartTime-help" class="form-help">Leave blank for sleepover shifts</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="shiftEndTime" class="form-label">End Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="shiftEndTime" 
                                       name="shiftEndTime"
                                       aria-describedby="shiftEndTime-help">
                                <small id="shiftEndTime-help" class="form-help">Leave blank for sleepover shifts</small>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="shiftNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" 
                                      id="shiftNotes" 
                                      name="shiftNotes"
                                      placeholder="Any additional information..."
                                      rows="3"
                                      aria-describedby="shiftNotes-help"></textarea>
                            <small id="shiftNotes-help" class="form-help">Additional details about the shift</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('addShiftModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" data-action="submitShift" form="addShiftForm">
                    Submit for Approval
                </button>
            </footer>
        </div>
    </div>

    <!-- Transfer Shift Modal -->
<div id="transferShiftModal" class="modal" role="dialog" aria-labelledby="transferShiftTitle" aria-hidden="true">
    <div class="modal-content" role="document">
        <header class="modal-header">
            <h3 id="transferShiftTitle" class="modal-title">Transfer Shift</h3>
            <button class="modal-close" 
                    data-modal-close="transferShiftModal" 
                    aria-label="Close modal"
                    type="button">&times;</button>
        </header>
        
        <div class="modal-body">
            <form id="transferForm" novalidate>
                <fieldset>
                    <legend class="sr-only">Transfer Details</legend>
                    
                    <!-- MISSING: Shift selection dropdown -->
                    <div class="form-group">
                        <label for="transferShiftSelect" class="form-label">Select Shift to Transfer *</label>
                        <select class="form-control" 
                                id="transferShiftSelect" 
                                name="transferShiftSelect"
                                required
                                aria-describedby="transferShift-error">
                            <option value="">Select a shift</option>
                        </select>
                        <div id="transferShift-error" class="error-message" role="alert" aria-live="polite"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="transferToStaff" class="form-label">Transfer To *</label>
                        <input type="text" 
                               class="form-control" 
                               id="transferToStaffSearch" 
                               placeholder="Type to search staff..."
                               autocomplete="off">
                        <select class="form-control" 
                                id="transferToStaff" 
                                name="transferToStaff"
                                style="display: none;">
                            <option value="">Select staff member</option>
                        </select>
                        <div id="staffSearchResults" class="search-dropdown" style="display: none;"></div>
                    </div>
                    
                    <!-- Add warning div for conflicts -->
                    <div id="transferConflictWarning" style="display: none; margin-top: 10px;"></div>
                    
                    <div class="form-group">
                        <label for="transferReason" class="form-label">Reason *</label>
                        <textarea class="form-control" 
                                  id="transferReason" 
                                  name="transferReason"
                                  required 
                                  placeholder="Please provide a reason for the transfer..."
                                  rows="3"
                                  aria-describedby="transferReason-error transferReason-help"></textarea>
                        <small id="transferReason-help" class="form-help">Explain why you need to transfer this shift</small>
                        <div id="transferReason-error" class="error-message" role="alert" aria-live="polite"></div>
                    </div>
                </fieldset>
            </form>
        </div>
        
        <footer class="modal-footer">
            <button type="button" class="modal-btn secondary" data-modal-close="transferShiftModal">
                Cancel
            </button>
            <button type="submit" class="modal-btn primary" data-action="submitTransfer" form="transferForm">
                Send Transfer Request
            </button>
        </footer>
    </div>
</div>

    <!-- Time Adjustment Modal -->
    <div id="adjustmentModal" class="modal" role="dialog" aria-labelledby="adjustmentTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="adjustmentTitle" class="modal-title">Request Time Adjustment</h3>
                <button class="modal-close" 
                        data-modal-close="adjustmentModal" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="adjustmentForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Time Adjustment Details</legend>
                        
                        <div class="form-group">
                            <label for="adjustmentShift" class="form-label">Select Shift *</label>
                            <select class="form-control" 
                                    id="adjustmentShift" 
                                    name="adjustmentShift"
                                    required 
                                    onchange="loadShiftTimes()"
                                    aria-describedby="adjustmentShift-error">
                                <option value="">Select a shift</option>
                            </select>
                            <div id="adjustmentShift-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset>
                            <legend class="form-legend">New Times</legend>
                            
                            <div class="form-group">
                                <label for="adjustmentStartTime" class="form-label">New Start Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="adjustmentStartTime" 
                                       name="adjustmentStartTime"
                                       aria-describedby="adjustmentStartTime-help">
                                <small id="adjustmentStartTime-help" class="form-help">Current time will be shown when shift is selected</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="adjustmentEndTime" class="form-label">New End Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="adjustmentEndTime" 
                                       name="adjustmentEndTime"
                                       aria-describedby="adjustmentEndTime-help">
                                <small id="adjustmentEndTime-help" class="form-help">Current time will be shown when shift is selected</small>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="adjustmentReason" class="form-label">Reason for Adjustment *</label>
                            <textarea class="form-control" 
                                      id="adjustmentReason" 
                                      name="adjustmentReason"
                                      required 
                                      placeholder="Please explain the time adjustment..."
                                      rows="3"
                                      aria-describedby="adjustmentReason-error adjustmentReason-help"></textarea>
                            <small id="adjustmentReason-help" class="form-help">Explain why the times need to be adjusted</small>
                            <div id="adjustmentReason-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" data-modal-close="adjustmentModal">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" data-action="submitAdjustment" form="adjustmentForm">
                    Submit Request
                </button>
            </footer>
        </div>
    </div>

    <!-- Leave Request Modal -->
    <div id="leaveModal" class="modal" role="dialog" aria-labelledby="leaveTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="leaveTitle" class="modal-title">Request Leave</h3>
                <button class="modal-close" 
                        data-modal-close="leaveModal" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="leaveForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Leave Request Details</legend>
                        
                        <div class="form-group">
                            <label for="leaveType" class="form-label">Leave Type *</label>
                            <select class="form-control" 
                                    id="leaveType" 
                                    name="leaveType"
                                    required 
                                    aria-describedby="leaveType-error">
                                <option value="">Select type</option>
                                <option value="annual">Annual Leave</option>
                                <option value="sick">Sick Leave</option>
                                <option value="personal">Personal Leave</option>
                                <option value="unpaid">Unpaid Leave</option>
                            </select>
                            <div id="leaveType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset>
                            <legend class="form-legend">Leave Dates</legend>
                            
                            <div class="form-group">
                                <label for="leaveStartDate" class="form-label">Start Date *</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="leaveStartDate" 
                                       name="leaveStartDate"
                                       required 
                                       aria-describedby="leaveStartDate-error">
                                <div id="leaveStartDate-error" class="error-message" role="alert" aria-live="polite"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="leaveEndDate" class="form-label">End Date *</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="leaveEndDate" 
                                       name="leaveEndDate"
                                       required 
                                       aria-describedby="leaveEndDate-error">
                                <div id="leaveEndDate-error" class="error-message" role="alert" aria-live="polite"></div>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="leaveReason" class="form-label">Reason</label>
                            <textarea class="form-control" 
                                      id="leaveReason" 
                                      name="leaveReason"
                                      placeholder="Optional: Provide additional details..."
                                      rows="3"
                                      aria-describedby="leaveReason-help"></textarea>
                            <small id="leaveReason-help" class="form-help">Additional details about your leave request</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" data-modal-close="leaveModal">
                    Cancel
                </button>
                <button type="button" class="modal-btn primary" data-action="submitLeave">
                    Submit Request
                </button>
            </footer>
        </div>
    </div>

    <!-- Document Upload Modal -->
    <div id="documentUploadModal" class="modal" role="dialog" aria-labelledby="documentUploadTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="documentUploadTitle" class="modal-title">Upload Document</h3>
                <button class="modal-close" 
                        data-modal-close="documentUploadModal" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="documentUploadForm" enctype="multipart/form-data" novalidate>
                    <fieldset>
                        <legend class="sr-only">Document Information</legend>
                        
                        <div class="form-group">
                            <label for="documentType" class="form-label">Document Type *</label>
                            <select class="form-control" 
                                    id="documentType" 
                                    name="documentType"
                                    required 
                                    onchange="checkExpiryRequired()"
                                    aria-describedby="documentType-error">
                                <option value="">Select type</option>
                                <option value="id">Photo ID</option>
                                <option value="resume">Resume/CV</option>
                                <option value="visa">Visa/Work Permit</option>
                                <option value="firstaid">First Aid/CPR Certificate</option>
                                <option value="wwcc">Working with Children Check</option>
                                <option value="police">Police Check</option>
                                <option value="ndis">NDIS Worker Check</option>
                                <option value="other">Other</option>
                            </select>
                            <div id="documentType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentTitle" class="form-label">Document Title *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="documentTitle" 
                                   name="documentTitle"
                                   required 
                                   placeholder="e.g., Driver's License"
                                   aria-describedby="documentTitle-error">
                            <div id="documentTitle-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group" id="expiryGroup">
                            <label for="documentExpiry" class="form-label">Expiry Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="documentExpiry" 
                                   name="documentExpiry"
                                   aria-describedby="documentExpiry-help">
                            <small id="documentExpiry-help" class="form-help">Required for certain document types</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentFile" class="form-label">Select File *</label>
                            <input type="file" 
                                   class="form-control" 
                                   id="documentFile" 
                                   name="documentFile"
                                   required 
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   aria-describedby="documentFile-error documentFile-help">
                            <small id="documentFile-help" class="form-help">Max 10MB. PDF, JPG, PNG accepted.</small>
                            <div id="documentFile-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentNotes" class="form-label">Notes</label>
                            <textarea class="form-control" 
                                      id="documentNotes" 
                                      name="documentNotes"
                                      placeholder="Optional notes..."
                                      rows="3"
                                      aria-describedby="documentNotes-help"></textarea>
                            <small id="documentNotes-help" class="form-help">Additional information about the document</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" data-modal-close="documentUploadModal">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" data-action="uploadDocument" form="documentUploadForm">
                    Upload
                </button>
            </footer>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="addNoteModal" class="modal" role="dialog" aria-labelledby="addNoteTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="addNoteTitle" class="modal-title">Add Shift Note</h3>
                <button class="modal-close" 
                        data-modal-close="addNoteModal" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="noteForm" novalidate>
                    <input type="hidden" id="noteShiftId" name="noteShiftId">
                    
                    <fieldset>
                        <legend class="sr-only">Note Details</legend>
                        
                        <div class="form-group">
                            <label for="noteType" class="form-label">Note Type *</label>
                            <select class="form-control" 
                                    id="noteType" 
                                    name="noteType"
                                    required 
                                    aria-describedby="noteType-error noteType-help">
                                <option value="shift">Shift Note (Visible to Manager)</option>
                                <option value="handover">Handover Note (Staff Only)</option>
                                <option value="incident">Incident Report</option>
                            </select>
                            <small id="noteType-help" class="form-help">Choose the appropriate note type</small>
                            <div id="noteType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="noteContent" class="form-label">Note *</label>
                            <textarea class="form-control" 
                                      id="noteContent" 
                                      name="noteContent"
                                      required 
                                      placeholder="Enter your note..."
                                      rows="4"
                                      aria-describedby="noteContent-error"></textarea>
                            <div id="noteContent-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset class="form-group">
                            <legend class="form-label">Attach Images</legend>
                            <div class="image-upload-area" role="region" aria-label="Image upload area">
                                <button type="button" 
                                        class="add-image-btn" 
                                        data-trigger-click="noteImages"
                                        aria-label="Add images">
                                    <i class="fa-solid fa-plus" aria-hidden="true"></i>
                                </button>
                                <div id="imagePreviewContainer" 
                                     role="region" 
                                     aria-label="Image previews"
                                     aria-live="polite"></div>
                            </div>
                            <input type="file" 
                                   id="noteImages" 
                                   name="noteImages"
                                   multiple 
                                   accept="image/*" 
                                   style="display: none;" 
                                   onchange="previewImages()"
                                   aria-describedby="noteImages-help">
                            <small id="noteImages-help" class="form-help">Optional: Add up to 5 images</small>
                        </fieldset>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" data-modal-close="addNoteModal">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" data-action="submitNote" form="noteForm">
                    Add Note
                </button>
            </footer>
        </div>
    </div>

    <script>

        
        // Supabase Configuration
        const SUPABASE_URL = 'https://gqchhsayqxttewthcsah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxY2hoc2F5cXh0dGV3dGhjc2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTA0ODksImV4cCI6MjA3MjI2NjQ4OX0.iAGhrDZaHkpLwjJY07o-73l2OiePB2x1ZnnTEfUBd_M';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        //DAY OFFSETTER!
        const DATE_OFFSET_DAYS = -14; // Set to 0 to disable testing mode
        const PERIOD_LENGTH = 14; // 14-day pay periods
        const DB_ERRORS = {
    FOREIGN_KEY_VIOLATION: "23503",
    UNIQUE_VIOLATION: "23505",
    NOT_NULL_VIOLATION: "23502"
};
        let currentUser = null;
        let currentStaff = null;
        let allShifts = [];
        let myShifts = [];
        let participants = [];
        let staff = [];
        let dutyTypes = [];
        let locations = [];
        let notifications = [];
        let documents = [];
        let selectedImages = [];
        let currentPeriodStart = null;
        let currentPeriodEnd = null;
        let timesheetView = 'date';
        let weeklyAvailability = {};
        let participantDefaultLocations = new Map();
        let careHomeLocations = new Set();
        let isSubmittingLeave = false;
        let id = null;
window.shifts = window.shifts || [];
window.participants = window.participants || [];
window.locations = window.locations || [];
window.staff = window.staff || [];
window.dutyTypes = window.dutyTypes || [];
        window.AppState = {
    staff: {
        current: null,
        original: null,
        all: []
    },
    shifts: {
        my: [],
        all: []
    },
    ui: {
        currentSection: 'dashboard',
        timesheetView: 'date',
        periodOffset: 0
    },
    cache: {
        participants: [],
        dutyTypes: [],
        locations: [],
        transfers: {
            incoming: [],
            outgoing: []
        }
    }
};

// Create currentStaff as a property that syncs with AppState
Object.defineProperty(window, 'currentStaff', {
    get() { 
        return AppState.staff.current; 
    },
    set(value) { 
        AppState.staff.current = value;
        console.log('Staff updated:', value?.first_name, value?.last_name);
    },
    configurable: true
});

        function getTestDate() {
    const date = new Date();
    date.setDate(date.getDate() + DATE_OFFSET_DAYS);
    return date;
}

const ModalManager = {
    // Modal configurations
    modals: {
        addShift: {
            id: 'addShiftModal',
            onOpen: () => populateShiftModalDropdowns(),
            onClose: () => document.getElementById('addShiftForm')?.reset()
        },
        transfer: {
            id: 'transferShiftModal',
            onOpen: () => {
                loadTransferableShifts();
                initializeStaffSearch();
            },
            onClose: () => {
                document.getElementById('transferForm')?.reset();
                document.getElementById('transferToStaffSearch').value = '';
                document.getElementById('transferToStaff').value = '';
                document.getElementById('transferConflictWarning').style.display = 'none';
            }
        },
        adjustment: {
            id: 'adjustmentModal',
            onOpen: () => loadAdjustmentShifts(),
            onClose: () => document.getElementById('adjustmentForm')?.reset()
        },
        leave: {
            id: 'leaveModal',
            onOpen: () => loadLeaveRequestModal(),
            onClose: () => {
                document.getElementById('leaveForm')?.reset();
                isSubmittingLeave = false;
            }
        }
    },
    
    // Current open modal
    currentModal: null,
    
    // Open modal by name
    show(modalName, data = null) {
        const config = this.modals[modalName];
        if (!config) {
            console.error(`Modal '${modalName}' not found`);
            return;
        }
        
        // Close any open modal first
        if (this.currentModal) {
            this.close();
        }
        
        const modalElement = document.getElementById(config.id);
        if (!modalElement) {
            console.error(`Modal element '${config.id}' not found`);
            return;
        }
        
        // Store current modal
        this.currentModal = {
            name: modalName,
            element: modalElement,
            config: config
        };
        
        // Show modal
        modalElement.classList.add('active');
        modalElement.style.display = 'flex';
        
        // Run onOpen callback if exists
        if (config.onOpen) {
            config.onOpen(data);
        }
        
        // Add escape key listener
        this.escapeHandler = (e) => {
            if (e.key === 'Escape') {
                this.close();
            }
        };
        document.addEventListener('keydown', this.escapeHandler);
    },
    
    // Close current modal
    close() {
        if (!this.currentModal) return;
        
        const { element, config } = this.currentModal;
        
        // Hide modal
        element.classList.remove('active');
        element.style.display = 'none';
        
        // Run onClose callback if exists
        if (config.onClose) {
            config.onClose();
        }
        
        // Remove escape handler
        if (this.escapeHandler) {
            document.removeEventListener('keydown', this.escapeHandler);
        }
        
        // Clear current modal
        this.currentModal = null;
    },
    
    // Check if a modal is open
    isOpen(modalName = null) {
        if (!modalName) {
            return this.currentModal !== null;
        }
        return this.currentModal?.name === modalName;
    },
    
    // Get current modal data
    getCurrent() {
        return this.currentModal;
    }
};

async function initializeApp() {
    try {
        console.log('Initializing team app...');
        
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error || !session) {
            console.error('Authentication error:', error);
            window.location.href = 'index.html';
            return;
        }

        currentUser = session.user;
        console.log('User authenticated:', currentUser.email);
        console.log('Auth User ID:', currentUser.id);
        
        // Try multiple methods to find staff record
        let staffData = null;
        
        // Method 1: Try by user_id (fastest - already linked)
        let result = await supabaseClient
            .from('staff')
            .select('*')
            .eq('user_id', currentUser.id)
            .maybeSingle();
        
        staffData = result.data;
        
        if (staffData) {
            console.log('âœ… Staff found by user_id - already linked');
        }
        
        // Method 2: Try by email match (auto-link if needed)
        if (!staffData) {
            console.log('ðŸ” No staff found by user_id, searching by email...');
            result = await supabaseClient
                .from('staff')
                .select('*')
                .eq('email', currentUser.email)
                .maybeSingle();
            
            staffData = result.data;
            
            if (staffData) {
                console.log('ðŸ“§ Staff found by email match');
                
                // AUTO-LINK: If found by email but no user_id, create the link
                if (!staffData.user_id) {
                    console.log('ðŸ”— Creating link between staff and auth user...');
                    
                    const { data: updatedStaff, error: updateError } = await supabaseClient
                        .from('staff')
                        .update({ user_id: currentUser.id })
                        .eq('id', staffData.id)
                        .select()
                        .single();
                    
                    if (updateError) {
                        console.error('âŒ Failed to link staff record:', updateError);
                        showToast('Warning: Could not link your account. Contact admin.', 'warning');
                    } else {
                        staffData = updatedStaff;
                        console.log('âœ… Staff record auto-linked successfully!');
                        console.log('   Staff ID:', staffData.id);
                        console.log('   Now linked to Auth ID:', staffData.user_id);
                        showToast('Account linked successfully', 'success');
                    }
                } else {
                    console.log('âœ… Staff already has user_id, updating to current auth user');
                    // Update to current auth user (in case auth account was recreated)
                    const { data: updatedStaff } = await supabaseClient
                        .from('staff')
                        .update({ user_id: currentUser.id })
                        .eq('id', staffData.id)
                        .select()
                        .single();
                    
                    if (updatedStaff) {
                        staffData = updatedStaff;
                    }
                }
            }
        }
        
        // Method 3: For testing - allow manual override
        if (!staffData && window.location.hostname === 'localhost') {
            console.warn('âš ï¸ No staff found, checking for test override...');
            // You could load a default test staff here
        }
        
        // If still no staff record found
        if (!staffData) {
            console.error('âŒ No staff record found for this user');
            console.error('   Auth Email:', currentUser.email);
            console.error('   Auth ID:', currentUser.id);
            
            showToast('No staff record found. Please contact administrator.', 'error');
            
            // Show helpful error with current user info
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: Arial;">
                    <h2>Staff Account Not Found</h2>
                    <p>No staff record found for: <strong>${currentUser.email}</strong></p>
                    <p style="color: #666; margin-top: 20px;">Please contact your administrator to:</p>
                    <ol style="text-align: left; display: inline-block; color: #666;">
                        <li>Create a staff record for your email address</li>
                        <li>Or update your staff record email to match your login email</li>
                    </ol>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 20px;">
                        <p style="font-size: 12px; color: #999; margin: 5px;">Debug Info:</p>
                        <p style="font-size: 11px; color: #999; margin: 5px;">Auth User ID: ${currentUser.id}</p>
                        <p style="font-size: 11px; color: #999; margin: 5px;">Email: ${currentUser.email}</p>
                    </div>
                    <button data-action="logout" style="margin-top: 20px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
                </div>
            `;
            return;
        }
        
        // Success - Set the staff data
        AppState.staff.current = staffData;
        currentStaff = staffData;
        window.currentStaff = staffData; // Ensure global access
        
        console.log('âœ… Staff record loaded:', staffData.first_name, staffData.last_name);
        console.log('   Staff ID:', staffData.id);
        console.log('   Linked to Auth ID:', staffData.user_id);
        
        // Update UI with staff name
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = `${staffData.first_name} ${staffData.last_name}`;
        }
        
        
        // ============================================
        // LOAD ALL REFERENCE DATA (CRITICAL FOR ENRICHREQUESTDATA)
        // ============================================
        console.log('Loading reference data...');
        
        try {
            // Load all reference data in parallel for better performance
            const [participantsResult, staffResult, locationsResult, dutyTypesResult] = await Promise.all([
                supabaseClient.from('participants').select('*').eq('is_active', true).order('first_name'),
                supabaseClient.from('staff').select('*').eq('is_active', true).order('first_name'),
                supabaseClient.from('locations').select('*').eq('is_active', true).order('name'),  // Added is_active filter
                supabaseClient.from('duty_types').select('id, name').order('name')  // FIXED: Removed pay_multiplier
            ]);
            
            // Check for errors
            if (participantsResult.error) console.error('Error loading participants:', participantsResult.error);
            if (staffResult.error) console.error('Error loading staff:', staffResult.error);
            if (locationsResult.error) console.error('Error loading locations:', locationsResult.error);
            if (dutyTypesResult.error) console.error('Error loading duty types:', dutyTypesResult.error);
            
            // Populate global arrays (needed for enrichRequestData and other functions)
            participants = participantsResult.data || [];
            staff = staffResult.data || [];
            locations = locationsResult.data || [];
            dutyTypes = dutyTypesResult.data || [];
            
            // Ensure global window access for compatibility
            window.participants = participants;
            window.staff = staff;
            window.locations = locations;
            window.dutyTypes = dutyTypes;
            
            // Also update AppState cache if it exists
            if (window.AppState && window.AppState.cache) {
                AppState.cache.participants = participants;
                AppState.cache.dutyTypes = dutyTypes;
                AppState.cache.locations = locations;
            }
            
            console.log('Reference data loaded:', {
                participants: participants.length,
                staff: staff.length,
                locations: locations.length,
                dutyTypes: dutyTypes.length,
                careHomes: locations.filter(l => l.is_care_home).length
            });
            
            // NEW: Build participant-location mapping for care homes
            await initializeParticipantLocationMapping();
            
        } catch (refError) {
            console.error('Error loading reference data:', refError);
            showToast('Warning: Some reference data failed to load', 'warning');
        }
        
        
        function setupLeaveFormListener() {
    const leaveForm = document.getElementById('leaveForm');
    const submitBtn = document.getElementById('submitLeaveBtn');
    
    if (leaveForm) {
        // Remove any existing listeners first
        leaveForm.removeEventListener('submit', handleLeaveSubmit);
        // Add new listener
        leaveForm.addEventListener('submit', handleLeaveSubmit);
    }
    
    if (submitBtn) {
    // Remove any existing listeners
    submitBtn.replaceWith(submitBtn.cloneNode(true));
    const newSubmitBtn = document.querySelector('[data-action="submitLeaveWithProtection"]');
    if (newSubmitBtn) {
        newSubmitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!this.disabled) {
                submitLeaveWithProtection();
            }
        });
    }
}
}


        // ============================================
        // LOAD STAFF'S SHIFTS (FIXED: No pay_multiplier)
        // ============================================
        console.log('Loading staff shifts...');
        
        try {
            const { data: myShiftsData, error: shiftsError } = await supabaseClient
    .from('shifts')
    .select(`
        *,
        participants:participant_id(first_name, last_name, address),
        locations:location_id(id, name, address, is_care_home),
        duty_types:duty_type_id(name)
    `)
    .eq('staff_id', staffData.id)
    .is('deleted_at', null)
    .order('date', { ascending: false })
    .limit(100);

            if (shiftsError) {
                console.error('Error loading shifts:', shiftsError);
                myShifts = [];
                shifts = [];
            } else {
                myShifts = myShiftsData || [];
                shifts = myShiftsData || []; // Populate both arrays
                
                // Ensure global access
                window.myShifts = myShifts;
                window.shifts = shifts;
                
                // Update AppState if exists
                if (window.AppState && window.AppState.shifts) {
                    AppState.shifts.my = myShifts;
                    AppState.shifts.all = shifts;
                }
                
                console.log('Shifts loaded:', myShifts.length);
            }
            
        } catch (shiftsError) {
            console.error('Error loading shifts:', shiftsError);
            showToast('Warning: Could not load shifts', 'warning');
        }
        
        // ============================================
        // NEW: Load Participants with Care Home Mapping
        // ============================================
        await loadParticipantsWithCareHomes();
        
        // ============================================
        // INITIALIZE UI COMPONENTS
        // ============================================
        
        // Set greeting
        if (typeof setGreeting === 'function') {
            setGreeting();
        }
        
        // Initialize pay period
        if (typeof setCurrentPayPeriod === 'function') {
            setCurrentPayPeriod();
        }
        
        // Show default section
        if (typeof showSection === 'function') {
            showSection('dashboard');
        } else {
            // Fallback: show dashboard
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection) {
                dashboardSection.style.display = 'block';
            }
        }
        
        // NEW: Setup participant select event listeners
        setupParticipantSelectListeners();
        
        // ============================================
        // LOAD ADDITIONAL FEATURES (NON-BLOCKING)
        // ============================================
        
        // Load these in background, don't wait
        setTimeout(async () => {
            try {
                // Load transfers
                if (typeof loadTransfers === 'function') {
                    console.log('Loading transfers...');
                    await loadTransfers();
                }
                
                // Load notifications
                if (typeof loadNotifications === 'function') {
                    console.log('Loading notifications...');
                    await loadNotifications();
                }
                
                // Load documents
                if (typeof loadDocuments === 'function') {
                    console.log('Loading documents...');
                    await loadDocuments();
                }
                
                // Load availability
                if (typeof loadAvailability === 'function') {
                    console.log('Loading availability...');
                    await loadAvailability();
                }
                
                // Update dashboard metrics
                if (typeof updateDashboard === 'function') {
                    updateDashboard();
                }
                
                // Render schedule
                if (typeof renderSchedule === 'function') {
                    renderSchedule();
                }
                
                // Check for incoming transfers count
                if (typeof updateTransferBadge === 'function') {
                    updateTransferBadge();
                }
                
            } catch (featureError) {
                console.error('Error loading additional features:', featureError);
                // Non-critical, don't show error to user
            }
        }, 100);
        
        // ============================================
        // SETUP EVENT LISTENERS
        // ============================================
        
        // Setup all event listeners if function exists
        if (typeof setupAllEventListeners === 'function') {
            setupAllEventListeners();
        }
        
        // Populate modal dropdowns
        if (typeof populateModalDropdowns === 'function') {
            populateModalDropdowns();
        }
        
        // ============================================
        // FINAL SUCCESS MESSAGE
        // ============================================
        
        console.log('âœ… Application initialized successfully');
        console.log('   Current Staff:', currentStaff.first_name, currentStaff.last_name);
        console.log('   Global Arrays:', {
            participants: participants.length,
            staff: staff.length,
            locations: locations.length,
            dutyTypes: dutyTypes.length,
            shifts: shifts.length,
            careHomes: locations.filter(l => l.is_care_home).map(l => l.name)
        });
        
        // Show success message (optional)
        // showToast('Welcome back, ' + staffData.first_name + '!', 'success');
        
    } catch (error) {
        console.error('âŒ Fatal error in initializeApp:', error);
        showToast('Failed to initialize app: ' + error.message, 'error');
        
        // Show error UI
        const errorContainer = document.getElementById('errorContainer');
        if (errorContainer) {
            errorContainer.innerHTML = `
                <div style="padding: 20px; background: #f8d7da; color: #721c24; border-radius: 5px;">
                    <h3>Initialization Error</h3>
                    <p>${error.message}</p>
                    <button data-action="reloadPage" style="margin-top: 10px; padding: 5px 15px;">Retry</button>
                </div>
            `;
            errorContainer.style.display = 'block';
        }
    }
}

async function initializeParticipantLocationMapping() {
    // Build a map of participant addresses to identify care home residents
    const participantLocationMap = new Map();
    
    participants.forEach(p => {
        if (p.address) {
            const addressLower = p.address.toLowerCase();
            
            // Check if this participant is in Saunders Care Home
            if (addressLower.includes('saunders')) {
                const saundersLocation = locations.find(loc => 
                    loc.name.toLowerCase().includes('saunders') || 
                    (loc.address && loc.address.toLowerCase().includes('saunders'))
                );
                
                if (saundersLocation) {
                    participantLocationMap.set(p.id, saundersLocation.id);
                }
            } 
            // Check for other care homes
            else {
                const matchingLocation = locations.find(loc => {
                    if (!loc.address || !loc.is_care_home) return false;
                    const locAddressLower = loc.address.toLowerCase();
                    const participantAddressParts = addressLower.split(',')[0].trim();
                    return locAddressLower.includes(participantAddressParts);
                });
                
                if (matchingLocation) {
                    participantLocationMap.set(p.id, matchingLocation.id);
                }
            }
        }
    });
    
    // Store the map globally for use in shift creation
    window.participantDefaultLocations = participantLocationMap;
    
    console.log('Participant location mapping created:', {
        totalParticipants: participants.length,
        mappedToCareHomes: participantLocationMap.size
    });
}

async function loadParticipantsWithCareHomes() {
    // Populate participant dropdowns with care home indicators
    const selects = ['shiftParticipant', 'noteParticipant'];
    
    selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            select.innerHTML = '<option value="">Select Client</option>';
            
            // Group participants by care home
            const careHomeParticipants = [];
            const homeParticipants = [];
            
            participants.forEach(p => {
                const locationId = window.participantDefaultLocations?.get(p.id);
                const location = locationId ? locations.find(l => l.id === locationId) : null;
                
                if (location && location.is_care_home) {
                    careHomeParticipants.push({
                        participant: p,
                        careHomeName: location.name
                    });
                } else {
                    homeParticipants.push(p);
                }
            });
            
            // Add care home participants with labels
            if (careHomeParticipants.length > 0) {
                select.innerHTML += '<optgroup label="Care Home Residents">';
                careHomeParticipants.forEach(item => {
                    select.innerHTML += `<option value="${item.participant.id}" data-location-id="${window.participantDefaultLocations.get(item.participant.id) || ''}">${item.participant.first_name} ${item.participant.last_name} (${item.careHomeName})</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
            
            // Add home participants
            if (homeParticipants.length > 0) {
                select.innerHTML += '<optgroup label="Home Clients">';
                homeParticipants.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
        }
    });
}

function setupParticipantSelectListeners() {
    // For shift creation modal
    const shiftParticipant = document.getElementById('shiftParticipant');
    if (shiftParticipant) {
        shiftParticipant.addEventListener('change', function() {
            onParticipantSelect(this.value, 'shiftLocation');
        });
    }
    
    // For note creation modal
    const noteParticipant = document.getElementById('noteParticipant');
    if (noteParticipant) {
        noteParticipant.addEventListener('change', function() {
            // Notes don't have location, but we could use this for context
            console.log('Participant selected for note');
        });
    }
}

function onParticipantSelect(participantId, locationSelectId) {
    const locationSelect = document.getElementById(locationSelectId || 'shiftLocation');
    if (!locationSelect || !participantId) return;
    
    // Check if we have a default location for this participant
    if (window.participantDefaultLocations && window.participantDefaultLocations.has(participantId)) {
        const defaultLocationId = window.participantDefaultLocations.get(participantId);
        locationSelect.value = defaultLocationId;
        console.log('Auto-selected care home location for participant');
        return;
    }
    
    // Otherwise, try to find "Client Home" as default
    // Use constants from LOCATION_IDS
const clientHomeLocation = locations?.find(l => 
    l.name.toLowerCase().includes('client home') || 
    l.id === LOCATION_IDS.CLIENT_HOME  // Use constant
);
    if (clientHomeLocation) {
        locationSelect.value = clientHomeLocation.id;
        console.log('Auto-selected Client Home as default');
    }
}


async function loadReferenceData() {
    try {
        console.log('Loading reference data for team...');
        
        // Load all reference data in parallel
        const [participantsData, staffData, locationsData, dutyTypesData] = await Promise.all([
            supabaseClient.from('participants').select('*').eq('is_active', true).order('first_name'),
            supabaseClient.from('staff').select('*').eq('is_active', true).order('first_name'),
            supabaseClient.from('locations').select('*').order('name'),
            supabaseClient.from('duty_types').select('*').order('name')
        ]);
        
        // Populate global arrays
        participants = participantsData.data || [];
        staff = staffData.data || [];
        locations = locationsData.data || [];
        dutyTypes = dutyTypesData.data || [];
        
        // Also update window references
        window.participants = participants;
        window.staff = staff;
        window.locations = locations;
        window.dutyTypes = dutyTypes;
        
        console.log('Reference data loaded:', {
            participants: participants.length,
            staff: staff.length,
            locations: locations.length,
            dutyTypes: dutyTypes.length
        });
        
        return true;
        
    } catch (error) {
        console.error('Error loading reference data:', error);
        showToast('Failed to load reference data', 'error');
        return false;
    }
}

function createSearchableDropdown(selectId, options = {}) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'searchable-dropdown-wrapper';
    wrapper.style.position = 'relative';
    
    // Create search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control searchable-input';
    searchInput.placeholder = options.placeholder || 'Type to search...';
    searchInput.style.cssText = `
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    `;
    
    // Create dropdown list
    const dropdownList = document.createElement('div');
    dropdownList.className = 'searchable-dropdown-list';
    dropdownList.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        display: none;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    
    // Store selected value
    let selectedValue = select.value;
    let selectedText = '';
    
    // Get options from original select
    const originalOptions = Array.from(select.options).map(opt => ({
        value: opt.value,
        text: opt.textContent,
        data: opt.dataset
    }));
    
    // Function to update dropdown list
    function updateDropdownList(searchTerm = '') {
        dropdownList.innerHTML = '';
        
        const filtered = originalOptions.filter(opt => 
            opt.text.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        if (filtered.length === 0) {
            dropdownList.innerHTML = '<div style="padding: 8px; color: #999;">No results found</div>';
            return;
        }
        
        filtered.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                transition: background 0.2s;
            `;
            item.textContent = opt.text;
            item.dataset.value = opt.value;
            
            // Copy any data attributes
            Object.keys(opt.data || {}).forEach(key => {
                item.dataset[key] = opt.data[key];
            });
            
            item.onmouseover = () => item.style.background = '#f0f0f0';
            item.onmouseout = () => item.style.background = 'white';
            
            item.addEventListener('click', () => {
    selectedValue = opt.value;
    selectedText = opt.text;
    searchInput.value = opt.text;
    select.value = opt.value;
    
    // Trigger change event on original select
    const event = new Event('change', { bubbles: true });
    select.dispatchEvent(event);
    
    dropdownList.style.display = 'none';
});
            
            dropdownList.appendChild(item);
        });
    }
    
    // Event handlers
    searchInput.onfocus = () => {
        updateDropdownList('');
        dropdownList.style.display = 'block';
    };
    
    searchInput.oninput = (e) => {
        updateDropdownList(e.target.value);
        dropdownList.style.display = 'block';
    };
    
    // Click outside to close
    document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // Set initial value
    if (select.value) {
        const initial = originalOptions.find(opt => opt.value === select.value);
        if (initial) {
            searchInput.value = initial.text;
            selectedText = initial.text;
        }
    }
    
    // Replace select with wrapper
    select.style.display = 'none';
    wrapper.appendChild(searchInput);
    wrapper.appendChild(dropdownList);
    select.parentNode.insertBefore(wrapper, select.nextSibling);
    
    // Store reference for later updates
    select._searchableDropdown = {
        update: () => updateDropdownList(''),
        setValue: (value) => {
            const opt = originalOptions.find(o => o.value === value);
            if (opt) {
                selectedValue = opt.value;
                selectedText = opt.text;
                searchInput.value = opt.text;
                select.value = opt.value;
            }
        },
        getValue: () => selectedValue
    };
    
    return select._searchableDropdown;
}

async function populateEditModalDropdowns(shift = null) {
    try {
        // Ensure reference data is loaded
        if (!participants.length || !staff.length) {
            await loadReferenceData();
        }
        
        // Staff dropdown
        const staffSelect = document.getElementById('editStaff');
        if (staffSelect) {
            staffSelect.innerHTML = '<option value="">Select Staff</option>';
            staff.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.first_name} ${s.last_name}`;
                if (shift && shift.staff_id === s.id) {
                    option.selected = true;
                }
                staffSelect.appendChild(option);
            });
            
            // Make it searchable
            createSearchableDropdown('editStaff', {
                placeholder: 'Type to search staff...'
            });
        }
        
        // Participant dropdown
        const participantSelect = document.getElementById('editParticipant');
        if (participantSelect) {
            participantSelect.innerHTML = '<option value="">Select Client</option>';
            participants.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.first_name} ${p.last_name}`;
                if (shift && shift.participant_id === p.id) {
                    option.selected = true;
                }
                participantSelect.appendChild(option);
            });
            
            // Make it searchable
            createSearchableDropdown('editParticipant', {
                placeholder: 'Type to search client...'
            });
        }
        
        // Location dropdown
        const locationSelect = document.getElementById('editLocation');
        if (locationSelect) {
            locationSelect.innerHTML = '<option value="">Select Location</option>';
            
            // Add default Client Home option
            const clientHome = document.createElement('option');
            clientHome.value = '00000000-0000-0000-0000-000000000001';
            clientHome.textContent = 'Client Home';
            locationSelect.appendChild(clientHome);
            
            locations.forEach(l => {
                if (l.id !== '00000000-0000-0000-0000-000000000001') {
                    const option = document.createElement('option');
                    option.value = l.id;
                    option.textContent = l.name;
                    if (shift && shift.location_id === l.id) {
                        option.selected = true;
                    }
                    locationSelect.appendChild(option);
                }
            });
            
            // Make it searchable
            createSearchableDropdown('editLocation', {
                placeholder: 'Type to search location...'
            });
        }
        
        // Duty Type dropdown
        const dutyTypeSelect = document.getElementById('editDutyType');
        if (dutyTypeSelect) {
            dutyTypeSelect.innerHTML = '<option value="">Select Duty Type</option>';
            dutyTypes.forEach(dt => {
                const option = document.createElement('option');
                option.value = dt.id;
                option.textContent = dt.name;
                if (shift && shift.duty_type_id === dt.id) {
                    option.selected = true;
                }
                dutyTypeSelect.appendChild(option);
            });
            
            // Make it searchable
            createSearchableDropdown('editDutyType', {
                placeholder: 'Type to search duty type...'
            });
        }
        
    } catch (error) {
        console.error('Error populating modal dropdowns:', error);
        showToast('Failed to load dropdown options', 'error');
    }
}

async function refreshAfterChange() {
    try {
        // Reload shifts if function exists
        if (typeof loadShifts === 'function') {
            await loadShifts();
        }
        
        // Reload my shifts for team.html
        if (typeof loadMyShifts === 'function') {
            await loadMyShifts();
        }
        
        // Refresh current view
        if (typeof renderCurrentView === 'function') {
            renderCurrentView();
        }
        
        // Update dashboard if on team.html
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
        
    } catch (error) {
        console.error('Error refreshing after change:', error);
    }
}

async function loadMyShifts() {
    try {
        const { data: myShiftsData, error: shiftsError } = await supabaseClient
    .from('shifts')
    .select(`
        *,
        participants:participant_id(first_name, last_name, address),
        locations:location_id(id, name, address, is_care_home),
        duty_types:duty_type_id(name)
    `)
    .eq('staff_id', staffData.id)
    .is('deleted_at', null)
    .order('date', { ascending: false })
    .limit(100);

        if (shiftsError) {
            console.error('Error loading shifts:', shiftsError);
            throw shiftsError;
        }
        
        myShifts = myShiftsData || [];
        window.myShifts = myShifts;
        
        console.log('Shifts loaded:', myShifts.length);
        return myShifts;
        
    } catch (error) {
        console.error('Error in loadMyShifts:', error);
        showToast('Failed to load shifts', 'error');
        return [];
    }
}



// 2. CONSOLIDATED Event Listener Setup
function setupAllEventListeners() {
    console.log('Setting up all event listeners...');
    
    // Quick Actions
    setupQuickActions();
    
    // Navigation
    setupNavigation();
    
    // Forms
    setupForms();
    
    // Modals
    setupModals();
    
    // Edit/Save Buttons
    setupEditButtons();
    
    // File Uploads
    setupFileUploads();
    
    // Keyboard Shortcuts
    setupKeyboardShortcuts();
    
    // Timesheet Controls
    setTimeout(() => {
    const prevBtn = document.getElementById('prevPeriodBtn');
    const nextBtn = document.getElementById('nextPeriodBtn');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            console.log('Previous period clicked');
            changePeriod(-1);
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            console.log('Next period clicked');
            changePeriod(1);
        });
    }
}, 100);
    
    console.log('Event listeners ready');
}

window.showNotification = function(message, type) {
    showToast(message, type);
};

function setupQuickActions() {
    // Quick actions are now handled by data attributes
    // Just ensure the buttons have the right data-action attributes
    console.log('Quick actions setup via data attributes');
}
function setupNavigation() {
    // Tab navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const view = this.getAttribute('data-view');
            if (view) switchView(view);
        });
    });
    
    // View selector
    const viewSelector = document.getElementById('viewSelector');
    if (viewSelector) {
        viewSelector.addEventListener('change', (e) => switchView(e.target.value));
    }
}

function setupForms() {
    const forms = {
        'noteForm': submitNote,
        'addShiftForm': submitShift,
        'transferForm': submitTransfer,
        'adjustmentForm': submitAdjustment,
        'leaveForm': submitLeave
    };
    
    Object.entries(forms).forEach(([id, handler]) => {
        const form = document.getElementById(id);
        if (form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                handler();
            });
        }
    });
}

async function loadAvailableTransfers() {
    try {
        const container = document.getElementById('availableList');
        if (!container) return;
        
        // Load shifts that are unassigned or available for pickup
        const { data: availableShifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                locations(name, address),
                duty_types(name)
            `)
            .is('staff_id', null) // Unassigned shifts
            .gte('date', getTestDate().toISOString().split('T')[0])
            .order('date', { ascending: true })
            .limit(20);
        
        if (error) {
            console.error('Error loading available shifts:', error);
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">Failed to load available shifts</div>';
            return;
        }
        
        if (!availableShifts || availableShifts.length === 0) {
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No available shifts at this time</div>';
            return;
        }
        
        // Render available shifts
        container.innerHTML = availableShifts.map(shift => `
            <div class="transfer-item">
                <div class="transfer-header">
                    <div>
                        <div class="transfer-date">${formatDateLong(shift.date)}</div>
                        <div class="transfer-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary" data-action-with-param="claimShift" data-param="${shift.id}">
                        Claim Shift
                    </button>
                </div>
                <div class="transfer-from">
                    Client: ${shift.participants ? 
                        `${shift.participants.first_name} ${shift.participants.last_name}` : 
                        'Unassigned'}
                </div>
                <div class="transfer-from">
                    Location: ${shift.locations?.name || 'Client Home'}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error in loadAvailableTransfers:', error);
        showToast('Failed to load available shifts', 'error');
    }
}

function filterSchedule() {
    const filterValue = document.getElementById('participantFilter').value;
    // Re-render schedule with filter
    loadSchedule(); // This should use the filter value
}
// Also add the claim shift function
async function claimShift(shiftId) {
    try {
        if (!confirm('Do you want to claim this shift?')) return;
        
        const { error } = await supabaseClient
            .from('shifts')
            .update({ staff_id: AppState.staff.current.id })
            .eq('id', parseInt(shiftId));
        
        if (error) throw error;
        
        showToast('Shift claimed successfully', 'success');
        loadAvailableTransfers(); // Reload the list
        
    } catch (error) {
        console.error('Error claiming shift:', error);
        showToast('Failed to claim shift', 'error');
    }
}

function setupModals() {
    // Close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) closeModal(modal.id);
        });
    });
    
    // Cancel buttons
    document.querySelectorAll('.modal .btn-secondary').forEach(btn => {
        if (btn.textContent.includes('Cancel')) {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) closeModal(modal.id);
            });
        }
    });
    
    // Click outside to close
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target.id);
        }
    });
}

function setupEditButtons() {
    const editButtons = {
        'editPersonalBtn': editPersonalInfo,
        'editContactBtn': editContactInfo,
        'editBankingBtn': editBankingInfo,
        'savePersonalBtn': savePersonalInfo,
        'saveContactBtn': saveContactInfo,
        'saveBankingBtn': saveBankingInfo,
        'saveAvailabilityBtn': saveAvailability
    };
    
    Object.entries(editButtons).forEach(([id, handler]) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.addEventListener('click', handler);
        }
    });
}

function setupFileUploads() {
    
    const docUploadBtn = document.getElementById('uploadDocBtn');
    if (docUploadBtn) {
        docUploadBtn.addEventListener('click', uploadDocument);
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Alt+T: Toggle staff selector
        if (e.altKey && e.key === 't') {
            e.preventDefault();
            const selector = document.getElementById('staffSelector');
            if (selector) {
                selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Escape: Close active modal
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                closeModal(activeModal.id);
            }
        }
    });
}

function setupTimesheetControls() {
    // Period navigation - use IDs instead of searching for text
    const prevBtn = document.getElementById('prevPeriodBtn');
    const nextBtn = document.getElementById('nextPeriodBtn');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            console.log('Navigate previous period');
            changePeriod(-1);  // Call directly, not window.changePeriod
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            console.log('Navigate next period');
            changePeriod(1);  // Call directly, not window.changePeriod
        });
    }
    
    // View toggle buttons
    document.querySelectorAll('.view-toggle .toggle-btn').forEach(button => {
        button.setAttribute('data-action', 'appropriateActionName');
        
        if (button.textContent.includes('Date')) {
            button.addEventListener('click', () => toggleTimesheetView('date'));
        } else if (button.textContent.includes('Client')) {
            button.addEventListener('click', () => toggleTimesheetView('participant'));
        }
    });
}

async function checkTableStructure() {
    // Run this once to determine actual column types
    const { data, error } = await supabaseClient
        .from('shift_adjustment_requests')
        .select('*')
        .limit(1);
    
    console.log('shift_adjustment_requests sample:', data);
    
    // Based on the error, shift_id appears to be UUID in this table
    // So we need to handle it differently
}



function ensureRequiredElements() {
    const requiredElements = [
        { id: 'userName', description: 'User name display' },
        { id: 'scheduleGrid', description: 'Schedule container' },
        { id: 'recentNotifications', description: 'Notifications container' },
        { id: 'incomingCount', description: 'Transfer count badge' },
        { id: 'periodDates', description: 'Pay period display' },
        { id: 'dashboardContent', description: 'Main dashboard content' }
    ];
    
    const missingElements = [];
    
    requiredElements.forEach(element => {
        const domElement = document.getElementById(element.id);
        if (!domElement) {
            console.warn(`Required element missing: ${element.id} (${element.description})`);
            missingElements.push(element.id);
        }
    });
    
    if (missingElements.length > 0) {
        console.warn('Missing DOM elements:', missingElements);
        // Could create placeholder elements here if needed
        missingElements.forEach(id => {
            if (id === 'scheduleGrid' || id === 'recentNotifications') {
                // Create essential containers if missing
                const container = document.createElement('div');
                container.id = id;
                container.innerHTML = '<div class="loading">Loading...</div>';
                
                // Try to find a good parent to attach to
                const parent = document.querySelector('.content-section') || document.body;
                parent.appendChild(container);
                
                console.log(`Created placeholder element: ${id}`);
            }
        });
    }
    
    return missingElements.length === 0;
}

        
        async function loadDashboard() {
    try {
        // Load current/upcoming shift
        await loadCurrentShift();
        
        // Load pending requests
        await loadPendingRequests();
        
        // Load notifications
        await loadNotifications();
        
        // Load upcoming leave
        const today = getTestDate().toISOString().split('T')[0];
        const thirtyDaysFromNow = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        const { data: myLeave } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('available', false)
            .gte('date', today)
            .lte('date', thirtyDaysFromNow)
            .order('date');

        if (myLeave && myLeave.length > 0) {
            // Group consecutive dates
            const leaveGroups = [];
            let currentGroup = null;
            
            myLeave.forEach(leave => {
                const leaveDate = new Date(leave.date);
                
                if (!currentGroup || 
                    leave.reason !== currentGroup.reason ||
                    (leaveDate - new Date(currentGroup.endDate)) > 24 * 60 * 60 * 1000) {
                    currentGroup = {
                        startDate: leave.date,
                        endDate: leave.date,
                        reason: leave.reason,
                        days: 1
                    };
                    leaveGroups.push(currentGroup);
                } else {
                    currentGroup.endDate = leave.date;
                    currentGroup.days++;
                }
            });

            // Create leave section HTML
            const leaveHTML = `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>ðŸ“… Upcoming Leave</h3>
                        <span class="badge">${leaveGroups.length}</span>
                    </div>
                    <div class="leave-list">
                        ${leaveGroups.map(group => {
                            const start = formatDateShort(group.startDate);
                            const end = formatDateShort(group.endDate);
                            const dateRange = group.startDate === group.endDate ? 
                                start : 
                                `${start} - ${end} (${group.days} days)`;
                            
                            const daysUntil = Math.floor((new Date(group.startDate) - getTestDate()) / (24 * 60 * 60 * 1000));
                            const urgency = daysUntil <= 7 ? 'urgent' : daysUntil <= 14 ? 'soon' : '';
                            
                            return `
                                <div class="leave-item ${urgency}">
                                    <div class="leave-info">
                                        <div class="leave-dates">${dateRange}</div>
                                        <div class="leave-type">${group.reason}</div>
                                    </div>
                                    ${daysUntil > 0 ? 
                                        `<div class="leave-countdown">In ${daysUntil} day${daysUntil !== 1 ? 's' : ''}</div>` : 
                                        daysUntil === 0 ? 
                                        '<div class="leave-countdown today">Today</div>' : 
                                        '<div class="leave-countdown ongoing">Ongoing</div>'
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Insert leave section into dashboard
            const dashboardContent = document.getElementById('dashboardContent');
            if (dashboardContent) {
                // Find or create leave container
                let leaveContainer = dashboardContent.querySelector('.leave-container');
                if (!leaveContainer) {
                    leaveContainer = document.createElement('div');
                    leaveContainer.className = 'leave-container';
                    
                    // Insert after pending requests or at the end
                    const pendingRequests = dashboardContent.querySelector('.dashboard-card');
                    if (pendingRequests) {
                        pendingRequests.insertAdjacentElement('afterend', leaveContainer);
                    } else {
                        dashboardContent.appendChild(leaveContainer);
                    }
                }
                leaveContainer.innerHTML = leaveHTML;
            }
        }
        
        // Update summary stats
        const { data: stats } = await supabaseClient
            .from('shifts')
            .select('id, status')
            .eq('staff_id', currentStaff.id)
            .gte('date', today);
        
        const upcomingShifts = stats?.filter(s => s.status === 'confirmed').length || 0;
        const pendingShifts = stats?.filter(s => s.status === 'pending').length || 0;
        
        // Update dashboard badges
        const homeBadge = document.getElementById('homeBadge');
        if (homeBadge) {
            const totalAlerts = pendingShifts + (myLeave?.length || 0);
            homeBadge.textContent = totalAlerts;
            homeBadge.classList.toggle('hidden', totalAlerts === 0);
        }
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Failed to load dashboard completely', 'error');
    }
}


        async function loadCurrentShift() {
            const now = getTestDate();
            const today = now.toISOString().split('T')[0];
            
            // Get today's and tomorrow's shifts
            const { data: upcomingShifts } = await supabaseClient
                .from('shifts')
                .select(`
                    *,
                    participant:participant_id(first_name, last_name),
                    location:location_id(name, address),
                    duty_type:duty_type_id(name)
                `)
                .eq('staff_id', currentStaff.id)
                .gte('date', today)
                .lte('date', new Date(now.getTime() + 24*60*60*1000).toISOString().split('T')[0])
                .is('deleted_at', null)
                .order('date')
                .order('start_time')
                .limit(1);

            const container = document.getElementById('currentShift');
            
            if (!upcomingShifts || upcomingShifts.length === 0) {
                container.innerHTML = `
                    <div class="shift-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="shift-card-header">
                            <div class="shift-time">No shifts today</div>
                            <div class="shift-participant">Enjoy your day off!</div>
                        </div>
                    </div>
                `;
                return;
            }

            const shift = upcomingShifts[0];
            const isToday = shift.date === today;
            const participantName = shift.participant ? 
                `${shift.participant.first_name} ${shift.participant.last_name}` :
                (shift.location?.name || 'Unassigned');
            
            container.innerHTML = `
            <div class="shift-card" data-shift-id="${shift.id}" data-action="toggleShiftDetails">
                    <div class="shift-card-header">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                        <div class="shift-participant">${participantName}</div>
                        <div class="shift-location">
                            ðŸ“ ${shift.location?.name || shift.location?.address || 'Client Home'}
                        </div>
                        <div class="shift-status">${isToday ? 'TODAY' : 'TOMORROW'}</div>
                    </div>
                    <div class="shift-expand-icon">â–¼</div>
                    <div class="shift-details">
                        <div class="handover-section">
                            <div class="handover-title">Handover Notes</div>
                            <div id="handoverNotes">Loading...</div>
                            <button class="modal-btn primary mt-2" data-action-with-param="addNoteToShift" data-param="${shift.id}">Add Note</button>
                        </div>
                    </div>
                </div>
            `;

            // Load handover notes
            loadHandoverNotes(shift.id);
        }

function switchTransferTab(tab) {
    // Update tab styling
    document.querySelectorAll('.transfer-tab').forEach(t => {
        t.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Hide all transfer content divs
    document.getElementById('incomingTransfers').classList.remove('active');
    document.getElementById('outgoingTransfers').classList.remove('active');
    document.getElementById('availableTransfers').classList.remove('active');
    
    // Show selected tab content
    if (tab === 'incoming') {
        document.getElementById('incomingTransfers').classList.add('active');
    } else if (tab === 'outgoing') {
        document.getElementById('outgoingTransfers').classList.add('active');
    } else if (tab === 'available') {
        document.getElementById('availableTransfers').classList.add('active');
        // Load available shifts if needed
        if (typeof loadAvailableTransfers === 'function') {
            loadAvailableTransfers();
        }
    }
}
async function enrichRequestData(requests, type) {
    if (!requests || requests.length === 0) return [];
    
    return await Promise.all(requests.map(async req => {
        const shift = shifts.find(s => s.id === req.shift_id);
        const participant = shift ? participants.find(p => p.id === shift.participant_id) : null;
        const location = shift ? locations.find(l => l.id === shift.location_id) : null;
        
        const baseEnrichment = {
            ...req,
            shift: shift ? {
                ...shift,
                participant,
                location,
                participantName: participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    (location?.name || 'Unassigned')
            } : null
        };
        
        if (type === 'transfer') {
            return {
                ...baseEnrichment,
                fromStaff: staff.find(s => s.id === req.from_staff_id),
                toStaff: req.to_staff_id ? staff.find(s => s.id === req.to_staff_id) : null
            };
        } else if (type === 'adjustment') {
            return {
                ...baseEnrichment,
                staff: staff.find(s => s.id === req.staff_id)
            };
        }
        
        return baseEnrichment;
    }));
}

async function requestTransfer(shiftId) {
    // Ensure shift_id is INTEGER for database
    const { data, error } = await supabaseClient
        .from('transfer_requests')
        .insert({
            shift_id: parseInt(shiftId), // CRITICAL: Convert to INTEGER
            from_staff_id: currentStaff.id,
            to_staff_id: null,
            status: 'pending',
            reason: 'Personal reason',
            created_at: new Date().toISOString() // Add required field
        });
    
    if (error) {
        console.error('Transfer request error:', error);
        if (error.code === DB_ERRORS.FOREIGN_KEY_VIOLATION) {
            showToast('Invalid shift reference', 'error');
        } else {
            showToast('Failed to request transfer', 'error');
        }
    } else {
        showToast('Transfer request submitted', 'success');
    }
}


function toggleTimeFields() {
    const dutyType = document.getElementById('shiftDutyType');
    const timeFields = document.getElementById('timeFields');
    
    if (dutyType && timeFields) {
        // Hide time fields for sleepover shifts
        if (dutyType.options[dutyType.selectedIndex]?.text?.toLowerCase().includes('sleepover')) {
            timeFields.style.display = 'none';
        } else {
            timeFields.style.display = 'block';
        }
    }
}



function showDocumentUploadModal() {
    // Open the document upload modal
    const modal = document.getElementById('documentUploadModal');
    if (modal) {
        modal.classList.add('active');
    } else {
        // If modal doesn't exist, show simple file input
        document.getElementById('documentFile')?.click();
    }
}

async function loadAvailableTransfers() {
    try {
        // Load shifts available for transfer (from other staff)
        const { data: available } = await supabaseClient
            .from('transfer_requests')
            .select(`
                *,
                shift:shift_id(date, start_time, end_time, participant:participant_id(first_name, last_name)),
                from_staff:from_staff_id(first_name, last_name)
            `)
            .is('to_staff_id', null) // Open to anyone
            .eq('status', 'pending')
            .neq('from_staff_id', currentStaff.id) // Not your own
            .order('created_at', { ascending: false });

        const container = document.getElementById('availableList');
        if (!container) return;
        
        if (!available || available.length === 0) {
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No available shifts to pick up</div>';
            return;
        }

        container.innerHTML = available.map(transfer => `
            <div class="transfer-item">
                <div class="transfer-header">
                    <div>
                        <div class="transfer-date">${formatDateLong(transfer.shift.date)}</div>
                        <div class="transfer-time">
                            ${transfer.shift.start_time ? formatTime(transfer.shift.start_time) : 'Sleepover'} - 
                            ${transfer.shift.end_time ? formatTime(transfer.shift.end_time) : ''}
                        </div>
                    </div>
                </div>
                <div class="transfer-from">
                    From: ${transfer.from_staff.first_name} ${transfer.from_staff.last_name}
                </div>
                ${transfer.reason ? `<div class="transfer-reason">"${transfer.reason}"</div>` : ''}
                <div class="transfer-actions">
                    <button class="transfer-btn accept" data-action-with-param="acceptTransfer" data-param="${transfer.id}">Pick Up Shift</button>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading available transfers:', error);
    }
}



async function loadPendingRequests() {
    try {
        // Get shifts with pending transfers or adjustments
        const { data: pendingShifts } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name)
            `)
            .or(`transfer_to_staff.eq.${currentStaff.id},and(staff_id.eq.${currentStaff.id},adjustment_status.eq.pending)`)
            .eq('transfer_status', 'pending')
            .is('deleted_at', null)
            .order('date', { ascending: true });

        const container = document.getElementById('pendingRequestsList');
        if (!container) return;

        if (!pendingShifts || pendingShifts.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No pending requests</p>';
            return;
        }

        container.innerHTML = pendingShifts.map(shift => {
            const isTransfer = shift.transfer_to_staff === currentStaff.id;
            const isAdjustment = shift.adjustment_status === 'pending' && shift.staff_id === currentStaff.id;
            
            return `
                <div class="request-item">
                    <div class="request-badge">${isTransfer ? 'Transfer' : 'Adjustment'}</div>
                    <div class="request-date">${formatDateShort(shift.date)}</div>
                    <div class="request-details">
                        ${shift.participants ? 
                            `${shift.participants.first_name} ${shift.participants.last_name}` : 
                            'Unknown Client'}
                        ${shift.start_time ? ` - ${formatTime12Hour(shift.start_time)}` : ' - Sleepover'}
                    </div>
                    ${isTransfer ? 
                        `<button data-action-with-param="approveTransfer" data-param="${shift.id}"
 class="btn btn-sm btn-primary">Accept</button>` :
                        `<div class="text-muted">Pending Admin Approval</div>`
                    }
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading pending requests:', error);
    }
}
        


function showLoading() {
    document.body.classList.add('loading');
}
function hideLoading() {
    document.body.classList.remove('loading');
}

        

        async function loadNotifications() {
    try {
        // Ensure we have currentUser from auth
        if (!currentUser) {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;
            currentUser = user;
        }

        // Use correct column names: user_id and read_at
        const { data: notifications, error } = await supabaseClient
            .from('notifications')
            .select('*')
            .eq('user_id', currentUser.id)
            .is('read_at', null)
            .order('created_at', { ascending: false })
            .limit(5);

        if (error) {
            console.error('Error loading notifications:', error);
            return;
        }

        const container = document.getElementById('recentNotifications');
        if (!container) return;

        if (!notifications || notifications.length === 0) {
            container.innerHTML = '<div class="notification-item">No new notifications</div>';
            return;
        }

        container.innerHTML = notifications.map(note => `
            <div class="notification-item ${note.notification_type || ''}" data-action-with-param="markAsRead" data-param="${note.id}">
                <div class="notification-content">${note.message || 'New notification'}</div>
                <div class="notification-time">${formatDateTime(note.created_at)}</div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error in loadNotifications:', error);
        const container = document.getElementById('recentNotifications');
        if (container) {
            container.innerHTML = '<div class="notification-item">Unable to load notifications</div>';
        }
    }
}

async function acceptTransfer(transferRequestId) {
    try {
        const { data: transferRequest, error: fetchError } = await supabaseClient
            .from('transfer_requests')
            .select('*')
            .eq('id', transferRequestId)
            .single();
        
        if (fetchError) throw fetchError;
        
        const { error: transferError } = await supabaseClient
            .from('transfer_requests')
            .update({
                status: 'accepted',
                approved_by: currentStaff.id,
                approved_at: new Date().toISOString()
            })
            .eq('id', transferRequestId);
        
        if (transferError) throw transferError;
        
        const { error: shiftError } = await supabaseClient
            .from('shifts')
            .update({
                staff_id: currentStaff.id,
                transfer_status: 'completed',
                transfer_approved_by: currentStaff.id,
                transfer_approved_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .eq('id', transferRequest.shift_id);
        
        if (shiftError) throw shiftError;
        
        showToast('Transfer accepted successfully', 'success');
        loadIncomingTransfers();
        loadSchedule();
        
    } catch (error) {
        console.error('Error accepting transfer:', error);
        showToast('Failed to accept transfer', 'error');
    }
}

async function rejectTransfer(transferRequestId) {
    try {
        const { data: transferRequest, error: fetchError } = await supabaseClient
            .from('transfer_requests')
            .select('shift_id')
            .eq('id', transferRequestId)
            .single();
        
        if (fetchError) throw fetchError;
        
        const { error: transferError } = await supabaseClient
            .from('transfer_requests')
            .update({
                status: 'rejected',
                rejected_by: currentStaff.id,
                rejected_at: new Date().toISOString()
            })
            .eq('id', transferRequestId);
        
        if (transferError) throw transferError;
        
        const { error: shiftError } = await supabaseClient
            .from('shifts')
            .update({
                transfer_status: 'none',
                updated_at: new Date().toISOString()
            })
            .eq('id', transferRequest.shift_id);
        
        if (shiftError) throw shiftError;
        
        showToast('Transfer rejected', 'info');
        loadIncomingTransfers();
        
    } catch (error) {
        console.error('Error rejecting transfer:', error);
        showToast('Failed to reject transfer', 'error');
    }
}

async function fetchNotes(shiftId) {
    if (!shiftId) return [];
    
    try {
        const { data: notes, error } = await supabaseClient
            .from('shift_notes')
            .select(`
                *,
                staff:staff_id(first_name, last_name)
            `)
            .eq('shift_id', parseInt(shiftId))  // Simple integer
            .is('deleted_at', null)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error fetching notes:', error);
            return [];
        }
        
        return notes || [];
        
    } catch (error) {
        console.error('Error in fetchNotes:', error);
        return [];
    }
}

    
async function logout() {
    try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        window.location.href = 'index.html';
    } catch (error) {
        console.error('Logout error:', error);
        showToast('Failed to logout', 'error');
    }
}


        async function loadParticipants() {
    try {
        const { data, error } = await supabaseClient
            .from('participants')
            .select('*')
            .eq('is_active', true)
            .is('deleted_at', null)  // ADDED soft delete filter
            .order('first_name');
        
        if (error) {
            console.error('Error loading participants:', error);
            return [];
        }
        
        participants = data || [];
        
        // Build care home locations set
        careHomeLocations.clear();
        participants.forEach(p => {
            if (p.address && p.address.toLowerCase().includes('saunders')) {
                careHomeLocations.add(p.id);
            }
        });
        
        console.log('Loaded participants:', participants.length);
        return participants;
        
    } catch (error) {
        console.error('Error in loadParticipants:', error);
        return [];
    }
}

async function buildParticipantLocationMapping() {
    // Clear existing mappings
    participantDefaultLocations.clear();
    careHomeLocations.clear();
    
    // First, identify all care home locations
    if (locations && locations.length > 0) {
        locations.forEach(loc => {
            if (loc.is_care_home) {
                careHomeLocations.add(loc.id);
            }
        });
    }
    
    // Map participants to their default locations based on address
    participants.forEach(p => {
        if (!p.address) return;
        
        const addressLower = p.address.toLowerCase();
        
        // Check for Saunders Care Home
        if (addressLower.includes('saunders')) {
            const saundersLocation = locations.find(loc => 
                loc.name.toLowerCase().includes('saunders') || 
                (loc.address && loc.address.toLowerCase().includes('saunders'))
            );
            
            if (saundersLocation) {
                participantDefaultLocations.set(p.id, saundersLocation.id);
                console.log(`Mapped ${p.first_name} ${p.last_name} to Saunders Care Home`);
            }
        } 
        // Check for other care homes by matching addresses
        else {
            const matchingCareHome = locations.find(loc => {
                if (!loc.is_care_home || !loc.address) return false;
                
                // Extract street/building name from both addresses
                const locStreet = loc.address.toLowerCase().split(',')[0].trim();
                const participantStreet = addressLower.split(',')[0].trim();
                
                // Check if participant's address contains the care home's street
                return participantStreet.includes(locStreet) || locStreet.includes(participantStreet);
            });
            
            if (matchingCareHome) {
                participantDefaultLocations.set(p.id, matchingCareHome.id);
                console.log(`Mapped ${p.first_name} ${p.last_name} to ${matchingCareHome.name}`);
            }
        }
    });
    
    console.log(`Mapped ${participantDefaultLocations.size} participants to care homes`);
}

function populateParticipantDropdowns() {
    const dropdownIds = ['shiftParticipant', 'noteParticipant', 'transferParticipant'];
    
    dropdownIds.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;
        
        // Clear existing options
        select.innerHTML = '<option value="">Select Client</option>';
        
        // Separate participants into care home and home clients
        const careHomeParticipants = [];
        const homeParticipants = [];
        
        participants.forEach(p => {
            if (participantDefaultLocations.has(p.id)) {
                const locationId = participantDefaultLocations.get(p.id);
                const location = locations.find(l => l.id === locationId);
                careHomeParticipants.push({
                    participant: p,
                    locationName: location ? location.name : 'Care Home'
                });
            } else {
                homeParticipants.push(p);
            }
        });
        
        // Add care home residents with location labels
        if (careHomeParticipants.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = 'Care Home Residents';
            
            careHomeParticipants.forEach(item => {
                const option = document.createElement('option');
                option.value = item.participant.id;
                option.textContent = `${item.participant.first_name} ${item.participant.last_name} (${item.locationName})`;
                option.dataset.locationId = participantDefaultLocations.get(item.participant.id);
                optgroup.appendChild(option);
            });
            
            select.appendChild(optgroup);
        }
        
        // Add home clients
        if (homeParticipants.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = 'Home Clients';
            
            homeParticipants.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.first_name} ${p.last_name}`;
                optgroup.appendChild(option);
            });
            
            select.appendChild(optgroup);
        }
    });
}

function onParticipantSelect(participantSelectId, locationSelectId) {
    const participantSelect = document.getElementById(participantSelectId);
    const locationSelect = document.getElementById(locationSelectId);
    
    if (!participantSelect || !locationSelect) return;
    
    const participantId = participantSelect.value;
    
    if (!participantId) {
        locationSelect.value = '';
        return;
    }
    
    // Check if this participant has a default care home location
    if (participantDefaultLocations.has(participantId)) {
        const defaultLocationId = participantDefaultLocations.get(participantId);
        locationSelect.value = defaultLocationId;
        
        const location = locations.find(l => l.id === defaultLocationId);
        console.log(`Auto-selected location: ${location ? location.name : 'Unknown'}`);
        
        // Show a brief notification
        const locationName = location ? location.name : 'care home';
        showToast(`Auto-selected ${locationName}`, 'info');
    } else {
        // Try to select "Client Home" as default for non-care home residents
        const clientHome = locations.find(l => 
            l.name.toLowerCase().includes('client home') || 
            l.id === '00000000-0000-0000-0000-000000000001'
        );
        
        if (clientHome) {
            locationSelect.value = clientHome.id;
            console.log('Auto-selected Client Home as default');
        }
    }
}

function setupParticipantLocationListeners() {
    // For shift creation modal
    const shiftParticipant = document.getElementById('shiftParticipant');
    if (shiftParticipant) {
        shiftParticipant.addEventListener('change', function() {
            onParticipantSelect('shiftParticipant', 'shiftLocation');
        });
    }
    
    // For transfer request modal (if it has location)
    const transferParticipant = document.getElementById('transferParticipant');
    if (transferParticipant) {
        transferParticipant.addEventListener('change', function() {
            // Transfers might not have location, but we can still track it
            console.log('Participant selected for transfer');
        });
    }
    
    // For any edit modals
    const editParticipant = document.getElementById('editShiftParticipant');
    if (editParticipant) {
        editParticipant.addEventListener('change', function() {
            onParticipantSelect('editShiftParticipant', 'editShiftLocation');
        });
    }
}



async function initializeParticipantLocations() {
    // Make sure locations are loaded first
    if (!locations || locations.length === 0) {
        await loadLocations();
    }
    
    // Then load participants with location mapping
    await loadParticipants();
    
    // Setup event listeners
    setupParticipantSelects();
}



async function saveWeeklyAvailability() {
    try {
        const startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        
        // Get next 4 weeks of dates
        const records = [];
        for (let week = 0; week < 4; week++) {
            for (let day = 0; day < 7; day++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + (week * 7) + day);
                
                // Check if this day is marked as available
                const checkbox = document.querySelector(`input[data-day="${day}"][data-week="${week}"]`);
                if (checkbox && checkbox.checked) {
                    records.push({
                        staff_id: currentStaff.id,
                        date: date.toISOString().split('T')[0],
                        is_available: true,
                        start_time: '09:00:00',
                        end_time: '17:00:00',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                }
            }
        }
        
        if (records.length === 0) {
            showToast('Please select at least one available day', 'warning');
            return;
        }
        
        // Clear old availability for this period
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 28);
        
        await supabaseClient
            .from('staff_availability')
            .delete()
            .eq('staff_id', currentStaff.id)
            .gte('date', startDate.toISOString().split('T')[0])
            .lte('date', endDate.toISOString().split('T')[0]);
        
        // Insert new availability
        const { error } = await supabaseClient
            .from('staff_availability')
            .insert(records);
        
        if (error) throw error;
        
        showToast('Weekly availability saved successfully', 'success');
        
    } catch (error) {
        console.error('Error saving weekly availability:', error);
        showToast('Failed to save availability: ' + error.message, 'error');
    }
}


async function loadDocuments() {
    if (!currentStaff) {
        console.log('No current staff to load documents for');
        return;
    }
    
    try {
        // Load documents WITHOUT the join
        const { data: documents, error } = await supabaseClient
            .from('documents')
            .select('*')
            .eq('entity_type', 'staff')
            .eq('entity_id', currentStaff.id)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error loading documents:', error);
            return;
        }
        
        // Load document types separately
        const { data: documentTypes } = await supabaseClient
            .from('document_types')
            .select('*');
        
        // Enrich documents with type information
        if (documents && documentTypes) {
            documents.forEach(doc => {
                doc.document_type = documentTypes.find(t => t.id === doc.type_id);
            });
        }
        
        displayDocuments(documents || []);
        
    } catch (error) {
        console.error('Error in loadDocuments:', error);
        showToast('Failed to load documents', 'error');
    }
}

function displayDocuments(documents) {
    const container = document.getElementById('documentsList');
    if (!container) return;
    
    if (!documents || documents.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-file-alt"></i>
                <p>No documents uploaded yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = documents.map(doc => {
        // Get type info from enriched data
        const typeName = doc.document_type?.name || 'Unknown Type';
        const requiresExpiry = doc.document_type?.requires_expiry || false;
        
        // Check if document is expired
        const isExpired = doc.expiry_date && new Date(doc.expiry_date) < new Date();
        const expiryClass = isExpired ? 'expired' : '';
        const expiryWarning = isExpired ? '<span class="badge danger">Expired</span>' : '';
        
        return `
            <div class="document-item ${expiryClass}">
                <div class="document-info">
                    <h4>${doc.title}</h4>
                    <p class="document-type">${typeName}</p>
                    ${doc.expiry_date ? `
                        <p class="expiry-date">
                            Expires: ${formatDate(doc.expiry_date)}
                            ${expiryWarning}
                        </p>
                    ` : ''}
                    ${doc.notes ? `<p class="notes">${doc.notes}</p>` : ''}
                </div>
                <div class="document-actions">
                    <a href="${doc.file_url}" target="_blank" class="btn btn-sm btn-primary">View</a>
                    <button data-action-with-param="deleteDocument" data-param="${doc.id}" class="btn btn-sm btn-danger">Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

        async function loadAvailability() {
            const { data: availability } = await supabaseClient
                .from('staff_weekly_availability')
                .select('*')
                .eq('staff_id', currentStaff.id);

            if (availability) {
                availability.forEach(slot => {
                    const key = `${slot.day_of_week}_${slot.time_slot}`;
                    weeklyAvailability[key] = slot.available;
                });
            }

            renderAvailability();
        }


        async function approveTransfer(shiftId) {
    try {
        if (!confirm('Accept this shift transfer?')) return;

        // Get the shift details
        const { data: shift } = await supabaseClient
            .from('shifts')
            .select('*')
            .is('deleted_at', null)
            .eq('id', parseInt(shiftId))
            .single();

        if (!shift) {
            showToast('Shift not found', 'error');
            return;
        }

        // Check for conflicts before accepting
        const { data: conflicts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('date', shift.date)
            .is('deleted_at', null);

        if (conflicts && conflicts.length > 0) {
            if (!confirm(`You already have ${conflicts.length} shift(s) on this date. Continue anyway?`)) {
                return;
            }
        }

        // Approve the transfer by updating the shift
        const { error } = await supabaseClient
            .from('shifts')
            .update({
                staff_id: currentStaff.id,  // Take ownership
                transfer_status: 'completed',
                transfer_approved_by: currentStaff.id,
                updated_at: new Date().toISOString()
            })
            .eq('id', parseInt(shiftId));

        if (error) throw error;

        showToast('Transfer accepted successfully', 'success');
        loadTransfers();
        loadDashboard();

    } catch (error) {
        console.error('Error accepting transfer:', error);
        showToast('Failed to accept transfer', 'error');
    }
}

// Helper function to check if a duty type is a sleepover
async function checkIfSleepover(dutyTypeId) {
    if (!dutyTypeId) return false;
    
    const dutyType = dutyTypes.find(dt => dt.id === dutyTypeId);
    if (dutyType) {
        return dutyType.name?.toLowerCase().includes('sleepover');
    }
    
    // Fallback to database query if not in cache
    const { data } = await supabaseClient
        .from('duty_types')
        .select('name')
        .is('deleted_at', null)
        .eq('id', dutyTypeId)
        .single();
    
    return data?.name?.toLowerCase().includes('sleepover') || false;
}


// Helper function to parse time string to minutes for comparison
function parseTime(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
}

// Helper function to calculate shift duration in hours
function calculateShiftDuration(startTime, endTime) {
    const start = parseTime(startTime);
    const end = parseTime(endTime);
    
    // Handle overnight shifts
    const duration = end > start ? end - start : (1440 - start) + end;
    return duration / 60;
}

async function displayShiftNotes(shiftId) {
    const container = document.getElementById('shiftNotesList');
    if (!container) return;
    
    const notes = await fetchNotes(shiftId);
    
    if (notes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-sticky-note"></i>
                <p>No notes for this shift</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = notes.map(note => `
        <div class="note-item">
            <div class="note-header">
                <span class="note-type badge">${note.note_type || 'General'}</span>
                <span class="note-author">${note.staff?.first_name || 'Unknown'} ${note.staff?.last_name || ''}</span>
            </div>
            <div class="note-content">${escapeHtml(note.note)}</div>
            <div class="note-footer">
                <span class="note-time">${formatDateTime(note.created_at)}</span>
                ${note.staff_id === currentStaff.id ? `
                    <button data-action-with-param="deleteNote" data-param="${note.id}" class="btn-delete-note">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
}


async function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('shift_notes')
            .update({ deleted_at: new Date().toISOString() })
            .eq('id', noteId)
            .eq('staff_id', currentStaff.id);
        
        if (error) throw error;
        
        showToast('Note deleted successfully', 'success');
        
        if (typeof refreshCurrentView === 'function') {
            refreshCurrentView();
        }
        
    } catch (error) {
        console.error('Error deleting note:', error);
        showToast('Failed to delete note', 'error');
    }
}



function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function checkShiftHasNotes(shiftId) {
    const { count, error } = await supabaseClient
        .from('shift_notes')
        .select('*', { count: 'exact', head: true })
        .eq('shift_id', parseInt(shiftId))  // Simple integer
        .is('deleted_at', null);
    
    return count > 0;
}

async function submitShift() {
    try {
        const date = document.getElementById('shiftDate').value;
        const participantId = document.getElementById('shiftParticipant').value;
        const dutyTypeId = document.getElementById('shiftDutyType').value;
        const notes = document.getElementById('shiftNotes').value;
        const startTime = document.getElementById('shiftStartTime').value;
        const endTime = document.getElementById('shiftEndTime').value;
        
        // GET THE LOCATION VALUE
        const locationId = document.getElementById('shiftLocation').value;
        
        // Validate required fields
        if (!date || !participantId || !dutyTypeId) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        // Determine final location
        let finalLocationId = locationId;
        if (!finalLocationId) {
            // Auto-assign based on participant
            const participant = participants.find(p => p.id === participantId);
            if (participant?.address?.toLowerCase().includes('saunders')) {
                // Find Saunders location
                const saundersLocation = locations.find(l => 
                    l.name.toLowerCase().includes('saunders') || 
                    l.id === '00000000-0000-0000-0000-000000000003'
                );
                finalLocationId = saundersLocation?.id;
            } else {
                // Default to Client Home
                const clientHome = locations.find(l => 
                    l.name.toLowerCase().includes('client home') ||
                    l.id === '00000000-0000-0000-0000-000000000001'
                );
                finalLocationId = clientHome?.id;
            }
        }
        
        if (!finalLocationId) {
            showToast('Unable to determine location. Please select a location.', 'error');
            return;
        }

        // GET THE CORRECT PAY RATE
        let payRateId = null;
        
        // Check if current staff has a pay_rate_id
        if (currentStaff?.pay_rate_id) {
            payRateId = currentStaff.pay_rate_id;
        }
        
        // If no pay rate found, use default
        if (!payRateId) {
            payRateId = '00000000-0000-0000-0000-000000000002'; // Default pay rate UUID
        }

        // Create shift data with CORRECT pay_override_id
        const shiftData = {
            date: date,
            start_time: startTime || null,
            end_time: endTime || null,
            staff_id: currentStaff.id,
            participant_id: participantId,
            duty_type_id: dutyTypeId,
            location_id: finalLocationId,
            pay_override_id: payRateId, // NOW USING CORRECT PAY RATE!
            created_by: currentUser.id,
            status: 'pending',
            notes: notes || null
        };

const payOverrideId = currentStaff?.pay_rate_id;
        
        if (!payOverrideId) {
            showToast('Staff pay rate not found', 'error');
            return;
        }
        const { data, error } = await supabaseClient
            .from('shifts')
            .insert({
                staff_id: currentStaff.id,
                participant_id: participantId,
                location_id: locationId,
                duty_type_id: dutyTypeId,
                pay_override_id: payOverrideId, // CRITICAL: Add this
                date: shiftDate,
                start_time: startTime || null,
                end_time: endTime || null,
                status: 'scheduled',
                notes: notes || null,
                created_by: currentStaff.id,
                created_at: new Date().toISOString()
            })
            .select()
            .single();
            
        if (error) throw error;

        showToast('Shift submitted for approval', 'success');
        closeModal('addShiftModal');
        
        // Clear form
        document.getElementById('shiftForm').reset();
        
        // Reload shifts
        if (typeof loadMyShifts === 'function') {
            await loadMyShifts();
        }
        if (typeof renderSchedule === 'function') {
            renderSchedule();
        }

    } catch (error) {
        console.error('Error submitting shift:', error);
        showToast('Failed to submit shift: ' + error.message, 'error');
    }
}


function populateLocationDropdown() {
    const select = document.getElementById('shiftLocation');
    if (!select || !locations) return;
    
    select.innerHTML = '<option value="">Select Location</option>';
    
    // Group by care home status
    const careHomes = locations.filter(l => l.is_care_home);
    const otherLocations = locations.filter(l => !l.is_care_home);
    
    if (careHomes.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Care Homes';
        careHomes.forEach(l => {
            const option = document.createElement('option');
            option.value = l.id;
            option.textContent = l.name;
            optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
    }
    
    if (otherLocations.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Other Locations';
        otherLocations.forEach(l => {
            const option = document.createElement('option');
            option.value = l.id;
            option.textContent = l.name;
            optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
    }
}

function onDutyTypeChange() {
    const dutyTypeSelect = document.getElementById('shiftDutyType');
    const selectedOption = dutyTypeSelect.options[dutyTypeSelect.selectedIndex];
    const dutyTypeName = selectedOption?.text || '';
    
    const isSleepover = dutyTypeName.toLowerCase().includes('sleepover');
    
    const timeFieldsContainer = document.querySelector('.time-fields-group');
    const startTimeInput = document.getElementById('shiftStartTime');
    const endTimeInput = document.getElementById('shiftEndTime');
    
    if (isSleepover) {
        // Hide time fields for sleepover
        if (timeFieldsContainer) {
            timeFieldsContainer.style.display = 'none';
        }
        // Clear and disable time inputs
        if (startTimeInput) {
            startTimeInput.value = '';
            startTimeInput.required = false;
        }
        if (endTimeInput) {
            endTimeInput.value = '';
            endTimeInput.required = false;
        }
    } else {
        // Show time fields for regular shifts
        if (timeFieldsContainer) {
            timeFieldsContainer.style.display = 'block';
        }
        // Enable and require time inputs
        if (startTimeInput) {
            startTimeInput.required = true;
        }
        if (endTimeInput) {
            endTimeInput.required = true;
        }
    }
}

function setCurrentPayPeriod(offset = 0) {
    try {
        // Update the global offset
        window.periodOffset = offset;
        
        // Calculate the current period
        const period = calculatePayPeriod(new Date(), window.periodOffset);
        
        // Store globally
        window.currentPeriodStart = period.start;
        window.currentPeriodEnd = period.end;
        
        // Update UI
        updatePeriodDisplay(period.start, period.end);
        
        // Reload timesheet if visible
        if (document.querySelector('.timesheet-section')?.style.display !== 'none') {
            loadTimesheetForPeriod(period.start, period.end);
        }
        
        console.log('Period set:', {
            start: period.start.toLocaleDateString(),
            end: period.end.toLocaleDateString(),
            offset: window.periodOffset
        });
        
    } catch (error) {
        console.error('Error setting pay period:', error);
        // Set fallback dates
        const today = new Date();
        window.currentPeriodStart = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
        window.currentPeriodEnd = today;
    }
}

function showAddShiftModal() {
    const modal = document.getElementById('addShiftModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        populateShiftModalDropdowns();
        populateLocationDropdown();
        
        // Set default duty type to Active Shift after dropdowns are populated
        setTimeout(() => {
            const dutySelect = document.getElementById('shiftDutyType');
            if (dutySelect) {
                // Find and select "Active Shift"
                for (let i = 0; i < dutySelect.options.length; i++) {
                    if (dutySelect.options[i].text === 'Active Shift') {
                        dutySelect.selectedIndex = i;
                        onDutyTypeChange(); // Update time fields visibility
                        break;
                    }
                }
            }
        }, 100);
    }
}

async function loadTransferableShifts() {
    try {
        const today = getTestDate();
        today.setHours(0, 0, 0, 0);
        
        const fourteenDaysFromNow = new Date(today);
        fourteenDaysFromNow.setDate(fourteenDaysFromNow.getDate() + 14);
        
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                id,
                date,
                start_time,
                end_time,
                participant_id,
                duty_type_id,
                participant:participants(first_name, last_name),
                duty_type:duty_types(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', today.toISOString().split('T')[0])
            .lte('date', fourteenDaysFromNow.toISOString().split('T')[0])
            .is('deleted_at', null)
            .order('date', { ascending: true })
            .order('start_time', { ascending: true });

        if (error) throw error;

        const select = document.getElementById('transferShiftSelect');
        select.innerHTML = '<option value="">Select a shift to transfer</option>';
        
        if (!shifts || shifts.length === 0) {
            select.innerHTML += '<option value="" disabled>No upcoming shifts to transfer</option>';
            return;
        }
        
        shifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id;
            
            const date = new Date(shift.date);
            const dayName = date.toLocaleDateString('en-AU', { weekday: 'short' });
            const day = date.getDate();
            const month = date.toLocaleDateString('en-AU', { month: 'short' });
            
            const participantName = shift.participant 
                ? `${shift.participant.first_name} ${shift.participant.last_name}`
                : 'Unassigned';
            
            const isSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover') || false;
            
            let timeRange = '';
            if (!isSleepover && shift.start_time && shift.end_time) {
                const startTime = formatTimeDisplay(shift.start_time);
                const endTime = formatTimeDisplay(shift.end_time);
                timeRange = `, ${startTime}-${endTime}`;
            } else if (isSleepover) {
                timeRange = ', Sleepover';
            }
            
            const dutyTypeLabel = shift.duty_type?.name || 'Standard';
            option.textContent = `${dayName} ${day} ${month} - ${participantName}${timeRange} (${dutyTypeLabel})`;
            
            option.dataset.date = shift.date;
            option.dataset.startTime = shift.start_time || '';
            option.dataset.endTime = shift.end_time || '';
            option.dataset.isSleepover = isSleepover.toString();
            
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading transferable shifts:', error);
        showToast('Failed to load shifts', 'error');
    }
}

// Initialize searchable staff dropdown
async function initializeStaffSearch() {
    // Load all active staff
    const { data: staffList, error } = await supabaseClient
        .from('staff')
        .select('id, first_name, last_name, staff_code')
        .eq('is_active', true)
        .is('deleted_at', null)
        .neq('id', currentStaff.id)  // Exclude current user
        .order('first_name');
    
    if (error) {
        console.error('Error loading staff:', error);
        return;
    }
    
    window.availableStaff = staffList || [];
    
    const searchInput = document.getElementById('transferToStaffSearch');
    const resultsDiv = document.getElementById('staffSearchResults');
    const hiddenSelect = document.getElementById('transferToStaff');
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        if (searchTerm.length === 0) {
            resultsDiv.style.display = 'none';
            return;
        }
        
        const filtered = window.availableStaff.filter(s => 
            `${s.first_name} ${s.last_name}`.toLowerCase().includes(searchTerm) ||
            s.staff_code?.toLowerCase().includes(searchTerm)
        );
        
        if (filtered.length > 0) {
            resultsDiv.innerHTML = filtered.map(s => `
                <div class="search-dropdown-item" data-id="${s.id}" data-name="${s.first_name} ${s.last_name}">
                    ${s.first_name} ${s.last_name} (${s.staff_code || 'No code'})
                </div>
            `).join('');
            resultsDiv.style.display = 'block';
        } else {
            resultsDiv.innerHTML = '<div class="search-dropdown-item">No staff found</div>';
            resultsDiv.style.display = 'block';
        }
    });
    
    // Click handler for dropdown items
    resultsDiv.addEventListener('click', function(e) {
        const item = e.target.closest('.search-dropdown-item');
        if (item && item.dataset.id) {
            searchInput.value = item.dataset.name;
            hiddenSelect.value = item.dataset.id;
            resultsDiv.style.display = 'none';
            
            // Check for conflicts when staff is selected
            checkTransferConflicts();
        }
    });
    
    // Hide dropdown on click outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });
}

// Check for transfer conflicts
async function checkTransferConflicts() {
    const shiftSelect = document.getElementById('transferShiftSelect');
    const targetStaffId = document.getElementById('transferToStaff').value;
    
    if (!shiftSelect.value || !targetStaffId) {
        document.getElementById('transferConflictWarning').style.display = 'none';
        return;
    }
    
    const selectedShift = shiftSelect.options[shiftSelect.selectedIndex];
    const shiftDate = selectedShift.dataset.date;
    const shiftStart = selectedShift.dataset.startTime;
    const shiftEnd = selectedShift.dataset.endTime;
    const isSleepover = selectedShift.dataset.isSleepover === 'true';
    
    // Get target staff's shifts on the same date
    const { data: targetShifts, error } = await supabaseClient
        .from('shifts')
        .select(`
            id, 
            start_time, 
            end_time,
            duty_type:duty_types(name)
        `)
        .eq('staff_id', targetStaffId)
        .eq('date', shiftDate)
        .is('deleted_at', null);
    
    if (error) {
        console.error('Error checking conflicts:', error);
        return;
    }
    
    const warningDiv = document.getElementById('transferConflictWarning');
    let hasConflict = false;
    let requiresApproval = false;
    let conflictMessage = '';
    
    if (targetShifts && targetShifts.length > 0) {
        for (const existingShift of targetShifts) {
            const existingIsSleepover = existingShift.duty_type?.name?.toLowerCase().includes('sleepover');
            
            // Check if either is a sleepover
            if (isSleepover || existingIsSleepover) {
                hasConflict = true;
                conflictMessage = 'â›” Cannot transfer: Target staff already has a shift on this date (sleepover conflict)';
                break;
            }
            
            if (shiftStart && shiftEnd && existingShift.start_time && existingShift.end_time) {
                const newStart = parseTimeToMinutes(shiftStart);
                const newEnd = parseTimeToMinutes(shiftEnd);
                const existingStart = parseTimeToMinutes(existingShift.start_time);
                const existingEnd = parseTimeToMinutes(existingShift.end_time);
                
                // Check for direct overlap
                if (!(newEnd <= existingStart || newStart >= existingEnd)) {
                    hasConflict = true;
                    conflictMessage = `â›” Cannot transfer: Overlaps with existing shift (${formatTimeDisplay(existingShift.start_time)}-${formatTimeDisplay(existingShift.end_time)})`;
                    break;
                }
                
                // Check for 1-hour buffer
                const gapBefore = newStart - existingEnd;
                const gapAfter = existingStart - newEnd;
                
                if ((gapBefore >= 0 && gapBefore < 60) || (gapAfter >= 0 && gapAfter < 60)) {
                    requiresApproval = true;
                    conflictMessage = `âš ï¸ Warning: Less than 1 hour gap with existing shift (${formatTimeDisplay(existingShift.start_time)}-${formatTimeDisplay(existingShift.end_time)}). Transfer requires manager approval.`;
                }
            }
        }
    }
    
    if (hasConflict) {
        warningDiv.innerHTML = `<div class="alert alert-danger">${conflictMessage}</div>`;
        warningDiv.style.display = 'block';
        document.querySelector('[data-action="submitTransfer"]').disabled = true;
    } else if (requiresApproval) {
        warningDiv.innerHTML = `<div class="alert alert-warning">${conflictMessage}</div>`;
        warningDiv.style.display = 'block';
        document.querySelector('[data-action="submitTransfer"]').disabled = false;
        // Store that this requires approval
        window.transferRequiresApproval = true;
    } else {
        warningDiv.style.display = 'none';
        document.querySelector('[data-action="submitTransfer"]').disabled = false;
        window.transferRequiresApproval = false;
    }
}

// Helper function to parse time
function parseTimeToMinutes(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
}

// Updated submit transfer function
async function submitTransfer() {
    try {
        const shiftId = document.getElementById('transferShiftSelect').value;
        const toStaffId = document.getElementById('transferToStaff').value;
        const reason = document.getElementById('transferReason').value;
        
        if (!shiftId || !toStaffId || !reason) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        // Create transfer request
        const { data, error } = await supabaseClient
            .from('transfer_requests')
            .insert({
                shift_id: parseInt(shiftId),
                from_staff_id: currentStaff.id,
                to_staff_id: toStaffId,
                status: window.transferRequiresApproval ? 'pending_approval' : 'pending',
                reason: reason,
                created_at: new Date().toISOString()
            });
        
        if (!error) {
            // Update shift transfer status
            await supabaseClient
                .from('shifts')
                .update({
                    transfer_status: 'requested'
                })
                .eq('id', parseInt(shiftId));
        }
        
        if (error) {
            console.error('Transfer request error:', error);
            showToast('Failed to submit transfer request', 'error');
        } else {
            const message = window.transferRequiresApproval 
                ? 'Transfer request submitted for manager approval' 
                : 'Transfer request submitted successfully';
            showToast(message, 'success');
            closeModal('transferShiftModal');
            document.getElementById('transferForm').reset();
            document.getElementById('transferToStaffSearch').value = '';
            document.getElementById('transferToStaff').value = '';
        }
    } catch (error) {
        console.error('Error submitting transfer:', error);
        showToast('Failed to submit transfer request', 'error');
    }
}


function showTransferModal() {
    loadTransferableShifts();
    initializeStaffSearch();
    ModalManager.show('transfer');
    
    // Add listeners for conflict checking
    setTimeout(() => {
        const shiftSelect = document.getElementById('transferShiftSelect');
        if (shiftSelect) {
            shiftSelect.addEventListener('change', checkTransferConflicts);
        }
    }, 500);
}

function showAdjustmentModal() {
    loadAdjustmentShifts();
    ModalManager.show('adjustment');
}

function showLeaveModal() {
    ModalManager.show('leave');
}


// ==========================================
// APPSTATE IMPLEMENTATION
// ==========================================

// Since you've already replaced window.* with AppState.*, here's the actual AppState object:

const AppState = {
    staff: {
        current: null,
        original: null,
        all: []
    },
    shifts: {
        my: [],
        filtered: [],
        all: []
    },
    ui: {
        currentSection: 'dashboard',
        timesheetView: 'date',
        periodOffset: 0,
        currentPeriod: null
    },
    cache: {
        participants: [],
        dutyTypes: [],
        locations: [],
        transfers: {
            incoming: [],
            outgoing: []
        }
    },
    
    // Helper methods
    reset() {
        this.staff.original = null;
        this.ui.periodOffset = 0;
        this.ui.timesheetView = 'date';
    },
    
    isInTestMode() {
        return this.staff.original !== null;
    },
    
    getCurrentStaff() {
        return this.staff.current;
    },
    
    setCurrentStaff(staff) {
        this.staff.current = staff;
    },
    
    switchToTestMode(testStaff) {
        if (!this.staff.original) {
            this.staff.original = this.staff.current;
        }
        this.staff.current = testStaff;
    },
    
    exitTestMode() {
        if (this.staff.original) {
            this.staff.current = this.staff.original;
            this.staff.original = null;
        }
    }
};

// Initialize currentStaff reference for backward compatibility
Object.defineProperty(window, 'currentStaff', {
    get() { return AppState.staff.current; },
    set(value) { AppState.staff.current = value; }
});


async function populateParticipantDropdown() {
    const select = document.getElementById('shiftParticipant');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Client</option>';
    
    // Check if participants array is populated
    if (!participants || participants.length === 0) {
        console.log('Participants array empty, loading...');
        await loadReferenceData();
    }
    
    if (participants.length === 0) {
        select.innerHTML += '<option value="">No clients available</option>';
        return;
    }
    
    participants.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.first_name} ${p.last_name}`;
        select.appendChild(option);
    });
}

async function populateDutyTypeDropdown() {
    const select = document.getElementById('shiftDutyType');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Type</option>';
    
    // Check if dutyTypes array is populated
    if (!dutyTypes || dutyTypes.length === 0) {
        console.log('Duty types array empty, loading...');
        await loadReferenceData();
    }
    
    if (dutyTypes.length === 0) {
        select.innerHTML += '<option value="">No duty types available</option>';
        return;
    }
    
    dutyTypes.forEach(dt => {
        const option = document.createElement('option');
        option.value = dt.id;
        option.textContent = dt.name;
        select.appendChild(option);
    });
}

async function populateTransferableShifts() {
    const select = document.getElementById('transferShiftSelect');
    if (!select) return;
    
    // Clear existing options
    select.innerHTML = '<option value="">Select a shift</option>';
    
    // Load shifts for current staff
    const { data: myShifts } = await supabaseClient
        .from('shifts')
        .select('*, participants(first_name, last_name)')
        .eq('staff_id', currentStaff.id)
        .gte('date', getTestDate().toISOString().split('T')[0])
        .order('date', { ascending: true });
    
    if (myShifts && myShifts.length > 0) {
        myShifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id; // This is already an INTEGER
            option.dataset.start = shift.start_time || '';
            option.dataset.end = shift.end_time || '';
            
            const clientName = shift.participants ? 
                `${shift.participants.first_name} ${shift.participants.last_name}` : 
                'Unknown Client';
            option.textContent = `${formatDateShort(shift.date)} - ${clientName} (${shift.start_time || 'Sleepover'})`;
            select.appendChild(option);
        });
    }
}


async function populateStaffDropdown() {
    const select = document.getElementById('transferToStaff');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select staff member (optional)</option>';
    
    // Check if staff array is populated
    if (!staff || staff.length === 0) {
        console.log('Staff array empty, loading...');
        await loadReferenceData();
    }
    
    // Filter out current staff
    const otherStaff = staff.filter(s => s.id !== currentStaff.id);
    
    if (otherStaff.length === 0) {
        select.innerHTML += '<option value="">No other staff available</option>';
        return;
    }
    
    otherStaff.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = `${s.first_name} ${s.last_name}`;
        select.appendChild(option);
    });
}

function ensureIntegerId(id) {
    if (typeof id === 'number') return id;
    const parsed = parseInt(id, 10);
    if (isNaN(parsed)) {
        throw new Error(`Invalid ID: ${id} cannot be converted to integer`);
    }
    return parsed;
}


async function loadAdjustmentShifts() {
    try {
        // Use getTestDate() which applies your DATE_OFFSET_DAYS
        const today = getTestDate();
        today.setHours(23, 59, 59, 999);
        
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        sevenDaysAgo.setHours(0, 0, 0, 0);
        
        console.log('Date range with test offset:', {
            from: sevenDaysAgo.toISOString().split('T')[0],
            to: today.toISOString().split('T')[0]
        });
        
        // Get shifts for the current staff member
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                id,
                date,
                start_time,
                end_time,
                participant_id,
                duty_type_id,
                participant:participants(first_name, last_name),
                duty_type:duty_types(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', sevenDaysAgo.toISOString().split('T')[0])
            .lte('date', today.toISOString().split('T')[0])
            .is('deleted_at', null)
            .order('date', { ascending: false });

        if (error) throw error;

        const select = document.getElementById('adjustmentShift');
        select.innerHTML = '<option value="">Select a shift</option>';
        
        if (!shifts || shifts.length === 0) {
            select.innerHTML += '<option value="" disabled>No shifts in the past 7 days</option>';
            return;
        }
        
        shifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id;
            
            const date = new Date(shift.date);
            const dayName = date.toLocaleDateString('en-AU', { weekday: 'short' });
            const day = date.getDate();
            const month = date.toLocaleDateString('en-AU', { month: 'short' });
            
            const participantName = shift.participant 
                ? `${shift.participant.first_name} ${shift.participant.last_name}`
                : 'Unassigned';
            
            const isSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover') || false;
            
            let timeRange = '';
            if (!isSleepover && shift.start_time && shift.end_time) {
                const startTime = formatTimeDisplay(shift.start_time);
                const endTime = formatTimeDisplay(shift.end_time);
                timeRange = `, ${startTime}-${endTime}`;
            } else if (isSleepover) {
                timeRange = ', Sleepover';
            }
            
            const dutyTypeLabel = shift.duty_type?.name || 'Standard';
            option.textContent = `${dayName} ${day} ${month} - ${participantName}${timeRange} (${dutyTypeLabel})`;
            
            option.dataset.startTime = shift.start_time || '';
            option.dataset.endTime = shift.end_time || '';
            option.dataset.isSleepover = isSleepover.toString();
            
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading shifts:', error);
        showToast('Failed to load shifts', 'error');
    }
}
// Helper function to format time for display (e.g., "11am", "10:30pm")
function formatTimeDisplay(timeString) {
    if (!timeString) return '';
    const [hours, minutes] = timeString.split(':');
    const hour = parseInt(hours);
    const min = parseInt(minutes);
    const period = hour >= 12 ? 'pm' : 'am';
    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
    const displayMin = min > 0 ? `:${min.toString().padStart(2, '0')}` : '';
    return `${displayHour}${displayMin}${period}`;
}


async function loadLeaveRequestModal() {
    try {
        const today = getTestDate();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Set default start date to tomorrow
        const startDateInput = document.getElementById('leaveStartDate');
        if (startDateInput) {
            startDateInput.value = tomorrow.toISOString().split('T')[0];
            startDateInput.min = tomorrow.toISOString().split('T')[0];
        }
        
        // Set default end date to same as start
        const endDateInput = document.getElementById('leaveEndDate');
        if (endDateInput) {
            endDateInput.value = tomorrow.toISOString().split('T')[0];
            endDateInput.min = tomorrow.toISOString().split('T')[0];
        }
        
    } catch (error) {
        console.error('Error loading leave modal:', error);
    }
}


async function submitLeave() {
    // Prevent multiple simultaneous submissions
    if (isSubmittingLeave) {
        console.log('Leave submission already in progress, ignoring duplicate call');
        return;
    }
    
    isSubmittingLeave = true;
    
    try {
        const leaveType = document.getElementById('leaveType').value;
        const startDate = document.getElementById('leaveStartDate').value;
        const endDate = document.getElementById('leaveEndDate').value;
        const reason = document.getElementById('leaveReason').value;

        // ADD THIS DEBUGGING
        console.log('Leave form values:', {
            leaveType,
            startDate,
            endDate,
            reason,
            leaveTypeElement: document.getElementById('leaveType'),
            startDateElement: document.getElementById('leaveStartDate'),
            endDateElement: document.getElementById('leaveEndDate')
        });

        if (!leaveType || !startDate || !endDate) {
            // ADD MORE DEBUGGING
            console.log('Validation failed:', {
                leaveType: leaveType || 'EMPTY',
                startDate: startDate || 'EMPTY',
                endDate: endDate || 'EMPTY'
            });
            showToast('Please fill all required fields', 'error');
            isSubmittingLeave = false;
            return;
        }

        // Rest of your code stays the same...
        // Validate dates
        if (new Date(endDate) < new Date(startDate)) {
            showToast('End date must be after start date', 'error');
            isSubmittingLeave = false;
            return;
        }

        const { data, error } = await supabaseClient
            .from('leave_requests')
            .insert({
                staff_id: currentStaff.id,
                leave_type: leaveType,
                start_date: startDate,
                end_date: endDate,
                reason: reason,
                status: 'pending',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .select()
            .single();

        if (error) throw error;

        showToast('Leave request submitted for approval', 'success');
        closeModal('leaveModal');
        document.getElementById('leaveForm').reset();
        
    } catch (error) {
        console.error('Error submitting leave:', error);
        showToast('Failed to submit leave request: ' + error.message, 'error');
    } finally {
        // Always reset the flag
        isSubmittingLeave = false;
    }
}

function loadShiftTimes() {
    const select = document.getElementById('adjustmentShift');
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption || !selectedOption.value) return;
    
    const startTimeInput = document.getElementById('adjustmentStartTime');
    const endTimeInput = document.getElementById('adjustmentEndTime');
    const isSleepover = selectedOption.dataset.isSleepover === 'true';
    
    // Populate with original times (without seconds)
    if (selectedOption.dataset.startTime) {
        // Remove seconds from time
        startTimeInput.value = selectedOption.dataset.startTime.substring(0, 5);
    }
    if (selectedOption.dataset.endTime) {
        endTimeInput.value = selectedOption.dataset.endTime.substring(0, 5);
    }
    
    // Handle sleepover shifts
    if (isSleepover) {
        startTimeInput.disabled = true;
        endTimeInput.disabled = true;
        startTimeInput.removeAttribute('required');
        endTimeInput.removeAttribute('required');
        document.querySelector('label[for="adjustmentStartTime"]').textContent = 'Start Time (Not required for sleepover)';
        document.querySelector('label[for="adjustmentEndTime"]').textContent = 'End Time (Not required for sleepover)';
    } else {
        startTimeInput.disabled = false;
        endTimeInput.disabled = false;
        startTimeInput.setAttribute('required', 'required');
        endTimeInput.setAttribute('required', 'required');
        document.querySelector('label[for="adjustmentStartTime"]').textContent = 'New Start Time';
        document.querySelector('label[for="adjustmentEndTime"]').textContent = 'New End Time';
    }
    
    // Set 30-minute step intervals
    startTimeInput.step = '1800'; // 30 minutes in seconds
    endTimeInput.step = '1800';
    
    // Add validation listeners
    startTimeInput.removeEventListener('change', validateTimes);
    endTimeInput.removeEventListener('change', validateTimes);
    startTimeInput.addEventListener('change', validateTimes);
    endTimeInput.addEventListener('change', validateTimes);
}

function validateTimes() {
    const startTimeInput = document.getElementById('adjustmentStartTime');
    const endTimeInput = document.getElementById('adjustmentEndTime');
    
    if (!startTimeInput.value || !endTimeInput.value) return;
    
    const startTime = startTimeInput.value;
    const endTime = endTimeInput.value;
    
    // Compare times
    if (endTime <= startTime) {
        endTimeInput.setCustomValidity('End time must be after start time');
        showToast('End time must be after start time', 'error');
        endTimeInput.value = ''; // Clear invalid end time
    } else {
        endTimeInput.setCustomValidity('');
    }
}

async function submitAdjustment() {
    try {
        const select = document.getElementById('adjustmentShift');
        const selectedOption = select.options[select.selectedIndex];
        const shiftId = select.value;
        const reason = document.getElementById('adjustmentReason').value;
        const newStartTime = document.getElementById('adjustmentStartTime').value;
        const newEndTime = document.getElementById('adjustmentEndTime').value;
        const isSleepover = selectedOption.dataset.isSleepover === 'true';
        
        if (!shiftId || !reason) {
            showToast('Please fill in required fields', 'error');
            return;
        }
        
        // Validate times for non-sleepover shifts
        if (!isSleepover) {
            if (!newStartTime || !newEndTime) {
                showToast('Start and end times are required for non-sleepover shifts', 'error');
                return;
            }
            
            if (newEndTime <= newStartTime) {
                showToast('End time must be after start time', 'error');
                return;
            }
        }
        
        // Get original times from the selected option
        const originalStartTime = selectedOption.dataset.startTime || null;
        const originalEndTime = selectedOption.dataset.endTime || null;
        
        // Add seconds to times for database storage
        const formattedStartTime = newStartTime ? `${newStartTime}:00` : null;
        const formattedEndTime = newEndTime ? `${newEndTime}:00` : null;
        
        // Update the shift record directly
        const { data, error } = await supabaseClient
            .from('shifts')
            .update({
                original_start_time: originalStartTime,
                original_end_time: originalEndTime,
                adjusted_start_time: formattedStartTime,
                adjusted_end_time: formattedEndTime,
                adjustment_reason: reason,
                adjustment_status: 'pending'
            })
            .eq('id', parseInt(shiftId));
        
        if (error) {
            console.error('Adjustment request error:', error);
            showToast('Failed to submit adjustment request', 'error');
        } else {
            showToast('Adjustment request submitted', 'success');
            closeModal('adjustmentModal');
            document.getElementById('adjustmentForm').reset();
            
            // Refresh the schedule if it's visible
            if (document.getElementById('schedule').classList.contains('active')) {
                loadSchedule();
            }
        }
    } catch (error) {
        console.error('Error submitting adjustment:', error);
        showToast('Failed to submit adjustment request', 'error');
    }
}

async function loadDutyTypes() {
    try {
        const { data, error } = await supabaseClient
            .from('duty_types')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        if (error) {
            console.error('Error loading duty types:', error);
            return [];
        }
        
        dutyTypes = data || [];
        console.log('Loaded duty types:', dutyTypes.length);
        return dutyTypes;
        
    } catch (error) {
        console.error('Error in loadDutyTypes:', error);
        return [];
    }
}

async function loadLocations() {
    try {
        const { data, error } = await supabaseClient
            .from('locations')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        if (error) {
            console.error('Error loading locations:', error);
            return [];
        }
        
        locations = data || [];
        console.log('Loaded locations:', locations.length);
        return locations;
        
    } catch (error) {
        console.error('Error in loadLocations:', error);
        return [];
    }
}

async function submitNote() {
    const shiftId = document.getElementById('noteShiftId').value;
    const noteType = document.getElementById('noteType').value;
    const noteText = document.getElementById('noteText').value;
    
    if (!shiftId || !noteType || !noteText.trim()) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    try {
        // CRITICAL: Ensure shift_id is INTEGER
        const { data: noteData, error: noteError } = await supabaseClient
            .from('shift_notes')
            .insert({
                shift_id: parseInt(shiftId), // Convert to INTEGER
                staff_id: currentStaff.id,
                note_type: noteType,
                note: noteText,
                created_at: new Date().toISOString()
            })
            .select()
            .single();
        
        if (noteError) {
            console.error('Note creation error:', noteError);
            if (noteError.code === DB_ERRORS.FOREIGN_KEY_VIOLATION) {
                showToast('Invalid shift reference', 'error');
            } else {
                showToast('Failed to add note', 'error');
            }
        } else {
            showToast('Note added successfully', 'success');
            closeModal('addNoteModal');
            await loadShiftNotes(shiftId);
        }
    } catch (error) {
        console.error('Error submitting note:', error);
        showToast('Failed to add note', 'error');
    }
}


function previewImages() {
    const files = document.getElementById('noteImages').files;
    const container = document.getElementById('imagePreviewContainer');
    
    selectedImages = Array.from(files);
    container.innerHTML = '';
    
    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-preview';
            img.setAttribute('data-action-with-param', 'removeImage');
img.setAttribute('data-param', index);            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedImages.splice(index, 1);
    previewImages();
}

async function uploadDocument() {
    const fileInput = document.getElementById('documentFile');
    const file = fileInput.files[0];
    const documentTypeId = document.getElementById('documentType').value; // UUID from dropdown
    const title = document.getElementById('documentTitle').value;
    const expiryDate = document.getElementById('documentExpiry').value;
    const notes = document.getElementById('documentNotes').value;
    
    if (!file || !documentTypeId || !title) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    try {
        // Check file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            showToast('File size must be less than 10MB', 'error');
            return;
        }
        
        // Get file extension
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentStaff.id}/${Date.now()}_${title}.${fileExt}`;
        
        // Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('documents')
            .upload(fileName, file);
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from('documents')
            .getPublicUrl(fileName);
        
        // Save to database with correct column name
        const { error: dbError } = await supabaseClient
            .from('documents')
            .insert({
                entity_type: 'staff',
                entity_id: currentStaff.id,
                type_id: documentTypeId,
                title: title,
                file_url: urlData.publicUrl,
                expiry_date: expiryDate || null,
                notes: notes || null,
                created_at: new Date().toISOString()
            });
        
        if (dbError) throw dbError;
        
        showToast('Document uploaded successfully', 'success');
        closeModal('uploadDocumentModal');
        
        // Reload documents list
        await loadDocuments();
        
    } catch (error) {
        console.error('Error uploading document:', error);
        showToast('Failed to upload document', 'error');
    }
}
function loadProfilePicture() {
    const profileImg = document.getElementById('profileImage');
    if (profileImg) {
        // Since profile_picture doesn't exist in DB, use default avatar
        profileImg.src = '/assets/default-avatar.png';
        // OR generate avatar from initials
        if (currentStaff) {
            const initials = `${currentStaff.first_name?.[0] || ''}${currentStaff.last_name?.[0] || ''}`;
            profileImg.alt = initials;
            // Could use a service like ui-avatars.com
            profileImg.src = `https://ui-avatars.com/api/?name=${currentStaff.first_name}+${currentStaff.last_name}&background=random`;
        }
    }
}



function displayUserRole() {
    // Since there's no role field, use a default or derive from other data
    const userRole = document.getElementById('userRole');
    if (userRole) {
        userRole.textContent = 'Support Worker'; // Default role
        // OR you could check if they have manager permissions some other way
    }
}

async function populateShiftModalDropdowns() {
    // Populate participants
    const participantSelect = document.getElementById('shiftParticipant');
    if (participantSelect && participants.length > 0) {
        participantSelect.innerHTML = '<option value="">Select Participant</option>' +
            participants.map(p => `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`).join('');
    }
    
    // Populate duty types and set default to "Active Shift"
    const dutySelect = document.getElementById('shiftDutyType');
    if (dutySelect && dutyTypes.length > 0) {
        dutySelect.innerHTML = '<option value="">Select Duty Type</option>';
        
        let activeShiftId = null;
        
        dutyTypes.forEach(d => {
            const option = document.createElement('option');
            option.value = d.id;
            option.textContent = d.name;
            
            // Check if this is "Active Shift" and set as default
            if (d.name === 'Active Shift' || d.name.toLowerCase() === 'active shift') {
                option.selected = true;
                activeShiftId = d.id;
            }
            
            dutySelect.appendChild(option);
        });
        
        // Add change event listener
        dutySelect.onchange = onDutyTypeChange;
        
        // Trigger the change event to set up time fields correctly for default selection
        if (activeShiftId) {
            onDutyTypeChange();
        }
    }
}
// ==========================================
// COMPLETE PROFILE FUNCTIONS FOR TEAM.HTML
// ==========================================

// 1. Load Profile Data
async function loadProfile() {
    try {
        if (!currentStaff) {
            showToast('Staff data not loaded', 'error');
            return;
        }
        
        // Display Personal Information
        const personalInfo = document.getElementById('personalInfo');
        if (personalInfo) {
            personalInfo.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">First Name</div>
                    <div class="field-value">${currentStaff.first_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Middle Name</div>
                    <div class="field-value">${currentStaff.middle_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Last Name</div>
                    <div class="field-value">${currentStaff.last_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Email</div>
                    <div class="field-value">${currentStaff.email || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Phone</div>
                    <div class="field-value">${currentStaff.phone || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <div class="field-value">${currentStaff.date_of_birth ? formatDate(currentStaff.date_of_birth) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Gender</div>
                    <div class="field-value">${currentStaff.sex || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Staff Code</div>
                    <div class="field-value">${currentStaff.staff_code || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <div class="field-value">${currentStaff.ndis_worker_number || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Start Date</div>
                    <div class="field-value">${currentStaff.start_date ? formatDate(currentStaff.start_date) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Hour Limit</div>
                    <div class="field-value">${currentStaff.limits || '76'} hours/fortnight</div>
                </div>
            `;
        }
        
        // Display Contact Information
        const contactInfo = document.getElementById('contactInfo');
        if (contactInfo) {
            contactInfo.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Address</div>
                    <div class="field-value">${currentStaff.address || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact Name</div>
                    <div class="field-value">${currentStaff.emergency_contact_name || currentStaff.emergency_contact || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact Phone</div>
                    <div class="field-value">${currentStaff.emergency_contact_phone || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact Relationship</div>
                    <div class="field-value">${currentStaff.emergency_contact_relationship || '-'}</div>
                </div>
            `;
        }
        
        // Display Banking Information
        const bankingInfo = document.getElementById('bankingInfo');
        if (bankingInfo) {
            bankingInfo.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Bank Name</div>
                    <div class="field-value">${currentStaff.bank_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">BSB</div>
                    <div class="field-value">${currentStaff.bsb || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Account Number</div>
                    <div class="field-value">${currentStaff.account_number ? '****' + currentStaff.account_number.slice(-4) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Tax File Number</div>
                    <div class="field-value">${currentStaff.tax_file_number ? '***-***-' + currentStaff.tax_file_number.slice(-3) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Superannuation Fund</div>
                    <div class="field-value">${currentStaff.super_fund || '-'}</div>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading profile:', error);
        showToast('Failed to load profile', 'error');
    }
}

// 2. Edit Personal Information
function editPersonalInfo() {
    const container = document.getElementById('personalInfo');
    if (!container) return;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">First Name</div>
            <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Middle Name</div>
            <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Last Name</div>
            <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Email</div>
            <input type="email" class="form-control" id="editEmail" value="${currentStaff.email || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Phone</div>
            <input type="tel" class="form-control" id="editPhone" value="${currentStaff.phone || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Date of Birth</div>
            <input type="date" class="form-control" id="editBirthday" value="${currentStaff.date_of_birth || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Gender</div>
            <select class="form-control" id="editSex">
                <option value="">Select</option>
                <option value="Male" ${currentStaff.sex === 'Male' ? 'selected' : ''}>Male</option>
                <option value="Female" ${currentStaff.sex === 'Female' ? 'selected' : ''}>Female</option>
                <option value="Other" ${currentStaff.sex === 'Other' ? 'selected' : ''}>Other</option>
            </select>
        </div>
        <div class="profile-field">
            <div class="field-label">NDIS Worker Number</div>
            <input type="text" class="form-control" id="editNDISNumber" value="${currentStaff.ndis_worker_number || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" data-action="savePersonalInfo">Save Changes</button>
            <button class="btn btn-secondary" data-action="loadProfile">Cancel</button>
        </div>
    `;
}

// 3. Save Personal Information
async function savePersonalInfo() {
    try {
        const updateData = {
            first_name: document.getElementById('editFirstName')?.value || currentStaff.first_name,
            middle_name: document.getElementById('editMiddleName')?.value || null,
            last_name: document.getElementById('editLastName')?.value || currentStaff.last_name,
            email: document.getElementById('editEmail')?.value || currentStaff.email,
            phone: document.getElementById('editPhone')?.value || null,
            date_of_birth: document.getElementById('editBirthday')?.value || null,
            sex: document.getElementById('editSex')?.value || null,
            ndis_worker_number: document.getElementById('editNDISNumber')?.value || null,
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('staff')
            .update(updateData)
            .eq('id', currentStaff.id)
            .select()
            .single();
        
        if (error) throw error;
        
        // Update local state
        currentStaff = data;
        AppState.staff.current = data;
        
        // Update header name
        document.getElementById('userName').textContent = 
            `${data.first_name} ${data.last_name}`;
        
        loadProfile();
        showToast('Personal information updated successfully', 'success');
        
    } catch (error) {
        console.error('Error saving personal info:', error);
        showToast('Failed to save changes: ' + error.message, 'error');
    }
}

// 4. Edit Contact Information
function editContactInfo() {
    const container = document.getElementById('contactInfo');
    if (!container) return;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Address</div>
            <textarea class="form-control" id="editAddress" rows="3">${currentStaff.address || ''}</textarea>
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Name</div>
            <input type="text" class="form-control" id="editEmergencyName" 
                   value="${currentStaff.emergency_contact_name || currentStaff.emergency_contact || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Phone</div>
            <input type="tel" class="form-control" id="editEmergencyPhone" 
                   value="${currentStaff.emergency_contact_phone || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Relationship</div>
            <input type="text" class="form-control" id="editEmergencyRelationship" 
                   value="${currentStaff.emergency_contact_relationship || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" data-action="saveContactInfo">Save Changes</button>
            <button class="btn btn-secondary" data-action="loadProfile">Cancel</button>
        </div>
    `;
}

// 5. Save Contact Information
async function saveContactInfo() {
    try {
        const updateData = {
            address: document.getElementById('editAddress')?.value || null,
            emergency_contact_name: document.getElementById('editEmergencyName')?.value || null,
            emergency_contact_phone: document.getElementById('editEmergencyPhone')?.value || null,
            emergency_contact_relationship: document.getElementById('editEmergencyRelationship')?.value || null,
            emergency_contact: document.getElementById('editEmergencyName')?.value || null, // Backup field
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('staff')
            .update(updateData)
            .eq('id', currentStaff.id)
            .select()
            .single();
        
        if (error) throw error;
        
        currentStaff = data;
        AppState.staff.current = data;
        
        loadProfile();
        showToast('Contact information updated successfully', 'success');
        
    } catch (error) {
        console.error('Error saving contact info:', error);
        showToast('Failed to save changes: ' + error.message, 'error');
    }
}

// 6. Edit Banking Information
function editBankingInfo() {
    const container = document.getElementById('bankingInfo');
    if (!container) return;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Bank Name</div>
            <input type="text" class="form-control" id="editBankName" value="${currentStaff.bank_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">BSB</div>
            <input type="text" class="form-control" id="editBSB" value="${currentStaff.bsb || ''}" 
                   maxlength="7" placeholder="XXX-XXX">
        </div>
        <div class="profile-field">
            <div class="field-label">Account Number</div>
            <input type="text" class="form-control" id="editAccountNumber" value="${currentStaff.account_number || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Tax File Number</div>
            <input type="text" class="form-control" id="editTFN" value="${currentStaff.tax_file_number || ''}" 
                   maxlength="9" placeholder="XXX XXX XXX">
        </div>
        <div class="profile-field">
            <div class="field-label">Superannuation Fund</div>
            <input type="text" class="form-control" id="editSuper" value="${currentStaff.super_fund || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" data-action="saveBankingInfo">Save Changes</button>
            <button class="btn btn-secondary" data-action="loadProfile">Cancel</button>
        </div>
    `;
}

// 7. Save Banking Information
async function saveBankingInfo() {
    try {
        const updateData = {
            bank_name: document.getElementById('editBankName')?.value || null,
            bsb: document.getElementById('editBSB')?.value || null,
            account_number: document.getElementById('editAccountNumber')?.value || null,
            tax_file_number: document.getElementById('editTFN')?.value || null,
            super_fund: document.getElementById('editSuper')?.value || null,
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('staff')
            .update(updateData)
            .eq('id', currentStaff.id)
            .select()
            .single();
        
        if (error) throw error;
        
        currentStaff = data;
        AppState.staff.current = data;
        
        loadProfile();
        showToast('Banking information updated successfully', 'success');
        
    } catch (error) {
        console.error('Error saving banking info:', error);
        showToast('Failed to save changes: ' + error.message, 'error');
    }
}

async function saveAvailability() {
    try {
        const form = document.getElementById('availabilityForm');
        const selectedDates = form ? form.querySelectorAll('input[type="date"]') : [];
        
        if (selectedDates.length === 0) {
            // Fallback to checkbox method if using different UI
            return saveWeeklyAvailability();
        }
        
        const records = [];
        selectedDates.forEach(input => {
            if (input.value) {
                const isAvailable = input.dataset.available === 'true';
                const startTime = document.getElementById(`start_${input.id}`)?.value;
                const endTime = document.getElementById(`end_${input.id}`)?.value;
                
                records.push({
                    staff_id: currentStaff.id,
                    date: input.value,
                    is_available: isAvailable, // Correct column name
                    start_time: startTime || null,
                    end_time: endTime || null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                });
            }
        });
        
        if (records.length === 0) {
            showToast('Please select at least one date', 'warning');
            return;
        }
        
        // Use upsert to handle unique constraint
        const { error } = await supabaseClient
            .from('staff_availability')
            .upsert(records, {
                onConflict: 'staff_id,date',
                ignoreDuplicates: false
            });
        
        if (error) throw error;
        
        showToast('Availability saved successfully', 'success');
        
    } catch (error) {
        console.error('Error saving availability:', error);
        showToast('Failed to save availability: ' + error.message, 'error');
    }
}

async function populateDocumentTypes() {
    const select = document.getElementById('documentType');
    if (!select) return;
    
    try {
        // Load document types from the document_types table
        const { data: types, error } = await supabaseClient
            .from('document_types')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        if (error) {
            console.error('Error loading document types:', error);
            select.innerHTML = '<option value="">Failed to load types</option>';
            return;
        }
        
        // Clear existing options
        select.innerHTML = '<option value="">Select document type</option>';
        
        if (types && types.length > 0) {
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                option.dataset.requiresExpiry = type.requires_expiry;
                select.appendChild(option);
            });
            
            // Add event listener to show/hide expiry date field based on type
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const requiresExpiry = selectedOption.dataset.requiresExpiry === 'true';
                const expiryField = document.getElementById('documentExpiryField');
                
                if (expiryField) {
                    expiryField.style.display = requiresExpiry ? 'block' : 'none';
                    if (!requiresExpiry) {
                        // Clear expiry date if not required
                        const expiryInput = document.getElementById('documentExpiry');
                        if (expiryInput) expiryInput.value = '';
                    }
                }
            });
        } else {
            select.innerHTML += '<option value="">No document types available</option>';
        }
        
    } catch (error) {
        console.error('Error populating document types:', error);
        select.innerHTML = '<option value="">Error loading types</option>';
    }
}

function checkExpiryRequired() {
    const documentType = document.getElementById('documentType');
    const selectedOption = documentType.options[documentType.selectedIndex];
    const expiryGroup = document.getElementById('expiryGroup');
    const expiryInput = document.getElementById('documentExpiry');
    
    if (selectedOption && selectedOption.dataset.requiresExpiry === 'true') {
        expiryGroup.style.display = 'block';
        expiryInput.required = true;
    } else {
        expiryGroup.style.display = 'none';
        expiryInput.required = false;
    }
}


// Availability functions
function toggleDayAvailability(day, available) {
    // Update all time slots for the day
    for (let slot = 0; slot < 4; slot++) {
        weeklyAvailability[`${day}_${slot}`] = available;
    }
    renderAvailability();
}

function toggleTimeSlot(day, slot, element) {
    const key = `${day}_${slot}`;
    weeklyAvailability[key] = !weeklyAvailability[key];
    element.classList.toggle('selected');
}



let cropper = null;
let selectedFile = null;

// When user selects a file, open the editor instead of uploading directly
document.getElementById('bannerUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Check file type
    if (!file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
    }
    
    // Check file size
    if (file.size > 10 * 1024 * 1024) {
        showToast('File size must be less than 10MB', 'error');
        return;
    }
    
    selectedFile = file;
    openPhotoEditor(file);
});

function openPhotoEditor(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const modal = document.getElementById('photoEditorModal');
        const image = document.getElementById('imageToCrop');
        
        image.src = e.target.result;
        modal.classList.add('active');
        
        // Initialize Cropper.js
        if (cropper) {
            cropper.destroy();
        }
        
        cropper = new Cropper(image, {
            aspectRatio: 3, // 3:1 ratio for banner
            viewMode: 1,
            guides: true,
            center: true,
            highlight: true,
            background: true,
            autoCrop: true,
            movable: true,
            rotatable: true,
            scalable: true,
            zoomable: true,
            cropBoxMovable: true,
            cropBoxResizable: true,
        });
    };
    reader.readAsDataURL(file);
}

function closePhotoEditor() {
    const modal = document.getElementById('photoEditorModal');
    modal.classList.remove('active');
    
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    // Reset file input
    document.getElementById('bannerUpload').value = '';
}

function rotateCropper(degrees) {
    if (cropper) {
        cropper.rotate(degrees);
    }
}

function resetCropper() {
    if (cropper) {
        cropper.reset();
    }
}

async function saveCroppedImage() {
    if (!cropper) return;
    
    try {
        showToast('Processing image...', 'info');
        
        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
            width: 1200,  // Output width
            height: 400,  // Output height
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });
        
        // Convert to blob
        canvas.toBlob(async (blob) => {
            // Convert blob to base64
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Data = reader.result;
                
                try {
                    // Delete existing banner
                    await supabaseClient
                        .from('attachments')
                        .delete()
                        .eq('entity_type', 'staff')
                        .eq('entity_id', currentStaff.id)
                        .eq('file_type', 'profile_banner');
                    
                    // Save new banner
                    const { data, error } = await supabaseClient
                        .from('attachments')
                        .insert({
                            entity_type: 'staff',
                            entity_id: currentStaff.id,
                            file_type: 'profile_banner',
                            file_name: selectedFile.name,
                            file: base64Data,
                            file_url: 'stored-in-db',
                            file_size: blob.size,
                            mime_type: 'image/jpeg',
                            uploaded_by: currentUser.id
                        })
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update UI immediately
                    const bannerElement = document.getElementById('profileBanner');
                    if (bannerElement) {
                        bannerElement.style.backgroundImage = `url(${base64Data})`;
                        bannerElement.classList.add('has-image');  // ADD THIS LINE
                    }
                    
                    closePhotoEditor();
                    showToast('Banner updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error saving banner:', error);
                    showToast('Failed to save banner', 'error');
                }
            };
            reader.readAsDataURL(blob);
            
        }, 'image/jpeg', 0.9);
        
    } catch (error) {
        console.error('Error processing image:', error);
        showToast('Failed to process image', 'error');
    }
}


async function uploadProfileBanner() {
    const fileInput = document.getElementById('bannerUpload');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select a file', 'error');
        return;
    }
    
    try {
        // Check file size (5MB limit for banners)
        if (file.size > 5 * 1024 * 1024) {
            showToast('File size must be less than 5MB', 'error');
            return;
        }
        
        // Check if image type
        if (!file.type.startsWith('image/')) {
            showToast('Please select an image file', 'error');
            return;
        }
        
        // Compress/resize image before upload
        const compressedFile = await compressImage(file, 1200, 0.8); // Max width 1200px, 80% quality
        
        // Convert to base64 for storing in attachments table
        const reader = new FileReader();
        reader.onloadend = async () => {
            try {
                const base64Data = reader.result;
                
                // Delete existing banner if exists
                await supabaseClient
                    .from('attachments')
                    .delete()
                    .eq('entity_type', 'staff')
                    .eq('entity_id', currentStaff.id)
                    .eq('file_type', 'profile_banner');
                
                // Insert new banner to attachments table
                const { data, error } = await supabaseClient
    .from('attachments')
    .insert({
        entity_type: 'staff',
        entity_id: currentStaff.id,
        file_type: 'profile_banner',
        file_name: file.name,
        file: base64Data,  // CHANGED from file_data to file
        file_size: compressedFile.size,
        mime_type: compressedFile.type,
        uploaded_by: currentUser.id
    })
    .select()
    .single();

                if (error) throw error;
                
                // Update UI immediately
                const bannerElement = document.getElementById('profileBanner');
                if (bannerElement) {
                    bannerElement.style.backgroundImage = `url(${base64Data})`;
                }
                
                showToast('Banner uploaded successfully', 'success');
                
            } catch (error) {
                console.error('Error saving banner:', error);
                showToast('Failed to upload banner', 'error');
            }
        };
        
        reader.readAsDataURL(compressedFile);
        
    } catch (error) {
        console.error('Error uploading banner:', error);
        showToast('Failed to upload banner', 'error');
    }
}

async function loadProfileBanner() {
    if (!currentStaff) return;
    
    const bannerElement = document.getElementById('profileBanner');
    
    try {
        const { data } = await supabaseClient
            .from('attachments')
            .select('file')
            .eq('entity_type', 'staff')
            .eq('entity_id', currentStaff.id)
            .eq('file_type', 'profile_banner')
            .single();
        
        if (data && data.file && bannerElement) {
            bannerElement.style.backgroundImage = `url(${data.file})`;
            bannerElement.classList.add('has-image');  // ADD THIS
        }
    } catch (error) {
        // No banner - remove the class
        if (bannerElement) {
            bannerElement.classList.remove('has-image');
        }
    }
}

// Helper function to compress/resize image
async function compressImage(file, maxWidth, quality) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Calculate new dimensions
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(
                    (blob) => {
                        resolve(new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        }));
                    },
                    'image/jpeg',
                    quality
                );
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

async function loadHandoverNotes(participantId, shiftDate) {
    if (!participantId || !shiftDate) return [];
    
    try {
        // Get recent shifts for this participant
        const startDate = new Date(shiftDate);
        startDate.setDate(startDate.getDate() - 7); // Look back 7 days
        
        const { data: recentShifts, error: shiftsError } = await supabaseClient
            .from('shifts')
            .select('id')
            .eq('participant_id', participantId)
            .gte('date', startDate.toISOString().split('T')[0])
            .lte('date', shiftDate)
            .is('deleted_at', null);
        
        if (shiftsError || !recentShifts || recentShifts.length === 0) {
            return [];
        }
        
        // Get shift IDs as integers
        const shiftIds = recentShifts.map(shift => shift.id);
        
        // Fetch notes for these shifts - no UUID conversion needed!
        const { data: notes, error: notesError } = await supabaseClient
            .from('shift_notes')
            .select(`
                *,
                staff:staff_id(first_name, last_name)
            `)
            .in('shift_id', shiftIds)  // Direct integer array
            .is('deleted_at', null)
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (notesError) {
            console.error('Error loading handover notes:', notesError);
            return [];
        }
        
        return notes || [];
        
    } catch (error) {
        console.error('Error in loadHandoverNotes:', error);
        return [];
    }
}


async function addNoteToShift(shiftId) {
    try {
        // Open the modal
        const modal = document.getElementById('addNoteModal');
        if (!modal) {
            console.error('Add note modal not found');
            showToast('Note modal not available', 'error');
            return;
        }
        
        // Store the shift ID for later use
        window.currentNoteShiftId = shiftId;
        
        // Set the shift ID in a hidden field if it exists
        const shiftIdField = document.getElementById('noteShiftId');
        if (shiftIdField) {
            shiftIdField.value = shiftId;
        }
        
        // Open the modal
        openModal('addNoteModal');
        
        // Pre-select the shift if there's a dropdown
        const shiftSelect = document.getElementById('noteShift');
        if (shiftSelect) {
            setTimeout(() => {
                shiftSelect.value = shiftId;
            }, 100);
        }
        
    } catch (error) {
        console.error('Error in addNoteToShift:', error);
        showToast('Failed to open note form', 'error');
    }
}

async function loadSchedule() {
    try {
        const scheduleSection = document.getElementById('schedule');
        if (!scheduleSection) return;
        
        // Ensure we have current staff data
        if (!AppState.staff.current) {
            console.error('No current staff for schedule');
            return;
        }

        // Calculate current week (Monday to Sunday)
        const today = getTestDate();
        const currentDay = today.getDay();
        const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1); // Adjust when Sunday
        const weekStart = new Date(today.setDate(diff));
        weekStart.setHours(0, 0, 0, 0);
        
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);
        
        // Format dates for query
        const startDate = weekStart.toISOString().split('T')[0];
        const endDate = weekEnd.toISOString().split('T')[0];
        
        console.log('Loading schedule for week:', startDate, 'to', endDate);
        
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(id, first_name, last_name),
                locations(name, address),
                duty_types(name)
            `)  // REMOVED ndis_number
            .eq('staff_id', AppState.staff.current.id)
            .gte('date', startDate)
            .lte('date', endDate)
            .is('deleted_at', null)
            .order('date', { ascending: true })
            .order('start_time', { ascending: true });

        if (error) {
            console.error('Error loading schedule:', error);
            showToast('Failed to load schedule', 'error');
            return;
        }
        // Store shifts globally
        allShifts = shifts || [];
        myShifts = shifts || [];
        
        console.log('Schedule loaded:', allShifts.length, 'shifts');
        
        // Render the weekly schedule
        renderWeeklySchedule(weekStart, weekEnd, shifts || []);
        
    } catch (error) {
        console.error('Error in loadSchedule:', error);
        showToast('Failed to load schedule', 'error');
    }
}

function renderWeeklySchedule(weekStart, weekEnd, shifts) {
    const container = document.getElementById('scheduleGrid');
    if (!container) return;
    
    // Create week navigation header
    let html = `
        <div class="schedule-header">
            <button class="btn btn-sm" data-action-with-param="changeWeek" data-param="-1">â† Previous Week</button>
            <div class="week-display">
                <h3>${formatDateShort(weekStart.toISOString().split('T')[0])} - ${formatDateShort(weekEnd.toISOString().split('T')[0])}</h3>
            </div>
            <button class="btn btn-sm" data-action-with-param="changeWeek" data-param="1">Next Week â†’</button>
        </div>
    `;
    
    // Group shifts by date
    const shiftsByDate = {};
    const daysOfWeek = [];
    
    // Generate all days of the week
    for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        daysOfWeek.push(dateStr);
        shiftsByDate[dateStr] = [];
    }
    
    // Populate shifts into their dates
    shifts.forEach(shift => {
        if (shiftsByDate[shift.date]) {
            shiftsByDate[shift.date].push(shift);
        }
    });
    
    // Render each day
    html += '<div class="weekly-schedule">';
    
    daysOfWeek.forEach(dateStr => {
        const date = new Date(dateStr + 'T12:00:00');
        const isToday = dateStr === getTestDate().toISOString().split('T')[0];
        const dayShifts = shiftsByDate[dateStr];
        
        html += `
            <div class="day-section ${isToday ? 'today' : ''}">
                <div class="day-header">
                    <div class="day-name">${date.toLocaleDateString('en-AU', { weekday: 'long' })}</div>
                    <div class="day-date">${date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })}</div>
                    ${dayShifts.length > 0 ? `<span class="shift-count">${dayShifts.length} shift${dayShifts.length > 1 ? 's' : ''}</span>` : ''}
                </div>
                <div class="day-shifts">
        `;
        
        if (dayShifts.length === 0) {
            html += '<div class="no-shifts">No shifts scheduled</div>';
        } else {
            dayShifts.forEach(shift => {
                const participant = shift.participants;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                html += `
                    <div class="shift-item" data-action="showParticipantShifts" data-participant-id="${shift.participant_id}" data-participant-name="${participantName}" style="cursor: pointer;">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                        <div class="shift-participant">
                            <strong>${participantName}</strong>
                            ${participant?.ndis_number ? `<span class="ndis-number">(${participant.ndis_participant_number})</span>` : ''}
                        </div>
                        <div class="shift-location">
                            ðŸ“ ${shift.locations?.name || 'Client Home'}
                        </div>
                        ${shift.duty_types ? `<div class="shift-duty-type">${shift.duty_types.name}</div>` : ''}
                    </div>
                `;
            });
        }
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    container.innerHTML = html;
}

// Function to change week
window.changeWeek = function(direction) {
    window.currentWeekOffset = (window.currentWeekOffset || 0) + direction;
    
    const today = getTestDate();
    const currentDay = today.getDay();
    const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
    const weekStart = new Date(today.setDate(diff + (window.currentWeekOffset * 7)));
    
    loadSchedule();
};

window.showParticipantShifts = async function(participantId, participantName) {
    try {
        if (!participantId) return;
        
        // Get ALL shifts for this participant (any staff)
        const { data: participantShifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                locations(name, address),
                duty_types(name)
            `)
            .eq('participant_id', participantId)
            .is('deleted_at', null)
            .order('date', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        
        // Get staff names separately to avoid the foreign key ambiguity
        const staffIds = [...new Set(participantShifts?.map(s => s.staff_id) || [])];
        const { data: staffData } = await supabaseClient
            .from('staff')
            .select('id, first_name, last_name')
            .in('id', staffIds);
        
        const staffMap = {};
        staffData?.forEach(s => {
            staffMap[s.id] = `${s.first_name} ${s.last_name}`;
        });
        
        // Create modal
        const modalHtml = `
            <div id="participantShiftsModal" class="modal active" style="display: flex;">
                <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Shift History: ${participantName}</h3>
                        <button class="modal-close" data-action="removeModal" data-modal-id="participantShiftsModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="padding: 20px;">
                            ${!participantShifts || participantShifts.length === 0 ? 
                                '<p>No shifts found for this participant</p>' :
                                participantShifts.map(shift => `
                                    <div class="shift-history-item" style="margin-bottom: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">
                                            ${formatDateLong(shift.date)}
                                        </div>
                                        <div style="color: #666;">
                                            <div>
                                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                                                ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                                            </div>
                                            <div>Staff: ${staffMap[shift.staff_id] || 'Unassigned'}</div>
                                            <div>ðŸ“ ${shift.locations?.name || 'Client Home'}</div>
                                            ${shift.duty_types ? `<div>Type: ${shift.duty_types.name}</div>` : ''}
                                            <div style="display: inline-block; margin-top: 5px; padding: 2px 8px; background: ${shift.status === 'confirmed' ? '#28a745' : '#ffc107'}; color: white; border-radius: 4px; font-size: 12px;">
                                                ${shift.status || 'confirmed'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal and add new one
        document.getElementById('participantShiftsModal')?.remove();
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Error showing participant shifts:', error);
        showToast('Failed to load participant history', 'error');
    }
};


// ==========================================
// SIMPLIFIED DATE/TIME CALCULATION SYSTEM
// ==========================================

// 1. Time Constants & Configuration
const TIME_CONFIG = {
    periods: {
        day: { start: 6, end: 20 },      // 6 AM - 8 PM
        evening: { start: 20, end: 24 },  // 8 PM - Midnight
        night: { start: 0, end: 6 }       // Midnight - 6 AM
    },
    days: {
        weekday: [1, 2, 3, 4, 5],  // Mon-Fri
        saturday: [6],
        sunday: [0]
    },
    sleepover: {
        hours: 2,  // Sleepovers count as 2 hours
        count: 1
    }
};

// 2. Main Shift Hours Calculator (Simplified)
function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };
    
    // Handle sleepover shifts
    if (isSleepoverShift(shift)) {
        result.sleepover = TIME_CONFIG.sleepover.count;
        result.total = TIME_CONFIG.sleepover.hours;
        return result;
    }
    
    // Validate shift has required times
    if (!shift.start_time || !shift.end_time) {
        return result;
    }
    
    // Parse shift times
    const { startTime, endTime } = parseShiftTimes(shift);
    if (!startTime || !endTime) return result;
    
    // Calculate total hours
    result.total = (endTime - startTime) / (1000 * 60 * 60);
    
    // Categorize hours by day type
    const shiftDate = new Date(shift.date + 'T12:00:00');
    const dayOfWeek = shiftDate.getDay();
    
    // Public holiday takes precedence
    if (shift.is_public_holiday === true) {
        result.publicHoliday = result.total;
        return result;
    }
    
    // Weekend shifts
    if (dayOfWeek === 0) {
        result.sunday = result.total;
        return result;
    }
    
    if (dayOfWeek === 6) {
        result.saturday = result.total;
        return result;
    }
    
    // Weekday shifts - break down by time period
    const breakdown = calculateWeekdayBreakdown(startTime, endTime);
    result.weekdayDay = breakdown.day;
    result.weekdayEvening = breakdown.evening;
    result.weekdayNight = breakdown.night;
    
    return result;
}

// 3. Helper Functions
function isSleepoverShift(shift) {
    const dutyType = shift.duty_types?.name || '';
    return dutyType.toLowerCase().includes('sleepover') || !shift.start_time;
}

function parseShiftTimes(shift) {
    const [startHour, startMin] = shift.start_time.split(':').map(Number);
    const [endHour, endMin] = shift.end_time.split(':').map(Number);
    
    const startTime = new Date(shift.date + 'T' + shift.start_time);
    let endTime = new Date(shift.date + 'T' + shift.end_time);
    
    // Handle overnight shifts
    if (endHour < startHour || (endHour === startHour && endMin < startMin)) {
        endTime.setDate(endTime.getDate() + 1);
    }
    
    return { startTime, endTime };
}

function calculateWeekdayBreakdown(startTime, endTime) {
    const breakdown = { day: 0, evening: 0, night: 0 };
    let current = new Date(startTime);
    
    while (current < endTime) {
        const hour = current.getHours();
        const nextHour = new Date(current);
        nextHour.setHours(hour + 1, 0, 0, 0);
        
        const periodEnd = nextHour > endTime ? endTime : nextHour;
        const periodHours = (periodEnd - current) / (1000 * 60 * 60);
        
        // Assign to correct period
        if (hour >= TIME_CONFIG.periods.day.start && hour < TIME_CONFIG.periods.day.end) {
            breakdown.day += periodHours;
        } else if (hour >= TIME_CONFIG.periods.evening.start) {
            breakdown.evening += periodHours;
        } else {
            breakdown.night += periodHours;
        }
        
        current = new Date(periodEnd);
    }
    
    return breakdown;
}

// 4. Unified Date/Time Formatter
const DateTimeFormatter = {
    // Locale configuration
    locale: 'en-AU',
    
    // Format configurations
    formats: {
        long: { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        },
        short: { 
            weekday: 'short',
            day: 'numeric', 
            month: 'short' 
        },
        friendly: { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short' 
        },
        date: {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        },
        datetime: {
            day: 'numeric',
            month: 'short',
            hour: 'numeric',
            minute: '2-digit'
        }
    },
    
    // Parse date consistently
    parseDate(dateString) {
        if (!dateString) return null;
        // Add noon time to avoid timezone issues
        if (!dateString.includes('T')) {
            dateString += 'T12:00:00';
        }
        return new Date(dateString);
    },
    
    // Format date with specified format
    format(dateString, formatType = 'short') {
        if (!dateString) return '';
        const date = this.parseDate(dateString);
        return date.toLocaleDateString(this.locale, this.formats[formatType]);
    },
    
    // Format time (12-hour with AM/PM)
    formatTime(timeString) {
        if (!timeString) return '';
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const period = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        return `${displayHour}:${minutes} ${period}`;
    },
    
    // Format datetime
    formatDateTime(dateString) {
        if (!dateString) return '';
        const date = this.parseDate(dateString);
        return date.toLocaleString(this.locale, this.formats.datetime);
    },
    
    // Get greeting based on time
    getGreeting(date = new Date()) {
        const hour = date.getHours();
        if (hour < 12) return 'Good morning';
        if (hour < 17) return 'Good afternoon';
        return 'Good evening';
    }
};

// 6. Week/Period Utilities
function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday start
    return new Date(d.setDate(diff));
}

function setGreeting() {
    const testDate = typeof getTestDate === 'function' ? getTestDate() : new Date();
    const greeting = DateTimeFormatter.getGreeting(testDate);
    
    const greetingEl = document.getElementById('greeting');
    if (greetingEl && currentStaff) {
        greetingEl.textContent = `${greeting}, ${currentStaff.first_name}!`;
    }
    
    const dateEl = document.getElementById('currentDate');
    if (dateEl) {
        dateEl.textContent = formatDateLong(testDate.toISOString().split('T')[0]);
    }
}


function changeMonth(direction) {
    if (!window.currentMonthOffset) {
        window.currentMonthOffset = 0;
    }
    window.currentMonthOffset += direction;
    loadSchedule();
}

        function populateParticipantFilter() {
            const select = document.getElementById('participantFilter');
            const uniqueParticipants = {};
            
            allShifts.forEach(shift => {
                if (shift.participant) {
                    uniqueParticipants[shift.participant_id] = shift.participant;
                }
            });

            select.innerHTML = '<option value="">All My Clients</option>';
            Object.values(uniqueParticipants).forEach(participant => {
                select.innerHTML += `
                    <option value="${participant.id}">
                        ${participant.first_name} ${participant.last_name}
                    </option>
                `;
            });
        }


        // ==========================================
// MODULAR UI RENDERING SYSTEM
// ==========================================

// 1. UI Component Factory
const UIComponents = {
    // Security: HTML escaping
    escape(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },
    
    // Generic element creator
    createElement(tag, options = {}) {
        const element = document.createElement(tag);
        
        if (options.class) element.className = options.class;
        if (options.id) element.id = options.id;
        if (options.text) element.textContent = options.text;
        if (options.html) element.innerHTML = options.html;
        if (options.style) element.style.cssText = options.style;
        if (options.data) {
            Object.entries(options.data).forEach(([key, value]) => {
                element.dataset[key] = value;
            });
        }
        if (options.attrs) {
            Object.entries(options.attrs).forEach(([key, value]) => {
                element.setAttribute(key, value);
            });
        }
        if (options.events) {
            Object.entries(options.events).forEach(([event, handler]) => {
                element.addEventListener(event, handler);
            });
        }
        if (options.children) {
            options.children.forEach(child => {
                if (typeof child === 'string') {
                    element.insertAdjacentHTML('beforeend', child);
                } else if (child) {
                    element.appendChild(child);
                }
            });
        }
        
        return element;
    },
    
    // Empty state component
    emptyState(message) {
        return this.createElement('div', {
            class: 'p-2 text-center',
            style: 'color: var(--text-light);',
            text: message
        });
    },
    
    // Shift list item component
    shiftListItem(shift, options = {}) {
        const participant = shift.participants;
        const hours = calculateShiftHours(shift);
        const dutyType = shift.duty_types?.name || 'Regular';
        
        return this.createElement('div', {
            class: 'shift-list-item',
            data: { shiftId: shift.id },
            children: [
                this.createElement('div', {
                    class: 'shift-info',
                    children: [
                        this.createElement('div', {
                            class: 'shift-date-time',
                            html: `
                                ${options.showDate ? formatDateShort(shift.date) + ' - ' : ''}
                                ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                ${shift.end_time ? formatTime(shift.end_time) : ''}
                                ${dutyType !== 'Regular' ? `<span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">${dutyType}</span>` : ''}
                            `
                        }),
                        participant && this.createElement('div', {
                            class: 'shift-client',
                            text: `${participant.first_name} ${participant.last_name}${shift.locations ? ` - ${shift.locations.name}` : ''}`
                        })
                    ].filter(Boolean)
                }),
                this.createElement('div', {
                    class: 'shift-hours',
                    children: [
                        this.createElement('div', {
                            class: 'shift-hours-value',
                            text: `${hours.total.toFixed(1)}h`
                        })
                    ]
                })
            ]
        });
    },
    
    // Group header component
    groupHeader(title, totalHours, style = {}) {
        return this.createElement('div', {
            style: `font-weight: 600; padding: 12px 16px; background: var(--bg-light); border-bottom: 1px solid var(--border-color); ${style.css || ''}`,
            children: [
                this.createElement('span', { text: title }),
                this.createElement('span', {
                    style: 'float: right; color: var(--primary-color);',
                    text: `${totalHours.toFixed(1)}h`
                })
            ]
        });
    },
    
    // Transfer item component
    transferItem(transfer, type = 'incoming') {
        const statusClass = `status-${transfer.status || 'pending'}`;
        const isIncoming = type === 'incoming';
        
        return this.createElement('div', {
            class: 'transfer-item',
            data: { transferId: transfer.id },
            children: [
                // Header
                this.createElement('div', {
                    class: 'transfer-header',
                    children: [
                        this.createElement('div', {
                            children: [
                                this.createElement('div', {
                                    class: 'transfer-date',
                                    text: formatDateLong(transfer.shift?.date)
                                }),
                                this.createElement('div', {
                                    class: 'transfer-time',
                                    html: `
                                        ${transfer.shift?.start_time ? formatTime(transfer.shift.start_time) : 'Sleepover'} - 
                                        ${transfer.shift?.end_time ? formatTime(transfer.shift.end_time) : ''}
                                    `
                                })
                            ]
                        }),
                        this.createElement('div', {
                            class: `transfer-badge ${statusClass}`,
                            text: transfer.status || 'Pending'
                        })
                    ]
                }),
                
                // From/To line
                this.createElement('div', {
                    class: 'transfer-from',
                    text: isIncoming ? 
                        `From: ${transfer.from_staff?.first_name} ${transfer.from_staff?.last_name}` :
                        `To: ${transfer.to_staff?.first_name || 'Pending'} ${transfer.to_staff?.last_name || ''}`
                }),
                
                // Reason (if exists)
                transfer.reason && this.createElement('div', {
                    class: 'transfer-reason',
                    text: `"${this.escape(transfer.reason)}"`
                }),
                
                // Actions (only for pending incoming)
                isIncoming && transfer.status === 'pending' && this.createElement('div', {
                    class: 'transfer-actions',
                    children: [
                        this.createElement('button', {
                            class: 'transfer-btn accept',
                            text: 'Accept',
                            events: { click: () => acceptTransfer(transfer.id) }
                        }),
                        this.createElement('button', {
                            class: 'transfer-btn decline',
                            text: 'Decline',
                            events: { click: () => declineTransfer(transfer.id) }
                        })
                    ]
                })
            ].filter(Boolean)
        });
    },
    
    // Note item component
    noteItem(note) {
        const staffName = note.staff ? 
            `${note.staff.first_name} ${note.staff.last_name}` : 
            'Unknown Staff';
        
        return this.createElement('div', {
            class: 'note-item',
            children: [
                this.createElement('div', {
                    class: 'note-header',
                    children: [
                        this.createElement('span', {
                            class: 'note-author',
                            text: staffName
                        }),
                        this.createElement('span', {
                            class: 'note-time',
                            text: formatDateTime(note.created_at)
                        })
                    ]
                }),
                this.createElement('div', {
                    class: 'note-content',
                    text: note.note
                }),
                this.createElement('div', {
                    class: 'note-type',
                    text: note.note_type
                })
            ]
        });
    },
    
    // Availability day component
    availabilityDay(day, index, availability) {
        const isAvailable = availability[`${index}_0`] || 
                          availability[`${index}_1`] || 
                          availability[`${index}_2`] || 
                          availability[`${index}_3`];
        
        return this.createElement('div', {
            class: 'availability-day',
            children: [
                this.createElement('div', {
                    class: 'availability-day-header',
                    children: [
                        this.createElement('span', {
                            class: 'day-name',
                            text: day
                        }),
                        this.createElement('label', {
                            class: 'availability-toggle',
                            children: [
                                this.createElement('input', {
                                    attrs: {
                                        type: 'checkbox',
                                        checked: isAvailable
                                    },
                                    events: {
                                        change: (e) => toggleDayAvailability(index, e.target.checked)
                                    }
                                }),
                                this.createElement('span', {
                                    class: 'toggle-slider'
                                })
                            ]
                        })
                    ]
                }),
                this.createElement('div', {
                    class: 'availability-times',
                    children: [
                        { slot: 0, label: 'Morning' },
                        { slot: 1, label: 'Afternoon' },
                        { slot: 2, label: 'Evening' },
                        { slot: 3, label: 'Night' }
                    ].map(({ slot, label }) => 
                        this.createElement('div', {
                            class: `time-slot ${availability[`${index}_${slot}`] ? 'selected' : ''}`,
                            text: label,
                            events: {
                                click: function() { toggleTimeSlot(index, slot, this); }
                            }
                        })
                    )
                })
            ]
        });
    }
};

// 2. Refactored Render Functions

function renderTimesheetShifts() {
    const container = document.getElementById('timesheetShifts');
    if (!container) {
        console.error('Timesheet shifts container not found');
        return;
    }
    
    const shifts = AppState.shifts.my || [];
    
    if (shifts.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-light);">
                No shifts in this pay period
            </div>
        `;
        return;
    }
    
    let html = '';
    
    if (AppState.ui.timesheetView === 'date') {
        // Group by date
        const grouped = {};
        shifts.forEach(shift => {
            if (!grouped[shift.date]) grouped[shift.date] = [];
            grouped[shift.date].push(shift);
        });
        
        // Sort dates and render
        Object.keys(grouped).sort().forEach(date => {
            const dayShifts = grouped[date];
            const dayHours = dayShifts.reduce((sum, s) => {
                const hours = calculateShiftHours(s);
                return sum + (hours.total || 0);
            }, 0);
            
            html += `
                <div class="shift-group">
                    <div class="shift-group-header">
                        <span>${formatDateLong(date)}</span>
                        <span class="shift-group-hours">${dayHours.toFixed(1)}h</span>
                    </div>
            `;
            
            dayShifts.forEach(shift => {
                const hours = calculateShiftHours(shift);
                const participant = shift.participants;
                
                html += `
                    <div class="shift-list-item">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                                ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                            </div>
                            <div class="shift-client">
                                ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                            </div>
                            <div class="shift-location">
                                ðŸ“ ${shift.locations?.name || 'Client Home'}
                            </div>
                        </div>
                        <div class="shift-hours">
                            <div class="shift-hours-value">${hours.total.toFixed(1)}h</div>
                            ${hours.sleepover > 0 ? '<div class="shift-pay">Sleepover</div>' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        });
        
    } else {
        // Group by participant
        const grouped = {};
        shifts.forEach(shift => {
            const key = shift.participant_id || 'unassigned';
            if (!grouped[key]) {
                grouped[key] = {
                    participant: shift.participants,
                    shifts: []
                };
            }
            grouped[key].shifts.push(shift);
        });
        
        Object.values(grouped).forEach(group => {
            const totalHours = group.shifts.reduce((sum, s) => {
                const hours = calculateShiftHours(s);
                return sum + (hours.total || 0);
            }, 0);
            
            const name = group.participant ? 
                `${group.participant.first_name} ${group.participant.last_name}` : 
                'Unassigned';
            
            html += `
                <div class="shift-group">
                    <div class="shift-group-header">
                        <span>${name}</span>
                        <span class="shift-group-hours">${totalHours.toFixed(1)}h</span>
                    </div>
            `;
            
            group.shifts.sort((a, b) => a.date.localeCompare(b.date)).forEach(shift => {
                const hours = calculateShiftHours(shift);
                
                html += `
                    <div class="shift-list-item">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${formatDateShort(shift.date)} - 
                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                                ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                            </div>
                            <div class="shift-location">
                                ðŸ“ ${shift.locations?.name || 'Client Home'}
                            </div>
                        </div>
                        <div class="shift-hours">
                            <div class="shift-hours-value">${hours.total.toFixed(1)}h</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        });
    }
    
    container.innerHTML = html;
}



function renderIncomingTransfers(transfers) {
    const container = document.getElementById('incomingList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transfers.length === 0) {
        container.appendChild(
            UIComponents.emptyState('No incoming transfer requests')
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    transfers.forEach(transfer => {
        fragment.appendChild(
            UIComponents.transferItem(transfer, 'incoming')
        );
    });
    
    container.appendChild(fragment);
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
    });
}

function formatDateFriendly(dateStr) {
    if (!dateStr) return 'Unknown';
    const date = new Date(dateStr);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-AU', options);
}

function formatTime12Hour(timeStr) {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    const date = new Date(dateTimeStr);
    return date.toLocaleDateString('en-AU', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-AU', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function formatDateShort(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-AU', { 
        month: 'short', 
        day: 'numeric' 
    });
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleString('en-AU', { 
        year: 'numeric',
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatTime(timeStr) {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    return `${hours}:${minutes}`;
}


function formatDateShort(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {
        day: 'numeric',
        month: 'short'
    });
}

function formatDateLong(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
}


function renderShiftRow(shift) {
    const participant = shift.participants;
    const location = shift.locations;
    const dutyType = shift.duty_types;
    const hours = calculateShiftHours(shift);
    
    return `
        <div class="shift-row">
            <div class="shift-info">
                <div class="shift-time">
                    ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                    ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                </div>
                <div class="shift-client">
                    ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                </div>
                <div class="shift-location">
                    ðŸ“ ${location?.name || 'Client Home'}
                </div>
            </div>
            <div class="shift-hours">
                ${hours.total.toFixed(1)}h
            </div>
        </div>
    `;
}

function renderOutgoingTransfers(transfers) {
    const container = document.getElementById('outgoingList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transfers.length === 0) {
        container.appendChild(
            UIComponents.emptyState('No outgoing transfer requests')
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    transfers.forEach(transfer => {
        fragment.appendChild(
            UIComponents.transferItem(transfer, 'outgoing')
        );
    });
    
    container.appendChild(fragment);
}

function renderNotes(container, notes) {
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!notes || notes.length === 0) {
        container.appendChild(
            UIComponents.createElement('div', {
                style: 'color: var(--text-light);',
                text: 'No handover notes yet'
            })
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    notes.forEach(note => {
        fragment.appendChild(UIComponents.noteItem(note));
    });
    
    container.appendChild(fragment);
}

function renderAvailability() {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const container = document.getElementById('availabilityGrid');
    if (!container) return;
    
    container.innerHTML = '';
    
    const fragment = document.createDocumentFragment();
    days.forEach((day, index) => {
        fragment.appendChild(
            UIComponents.availabilityDay(day, index, weeklyAvailability)
        );
    });
    
    container.appendChild(fragment);
}

// 3. Keep complex calendar renders as template functions for now
// (These are complex enough that DOM manipulation might be overkill)

const CalendarTemplates = {
    renderSchedule(container, filterValue, allShifts) {
        if (!container) return;
        
        let filteredShifts = filterValue ? 
            allShifts.filter(s => s.participant_id === filterValue) : 
            allShifts;
        
        // Group by date
        const grouped = {};
        filteredShifts.forEach(shift => {
            if (!grouped[shift.date]) grouped[shift.date] = [];
            grouped[shift.date].push(shift);
        });
        
        container.innerHTML = '';
        
        if (Object.keys(grouped).length === 0) {
            container.appendChild(UIComponents.emptyState('No shifts found'));
            return;
        }
        
        const fragment = document.createDocumentFragment();
        
        Object.keys(grouped).sort().forEach(date => {
            const dayShifts = grouped[date];
            const isToday = date === getTestDate().toISOString().split('T')[0];
            
            const daySection = UIComponents.createElement('div', {
                class: 'day-section',
                children: [
                    UIComponents.createElement('div', {
                        class: 'day-header',
                        style: isToday ? 'background: var(--primary-color); color: white;' : '',
                        children: [
                            UIComponents.createElement('div', {
                                class: 'day-date',
                                text: formatDateLong(date)
                            }),
                            UIComponents.createElement('div', {
                                class: 'day-shift-count',
                                text: dayShifts.length.toString()
                            })
                        ]
                    }),
                    UIComponents.createElement('div', {
                        class: 'day-shifts',
                        children: dayShifts.map(shift => {
                            const isMyShift = shift.staff_id === currentStaff.id;
                            const staffName = shift.staff ? 
                                `${shift.staff.first_name} ${shift.staff.last_name}` : 
                                'Unassigned';
                            
                            return UIComponents.createElement('div', {
                                class: 'schedule-shift',
                                style: isMyShift ? 
                                    'background: #e3f2fd; border-left: 3px solid var(--primary-color);' : '',
                                children: [
                                    UIComponents.createElement('div', {
                                        children: [
                                            UIComponents.createElement('div', {
                                                class: 'schedule-shift-time',
                                                html: `
                                                    ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                                    ${shift.end_time ? formatTime(shift.end_time) : ''}
                                                `
                                            }),
                                            UIComponents.createElement('div', {
                                                class: 'schedule-shift-staff',
                                                text: staffName
                                            })
                                        ]
                                    }),
                                    isMyShift && UIComponents.createElement('div', {
                                        class: 'schedule-shift-actions',
                                        children: [
                                            UIComponents.createElement('button', {
                                                class: 'action-btn secondary',
                                                text: 'Note',
                                                events: {
                                                    click: () => addNoteToShift(shift.id)
                                                }
                                            })
                                        ]
                                    })
                                ].filter(Boolean)
                            });
                        })
                    })
                ]
            });
            
            fragment.appendChild(daySection);
        });
        
        container.appendChild(fragment);
    }
};


function renderFortnightSchedule(startDate, endDate, shifts) {
    const container = document.getElementById('scheduleCalendar');
    if (!container) return;

    // Create navigation similar to timesheet
    let html = `
        <div class="schedule-wrapper">
            <div class="schedule-header">
                <button data-action-with-param="changeSchedulePeriod" data-param="-1" class="btn-nav">â€¹ Previous</button>
                <h3 class="schedule-period">
                    ${startDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })} - 
                    ${endDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}
                </h3>
                <button data-action-with-param="changeSchedulePeriod" data-param="1" class="btn-nav">Next â€º</button>
            </div>
            <div class="fortnight-grid">
    `;

    // Generate 14 days
    for (let i = 0; i < 14; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        const dateStr = currentDate.toISOString().split('T')[0];
        const dayShifts = shifts.filter(s => s.date === dateStr);
        const isToday = getTestDate().toDateString() === currentDate.toDateString();
        const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
        
        html += `
            <div class="schedule-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''} ${dayShifts.length > 0 ? 'has-shifts' : ''}">
                <div class="day-header">
                    <div class="day-name">${currentDate.toLocaleDateString('en-AU', { weekday: 'short' })}</div>
                    <div class="day-date">${currentDate.getDate()}</div>
                </div>
                <div class="day-shifts">
        `;
        
        if (dayShifts.length > 0) {
            dayShifts.forEach(shift => {
                html += `
                    <div class="shift-block">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'}
                            ${shift.end_time ? ' - ' + formatTime(shift.end_time) : ''}
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<div class="no-shift">No shifts</div>';
        }
        
        html += `
                </div>
            </div>
        `;
    }
    
    html += `
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function renderCalendar(targetDate, shifts) {
    const container = document.getElementById('scheduleCalendar');
    if (!container) return;

    const year = targetDate.getFullYear();
    const month = targetDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    let html = `
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <button data-action-with-param="changeMonth" data-param="-1" class="calendar-nav-btn">â€¹</button>
                <h3 class="calendar-month">${monthNames[month]} ${year}</h3>
                <button data-action-with-param="changeMonth" data-param="1" class="calendar-nav-btn">â€º</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-weekdays">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
                    <div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-days">
    `;
    
    // Empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day empty"></div>';
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayShifts = shifts.filter(s => s.date === dateStr);
        const isToday = getTestDate().toDateString() === new Date(year, month, day).toDateString();
        
        html += `
            <div class="calendar-day ${isToday ? 'today' : ''} ${dayShifts.length > 0 ? 'has-shifts' : ''}">
                <div class="day-number">${day}</div>
                ${dayShifts.length > 0 ? `
                    <div class="shift-dots">
                        ${dayShifts.map(() => '<span class="shift-dot"></span>').join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Update the original renderSchedule function
function renderSchedule() {
    const container = document.getElementById('scheduleGrid');
    const filterValue = document.getElementById('participantFilter')?.value;
    
    CalendarTemplates.renderSchedule(container, filterValue, allShifts);
}

        
        // Add all the edit profile functions
        function editPersonalInfo() {
            const container = document.getElementById('personalInfo');
            container.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">First Name</div>
                    <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Middle Name</div>
                    <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Last Name</div>
                    <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <input type="date" class="form-control" id="editDOB" value="${currentStaff.date_of_birth || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <input type="text" class="form-control" id="editNDIS" value="${currentStaff.ndis_worker_number || ''}">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" data-action="savePersonalInfo">Save</button>
                    <button class="btn btn-secondary" data-action="loadProfile">Cancel</button>
                </div>
            `;
        }

        async function savePersonalInfo() {
            try {
                const updates = {
                    first_name: document.getElementById('editFirstName').value,
                    middle_name: document.getElementById('editMiddleName').value || null,
                    last_name: document.getElementById('editLastName').value,
                    date_of_birth: document.getElementById('editDOB').value || null,
                    ndis_worker_number: document.getElementById('editNDIS').value || null
                };

                const { error } = await supabaseClient
                    .from('staff')
                    .update(updates)
                    .eq('id', currentStaff.id);

                if (error) throw error;

                currentStaff = { ...currentStaff, ...updates };
                showToast('Personal information updated', 'success');
                loadProfile();
                document.getElementById('userName').textContent = `${currentStaff.first_name} ${currentStaff.last_name}`;

            } catch (error) {
                console.error('Error updating personal info:', error);
                showToast('Failed to update personal information', 'error');
            }
        }


function showSection(sectionName) {
    try {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show target section
        const targetSection = document.getElementById(sectionName);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Update navigation
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
        });
        
        // Find and activate corresponding nav item
        const navItem = document.querySelector(`[data-section="${sectionName}"]`);
        if (navItem) {
            navItem.classList.add('active');
        }
        
    } catch (error) {
        console.error('Error showing section:', error);
    }
}

// ============================================
// TIMESHEET FIXES - Complete Implementation
// ============================================

// Global variables needed for timesheet
AppState.shifts.my = [];
window.currentPeriodStart = null;
window.currentPeriodEnd = null;
AppState.ui.timesheetView = 'date'; // 'date' or 'participant'
window.currentPeriodOffset = 0;


// ==================================================
// PAY PERIOD MANAGEMENT - SINGLE CLEAN IMPLEMENTATION
// ==================================================

// Configuration constants
const PAY_PERIOD_CONFIG = {
    BASE_DATE: new Date('2024-01-07'), // Sunday - adjust to your org's actual base date
    LENGTH_DAYS: 14, // Fortnightly pay periods
    LOCALE: 'en-AU'
};

// Single source of truth for period offset
if (!window.hasOwnProperty('periodOffset')) {
    window.periodOffset = 0;
}

/**
 * Calculate pay period for any given date
 * @param {Date} date - The date to calculate period for
 * @param {number} offset - Number of periods to offset (negative = past, positive = future)
 * @returns {Object} Period start and end dates
 */
function calculatePayPeriod(date = new Date(), offset = 0) {
    const daysSinceBase = Math.floor((date - PAY_PERIOD_CONFIG.BASE_DATE) / (1000 * 60 * 60 * 24));
    const currentPeriodNumber = Math.floor(daysSinceBase / PAY_PERIOD_CONFIG.LENGTH_DAYS);
    const targetPeriodNumber = currentPeriodNumber + offset;
    
    const periodStart = new Date(PAY_PERIOD_CONFIG.BASE_DATE);
    periodStart.setDate(periodStart.getDate() + (targetPeriodNumber * PAY_PERIOD_CONFIG.LENGTH_DAYS));
    
    const periodEnd = new Date(periodStart);
    periodEnd.setDate(periodEnd.getDate() + PAY_PERIOD_CONFIG.LENGTH_DAYS - 1);
    
    return {
        start: periodStart,
        end: periodEnd,
        number: targetPeriodNumber
    };
}

function loadTimesheetForPeriod(startDate, endDate) {
    console.log(`Loading timesheet for period: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`);
    
    // Call your existing timesheet loading function
    if (typeof loadTimesheet === 'function') {
        loadTimesheet();
    }
    
    // Or if you have a different function, call it here
    // For now, just filter shifts for the period
    if (window.shifts && window.shifts.my) {
        const periodShifts = window.shifts.my.filter(shift => {
            const shiftDate = new Date(shift.date);
            return shiftDate >= startDate && shiftDate <= endDate;
        });
        console.log(`Found ${periodShifts.length} shifts in period`);
        
        // Update timesheet display if needed
        if (typeof renderTimesheet === 'function') {
            renderTimesheet(periodShifts);
        }
    }
}


function updatePeriodDisplay() {
    const periodDatesElement = document.getElementById('periodDates');
    if (!periodDatesElement || !window.currentPeriodStart || !window.currentPeriodEnd) {
        return;
    }
    
    const formatOptions = { day: 'numeric', month: 'short', year: 'numeric' };
    const startStr = window.currentPeriodStart.toLocaleDateString(PAY_PERIOD_CONFIG.LOCALE, formatOptions);
    const endStr = window.currentPeriodEnd.toLocaleDateString(PAY_PERIOD_CONFIG.LOCALE, formatOptions);
    
    periodDatesElement.textContent = `${startStr} - ${endStr}`;
}

/**
 * Change to a different pay period
 * @param {number} direction - Number of periods to move (-1 = previous, 1 = next)
 */
function changePeriod(direction) {
    if (typeof direction !== 'number') {
        console.error('changePeriod: direction must be a number');
        return;
    }
    
    // Update the offset
    window.periodOffset = (window.periodOffset || 0) + direction;
    
    // Recalculate the period
    setCurrentPayPeriod();
    
    // Reload the timesheet with new period
    if (typeof loadTimesheet === 'function') {
        loadTimesheet();
    }
    
    // Also update schedule if visible
    if (document.getElementById('schedule')?.style.display !== 'none') {
        if (typeof loadSchedule === 'function') {
            loadSchedule();
        }
    }
}

/**
 * Reset to current pay period
 */
function resetToCurrentPeriod() {
    window.periodOffset = 0;
    setCurrentPayPeriod();
    
    if (typeof loadTimesheet === 'function') {
        loadTimesheet();
    }
}

/**
 * Get pay period for a specific date (utility function)
 */
function getPayPeriodForDate(date) {
    return calculatePayPeriod(date, 0);
}

// Make functions globally available
window.setCurrentPayPeriod = setCurrentPayPeriod;
window.changePeriod = changePeriod;
window.updatePeriodDisplay = updatePeriodDisplay;
window.resetToCurrentPeriod = resetToCurrentPeriod;
window.getPayPeriodForDate = getPayPeriodForDate;


async function loadTimesheet() {
    try {
        // Ensure period is set
        if (!window.currentPeriodStart || !window.currentPeriodEnd) {
            setCurrentPayPeriod();
        }
        
        // Use the period dates for query
        const startQuery = window.currentPeriodStart.toISOString().split('T')[0];
        const endQuery = window.currentPeriodEnd.toISOString().split('T')[0];
        
        console.log('Loading timesheet for period:', startQuery, 'to', endQuery);
        
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                duty_types(name),
                locations(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', startQuery)
            .lte('date', endQuery)
            .is('deleted_at', null)
            .order('date', { ascending: true });
        
        if (error) throw error;
        
        // Store shifts and update display
        AppState.shifts.my = shifts || [];
        
        if (shifts && shifts.length > 0) {
            calculateTimesheetHours(shifts);
            renderTimesheetShifts();
        } else {
            // Show empty state
            document.getElementById('timesheetShifts').innerHTML = 
                '<div style="padding: 40px; text-align: center; color: #999;">No shifts in this period</div>';
            document.getElementById('totalHours').textContent = '0.0h';
        }
        
    } catch (error) {
        console.error('Error loading timesheet:', error);
        showToast('Failed to load timesheet', 'error');
    }
}


function calculateHoursBreakdown() {
    const breakdown = {
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0,
        total: 0
    };
    
    AppState.shifts.my.forEach(shift => {
        const hours = calculateShiftHours(shift);
        Object.keys(hours).forEach(key => {
            if (breakdown[key] !== undefined) {
                breakdown[key] += hours[key] || 0;
            }
        });
    });
    
    // Update the hours grid display
    const hoursGrid = document.getElementById('hoursGrid');
    if (hoursGrid) {
        hoursGrid.innerHTML = `
            <div class="hour-item">
                <div class="hour-label">Weekday Day</div>
                <div class="hour-value">${breakdown.weekdayDay.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Weekday Evening</div>
                <div class="hour-value">${breakdown.weekdayEvening.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Weekday Night</div>
                <div class="hour-value">${breakdown.weekdayNight.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Saturday</div>
                <div class="hour-value">${breakdown.saturday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Sunday</div>
                <div class="hour-value">${breakdown.sunday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Public Holiday</div>
                <div class="hour-value">${breakdown.publicHoliday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Sleepovers</div>
                <div class="hour-value">${Math.floor(breakdown.sleepover)}x</div>
            </div>
        `;
    }
    
    // Update total hours
    const totalHours = document.getElementById('totalHours');
    if (totalHours) {
        totalHours.textContent = `${breakdown.total.toFixed(1)}h`;
    }
    
    return breakdown;
}

const timesheetStyles = `
    .shift-group {
        margin-bottom: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .shift-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-light, #f5f5f5);
        border-bottom: 1px solid var(--border-color, #e0e0e0);
        font-weight: 600;
    }
    
    .shift-group-hours {
        color: var(--primary-color, #004990);
        font-size: 16px;
    }
    
    .shift-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-light, #f0f0f0);
        transition: background 0.2s;
    }
    
    .shift-list-item:hover {
        background: var(--bg-light, #f9f9f9);
    }
    
    .shift-list-item:last-child {
        border-bottom: none;
    }
    
    .shift-info {
        flex: 1;
    }
    
    .shift-date-time {
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .shift-client {
        font-size: 14px;
        color: var(--text-light, #666);
        margin-bottom: 2px;
    }
    
    .shift-location {
        font-size: 13px;
        color: var(--text-light, #888);
    }
    
    .shift-hours {
        text-align: right;
        min-width: 60px;
    }
    
    .shift-hours-value {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-color, #004990);
    }
    
    .shift-pay {
        font-size: 12px;
        color: var(--text-light, #888);
        margin-top: 2px;
    }
`;

// Add styles if they don't exist
if (!document.getElementById('timesheetStyles')) {
    const styleElement = document.createElement('style');
    styleElement.id = 'timesheetStyles';
    styleElement.textContent = timesheetStyles;
    document.head.appendChild(styleElement);
}

// ==========================================
// EXACT TIMESHEET CALCULATIONS FROM MC-MANAGER
// ==========================================

// 1. Global variable for public holidays (add at top)
let publicHolidays = new Set();

// 2. The EXACT calculateShiftHours function from mc-manager
function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };

    const dutyType = shift.duty_type || shift.duty_types;
    const isSleepover = dutyType && dutyType.name && 
        dutyType.name.toLowerCase().includes('sleepover');

    // If it has times AND is a sleepover, calculate both
    if (isSleepover && shift.start_time && shift.end_time) {
        // This is BOTH active hours AND a sleepover
        
        // First calculate active hours
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const activeHours = (endTime - startTime) / (1000 * 60 * 60);
        
        // Apply penalty logic for active hours
        const shiftDate = new Date(shift.date);
        const dayOfWeek = shiftDate.getDay();
        const isPublicHoliday = publicHolidays.has(shift.date);
        
        if (isPublicHoliday) {
            result.publicHoliday = activeHours;
        } else if (dayOfWeek === 6) {
            result.saturday = activeHours;
        } else if (dayOfWeek === 0) {
            result.sunday = activeHours;
        } else {
            const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
            Object.assign(result, weekdayBreakdown);
        }
        
        // ADD the sleepover hours on top
        result.sleepover = 2; // Always 2 hours for sleepover
        result.total = activeHours + 2; // Total is active + sleepover
        
    } else if (isSleepover) {
        // Just a sleepover, no active hours
        result.sleepover = 2;
        result.total = 2;
        
    } else if (shift.start_time && shift.end_time) {
        // Just active hours, no sleepover
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const totalHours = (endTime - startTime) / (1000 * 60 * 60);
        result.total = totalHours;
        
        // Apply penalty logic
        const shiftDate = new Date(shift.date);
        const dayOfWeek = shiftDate.getDay();
        const isPublicHoliday = publicHolidays.has(shift.date);
        
        if (isPublicHoliday) {
            result.publicHoliday = totalHours;
        } else if (dayOfWeek === 6) {
            result.saturday = totalHours;
        } else if (dayOfWeek === 0) {
            result.sunday = totalHours;
        } else {
            const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
            Object.assign(result, weekdayBreakdown);
        }
    }
    
    return result;
}

// 3. The EXACT splitWeekdayHours function
function splitWeekdayHours(startTime, endTime) {
    const result = {
        total: 0,
        weekdayDay: 0,      // 6am-8pm
        weekdayEvening: 0,  // 8pm-12am  
        weekdayNight: 0     // 12am-6am
    };

    const current = new Date(startTime);
    
    while (current < endTime) {
        // Calculate end of current period
        const nextPeriod = new Date(current);
        nextPeriod.setMinutes(current.getMinutes() + 30); // Calculate in 30-min increments
        
        const periodEnd = nextPeriod > endTime ? endTime : nextPeriod;
        const periodHours = (periodEnd - current) / (1000 * 60 * 60);
        
        const hour = current.getHours();
        
        // Time period classification
        if (hour >= 6 && hour < 20) {
            result.weekdayDay += periodHours;
        } else if (hour >= 20 && hour < 24) {
            result.weekdayEvening += periodHours;
        } else {
            result.weekdayNight += periodHours;
        }
        
        current.setTime(periodEnd.getTime());
    }

    result.total = result.weekdayDay + result.weekdayEvening + result.weekdayNight;
    return result;
}

// 4. The EXACT calculateTimesheetHours for the timesheet display
function calculateTimesheetHours(shifts) {
    const breakdown = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0,
        sleepoverCount: 0
    };
    
    shifts.forEach(shift => {
        const hours = calculateShiftHours(shift);
        
        breakdown.total += hours.total || 0;
        breakdown.weekdayDay += hours.weekdayDay || 0;
        breakdown.weekdayEvening += hours.weekdayEvening || 0;
        breakdown.weekdayNight += hours.weekdayNight || 0;
        breakdown.saturday += hours.saturday || 0;
        breakdown.sunday += hours.sunday || 0;
        breakdown.publicHoliday += hours.publicHoliday || 0;
        breakdown.sleepover += hours.sleepover || 0;
        
        // Count sleepovers (not hours)
        if (hours.sleepover > 0) {
            breakdown.sleepoverCount++;
        }
    });
    
    // Update the hours grid display
    const hoursGrid = document.getElementById('hoursGrid');
    if (hoursGrid) {
        hoursGrid.innerHTML = `
            <div class="hours-item">
                <span class="hours-label">Weekday Day</span>
                <span class="hours-value">${breakdown.weekdayDay.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Evening</span>
                <span class="hours-value">${breakdown.weekdayEvening.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Night</span>
                <span class="hours-value">${breakdown.weekdayNight.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Saturday</span>
                <span class="hours-value">${breakdown.saturday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sunday</span>
                <span class="hours-value">${breakdown.sunday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Public Holiday</span>
                <span class="hours-value">${breakdown.publicHoliday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sleepovers</span>
                <span class="hours-value">${breakdown.sleepoverCount}</span>
            </div>
        `;
    }
    
    // Update total
    const totalElement = document.getElementById('totalHours');
    if (totalElement) {
        totalElement.textContent = `${breakdown.total.toFixed(1)}h`;
    }
    
    return breakdown;
}

// 5. Helper function for formatting hours
function formatHours(hours) {
    return (hours || 0).toFixed(1);
}

function toggleTimesheetView(view) {
    console.log('Toggling view to:', view);
    
    AppState.ui.timesheetView = view;
    
    // Update button states
    document.querySelectorAll('.view-toggle .toggle-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(view === 'date' ? 'Date' : 'Client')) {
            btn.classList.add('active');
        }
    });
    
    // Re-render with new view
    renderTimesheetShifts();
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('Initializing application...');
        
        // ===== UNIVERSAL EVENT DELEGATION (ONLY ONCE, COMPREHENSIVE VERSION) =====
        document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-modal-close], [data-modal-open], [data-timesheet-view], [data-transfer-tab], [data-section], [data-action], [data-action-with-param], [data-action-with-two-params]');
            
            if (!target) return;
            
            // Handle modal closes
            if (target.dataset.modalClose) {
                closeModal(target.dataset.modalClose);
                return;
            }
            
            // Handle modal opens
            if (target.dataset.modalOpen) {
                const modalName = target.dataset.modalOpen;
                const modal = document.getElementById(modalName);
                if (modal) {
                    modal.style.display = 'flex';
                }
                return;
            }
            
            // Handle specific actions FIRST (before generic handler)
            if (target.dataset.action === 'submitTransfer') {
                submitTransfer();
                return;
            }
            if (target.dataset.action === 'submitAdjustment') {
                submitAdjustment();
                return;
            }
            if (target.dataset.action === 'submitLeave') {
                submitLeave();
                return;
            }
            if (target.dataset.action === 'acceptTransfer') {
                const transferId = target.dataset.transferId;
                if (transferId) acceptTransfer(transferId);
                return;
            }
            if (target.dataset.action === 'rejectTransfer') {
                const transferId = target.dataset.transferId;
                if (transferId) rejectTransfer(transferId);
                return;
            }
            
            // Handle remove modal (special case for .remove())
            if (target.dataset.action === 'removeModal' && target.dataset.modalId) {
                const modal = document.getElementById(target.dataset.modalId);
                if (modal) {
                    modal.remove();
                }
                return;
            }
            
            // Handle reload page
            if (target.dataset.action === 'reloadPage') {
                location.reload();
                return;
            }
            
            // Handle toggle shift details (special case - needs 'this')
            if (target.dataset.action === 'toggleShiftDetails') {
                toggleShiftDetails(target);
                return;
            }
            
            // Handle show participant shifts (special case - multiple params)
            if (target.dataset.action === 'showParticipantShifts') {
                const participantId = target.dataset.participantId;
                const participantName = target.dataset.participantName;
                if (participantId && participantName) {
                    showParticipantShifts(participantId, participantName);
                }
                return;
            }
            
            // Handle timesheet view toggles
            if (target.dataset.timesheetView) {
                toggleTimesheetView(target.dataset.timesheetView);
                // Update active state for toggle buttons
                document.querySelectorAll('[data-timesheet-view]').forEach(btn => {
                    btn.classList.remove('active');
                });
                target.classList.add('active');
                return;
            }
            
            // Handle transfer tabs
            if (target.dataset.transferTab) {
                switchTransferTab(target.dataset.transferTab);
                return;
            }
            
            // Handle section switches
            if (target.dataset.section) {
                switchSection(target.dataset.section);
                return;
            }
            
            // Handle trigger click
            if (target.dataset.triggerClick) {
                const elementToClick = document.getElementById(target.dataset.triggerClick);
                if (elementToClick) {
                    elementToClick.click();
                }
                return;
            }
            
            // Handle generic actions (no parameters) - LAST
            if (target.dataset.action && !target.dataset.param) {
                const actionName = target.dataset.action;
                if (typeof window[actionName] === 'function') {
                    window[actionName]();
                }
                return;
            }
            
            // Handle actions with single parameter
            if (target.dataset.actionWithParam && target.dataset.param) {
                const actionName = target.dataset.actionWithParam;
                const param = target.dataset.param;
                
                if (typeof window[actionName] === 'function') {
                    // Handle numeric parameters
                    if (!isNaN(param) && param !== '') {
                        window[actionName](parseInt(param));
                    } else {
                        window[actionName](param);
                    }
                }
                return;
            }
        });
        
        // Add banner upload listeners
        const bannerUploadBtn = document.getElementById('bannerUploadBtn');
        if (bannerUploadBtn) {
            bannerUploadBtn.addEventListener('click', () => {
                document.getElementById('bannerUpload').click();
            });
        }
        
        const bannerUpload = document.getElementById('bannerUpload');
        if (bannerUpload) {
            bannerUpload.addEventListener('change', uploadProfileBanner);
        }
        
        // Phase 2: Initialize app
        await initializeApp();
        await ensureStaffLoaded();
        
        // Phase 3: Setup period navigation controls (NEW - PROPERLY TIMED)
        setTimeout(() => {
            const prevBtn = document.getElementById('prevPeriodBtn');
            const nextBtn = document.getElementById('nextPeriodBtn');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    console.log('Previous period clicked');
                    changePeriod(-1);
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    console.log('Next period clicked');
                    changePeriod(1);
                });
            }
            
            console.log('Period navigation buttons initialized');
        }, 500); // Small delay to ensure DOM is ready
        
        // Phase 4: Post-init tasks (with delay)
        setTimeout(async () => {
            if (AppState.staff.current) {
                const selector = document.getElementById('staffSelector');
                if (selector) {
                    selector.style.display = 'block';
                }
            }
        }, 2000);
        
        // Initialize pay period - ONLY call the GOOD setCurrentPayPeriod
        // Make sure you've deleted the OLD one that uses currentPeriodOffset
        if (typeof setCurrentPayPeriod === 'function') {
            setCurrentPayPeriod();
        }
        
        // Phase 6: Setup any remaining event listeners for special cases
        // For example, if you have file inputs or other special elements
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                if (e.target.id === 'documentFile') {
                    // Handle document upload preview if needed
                    if (typeof previewDocument === 'function') {
                        previewDocument(e);
                    }
                }
            });
        });
        
        // Load profile banner
        await loadProfileBanner();
        
        console.log('Application ready');
        console.log('Event delegation active for:', {
            modals: 'data-modal-close, data-modal-open',
            navigation: 'data-section',
            actions: 'data-action, data-action-with-param',
            timesheets: 'data-timesheet-view',
            transfers: 'data-transfer-tab',
            special: 'toggleShiftDetails, showParticipantShifts, removeModal'
        });
        
    } catch (error) {
        console.error('Initialization failed:', error);
        showToast('Failed to start application', 'error');
    }
});

// ============================================
// FIX 10: Initialize on Section Switch
// ============================================

// Override or enhance the switchSection function
const originalSwitchSection = window.switchSection;
window.switchSection = function(section) {
    // Call original if it exists
    if (typeof originalSwitchSection === 'function') {
        originalSwitchSection(section);
    }
    
    // Update nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.section === section) {
            item.classList.add('active');
        }
    });
    
    // Update content sections
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const targetSection = document.getElementById(section);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Load section data
    if (section === 'timesheet') {
        loadTimesheet();
    }
}

window.toggleTimesheetView = function(view) {
    try {
        AppState.ui.timesheetView = view;
        
        // Update button states
        document.querySelectorAll('.view-toggle .toggle-btn').forEach(btn => {
            btn.classList.remove('active');
            // Check if this is the clicked button
            if (btn.textContent.includes(view === 'date' ? 'Date' : 'Client')) {
                btn.classList.add('active');
            }
        });
        
        // Re-render with new view
        if (typeof renderTimesheetShifts === 'function') {
            renderTimesheetShifts();
        }
        
    } catch (error) {
        console.error('Error toggling timesheet view:', error);
    }
}


async function ensureStaffLoaded() {
    console.log('Ensuring staff data is loaded...');
    
    if (AppState.staff.current) {
        console.log('Staff already loaded:', AppState.staff.current);
        return AppState.staff.current;
    }
    
    try {
        // Get current user first
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (userError || !user) {
            console.error('No authenticated user found:', userError);
            window.location.href = 'index.html';
            return null;
        }
        
        console.log('Current user:', user.email);
        window.currentUser = user;
        
        // Try to load staff by user_id first
        let { data: staffData, error: staffError } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('user_id', user.id)
            .maybeSingle();
        
        // If not found by user_id, try by email
        if (!staffData) {
            console.log('No staff found by user_id, trying email...');
            const result = await supabaseClient
                .from('staff')
                .select('*')
                .eq('email', user.email)
                .maybeSingle();
            
            staffData = result.data;
            staffError = result.error;
        }
        
        if (staffError) {
            console.error('Error loading staff data:', staffError);
            showToast('Failed to load staff data', 'error');
            return null;
        }
        
        if (!staffData) {
            console.error('No staff record found for user');
            showToast('No staff record found. Please contact administrator.', 'error');
            return null;
        }
        
        // Set the global currentStaff
        AppState.staff.current = staffData;
        console.log('Staff data loaded successfully:', staffData);
        
        // Update UI with staff name
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = `${staffData.first_name} ${staffData.last_name}`;
        }
        
        return staffData;
        
    } catch (error) {
        console.error('Failed to ensure staff loaded:', error);
        showToast('Failed to load staff data', 'error');
        return null;
    }
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
        color: white;
        border-radius: 4px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showNotification(message, type = 'info') {
    // Alias for showToast to ensure compatibility
    showToast(message, type === 'error' ? 'error' : type === 'success' ? 'success' : 'info');
}


if (!document.querySelector('#toastStyles')) {
    const style = document.createElement('style');
    style.id = 'toastStyles';
    style.textContent = `
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, 100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

function switchSection(section) {
    try {
        // Update mobile nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            item.setAttribute('aria-selected', 'false');
        });
        
        // Set active nav item
        const activeNavItem = document.getElementById(`nav-${section}`);
        if (activeNavItem) {
            activeNavItem.classList.add('active');
            activeNavItem.setAttribute('aria-selected', 'true');
        }
        
        // Update desktop nav if it exists
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        const activeTab = document.querySelector(`.nav-tab[data-view="${section}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        // Hide all content sections
        document.querySelectorAll('.content-section').forEach(sec => {
            sec.classList.remove('active');
            sec.style.display = 'none';
        });
        
        // Show selected section
        const targetSection = document.getElementById(section);
        if (targetSection) {
            targetSection.classList.add('active');
            targetSection.style.display = 'block';
        }
        
        // Update AppState
        AppState.ui.currentSection = section;
        
        // Load section data based on what's selected
        switch(section) {
            case 'dashboard':
                if (typeof loadDashboard === 'function') {
                    loadDashboard();
                }
                break;
            case 'timesheet':
                if (typeof loadTimesheet === 'function') {
                    loadTimesheet();
                }
                break;
            case 'schedule':
                if (typeof loadSchedule === 'function') {
                    loadSchedule();
                }
                break;
            case 'transfers':
                if (typeof loadTransfers === 'function') {
                    loadTransfers();
                }
                break;
            case 'profile':
                if (typeof loadProfile === 'function') {
                    loadProfile();
                }
                break;
            default:
                console.warn('Unknown section:', section);
        }
        
        // Scroll to top on mobile
        window.scrollTo(0, 0);
        
    } catch (error) {
        console.error('Error switching section:', error);
        showToast('Failed to switch section', 'error');
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        
        // Clear form if exists
        const form = modal.querySelector('form');
        if (form) {
            form.reset();
        }
    }
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
    }
}



        function addButtonStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .btn {
                    padding: 12px 20px;
                    border: none;
                    border-radius: var(--radius-md);
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-size: 14px;
                }
                .btn-primary {
                    background: var(--primary-color);
                    color: white;
                }
                .btn-primary:hover {
                    background: var(--primary-dark);
                }
                .btn-secondary {
                    background: var(--bg-light);
                    color: var(--text-dark);
                }
                .btn-secondary:hover {
                    background: #d0d0d0;
                }
                .btn-sm {
                    padding: 8px 16px;
                    font-size: 12px;
                }
                .btn-outline {
                    background: transparent;
                    border: 1px solid var(--border-color);
                    color: var(--text-dark);
                }
                .btn-outline:hover {
                    background: var(--bg-light);
                }
            `;
            document.head.appendChild(style);
        }

window.testSelectedStaff = async function() {
    const select = document.getElementById('staffTestSelect');
    const staffId = select.value;
    
    console.log('Test selected staff called with ID:', staffId);
    
    if (!staffId) {
        showToast('Please select a staff member', 'warning');
        return;
    }
    
    // First ensure we have the original staff loaded
    if (!AppState.staff.current) {
        console.log('Current staff not loaded, loading first...');
        await ensureStaffLoaded();
        
        if (!AppState.staff.current) {
            showToast('Failed to load your staff data first', 'error');
            return;
        }
    }
    
    // Now switch to test staff
    await switchToStaff(staffId);
    
    // Hide the selector after successful switch
    const selector = document.getElementById('staffSelector');
    if (selector) {
        selector.style.display = 'none';
    }
}

// ==========================================
// ENHANCED: Initialize App with Staff Check
// ==========================================

// Override or enhance the initializeApp function
const originalInitializeApp = window.initializeApp;

window.initializeApp = async function() {
    try {
        console.log('Enhanced initialization starting...');
        
        // Ensure staff is loaded first
        await ensureStaffLoaded();
        
        if (!AppState.staff.current) {
            console.error('Failed to load staff during initialization');
            showToast('Failed to load staff data. Please refresh the page.', 'error');
            return;
        }
        
        // Call original initialization if it exists
        if (typeof originalInitializeApp === 'function') {
            await originalInitializeApp();
        }
        
        // Load reference data if not already loaded
        if (typeof loadReferenceData === 'function') {
            await loadReferenceData();
        }
        
        console.log('Enhanced initialization complete');
        
    } catch (error) {
        console.error('Enhanced initialization error:', error);
        showToast('Initialization failed: ' + error.message, 'error');
    }
}


        </script>
        </body>
        </html>

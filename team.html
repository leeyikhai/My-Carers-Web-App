
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>My Carers</title>
  
    <!-- favicon links -->
    <link rel="icon" type="image/png" sizes="16x16" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-32x32.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        
        :root {
            --primary-color: #004990;
            --primary-dark: #003670;
            --primary-light: #0056b3;
            --success-color: #88a542;
            --info-color: #359dca;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f8f9fa;
            --bg-dark: #1a2332;
            --border-color: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 70px; /* Space for mobile nav */
        }

        /* Header with Profile Banner */
        .header {
            background: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .profile-banner {
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .profile-banner-upload {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: var(--radius-md);
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .profile-info {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .user-details h2 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .user-role {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: var(--text-light);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item .badge {
            position: absolute;
            top: 4px;
            right: calc(50% - 20px);
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 16px;
        }

        /* Content Sections */
        .content-section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .dashboard-header {
            margin-bottom: 20px;
        }

        .greeting {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .date-display {
            color: var(--text-light);
            font-size: 14px;
        }

        .shift-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .shift-card:active {
            transform: scale(0.98);
        }

        .shift-card-header {
            padding: 20px;
            position: relative;
        }

        .shift-time {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .shift-participant {
            font-size: 16px;
            opacity: 0.95;
            margin-bottom: 4px;
        }

        .shift-location {
            font-size: 14px;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shift-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .shift-expand-icon {
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .shift-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(255,255,255,0.95);
            color: var(--text-dark);
        }

        .shift-card.expanded .shift-details {
            max-height: 500px;
        }

        .shift-card.expanded .shift-expand-icon {
            transform: rotate(180deg);
        }

        .handover-section {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .handover-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .handover-note {
            background: var(--bg-light);
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .handover-author {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .quick-action-btn:active {
            transform: scale(0.95);
            background: var(--bg-light);
        }

        .quick-action-btn .icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        /* Requests Summary */
        .requests-summary {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .requests-summary h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-dark);
        }

        .request-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-type {
            font-size: 14px;
            font-weight: 500;
        }

        .request-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-denied {
            background: #f8d7da;
            color: #721c24;
        }

        /* Timesheet View */
        .period-selector {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .period-display {
            text-align: center;
            flex: 1;
        }

        .period-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .period-dates {
            font-size: 16px;
            font-weight: 600;
        }

        .period-nav {
            padding: 8px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
        }

        /* Timesheet Summary */
        .timesheet-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .timesheet-summary h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        .hours-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .hour-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: var(--radius-md);
        }

        .hour-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .hour-value {
            font-size: 20px;
            font-weight: 600;
        }

        .total-section {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 16px;
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 600;
        }

        /* Shift List */
        .shift-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .shift-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .shift-list-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-list-item:last-child {
            border-bottom: none;
        }

        .shift-info {
            flex: 1;
        }

        .shift-date-time {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .shift-client {
            font-size: 14px;
            color: var(--text-light);
        }

        .shift-hours {
            text-align: right;
        }

        .btn {
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
}

.btn-secondary:hover {
    background: #d0d0d0;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 12px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-dark);
}

.btn-outline:hover {
    background: var(--bg-light);
}

        .shift-hours-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .shift-pay {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Schedule View */
        .calendar-header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .participant-filter {
            margin-bottom: 12px;
        }

        .participant-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: white;
        }

        .date-range-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-light);
            margin-top: 12px;
        }

        .schedule-grid {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .day-section {
            border-bottom: 1px solid var(--border-color);
        }

        .day-section:last-child {
            border-bottom: none;
        }

        .day-header {
            background: var(--bg-light);
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-date {
            font-size: 14px;
        }

        .fortnight-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--border-color);
    margin-top: 20px;
}

.schedule-day {
    background: white;
    min-height: 100px;
    padding: 8px;
}

.schedule-day.weekend {
    background: #f8f9fa;
}

.schedule-day.today {
    background: #e3f2fd;
}

.day-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border-color);
}

.day-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--text-light);
}

.day-date {
    font-weight: 600;
    font-size: 14px;
}

.shift-block {
    background: var(--primary-color);
    color: white;
    padding: 4px 6px;
    border-radius: 4px;
    margin-bottom: 4px;
    font-size: 11px;
}

.no-shift {
    color: var(--text-light);
    font-size: 11px;
    text-align: center;
    margin-top: 10px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}



        .day-shift-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .day-shifts {
            padding: 8px;
        }

        .schedule-shift {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-shift:last-child {
            margin-bottom: 0;
        }

        .schedule-shift-time {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .schedule-shift-staff {
            font-size: 13px;
            color: var(--text-light);
        }

        .schedule-shift-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .action-btn.secondary {
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        /* Transfers View */
        .transfer-tabs {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 16px;
            display: flex;
            box-shadow: var(--shadow-sm);
        }

        .transfer-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            font-weight: 500;
            transition: all 0.3s;
        }

        .transfer-tab:last-child {
            border-right: none;
        }

        .transfer-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .transfer-list {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .transfer-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .transfer-item:last-child {
            margin-bottom: 0;
        }

        .transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .transfer-date {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .transfer-time {
            font-size: 14px;
            color: var(--text-light);
        }

        .transfer-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .transfer-from {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .transfer-reason {
            font-size: 13px;
            color: var(--text-light);
            font-style: italic;
            padding: 8px;
            background: white;
            border-radius: var(--radius-sm);
            margin-top: 8px;
        }

        .transfer-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .transfer-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .transfer-btn.accept {
            background: var(--success-color);
            color: white;
        }

        .transfer-btn.decline {
            background: white;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        /* Profile View */
        .profile-section {
            background: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .profile-section-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-btn {
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .profile-content {
            padding: 16px;
        }

        .profile-field {
            margin-bottom: 16px;
        }

        .profile-field:last-child {
            margin-bottom: 0;
        }

        .field-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .field-value {
            font-size: 16px;
            color: var(--text-dark);
        }

        .field-value input,
        .field-value select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 16px;
        }

        /* Documents Section */
        .document-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .document-upload-area:hover {
            border-color: var(--primary-color);
            background: var(--bg-light);
        }

        .document-list {
            display: grid;
            gap: 12px;
        }

        .document-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 12px;
            color: var(--text-light);
        }

        .document-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Availability Pattern */
        .availability-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 16px;
        }

        .availability-day {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .availability-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .day-name {
            font-weight: 600;
        }

        .availability-toggle {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .availability-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        .availability-toggle input:checked + .toggle-slider {
            background: var(--success-color);
        }

        .availability-toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .availability-times {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .time-slot {
            padding: 8px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Modal System */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 73, 144, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Image Upload for Notes */
        .image-upload-area {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        .add-image-btn {
            width: 60px;
            height: 60px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-light);
        }

        /* Notifications */
        .notification-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .notification-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.unread {
            background: #f0f8ff;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-icon.info {
            background: #cce5ff;
            color: #004085;
        }

        .notification-icon.success {
            background: #d4edda;
            color: #155724;
        }

        .notification-icon.warning {
            background: #fff3cd;
            color: #856404;
        }

        .notification-content {
            flex: 1;
        }

        .notification-message {
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            animation: slideUp 0.3s ease-out;
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* Desktop Responsiveness */
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }

            .mobile-nav {
                display: none;
            }

            .desktop-nav {
                display: flex;
                background: white;
                border-bottom: 1px solid var(--border-color);
                padding: 0 20px;
            }

            .desktop-nav .nav-item {
                padding: 16px 24px;
                border-bottom: 3px solid transparent;
                transition: all 0.3s;
            }

            .desktop-nav .nav-item.active {
                border-bottom-color: var(--primary-color);
            }

            .content-section {
                max-width: 1200px;
                margin: 0 auto;
                padding: 40px;
            }

            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }

            .hours-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .document-list {
                grid-template-columns: repeat(2, 1fr);
            }

            .availability-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 600; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .p-2 { padding: 16px; }
        .hidden { display: none; }

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.form-legend {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--text-dark);
    border: none;
    padding: 0;
}

.form-help {
    display: block;
    margin-top: 4px;
    font-size: 12px;
    color: var(--text-light);
}

.error-message {
    display: none;
    margin-top: 4px;
    font-size: 12px;
    color: var(--danger-color);
    font-weight: 500;
}

.error-message.show {
    display: block;
}

.form-control:invalid {
    border-color: var(--danger-color);
}

.form-control:invalid + .error-message {
    display: block;
}

/* Navigation improvements */
.nav-item {
    border: none;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s;
}

.nav-item:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

.nav-item[aria-selected="true"] {
    color: var(--primary-color);
}

/* Modal improvements */
.modal[aria-hidden="true"] {
    display: none;
}

.modal[aria-hidden="false"] {
    display: flex;
}

.modal-close:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* Header improvements */
.header {
    background: white;
    border-bottom: 1px solid var(--border-color);
    padding: 0;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.logo img {
    max-height: 40px;
    width: auto;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-name {
    font-weight: 500;
    color: var(--text-dark);
}

.user-role {
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
}

/* Image upload improvements */
.add-image-btn {
    width: 60px;
    height: 60px;
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 24px;
    color: var(--text-light);
}

.add-image-btn:hover,
.add-image-btn:focus {
    border-color: var(--primary-color);
    color: var(--primary-color);
    outline: none;
}

.image-upload-area {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 8px;
}

#imagePreviewContainer {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.image-preview {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius-md);
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
}

.image-preview:hover {
    border-color: var(--danger-color);
    opacity: 0.8;
}

.weekly-schedule {
    background: white;
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.day-section {
    border-bottom: 1px solid var(--border-color);
}

.day-section:last-child {
    border-bottom: none;
}

.day-section.today {
    background: #f0f8ff;
}

.day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--bg-light);
    border-bottom: 1px solid var(--border-color);
}

.day-name {
    font-weight: 600;
    font-size: 16px;
}

.shift-count {
    background: var(--primary-color);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.shift-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light);
    transition: background 0.2s;
}

.shift-item:hover {
    background: var(--bg-light);
}

.shift-item:last-child {
    border-bottom: none;
}

.no-shifts {
    padding: 20px;
    text-align: center;
    color: var(--text-light);
    font-style: italic;
}

.shift-history-item {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
}

.shift-date-header {
    font-weight: 600;
    margin-bottom: 8px;
}
    </style>

    
</head>
<body>
     <!-- Header with Profile Banner -->
     <header class="header">
        <div class="profile-info">
            <div class="user-details">
                <h2 id="userName">Loading...</h2>
                <span class="user-role" id="userRole">Staff</span>
            </div>
            <button class="btn btn-sm btn-outline" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Desktop Navigation (hidden on mobile) -->
    <nav class="desktop-nav hidden">
        <button class="nav-item" onclick="switchSection('dashboard')" 
                aria-label="Navigate to dashboard" 
                role="tab" 
                aria-selected="true">
            <div class="icon"><i class="fa-solid fa-house" aria-hidden="true"></i></div>
            <div>Home</div>
        </button>
        <div class="nav-item" onclick="switchSection('timesheet')">
            <span>Timesheet</span>
        </div>
        <div class="nav-item" onclick="switchSection('schedule')">
            <span>Schedule</span>
        </div>
        <div class="nav-item" onclick="switchSection('transfers')">
            <span>Transfers</span>
        </div>
        <div class="nav-item" onclick="switchSection('profile')">
            <span>Profile</span>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboard" class="content-section active">
        <div class="dashboard-header">
            <div class="greeting" id="greeting">Good morning!</div>
            <div class="date-display" id="currentDate">Monday, 5 January 2025</div>
        </div>

        <!-- Current/Upcoming Shift -->
        <div id="currentShift">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action-btn" onclick="showAddShiftModal()">
                <span class="icon"><i class="fa-solid fa-plus"></i></span>
                <span>Add Shift</span>
            </div>
            <div class="quick-action-btn" onclick="showTransferModal()">
                <span class="icon"><i class="fa-solid fa-arrow-right-arrow-left"></i></span>
                <span>Transfer Shift</span>
            </div>
            <div class="quick-action-btn" onclick="showAdjustmentModal()">
                <span class="icon"><i class="fa-solid fa-clock"></i></span>
                <span>Adjust Time</span>
            </div>
            <div class="quick-action-btn" onclick="showLeaveModal()">
                <span class="icon"><i class="fa-solid fa-umbrella-beach"></i></span>
                <span>Request Leave</span>
            </div>
        </div>
    
        <!-- Pending Requests Summary -->
        <div class="requests-summary">
            <h3>Pending Requests</h3>
            <div id="pendingRequestsList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Recent Notifications -->
        <div class="requests-summary">
            <h3>Recent Updates</h3>
            <div id="recentNotifications">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Timesheet Section -->
    <div id="timesheet" class="content-section">
        <div class="period-selector">
            <button class="period-nav" onclick="changePeriod(-1)">◀</button>
            <div class="period-display">
                <div class="period-label">Pay Period</div>
                <div class="period-dates" id="periodDates">28 Jul - 10 Aug 2025</div>
            </div>
            <button class="period-nav" onclick="changePeriod(1)">▶</button>
        </div>

        <!-- Hours Summary -->
        <div class="timesheet-summary">
            <h3>Hours Breakdown</h3>
            <div class="hours-grid" id="hoursGrid">
                <!-- Will be populated dynamically -->
            </div>
            <div class="total-section">
                <span>Total Hours</span>
                <span id="totalHours">0.0h</span>
            </div>
        </div>

        <!-- Shift List with Toggle -->
        <div class="shift-list">
            <div class="shift-list-header">
                <h3>Shifts</h3>
                <div class="view-toggle">
                    <button class="toggle-btn active" onclick="toggleTimesheetView('date')">By Date</button>
                    <button class="toggle-btn" onclick="toggleTimesheetView('participant')">By Client</button>
                </div>
            </div>
            <div id="timesheetShifts">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Schedule Section -->
    <div id="schedule" class="content-section">
        <div class="calendar-header">
            <div class="participant-filter">
                <label class="field-label">Filter by Client</label>
                <select class="participant-select" id="participantFilter" onchange="filterSchedule()">
                    <option value="">All My Clients</option>
                </select>
            </div>
            <div class="date-range-info">
                <span>📅</span>
                <span>Showing 2 weeks before and after today</span>
            </div>
        </div>

        <div class="schedule-grid" id="scheduleGrid">
            <!-- Will be populated dynamically -->
        </div>
    </div>

    <!-- Transfers Section -->
    <div id="transfers" class="content-section">
        <div class="transfer-tabs">
            <div class="transfer-tab active" onclick="switchTransferTab('incoming')">
                Incoming Requests
                <span class="badge" id="incomingCount">0</span>
            </div>
            <div class="transfer-tab" onclick="switchTransferTab('outgoing')">
                My Requests
            </div>
            <div class="transfer-tab" onclick="switchTransferTab('available')">
                Available Shifts
            </div>
        </div>

        <div id="incomingTransfers" class="transfer-content active">
            <div class="transfer-list" id="incomingList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <div id="outgoingTransfers" class="transfer-content">
            <div class="transfer-list" id="outgoingList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <div id="availableTransfers" class="transfer-content">
            <div class="transfer-list" id="availableList">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Profile Section -->
    <div id="profile" class="content-section">
        <div class="profile-banner" id="profileBanner">
            <div class="profile-banner-upload" id="bannerUploadBtn">
                📷 Change Banner
            </div>
            <input type="file" id="bannerUpload" accept="image/*" style="display: none;">
        </div>
        <!-- Personal Information -->
        <div class="profile-section">
            <div class="profile-section-header">
                Personal Information
                <button class="edit-btn" onclick="editPersonalInfo()">Edit</button>
            </div>
            <div class="profile-content" id="personalInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Contact Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Contact Details
                <button class="edit-btn" onclick="editContactInfo()">Edit</button>
            </div>
            <div class="profile-content" id="contactInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Banking Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Banking & Super
                <button class="edit-btn" onclick="editBankingInfo()">Edit</button>
            </div>
            <div class="profile-content" id="bankingInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Documents -->
        <div class="profile-section">
            <div class="profile-section-header">
                Documents
            </div>
            <div class="profile-content">
                <div class="document-upload-area" onclick="showDocumentUploadModal()">
                    <div>📎 Upload Document</div>
                    <div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                        Click to upload certifications, ID, checks, etc.
                    </div>
                </div>
                <div class="document-list" id="documentList">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Availability Pattern -->
        <div class="profile-section">
            <div class="profile-section-header">
                Weekly Availability
                <button class="edit-btn" onclick="saveAvailability()">Save</button>
            </div>
            <div class="profile-content">
                <div class="availability-grid" id="availabilityGrid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav" role="tablist" aria-label="Main navigation">
        <button class="nav-item active" 
                onclick="switchSection('dashboard')" 
                aria-label="Navigate to dashboard" 
                role="tab" 
                aria-selected="true"
                id="nav-dashboard">
            <div class="icon"><i class="fa-solid fa-house" aria-hidden="true"></i></div>
            <div>Home</div>
            <span class="badge hidden" id="homeBadge" aria-label="pending items">1</span>
        </button>
        
        <button class="nav-item" 
                onclick="switchSection('timesheet')" 
                aria-label="Navigate to timesheet" 
                role="tab" 
                aria-selected="false"
                id="nav-timesheet">
            <div class="icon"><i class="fa-solid fa-chart-bar" aria-hidden="true"></i></div>
            <div>Timesheet</div>
        </button>
        
        <button class="nav-item" 
                onclick="switchSection('schedule')" 
                aria-label="Navigate to schedule" 
                role="tab" 
                aria-selected="false"
                id="nav-schedule">
            <div class="icon"><i class="fa-solid fa-calendar-days" aria-hidden="true"></i></div>
            <div>Schedule</div>
        </button>
        
        <button class="nav-item" 
                onclick="switchSection('transfers')" 
                aria-label="Navigate to transfers" 
                role="tab" 
                aria-selected="false"
                id="nav-transfers">
            <div class="icon"><i class="fa-solid fa-arrow-right-arrow-left" aria-hidden="true"></i></div>
            <div>Transfers</div>
            <span class="badge hidden" id="transferBadge" aria-label="pending transfers">0</span>
        </button>
        
        <button class="nav-item" 
                onclick="switchSection('profile')" 
                aria-label="Navigate to profile" 
                role="tab" 
                aria-selected="false"
                id="nav-profile">
            <div class="icon"><i class="fa-solid fa-user" aria-hidden="true"></i></div>
            <div>Profile</div>
        </button>
    </nav>

    <!-- MODALS SECTION -->

    <!-- Add Shift Modal -->
    <div id="addShiftModal" class="modal" role="dialog" aria-labelledby="addShiftTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="addShiftTitle" class="modal-title">Add New Shift</h3>
                <button class="modal-close" 
                        onclick="closeModal('addShiftModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="addShiftForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Shift Details</legend>
                        
                        <div class="form-group">
                            <label for="shiftDate" class="form-label">Date *</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="shiftDate" 
                                   name="shiftDate"
                                   required 
                                   aria-describedby="shiftDate-error">
                            <div id="shiftDate-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        <div class="form-group">
                            <label for="shiftParticipant" class="form-label">Client *</label>
                            <select class="form-control" 
                                    id="shiftParticipant" 
                                    name="shiftParticipant"
                                    required 
                                    onchange="onParticipantSelect('shiftParticipant', 'shiftLocation')"
                                    aria-describedby="shiftParticipant-error">
                                <option value="">Select Client</option>
                            </select>
                            <div id="shiftParticipant-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="shiftLocation" class="form-label">Location *</label>
                            <select class="form-control" 
                                    id="shiftLocation" 
                                    name="shiftLocation"
                                    required 
                                    aria-describedby="shiftLocation-error">
                                <option value="">Select Location</option>
                            </select>
                            <div id="shiftLocation-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="shiftDutyType" class="form-label">Shift Type *</label>
                            <select class="form-control" 
                                    id="shiftDutyType" 
                                    name="shiftDutyType"
                                    required 
                                    onchange="toggleTimeFields()"
                                    aria-describedby="shiftDutyType-error">
                                <option value="">Select Type</option>
                            </select>
                            <div id="shiftDutyType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset id="timeFields">
                            <legend class="sr-only">Shift Times</legend>
                            
                            <div class="form-group">
                                <label for="shiftStartTime" class="form-label">Start Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="shiftStartTime" 
                                       name="shiftStartTime"
                                       aria-describedby="shiftStartTime-help">
                                <small id="shiftStartTime-help" class="form-help">Leave blank for sleepover shifts</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="shiftEndTime" class="form-label">End Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="shiftEndTime" 
                                       name="shiftEndTime"
                                       aria-describedby="shiftEndTime-help">
                                <small id="shiftEndTime-help" class="form-help">Leave blank for sleepover shifts</small>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="shiftNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" 
                                      id="shiftNotes" 
                                      name="shiftNotes"
                                      placeholder="Any additional information..."
                                      rows="3"
                                      aria-describedby="shiftNotes-help"></textarea>
                            <small id="shiftNotes-help" class="form-help">Additional details about the shift</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('addShiftModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="submitShift()" form="addShiftForm">
                    Submit for Approval
                </button>
            </footer>
        </div>
    </div>

    <!-- Transfer Shift Modal -->
    <div id="transferShiftModal" class="modal" role="dialog" aria-labelledby="transferShiftTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="transferShiftTitle" class="modal-title">Transfer Shift</h3>
                <button class="modal-close" 
                        onclick="closeModal('transferShiftModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="transferForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Transfer Details</legend>
                        
                        <div class="form-group">
                            <label for="transferShiftSelect" class="form-label">Select Shift to Transfer *</label>
                            <select class="form-control" 
                                    id="transferShiftSelect" 
                                    name="transferShiftSelect"
                                    required 
                                    aria-describedby="transferShiftSelect-error">
                                <option value="">Select a shift</option>
                            </select>
                            <div id="transferShiftSelect-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="transferToStaff" class="form-label">Transfer To *</label>
                            <select class="form-control" 
                                    id="transferToStaff" 
                                    name="transferToStaff"
                                    required 
                                    aria-describedby="transferToStaff-error transferToStaff-help">
                                <option value="">Select staff member</option>
                            </select>
                            <small id="transferToStaff-help" class="form-help">Choose the staff member to transfer this shift to</small>
                            <div id="transferToStaff-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="transferReason" class="form-label">Reason *</label>
                            <textarea class="form-control" 
                                      id="transferReason" 
                                      name="transferReason"
                                      required 
                                      placeholder="Please provide a reason for the transfer..."
                                      rows="3"
                                      aria-describedby="transferReason-error transferReason-help"></textarea>
                            <small id="transferReason-help" class="form-help">Explain why you need to transfer this shift</small>
                            <div id="transferReason-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('transferShiftModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="submitTransfer()" form="transferForm">
                    Send Transfer Request
                </button>
            </footer>
        </div>
    </div>

    <!-- Time Adjustment Modal -->
    <div id="adjustmentModal" class="modal" role="dialog" aria-labelledby="adjustmentTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="adjustmentTitle" class="modal-title">Request Time Adjustment</h3>
                <button class="modal-close" 
                        onclick="closeModal('adjustmentModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="adjustmentForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Time Adjustment Details</legend>
                        
                        <div class="form-group">
                            <label for="adjustmentShift" class="form-label">Select Shift *</label>
                            <select class="form-control" 
                                    id="adjustmentShift" 
                                    name="adjustmentShift"
                                    required 
                                    onchange="loadShiftTimes()"
                                    aria-describedby="adjustmentShift-error">
                                <option value="">Select a shift</option>
                            </select>
                            <div id="adjustmentShift-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset>
                            <legend class="form-legend">New Times</legend>
                            
                            <div class="form-group">
                                <label for="adjustmentStartTime" class="form-label">New Start Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="adjustmentStartTime" 
                                       name="adjustmentStartTime"
                                       aria-describedby="adjustmentStartTime-help">
                                <small id="adjustmentStartTime-help" class="form-help">Current time will be shown when shift is selected</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="adjustmentEndTime" class="form-label">New End Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="adjustmentEndTime" 
                                       name="adjustmentEndTime"
                                       aria-describedby="adjustmentEndTime-help">
                                <small id="adjustmentEndTime-help" class="form-help">Current time will be shown when shift is selected</small>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="adjustmentReason" class="form-label">Reason for Adjustment *</label>
                            <textarea class="form-control" 
                                      id="adjustmentReason" 
                                      name="adjustmentReason"
                                      required 
                                      placeholder="Please explain the time adjustment..."
                                      rows="3"
                                      aria-describedby="adjustmentReason-error adjustmentReason-help"></textarea>
                            <small id="adjustmentReason-help" class="form-help">Explain why the times need to be adjusted</small>
                            <div id="adjustmentReason-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('adjustmentModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="submitAdjustment()" form="adjustmentForm">
                    Submit Request
                </button>
            </footer>
        </div>
    </div>

    <!-- Leave Request Modal -->
    <div id="leaveModal" class="modal" role="dialog" aria-labelledby="leaveTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="leaveTitle" class="modal-title">Request Leave</h3>
                <button class="modal-close" 
                        onclick="closeModal('leaveModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="leaveForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Leave Request Details</legend>
                        
                        <div class="form-group">
                            <label for="leaveType" class="form-label">Leave Type *</label>
                            <select class="form-control" 
                                    id="leaveType" 
                                    name="leaveType"
                                    required 
                                    aria-describedby="leaveType-error">
                                <option value="">Select type</option>
                                <option value="annual">Annual Leave</option>
                                <option value="sick">Sick Leave</option>
                                <option value="personal">Personal Leave</option>
                                <option value="unpaid">Unpaid Leave</option>
                            </select>
                            <div id="leaveType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset>
                            <legend class="form-legend">Leave Dates</legend>
                            
                            <div class="form-group">
                                <label for="leaveStartDate" class="form-label">Start Date *</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="leaveStartDate" 
                                       name="leaveStartDate"
                                       required 
                                       aria-describedby="leaveStartDate-error">
                                <div id="leaveStartDate-error" class="error-message" role="alert" aria-live="polite"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="leaveEndDate" class="form-label">End Date *</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="leaveEndDate" 
                                       name="leaveEndDate"
                                       required 
                                       aria-describedby="leaveEndDate-error">
                                <div id="leaveEndDate-error" class="error-message" role="alert" aria-live="polite"></div>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="leaveReason" class="form-label">Reason</label>
                            <textarea class="form-control" 
                                      id="leaveReason" 
                                      name="leaveReason"
                                      placeholder="Optional: Provide additional details..."
                                      rows="3"
                                      aria-describedby="leaveReason-help"></textarea>
                            <small id="leaveReason-help" class="form-help">Additional details about your leave request</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('leaveModal')">
                    Cancel
                </button>
                <button type="button" onclick="submitLeave()">Submit Request</button>
            </footer>
        </div>
    </div>

    <!-- Document Upload Modal -->
    <div id="documentUploadModal" class="modal" role="dialog" aria-labelledby="documentUploadTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="documentUploadTitle" class="modal-title">Upload Document</h3>
                <button class="modal-close" 
                        onclick="closeModal('documentUploadModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="documentUploadForm" enctype="multipart/form-data" novalidate>
                    <fieldset>
                        <legend class="sr-only">Document Information</legend>
                        
                        <div class="form-group">
                            <label for="documentType" class="form-label">Document Type *</label>
                            <select class="form-control" 
                                    id="documentType" 
                                    name="documentType"
                                    required 
                                    onchange="checkExpiryRequired()"
                                    aria-describedby="documentType-error">
                                <option value="">Select type</option>
                                <option value="id">Photo ID</option>
                                <option value="resume">Resume/CV</option>
                                <option value="visa">Visa/Work Permit</option>
                                <option value="firstaid">First Aid/CPR Certificate</option>
                                <option value="wwcc">Working with Children Check</option>
                                <option value="police">Police Check</option>
                                <option value="ndis">NDIS Worker Check</option>
                                <option value="other">Other</option>
                            </select>
                            <div id="documentType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentTitle" class="form-label">Document Title *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="documentTitle" 
                                   name="documentTitle"
                                   required 
                                   placeholder="e.g., Driver's License"
                                   aria-describedby="documentTitle-error">
                            <div id="documentTitle-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group" id="expiryGroup">
                            <label for="documentExpiry" class="form-label">Expiry Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="documentExpiry" 
                                   name="documentExpiry"
                                   aria-describedby="documentExpiry-help">
                            <small id="documentExpiry-help" class="form-help">Required for certain document types</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentFile" class="form-label">Select File *</label>
                            <input type="file" 
                                   class="form-control" 
                                   id="documentFile" 
                                   name="documentFile"
                                   required 
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   aria-describedby="documentFile-error documentFile-help">
                            <small id="documentFile-help" class="form-help">Max 10MB. PDF, JPG, PNG accepted.</small>
                            <div id="documentFile-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentNotes" class="form-label">Notes</label>
                            <textarea class="form-control" 
                                      id="documentNotes" 
                                      name="documentNotes"
                                      placeholder="Optional notes..."
                                      rows="3"
                                      aria-describedby="documentNotes-help"></textarea>
                            <small id="documentNotes-help" class="form-help">Additional information about the document</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('documentUploadModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="uploadDocument()" form="documentUploadForm">
                    Upload
                </button>
            </footer>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="addNoteModal" class="modal" role="dialog" aria-labelledby="addNoteTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="addNoteTitle" class="modal-title">Add Shift Note</h3>
                <button class="modal-close" 
                        onclick="closeModal('addNoteModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="noteForm" novalidate>
                    <input type="hidden" id="noteShiftId" name="noteShiftId">
                    
                    <fieldset>
                        <legend class="sr-only">Note Details</legend>
                        
                        <div class="form-group">
                            <label for="noteType" class="form-label">Note Type *</label>
                            <select class="form-control" 
                                    id="noteType" 
                                    name="noteType"
                                    required 
                                    aria-describedby="noteType-error noteType-help">
                                <option value="shift">Shift Note (Visible to Manager)</option>
                                <option value="handover">Handover Note (Staff Only)</option>
                                <option value="incident">Incident Report</option>
                            </select>
                            <small id="noteType-help" class="form-help">Choose the appropriate note type</small>
                            <div id="noteType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="noteContent" class="form-label">Note *</label>
                            <textarea class="form-control" 
                                      id="noteContent" 
                                      name="noteContent"
                                      required 
                                      placeholder="Enter your note..."
                                      rows="4"
                                      aria-describedby="noteContent-error"></textarea>
                            <div id="noteContent-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset class="form-group">
                            <legend class="form-label">Attach Images</legend>
                            <div class="image-upload-area" role="region" aria-label="Image upload area">
                                <button type="button" 
                                        class="add-image-btn" 
                                        onclick="document.getElementById('noteImages').click()"
                                        aria-label="Add images">
                                    <i class="fa-solid fa-plus" aria-hidden="true"></i>
                                </button>
                                <div id="imagePreviewContainer" 
                                     role="region" 
                                     aria-label="Image previews"
                                     aria-live="polite"></div>
                            </div>
                            <input type="file" 
                                   id="noteImages" 
                                   name="noteImages"
                                   multiple 
                                   accept="image/*" 
                                   style="display: none;" 
                                   onchange="previewImages()"
                                   aria-describedby="noteImages-help">
                            <small id="noteImages-help" class="form-help">Optional: Add up to 5 images</small>
                        </fieldset>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('addNoteModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="submitNote()" form="noteForm">
                    Add Note
                </button>
            </footer>
        </div>
    </div>

    <script>

        
        // Supabase Configuration
        const SUPABASE_URL = 'https://gqchhsayqxttewthcsah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxY2hoc2F5cXh0dGV3dGhjc2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTA0ODksImV4cCI6MjA3MjI2NjQ4OX0.iAGhrDZaHkpLwjJY07o-73l2OiePB2x1ZnnTEfUBd_M';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        //DAY OFFSETTER!
        const DATE_OFFSET_DAYS = -21; // Set to 0 to disable testing mode
        const PERIOD_LENGTH = 14; // 14-day pay periods
        // Global State
        let currentUser = null;
        let currentStaff = null;
        let allShifts = [];
        let myShifts = [];
        let participants = [];
        let staff = [];
        let dutyTypes = [];
        let locations = [];
        let notifications = [];
        let documents = [];
        let selectedImages = [];
        let currentPeriodStart = null;
        let currentPeriodEnd = null;
        let timesheetView = 'date';
        let weeklyAvailability = {};
        let participantDefaultLocations = new Map();
        let careHomeLocations = new Set();
        let isSubmittingLeave = false;
        
window.shifts = window.shifts || [];
window.participants = window.participants || [];
window.locations = window.locations || [];
window.staff = window.staff || [];
window.dutyTypes = window.dutyTypes || [];
        window.AppState = {
    staff: {
        current: null,
        original: null,
        all: []
    },
    shifts: {
        my: [],
        all: []
    },
    ui: {
        currentSection: 'dashboard',
        timesheetView: 'date',
        periodOffset: 0
    },
    cache: {
        participants: [],
        dutyTypes: [],
        locations: [],
        transfers: {
            incoming: [],
            outgoing: []
        }
    }
};

// Create currentStaff as a property that syncs with AppState
Object.defineProperty(window, 'currentStaff', {
    get() { 
        return AppState.staff.current; 
    },
    set(value) { 
        AppState.staff.current = value;
        console.log('Staff updated:', value?.first_name, value?.last_name);
    },
    configurable: true
});

        function getTestDate() {
    const date = new Date();
    date.setDate(date.getDate() + DATE_OFFSET_DAYS);
    return date;
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('Initializing application...');
        
        // Phase 1: Create DOM elements
        createStaffSelector();
        if (typeof addButtonStyles === 'function') {
            addButtonStyles();
        }
        
        // Phase 2: Initialize app
        await initializeApp();
        await ensureStaffLoaded();
        
        // Phase 3: Setup all event listeners
        setupAllEventListeners();
        
        // Phase 4: Post-init tasks (with delay)
        setTimeout(async () => {
            if (AppState.staff.current) {
                await addStaffSelector();
                const selector = document.getElementById('staffSelector');
                if (selector) {
                    selector.style.display = 'block';
                }
            }
        }, 2000);
        
        // Phase 5: Initialize features
        window.currentPeriodOffset = 0;
        if (typeof setCurrentPayPeriod === 'function') {
            setCurrentPayPeriod();
        }
        
        console.log('Application ready');
        
    } catch (error) {
        console.error('Initialization failed:', error);
        showToast('Failed to start application', 'error');
    }
});

async function initializeApp() {
    try {
        console.log('Initializing team app...');
        
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error || !session) {
            console.error('Authentication error:', error);
            window.location.href = 'index.html';
            return;
        }

        currentUser = session.user;
        console.log('User authenticated:', currentUser.email);
        console.log('Auth User ID:', currentUser.id);
        
        // Try multiple methods to find staff record
        let staffData = null;
        
        // Method 1: Try by user_id (fastest - already linked)
        let result = await supabaseClient
            .from('staff')
            .select('*')
            .eq('user_id', currentUser.id)
            .maybeSingle();
        
        staffData = result.data;
        
        if (staffData) {
            console.log('✅ Staff found by user_id - already linked');
        }
        
        // Method 2: Try by email match (auto-link if needed)
        if (!staffData) {
            console.log('🔍 No staff found by user_id, searching by email...');
            result = await supabaseClient
                .from('staff')
                .select('*')
                .eq('email', currentUser.email)
                .maybeSingle();
            
            staffData = result.data;
            
            if (staffData) {
                console.log('📧 Staff found by email match');
                
                // AUTO-LINK: If found by email but no user_id, create the link
                if (!staffData.user_id) {
                    console.log('🔗 Creating link between staff and auth user...');
                    
                    const { data: updatedStaff, error: updateError } = await supabaseClient
                        .from('staff')
                        .update({ user_id: currentUser.id })
                        .eq('id', staffData.id)
                        .select()
                        .single();
                    
                    if (updateError) {
                        console.error('❌ Failed to link staff record:', updateError);
                        showToast('Warning: Could not link your account. Contact admin.', 'warning');
                    } else {
                        staffData = updatedStaff;
                        console.log('✅ Staff record auto-linked successfully!');
                        console.log('   Staff ID:', staffData.id);
                        console.log('   Now linked to Auth ID:', staffData.user_id);
                        showToast('Account linked successfully', 'success');
                    }
                } else {
                    console.log('✅ Staff already has user_id, updating to current auth user');
                    // Update to current auth user (in case auth account was recreated)
                    const { data: updatedStaff } = await supabaseClient
                        .from('staff')
                        .update({ user_id: currentUser.id })
                        .eq('id', staffData.id)
                        .select()
                        .single();
                    
                    if (updatedStaff) {
                        staffData = updatedStaff;
                    }
                }
            }
        }
        
        // Method 3: For testing - allow manual override
        if (!staffData && window.location.hostname === 'localhost') {
            console.warn('⚠️ No staff found, checking for test override...');
            // You could load a default test staff here
        }
        
        // If still no staff record found
        if (!staffData) {
            console.error('❌ No staff record found for this user');
            console.error('   Auth Email:', currentUser.email);
            console.error('   Auth ID:', currentUser.id);
            
            showToast('No staff record found. Please contact administrator.', 'error');
            
            // Show helpful error with current user info
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: Arial;">
                    <h2>Staff Account Not Found</h2>
                    <p>No staff record found for: <strong>${currentUser.email}</strong></p>
                    <p style="color: #666; margin-top: 20px;">Please contact your administrator to:</p>
                    <ol style="text-align: left; display: inline-block; color: #666;">
                        <li>Create a staff record for your email address</li>
                        <li>Or update your staff record email to match your login email</li>
                    </ol>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 20px;">
                        <p style="font-size: 12px; color: #999; margin: 5px;">Debug Info:</p>
                        <p style="font-size: 11px; color: #999; margin: 5px;">Auth User ID: ${currentUser.id}</p>
                        <p style="font-size: 11px; color: #999; margin: 5px;">Email: ${currentUser.email}</p>
                    </div>
                    <button onclick="logout()" style="margin-top: 20px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
                </div>
            `;
            return;
        }
        
        // Success - Set the staff data
        AppState.staff.current = staffData;
        currentStaff = staffData;
        window.currentStaff = staffData; // Ensure global access
        
        console.log('✅ Staff record loaded:', staffData.first_name, staffData.last_name);
        console.log('   Staff ID:', staffData.id);
        console.log('   Linked to Auth ID:', staffData.user_id);
        
        // Update UI with staff name
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = `${staffData.first_name} ${staffData.last_name}`;
        }
        
        
        // ============================================
        // LOAD ALL REFERENCE DATA (CRITICAL FOR ENRICHREQUESTDATA)
        // ============================================
        console.log('Loading reference data...');
        
        try {
            // Load all reference data in parallel for better performance
            const [participantsResult, staffResult, locationsResult, dutyTypesResult] = await Promise.all([
                supabaseClient.from('participants').select('*').eq('is_active', true).order('first_name'),
                supabaseClient.from('staff').select('*').eq('is_active', true).order('first_name'),
                supabaseClient.from('locations').select('*').eq('is_active', true).order('name'),  // Added is_active filter
                supabaseClient.from('duty_types').select('id, name').order('name')  // FIXED: Removed pay_multiplier
            ]);
            
            // Check for errors
            if (participantsResult.error) console.error('Error loading participants:', participantsResult.error);
            if (staffResult.error) console.error('Error loading staff:', staffResult.error);
            if (locationsResult.error) console.error('Error loading locations:', locationsResult.error);
            if (dutyTypesResult.error) console.error('Error loading duty types:', dutyTypesResult.error);
            
            // Populate global arrays (needed for enrichRequestData and other functions)
            participants = participantsResult.data || [];
            staff = staffResult.data || [];
            locations = locationsResult.data || [];
            dutyTypes = dutyTypesResult.data || [];
            
            // Ensure global window access for compatibility
            window.participants = participants;
            window.staff = staff;
            window.locations = locations;
            window.dutyTypes = dutyTypes;
            
            // Also update AppState cache if it exists
            if (window.AppState && window.AppState.cache) {
                AppState.cache.participants = participants;
                AppState.cache.dutyTypes = dutyTypes;
                AppState.cache.locations = locations;
            }
            
            console.log('Reference data loaded:', {
                participants: participants.length,
                staff: staff.length,
                locations: locations.length,
                dutyTypes: dutyTypes.length,
                careHomes: locations.filter(l => l.is_care_home).length
            });
            
            // NEW: Build participant-location mapping for care homes
            await initializeParticipantLocationMapping();
            
        } catch (refError) {
            console.error('Error loading reference data:', refError);
            showToast('Warning: Some reference data failed to load', 'warning');
        }
        
        
        function setupLeaveFormListener() {
    const leaveForm = document.getElementById('leaveForm');
    const submitBtn = document.getElementById('submitLeaveBtn');
    
    if (leaveForm) {
        // Remove any existing listeners first
        leaveForm.removeEventListener('submit', handleLeaveSubmit);
        // Add new listener
        leaveForm.addEventListener('submit', handleLeaveSubmit);
    }
    
    if (submitBtn) {
        // Remove any existing onclick
        submitBtn.onclick = null;
        // Use a flag to prevent multiple submissions
        submitBtn.onclick = function(e) {
            e.preventDefault();
            if (!this.disabled) {
                submitLeaveWithProtection();
            }
        };
    }
}


        // ============================================
        // LOAD STAFF'S SHIFTS (FIXED: No pay_multiplier)
        // ============================================
        console.log('Loading staff shifts...');
        
        try {
            const { data: myShiftsData, error: shiftsError } = await supabaseClient
                .from('shifts')
                .select(`
                    *,
                    participants:participant_id(first_name, last_name, address),
                    locations:location_id(id, name, address, is_care_home),
                    duty_types:duty_type_id(name)
                `)  // FIXED: Removed pay_multiplier from duty_types
                .eq('staff_id', staffData.id)
                .is('deleted_at', null)
                .order('date', { ascending: false })
                .limit(100); // Limit for performance
            
            if (shiftsError) {
                console.error('Error loading shifts:', shiftsError);
                myShifts = [];
                shifts = [];
            } else {
                myShifts = myShiftsData || [];
                shifts = myShiftsData || []; // Populate both arrays
                
                // Ensure global access
                window.myShifts = myShifts;
                window.shifts = shifts;
                
                // Update AppState if exists
                if (window.AppState && window.AppState.shifts) {
                    AppState.shifts.my = myShifts;
                    AppState.shifts.all = shifts;
                }
                
                console.log('Shifts loaded:', myShifts.length);
            }
            
        } catch (shiftsError) {
            console.error('Error loading shifts:', shiftsError);
            showToast('Warning: Could not load shifts', 'warning');
        }
        
        // ============================================
        // NEW: Load Participants with Care Home Mapping
        // ============================================
        await loadParticipantsWithCareHomes();
        
        // ============================================
        // INITIALIZE UI COMPONENTS
        // ============================================
        
        // Set greeting
        if (typeof setGreeting === 'function') {
            setGreeting();
        }
        
        // Initialize pay period
        if (typeof setCurrentPayPeriod === 'function') {
            setCurrentPayPeriod();
        }
        
        // Show default section
        if (typeof showSection === 'function') {
            showSection('dashboard');
        } else {
            // Fallback: show dashboard
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection) {
                dashboardSection.style.display = 'block';
            }
        }
        
        // NEW: Setup participant select event listeners
        setupParticipantSelectListeners();
        
        // ============================================
        // LOAD ADDITIONAL FEATURES (NON-BLOCKING)
        // ============================================
        
        // Load these in background, don't wait
        setTimeout(async () => {
            try {
                // Load transfers
                if (typeof loadTransfers === 'function') {
                    console.log('Loading transfers...');
                    await loadTransfers();
                }
                
                // Load notifications
                if (typeof loadNotifications === 'function') {
                    console.log('Loading notifications...');
                    await loadNotifications();
                }
                
                // Load documents
                if (typeof loadDocuments === 'function') {
                    console.log('Loading documents...');
                    await loadDocuments();
                }
                
                // Load availability
                if (typeof loadAvailability === 'function') {
                    console.log('Loading availability...');
                    await loadAvailability();
                }
                
                // Update dashboard metrics
                if (typeof updateDashboard === 'function') {
                    updateDashboard();
                }
                
                // Render schedule
                if (typeof renderSchedule === 'function') {
                    renderSchedule();
                }
                
                // Check for incoming transfers count
                if (typeof updateTransferBadge === 'function') {
                    updateTransferBadge();
                }
                
            } catch (featureError) {
                console.error('Error loading additional features:', featureError);
                // Non-critical, don't show error to user
            }
        }, 100);
        
        // ============================================
        // SETUP EVENT LISTENERS
        // ============================================
        
        // Setup all event listeners if function exists
        if (typeof setupAllEventListeners === 'function') {
            setupAllEventListeners();
        }
        
        // Populate modal dropdowns
        if (typeof populateModalDropdowns === 'function') {
            populateModalDropdowns();
        }
        
        // ============================================
        // FINAL SUCCESS MESSAGE
        // ============================================
        
        console.log('✅ Application initialized successfully');
        console.log('   Current Staff:', currentStaff.first_name, currentStaff.last_name);
        console.log('   Global Arrays:', {
            participants: participants.length,
            staff: staff.length,
            locations: locations.length,
            dutyTypes: dutyTypes.length,
            shifts: shifts.length,
            careHomes: locations.filter(l => l.is_care_home).map(l => l.name)
        });
        
        // Show success message (optional)
        // showToast('Welcome back, ' + staffData.first_name + '!', 'success');
        
    } catch (error) {
        console.error('❌ Fatal error in initializeApp:', error);
        showToast('Failed to initialize app: ' + error.message, 'error');
        
        // Show error UI
        const errorContainer = document.getElementById('errorContainer');
        if (errorContainer) {
            errorContainer.innerHTML = `
                <div style="padding: 20px; background: #f8d7da; color: #721c24; border-radius: 5px;">
                    <h3>Initialization Error</h3>
                    <p>${error.message}</p>
                    <button onclick="location.reload()" style="margin-top: 10px; padding: 5px 15px;">Retry</button>
                </div>
            `;
            errorContainer.style.display = 'block';
        }
    }
}

async function initializeParticipantLocationMapping() {
    // Build a map of participant addresses to identify care home residents
    const participantLocationMap = new Map();
    
    participants.forEach(p => {
        if (p.address) {
            const addressLower = p.address.toLowerCase();
            
            // Check if this participant is in Saunders Care Home
            if (addressLower.includes('saunders')) {
                const saundersLocation = locations.find(loc => 
                    loc.name.toLowerCase().includes('saunders') || 
                    (loc.address && loc.address.toLowerCase().includes('saunders'))
                );
                
                if (saundersLocation) {
                    participantLocationMap.set(p.id, saundersLocation.id);
                }
            } 
            // Check for other care homes
            else {
                const matchingLocation = locations.find(loc => {
                    if (!loc.address || !loc.is_care_home) return false;
                    const locAddressLower = loc.address.toLowerCase();
                    const participantAddressParts = addressLower.split(',')[0].trim();
                    return locAddressLower.includes(participantAddressParts);
                });
                
                if (matchingLocation) {
                    participantLocationMap.set(p.id, matchingLocation.id);
                }
            }
        }
    });
    
    // Store the map globally for use in shift creation
    window.participantDefaultLocations = participantLocationMap;
    
    console.log('Participant location mapping created:', {
        totalParticipants: participants.length,
        mappedToCareHomes: participantLocationMap.size
    });
}

async function loadParticipantsWithCareHomes() {
    // Populate participant dropdowns with care home indicators
    const selects = ['shiftParticipant', 'noteParticipant'];
    
    selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            select.innerHTML = '<option value="">Select Client</option>';
            
            // Group participants by care home
            const careHomeParticipants = [];
            const homeParticipants = [];
            
            participants.forEach(p => {
                const locationId = window.participantDefaultLocations?.get(p.id);
                const location = locationId ? locations.find(l => l.id === locationId) : null;
                
                if (location && location.is_care_home) {
                    careHomeParticipants.push({
                        participant: p,
                        careHomeName: location.name
                    });
                } else {
                    homeParticipants.push(p);
                }
            });
            
            // Add care home participants with labels
            if (careHomeParticipants.length > 0) {
                select.innerHTML += '<optgroup label="Care Home Residents">';
                careHomeParticipants.forEach(item => {
                    select.innerHTML += `<option value="${item.participant.id}" data-location-id="${window.participantDefaultLocations.get(item.participant.id) || ''}">${item.participant.first_name} ${item.participant.last_name} (${item.careHomeName})</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
            
            // Add home participants
            if (homeParticipants.length > 0) {
                select.innerHTML += '<optgroup label="Home Clients">';
                homeParticipants.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
        }
    });
}

function setupParticipantSelectListeners() {
    // For shift creation modal
    const shiftParticipant = document.getElementById('shiftParticipant');
    if (shiftParticipant) {
        shiftParticipant.addEventListener('change', function() {
            onParticipantSelect(this.value, 'shiftLocation');
        });
    }
    
    // For note creation modal
    const noteParticipant = document.getElementById('noteParticipant');
    if (noteParticipant) {
        noteParticipant.addEventListener('change', function() {
            // Notes don't have location, but we could use this for context
            console.log('Participant selected for note');
        });
    }
}

function onParticipantSelect(participantId, locationSelectId) {
    const locationSelect = document.getElementById(locationSelectId || 'shiftLocation');
    if (!locationSelect || !participantId) return;
    
    // Check if we have a default location for this participant
    if (window.participantDefaultLocations && window.participantDefaultLocations.has(participantId)) {
        const defaultLocationId = window.participantDefaultLocations.get(participantId);
        locationSelect.value = defaultLocationId;
        console.log('Auto-selected care home location for participant');
        return;
    }
    
    // Otherwise, try to find "Client Home" as default
    const clientHomeLocation = locations?.find(l => 
        l.name.toLowerCase().includes('client home') || 
        l.id === '00000000-0000-0000-0000-000000000001'  // Special ID for Client Home
    );
    
    if (clientHomeLocation) {
        locationSelect.value = clientHomeLocation.id;
        console.log('Auto-selected Client Home as default');
    }
}

async function loadDutyTypes() {
    try {
        const { data: dutyTypesData } = await supabaseClient
            .from('duty_types')
            .select('id, name')  // Only select fields that exist
            .order('name');
        
        dutyTypes = dutyTypesData || [];
        window.dutyTypes = dutyTypes;
        
        console.log('Duty types loaded:', dutyTypes.length);
        return dutyTypes;
        
    } catch (error) {
        console.error('Error loading duty types:', error);
        dutyTypes = [];
        return [];
    }
}

async function loadReferenceData() {
    try {
        console.log('Loading reference data for team...');
        
        // Load all reference data in parallel
        const [participantsData, staffData, locationsData, dutyTypesData] = await Promise.all([
            supabaseClient.from('participants').select('*').eq('is_active', true).order('first_name'),
            supabaseClient.from('staff').select('*').eq('is_active', true).order('first_name'),
            supabaseClient.from('locations').select('*').order('name'),
            supabaseClient.from('duty_types').select('*').order('name')
        ]);
        
        // Populate global arrays
        participants = participantsData.data || [];
        staff = staffData.data || [];
        locations = locationsData.data || [];
        dutyTypes = dutyTypesData.data || [];
        
        // Also update window references
        window.participants = participants;
        window.staff = staff;
        window.locations = locations;
        window.dutyTypes = dutyTypes;
        
        console.log('Reference data loaded:', {
            participants: participants.length,
            staff: staff.length,
            locations: locations.length,
            dutyTypes: dutyTypes.length
        });
        
        return true;
        
    } catch (error) {
        console.error('Error loading reference data:', error);
        showToast('Failed to load reference data', 'error');
        return false;
    }
}

function createSearchableDropdown(selectId, options = {}) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'searchable-dropdown-wrapper';
    wrapper.style.position = 'relative';
    
    // Create search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control searchable-input';
    searchInput.placeholder = options.placeholder || 'Type to search...';
    searchInput.style.cssText = `
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    `;
    
    // Create dropdown list
    const dropdownList = document.createElement('div');
    dropdownList.className = 'searchable-dropdown-list';
    dropdownList.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        display: none;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    
    // Store selected value
    let selectedValue = select.value;
    let selectedText = '';
    
    // Get options from original select
    const originalOptions = Array.from(select.options).map(opt => ({
        value: opt.value,
        text: opt.textContent,
        data: opt.dataset
    }));
    
    // Function to update dropdown list
    function updateDropdownList(searchTerm = '') {
        dropdownList.innerHTML = '';
        
        const filtered = originalOptions.filter(opt => 
            opt.text.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        if (filtered.length === 0) {
            dropdownList.innerHTML = '<div style="padding: 8px; color: #999;">No results found</div>';
            return;
        }
        
        filtered.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                transition: background 0.2s;
            `;
            item.textContent = opt.text;
            item.dataset.value = opt.value;
            
            // Copy any data attributes
            Object.keys(opt.data || {}).forEach(key => {
                item.dataset[key] = opt.data[key];
            });
            
            item.onmouseover = () => item.style.background = '#f0f0f0';
            item.onmouseout = () => item.style.background = 'white';
            
            item.onclick = () => {
                selectedValue = opt.value;
                selectedText = opt.text;
                searchInput.value = opt.text;
                select.value = opt.value;
                
                // Trigger change event on original select
                const event = new Event('change', { bubbles: true });
                select.dispatchEvent(event);
                
                dropdownList.style.display = 'none';
            };
            
            dropdownList.appendChild(item);
        });
    }
    
    // Event handlers
    searchInput.onfocus = () => {
        updateDropdownList('');
        dropdownList.style.display = 'block';
    };
    
    searchInput.oninput = (e) => {
        updateDropdownList(e.target.value);
        dropdownList.style.display = 'block';
    };
    
    // Click outside to close
    document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // Set initial value
    if (select.value) {
        const initial = originalOptions.find(opt => opt.value === select.value);
        if (initial) {
            searchInput.value = initial.text;
            selectedText = initial.text;
        }
    }
    
    // Replace select with wrapper
    select.style.display = 'none';
    wrapper.appendChild(searchInput);
    wrapper.appendChild(dropdownList);
    select.parentNode.insertBefore(wrapper, select.nextSibling);
    
    // Store reference for later updates
    select._searchableDropdown = {
        update: () => updateDropdownList(''),
        setValue: (value) => {
            const opt = originalOptions.find(o => o.value === value);
            if (opt) {
                selectedValue = opt.value;
                selectedText = opt.text;
                searchInput.value = opt.text;
                select.value = opt.value;
            }
        },
        getValue: () => selectedValue
    };
    
    return select._searchableDropdown;
}

async function populateEditModalDropdowns(shift = null) {
    try {
        // Ensure reference data is loaded
        if (!participants.length || !staff.length) {
            await loadReferenceData();
        }
        
        // Staff dropdown
        const staffSelect = document.getElementById('editStaff');
        if (staffSelect) {
            staffSelect.innerHTML = '<option value="">Select Staff</option>';
            staff.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.first_name} ${s.last_name}`;
                if (shift && shift.staff_id === s.id) {
                    option.selected = true;
                }
                staffSelect.appendChild(option);
            });
            
            // Make it searchable
            createSearchableDropdown('editStaff', {
                placeholder: 'Type to search staff...'
            });
        }
        
        // Participant dropdown
        const participantSelect = document.getElementById('editParticipant');
        if (participantSelect) {
            participantSelect.innerHTML = '<option value="">Select Client</option>';
            participants.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.first_name} ${p.last_name}`;
                if (shift && shift.participant_id === p.id) {
                    option.selected = true;
                }
                participantSelect.appendChild(option);
            });
            
            // Make it searchable
            createSearchableDropdown('editParticipant', {
                placeholder: 'Type to search client...'
            });
        }
        
        // Location dropdown
        const locationSelect = document.getElementById('editLocation');
        if (locationSelect) {
            locationSelect.innerHTML = '<option value="">Select Location</option>';
            
            // Add default Client Home option
            const clientHome = document.createElement('option');
            clientHome.value = '00000000-0000-0000-0000-000000000001';
            clientHome.textContent = 'Client Home';
            locationSelect.appendChild(clientHome);
            
            locations.forEach(l => {
                if (l.id !== '00000000-0000-0000-0000-000000000001') {
                    const option = document.createElement('option');
                    option.value = l.id;
                    option.textContent = l.name;
                    if (shift && shift.location_id === l.id) {
                        option.selected = true;
                    }
                    locationSelect.appendChild(option);
                }
            });
            
            // Make it searchable
            createSearchableDropdown('editLocation', {
                placeholder: 'Type to search location...'
            });
        }
        
        // Duty Type dropdown
        const dutyTypeSelect = document.getElementById('editDutyType');
        if (dutyTypeSelect) {
            dutyTypeSelect.innerHTML = '<option value="">Select Duty Type</option>';
            dutyTypes.forEach(dt => {
                const option = document.createElement('option');
                option.value = dt.id;
                option.textContent = dt.name;
                if (shift && shift.duty_type_id === dt.id) {
                    option.selected = true;
                }
                dutyTypeSelect.appendChild(option);
            });
            
            // Make it searchable
            createSearchableDropdown('editDutyType', {
                placeholder: 'Type to search duty type...'
            });
        }
        
    } catch (error) {
        console.error('Error populating modal dropdowns:', error);
        showToast('Failed to load dropdown options', 'error');
    }
}

async function refreshAfterChange() {
    try {
        // Reload shifts if function exists
        if (typeof loadShifts === 'function') {
            await loadShifts();
        }
        
        // Reload my shifts for team.html
        if (typeof loadMyShifts === 'function') {
            await loadMyShifts();
        }
        
        // Refresh current view
        if (typeof renderCurrentView === 'function') {
            renderCurrentView();
        }
        
        // Update dashboard if on team.html
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
        
    } catch (error) {
        console.error('Error refreshing after change:', error);
    }
}

async function loadMyShifts() {
    try {
        const { data: myShiftsData, error: shiftsError } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants:participant_id(first_name, last_name, address),
                locations:location_id(id, name, address, is_care_home),
                duty_types:duty_type_id(name)
            `)  // REMOVED pay_multiplier - doesn't exist
            .eq('staff_id', currentStaff.id)
            .is('deleted_at', null)
            .order('date', { ascending: false })
            .limit(100);
        
        if (shiftsError) {
            console.error('Error loading shifts:', shiftsError);
            throw shiftsError;
        }
        
        myShifts = myShiftsData || [];
        window.myShifts = myShifts;
        
        console.log('Shifts loaded:', myShifts.length);
        return myShifts;
        
    } catch (error) {
        console.error('Error in loadMyShifts:', error);
        showToast('Failed to load shifts', 'error');
        return [];
    }
}



// 2. CONSOLIDATED Event Listener Setup
function setupAllEventListeners() {
    console.log('Setting up all event listeners...');
    
    // Quick Actions
    setupQuickActions();
    
    // Navigation
    setupNavigation();
    
    // Forms
    setupForms();
    
    // Modals
    setupModals();
    
    // Edit/Save Buttons
    setupEditButtons();
    
    // File Uploads
    setupFileUploads();
    
    // Keyboard Shortcuts
    setupKeyboardShortcuts();
    
    // Timesheet Controls
    setupTimesheetControls();
    
    console.log('Event listeners ready');
}

window.showNotification = function(message, type) {
    showToast(message, type);
};

function setupQuickActions() {
    const quickActions = {
        'quickAddShift': showAddShiftModal,
        'quickTransfer': showTransferModal,
        'quickAdjustment': showAdjustmentModal,
        'quickLeave': showLeaveModal
    };
    
    Object.entries(quickActions).forEach(([id, handler]) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.onclick = handler;
        }
    });
}

function setupNavigation() {
    // Tab navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const view = this.getAttribute('data-view');
            if (view) switchView(view);
        });
    });
    
    // View selector
    const viewSelector = document.getElementById('viewSelector');
    if (viewSelector) {
        viewSelector.addEventListener('change', (e) => switchView(e.target.value));
    }
}

function setupForms() {
    const forms = {
        'noteForm': submitNote,
        'addShiftForm': submitShift,
        'transferForm': submitTransfer,
        'adjustmentForm': submitAdjustment,
        'leaveForm': submitLeave
    };
    
    Object.entries(forms).forEach(([id, handler]) => {
        const form = document.getElementById(id);
        if (form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                handler();
            });
        }
    });
}

async function loadAvailableTransfers() {
    try {
        const container = document.getElementById('availableList');
        if (!container) return;
        
        // Load shifts that are unassigned or available for pickup
        const { data: availableShifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                locations(name, address),
                duty_types(name)
            `)
            .is('staff_id', null) // Unassigned shifts
            .gte('date', getTestDate().toISOString().split('T')[0])
            .order('date', { ascending: true })
            .limit(20);
        
        if (error) {
            console.error('Error loading available shifts:', error);
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">Failed to load available shifts</div>';
            return;
        }
        
        if (!availableShifts || availableShifts.length === 0) {
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No available shifts at this time</div>';
            return;
        }
        
        // Render available shifts
        container.innerHTML = availableShifts.map(shift => `
            <div class="transfer-item">
                <div class="transfer-header">
                    <div>
                        <div class="transfer-date">${formatDateLong(shift.date)}</div>
                        <div class="transfer-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="claimShift('${shift.id}')">
                        Claim Shift
                    </button>
                </div>
                <div class="transfer-from">
                    Client: ${shift.participants ? 
                        `${shift.participants.first_name} ${shift.participants.last_name}` : 
                        'Unassigned'}
                </div>
                <div class="transfer-from">
                    Location: ${shift.locations?.name || 'Client Home'}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error in loadAvailableTransfers:', error);
        showToast('Failed to load available shifts', 'error');
    }
}

function filterSchedule() {
    const filterValue = document.getElementById('participantFilter').value;
    // Re-render schedule with filter
    loadSchedule(); // This should use the filter value
}
// Also add the claim shift function
async function claimShift(shiftId) {
    try {
        if (!confirm('Do you want to claim this shift?')) return;
        
        const { error } = await supabaseClient
            .from('shifts')
            .update({ staff_id: AppState.staff.current.id })
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showToast('Shift claimed successfully', 'success');
        loadAvailableTransfers(); // Reload the list
        
    } catch (error) {
        console.error('Error claiming shift:', error);
        showToast('Failed to claim shift', 'error');
    }
}

function setupModals() {
    // Close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) closeModal(modal.id);
        });
    });
    
    // Cancel buttons
    document.querySelectorAll('.modal .btn-secondary').forEach(btn => {
        if (btn.textContent.includes('Cancel')) {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) closeModal(modal.id);
            });
        }
    });
    
    // Click outside to close
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target.id);
        }
    });
}

function setupEditButtons() {
    const editButtons = {
        'editPersonalBtn': editPersonalInfo,
        'editContactBtn': editContactInfo,
        'editBankingBtn': editBankingInfo,
        'savePersonalBtn': savePersonalInfo,
        'saveContactBtn': saveContactInfo,
        'saveBankingBtn': saveBankingInfo,
        'saveAvailabilityBtn': saveAvailability
    };
    
    Object.entries(editButtons).forEach(([id, handler]) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.addEventListener('click', handler);
        }
    });
}

function setupFileUploads() {
    const bannerUpload = document.getElementById('bannerUpload');
    if (bannerUpload) {
        bannerUpload.addEventListener('change', handleBannerUpload);
    }
    
    const docUploadBtn = document.getElementById('uploadDocBtn');
    if (docUploadBtn) {
        docUploadBtn.addEventListener('click', uploadDocument);
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Alt+T: Toggle staff selector
        if (e.altKey && e.key === 't') {
            e.preventDefault();
            const selector = document.getElementById('staffSelector');
            if (selector) {
                selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Escape: Close active modal
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                closeModal(activeModal.id);
            }
        }
    });
}

function setupTimesheetControls() {
    // Period navigation
    document.querySelectorAll('.period-nav').forEach(button => {
        button.removeAttribute('onclick'); // Clean inline handlers
        
        if (button.textContent.includes('◀') || button.textContent.includes('Previous')) {
            button.addEventListener('click', () => {
                console.log('Navigate previous period');
                window.changePeriod(-1);
            });
        } else if (button.textContent.includes('▶') || button.textContent.includes('Next')) {
            button.addEventListener('click', () => {
                console.log('Navigate next period');
                window.changePeriod(1);
            });
        }
    });
    
    // View toggle buttons
    document.querySelectorAll('.view-toggle .toggle-btn').forEach(button => {
        button.removeAttribute('onclick'); // Clean inline handlers
        
        if (button.textContent.includes('Date')) {
            button.addEventListener('click', () => window.toggleTimesheetView('date'));
        } else if (button.textContent.includes('Client')) {
            button.addEventListener('click', () => window.toggleTimesheetView('participant'));
        }
    });
}

window.switchToStaff = async function(staffId) {
    try {
        if (!staffId) {
            showToast('No staff ID provided', 'error');
            return;
        }

        console.log('Switching to staff ID:', staffId);

        // Get the selected staff member
        const { data: selectedStaff, error } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('id', staffId)
            .single();
        
        if (error) {
            console.error('Error fetching staff:', error);
            showToast('Failed to load staff data', 'error');
            return;
        }
        
        console.log('Selected staff:', selectedStaff);
        
        // Store original if first time
        if (!AppState.staff.original) {
            AppState.staff.original = AppState.staff.current;
            console.log('Stored original staff:', AppState.staff.original);
        }
        
        // Switch to new staff member - CRITICAL: maintain currentStaff
        AppState.staff.current = selectedStaff;
        
        // Update the UI
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = `${selectedStaff.first_name} ${selectedStaff.last_name}`;
        }
        
        // Add/Update test mode banner
        let testBanner = document.getElementById('testModeBanner');
        if (!testBanner) {
            testBanner = document.createElement('div');
            testBanner.id = 'testModeBanner';
            testBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #ff9800;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            `;
            document.body.prepend(testBanner);
        }
        
        testBanner.innerHTML = `
            🧪 TEST MODE: Viewing as ${selectedStaff.first_name} ${selectedStaff.last_name}
            <button onclick="exitTestMode()" style="
                margin-left: 20px;
                padding: 5px 15px;
                background: white;
                color: #333;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: normal;
            ">Exit Test Mode</button>
        `;
        
        // Reload all their data
        const loaders = [];
        if (typeof loadDashboard === 'function') loaders.push(loadDashboard());
        if (typeof loadSchedule === 'function') loaders.push(loadSchedule());
        if (typeof loadTransfers === 'function') loaders.push(loadTransfers());
        if (typeof loadProfile === 'function') loaders.push(loadProfile());
        
        await Promise.all(loaders).catch(err => console.error('Error loading data:', err));
        
        // Stay on current section, don't force dashboard
        // The current section should reload with new staff data
        
        showToast(`Now viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name}`, 'success');
        
    } catch (error) {
        console.error('Error switching staff:', error);
        showToast('Failed to switch staff view', 'error');
    }
}

// Exit test mode function
window.exitTestMode = function() {
    if (AppState.staff.original) {
        console.log('Exiting test mode, restoring:', AppState.staff.original);
        
        AppState.staff.current = AppState.staff.original;
        delete AppState.staff.original;
        
        // Update UI
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = 
                `${AppState.staff.current.first_name} ${AppState.staff.current.last_name}`;
        }
        
        // Remove test banner
        const banner = document.getElementById('testModeBanner');
        if (banner) banner.remove();
        
        // Reload original data
        const loaders = [];
        if (typeof loadDashboard === 'function') loaders.push(loadDashboard());
        if (typeof loadSchedule === 'function') loaders.push(loadSchedule());
        if (typeof loadTransfers === 'function') loaders.push(loadTransfers());
        if (typeof loadProfile === 'function') loaders.push(loadProfile());
        
        Promise.all(loaders).catch(err => console.error('Error reloading data:', err));
        
        showToast('Returned to your account', 'success');
    }
}

window.debugStaffState = function() {
    console.log('=== Staff State Debug ===');
    console.log('currentStaff:', AppState.staff.current);
    console.log('originalStaff:', AppState.staff.original);
    console.log('currentUser:', window.currentUser);
    console.log('Test Mode Active:', !!AppState.staff.original);
    console.log('========================');
    return {
        currentStaff: AppState.staff.current,
        originalStaff: AppState.staff.original,
        testMode: !!AppState.staff.original
    };
}



async function checkTableStructure() {
    // Run this once to determine actual column types
    const { data, error } = await supabaseClient
        .from('shift_adjustment_requests')
        .select('*')
        .limit(1);
    
    console.log('shift_adjustment_requests sample:', data);
    
    // Based on the error, shift_id appears to be UUID in this table
    // So we need to handle it differently
}



function ensureRequiredElements() {
    const requiredElements = [
        { id: 'userName', description: 'User name display' },
        { id: 'scheduleGrid', description: 'Schedule container' },
        { id: 'recentNotifications', description: 'Notifications container' },
        { id: 'incomingCount', description: 'Transfer count badge' },
        { id: 'periodDates', description: 'Pay period display' },
        { id: 'dashboardContent', description: 'Main dashboard content' }
    ];
    
    const missingElements = [];
    
    requiredElements.forEach(element => {
        const domElement = document.getElementById(element.id);
        if (!domElement) {
            console.warn(`Required element missing: ${element.id} (${element.description})`);
            missingElements.push(element.id);
        }
    });
    
    if (missingElements.length > 0) {
        console.warn('Missing DOM elements:', missingElements);
        // Could create placeholder elements here if needed
        missingElements.forEach(id => {
            if (id === 'scheduleGrid' || id === 'recentNotifications') {
                // Create essential containers if missing
                const container = document.createElement('div');
                container.id = id;
                container.innerHTML = '<div class="loading">Loading...</div>';
                
                // Try to find a good parent to attach to
                const parent = document.querySelector('.content-section') || document.body;
                parent.appendChild(container);
                
                console.log(`Created placeholder element: ${id}`);
            }
        });
    }
    
    return missingElements.length === 0;
}

        
        async function loadDashboard() {
    try {
        // Load current/upcoming shift
        await loadCurrentShift();
        
        // Load pending requests
        await loadPendingRequests();
        
        // Load notifications
        await loadNotifications();
        
        // Load upcoming leave
        const today = getTestDate().toISOString().split('T')[0];
        const thirtyDaysFromNow = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        const { data: myLeave } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('available', false)
            .gte('date', today)
            .lte('date', thirtyDaysFromNow)
            .order('date');

        if (myLeave && myLeave.length > 0) {
            // Group consecutive dates
            const leaveGroups = [];
            let currentGroup = null;
            
            myLeave.forEach(leave => {
                const leaveDate = new Date(leave.date);
                
                if (!currentGroup || 
                    leave.reason !== currentGroup.reason ||
                    (leaveDate - new Date(currentGroup.endDate)) > 24 * 60 * 60 * 1000) {
                    currentGroup = {
                        startDate: leave.date,
                        endDate: leave.date,
                        reason: leave.reason,
                        days: 1
                    };
                    leaveGroups.push(currentGroup);
                } else {
                    currentGroup.endDate = leave.date;
                    currentGroup.days++;
                }
            });

            // Create leave section HTML
            const leaveHTML = `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>📅 Upcoming Leave</h3>
                        <span class="badge">${leaveGroups.length}</span>
                    </div>
                    <div class="leave-list">
                        ${leaveGroups.map(group => {
                            const start = formatDateShort(group.startDate);
                            const end = formatDateShort(group.endDate);
                            const dateRange = group.startDate === group.endDate ? 
                                start : 
                                `${start} - ${end} (${group.days} days)`;
                            
                            const daysUntil = Math.floor((new Date(group.startDate) - getTestDate()) / (24 * 60 * 60 * 1000));
                            const urgency = daysUntil <= 7 ? 'urgent' : daysUntil <= 14 ? 'soon' : '';
                            
                            return `
                                <div class="leave-item ${urgency}">
                                    <div class="leave-info">
                                        <div class="leave-dates">${dateRange}</div>
                                        <div class="leave-type">${group.reason}</div>
                                    </div>
                                    ${daysUntil > 0 ? 
                                        `<div class="leave-countdown">In ${daysUntil} day${daysUntil !== 1 ? 's' : ''}</div>` : 
                                        daysUntil === 0 ? 
                                        '<div class="leave-countdown today">Today</div>' : 
                                        '<div class="leave-countdown ongoing">Ongoing</div>'
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Insert leave section into dashboard
            const dashboardContent = document.getElementById('dashboardContent');
            if (dashboardContent) {
                // Find or create leave container
                let leaveContainer = dashboardContent.querySelector('.leave-container');
                if (!leaveContainer) {
                    leaveContainer = document.createElement('div');
                    leaveContainer.className = 'leave-container';
                    
                    // Insert after pending requests or at the end
                    const pendingRequests = dashboardContent.querySelector('.dashboard-card');
                    if (pendingRequests) {
                        pendingRequests.insertAdjacentElement('afterend', leaveContainer);
                    } else {
                        dashboardContent.appendChild(leaveContainer);
                    }
                }
                leaveContainer.innerHTML = leaveHTML;
            }
        }
        
        // Update summary stats
        const { data: stats } = await supabaseClient
            .from('shifts')
            .select('id, status')
            .eq('staff_id', currentStaff.id)
            .gte('date', today);
        
        const upcomingShifts = stats?.filter(s => s.status === 'confirmed').length || 0;
        const pendingShifts = stats?.filter(s => s.status === 'pending').length || 0;
        
        // Update dashboard badges
        const homeBadge = document.getElementById('homeBadge');
        if (homeBadge) {
            const totalAlerts = pendingShifts + (myLeave?.length || 0);
            homeBadge.textContent = totalAlerts;
            homeBadge.classList.toggle('hidden', totalAlerts === 0);
        }
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Failed to load dashboard completely', 'error');
    }
}


        async function loadCurrentShift() {
            const now = getTestDate();
            const today = now.toISOString().split('T')[0];
            
            // Get today's and tomorrow's shifts
            const { data: upcomingShifts } = await supabaseClient
                .from('shifts')
                .select(`
                    *,
                    participant:participant_id(first_name, last_name),
                    location:location_id(name, address),
                    duty_type:duty_type_id(name)
                `)
                .eq('staff_id', currentStaff.id)
                .gte('date', today)
                .lte('date', new Date(now.getTime() + 24*60*60*1000).toISOString().split('T')[0])
                .is('deleted_at', null)
                .order('date')
                .order('start_time')
                .limit(1);

            const container = document.getElementById('currentShift');
            
            if (!upcomingShifts || upcomingShifts.length === 0) {
                container.innerHTML = `
                    <div class="shift-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="shift-card-header">
                            <div class="shift-time">No shifts today</div>
                            <div class="shift-participant">Enjoy your day off!</div>
                        </div>
                    </div>
                `;
                return;
            }

            const shift = upcomingShifts[0];
            const isToday = shift.date === today;
            const participantName = shift.participant ? 
                `${shift.participant.first_name} ${shift.participant.last_name}` :
                (shift.location?.name || 'Unassigned');
            
            container.innerHTML = `
            <div class="shift-card" data-shift-id="${shift.id}" onclick="toggleShiftDetails(this)">
                    <div class="shift-card-header">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                        <div class="shift-participant">${participantName}</div>
                        <div class="shift-location">
                            📍 ${shift.location?.name || shift.location?.address || 'Client Home'}
                        </div>
                        <div class="shift-status">${isToday ? 'TODAY' : 'TOMORROW'}</div>
                    </div>
                    <div class="shift-expand-icon">▼</div>
                    <div class="shift-details">
                        <div class="handover-section">
                            <div class="handover-title">Handover Notes</div>
                            <div id="handoverNotes">Loading...</div>
                            <button class="modal-btn primary mt-2" onclick="addNoteToShift(${shift.id})">Add Note</button>
                        </div>
                    </div>
                </div>
            `;

            // Load handover notes
            loadHandoverNotes(shift.id);
        }

function switchTransferTab(tab) {
    // Update tab styling
    document.querySelectorAll('.transfer-tab').forEach(t => {
        t.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Hide all transfer content divs
    document.getElementById('incomingTransfers').classList.remove('active');
    document.getElementById('outgoingTransfers').classList.remove('active');
    document.getElementById('availableTransfers').classList.remove('active');
    
    // Show selected tab content
    if (tab === 'incoming') {
        document.getElementById('incomingTransfers').classList.add('active');
    } else if (tab === 'outgoing') {
        document.getElementById('outgoingTransfers').classList.add('active');
    } else if (tab === 'available') {
        document.getElementById('availableTransfers').classList.add('active');
        // Load available shifts if needed
        if (typeof loadAvailableTransfers === 'function') {
            loadAvailableTransfers();
        }
    }
}
async function enrichRequestData(requests, type) {
    if (!requests || requests.length === 0) return [];
    
    return await Promise.all(requests.map(async req => {
        const shift = shifts.find(s => s.id === req.shift_id);
        const participant = shift ? participants.find(p => p.id === shift.participant_id) : null;
        const location = shift ? locations.find(l => l.id === shift.location_id) : null;
        
        const baseEnrichment = {
            ...req,
            shift: shift ? {
                ...shift,
                participant,
                location,
                participantName: participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    (location?.name || 'Unassigned')
            } : null
        };
        
        if (type === 'transfer') {
            return {
                ...baseEnrichment,
                fromStaff: staff.find(s => s.id === req.from_staff_id),
                toStaff: req.to_staff_id ? staff.find(s => s.id === req.to_staff_id) : null
            };
        } else if (type === 'adjustment') {
            return {
                ...baseEnrichment,
                staff: staff.find(s => s.id === req.staff_id)
            };
        }
        
        return baseEnrichment;
    }));
}

async function requestTransfer(shiftId) {
    // shiftId is INTEGER - correct for the database
    const { data, error } = await supabaseClient
        .from('transfer_requests')
        .insert({
            shift_id: parseInt(shiftId), // Ensure it's an integer
            from_staff_id: currentStaff.id,
            to_staff_id: null, // Optional target staff
            status: 'pending',
            reason: 'Personal reason',
            created_at: new Date().toISOString()
        });
    
    if (error) {
        console.error('Transfer request error:', error);
        showToast('Failed to request transfer', 'error');
    } else {
        showToast('Transfer request submitted', 'success');
    }
}

async function submitTransfer() {
    try {
        const shiftId = document.getElementById('transferShiftSelect').value;
        const toStaffId = document.getElementById('transferToStaff').value;
        const reason = document.getElementById('transferReason').value;

        if (!shiftId || !reason) {
            showToast('Please select a shift and provide a reason', 'error');
            return;
        }

        // Only create transfer_request record
        const { data, error } = await supabaseClient
            .from('transfer_requests')
            .insert({
                shift_id: parseInt(shiftId), // Ensure INTEGER type
                from_staff_id: currentStaff.id,
                to_staff_id: toStaffId || null, // Optional target staff
                status: 'pending',
                reason: reason,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .select()
            .single();

        if (error) throw error;

        showToast('Transfer request submitted successfully', 'success');
        closeModal('transferShiftModal');
        document.getElementById('transferForm').reset();
        
        // Refresh UI if needed
        if (typeof loadTransfers === 'function') {
            await loadTransfers();
        }
        
    } catch (error) {
        console.error('Error submitting transfer:', error);
        showToast('Failed to submit transfer request: ' + error.message, 'error');
    }
}


function toggleTimeFields() {
    const dutyType = document.getElementById('shiftDutyType');
    const timeFields = document.getElementById('timeFields');
    
    if (dutyType && timeFields) {
        // Hide time fields for sleepover shifts
        if (dutyType.options[dutyType.selectedIndex]?.text?.toLowerCase().includes('sleepover')) {
            timeFields.style.display = 'none';
        } else {
            timeFields.style.display = 'block';
        }
    }
}



function showDocumentUploadModal() {
    // Open the document upload modal
    const modal = document.getElementById('documentUploadModal');
    if (modal) {
        modal.classList.add('active');
    } else {
        // If modal doesn't exist, show simple file input
        document.getElementById('documentFile')?.click();
    }
}

async function loadAvailableTransfers() {
    try {
        // Load shifts available for transfer (from other staff)
        const { data: available } = await supabaseClient
            .from('transfer_requests')
            .select(`
                *,
                shift:shift_id(date, start_time, end_time, participant:participant_id(first_name, last_name)),
                from_staff:from_staff_id(first_name, last_name)
            `)
            .is('to_staff_id', null) // Open to anyone
            .eq('status', 'pending')
            .neq('from_staff_id', currentStaff.id) // Not your own
            .order('created_at', { ascending: false });

        const container = document.getElementById('availableList');
        if (!container) return;
        
        if (!available || available.length === 0) {
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No available shifts to pick up</div>';
            return;
        }

        container.innerHTML = available.map(transfer => `
            <div class="transfer-item">
                <div class="transfer-header">
                    <div>
                        <div class="transfer-date">${formatDateLong(transfer.shift.date)}</div>
                        <div class="transfer-time">
                            ${transfer.shift.start_time ? formatTime(transfer.shift.start_time) : 'Sleepover'} - 
                            ${transfer.shift.end_time ? formatTime(transfer.shift.end_time) : ''}
                        </div>
                    </div>
                </div>
                <div class="transfer-from">
                    From: ${transfer.from_staff.first_name} ${transfer.from_staff.last_name}
                </div>
                ${transfer.reason ? `<div class="transfer-reason">"${transfer.reason}"</div>` : ''}
                <div class="transfer-actions">
                    <button class="transfer-btn accept" onclick="acceptTransfer('${transfer.id}')">Pick Up Shift</button>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading available transfers:', error);
    }
}

function toggleShiftDetails(element) {
    try {
        // Find the shift card element
        const shiftCard = element.closest('.shift-card') || element;
        
        // Toggle expanded class
        shiftCard.classList.toggle('expanded');
        
        // Get shift ID from the element - multiple ways to find it
        let shiftId = null;
        
        // Method 1: Look for data attribute
        shiftId = shiftCard.dataset.shiftId || shiftCard.getAttribute('data-shift-id');
        
        // Method 2: Look in onclick attribute for shift ID
        if (!shiftId) {
            const addNoteBtn = shiftCard.querySelector('[onclick*="addNoteToShift"]');
            if (addNoteBtn) {
                const onclickText = addNoteBtn.getAttribute('onclick');
                const match = onclickText.match(/addNoteToShift\((\d+)\)/);
                if (match) {
                    shiftId = match[1];
                }
            }
        }
        
        if (!shiftId) {
            console.error('No shift ID found in element:', shiftCard);
            return;
        }
        
        console.log('Toggle shift details for ID:', shiftId);
        
        // If expanding, load handover notes
        if (shiftCard.classList.contains('expanded')) {
            loadHandoverNotes(parseInt(shiftId));
        }
        
    } catch (error) {
        console.error('Error in toggleShiftDetails:', error);
    }
}



async function loadPendingRequests() {
    try {
        // Get shifts with pending transfers or adjustments
        const { data: pendingShifts } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name)
            `)
            .or(`transfer_to_staff.eq.${currentStaff.id},and(staff_id.eq.${currentStaff.id},adjustment_status.eq.pending)`)
            .eq('transfer_status', 'pending')
            .is('deleted_at', null)
            .order('date', { ascending: true });

        const container = document.getElementById('pendingRequestsList');
        if (!container) return;

        if (!pendingShifts || pendingShifts.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No pending requests</p>';
            return;
        }

        container.innerHTML = pendingShifts.map(shift => {
            const isTransfer = shift.transfer_to_staff === currentStaff.id;
            const isAdjustment = shift.adjustment_status === 'pending' && shift.staff_id === currentStaff.id;
            
            return `
                <div class="request-item">
                    <div class="request-badge">${isTransfer ? 'Transfer' : 'Adjustment'}</div>
                    <div class="request-date">${formatDateShort(shift.date)}</div>
                    <div class="request-details">
                        ${shift.participants ? 
                            `${shift.participants.first_name} ${shift.participants.last_name}` : 
                            'Unknown Client'}
                        ${shift.start_time ? ` - ${formatTime12Hour(shift.start_time)}` : ' - Sleepover'}
                    </div>
                    ${isTransfer ? 
                        `<button onclick="approveTransfer(${shift.id})" class="btn btn-sm btn-primary">Accept</button>` :
                        `<div class="text-muted">Pending Admin Approval</div>`
                    }
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading pending requests:', error);
    }
}
        


function showLoading() {
    document.body.classList.add('loading');
}
function hideLoading() {
    document.body.classList.remove('loading');
}

        

        async function loadNotifications() {
    try {
        // Ensure we have currentUser from auth
        if (!currentUser) {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;
            currentUser = user;
        }

        // Use correct column names: user_id and read_at
        const { data: notifications, error } = await supabaseClient
            .from('notifications')
            .select('*')
            .eq('user_id', currentUser.id)
            .is('read_at', null)
            .order('created_at', { ascending: false })
            .limit(5);

        if (error) {
            console.error('Error loading notifications:', error);
            return;
        }

        const container = document.getElementById('recentNotifications');
        if (!container) return;

        if (!notifications || notifications.length === 0) {
            container.innerHTML = '<div class="notification-item">No new notifications</div>';
            return;
        }

        container.innerHTML = notifications.map(note => `
            <div class="notification-item ${note.notification_type || ''}" onclick="markAsRead('${note.id}')">
                <div class="notification-content">${note.message || 'New notification'}</div>
                <div class="notification-time">${formatDateTime(note.created_at)}</div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error in loadNotifications:', error);
        const container = document.getElementById('recentNotifications');
        if (container) {
            container.innerHTML = '<div class="notification-item">Unable to load notifications</div>';
        }
    }
}



        function loadShiftTimes() {
    try {
        const select = document.getElementById('adjustmentShift');
        const selected = select.options[select.selectedIndex];
        
        if (selected && selected.dataset.start) {
            document.getElementById('adjustmentStartTime').value = selected.dataset.start || '';
            document.getElementById('adjustmentEndTime').value = selected.dataset.end || '';
        } else {
            document.getElementById('adjustmentStartTime').value = '';
            document.getElementById('adjustmentEndTime').value = '';
        }
    } catch (error) {
        console.error('Error loading shift times:', error);
        // Don't show toast for this minor error
    }
}

async function loadTransfers() {
    try {
        if (!currentStaff || !currentStaff.id) {
            console.error('No current staff data');
            return;
        }

        // Incoming transfers - shifts being transferred TO this staff
        const { data: incoming } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                staff!shifts_staff_id_fkey(first_name, last_name),
                transfer_staff:staff!shifts_transfer_requested_by_fkey(first_name, last_name)
            `)
            .eq('transfer_to_staff', currentStaff.id)
            .eq('transfer_status', 'pending')
            .order('date', { ascending: true });

        // Outgoing transfers - shifts this staff is transferring away
        const { data: outgoing } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                to_staff:staff!shifts_transfer_to_staff_fkey(first_name, last_name)
            `)
            .eq('staff_id', currentStaff.id)
            .eq('transfer_requested_by', currentStaff.id)
            .in('transfer_status', ['pending', 'approved', 'denied'])
            .order('date', { ascending: true });

        // Available transfers - open transfers from others
        const { data: available } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                staff!shifts_staff_id_fkey(first_name, last_name)
            `)
            .eq('transfer_status', 'pending')
            .is('transfer_to_staff', null)  // Open to anyone
            .neq('staff_id', currentStaff.id)  // Not your own shifts
            .order('date', { ascending: true });

        // Update badge
        const badge = document.getElementById('transferBadge');
        if (badge) {
            badge.textContent = incoming?.length || 0;
            badge.classList.toggle('hidden', !incoming?.length);
        }

        // Render based on active tab
        const activeTab = document.querySelector('.transfer-tab.active');
        if (activeTab?.textContent.includes('Incoming')) {
            renderIncomingTransfers(incoming || []);
        } else if (activeTab?.textContent.includes('My Requests')) {
            renderOutgoingTransfers(outgoing || []);
        } else {
            renderAvailableTransfers(available || []);
        }

    } catch (error) {
        console.error('Error loading transfers:', error);
        showToast('Failed to load transfers', 'error');
    }
}

async function acceptTransfer(transferId) {
    try {
        // Get the transfer request details
        const { data: transfer, error: fetchError } = await supabaseClient
            .from('transfer_requests')
            .select('*, shifts!shift_id(*)')
            .eq('id', transferId)
            .single();

        if (fetchError || !transfer) {
            throw new Error('Transfer request not found');
        }

        // Check for shift conflicts
        const { data: conflicts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('date', transfer.shifts.date)
            .is('deleted_at', null);

        if (conflicts && conflicts.length > 0) {
            // Check for time overlaps
            const hasOverlap = conflicts.some(existing => {
                if (!existing.start_time || !existing.end_time || 
                    !transfer.shifts.start_time || !transfer.shifts.end_time) {
                    return false; // Can't determine overlap without times
                }
                
                const newStart = new Date(`2000-01-01T${transfer.shifts.start_time}`);
                const newEnd = new Date(`2000-01-01T${transfer.shifts.end_time}`);
                const existStart = new Date(`2000-01-01T${existing.start_time}`);
                const existEnd = new Date(`2000-01-01T${existing.end_time}`);
                
                return (newStart < existEnd && newEnd > existStart);
            });
            
            if (hasOverlap) {
                if (!confirm('You have conflicting shifts on this date. Continue anyway?')) {
                    return;
                }
            }
        }

        // Update the shift with new staff member
        const { error: shiftError } = await supabaseClient
            .from('shifts')
            .update({
                staff_id: currentStaff.id,
                updated_at: new Date().toISOString()
            })
            .eq('id', transfer.shift_id);

        if (shiftError) throw shiftError;

        // Update transfer request status
        const { error: transferError } = await supabaseClient
            .from('transfer_requests')
            .update({
                to_staff_id: currentStaff.id,
                status: 'approved',
                updated_at: new Date().toISOString()
            })
            .eq('id', transferId);

        if (transferError) throw transferError;

        showToast('Shift accepted successfully', 'success');
        
        // Refresh the transfers view
        if (typeof loadAvailableTransfers === 'function') {
            await loadAvailableTransfers();
        }
        if (typeof loadTransfers === 'function') {
            await loadTransfers();
        }

    } catch (error) {
        console.error('Error accepting transfer:', error);
        showToast('Failed to accept transfer: ' + error.message, 'error');
    }
}



// Add this function to handle both modal ID variations
function getTransferModalId() {
    // Check which ID exists in your HTML
    if (document.getElementById('transferShiftModal')) {
        return 'transferShiftModal';
    } else if (document.getElementById('transferModal')) {
        return 'transferModal';
    }
    return null;
}

async function fetchNotes(shiftId) {
    if (!shiftId) return [];
    
    try {
        const { data: notes, error } = await supabaseClient
            .from('shift_notes')
            .select(`
                *,
                staff:staff_id(first_name, last_name)
            `)
            .eq('shift_id', parseInt(shiftId))  // Simple integer
            .is('deleted_at', null)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error fetching notes:', error);
            return [];
        }
        
        return notes || [];
        
    } catch (error) {
        console.error('Error in fetchNotes:', error);
        return [];
    }
}

    
async function logout() {
    try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        window.location.href = 'index.html';
    } catch (error) {
        console.error('Logout error:', error);
        showToast('Failed to logout', 'error');
    }
}


        async function loadTransferableShifts() {
    try {
        const tomorrow = getTestDate();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const { data: shifts } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participant:participants(first_name, last_name),
                duty_type:duty_type_id(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', tomorrow.toISOString().split('T')[0])
            .is('deleted_at', null)
            .eq('status', 'confirmed')
            .order('date')
            .order('start_time');

        const select = document.getElementById('transferShiftSelect');
        select.innerHTML = '<option value="">Select a shift</option>';
        
        if (shifts && shifts.length > 0) {
            shifts.forEach(shift => {
                const participant = shift.participant;
                const label = `${formatDateShort(shift.date)} ${shift.start_time || 'Sleepover'} - ${participant?.first_name} ${participant?.last_name}`;
                select.innerHTML += `<option value="${shift.id}" data-start="${shift.start_time}" data-end="${shift.end_time}">${label}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading transferable shifts:', error);
        showToast('Failed to load transferable shifts', 'error');
    }
}
        async function loadAdjustableShifts() {
            const yesterday = getTestDate();
            yesterday.setDate(yesterday.getDate() - 1);
            
            const { data: shifts } = await supabaseClient
                .from('shifts')
                .select(`
                    *,
                    participant:participants(first_name, last_name)
                `)
                .eq('staff_id', currentStaff.id)
                .gte('date', yesterday.toISOString().split('T')[0])
                .is('deleted_at', null)
                .in('status', ['confirmed', 'completed'])
                .order('date', { ascending: false })
                .order('start_time', { ascending: false })
                .limit(20);

            const select = document.getElementById('adjustmentShift');
            select.innerHTML = '<option value="">Select a shift</option>';
            
            if (shifts && shifts.length > 0) {
                shifts.forEach(shift => {
                    const participant = shift.participant;
                    const label = `${formatDateShort(shift.date)} ${shift.start_time || 'Sleepover'} - ${participant?.first_name} ${participant?.last_name}`;
                    select.innerHTML += `<option value="${shift.id}" data-start="${shift.start_time}" data-end="${shift.end_time}">${label}</option>`;
                });
            }
        }

        async function loadParticipants() {
    try {
        const { data: participantsData } = await supabaseClient
            .from('participants')
            .select('*')
            .eq('is_active', true)
            .order('first_name');
        
        participants = participantsData || [];
        window.participants = participants; // Ensure global access
        
        // Build participant-location mapping
        await buildParticipantLocationMapping();
        
        // Populate all participant dropdowns
        populateParticipantDropdowns();
        
        console.log('Participants loaded:', participants.length);
        console.log('Care home mappings:', participantDefaultLocations.size);
        
    } catch (error) {
        console.error('Error loading participants:', error);
        showToast('Failed to load participants', 'error');
    }
}

async function buildParticipantLocationMapping() {
    // Clear existing mappings
    participantDefaultLocations.clear();
    careHomeLocations.clear();
    
    // First, identify all care home locations
    if (locations && locations.length > 0) {
        locations.forEach(loc => {
            if (loc.is_care_home) {
                careHomeLocations.add(loc.id);
            }
        });
    }
    
    // Map participants to their default locations based on address
    participants.forEach(p => {
        if (!p.address) return;
        
        const addressLower = p.address.toLowerCase();
        
        // Check for Saunders Care Home
        if (addressLower.includes('saunders')) {
            const saundersLocation = locations.find(loc => 
                loc.name.toLowerCase().includes('saunders') || 
                (loc.address && loc.address.toLowerCase().includes('saunders'))
            );
            
            if (saundersLocation) {
                participantDefaultLocations.set(p.id, saundersLocation.id);
                console.log(`Mapped ${p.first_name} ${p.last_name} to Saunders Care Home`);
            }
        } 
        // Check for other care homes by matching addresses
        else {
            const matchingCareHome = locations.find(loc => {
                if (!loc.is_care_home || !loc.address) return false;
                
                // Extract street/building name from both addresses
                const locStreet = loc.address.toLowerCase().split(',')[0].trim();
                const participantStreet = addressLower.split(',')[0].trim();
                
                // Check if participant's address contains the care home's street
                return participantStreet.includes(locStreet) || locStreet.includes(participantStreet);
            });
            
            if (matchingCareHome) {
                participantDefaultLocations.set(p.id, matchingCareHome.id);
                console.log(`Mapped ${p.first_name} ${p.last_name} to ${matchingCareHome.name}`);
            }
        }
    });
    
    console.log(`Mapped ${participantDefaultLocations.size} participants to care homes`);
}

function populateParticipantDropdowns() {
    const dropdownIds = ['shiftParticipant', 'noteParticipant', 'transferParticipant'];
    
    dropdownIds.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;
        
        // Clear existing options
        select.innerHTML = '<option value="">Select Client</option>';
        
        // Separate participants into care home and home clients
        const careHomeParticipants = [];
        const homeParticipants = [];
        
        participants.forEach(p => {
            if (participantDefaultLocations.has(p.id)) {
                const locationId = participantDefaultLocations.get(p.id);
                const location = locations.find(l => l.id === locationId);
                careHomeParticipants.push({
                    participant: p,
                    locationName: location ? location.name : 'Care Home'
                });
            } else {
                homeParticipants.push(p);
            }
        });
        
        // Add care home residents with location labels
        if (careHomeParticipants.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = 'Care Home Residents';
            
            careHomeParticipants.forEach(item => {
                const option = document.createElement('option');
                option.value = item.participant.id;
                option.textContent = `${item.participant.first_name} ${item.participant.last_name} (${item.locationName})`;
                option.dataset.locationId = participantDefaultLocations.get(item.participant.id);
                optgroup.appendChild(option);
            });
            
            select.appendChild(optgroup);
        }
        
        // Add home clients
        if (homeParticipants.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = 'Home Clients';
            
            homeParticipants.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.first_name} ${p.last_name}`;
                optgroup.appendChild(option);
            });
            
            select.appendChild(optgroup);
        }
    });
}

function onParticipantSelect(participantSelectId, locationSelectId) {
    const participantSelect = document.getElementById(participantSelectId);
    const locationSelect = document.getElementById(locationSelectId);
    
    if (!participantSelect || !locationSelect) return;
    
    const participantId = participantSelect.value;
    
    if (!participantId) {
        locationSelect.value = '';
        return;
    }
    
    // Check if this participant has a default care home location
    if (participantDefaultLocations.has(participantId)) {
        const defaultLocationId = participantDefaultLocations.get(participantId);
        locationSelect.value = defaultLocationId;
        
        const location = locations.find(l => l.id === defaultLocationId);
        console.log(`Auto-selected location: ${location ? location.name : 'Unknown'}`);
        
        // Show a brief notification
        const locationName = location ? location.name : 'care home';
        showToast(`Auto-selected ${locationName}`, 'info');
    } else {
        // Try to select "Client Home" as default for non-care home residents
        const clientHome = locations.find(l => 
            l.name.toLowerCase().includes('client home') || 
            l.id === '00000000-0000-0000-0000-000000000001'
        );
        
        if (clientHome) {
            locationSelect.value = clientHome.id;
            console.log('Auto-selected Client Home as default');
        }
    }
}

function setupParticipantLocationListeners() {
    // For shift creation modal
    const shiftParticipant = document.getElementById('shiftParticipant');
    if (shiftParticipant) {
        shiftParticipant.addEventListener('change', function() {
            onParticipantSelect('shiftParticipant', 'shiftLocation');
        });
    }
    
    // For transfer request modal (if it has location)
    const transferParticipant = document.getElementById('transferParticipant');
    if (transferParticipant) {
        transferParticipant.addEventListener('change', function() {
            // Transfers might not have location, but we can still track it
            console.log('Participant selected for transfer');
        });
    }
    
    // For any edit modals
    const editParticipant = document.getElementById('editShiftParticipant');
    if (editParticipant) {
        editParticipant.addEventListener('change', function() {
            onParticipantSelect('editShiftParticipant', 'editShiftLocation');
        });
    }
}



async function initializeParticipantLocations() {
    // Make sure locations are loaded first
    if (!locations || locations.length === 0) {
        await loadLocations();
    }
    
    // Then load participants with location mapping
    await loadParticipants();
    
    // Setup event listeners
    setupParticipantSelects();
}



async function saveWeeklyAvailability() {
    try {
        const startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        
        // Get next 4 weeks of dates
        const records = [];
        for (let week = 0; week < 4; week++) {
            for (let day = 0; day < 7; day++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + (week * 7) + day);
                
                // Check if this day is marked as available
                const checkbox = document.querySelector(`input[data-day="${day}"][data-week="${week}"]`);
                if (checkbox && checkbox.checked) {
                    records.push({
                        staff_id: currentStaff.id,
                        date: date.toISOString().split('T')[0],
                        is_available: true,
                        start_time: '09:00:00',
                        end_time: '17:00:00',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                }
            }
        }
        
        if (records.length === 0) {
            showToast('Please select at least one available day', 'warning');
            return;
        }
        
        // Clear old availability for this period
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 28);
        
        await supabaseClient
            .from('staff_availability')
            .delete()
            .eq('staff_id', currentStaff.id)
            .gte('date', startDate.toISOString().split('T')[0])
            .lte('date', endDate.toISOString().split('T')[0]);
        
        // Insert new availability
        const { error } = await supabaseClient
            .from('staff_availability')
            .insert(records);
        
        if (error) throw error;
        
        showToast('Weekly availability saved successfully', 'success');
        
    } catch (error) {
        console.error('Error saving weekly availability:', error);
        showToast('Failed to save availability: ' + error.message, 'error');
    }
}


async function loadDocuments() {
    if (!currentStaff) {
        console.log('No current staff to load documents for');
        return;
    }
    
    try {
        const { data: documents, error } = await supabaseClient
            .from('documents')
            .select(`
                *,
                document_types:document_type_id(name, requires_expiry)
            `)
            .eq('entity_type', 'staff')
            .eq('entity_id', currentStaff.id)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error loading documents:', error);
            return;
        }
        
        displayDocuments(documents || []);
        
    } catch (error) {
        console.error('Error in loadDocuments:', error);
        showToast('Failed to load documents', 'error');
    }
}

function displayDocuments(documents) {
    const container = document.getElementById('documentsList');
    if (!container) return;
    
    if (!documents || documents.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-file-alt"></i>
                <p>No documents uploaded yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = documents.map(doc => {
        // Get the document type name from the joined data
        const typeName = doc.document_types?.name || 'Unknown Type';
        const requiresExpiry = doc.document_types?.requires_expiry || false;
        
        // Check if document is expired
        const isExpired = doc.expiry_date && new Date(doc.expiry_date) < new Date();
        const expiryClass = isExpired ? 'expired' : '';
        const expiryWarning = isExpired ? '<span class="badge danger">Expired</span>' : '';
        
        return `
            <div class="document-item ${expiryClass}">
                <div class="document-info">
                    <h4>${doc.title}</h4>
                    <p class="document-type">${typeName}</p>
                    ${doc.expiry_date ? `
                        <p class="expiry-date">
                            Expires: ${formatDate(doc.expiry_date)}
                            ${expiryWarning}
                        </p>
                    ` : ''}
                    ${doc.notes ? `<p class="notes">${doc.notes}</p>` : ''}
                    <p class="upload-date">Uploaded: ${formatDate(doc.created_at)}</p>
                </div>
                <div class="document-actions">
                    <a href="${doc.file_url}" target="_blank" class="btn btn-sm btn-primary">
                        <i class="fas fa-download"></i> View
                    </a>
                    <button onclick="deleteDocument('${doc.id}')" class="btn btn-sm btn-danger">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        `;
    }).join('');
}


        async function loadAvailability() {
            const { data: availability } = await supabaseClient
                .from('staff_weekly_availability')
                .select('*')
                .eq('staff_id', currentStaff.id);

            if (availability) {
                availability.forEach(slot => {
                    const key = `${slot.day_of_week}_${slot.time_slot}`;
                    weeklyAvailability[key] = slot.available;
                });
            }

            renderAvailability();
        }


        async function approveTransfer(shiftId) {
    try {
        if (!confirm('Accept this shift transfer?')) return;

        // Get the shift details
        const { data: shift } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('id', parseInt(shiftId))
            .single();

        if (!shift) {
            showToast('Shift not found', 'error');
            return;
        }

        // Check for conflicts before accepting
        const { data: conflicts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('date', shift.date)
            .is('deleted_at', null);

        if (conflicts && conflicts.length > 0) {
            if (!confirm(`You already have ${conflicts.length} shift(s) on this date. Continue anyway?`)) {
                return;
            }
        }

        // Approve the transfer by updating the shift
        const { error } = await supabaseClient
            .from('shifts')
            .update({
                staff_id: currentStaff.id,  // Take ownership
                transfer_status: 'completed',
                transfer_approved_by: currentStaff.id,
                updated_at: new Date().toISOString()
            })
            .eq('id', parseInt(shiftId));

        if (error) throw error;

        showToast('Transfer accepted successfully', 'success');
        loadTransfers();
        loadDashboard();

    } catch (error) {
        console.error('Error accepting transfer:', error);
        showToast('Failed to accept transfer', 'error');
    }
}

// Helper function to check if a duty type is a sleepover
async function checkIfSleepover(dutyTypeId) {
    if (!dutyTypeId) return false;
    
    const dutyType = dutyTypes.find(dt => dt.id === dutyTypeId);
    if (dutyType) {
        return dutyType.name?.toLowerCase().includes('sleepover');
    }
    
    // Fallback to database query if not in cache
    const { data } = await supabaseClient
        .from('duty_types')
        .select('name')
        .eq('id', dutyTypeId)
        .single();
    
    return data?.name?.toLowerCase().includes('sleepover') || false;
}

// Helper function to parse time string to minutes for comparison
function parseTime(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
}

// Helper function to calculate shift duration in hours
function calculateShiftDuration(startTime, endTime) {
    const start = parseTime(startTime);
    const end = parseTime(endTime);
    
    // Handle overnight shifts
    const duration = end > start ? end - start : (1440 - start) + end;
    return duration / 60;
}

async function displayShiftNotes(shiftId) {
    const container = document.getElementById('shiftNotesList');
    if (!container) return;
    
    const notes = await fetchNotes(shiftId);
    
    if (notes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-sticky-note"></i>
                <p>No notes for this shift</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = notes.map(note => `
        <div class="note-item">
            <div class="note-header">
                <span class="note-type badge">${note.note_type || 'General'}</span>
                <span class="note-author">${note.staff?.first_name || 'Unknown'} ${note.staff?.last_name || ''}</span>
            </div>
            <div class="note-content">${escapeHtml(note.note)}</div>
            <div class="note-footer">
                <span class="note-time">${formatDateTime(note.created_at)}</span>
                ${note.staff_id === currentStaff.id ? `
                    <button onclick="deleteNote('${note.id}')" class="btn-delete-note">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
}


async function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('shift_notes')
            .update({ deleted_at: new Date().toISOString() })
            .eq('id', noteId)
            .eq('staff_id', currentStaff.id);
        
        if (error) throw error;
        
        showToast('Note deleted successfully', 'success');
        
        if (typeof refreshCurrentView === 'function') {
            refreshCurrentView();
        }
        
    } catch (error) {
        console.error('Error deleting note:', error);
        showToast('Failed to delete note', 'error');
    }
}



function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function checkShiftHasNotes(shiftId) {
    const { count, error } = await supabaseClient
        .from('shift_notes')
        .select('*', { count: 'exact', head: true })
        .eq('shift_id', parseInt(shiftId))  // Simple integer
        .is('deleted_at', null);
    
    return count > 0;
}

async function submitShift() {
    try {
        const date = document.getElementById('shiftDate').value;
        const participantId = document.getElementById('shiftParticipant').value;
        const dutyTypeId = document.getElementById('shiftDutyType').value;
        const notes = document.getElementById('shiftNotes').value;
        
        // GET THE LOCATION VALUE - THIS WAS MISSING!
        const locationId = document.getElementById('shiftLocation')?.value;

        if (!date || !participantId || !dutyTypeId) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        // Check if sleepover
        const { data: dutyType } = await supabaseClient
            .from('duty_types')
            .select('name')
            .eq('id', dutyTypeId)
            .single();
        
        const isSleepover = dutyType?.name?.toLowerCase().includes('sleepover');
        
        // Get times only if NOT sleepover
        let startTime = null;
        let endTime = null;
        if (!isSleepover) {
            startTime = document.getElementById('shiftStartTime').value;
            endTime = document.getElementById('shiftEndTime').value;
            
            if (!startTime || !endTime) {
                showToast('Please enter start and end times', 'error');
                return;
            }
        }
        
        // If no location selected, try to set a default
        let finalLocationId = locationId;
        
        if (!finalLocationId) {
            // Check if this participant has a default location (care home)
            if (window.participantDefaultLocations && window.participantDefaultLocations.has(participantId)) {
                finalLocationId = window.participantDefaultLocations.get(participantId);
                console.log('Using participant\'s default care home location');
            } else {
                // Try to find "Client Home" as default
                const clientHome = locations?.find(l => 
                    l.name.toLowerCase().includes('client home') || 
                    l.id === '00000000-0000-0000-0000-000000000001'
                );
                
                if (clientHome) {
                    finalLocationId = clientHome.id;
                    console.log('Using Client Home as default location');
                } else if (locations && locations.length > 0) {
                    // Last resort: use first available location
                    finalLocationId = locations[0].id;
                    console.log('Using first available location as default');
                }
            }
        }
        
        // Validate we have a location
        if (!finalLocationId) {
            showToast('Location is required. Please select a location.', 'error');
            return;
        }

        // Create shift data with valid location_id
        const shiftData = {
            date: date,
            start_time: startTime,
            end_time: endTime,
            staff_id: currentStaff.id,
            participant_id: participantId,
            duty_type_id: dutyTypeId,
            location_id: finalLocationId,  // NOW PROPERLY SET!
            pay_override_id: dutyTypeId,  // Use duty type as default
            created_by: currentUser.id,
            status: 'pending',  // Awaiting approval
            notes: notes || null
        };

        console.log('Submitting shift with data:', shiftData);

        const { data, error } = await supabaseClient
            .from('shifts')
            .insert(shiftData)
            .select();

        if (error) throw error;

        showToast('Shift submitted for approval', 'success');
        closeModal('addShiftModal');
        
        // Clear form
        document.getElementById('shiftForm').reset();
        
        // Reload shifts to show the new one
        if (typeof loadMyShifts === 'function') {
            await loadMyShifts();
        }
        if (typeof renderSchedule === 'function') {
            renderSchedule();
        }

    } catch (error) {
        console.error('Error submitting shift:', error);
        showToast('Failed to submit shift: ' + error.message, 'error');
    }
}

function populateLocationDropdown() {
    const select = document.getElementById('shiftLocation');
    if (!select || !locations) return;
    
    select.innerHTML = '<option value="">Select Location</option>';
    
    // Group by care home status
    const careHomes = locations.filter(l => l.is_care_home);
    const otherLocations = locations.filter(l => !l.is_care_home);
    
    if (careHomes.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Care Homes';
        careHomes.forEach(l => {
            const option = document.createElement('option');
            option.value = l.id;
            option.textContent = l.name;
            optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
    }
    
    if (otherLocations.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Other Locations';
        otherLocations.forEach(l => {
            const option = document.createElement('option');
            option.value = l.id;
            option.textContent = l.name;
            optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
    }
}

function onDutyTypeChange() {
    const dutyTypeSelect = document.getElementById('shiftDutyType');
    const selectedOption = dutyTypeSelect.options[dutyTypeSelect.selectedIndex];
    const dutyTypeName = selectedOption?.text || '';
    
    const isSleepover = dutyTypeName.toLowerCase().includes('sleepover');
    
    const timeFieldsContainer = document.querySelector('.time-fields-group');
    const startTimeInput = document.getElementById('shiftStartTime');
    const endTimeInput = document.getElementById('shiftEndTime');
    
    if (isSleepover) {
        // Hide time fields for sleepover
        if (timeFieldsContainer) {
            timeFieldsContainer.style.display = 'none';
        }
        // Clear and disable time inputs
        if (startTimeInput) {
            startTimeInput.value = '';
            startTimeInput.required = false;
        }
        if (endTimeInput) {
            endTimeInput.value = '';
            endTimeInput.required = false;
        }
    } else {
        // Show time fields for regular shifts
        if (timeFieldsContainer) {
            timeFieldsContainer.style.display = 'block';
        }
        // Enable and require time inputs
        if (startTimeInput) {
            startTimeInput.required = true;
        }
        if (endTimeInput) {
            endTimeInput.required = true;
        }
    }
}



const ModalManager = {
    // Modal configurations
    modals: {
        addShift: {
            id: 'addShiftModal',
            onOpen: () => populateShiftModalDropdowns(),
            onClose: () => document.getElementById('addShiftForm')?.reset()
        },
        transfer: {
            id: 'transferModal',
            onOpen: () => loadTransferModalData(),
            onClose: () => document.getElementById('transferForm')?.reset()
        },
        adjustment: {
            id: 'adjustmentModal',
            onOpen: () => loadAdjustmentModalData(),
            onClose: () => document.getElementById('adjustmentForm')?.reset()
        },
        leave: {
            id: 'leaveModal',
            onOpen: null,
            onClose: () => document.getElementById('leaveForm')?.reset()
        }
    },
    
    // Current open modal
    currentModal: null,
    
    // Open modal by name
    show(modalName, data = null) {
        const config = this.modals[modalName];
        if (!config) {
            console.error(`Modal '${modalName}' not found`);
            return;
        }
        
        // Close any open modal first
        if (this.currentModal) {
            this.close();
        }
        
        const modalElement = document.getElementById(config.id);
        if (!modalElement) {
            console.error(`Modal element '${config.id}' not found`);
            return;
        }
        
        // Store current modal
        this.currentModal = {
            name: modalName,
            element: modalElement,
            config: config
        };
        
        // Show modal
        modalElement.classList.add('active');
        modalElement.style.display = 'flex';
        
        // Run onOpen callback if exists
        if (config.onOpen) {
            config.onOpen(data);
        }
        
        // Add escape key listener
        this.escapeHandler = (e) => {
            if (e.key === 'Escape') {
                this.close();
            }
        };
        document.addEventListener('keydown', this.escapeHandler);
    },
    
    // Close current modal
    close() {
        if (!this.currentModal) return;
        
        const { element, config } = this.currentModal;
        
        // Hide modal
        element.classList.remove('active');
        element.style.display = 'none';
        
        // Run onClose callback if exists
        if (config.onClose) {
            config.onClose();
        }
        
        // Remove escape handler
        if (this.escapeHandler) {
            document.removeEventListener('keydown', this.escapeHandler);
        }
        
        // Clear current modal
        this.currentModal = null;
    },
    
    // Check if a modal is open
    isOpen(modalName = null) {
        if (!modalName) {
            return this.currentModal !== null;
        }
        return this.currentModal?.name === modalName;
    },
    
    // Get current modal data
    getCurrent() {
        return this.currentModal;
    }
};

function showAddShiftModal() {
    const modal = document.getElementById('addShiftModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        populateShiftModalDropdowns();
        populateLocationDropdown();
        
        // Set default duty type to Active Shift after dropdowns are populated
        setTimeout(() => {
            const dutySelect = document.getElementById('shiftDutyType');
            if (dutySelect) {
                // Find and select "Active Shift"
                for (let i = 0; i < dutySelect.options.length; i++) {
                    if (dutySelect.options[i].text === 'Active Shift') {
                        dutySelect.selectedIndex = i;
                        onDutyTypeChange(); // Update time fields visibility
                        break;
                    }
                }
            }
        }, 100);
    }
}


function showTransferModal() {
    const modalId = getTransferModalId();
    if (modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'flex';
        modal.classList.add('active');
        loadTransferModalData();
    } else {
        console.error('Transfer modal not found');
    }
}

function showAdjustmentModal() {
    ModalManager.show('adjustment');
}

function showLeaveModal() {
    ModalManager.show('leave');
}


// ==========================================
// APPSTATE IMPLEMENTATION
// ==========================================

// Since you've already replaced window.* with AppState.*, here's the actual AppState object:

const AppState = {
    staff: {
        current: null,
        original: null,
        all: []
    },
    shifts: {
        my: [],
        filtered: [],
        all: []
    },
    ui: {
        currentSection: 'dashboard',
        timesheetView: 'date',
        periodOffset: 0,
        currentPeriod: null
    },
    cache: {
        participants: [],
        dutyTypes: [],
        locations: [],
        transfers: {
            incoming: [],
            outgoing: []
        }
    },
    
    // Helper methods
    reset() {
        this.staff.original = null;
        this.ui.periodOffset = 0;
        this.ui.timesheetView = 'date';
    },
    
    isInTestMode() {
        return this.staff.original !== null;
    },
    
    getCurrentStaff() {
        return this.staff.current;
    },
    
    setCurrentStaff(staff) {
        this.staff.current = staff;
    },
    
    switchToTestMode(testStaff) {
        if (!this.staff.original) {
            this.staff.original = this.staff.current;
        }
        this.staff.current = testStaff;
    },
    
    exitTestMode() {
        if (this.staff.original) {
            this.staff.current = this.staff.original;
            this.staff.original = null;
        }
    }
};

// Initialize currentStaff reference for backward compatibility
Object.defineProperty(window, 'currentStaff', {
    get() { return AppState.staff.current; },
    set(value) { AppState.staff.current = value; }
});


async function populateParticipantDropdown() {
    const select = document.getElementById('shiftParticipant');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Client</option>';
    
    // Check if participants array is populated
    if (!participants || participants.length === 0) {
        console.log('Participants array empty, loading...');
        await loadReferenceData();
    }
    
    if (participants.length === 0) {
        select.innerHTML += '<option value="">No clients available</option>';
        return;
    }
    
    participants.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.first_name} ${p.last_name}`;
        select.appendChild(option);
    });
}

async function populateDutyTypeDropdown() {
    const select = document.getElementById('shiftDutyType');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Type</option>';
    
    // Check if dutyTypes array is populated
    if (!dutyTypes || dutyTypes.length === 0) {
        console.log('Duty types array empty, loading...');
        await loadReferenceData();
    }
    
    if (dutyTypes.length === 0) {
        select.innerHTML += '<option value="">No duty types available</option>';
        return;
    }
    
    dutyTypes.forEach(dt => {
        const option = document.createElement('option');
        option.value = dt.id;
        option.textContent = dt.name;
        select.appendChild(option);
    });
}

async function populateTransferableShifts() {
    const select = document.getElementById('transferShiftSelect');
    if (!select) return;
    
    // Clear existing options
    select.innerHTML = '<option value="">Select a shift</option>';
    
    // Load shifts for current staff
    const { data: myShifts } = await supabaseClient
        .from('shifts')
        .select('*, participants(first_name, last_name)')
        .eq('staff_id', currentStaff.id)
        .gte('date', getTestDate().toISOString().split('T')[0])
        .order('date', { ascending: true });
    
    if (myShifts && myShifts.length > 0) {
        myShifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id; // This is already an INTEGER
            option.dataset.start = shift.start_time || '';
            option.dataset.end = shift.end_time || '';
            
            const clientName = shift.participants ? 
                `${shift.participants.first_name} ${shift.participants.last_name}` : 
                'Unknown Client';
            option.textContent = `${formatDateShort(shift.date)} - ${clientName} (${shift.start_time || 'Sleepover'})`;
            select.appendChild(option);
        });
    }
}


async function populateStaffDropdown() {
    const select = document.getElementById('transferToStaff');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select staff member (optional)</option>';
    
    // Check if staff array is populated
    if (!staff || staff.length === 0) {
        console.log('Staff array empty, loading...');
        await loadReferenceData();
    }
    
    // Filter out current staff
    const otherStaff = staff.filter(s => s.id !== currentStaff.id);
    
    if (otherStaff.length === 0) {
        select.innerHTML += '<option value="">No other staff available</option>';
        return;
    }
    
    otherStaff.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = `${s.first_name} ${s.last_name}`;
        select.appendChild(option);
    });
}

async function populateAdjustableShifts() {
    const select = document.getElementById('adjustmentShift');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select a shift</option>';
    
    const { data: myShifts } = await supabaseClient
        .from('shifts')
        .select('*, participants(first_name, last_name)')
        .eq('staff_id', currentStaff.id)
        .gte('date', getTestDate().toISOString().split('T')[0])
        .order('date', { ascending: true });
    
    if (myShifts && myShifts.length > 0) {
        myShifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id;  // Already INTEGER
            option.dataset.start = shift.start_time || '';
            option.dataset.end = shift.end_time || '';
            
            const clientName = shift.participants ? 
                `${shift.participants.first_name} ${shift.participants.last_name}` : 
                'Unknown Client';
            option.textContent = `${formatDateShort(shift.date)} - ${clientName} (${shift.start_time || 'Sleepover'})`;
            select.appendChild(option);
        });
    }
}

function ensureIntegerId(id) {
    if (typeof id === 'number') return id;
    const parsed = parseInt(id, 10);
    if (isNaN(parsed)) {
        throw new Error(`Invalid ID: ${id} cannot be converted to integer`);
    }
    return parsed;
}

async function submitAdjustment() {
    try {
        const shiftId = document.getElementById('adjustmentShift').value;
        const newStartTime = document.getElementById('adjustmentStartTime').value;
        const newEndTime = document.getElementById('adjustmentEndTime').value;
        const reason = document.getElementById('adjustmentReason').value;

        if (!shiftId || !reason) {
            showToast('Please select a shift and provide a reason', 'error');
            return;
        }

        // Validate times if provided
        if (newStartTime && newEndTime) {
            const start = new Date(`2000-01-01T${newStartTime}`);
            const end = new Date(`2000-01-01T${newEndTime}`);
            if (end <= start) {
                showToast('End time must be after start time', 'error');
                return;
            }
        }

        const { data, error } = await supabaseClient
            .from('shift_adjustment_requests')
            .insert({
                shift_id: parseInt(shiftId), // Ensure INTEGER type
                staff_id: currentStaff.id,
                requested_start_time: newStartTime || null, // Correct column name
                requested_end_time: newEndTime || null,     // Correct column name
                reason: reason,
                status: 'pending',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .select()
            .single();
            
        if (error) throw error;
        
        showToast('Time adjustment request sent successfully', 'success');
        closeModal('adjustmentModal');
        document.getElementById('adjustmentForm').reset();
        
    } catch (error) {
        console.error('Error submitting adjustment:', error);
        showToast('Failed to send adjustment request: ' + error.message, 'error');
    }
}


async function submitLeave() {
    // Prevent multiple simultaneous submissions
    if (isSubmittingLeave) {
        console.log('Leave submission already in progress, ignoring duplicate call');
        return;
    }
    
    isSubmittingLeave = true;
    
    try {
        const leaveType = document.getElementById('leaveType').value;
        const startDate = document.getElementById('leaveStartDate').value;
        const endDate = document.getElementById('leaveEndDate').value;
        const reason = document.getElementById('leaveReason').value;

        if (!leaveType || !startDate || !endDate) {
            showToast('Please fill all required fields', 'error');
            isSubmittingLeave = false;
            return;
        }

        // Validate dates
        if (new Date(endDate) < new Date(startDate)) {
            showToast('End date must be after start date', 'error');
            isSubmittingLeave = false;
            return;
        }

        const { data, error } = await supabaseClient
            .from('leave_requests')
            .insert({
                staff_id: currentStaff.id,
                leave_type: leaveType,
                start_date: startDate,
                end_date: endDate,
                reason: reason,
                status: 'pending',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .select()
            .single();

        if (error) throw error;

        showToast('Leave request submitted for approval', 'success');
        closeModal('leaveModal');
        document.getElementById('leaveForm').reset();
        
    } catch (error) {
        console.error('Error submitting leave:', error);
        showToast('Failed to submit leave request: ' + error.message, 'error');
    } finally {
        // Always reset the flag
        isSubmittingLeave = false;
    }
}
function addModalsToDOM() {
    // Only add if not already present
    if (!document.getElementById('leaveModal')) {
        const modalsHTML = `<!-- your modal HTML here -->`;
        document.body.insertAdjacentHTML('beforeend', modalsHTML);
    }
}



async function loadShiftTimes() {
    const shiftId = document.getElementById('adjustmentShift').value;
    if (!shiftId) return;
    
    const { data: shift } = await supabaseClient
        .from('shifts')
        .select('start_time, end_time')
        .eq('id', shiftId)
        .single();
        
    if (shift) {
        document.getElementById('adjustmentStartTime').value = shift.start_time || '';
        document.getElementById('adjustmentEndTime').value = shift.end_time || '';
    }
}
async function loadLocations() {
    try {
        const { data: locationsData } = await supabaseClient
            .from('locations')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        locations = locationsData || [];
        window.locations = locations;
        
        console.log('Locations loaded:', locations.length);
        console.log('Care homes:', locations.filter(l => l.is_care_home).map(l => l.name));
        
        return locations;
        
    } catch (error) {
        console.error('Error loading locations:', error);
        locations = [];
        return [];
    }
}


async function submitNote() {
    const shiftId = document.getElementById('noteShiftId').value;
    const noteType = document.getElementById('noteType').value;
    const noteText = document.getElementById('noteText').value;
    
    if (!shiftId || !noteType || !noteText.trim()) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    try {
        // Insert the note - shift_id is now properly INTEGER
        const { data: noteData, error: noteError } = await supabaseClient
            .from('shift_notes')
            .insert({
                shift_id: parseInt(shiftId),  // Simple integer conversion
                staff_id: currentStaff.id,
                note_type: noteType,
                note: noteText,
                created_at: new Date().toISOString()
            })
            .select()
            .single();
        
        if (noteError) throw noteError;
        
        showToast('Note added successfully', 'success');
        closeModal('addNoteModal');
        
        // Clear the form
        document.getElementById('noteText').value = '';
        document.getElementById('noteType').selectedIndex = 0;
        
        // Refresh the notes display if we're viewing this shift
        if (typeof refreshShiftNotes === 'function') {
            refreshShiftNotes(shiftId);
        }
        
    } catch (error) {
        console.error('Error submitting note:', error);
        showToast('Failed to add note', 'error');
    }
}


function previewImages() {
    const files = document.getElementById('noteImages').files;
    const container = document.getElementById('imagePreviewContainer');
    
    selectedImages = Array.from(files);
    container.innerHTML = '';
    
    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-preview';
            img.onclick = () => removeImage(index);
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedImages.splice(index, 1);
    previewImages();
}

async function uploadDocument() {
    const fileInput = document.getElementById('documentFile');
    const file = fileInput.files[0];
    const documentTypeId = document.getElementById('documentType').value; // UUID from dropdown
    const title = document.getElementById('documentTitle').value;
    const expiryDate = document.getElementById('documentExpiry').value;
    const notes = document.getElementById('documentNotes').value;
    
    if (!file || !documentTypeId || !title) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    try {
        // Check file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            showToast('File size must be less than 10MB', 'error');
            return;
        }
        
        // Get file extension
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentStaff.id}/${Date.now()}_${title}.${fileExt}`;
        
        // Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('documents')
            .upload(fileName, file);
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from('documents')
            .getPublicUrl(fileName);
        
        // Save to database with correct column name
        const { error: dbError } = await supabaseClient
            .from('documents')
            .insert({
                entity_type: 'staff',
                entity_id: currentStaff.id,
                document_type_id: documentTypeId,  // CORRECT: Using document_type_id
                title: title,
                file_url: urlData.publicUrl,
                expiry_date: expiryDate || null,
                notes: notes || null,
                created_at: new Date().toISOString()
            });
        
        if (dbError) throw dbError;
        
        showToast('Document uploaded successfully', 'success');
        closeModal('uploadDocumentModal');
        
        // Reload documents list
        await loadDocuments();
        
    } catch (error) {
        console.error('Error uploading document:', error);
        showToast('Failed to upload document', 'error');
    }
}
function loadProfilePicture() {
    const profileImg = document.getElementById('profileImage');
    if (profileImg) {
        // Since profile_picture doesn't exist in DB, use default avatar
        profileImg.src = '/assets/default-avatar.png';
        // OR generate avatar from initials
        if (currentStaff) {
            const initials = `${currentStaff.first_name?.[0] || ''}${currentStaff.last_name?.[0] || ''}`;
            profileImg.alt = initials;
            // Could use a service like ui-avatars.com
            profileImg.src = `https://ui-avatars.com/api/?name=${currentStaff.first_name}+${currentStaff.last_name}&background=random`;
        }
    }
}



function displayUserRole() {
    // Since there's no role field, use a default or derive from other data
    const userRole = document.getElementById('userRole');
    if (userRole) {
        userRole.textContent = 'Support Worker'; // Default role
        // OR you could check if they have manager permissions some other way
    }
}

function createStaffSelector() {
    const selector = document.createElement('div');
    selector.id = 'staffSelector';
    selector.style.display = 'none';
    selector.style.position = 'fixed';
    selector.style.top = '60px';
    selector.style.right = '20px';
    selector.style.background = 'white';
    selector.style.border = '1px solid #ddd';
    selector.style.borderRadius = '8px';
    selector.style.padding = '10px';
    selector.style.zIndex = '1000';
    selector.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
    selector.innerHTML = `
        <h4 style="margin: 0 0 10px 0;">Quick Staff Switch</h4>
        <select id="staffQuickSelect" style="width: 200px; padding: 5px;">
            <option>Loading staff...</option>
        </select>
    `;
    document.body.appendChild(selector);
}


async function populateShiftModalDropdowns() {
    // Populate participants
    const participantSelect = document.getElementById('shiftParticipant');
    if (participantSelect && participants.length > 0) {
        participantSelect.innerHTML = '<option value="">Select Participant</option>' +
            participants.map(p => `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`).join('');
    }
    
    // Populate duty types and set default to "Active Shift"
    const dutySelect = document.getElementById('shiftDutyType');
    if (dutySelect && dutyTypes.length > 0) {
        dutySelect.innerHTML = '<option value="">Select Duty Type</option>';
        
        let activeShiftId = null;
        
        dutyTypes.forEach(d => {
            const option = document.createElement('option');
            option.value = d.id;
            option.textContent = d.name;
            
            // Check if this is "Active Shift" and set as default
            if (d.name === 'Active Shift' || d.name.toLowerCase() === 'active shift') {
                option.selected = true;
                activeShiftId = d.id;
            }
            
            dutySelect.appendChild(option);
        });
        
        // Add change event listener
        dutySelect.onchange = onDutyTypeChange;
        
        // Trigger the change event to set up time fields correctly for default selection
        if (activeShiftId) {
            onDutyTypeChange();
        }
    }
}
// ==========================================
// COMPLETE PROFILE FUNCTIONS FOR TEAM.HTML
// ==========================================

// 1. Load Profile Data
async function loadProfile() {
    try {
        if (!currentStaff) {
            showToast('Staff data not loaded', 'error');
            return;
        }
        
        // Display Personal Information
        const personalInfo = document.getElementById('personalInfo');
        if (personalInfo) {
            personalInfo.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">First Name</div>
                    <div class="field-value">${currentStaff.first_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Middle Name</div>
                    <div class="field-value">${currentStaff.middle_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Last Name</div>
                    <div class="field-value">${currentStaff.last_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Email</div>
                    <div class="field-value">${currentStaff.email || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Phone</div>
                    <div class="field-value">${currentStaff.phone || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <div class="field-value">${currentStaff.date_of_birth ? formatDate(currentStaff.date_of_birth) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Gender</div>
                    <div class="field-value">${currentStaff.sex || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Staff Code</div>
                    <div class="field-value">${currentStaff.staff_code || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <div class="field-value">${currentStaff.ndis_worker_number || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Start Date</div>
                    <div class="field-value">${currentStaff.start_date ? formatDate(currentStaff.start_date) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Hour Limit</div>
                    <div class="field-value">${currentStaff.limits || '76'} hours/fortnight</div>
                </div>
            `;
        }
        
        // Display Contact Information
        const contactInfo = document.getElementById('contactInfo');
        if (contactInfo) {
            contactInfo.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Address</div>
                    <div class="field-value">${currentStaff.address || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact Name</div>
                    <div class="field-value">${currentStaff.emergency_contact_name || currentStaff.emergency_contact || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact Phone</div>
                    <div class="field-value">${currentStaff.emergency_contact_phone || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact Relationship</div>
                    <div class="field-value">${currentStaff.emergency_contact_relationship || '-'}</div>
                </div>
            `;
        }
        
        // Display Banking Information
        const bankingInfo = document.getElementById('bankingInfo');
        if (bankingInfo) {
            bankingInfo.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Bank Name</div>
                    <div class="field-value">${currentStaff.bank_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">BSB</div>
                    <div class="field-value">${currentStaff.bsb || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Account Number</div>
                    <div class="field-value">${currentStaff.account_number ? '****' + currentStaff.account_number.slice(-4) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Tax File Number</div>
                    <div class="field-value">${currentStaff.tax_file_number ? '***-***-' + currentStaff.tax_file_number.slice(-3) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Superannuation Fund</div>
                    <div class="field-value">${currentStaff.super_fund || '-'}</div>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading profile:', error);
        showToast('Failed to load profile', 'error');
    }
}

// 2. Edit Personal Information
function editPersonalInfo() {
    const container = document.getElementById('personalInfo');
    if (!container) return;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">First Name</div>
            <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Middle Name</div>
            <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Last Name</div>
            <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Email</div>
            <input type="email" class="form-control" id="editEmail" value="${currentStaff.email || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Phone</div>
            <input type="tel" class="form-control" id="editPhone" value="${currentStaff.phone || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Date of Birth</div>
            <input type="date" class="form-control" id="editBirthday" value="${currentStaff.date_of_birth || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Gender</div>
            <select class="form-control" id="editSex">
                <option value="">Select</option>
                <option value="Male" ${currentStaff.sex === 'Male' ? 'selected' : ''}>Male</option>
                <option value="Female" ${currentStaff.sex === 'Female' ? 'selected' : ''}>Female</option>
                <option value="Other" ${currentStaff.sex === 'Other' ? 'selected' : ''}>Other</option>
            </select>
        </div>
        <div class="profile-field">
            <div class="field-label">NDIS Worker Number</div>
            <input type="text" class="form-control" id="editNDISNumber" value="${currentStaff.ndis_worker_number || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="savePersonalInfo()">Save Changes</button>
            <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
        </div>
    `;
}

// 3. Save Personal Information
async function savePersonalInfo() {
    try {
        const updateData = {
            first_name: document.getElementById('editFirstName')?.value || currentStaff.first_name,
            middle_name: document.getElementById('editMiddleName')?.value || null,
            last_name: document.getElementById('editLastName')?.value || currentStaff.last_name,
            email: document.getElementById('editEmail')?.value || currentStaff.email,
            phone: document.getElementById('editPhone')?.value || null,
            date_of_birth: document.getElementById('editBirthday')?.value || null,
            sex: document.getElementById('editSex')?.value || null,
            ndis_worker_number: document.getElementById('editNDISNumber')?.value || null,
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('staff')
            .update(updateData)
            .eq('id', currentStaff.id)
            .select()
            .single();
        
        if (error) throw error;
        
        // Update local state
        currentStaff = data;
        AppState.staff.current = data;
        
        // Update header name
        document.getElementById('userName').textContent = 
            `${data.first_name} ${data.last_name}`;
        
        loadProfile();
        showToast('Personal information updated successfully', 'success');
        
    } catch (error) {
        console.error('Error saving personal info:', error);
        showToast('Failed to save changes: ' + error.message, 'error');
    }
}

// 4. Edit Contact Information
function editContactInfo() {
    const container = document.getElementById('contactInfo');
    if (!container) return;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Address</div>
            <textarea class="form-control" id="editAddress" rows="3">${currentStaff.address || ''}</textarea>
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Name</div>
            <input type="text" class="form-control" id="editEmergencyName" 
                   value="${currentStaff.emergency_contact_name || currentStaff.emergency_contact || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Phone</div>
            <input type="tel" class="form-control" id="editEmergencyPhone" 
                   value="${currentStaff.emergency_contact_phone || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Relationship</div>
            <input type="text" class="form-control" id="editEmergencyRelationship" 
                   value="${currentStaff.emergency_contact_relationship || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="saveContactInfo()">Save Changes</button>
            <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
        </div>
    `;
}

// 5. Save Contact Information
async function saveContactInfo() {
    try {
        const updateData = {
            address: document.getElementById('editAddress')?.value || null,
            emergency_contact_name: document.getElementById('editEmergencyName')?.value || null,
            emergency_contact_phone: document.getElementById('editEmergencyPhone')?.value || null,
            emergency_contact_relationship: document.getElementById('editEmergencyRelationship')?.value || null,
            emergency_contact: document.getElementById('editEmergencyName')?.value || null, // Backup field
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('staff')
            .update(updateData)
            .eq('id', currentStaff.id)
            .select()
            .single();
        
        if (error) throw error;
        
        currentStaff = data;
        AppState.staff.current = data;
        
        loadProfile();
        showToast('Contact information updated successfully', 'success');
        
    } catch (error) {
        console.error('Error saving contact info:', error);
        showToast('Failed to save changes: ' + error.message, 'error');
    }
}

// 6. Edit Banking Information
function editBankingInfo() {
    const container = document.getElementById('bankingInfo');
    if (!container) return;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Bank Name</div>
            <input type="text" class="form-control" id="editBankName" value="${currentStaff.bank_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">BSB</div>
            <input type="text" class="form-control" id="editBSB" value="${currentStaff.bsb || ''}" 
                   maxlength="7" placeholder="XXX-XXX">
        </div>
        <div class="profile-field">
            <div class="field-label">Account Number</div>
            <input type="text" class="form-control" id="editAccountNumber" value="${currentStaff.account_number || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Tax File Number</div>
            <input type="text" class="form-control" id="editTFN" value="${currentStaff.tax_file_number || ''}" 
                   maxlength="9" placeholder="XXX XXX XXX">
        </div>
        <div class="profile-field">
            <div class="field-label">Superannuation Fund</div>
            <input type="text" class="form-control" id="editSuper" value="${currentStaff.super_fund || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="saveBankingInfo()">Save Changes</button>
            <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
        </div>
    `;
}

// 7. Save Banking Information
async function saveBankingInfo() {
    try {
        const updateData = {
            bank_name: document.getElementById('editBankName')?.value || null,
            bsb: document.getElementById('editBSB')?.value || null,
            account_number: document.getElementById('editAccountNumber')?.value || null,
            tax_file_number: document.getElementById('editTFN')?.value || null,
            super_fund: document.getElementById('editSuper')?.value || null,
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('staff')
            .update(updateData)
            .eq('id', currentStaff.id)
            .select()
            .single();
        
        if (error) throw error;
        
        currentStaff = data;
        AppState.staff.current = data;
        
        loadProfile();
        showToast('Banking information updated successfully', 'success');
        
    } catch (error) {
        console.error('Error saving banking info:', error);
        showToast('Failed to save changes: ' + error.message, 'error');
    }
}

async function saveAvailability() {
    try {
        const form = document.getElementById('availabilityForm');
        const selectedDates = form ? form.querySelectorAll('input[type="date"]') : [];
        
        if (selectedDates.length === 0) {
            // Fallback to checkbox method if using different UI
            return saveWeeklyAvailability();
        }
        
        const records = [];
        selectedDates.forEach(input => {
            if (input.value) {
                const isAvailable = input.dataset.available === 'true';
                const startTime = document.getElementById(`start_${input.id}`)?.value;
                const endTime = document.getElementById(`end_${input.id}`)?.value;
                
                records.push({
                    staff_id: currentStaff.id,
                    date: input.value,
                    is_available: isAvailable, // Correct column name
                    start_time: startTime || null,
                    end_time: endTime || null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                });
            }
        });
        
        if (records.length === 0) {
            showToast('Please select at least one date', 'warning');
            return;
        }
        
        // Use upsert to handle unique constraint
        const { error } = await supabaseClient
            .from('staff_availability')
            .upsert(records, {
                onConflict: 'staff_id,date',
                ignoreDuplicates: false
            });
        
        if (error) throw error;
        
        showToast('Availability saved successfully', 'success');
        
    } catch (error) {
        console.error('Error saving availability:', error);
        showToast('Failed to save availability: ' + error.message, 'error');
    }
}

async function populateDocumentTypes() {
    const select = document.getElementById('documentType');
    if (!select) return;
    
    try {
        // Load document types from the document_types table
        const { data: types, error } = await supabaseClient
            .from('document_types')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        if (error) {
            console.error('Error loading document types:', error);
            select.innerHTML = '<option value="">Failed to load types</option>';
            return;
        }
        
        // Clear existing options
        select.innerHTML = '<option value="">Select document type</option>';
        
        if (types && types.length > 0) {
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                option.dataset.requiresExpiry = type.requires_expiry;
                select.appendChild(option);
            });
            
            // Add event listener to show/hide expiry date field based on type
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const requiresExpiry = selectedOption.dataset.requiresExpiry === 'true';
                const expiryField = document.getElementById('documentExpiryField');
                
                if (expiryField) {
                    expiryField.style.display = requiresExpiry ? 'block' : 'none';
                    if (!requiresExpiry) {
                        // Clear expiry date if not required
                        const expiryInput = document.getElementById('documentExpiry');
                        if (expiryInput) expiryInput.value = '';
                    }
                }
            });
        } else {
            select.innerHTML += '<option value="">No document types available</option>';
        }
        
    } catch (error) {
        console.error('Error populating document types:', error);
        select.innerHTML = '<option value="">Error loading types</option>';
    }
}

function checkExpiryRequired() {
    const documentType = document.getElementById('documentType');
    const selectedOption = documentType.options[documentType.selectedIndex];
    const expiryGroup = document.getElementById('expiryGroup');
    const expiryInput = document.getElementById('documentExpiry');
    
    if (selectedOption && selectedOption.dataset.requiresExpiry === 'true') {
        expiryGroup.style.display = 'block';
        expiryInput.required = true;
    } else {
        expiryGroup.style.display = 'none';
        expiryInput.required = false;
    }
}


// Availability functions
function toggleDayAvailability(day, available) {
    // Update all time slots for the day
    for (let slot = 0; slot < 4; slot++) {
        weeklyAvailability[`${day}_${slot}`] = available;
    }
    renderAvailability();
}

function toggleTimeSlot(day, slot, element) {
    const key = `${day}_${slot}`;
    weeklyAvailability[key] = !weeklyAvailability[key];
    element.classList.toggle('selected');
}



async function handleBannerUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
        // Check file size
        if (file.size > 5 * 1024 * 1024) {
            showToast('Banner image must be less than 5MB', 'error');
            return;
        }
        
        // Get file extension properly
        const fileExt = file.name.split('.').pop();
        const fileName = `profile-banners/${currentStaff.id}_${Date.now()}.${fileExt}`;
        
        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
            .from('assets')
            .upload(fileName, file);
        
        if (error) throw error;
        
        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from('assets')
            .getPublicUrl(fileName);
        
        // Update staff record with banner URL
        const { error: updateError } = await supabaseClient
            .from('staff')
            .update({ profile_banner_url: urlData.publicUrl })
            .eq('id', currentStaff.id);
        
        if (updateError) throw updateError;
        
        // Update UI
        loadProfileBanner();
        showToast('Banner uploaded successfully', 'success');
        
    } catch (error) {
        console.error('Error uploading banner:', error);
        showToast('Failed to upload banner', 'error');
    }
}


async function uploadProfileBanner() {
    const fileInput = document.getElementById('bannerFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select a file', 'error');
        return;
    }
    
    try {
        // Check file size (5MB limit for banners)
        if (file.size > 5 * 1024 * 1024) {
            showToast('File size must be less than 5MB', 'error');
            return;
        }
        
        // Get file extension
        const fileExt = file.name.split('.').pop();
        const fileName = `profile-banners/${currentStaff.id}_${Date.now()}.${fileExt}`;
        
        // Upload to Supabase Storage - FIXED: Use 'documents' bucket instead of 'assets'
        const { data, error } = await supabaseClient.storage
            .from('documents')  // CHANGED FROM 'assets' to 'documents'
            .upload(fileName, file);
        
        if (error) throw error;
        
        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from('documents')  // CHANGED FROM 'assets' to 'documents'
            .getPublicUrl(fileName);
        
        // Note: profile_banner_url column may not exist in the staff table
        // You should either:
        // 1. Add this column to the staff table in the database
        // 2. Store this in a user_preferences or staff_settings table
        // 3. Remove this feature entirely
        
        // For now, commenting out the database update since the column likely doesn't exist
        /*
        const { error: updateError } = await supabaseClient
            .from('staff')
            .update({ profile_banner_url: urlData.publicUrl })
            .eq('id', currentStaff.id);
        
        if (updateError) throw updateError;
        */
        
        // Instead, store in localStorage as a temporary solution
        localStorage.setItem(`banner_${currentStaff.id}`, urlData.publicUrl);
        
        // Update UI
        const bannerElement = document.getElementById('profileBanner');
        if (bannerElement) {
            bannerElement.style.backgroundImage = `url(${urlData.publicUrl})`;
        }
        
        showToast('Banner uploaded successfully', 'success');
        closeModal('uploadBannerModal');
        
    } catch (error) {
        console.error('Error uploading banner:', error);
        showToast('Failed to upload banner', 'error');
    }
}


async function loadProfileBanner() {
    if (!currentStaff) return;
    
    // Try to load from localStorage (temporary solution)
    const storedBannerUrl = localStorage.getItem(`banner_${currentStaff.id}`);
    
    if (storedBannerUrl) {
        const bannerElement = document.getElementById('profileBanner');
        if (bannerElement) {
            bannerElement.style.backgroundImage = `url(${storedBannerUrl})`;
        }
    }
    
    // If you add profile_banner_url column to staff table, uncomment this:
    /*
    if (currentStaff.profile_banner_url) {
        const bannerElement = document.getElementById('profileBanner');
        if (bannerElement) {
            bannerElement.style.backgroundImage = `url(${currentStaff.profile_banner_url})`;
        }
    }
    */
}


async function loadHandoverNotes(participantId, shiftDate) {
    if (!participantId || !shiftDate) return [];
    
    try {
        // Get recent shifts for this participant
        const startDate = new Date(shiftDate);
        startDate.setDate(startDate.getDate() - 7); // Look back 7 days
        
        const { data: recentShifts, error: shiftsError } = await supabaseClient
            .from('shifts')
            .select('id')
            .eq('participant_id', participantId)
            .gte('date', startDate.toISOString().split('T')[0])
            .lte('date', shiftDate)
            .is('deleted_at', null);
        
        if (shiftsError || !recentShifts || recentShifts.length === 0) {
            return [];
        }
        
        // Get shift IDs as integers
        const shiftIds = recentShifts.map(shift => shift.id);
        
        // Fetch notes for these shifts - no UUID conversion needed!
        const { data: notes, error: notesError } = await supabaseClient
            .from('shift_notes')
            .select(`
                *,
                staff:staff_id(first_name, last_name)
            `)
            .in('shift_id', shiftIds)  // Direct integer array
            .is('deleted_at', null)
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (notesError) {
            console.error('Error loading handover notes:', notesError);
            return [];
        }
        
        return notes || [];
        
    } catch (error) {
        console.error('Error in loadHandoverNotes:', error);
        return [];
    }
}


async function addNoteToShift(shiftId) {
    try {
        // Open the modal
        const modal = document.getElementById('addNoteModal');
        if (!modal) {
            console.error('Add note modal not found');
            showToast('Note modal not available', 'error');
            return;
        }
        
        // Store the shift ID for later use
        window.currentNoteShiftId = shiftId;
        
        // Set the shift ID in a hidden field if it exists
        const shiftIdField = document.getElementById('noteShiftId');
        if (shiftIdField) {
            shiftIdField.value = shiftId;
        }
        
        // Open the modal
        openModal('addNoteModal');
        
        // Pre-select the shift if there's a dropdown
        const shiftSelect = document.getElementById('noteShift');
        if (shiftSelect) {
            setTimeout(() => {
                shiftSelect.value = shiftId;
            }, 100);
        }
        
    } catch (error) {
        console.error('Error in addNoteToShift:', error);
        showToast('Failed to open note form', 'error');
    }
}

async function loadSchedule() {
    try {
        const scheduleSection = document.getElementById('schedule');
        if (!scheduleSection) return;
        
        // Ensure we have current staff data
        if (!AppState.staff.current) {
            console.error('No current staff for schedule');
            return;
        }

        // Calculate current week (Monday to Sunday)
        const today = getTestDate();
        const currentDay = today.getDay();
        const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1); // Adjust when Sunday
        const weekStart = new Date(today.setDate(diff));
        weekStart.setHours(0, 0, 0, 0);
        
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);
        
        // Format dates for query
        const startDate = weekStart.toISOString().split('T')[0];
        const endDate = weekEnd.toISOString().split('T')[0];
        
        console.log('Loading schedule for week:', startDate, 'to', endDate);
        
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(id, first_name, last_name),
                locations(name, address),
                duty_types(name)
            `)  // REMOVED ndis_number
            .eq('staff_id', AppState.staff.current.id)
            .gte('date', startDate)
            .lte('date', endDate)
            .is('deleted_at', null)
            .order('date', { ascending: true })
            .order('start_time', { ascending: true });

        if (error) {
            console.error('Error loading schedule:', error);
            showToast('Failed to load schedule', 'error');
            return;
        }
        // Store shifts globally
        allShifts = shifts || [];
        myShifts = shifts || [];
        
        console.log('Schedule loaded:', allShifts.length, 'shifts');
        
        // Render the weekly schedule
        renderWeeklySchedule(weekStart, weekEnd, shifts || []);
        
    } catch (error) {
        console.error('Error in loadSchedule:', error);
        showToast('Failed to load schedule', 'error');
    }
}

function renderWeeklySchedule(weekStart, weekEnd, shifts) {
    const container = document.getElementById('scheduleGrid');
    if (!container) return;
    
    // Create week navigation header
    let html = `
        <div class="schedule-header">
            <button class="btn btn-sm" onclick="changeWeek(-1)">← Previous Week</button>
            <div class="week-display">
                <h3>${formatDateShort(weekStart.toISOString().split('T')[0])} - ${formatDateShort(weekEnd.toISOString().split('T')[0])}</h3>
            </div>
            <button class="btn btn-sm" onclick="changeWeek(1)">Next Week →</button>
        </div>
    `;
    
    // Group shifts by date
    const shiftsByDate = {};
    const daysOfWeek = [];
    
    // Generate all days of the week
    for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        daysOfWeek.push(dateStr);
        shiftsByDate[dateStr] = [];
    }
    
    // Populate shifts into their dates
    shifts.forEach(shift => {
        if (shiftsByDate[shift.date]) {
            shiftsByDate[shift.date].push(shift);
        }
    });
    
    // Render each day
    html += '<div class="weekly-schedule">';
    
    daysOfWeek.forEach(dateStr => {
        const date = new Date(dateStr + 'T12:00:00');
        const isToday = dateStr === getTestDate().toISOString().split('T')[0];
        const dayShifts = shiftsByDate[dateStr];
        
        html += `
            <div class="day-section ${isToday ? 'today' : ''}">
                <div class="day-header">
                    <div class="day-name">${date.toLocaleDateString('en-AU', { weekday: 'long' })}</div>
                    <div class="day-date">${date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })}</div>
                    ${dayShifts.length > 0 ? `<span class="shift-count">${dayShifts.length} shift${dayShifts.length > 1 ? 's' : ''}</span>` : ''}
                </div>
                <div class="day-shifts">
        `;
        
        if (dayShifts.length === 0) {
            html += '<div class="no-shifts">No shifts scheduled</div>';
        } else {
            dayShifts.forEach(shift => {
                const participant = shift.participants;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                html += `
                    <div class="shift-item" onclick="showParticipantShifts('${shift.participant_id}', '${participantName.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                        <div class="shift-participant">
                            <strong>${participantName}</strong>
                            ${participant?.ndis_number ? `<span class="ndis-number">(${participant.ndis_participant_number})</span>` : ''}
                        </div>
                        <div class="shift-location">
                            📍 ${shift.locations?.name || 'Client Home'}
                        </div>
                        ${shift.duty_types ? `<div class="shift-duty-type">${shift.duty_types.name}</div>` : ''}
                    </div>
                `;
            });
        }
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    container.innerHTML = html;
}

// Function to change week
window.changeWeek = function(direction) {
    window.currentWeekOffset = (window.currentWeekOffset || 0) + direction;
    
    const today = getTestDate();
    const currentDay = today.getDay();
    const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
    const weekStart = new Date(today.setDate(diff + (window.currentWeekOffset * 7)));
    
    loadSchedule();
};

window.showParticipantShifts = async function(participantId, participantName) {
    try {
        if (!participantId) return;
        
        // Get ALL shifts for this participant (any staff)
        const { data: participantShifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                locations(name, address),
                duty_types(name)
            `)
            .eq('participant_id', participantId)
            .is('deleted_at', null)
            .order('date', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        
        // Get staff names separately to avoid the foreign key ambiguity
        const staffIds = [...new Set(participantShifts?.map(s => s.staff_id) || [])];
        const { data: staffData } = await supabaseClient
            .from('staff')
            .select('id, first_name, last_name')
            .in('id', staffIds);
        
        const staffMap = {};
        staffData?.forEach(s => {
            staffMap[s.id] = `${s.first_name} ${s.last_name}`;
        });
        
        // Create modal
        const modalHtml = `
            <div id="participantShiftsModal" class="modal active" style="display: flex;">
                <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Shift History: ${participantName}</h3>
                        <button class="modal-close" onclick="document.getElementById('participantShiftsModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="padding: 20px;">
                            ${!participantShifts || participantShifts.length === 0 ? 
                                '<p>No shifts found for this participant</p>' :
                                participantShifts.map(shift => `
                                    <div class="shift-history-item" style="margin-bottom: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">
                                            ${formatDateLong(shift.date)}
                                        </div>
                                        <div style="color: #666;">
                                            <div>
                                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                                                ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                                            </div>
                                            <div>Staff: ${staffMap[shift.staff_id] || 'Unassigned'}</div>
                                            <div>📍 ${shift.locations?.name || 'Client Home'}</div>
                                            ${shift.duty_types ? `<div>Type: ${shift.duty_types.name}</div>` : ''}
                                            <div style="display: inline-block; margin-top: 5px; padding: 2px 8px; background: ${shift.status === 'confirmed' ? '#28a745' : '#ffc107'}; color: white; border-radius: 4px; font-size: 12px;">
                                                ${shift.status || 'confirmed'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal and add new one
        document.getElementById('participantShiftsModal')?.remove();
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Error showing participant shifts:', error);
        showToast('Failed to load participant history', 'error');
    }
};

function changeSchedulePeriod(direction) {
    if (!window.currentPeriodStart) {
        setCurrentPayPeriod();
    }
    
    const weeks = direction * 2; // Move by 2 weeks (fortnight)
    window.currentPeriodStart.setDate(window.currentPeriodStart.getDate() + (weeks * 7));
    window.currentPeriodEnd.setDate(window.currentPeriodEnd.getDate() + (weeks * 7));
    
    loadSchedule();
}


// ==========================================
// SIMPLIFIED DATE/TIME CALCULATION SYSTEM
// ==========================================

// 1. Time Constants & Configuration
const TIME_CONFIG = {
    periods: {
        day: { start: 6, end: 20 },      // 6 AM - 8 PM
        evening: { start: 20, end: 24 },  // 8 PM - Midnight
        night: { start: 0, end: 6 }       // Midnight - 6 AM
    },
    days: {
        weekday: [1, 2, 3, 4, 5],  // Mon-Fri
        saturday: [6],
        sunday: [0]
    },
    sleepover: {
        hours: 2,  // Sleepovers count as 2 hours
        count: 1
    }
};

// 2. Main Shift Hours Calculator (Simplified)
function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };
    
    // Handle sleepover shifts
    if (isSleepoverShift(shift)) {
        result.sleepover = TIME_CONFIG.sleepover.count;
        result.total = TIME_CONFIG.sleepover.hours;
        return result;
    }
    
    // Validate shift has required times
    if (!shift.start_time || !shift.end_time) {
        return result;
    }
    
    // Parse shift times
    const { startTime, endTime } = parseShiftTimes(shift);
    if (!startTime || !endTime) return result;
    
    // Calculate total hours
    result.total = (endTime - startTime) / (1000 * 60 * 60);
    
    // Categorize hours by day type
    const shiftDate = new Date(shift.date + 'T12:00:00');
    const dayOfWeek = shiftDate.getDay();
    
    // Public holiday takes precedence
    if (shift.is_public_holiday === true) {
        result.publicHoliday = result.total;
        return result;
    }
    
    // Weekend shifts
    if (dayOfWeek === 0) {
        result.sunday = result.total;
        return result;
    }
    
    if (dayOfWeek === 6) {
        result.saturday = result.total;
        return result;
    }
    
    // Weekday shifts - break down by time period
    const breakdown = calculateWeekdayBreakdown(startTime, endTime);
    result.weekdayDay = breakdown.day;
    result.weekdayEvening = breakdown.evening;
    result.weekdayNight = breakdown.night;
    
    return result;
}

// 3. Helper Functions
function isSleepoverShift(shift) {
    const dutyType = shift.duty_types?.name || '';
    return dutyType.toLowerCase().includes('sleepover') || !shift.start_time;
}

function parseShiftTimes(shift) {
    const [startHour, startMin] = shift.start_time.split(':').map(Number);
    const [endHour, endMin] = shift.end_time.split(':').map(Number);
    
    const startTime = new Date(shift.date + 'T' + shift.start_time);
    let endTime = new Date(shift.date + 'T' + shift.end_time);
    
    // Handle overnight shifts
    if (endHour < startHour || (endHour === startHour && endMin < startMin)) {
        endTime.setDate(endTime.getDate() + 1);
    }
    
    return { startTime, endTime };
}

function calculateWeekdayBreakdown(startTime, endTime) {
    const breakdown = { day: 0, evening: 0, night: 0 };
    let current = new Date(startTime);
    
    while (current < endTime) {
        const hour = current.getHours();
        const nextHour = new Date(current);
        nextHour.setHours(hour + 1, 0, 0, 0);
        
        const periodEnd = nextHour > endTime ? endTime : nextHour;
        const periodHours = (periodEnd - current) / (1000 * 60 * 60);
        
        // Assign to correct period
        if (hour >= TIME_CONFIG.periods.day.start && hour < TIME_CONFIG.periods.day.end) {
            breakdown.day += periodHours;
        } else if (hour >= TIME_CONFIG.periods.evening.start) {
            breakdown.evening += periodHours;
        } else {
            breakdown.night += periodHours;
        }
        
        current = new Date(periodEnd);
    }
    
    return breakdown;
}

// 4. Unified Date/Time Formatter
const DateTimeFormatter = {
    // Locale configuration
    locale: 'en-AU',
    
    // Format configurations
    formats: {
        long: { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        },
        short: { 
            weekday: 'short',
            day: 'numeric', 
            month: 'short' 
        },
        friendly: { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short' 
        },
        date: {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        },
        datetime: {
            day: 'numeric',
            month: 'short',
            hour: 'numeric',
            minute: '2-digit'
        }
    },
    
    // Parse date consistently
    parseDate(dateString) {
        if (!dateString) return null;
        // Add noon time to avoid timezone issues
        if (!dateString.includes('T')) {
            dateString += 'T12:00:00';
        }
        return new Date(dateString);
    },
    
    // Format date with specified format
    format(dateString, formatType = 'short') {
        if (!dateString) return '';
        const date = this.parseDate(dateString);
        return date.toLocaleDateString(this.locale, this.formats[formatType]);
    },
    
    // Format time (12-hour with AM/PM)
    formatTime(timeString) {
        if (!timeString) return '';
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const period = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        return `${displayHour}:${minutes} ${period}`;
    },
    
    // Format datetime
    formatDateTime(dateString) {
        if (!dateString) return '';
        const date = this.parseDate(dateString);
        return date.toLocaleString(this.locale, this.formats.datetime);
    },
    
    // Get greeting based on time
    getGreeting(date = new Date()) {
        const hour = date.getHours();
        if (hour < 12) return 'Good morning';
        if (hour < 17) return 'Good afternoon';
        return 'Good evening';
    }
};

// 6. Week/Period Utilities
function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday start
    return new Date(d.setDate(diff));
}

function setGreeting() {
    const testDate = typeof getTestDate === 'function' ? getTestDate() : new Date();
    const greeting = DateTimeFormatter.getGreeting(testDate);
    
    const greetingEl = document.getElementById('greeting');
    if (greetingEl && currentStaff) {
        greetingEl.textContent = `${greeting}, ${currentStaff.first_name}!`;
    }
    
    const dateEl = document.getElementById('currentDate');
    if (dateEl) {
        dateEl.textContent = formatDateLong(testDate.toISOString().split('T')[0]);
    }
}

// 7. Reference Data Loader (Simplified)
const DataLoader = {
    // Store for loaded data
    cache: {
        participants: [],
        staff: [],
        dutyTypes: [],
        locations: []
    },
    
    // Load all reference data
    async loadReferenceData() {
        console.log('Loading reference data...');
        
        const loaders = [
            this.loadParticipants(),
            this.loadStaff(),
            this.loadDutyTypes(),
            this.loadLocations()
        ];
        
        try {
            await Promise.all(loaders);
            console.log('Reference data loaded successfully');
            return this.cache;
        } catch (error) {
            console.error('Error loading reference data:', error);
            showToast('Failed to load reference data', 'error');
            return this.cache;
        }
    },
    
    async loadParticipants() {
        const { data, error } = await supabaseClient
            .from('participants')
            .select('*')
            .eq('is_active', true)
            .order('first_name');
        
        if (error) {
            console.error('Error loading participants:', error);
            return [];
        }
        
        this.cache.participants = data || [];
        participants = this.cache.participants; // Global compatibility
        console.log('Loaded participants:', this.cache.participants.length);
        return this.cache.participants;
    },
    
    async loadStaff() {
        const { data, error } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('is_active', true)
            .order('first_name');
        
        if (error) {
            console.error('Error loading staff:', error);
            return [];
        }
        
        this.cache.staff = data || [];
        staff = this.cache.staff; // Global compatibility
        console.log('Loaded staff:', this.cache.staff.length);
        return this.cache.staff;
    },
    
    async loadDutyTypes() {
        const { data, error } = await supabaseClient
            .from('duty_types')
            .select('*')
            .order('name');
        
        if (error) {
            console.error('Error loading duty types:', error);
            return [];
        }
        
        this.cache.dutyTypes = data || [];
        dutyTypes = this.cache.dutyTypes; // Global compatibility
        console.log('Loaded duty types:', this.cache.dutyTypes.length);
        return this.cache.dutyTypes;
    },
    
    async loadLocations() {
        const { data, error } = await supabaseClient
            .from('locations')
            .select('*')
            .order('name');
        
        if (error) {
            console.error('Error loading locations:', error);
            return [];
        }
        
        this.cache.locations = data || [];
        locations = this.cache.locations; // Global compatibility
        console.log('Loaded locations:', this.cache.locations.length);
        return this.cache.locations;
    }
};

async function viewShiftDetails(shiftId) {
    try {
        const { data: shift, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participant:participant_id(first_name, last_name, phone),
                location:location_id(name, address),
                duty_type:duty_type_id(name),
                staff:staff_id(first_name, last_name)
            `)
            .eq('id', shiftId)
            .single();

        if (error) throw error;

        // Show details in a simple alert or modal
        const details = `
Shift Details:
Date: ${formatDateLong(shift.date)}
Time: ${shift.start_time || 'Sleepover'} - ${shift.end_time || ''}
Client: ${shift.participant ? `${shift.participant.first_name} ${shift.participant.last_name}` : 'Unassigned'}
Location: ${shift.location?.name || 'TBC'}
Service: ${shift.duty_type?.name || 'Standard Care'}
        `;
        
        if (confirm(details + '\n\nWould you like to request a transfer for this shift?')) {
            openTransferModal(shiftId);
        }

    } catch (error) {
        console.error('Error viewing shift:', error);
        showToast('Failed to load shift details', 'error');
    }
}

async function openTransferModal(shiftId) {
    try {
        // Load available staff
        await loadTransferableShifts(); // This populates the shift dropdown
        
        // Set the specific shift if provided
        if (shiftId) {
            document.getElementById('transferShiftSelect').value = shiftId;
        }
        
        // Load staff options
        const { data: staffList } = await supabaseClient
            .from('staff')
            .select('id, first_name, last_name')
            .neq('id', currentStaff.id)
            .eq('active', true)
            .order('first_name');

        const staffSelect = document.getElementById('transferToStaff');
        staffSelect.innerHTML = '<option value="">Select staff member (optional)</option>' +
            (staffList || []).map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('');
        
        openModal('transferShiftModal');
        
    } catch (error) {
        console.error('Error opening transfer modal:', error);
        showToast('Failed to load transfer options', 'error');
    }
}
function changeMonth(direction) {
    if (!window.currentMonthOffset) {
        window.currentMonthOffset = 0;
    }
    window.currentMonthOffset += direction;
    loadSchedule();
}

        function populateParticipantFilter() {
            const select = document.getElementById('participantFilter');
            const uniqueParticipants = {};
            
            allShifts.forEach(shift => {
                if (shift.participant) {
                    uniqueParticipants[shift.participant_id] = shift.participant;
                }
            });

            select.innerHTML = '<option value="">All My Clients</option>';
            Object.values(uniqueParticipants).forEach(participant => {
                select.innerHTML += `
                    <option value="${participant.id}">
                        ${participant.first_name} ${participant.last_name}
                    </option>
                `;
            });
        }


        // ==========================================
// MODULAR UI RENDERING SYSTEM
// ==========================================

// 1. UI Component Factory
const UIComponents = {
    // Security: HTML escaping
    escape(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },
    
    // Generic element creator
    createElement(tag, options = {}) {
        const element = document.createElement(tag);
        
        if (options.class) element.className = options.class;
        if (options.id) element.id = options.id;
        if (options.text) element.textContent = options.text;
        if (options.html) element.innerHTML = options.html;
        if (options.style) element.style.cssText = options.style;
        if (options.data) {
            Object.entries(options.data).forEach(([key, value]) => {
                element.dataset[key] = value;
            });
        }
        if (options.attrs) {
            Object.entries(options.attrs).forEach(([key, value]) => {
                element.setAttribute(key, value);
            });
        }
        if (options.events) {
            Object.entries(options.events).forEach(([event, handler]) => {
                element.addEventListener(event, handler);
            });
        }
        if (options.children) {
            options.children.forEach(child => {
                if (typeof child === 'string') {
                    element.insertAdjacentHTML('beforeend', child);
                } else if (child) {
                    element.appendChild(child);
                }
            });
        }
        
        return element;
    },
    
    // Empty state component
    emptyState(message) {
        return this.createElement('div', {
            class: 'p-2 text-center',
            style: 'color: var(--text-light);',
            text: message
        });
    },
    
    // Shift list item component
    shiftListItem(shift, options = {}) {
        const participant = shift.participants;
        const hours = calculateShiftHours(shift);
        const dutyType = shift.duty_types?.name || 'Regular';
        
        return this.createElement('div', {
            class: 'shift-list-item',
            data: { shiftId: shift.id },
            children: [
                this.createElement('div', {
                    class: 'shift-info',
                    children: [
                        this.createElement('div', {
                            class: 'shift-date-time',
                            html: `
                                ${options.showDate ? formatDateShort(shift.date) + ' - ' : ''}
                                ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                ${shift.end_time ? formatTime(shift.end_time) : ''}
                                ${dutyType !== 'Regular' ? `<span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">${dutyType}</span>` : ''}
                            `
                        }),
                        participant && this.createElement('div', {
                            class: 'shift-client',
                            text: `${participant.first_name} ${participant.last_name}${shift.locations ? ` - ${shift.locations.name}` : ''}`
                        })
                    ].filter(Boolean)
                }),
                this.createElement('div', {
                    class: 'shift-hours',
                    children: [
                        this.createElement('div', {
                            class: 'shift-hours-value',
                            text: `${hours.total.toFixed(1)}h`
                        })
                    ]
                })
            ]
        });
    },
    
    // Group header component
    groupHeader(title, totalHours, style = {}) {
        return this.createElement('div', {
            style: `font-weight: 600; padding: 12px 16px; background: var(--bg-light); border-bottom: 1px solid var(--border-color); ${style.css || ''}`,
            children: [
                this.createElement('span', { text: title }),
                this.createElement('span', {
                    style: 'float: right; color: var(--primary-color);',
                    text: `${totalHours.toFixed(1)}h`
                })
            ]
        });
    },
    
    // Transfer item component
    transferItem(transfer, type = 'incoming') {
        const statusClass = `status-${transfer.status || 'pending'}`;
        const isIncoming = type === 'incoming';
        
        return this.createElement('div', {
            class: 'transfer-item',
            data: { transferId: transfer.id },
            children: [
                // Header
                this.createElement('div', {
                    class: 'transfer-header',
                    children: [
                        this.createElement('div', {
                            children: [
                                this.createElement('div', {
                                    class: 'transfer-date',
                                    text: formatDateLong(transfer.shift?.date)
                                }),
                                this.createElement('div', {
                                    class: 'transfer-time',
                                    html: `
                                        ${transfer.shift?.start_time ? formatTime(transfer.shift.start_time) : 'Sleepover'} - 
                                        ${transfer.shift?.end_time ? formatTime(transfer.shift.end_time) : ''}
                                    `
                                })
                            ]
                        }),
                        this.createElement('div', {
                            class: `transfer-badge ${statusClass}`,
                            text: transfer.status || 'Pending'
                        })
                    ]
                }),
                
                // From/To line
                this.createElement('div', {
                    class: 'transfer-from',
                    text: isIncoming ? 
                        `From: ${transfer.from_staff?.first_name} ${transfer.from_staff?.last_name}` :
                        `To: ${transfer.to_staff?.first_name || 'Pending'} ${transfer.to_staff?.last_name || ''}`
                }),
                
                // Reason (if exists)
                transfer.reason && this.createElement('div', {
                    class: 'transfer-reason',
                    text: `"${this.escape(transfer.reason)}"`
                }),
                
                // Actions (only for pending incoming)
                isIncoming && transfer.status === 'pending' && this.createElement('div', {
                    class: 'transfer-actions',
                    children: [
                        this.createElement('button', {
                            class: 'transfer-btn accept',
                            text: 'Accept',
                            events: { click: () => acceptTransfer(transfer.id) }
                        }),
                        this.createElement('button', {
                            class: 'transfer-btn decline',
                            text: 'Decline',
                            events: { click: () => declineTransfer(transfer.id) }
                        })
                    ]
                })
            ].filter(Boolean)
        });
    },
    
    // Note item component
    noteItem(note) {
        const staffName = note.staff ? 
            `${note.staff.first_name} ${note.staff.last_name}` : 
            'Unknown Staff';
        
        return this.createElement('div', {
            class: 'note-item',
            children: [
                this.createElement('div', {
                    class: 'note-header',
                    children: [
                        this.createElement('span', {
                            class: 'note-author',
                            text: staffName
                        }),
                        this.createElement('span', {
                            class: 'note-time',
                            text: formatDateTime(note.created_at)
                        })
                    ]
                }),
                this.createElement('div', {
                    class: 'note-content',
                    text: note.note
                }),
                this.createElement('div', {
                    class: 'note-type',
                    text: note.note_type
                })
            ]
        });
    },
    
    // Availability day component
    availabilityDay(day, index, availability) {
        const isAvailable = availability[`${index}_0`] || 
                          availability[`${index}_1`] || 
                          availability[`${index}_2`] || 
                          availability[`${index}_3`];
        
        return this.createElement('div', {
            class: 'availability-day',
            children: [
                this.createElement('div', {
                    class: 'availability-day-header',
                    children: [
                        this.createElement('span', {
                            class: 'day-name',
                            text: day
                        }),
                        this.createElement('label', {
                            class: 'availability-toggle',
                            children: [
                                this.createElement('input', {
                                    attrs: {
                                        type: 'checkbox',
                                        checked: isAvailable
                                    },
                                    events: {
                                        change: (e) => toggleDayAvailability(index, e.target.checked)
                                    }
                                }),
                                this.createElement('span', {
                                    class: 'toggle-slider'
                                })
                            ]
                        })
                    ]
                }),
                this.createElement('div', {
                    class: 'availability-times',
                    children: [
                        { slot: 0, label: 'Morning' },
                        { slot: 1, label: 'Afternoon' },
                        { slot: 2, label: 'Evening' },
                        { slot: 3, label: 'Night' }
                    ].map(({ slot, label }) => 
                        this.createElement('div', {
                            class: `time-slot ${availability[`${index}_${slot}`] ? 'selected' : ''}`,
                            text: label,
                            events: {
                                click: function() { toggleTimeSlot(index, slot, this); }
                            }
                        })
                    )
                })
            ]
        });
    }
};

// 2. Refactored Render Functions

function renderTimesheetShifts() {
    const container = document.getElementById('timesheetShifts');
    if (!container) {
        console.error('Timesheet shifts container not found');
        return;
    }
    
    const shifts = AppState.shifts.my || [];
    
    if (shifts.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-light);">
                No shifts in this pay period
            </div>
        `;
        return;
    }
    
    let html = '';
    
    if (AppState.ui.timesheetView === 'date') {
        // Group by date
        const grouped = {};
        shifts.forEach(shift => {
            if (!grouped[shift.date]) grouped[shift.date] = [];
            grouped[shift.date].push(shift);
        });
        
        // Sort dates and render
        Object.keys(grouped).sort().forEach(date => {
            const dayShifts = grouped[date];
            const dayHours = dayShifts.reduce((sum, s) => {
                const hours = calculateShiftHours(s);
                return sum + (hours.total || 0);
            }, 0);
            
            html += `
                <div class="shift-group">
                    <div class="shift-group-header">
                        <span>${formatDateLong(date)}</span>
                        <span class="shift-group-hours">${dayHours.toFixed(1)}h</span>
                    </div>
            `;
            
            dayShifts.forEach(shift => {
                const hours = calculateShiftHours(shift);
                const participant = shift.participants;
                
                html += `
                    <div class="shift-list-item">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                                ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                            </div>
                            <div class="shift-client">
                                ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                            </div>
                            <div class="shift-location">
                                📍 ${shift.locations?.name || 'Client Home'}
                            </div>
                        </div>
                        <div class="shift-hours">
                            <div class="shift-hours-value">${hours.total.toFixed(1)}h</div>
                            ${hours.sleepover > 0 ? '<div class="shift-pay">Sleepover</div>' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        });
        
    } else {
        // Group by participant
        const grouped = {};
        shifts.forEach(shift => {
            const key = shift.participant_id || 'unassigned';
            if (!grouped[key]) {
                grouped[key] = {
                    participant: shift.participants,
                    shifts: []
                };
            }
            grouped[key].shifts.push(shift);
        });
        
        Object.values(grouped).forEach(group => {
            const totalHours = group.shifts.reduce((sum, s) => {
                const hours = calculateShiftHours(s);
                return sum + (hours.total || 0);
            }, 0);
            
            const name = group.participant ? 
                `${group.participant.first_name} ${group.participant.last_name}` : 
                'Unassigned';
            
            html += `
                <div class="shift-group">
                    <div class="shift-group-header">
                        <span>${name}</span>
                        <span class="shift-group-hours">${totalHours.toFixed(1)}h</span>
                    </div>
            `;
            
            group.shifts.sort((a, b) => a.date.localeCompare(b.date)).forEach(shift => {
                const hours = calculateShiftHours(shift);
                
                html += `
                    <div class="shift-list-item">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${formatDateShort(shift.date)} - 
                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                                ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                            </div>
                            <div class="shift-location">
                                📍 ${shift.locations?.name || 'Client Home'}
                            </div>
                        </div>
                        <div class="shift-hours">
                            <div class="shift-hours-value">${hours.total.toFixed(1)}h</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        });
    }
    
    container.innerHTML = html;
}



function renderIncomingTransfers(transfers) {
    const container = document.getElementById('incomingList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transfers.length === 0) {
        container.appendChild(
            UIComponents.emptyState('No incoming transfer requests')
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    transfers.forEach(transfer => {
        fragment.appendChild(
            UIComponents.transferItem(transfer, 'incoming')
        );
    });
    
    container.appendChild(fragment);
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
    });
}

function formatDateFriendly(dateStr) {
    if (!dateStr) return 'Unknown';
    const date = new Date(dateStr);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-AU', options);
}

function formatTime12Hour(timeStr) {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    const date = new Date(dateTimeStr);
    return date.toLocaleDateString('en-AU', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
    });
}


function formatTime(timeStr) {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    return `${hours}:${minutes}`;
}


function formatDateShort(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {
        day: 'numeric',
        month: 'short'
    });
}

function formatDateLong(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
}


function renderShiftRow(shift) {
    const participant = shift.participants;
    const location = shift.locations;
    const dutyType = shift.duty_types;
    const hours = calculateShiftHours(shift);
    
    return `
        <div class="shift-row">
            <div class="shift-info">
                <div class="shift-time">
                    ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                    ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                </div>
                <div class="shift-client">
                    ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                </div>
                <div class="shift-location">
                    📍 ${location?.name || 'Client Home'}
                </div>
            </div>
            <div class="shift-hours">
                ${hours.total.toFixed(1)}h
            </div>
        </div>
    `;
}

function renderOutgoingTransfers(transfers) {
    const container = document.getElementById('outgoingList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transfers.length === 0) {
        container.appendChild(
            UIComponents.emptyState('No outgoing transfer requests')
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    transfers.forEach(transfer => {
        fragment.appendChild(
            UIComponents.transferItem(transfer, 'outgoing')
        );
    });
    
    container.appendChild(fragment);
}

function renderNotes(container, notes) {
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!notes || notes.length === 0) {
        container.appendChild(
            UIComponents.createElement('div', {
                style: 'color: var(--text-light);',
                text: 'No handover notes yet'
            })
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    notes.forEach(note => {
        fragment.appendChild(UIComponents.noteItem(note));
    });
    
    container.appendChild(fragment);
}

function renderAvailability() {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const container = document.getElementById('availabilityGrid');
    if (!container) return;
    
    container.innerHTML = '';
    
    const fragment = document.createDocumentFragment();
    days.forEach((day, index) => {
        fragment.appendChild(
            UIComponents.availabilityDay(day, index, weeklyAvailability)
        );
    });
    
    container.appendChild(fragment);
}

// 3. Keep complex calendar renders as template functions for now
// (These are complex enough that DOM manipulation might be overkill)

const CalendarTemplates = {
    renderSchedule(container, filterValue, allShifts) {
        if (!container) return;
        
        let filteredShifts = filterValue ? 
            allShifts.filter(s => s.participant_id === filterValue) : 
            allShifts;
        
        // Group by date
        const grouped = {};
        filteredShifts.forEach(shift => {
            if (!grouped[shift.date]) grouped[shift.date] = [];
            grouped[shift.date].push(shift);
        });
        
        container.innerHTML = '';
        
        if (Object.keys(grouped).length === 0) {
            container.appendChild(UIComponents.emptyState('No shifts found'));
            return;
        }
        
        const fragment = document.createDocumentFragment();
        
        Object.keys(grouped).sort().forEach(date => {
            const dayShifts = grouped[date];
            const isToday = date === getTestDate().toISOString().split('T')[0];
            
            const daySection = UIComponents.createElement('div', {
                class: 'day-section',
                children: [
                    UIComponents.createElement('div', {
                        class: 'day-header',
                        style: isToday ? 'background: var(--primary-color); color: white;' : '',
                        children: [
                            UIComponents.createElement('div', {
                                class: 'day-date',
                                text: formatDateLong(date)
                            }),
                            UIComponents.createElement('div', {
                                class: 'day-shift-count',
                                text: dayShifts.length.toString()
                            })
                        ]
                    }),
                    UIComponents.createElement('div', {
                        class: 'day-shifts',
                        children: dayShifts.map(shift => {
                            const isMyShift = shift.staff_id === currentStaff.id;
                            const staffName = shift.staff ? 
                                `${shift.staff.first_name} ${shift.staff.last_name}` : 
                                'Unassigned';
                            
                            return UIComponents.createElement('div', {
                                class: 'schedule-shift',
                                style: isMyShift ? 
                                    'background: #e3f2fd; border-left: 3px solid var(--primary-color);' : '',
                                children: [
                                    UIComponents.createElement('div', {
                                        children: [
                                            UIComponents.createElement('div', {
                                                class: 'schedule-shift-time',
                                                html: `
                                                    ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                                    ${shift.end_time ? formatTime(shift.end_time) : ''}
                                                `
                                            }),
                                            UIComponents.createElement('div', {
                                                class: 'schedule-shift-staff',
                                                text: staffName
                                            })
                                        ]
                                    }),
                                    isMyShift && UIComponents.createElement('div', {
                                        class: 'schedule-shift-actions',
                                        children: [
                                            UIComponents.createElement('button', {
                                                class: 'action-btn secondary',
                                                text: 'Note',
                                                events: {
                                                    click: () => addNoteToShift(shift.id)
                                                }
                                            })
                                        ]
                                    })
                                ].filter(Boolean)
                            });
                        })
                    })
                ]
            });
            
            fragment.appendChild(daySection);
        });
        
        container.appendChild(fragment);
    }
};


function renderFortnightSchedule(startDate, endDate, shifts) {
    const container = document.getElementById('scheduleCalendar');
    if (!container) return;

    // Create navigation similar to timesheet
    let html = `
        <div class="schedule-wrapper">
            <div class="schedule-header">
                <button onclick="changeSchedulePeriod(-1)" class="btn-nav">‹ Previous</button>
                <h3 class="schedule-period">
                    ${startDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })} - 
                    ${endDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}
                </h3>
                <button onclick="changeSchedulePeriod(1)" class="btn-nav">Next ›</button>
            </div>
            <div class="fortnight-grid">
    `;

    // Generate 14 days
    for (let i = 0; i < 14; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        const dateStr = currentDate.toISOString().split('T')[0];
        const dayShifts = shifts.filter(s => s.date === dateStr);
        const isToday = getTestDate().toDateString() === currentDate.toDateString();
        const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
        
        html += `
            <div class="schedule-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''} ${dayShifts.length > 0 ? 'has-shifts' : ''}">
                <div class="day-header">
                    <div class="day-name">${currentDate.toLocaleDateString('en-AU', { weekday: 'short' })}</div>
                    <div class="day-date">${currentDate.getDate()}</div>
                </div>
                <div class="day-shifts">
        `;
        
        if (dayShifts.length > 0) {
            dayShifts.forEach(shift => {
                html += `
                    <div class="shift-block">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'}
                            ${shift.end_time ? ' - ' + formatTime(shift.end_time) : ''}
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<div class="no-shift">No shifts</div>';
        }
        
        html += `
                </div>
            </div>
        `;
    }
    
    html += `
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function renderCalendar(targetDate, shifts) {
    const container = document.getElementById('scheduleCalendar');
    if (!container) return;

    const year = targetDate.getFullYear();
    const month = targetDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    let html = `
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)" class="calendar-nav-btn">‹</button>
                <h3 class="calendar-month">${monthNames[month]} ${year}</h3>
                <button onclick="changeMonth(1)" class="calendar-nav-btn">›</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-weekdays">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
                    <div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-days">
    `;
    
    // Empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day empty"></div>';
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayShifts = shifts.filter(s => s.date === dateStr);
        const isToday = getTestDate().toDateString() === new Date(year, month, day).toDateString();
        
        html += `
            <div class="calendar-day ${isToday ? 'today' : ''} ${dayShifts.length > 0 ? 'has-shifts' : ''}">
                <div class="day-number">${day}</div>
                ${dayShifts.length > 0 ? `
                    <div class="shift-dots">
                        ${dayShifts.map(() => '<span class="shift-dot"></span>').join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Update the original renderSchedule function
function renderSchedule() {
    const container = document.getElementById('scheduleGrid');
    const filterValue = document.getElementById('participantFilter')?.value;
    
    CalendarTemplates.renderSchedule(container, filterValue, allShifts);
}

        
        // Add all the edit profile functions
        function editPersonalInfo() {
            const container = document.getElementById('personalInfo');
            container.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">First Name</div>
                    <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Middle Name</div>
                    <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Last Name</div>
                    <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <input type="date" class="form-control" id="editDOB" value="${currentStaff.date_of_birth || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <input type="text" class="form-control" id="editNDIS" value="${currentStaff.ndis_worker_number || ''}">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="savePersonalInfo()">Save</button>
                    <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
                </div>
            `;
        }

        async function savePersonalInfo() {
            try {
                const updates = {
                    first_name: document.getElementById('editFirstName').value,
                    middle_name: document.getElementById('editMiddleName').value || null,
                    last_name: document.getElementById('editLastName').value,
                    date_of_birth: document.getElementById('editDOB').value || null,
                    ndis_worker_number: document.getElementById('editNDIS').value || null
                };

                const { error } = await supabaseClient
                    .from('staff')
                    .update(updates)
                    .eq('id', currentStaff.id);

                if (error) throw error;

                currentStaff = { ...currentStaff, ...updates };
                showToast('Personal information updated', 'success');
                loadProfile();
                document.getElementById('userName').textContent = `${currentStaff.first_name} ${currentStaff.last_name}`;

            } catch (error) {
                console.error('Error updating personal info:', error);
                showToast('Failed to update personal information', 'error');
            }
        }


function showSection(sectionName) {
    try {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show target section
        const targetSection = document.getElementById(sectionName);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Update navigation
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
        });
        
        // Find and activate corresponding nav item
        const navItem = document.querySelector(`[onclick*="${sectionName}"]`);
        if (navItem) {
            navItem.classList.add('active');
        }
        
    } catch (error) {
        console.error('Error showing section:', error);
    }
}

// ============================================
// TIMESHEET FIXES - Complete Implementation
// ============================================

// Global variables needed for timesheet
AppState.shifts.my = [];
window.currentPeriodStart = null;
window.currentPeriodEnd = null;
AppState.ui.timesheetView = 'date'; // 'date' or 'participant'
window.currentPeriodOffset = 0;



// ============================================
// FIX 1: Proper Pay Period Initialization
// ============================================

function setCurrentPayPeriod() {
    try {
        const today = new Date();
        
        // Calculate which pay period we're in
        const daysSinceStart = Math.floor((today - PAY_PERIOD_START) / (1000 * 60 * 60 * 24));
        const periodNumber = Math.floor(daysSinceStart / PERIOD_LENGTH);
        
        // Apply any offset (for navigating periods)
        const adjustedPeriodNumber = periodNumber + (window.currentPeriodOffset || 0);
        
        // Calculate current period start (Sunday)
        window.currentPeriodStart = new Date(PAY_PERIOD_START);
        window.currentPeriodStart.setDate(PAY_PERIOD_START.getDate() + (adjustedPeriodNumber * PERIOD_LENGTH));
        
        // Calculate period end (Saturday, 13 days later)
        window.currentPeriodEnd = new Date(window.currentPeriodStart);
        window.currentPeriodEnd.setDate(window.currentPeriodStart.getDate() + 13);
        
        console.log('Pay period set:', {
            start: window.currentPeriodStart.toISOString(),
            end: window.currentPeriodEnd.toISOString()
        });
        
        // Update the display
        updatePeriodDisplay();
        
    } catch (error) {
        console.error('Error setting pay period:', error);
        // Emergency fallback
        window.currentPeriodStart = new Date();
        window.currentPeriodEnd = new Date();
        window.currentPeriodEnd.setDate(window.currentPeriodEnd.getDate() + 13);
    }
}

// ============================================
// FIX 2: Update Period Display
// ============================================

function updatePeriodDisplay() {
    const periodDatesElement = document.getElementById('periodDates');
    if (periodDatesElement && window.currentPeriodStart && window.currentPeriodEnd) {
        const options = { day: 'numeric', month: 'short', year: 'numeric' };
        const startStr = window.currentPeriodStart.toLocaleDateString('en-AU', options);
        const endStr = window.currentPeriodEnd.toLocaleDateString('en-AU', options);
        periodDatesElement.textContent = `${startStr} - ${endStr}`;
    }
}

// Add this function to properly calculate pay periods
function getPayPeriodForDate(date = new Date()) {
    // Your organization's base period start - UPDATE THIS TO YOUR ACTUAL START
    const PERIOD_START_DATE = new Date('2024-07-28'); // Original base Sunday
    const PERIOD_LENGTH = 14; // days
    
    // Calculate days since base period
    const daysDiff = Math.floor((date - PERIOD_START_DATE) / (1000 * 60 * 60 * 24));
    const periodNumber = Math.floor(daysDiff / PERIOD_LENGTH);
    
    // Calculate this period's start date
    const periodStart = new Date(PERIOD_START_DATE);
    periodStart.setDate(periodStart.getDate() + (periodNumber * PERIOD_LENGTH));
    
    // Calculate period end (13 days after start)
    const periodEnd = new Date(periodStart);
    periodEnd.setDate(periodStart.getDate() + 13);
    
    return {
        start: periodStart,
        end: periodEnd,
        number: periodNumber
    };
}

async function loadTimesheet() {
    try {
        // Safety check
        if (!currentStaff || !currentStaff.id) {
            return;
        }
        
        // Initialize offset if needed
        if (AppState.ui.periodOffset === undefined) {
            AppState.ui.periodOffset = 0;
        }
        
        // Calculate period dates
        const PAY_PERIOD_START = new Date('2025-07-28'); // Monday
        const PERIOD_LENGTH = 14;
        const today = new Date();
        
        const daysSinceBase = Math.floor((today - PAY_PERIOD_START) / (1000 * 60 * 60 * 24));
        const basePeriodNumber = Math.floor(daysSinceBase / PERIOD_LENGTH);
        const currentPeriodNumber = basePeriodNumber + AppState.ui.periodOffset;
        
        const periodStart = new Date(PAY_PERIOD_START);
        periodStart.setDate(PAY_PERIOD_START.getDate() + (currentPeriodNumber * PERIOD_LENGTH));
        
        const periodEnd = new Date(periodStart);
        periodEnd.setDate(periodStart.getDate() + 13);
        
        // UPDATE THE DISPLAY
        const periodDatesElement = document.getElementById('periodDates');
        if (periodDatesElement) {
            const startStr = periodStart.getDate() + ' ' + 
                periodStart.toLocaleDateString('en-AU', { month: 'short' });
            const endStr = periodEnd.getDate() + ' ' + 
                periodEnd.toLocaleDateString('en-AU', { month: 'short' }) + ' ' +
                periodEnd.getFullYear();
            
            periodDatesElement.textContent = `${startStr} - ${endStr}`;
        }
        
        // Store globally
        window.currentPeriodStart = periodStart;
        window.currentPeriodEnd = periodEnd;
        
        // Load shifts
        const startQuery = periodStart.toISOString().split('T')[0];
        const endQuery = periodEnd.toISOString().split('T')[0];
        
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                duty_types(name),
                locations(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', startQuery)
            .lte('date', endQuery)
            .is('deleted_at', null)
            .order('date', { ascending: true });

        if (error) throw error;
        
        AppState.shifts.my = shifts || [];
        
        // Update displays
        if (shifts && shifts.length > 0) {
            calculateTimesheetHours(shifts);
            renderTimesheetShifts();
        } else {
            document.getElementById('hoursGrid').innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No hours</div>';
            document.getElementById('totalHours').textContent = '0.0h';
            document.getElementById('timesheetShifts').innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No shifts</div>';
        }
        
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to load timesheet', 'error');
    }
}

async function loadTransferModalData() {
    try {
        // Get future shifts only (can't transfer past shifts)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const { data: futureShifts } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', tomorrow.toISOString().split('T')[0])
            .is('deleted_at', null)
            .order('date', { ascending: true });
        
        console.log('Future shifts for transfer:', futureShifts);
        
        // Populate the dropdown
        const select = document.getElementById('transferShiftSelect');
        if (select) {
            select.innerHTML = '<option value="">Select a shift</option>';
            
            if (futureShifts && futureShifts.length > 0) {
                futureShifts.forEach(shift => {
                    const participant = shift.participants;
                    const clientName = participant ? 
                        `${participant.first_name} ${participant.last_name}` : 'Unassigned';
                    const option = document.createElement('option');
                    option.value = shift.id;
                    option.textContent = `${formatDateShort(shift.date)} - ${clientName} (${shift.start_time || 'Sleepover'})`;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">No future shifts available to transfer</option>';
            }
        }
        
        // Load other staff members...
        // (rest of function)
    } catch (error) {
        console.error('Error loading transfer modal data:', error);
    }
}

async function loadAdjustmentModalData() {
    try {
        // Get all your shifts (past and future for adjustments)
        const { data: yourShifts } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name)
            `)
            .eq('staff_id', currentStaff.id)
            .order('date', { ascending: false })
            .limit(20);
        
        console.log('Shifts for adjustment:', yourShifts);
        
        const select = document.getElementById('adjustmentShift');
        if (select) {
            select.innerHTML = '<option value="">Select a shift</option>';
            
            if (yourShifts && yourShifts.length > 0) {
                yourShifts.forEach(shift => {
                    const participant = shift.participants;
                    const clientName = participant ? 
                        `${participant.first_name} ${participant.last_name}` : 'Unassigned';
                    const option = document.createElement('option');
                    option.value = shift.id;
                    option.dataset.start = shift.start_time || '';
                    option.dataset.end = shift.end_time || '';
                    option.textContent = `${formatDateShort(shift.date)} - ${clientName} (${shift.start_time || 'Sleepover'})`;
                    select.appendChild(option);
                });
                
                // Auto-fill times when shift is selected
                select.onchange = function() {
                    const selected = this.options[this.selectedIndex];
                    if (selected && selected.dataset.start) {
                        document.getElementById('adjustmentStartTime').value = selected.dataset.start;
                        document.getElementById('adjustmentEndTime').value = selected.dataset.end;
                    }
                };
            } else {
                select.innerHTML = '<option value="">No shifts available</option>';
            }
        }
    } catch (error) {
        console.error('Error loading adjustment modal data:', error);
    }
}

function calculateHoursBreakdown() {
    const breakdown = {
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0,
        total: 0
    };
    
    AppState.shifts.my.forEach(shift => {
        const hours = calculateShiftHours(shift);
        Object.keys(hours).forEach(key => {
            if (breakdown[key] !== undefined) {
                breakdown[key] += hours[key] || 0;
            }
        });
    });
    
    // Update the hours grid display
    const hoursGrid = document.getElementById('hoursGrid');
    if (hoursGrid) {
        hoursGrid.innerHTML = `
            <div class="hour-item">
                <div class="hour-label">Weekday Day</div>
                <div class="hour-value">${breakdown.weekdayDay.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Weekday Evening</div>
                <div class="hour-value">${breakdown.weekdayEvening.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Weekday Night</div>
                <div class="hour-value">${breakdown.weekdayNight.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Saturday</div>
                <div class="hour-value">${breakdown.saturday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Sunday</div>
                <div class="hour-value">${breakdown.sunday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Public Holiday</div>
                <div class="hour-value">${breakdown.publicHoliday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Sleepovers</div>
                <div class="hour-value">${Math.floor(breakdown.sleepover)}x</div>
            </div>
        `;
    }
    
    // Update total hours
    const totalHours = document.getElementById('totalHours');
    if (totalHours) {
        totalHours.textContent = `${breakdown.total.toFixed(1)}h`;
    }
    
    return breakdown;
}

const timesheetStyles = `
    .shift-group {
        margin-bottom: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .shift-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-light, #f5f5f5);
        border-bottom: 1px solid var(--border-color, #e0e0e0);
        font-weight: 600;
    }
    
    .shift-group-hours {
        color: var(--primary-color, #004990);
        font-size: 16px;
    }
    
    .shift-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-light, #f0f0f0);
        transition: background 0.2s;
    }
    
    .shift-list-item:hover {
        background: var(--bg-light, #f9f9f9);
    }
    
    .shift-list-item:last-child {
        border-bottom: none;
    }
    
    .shift-info {
        flex: 1;
    }
    
    .shift-date-time {
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .shift-client {
        font-size: 14px;
        color: var(--text-light, #666);
        margin-bottom: 2px;
    }
    
    .shift-location {
        font-size: 13px;
        color: var(--text-light, #888);
    }
    
    .shift-hours {
        text-align: right;
        min-width: 60px;
    }
    
    .shift-hours-value {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-color, #004990);
    }
    
    .shift-pay {
        font-size: 12px;
        color: var(--text-light, #888);
        margin-top: 2px;
    }
`;

// Add styles if they don't exist
if (!document.getElementById('timesheetStyles')) {
    const styleElement = document.createElement('style');
    styleElement.id = 'timesheetStyles';
    styleElement.textContent = timesheetStyles;
    document.head.appendChild(styleElement);
}

// ==========================================
// EXACT TIMESHEET CALCULATIONS FROM MC-MANAGER
// ==========================================

// 1. Global variable for public holidays (add at top)
let publicHolidays = new Set();

// 2. The EXACT calculateShiftHours function from mc-manager
function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };

    const dutyType = shift.duty_type || shift.duty_types;
    const isSleepover = dutyType && dutyType.name && 
        dutyType.name.toLowerCase().includes('sleepover');

    // If it has times AND is a sleepover, calculate both
    if (isSleepover && shift.start_time && shift.end_time) {
        // This is BOTH active hours AND a sleepover
        
        // First calculate active hours
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const activeHours = (endTime - startTime) / (1000 * 60 * 60);
        
        // Apply penalty logic for active hours
        const shiftDate = new Date(shift.date);
        const dayOfWeek = shiftDate.getDay();
        const isPublicHoliday = publicHolidays.has(shift.date);
        
        if (isPublicHoliday) {
            result.publicHoliday = activeHours;
        } else if (dayOfWeek === 6) {
            result.saturday = activeHours;
        } else if (dayOfWeek === 0) {
            result.sunday = activeHours;
        } else {
            const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
            Object.assign(result, weekdayBreakdown);
        }
        
        // ADD the sleepover hours on top
        result.sleepover = 2; // Always 2 hours for sleepover
        result.total = activeHours + 2; // Total is active + sleepover
        
    } else if (isSleepover) {
        // Just a sleepover, no active hours
        result.sleepover = 2;
        result.total = 2;
        
    } else if (shift.start_time && shift.end_time) {
        // Just active hours, no sleepover
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const totalHours = (endTime - startTime) / (1000 * 60 * 60);
        result.total = totalHours;
        
        // Apply penalty logic
        const shiftDate = new Date(shift.date);
        const dayOfWeek = shiftDate.getDay();
        const isPublicHoliday = publicHolidays.has(shift.date);
        
        if (isPublicHoliday) {
            result.publicHoliday = totalHours;
        } else if (dayOfWeek === 6) {
            result.saturday = totalHours;
        } else if (dayOfWeek === 0) {
            result.sunday = totalHours;
        } else {
            const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
            Object.assign(result, weekdayBreakdown);
        }
    }
    
    return result;
}

// 3. The EXACT splitWeekdayHours function
function splitWeekdayHours(startTime, endTime) {
    const result = {
        total: 0,
        weekdayDay: 0,      // 6am-8pm
        weekdayEvening: 0,  // 8pm-12am  
        weekdayNight: 0     // 12am-6am
    };

    const current = new Date(startTime);
    
    while (current < endTime) {
        // Calculate end of current period
        const nextPeriod = new Date(current);
        nextPeriod.setMinutes(current.getMinutes() + 30); // Calculate in 30-min increments
        
        const periodEnd = nextPeriod > endTime ? endTime : nextPeriod;
        const periodHours = (periodEnd - current) / (1000 * 60 * 60);
        
        const hour = current.getHours();
        
        // Time period classification
        if (hour >= 6 && hour < 20) {
            result.weekdayDay += periodHours;
        } else if (hour >= 20 && hour < 24) {
            result.weekdayEvening += periodHours;
        } else {
            result.weekdayNight += periodHours;
        }
        
        current.setTime(periodEnd.getTime());
    }

    result.total = result.weekdayDay + result.weekdayEvening + result.weekdayNight;
    return result;
}

// 4. The EXACT calculateTimesheetHours for the timesheet display
function calculateTimesheetHours(shifts) {
    const breakdown = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0,
        sleepoverCount: 0
    };
    
    shifts.forEach(shift => {
        const hours = calculateShiftHours(shift);
        
        breakdown.total += hours.total || 0;
        breakdown.weekdayDay += hours.weekdayDay || 0;
        breakdown.weekdayEvening += hours.weekdayEvening || 0;
        breakdown.weekdayNight += hours.weekdayNight || 0;
        breakdown.saturday += hours.saturday || 0;
        breakdown.sunday += hours.sunday || 0;
        breakdown.publicHoliday += hours.publicHoliday || 0;
        breakdown.sleepover += hours.sleepover || 0;
        
        // Count sleepovers (not hours)
        if (hours.sleepover > 0) {
            breakdown.sleepoverCount++;
        }
    });
    
    // Update the hours grid display
    const hoursGrid = document.getElementById('hoursGrid');
    if (hoursGrid) {
        hoursGrid.innerHTML = `
            <div class="hours-item">
                <span class="hours-label">Weekday Day</span>
                <span class="hours-value">${breakdown.weekdayDay.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Evening</span>
                <span class="hours-value">${breakdown.weekdayEvening.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Night</span>
                <span class="hours-value">${breakdown.weekdayNight.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Saturday</span>
                <span class="hours-value">${breakdown.saturday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sunday</span>
                <span class="hours-value">${breakdown.sunday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Public Holiday</span>
                <span class="hours-value">${breakdown.publicHoliday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sleepovers</span>
                <span class="hours-value">${breakdown.sleepoverCount}</span>
            </div>
        `;
    }
    
    // Update total
    const totalElement = document.getElementById('totalHours');
    if (totalElement) {
        totalElement.textContent = `${breakdown.total.toFixed(1)}h`;
    }
    
    return breakdown;
}

// 5. Helper function for formatting hours
function formatHours(hours) {
    return (hours || 0).toFixed(1);
}

function toggleTimesheetView(view) {
    console.log('Toggling view to:', view);
    
    AppState.ui.timesheetView = view;
    
    // Update button states
    document.querySelectorAll('.view-toggle .toggle-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(view === 'date' ? 'Date' : 'Client')) {
            btn.classList.add('active');
        }
    });
    
    // Re-render with new view
    renderTimesheetShifts();
}

// 4. Also make sure the view toggle buttons work
document.addEventListener('DOMContentLoaded', function() {
    // View toggle buttons
    const dateViewBtn = document.querySelector('.toggle-btn:first-child');
    const clientViewBtn = document.querySelector('.toggle-btn:last-child');
    
    if (dateViewBtn) {
        dateViewBtn.onclick = function() {
            toggleTimesheetView('date');
        };
    }
    
    if (clientViewBtn) {
        clientViewBtn.onclick = function() {
            toggleTimesheetView('participant');
        };
    }
});


// ============================================
// FIX 10: Initialize on Section Switch
// ============================================

// Override or enhance the switchSection function
const originalSwitchSection = window.switchSection;
window.switchSection = function(section) {
    // Call original if it exists
    if (typeof originalSwitchSection === 'function') {
        originalSwitchSection(section);
    }
    
    // Update nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('onclick')?.includes(section)) {
            item.classList.add('active');
        }
    });
    
    // Update content sections
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const targetSection = document.getElementById(section);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Load section data
    if (section === 'timesheet') {
        loadTimesheet();
    }
}

// ============================================
// FIX FOR changePeriod FUNCTION
// ============================================

// Make sure the function is defined globally
window.changePeriod = function(direction) {
    console.log('changePeriod called with:', direction);
    
    // Initialize offset if not set
    if (AppState.ui.periodOffset === undefined) {
        AppState.ui.periodOffset = 0;
    }
    
    // Update offset
    AppState.ui.periodOffset += direction;
    console.log('New offset:', AppState.ui.periodOffset);
    
    // Reload timesheet
    loadTimesheet();
}


// Also ensure setCurrentPayPeriod exists and works correctly
window.setCurrentPayPeriod = function() {
    try {
        const PERIOD_LENGTH = 14; // 14-day pay periods
        const PAY_PERIOD_START = new Date('2025-07-28')
        const today = new Date();
        
        // Calculate which pay period we're in
        const daysSinceStart = Math.floor((today - PAY_PERIOD_START) / (1000 * 60 * 60 * 24));
        const periodNumber = Math.floor(daysSinceStart / PERIOD_LENGTH);
        
        // Apply any offset (for navigating periods)
        const adjustedPeriodNumber = periodNumber + (window.currentPeriodOffset || 0);
        
        // Calculate current period start (Sunday)
        window.currentPeriodStart = new Date(PAY_PERIOD_START);
        window.currentPeriodStart.setDate(PAY_PERIOD_START.getDate() + (adjustedPeriodNumber * PERIOD_LENGTH));
        
        // Calculate period end (Saturday, 13 days later)
        window.currentPeriodEnd = new Date(window.currentPeriodStart);
        window.currentPeriodEnd.setDate(window.currentPeriodStart.getDate() + 13);
        
        console.log('Pay period set:', {
            start: window.currentPeriodStart.toISOString(),
            end: window.currentPeriodEnd.toISOString(),
            offset: window.currentPeriodOffset || 0
        });
        
        // Update the display
        updatePeriodDisplay();
        
    } catch (error) {
        console.error('Error setting pay period:', error);
        // Emergency fallback
        window.currentPeriodStart = new Date();
        window.currentPeriodEnd = new Date();
        window.currentPeriodEnd.setDate(window.currentPeriodEnd.getDate() + 13);
    }
}

// Ensure updatePeriodDisplay exists
window.updatePeriodDisplay = function() {
    const periodDatesElement = document.getElementById('periodDates');
    if (periodDatesElement && window.currentPeriodStart && window.currentPeriodEnd) {
        const options = { day: 'numeric', month: 'short', year: 'numeric' };
        const startStr = window.currentPeriodStart.toLocaleDateString('en-AU', options);
        const endStr = window.currentPeriodEnd.toLocaleDateString('en-AU', options);
        periodDatesElement.textContent = `${startStr} - ${endStr}`;
    }
}



// Also fix toggleTimesheetView if it has similar issues
window.toggleTimesheetView = function(view) {
    try {
        AppState.ui.timesheetView = view;
        
        // Update button states
        document.querySelectorAll('.view-toggle .toggle-btn').forEach(btn => {
            btn.classList.remove('active');
            // Check if this is the clicked button
            if (btn.textContent.includes(view === 'date' ? 'Date' : 'Client')) {
                btn.classList.add('active');
            }
        });
        
        // Re-render with new view
        if (typeof renderTimesheetShifts === 'function') {
            renderTimesheetShifts();
        }
        
    } catch (error) {
        console.error('Error toggling timesheet view:', error);
    }
}


async function ensureStaffLoaded() {
    console.log('Ensuring staff data is loaded...');
    
    if (AppState.staff.current) {
        console.log('Staff already loaded:', AppState.staff.current);
        return AppState.staff.current;
    }
    
    try {
        // Get current user first
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (userError || !user) {
            console.error('No authenticated user found:', userError);
            window.location.href = 'index.html';
            return null;
        }
        
        console.log('Current user:', user.email);
        window.currentUser = user;
        
        // Try to load staff by user_id first
        let { data: staffData, error: staffError } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('user_id', user.id)
            .maybeSingle();
        
        // If not found by user_id, try by email
        if (!staffData) {
            console.log('No staff found by user_id, trying email...');
            const result = await supabaseClient
                .from('staff')
                .select('*')
                .eq('email', user.email)
                .maybeSingle();
            
            staffData = result.data;
            staffError = result.error;
        }
        
        if (staffError) {
            console.error('Error loading staff data:', staffError);
            showToast('Failed to load staff data', 'error');
            return null;
        }
        
        if (!staffData) {
            console.error('No staff record found for user');
            showToast('No staff record found. Please contact administrator.', 'error');
            return null;
        }
        
        // Set the global currentStaff
        AppState.staff.current = staffData;
        console.log('Staff data loaded successfully:', staffData);
        
        // Update UI with staff name
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = `${staffData.first_name} ${staffData.last_name}`;
        }
        
        return staffData;
        
    } catch (error) {
        console.error('Failed to ensure staff loaded:', error);
        showToast('Failed to load staff data', 'error');
        return null;
    }
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
        color: white;
        border-radius: 4px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showNotification(message, type = 'info') {
    // Alias for showToast to ensure compatibility
    showToast(message, type === 'error' ? 'error' : type === 'success' ? 'success' : 'info');
}


if (!document.querySelector('#toastStyles')) {
    const style = document.createElement('style');
    style.id = 'toastStyles';
    style.textContent = `
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, 100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

function switchSection(section) {
    try {
        // Update mobile nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            item.setAttribute('aria-selected', 'false');
        });
        
        // Set active nav item
        const activeNavItem = document.getElementById(`nav-${section}`);
        if (activeNavItem) {
            activeNavItem.classList.add('active');
            activeNavItem.setAttribute('aria-selected', 'true');
        }
        
        // Update desktop nav if it exists
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        const activeTab = document.querySelector(`.nav-tab[data-view="${section}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        // Hide all content sections
        document.querySelectorAll('.content-section').forEach(sec => {
            sec.classList.remove('active');
            sec.style.display = 'none';
        });
        
        // Show selected section
        const targetSection = document.getElementById(section);
        if (targetSection) {
            targetSection.classList.add('active');
            targetSection.style.display = 'block';
        }
        
        // Update AppState
        AppState.ui.currentSection = section;
        
        // Load section data based on what's selected
        switch(section) {
            case 'dashboard':
                if (typeof loadDashboard === 'function') {
                    loadDashboard();
                }
                break;
            case 'timesheet':
                if (typeof loadTimesheet === 'function') {
                    loadTimesheet();
                }
                break;
            case 'schedule':
                if (typeof loadSchedule === 'function') {
                    loadSchedule();
                }
                break;
            case 'transfers':
                if (typeof loadTransfers === 'function') {
                    loadTransfers();
                }
                break;
            case 'profile':
                if (typeof loadProfile === 'function') {
                    loadProfile();
                }
                break;
            default:
                console.warn('Unknown section:', section);
        }
        
        // Scroll to top on mobile
        window.scrollTo(0, 0);
        
    } catch (error) {
        console.error('Error switching section:', error);
        showToast('Failed to switch section', 'error');
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        
        // Clear form if exists
        const form = modal.querySelector('form');
        if (form) {
            form.reset();
        }
    }
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
    }
}


        function addButtonStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .btn {
                    padding: 12px 20px;
                    border: none;
                    border-radius: var(--radius-md);
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-size: 14px;
                }
                .btn-primary {
                    background: var(--primary-color);
                    color: white;
                }
                .btn-primary:hover {
                    background: var(--primary-dark);
                }
                .btn-secondary {
                    background: var(--bg-light);
                    color: var(--text-dark);
                }
                .btn-secondary:hover {
                    background: #d0d0d0;
                }
                .btn-sm {
                    padding: 8px 16px;
                    font-size: 12px;
                }
                .btn-outline {
                    background: transparent;
                    border: 1px solid var(--border-color);
                    color: var(--text-dark);
                }
                .btn-outline:hover {
                    background: var(--bg-light);
                }
            `;
            document.head.appendChild(style);
        }

window.testSelectedStaff = async function() {
    const select = document.getElementById('staffTestSelect');
    const staffId = select.value;
    
    console.log('Test selected staff called with ID:', staffId);
    
    if (!staffId) {
        showToast('Please select a staff member', 'warning');
        return;
    }
    
    // First ensure we have the original staff loaded
    if (!AppState.staff.current) {
        console.log('Current staff not loaded, loading first...');
        await ensureStaffLoaded();
        
        if (!AppState.staff.current) {
            showToast('Failed to load your staff data first', 'error');
            return;
        }
    }
    
    // Now switch to test staff
    await switchToStaff(staffId);
    
    // Hide the selector after successful switch
    const selector = document.getElementById('staffSelector');
    if (selector) {
        selector.style.display = 'none';
    }
}

// ==========================================
// ENHANCED: Initialize App with Staff Check
// ==========================================

// Override or enhance the initializeApp function
const originalInitializeApp = window.initializeApp;

window.initializeApp = async function() {
    try {
        console.log('Enhanced initialization starting...');
        
        // Ensure staff is loaded first
        await ensureStaffLoaded();
        
        if (!AppState.staff.current) {
            console.error('Failed to load staff during initialization');
            showToast('Failed to load staff data. Please refresh the page.', 'error');
            return;
        }
        
        // Call original initialization if it exists
        if (typeof originalInitializeApp === 'function') {
            await originalInitializeApp();
        }
        
        // Load reference data if not already loaded
        if (typeof loadReferenceData === 'function') {
            await loadReferenceData();
        }
        
        console.log('Enhanced initialization complete');
        
    } catch (error) {
        console.error('Enhanced initialization error:', error);
        showToast('Initialization failed: ' + error.message, 'error');
    }
}

// ==========================================
// FIX: Add Staff Selector with Proper Check
// ==========================================

window.addStaffSelector = async function() {
    try {
        console.log('Adding staff selector...');
        
        // First ensure current staff is loaded
        if (!AppState.staff.current) {
            await ensureStaffLoaded();
            if (!AppState.staff.current) {
                console.error('Cannot add staff selector - no current staff');
                return;
            }
        }
        
        // Load all staff members
        const { data: allStaff, error } = await supabaseClient
            .from('staff')
            .select('id, first_name, last_name, email')
            .eq('is_active', true)
            .order('first_name');
        
        if (error) throw error;
        
        // Remove existing selector if present
        const existingSelector = document.getElementById('staffSelector');
        if (existingSelector) {
            existingSelector.remove();
        }
        
        // Create the selector UI
        const selectorHTML = `
            <div id="staffSelector" style="
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 9999;
                max-width: 300px;
                display: none;
            ">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333;">
                    🧪 Test as Different Staff:
                </div>
                <div style="margin-bottom: 5px; font-size: 12px; color: #666;">
                    Currently: ${AppState.staff.current.first_name} ${AppState.staff.current.last_name}
                </div>
                <select id="staffTestSelect" style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    margin-bottom: 10px;
                ">
                    <option value="">-- Select Staff Member --</option>
                    ${allStaff.map(s => `
                        <option value="${s.id}" ${s.id === AppState.staff.current.id ? 'disabled' : ''}>
                            ${s.first_name} ${s.last_name} 
                            ${s.id === AppState.staff.current.id ? '(You)' : ''}
                        </option>
                    `).join('')}
                </select>
                <button onclick="testSelectedStaff()" style="
                    width: 100%;
                    padding: 8px;
                    background: #004990;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                ">Switch View</button>
                <button onclick="document.getElementById('staffSelector').style.display='none'" style="
                    width: 100%;
                    padding: 8px;
                    background: #f0f0f0;
                    color: #666;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    margin-top: 5px;
                    font-size: 12px;
                ">Hide</button>
            </div>
        `;
        
        // Add to page
        document.body.insertAdjacentHTML('beforeend', selectorHTML);
        console.log('Staff selector added successfully');
        
    } catch (error) {
        console.error('Error loading staff list:', error);
        showToast('Failed to load staff list', 'error');
    }
}


        </script>
        </body>
        </html>

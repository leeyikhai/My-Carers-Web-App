
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Portal - MC Care</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="utf-8">
    <title>My Carers</title>
  
    <!-- favicon links -->
    <link rel="icon" type="image/png" sizes="16x16" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-32x32.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        
        :root {
            --primary-color: #004990;
            --primary-dark: #003670;
            --primary-light: #0056b3;
            --success-color: #88a542;
            --info-color: #359dca;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f8f9fa;
            --bg-dark: #1a2332;
            --border-color: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 70px; /* Space for mobile nav */
        }

        /* Header with Profile Banner */
        .header {
            background: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .profile-banner {
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .profile-banner-upload {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: var(--radius-md);
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .profile-info {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .user-details h2 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .user-role {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: var(--text-light);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item .badge {
            position: absolute;
            top: 4px;
            right: calc(50% - 20px);
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 16px;
        }

        /* Content Sections */
        .content-section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .dashboard-header {
            margin-bottom: 20px;
        }

        .greeting {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .date-display {
            color: var(--text-light);
            font-size: 14px;
        }

        .shift-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .shift-card:active {
            transform: scale(0.98);
        }

        .shift-card-header {
            padding: 20px;
            position: relative;
        }

        .shift-time {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .shift-participant {
            font-size: 16px;
            opacity: 0.95;
            margin-bottom: 4px;
        }

        .shift-location {
            font-size: 14px;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shift-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .shift-expand-icon {
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .shift-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(255,255,255,0.95);
            color: var(--text-dark);
        }

        .shift-card.expanded .shift-details {
            max-height: 500px;
        }

        .shift-card.expanded .shift-expand-icon {
            transform: rotate(180deg);
        }

        .handover-section {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .handover-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .handover-note {
            background: var(--bg-light);
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .handover-author {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .quick-action-btn:active {
            transform: scale(0.95);
            background: var(--bg-light);
        }

        .quick-action-btn .icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        /* Requests Summary */
        .requests-summary {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .requests-summary h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-dark);
        }

        .request-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-type {
            font-size: 14px;
            font-weight: 500;
        }

        .request-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-denied {
            background: #f8d7da;
            color: #721c24;
        }

        /* Timesheet View */
        .period-selector {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .period-display {
            text-align: center;
            flex: 1;
        }

        .period-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .period-dates {
            font-size: 16px;
            font-weight: 600;
        }

        .period-nav {
            padding: 8px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
        }

        /* Timesheet Summary */
        .timesheet-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .timesheet-summary h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        .hours-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .hour-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: var(--radius-md);
        }

        .hour-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .hour-value {
            font-size: 20px;
            font-weight: 600;
        }

        .total-section {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 16px;
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 600;
        }

        /* Shift List */
        .shift-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .shift-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .shift-list-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-list-item:last-child {
            border-bottom: none;
        }

        .shift-info {
            flex: 1;
        }

        .shift-date-time {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .shift-client {
            font-size: 14px;
            color: var(--text-light);
        }

        .shift-hours {
            text-align: right;
        }

        .shift-hours-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .shift-pay {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Schedule View */
        .calendar-header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .participant-filter {
            margin-bottom: 12px;
        }

        .participant-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: white;
        }

        .date-range-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-light);
            margin-top: 12px;
        }

        .schedule-grid {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .day-section {
            border-bottom: 1px solid var(--border-color);
        }

        .day-section:last-child {
            border-bottom: none;
        }

        .day-header {
            background: var(--bg-light);
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-date {
            font-size: 14px;
        }

        .fortnight-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--border-color);
    margin-top: 20px;
}

.schedule-day {
    background: white;
    min-height: 100px;
    padding: 8px;
}

.schedule-day.weekend {
    background: #f8f9fa;
}

.schedule-day.today {
    background: #e3f2fd;
}

.day-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border-color);
}

.day-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--text-light);
}

.day-date {
    font-weight: 600;
    font-size: 14px;
}

.shift-block {
    background: var(--primary-color);
    color: white;
    padding: 4px 6px;
    border-radius: 4px;
    margin-bottom: 4px;
    font-size: 11px;
}

.no-shift {
    color: var(--text-light);
    font-size: 11px;
    text-align: center;
    margin-top: 10px;
}

        .day-shift-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .day-shifts {
            padding: 8px;
        }

        .schedule-shift {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-shift:last-child {
            margin-bottom: 0;
        }

        .schedule-shift-time {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .schedule-shift-staff {
            font-size: 13px;
            color: var(--text-light);
        }

        .schedule-shift-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .action-btn.secondary {
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        /* Transfers View */
        .transfer-tabs {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 16px;
            display: flex;
            box-shadow: var(--shadow-sm);
        }

        .transfer-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            font-weight: 500;
            transition: all 0.3s;
        }

        .transfer-tab:last-child {
            border-right: none;
        }

        .transfer-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .transfer-list {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .transfer-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .transfer-item:last-child {
            margin-bottom: 0;
        }

        .transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .transfer-date {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .transfer-time {
            font-size: 14px;
            color: var(--text-light);
        }

        .transfer-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .transfer-from {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .transfer-reason {
            font-size: 13px;
            color: var(--text-light);
            font-style: italic;
            padding: 8px;
            background: white;
            border-radius: var(--radius-sm);
            margin-top: 8px;
        }

        .transfer-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .transfer-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .transfer-btn.accept {
            background: var(--success-color);
            color: white;
        }

        .transfer-btn.decline {
            background: white;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        /* Profile View */
        .profile-section {
            background: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .profile-section-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-btn {
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .profile-content {
            padding: 16px;
        }

        .profile-field {
            margin-bottom: 16px;
        }

        .profile-field:last-child {
            margin-bottom: 0;
        }

        .field-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .field-value {
            font-size: 16px;
            color: var(--text-dark);
        }

        .field-value input,
        .field-value select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 16px;
        }

        /* Documents Section */
        .document-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .document-upload-area:hover {
            border-color: var(--primary-color);
            background: var(--bg-light);
        }

        .document-list {
            display: grid;
            gap: 12px;
        }

        .document-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 12px;
            color: var(--text-light);
        }

        .document-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Availability Pattern */
        .availability-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 16px;
        }

        .availability-day {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .availability-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .day-name {
            font-weight: 600;
        }

        .availability-toggle {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .availability-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        .availability-toggle input:checked + .toggle-slider {
            background: var(--success-color);
        }

        .availability-toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .availability-times {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .time-slot {
            padding: 8px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Modal System */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 73, 144, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Image Upload for Notes */
        .image-upload-area {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        .add-image-btn {
            width: 60px;
            height: 60px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-light);
        }

        /* Notifications */
        .notification-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .notification-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.unread {
            background: #f0f8ff;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-icon.info {
            background: #cce5ff;
            color: #004085;
        }

        .notification-icon.success {
            background: #d4edda;
            color: #155724;
        }

        .notification-icon.warning {
            background: #fff3cd;
            color: #856404;
        }

        .notification-content {
            flex: 1;
        }

        .notification-message {
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            animation: slideUp 0.3s ease-out;
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* Desktop Responsiveness */
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }

            .mobile-nav {
                display: none;
            }

            .desktop-nav {
                display: flex;
                background: white;
                border-bottom: 1px solid var(--border-color);
                padding: 0 20px;
            }

            .desktop-nav .nav-item {
                padding: 16px 24px;
                border-bottom: 3px solid transparent;
                transition: all 0.3s;
            }

            .desktop-nav .nav-item.active {
                border-bottom-color: var(--primary-color);
            }

            .content-section {
                max-width: 1200px;
                margin: 0 auto;
                padding: 40px;
            }

            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }

            .hours-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .document-list {
                grid-template-columns: repeat(2, 1fr);
            }

            .availability-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 600; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .p-2 { padding: 16px; }
        .hidden { display: none; }

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.form-legend {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--text-dark);
    border: none;
    padding: 0;
}

.form-help {
    display: block;
    margin-top: 4px;
    font-size: 12px;
    color: var(--text-light);
}

.error-message {
    display: none;
    margin-top: 4px;
    font-size: 12px;
    color: var(--danger-color);
    font-weight: 500;
}

.error-message.show {
    display: block;
}

.form-control:invalid {
    border-color: var(--danger-color);
}

.form-control:invalid + .error-message {
    display: block;
}

/* Navigation improvements */
.nav-item {
    border: none;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s;
}

.nav-item:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

.nav-item[aria-selected="true"] {
    color: var(--primary-color);
}

/* Modal improvements */
.modal[aria-hidden="true"] {
    display: none;
}

.modal[aria-hidden="false"] {
    display: flex;
}

.modal-close:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* Header improvements */
.header {
    background: white;
    border-bottom: 1px solid var(--border-color);
    padding: 0;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.logo img {
    max-height: 40px;
    width: auto;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-name {
    font-weight: 500;
    color: var(--text-dark);
}

.user-role {
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
}

/* Image upload improvements */
.add-image-btn {
    width: 60px;
    height: 60px;
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 24px;
    color: var(--text-light);
}

.add-image-btn:hover,
.add-image-btn:focus {
    border-color: var(--primary-color);
    color: var(--primary-color);
    outline: none;
}

.image-upload-area {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 8px;
}

#imagePreviewContainer {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.image-preview {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius-md);
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
}

.image-preview:hover {
    border-color: var(--danger-color);
    opacity: 0.8;
}

.weekly-schedule {
    background: white;
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.day-section {
    border-bottom: 1px solid var(--border-color);
}

.day-section:last-child {
    border-bottom: none;
}

.day-section.today {
    background: #f0f8ff;
}

.day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--bg-light);
    border-bottom: 1px solid var(--border-color);
}

.day-name {
    font-weight: 600;
    font-size: 16px;
}

.shift-count {
    background: var(--primary-color);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.shift-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light);
    transition: background 0.2s;
}

.shift-item:hover {
    background: var(--bg-light);
}

.shift-item:last-child {
    border-bottom: none;
}

.no-shifts {
    padding: 20px;
    text-align: center;
    color: var(--text-light);
    font-style: italic;
}

.shift-history-item {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
}

.shift-date-header {
    font-weight: 600;
    margin-bottom: 8px;
}
    </style>

    
</head>
<body>
     <!-- Header with Profile Banner -->
     <header class="header">
        <div class="profile-banner" id="profileBanner">
            <div class="profile-banner-upload" id="bannerUploadBtn">
                📷 Change Banner
            </div>
            <input type="file" id="bannerUpload" accept="image/*" style="display: none;">
        </div>
        <div class="profile-info">
            <div class="user-details">
                <h2 id="userName">Loading...</h2>
                <span class="user-role" id="userRole">Staff</span>
            </div>
            <button class="btn btn-sm btn-outline" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Desktop Navigation (hidden on mobile) -->
    <nav class="desktop-nav hidden">
        <button class="nav-item" onclick="switchSection('dashboard')" 
                aria-label="Navigate to dashboard" 
                role="tab" 
                aria-selected="true">
            <div class="icon"><i class="fa-solid fa-house" aria-hidden="true"></i></div>
            <div>Home</div>
        </button>
        <div class="nav-item" onclick="switchSection('timesheet')">
            <span>Timesheet</span>
        </div>
        <div class="nav-item" onclick="switchSection('schedule')">
            <span>Schedule</span>
        </div>
        <div class="nav-item" onclick="switchSection('transfers')">
            <span>Transfers</span>
        </div>
        <div class="nav-item" onclick="switchSection('profile')">
            <span>Profile</span>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboard" class="content-section active">
        <div class="dashboard-header">
            <div class="greeting" id="greeting">Good morning!</div>
            <div class="date-display" id="currentDate">Monday, 5 January 2025</div>
        </div>

        <!-- Current/Upcoming Shift -->
        <div id="currentShift">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action-btn" onclick="showAddShiftModal()">
                <span class="icon"><i class="fa-solid fa-plus"></i></span>
                <span>Add Shift</span>
            </div>
            <div class="quick-action-btn" onclick="showTransferModal()">
                <span class="icon"><i class="fa-solid fa-arrow-right-arrow-left"></i></span>
                <span>Transfer Shift</span>
            </div>
            <div class="quick-action-btn" onclick="showAdjustmentModal()">
                <span class="icon"><i class="fa-solid fa-clock"></i></span>
                <span>Adjust Time</span>
            </div>
            <div class="quick-action-btn" onclick="showLeaveModal()">
                <span class="icon"><i class="fa-solid fa-umbrella-beach"></i></span>
                <span>Request Leave</span>
            </div>
        </div>
    
        <!-- Pending Requests Summary -->
        <div class="requests-summary">
            <h3>Pending Requests</h3>
            <div id="pendingRequestsList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Recent Notifications -->
        <div class="requests-summary">
            <h3>Recent Updates</h3>
            <div id="recentNotifications">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Timesheet Section -->
    <div id="timesheet" class="content-section">
        <div class="period-selector">
            <button class="period-nav" onclick="changePeriod(-1)">◀</button>
            <div class="period-display">
                <div class="period-label">Pay Period</div>
                <div class="period-dates" id="periodDates">28 Jul - 10 Aug 2025</div>
            </div>
            <button class="period-nav" onclick="changePeriod(1)">▶</button>
        </div>

        <!-- Hours Summary -->
        <div class="timesheet-summary">
            <h3>Hours Breakdown</h3>
            <div class="hours-grid" id="hoursGrid">
                <!-- Will be populated dynamically -->
            </div>
            <div class="total-section">
                <span>Total Hours</span>
                <span id="totalHours">0.0h</span>
            </div>
        </div>

        <!-- Shift List with Toggle -->
        <div class="shift-list">
            <div class="shift-list-header">
                <h3>Shifts</h3>
                <div class="view-toggle">
                    <button class="toggle-btn active" onclick="toggleTimesheetView('date')">By Date</button>
                    <button class="toggle-btn" onclick="toggleTimesheetView('participant')">By Client</button>
                </div>
            </div>
            <div id="timesheetShifts">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Schedule Section -->
    <div id="schedule" class="content-section">
        <div class="calendar-header">
            <div class="participant-filter">
                <label class="field-label">Filter by Client</label>
                <select class="participant-select" id="participantFilter" onchange="filterSchedule()">
                    <option value="">All My Clients</option>
                </select>
            </div>
            <div class="date-range-info">
                <span>📅</span>
                <span>Showing 2 weeks before and after today</span>
            </div>
        </div>

        <div class="schedule-grid" id="scheduleGrid">
            <!-- Will be populated dynamically -->
        </div>
    </div>

    <!-- Transfers Section -->
    <div id="transfers" class="content-section">
        <div class="transfer-tabs">
            <div class="transfer-tab active" onclick="switchTransferTab('incoming')">
                Incoming Requests
                <span class="badge" id="incomingCount">0</span>
            </div>
            <div class="transfer-tab" onclick="switchTransferTab('outgoing')">
                My Requests
            </div>
            <div class="transfer-tab" onclick="switchTransferTab('available')">
                Available Shifts
            </div>
        </div>

        <div id="incomingTransfers" class="transfer-content active">
            <div class="transfer-list" id="incomingList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <div id="outgoingTransfers" class="transfer-content">
            <div class="transfer-list" id="outgoingList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <div id="availableTransfers" class="transfer-content">
            <div class="transfer-list" id="availableList">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Profile Section -->
    <div id="profile" class="content-section">
        <!-- Personal Information -->
        <div class="profile-section">
            <div class="profile-section-header">
                Personal Information
                <button class="edit-btn" onclick="editPersonalInfo()">Edit</button>
            </div>
            <div class="profile-content" id="personalInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Contact Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Contact Details
                <button class="edit-btn" onclick="editContactInfo()">Edit</button>
            </div>
            <div class="profile-content" id="contactInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Banking Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Banking & Super
                <button class="edit-btn" onclick="editBankingInfo()">Edit</button>
            </div>
            <div class="profile-content" id="bankingInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Documents -->
        <div class="profile-section">
            <div class="profile-section-header">
                Documents
            </div>
            <div class="profile-content">
                <div class="document-upload-area" onclick="showDocumentUploadModal()">
                    <div>📎 Upload Document</div>
                    <div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                        Click to upload certifications, ID, checks, etc.
                    </div>
                </div>
                <div class="document-list" id="documentList">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Availability Pattern -->
        <div class="profile-section">
            <div class="profile-section-header">
                Weekly Availability
                <button class="edit-btn" onclick="saveAvailability()">Save</button>
            </div>
            <div class="profile-content">
                <div class="availability-grid" id="availabilityGrid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav" role="tablist" aria-label="Main navigation">
        <button class="nav-item active" 
                onclick="switchSection('dashboard')" 
                aria-label="Navigate to dashboard" 
                role="tab" 
                aria-selected="true"
                id="nav-dashboard">
            <div class="icon"><i class="fa-solid fa-house" aria-hidden="true"></i></div>
            <div>Home</div>
            <span class="badge hidden" id="homeBadge" aria-label="pending items">1</span>
        </button>
        
        <button class="nav-item" 
                onclick="switchSection('timesheet')" 
                aria-label="Navigate to timesheet" 
                role="tab" 
                aria-selected="false"
                id="nav-timesheet">
            <div class="icon"><i class="fa-solid fa-chart-bar" aria-hidden="true"></i></div>
            <div>Timesheet</div>
        </button>
        
        <button class="nav-item" 
                onclick="switchSection('schedule')" 
                aria-label="Navigate to schedule" 
                role="tab" 
                aria-selected="false"
                id="nav-schedule">
            <div class="icon"><i class="fa-solid fa-calendar-days" aria-hidden="true"></i></div>
            <div>Schedule</div>
        </button>
        
        <button class="nav-item" 
                onclick="switchSection('transfers')" 
                aria-label="Navigate to transfers" 
                role="tab" 
                aria-selected="false"
                id="nav-transfers">
            <div class="icon"><i class="fa-solid fa-arrow-right-arrow-left" aria-hidden="true"></i></div>
            <div>Transfers</div>
            <span class="badge hidden" id="transferBadge" aria-label="pending transfers">0</span>
        </button>
        
        <button class="nav-item" 
                onclick="switchSection('profile')" 
                aria-label="Navigate to profile" 
                role="tab" 
                aria-selected="false"
                id="nav-profile">
            <div class="icon"><i class="fa-solid fa-user" aria-hidden="true"></i></div>
            <div>Profile</div>
        </button>
    </nav>

    <!-- MODALS SECTION -->

    <!-- Add Shift Modal -->
    <div id="addShiftModal" class="modal" role="dialog" aria-labelledby="addShiftTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="addShiftTitle" class="modal-title">Add New Shift</h3>
                <button class="modal-close" 
                        onclick="closeModal('addShiftModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="addShiftForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Shift Details</legend>
                        
                        <div class="form-group">
                            <label for="shiftDate" class="form-label">Date *</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="shiftDate" 
                                   name="shiftDate"
                                   required 
                                   aria-describedby="shiftDate-error">
                            <div id="shiftDate-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="shiftParticipant" class="form-label">Client *</label>
                            <select class="form-control" 
                                    id="shiftParticipant" 
                                    name="shiftParticipant"
                                    required 
                                    aria-describedby="shiftParticipant-error">
                                <option value="">Select Client</option>
                            </select>
                            <div id="shiftParticipant-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="shiftDutyType" class="form-label">Shift Type *</label>
                            <select class="form-control" 
                                    id="shiftDutyType" 
                                    name="shiftDutyType"
                                    required 
                                    onchange="toggleTimeFields()"
                                    aria-describedby="shiftDutyType-error">
                                <option value="">Select Type</option>
                            </select>
                            <div id="shiftDutyType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset id="timeFields">
                            <legend class="sr-only">Shift Times</legend>
                            
                            <div class="form-group">
                                <label for="shiftStartTime" class="form-label">Start Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="shiftStartTime" 
                                       name="shiftStartTime"
                                       aria-describedby="shiftStartTime-help">
                                <small id="shiftStartTime-help" class="form-help">Leave blank for sleepover shifts</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="shiftEndTime" class="form-label">End Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="shiftEndTime" 
                                       name="shiftEndTime"
                                       aria-describedby="shiftEndTime-help">
                                <small id="shiftEndTime-help" class="form-help">Leave blank for sleepover shifts</small>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="shiftNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" 
                                      id="shiftNotes" 
                                      name="shiftNotes"
                                      placeholder="Any additional information..."
                                      rows="3"
                                      aria-describedby="shiftNotes-help"></textarea>
                            <small id="shiftNotes-help" class="form-help">Additional details about the shift</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('addShiftModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="submitShift()" form="addShiftForm">
                    Submit for Approval
                </button>
            </footer>
        </div>
    </div>

    <!-- Transfer Shift Modal -->
    <div id="transferShiftModal" class="modal" role="dialog" aria-labelledby="transferShiftTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="transferShiftTitle" class="modal-title">Transfer Shift</h3>
                <button class="modal-close" 
                        onclick="closeModal('transferShiftModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="transferForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Transfer Details</legend>
                        
                        <div class="form-group">
                            <label for="transferShiftSelect" class="form-label">Select Shift to Transfer *</label>
                            <select class="form-control" 
                                    id="transferShiftSelect" 
                                    name="transferShiftSelect"
                                    required 
                                    aria-describedby="transferShiftSelect-error">
                                <option value="">Select a shift</option>
                            </select>
                            <div id="transferShiftSelect-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="transferToStaff" class="form-label">Transfer To *</label>
                            <select class="form-control" 
                                    id="transferToStaff" 
                                    name="transferToStaff"
                                    required 
                                    aria-describedby="transferToStaff-error transferToStaff-help">
                                <option value="">Select staff member</option>
                            </select>
                            <small id="transferToStaff-help" class="form-help">Choose the staff member to transfer this shift to</small>
                            <div id="transferToStaff-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="transferReason" class="form-label">Reason *</label>
                            <textarea class="form-control" 
                                      id="transferReason" 
                                      name="transferReason"
                                      required 
                                      placeholder="Please provide a reason for the transfer..."
                                      rows="3"
                                      aria-describedby="transferReason-error transferReason-help"></textarea>
                            <small id="transferReason-help" class="form-help">Explain why you need to transfer this shift</small>
                            <div id="transferReason-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('transferShiftModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="submitTransfer()" form="transferForm">
                    Send Transfer Request
                </button>
            </footer>
        </div>
    </div>

    <!-- Time Adjustment Modal -->
    <div id="adjustmentModal" class="modal" role="dialog" aria-labelledby="adjustmentTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="adjustmentTitle" class="modal-title">Request Time Adjustment</h3>
                <button class="modal-close" 
                        onclick="closeModal('adjustmentModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="adjustmentForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Time Adjustment Details</legend>
                        
                        <div class="form-group">
                            <label for="adjustmentShift" class="form-label">Select Shift *</label>
                            <select class="form-control" 
                                    id="adjustmentShift" 
                                    name="adjustmentShift"
                                    required 
                                    onchange="loadShiftTimes()"
                                    aria-describedby="adjustmentShift-error">
                                <option value="">Select a shift</option>
                            </select>
                            <div id="adjustmentShift-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset>
                            <legend class="form-legend">New Times</legend>
                            
                            <div class="form-group">
                                <label for="adjustmentStartTime" class="form-label">New Start Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="adjustmentStartTime" 
                                       name="adjustmentStartTime"
                                       aria-describedby="adjustmentStartTime-help">
                                <small id="adjustmentStartTime-help" class="form-help">Current time will be shown when shift is selected</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="adjustmentEndTime" class="form-label">New End Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="adjustmentEndTime" 
                                       name="adjustmentEndTime"
                                       aria-describedby="adjustmentEndTime-help">
                                <small id="adjustmentEndTime-help" class="form-help">Current time will be shown when shift is selected</small>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="adjustmentReason" class="form-label">Reason for Adjustment *</label>
                            <textarea class="form-control" 
                                      id="adjustmentReason" 
                                      name="adjustmentReason"
                                      required 
                                      placeholder="Please explain the time adjustment..."
                                      rows="3"
                                      aria-describedby="adjustmentReason-error adjustmentReason-help"></textarea>
                            <small id="adjustmentReason-help" class="form-help">Explain why the times need to be adjusted</small>
                            <div id="adjustmentReason-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('adjustmentModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="submitAdjustment()" form="adjustmentForm">
                    Submit Request
                </button>
            </footer>
        </div>
    </div>

    <!-- Leave Request Modal -->
    <div id="leaveModal" class="modal" role="dialog" aria-labelledby="leaveTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="leaveTitle" class="modal-title">Request Leave</h3>
                <button class="modal-close" 
                        onclick="closeModal('leaveModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="leaveForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Leave Request Details</legend>
                        
                        <div class="form-group">
                            <label for="leaveType" class="form-label">Leave Type *</label>
                            <select class="form-control" 
                                    id="leaveType" 
                                    name="leaveType"
                                    required 
                                    aria-describedby="leaveType-error">
                                <option value="">Select type</option>
                                <option value="annual">Annual Leave</option>
                                <option value="sick">Sick Leave</option>
                                <option value="personal">Personal Leave</option>
                                <option value="unpaid">Unpaid Leave</option>
                            </select>
                            <div id="leaveType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset>
                            <legend class="form-legend">Leave Dates</legend>
                            
                            <div class="form-group">
                                <label for="leaveStartDate" class="form-label">Start Date *</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="leaveStartDate" 
                                       name="leaveStartDate"
                                       required 
                                       aria-describedby="leaveStartDate-error">
                                <div id="leaveStartDate-error" class="error-message" role="alert" aria-live="polite"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="leaveEndDate" class="form-label">End Date *</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="leaveEndDate" 
                                       name="leaveEndDate"
                                       required 
                                       aria-describedby="leaveEndDate-error">
                                <div id="leaveEndDate-error" class="error-message" role="alert" aria-live="polite"></div>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="leaveReason" class="form-label">Reason</label>
                            <textarea class="form-control" 
                                      id="leaveReason" 
                                      name="leaveReason"
                                      placeholder="Optional: Provide additional details..."
                                      rows="3"
                                      aria-describedby="leaveReason-help"></textarea>
                            <small id="leaveReason-help" class="form-help">Additional details about your leave request</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('leaveModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="submitLeave()" form="leaveForm">
                    Submit Request
                </button>
            </footer>
        </div>
    </div>

    <!-- Document Upload Modal -->
    <div id="documentUploadModal" class="modal" role="dialog" aria-labelledby="documentUploadTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="documentUploadTitle" class="modal-title">Upload Document</h3>
                <button class="modal-close" 
                        onclick="closeModal('documentUploadModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="documentUploadForm" enctype="multipart/form-data" novalidate>
                    <fieldset>
                        <legend class="sr-only">Document Information</legend>
                        
                        <div class="form-group">
                            <label for="documentType" class="form-label">Document Type *</label>
                            <select class="form-control" 
                                    id="documentType" 
                                    name="documentType"
                                    required 
                                    onchange="checkExpiryRequired()"
                                    aria-describedby="documentType-error">
                                <option value="">Select type</option>
                                <option value="id">Photo ID</option>
                                <option value="resume">Resume/CV</option>
                                <option value="visa">Visa/Work Permit</option>
                                <option value="firstaid">First Aid/CPR Certificate</option>
                                <option value="wwcc">Working with Children Check</option>
                                <option value="police">Police Check</option>
                                <option value="ndis">NDIS Worker Check</option>
                                <option value="other">Other</option>
                            </select>
                            <div id="documentType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentTitle" class="form-label">Document Title *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="documentTitle" 
                                   name="documentTitle"
                                   required 
                                   placeholder="e.g., Driver's License"
                                   aria-describedby="documentTitle-error">
                            <div id="documentTitle-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group" id="expiryGroup">
                            <label for="documentExpiry" class="form-label">Expiry Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="documentExpiry" 
                                   name="documentExpiry"
                                   aria-describedby="documentExpiry-help">
                            <small id="documentExpiry-help" class="form-help">Required for certain document types</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentFile" class="form-label">Select File *</label>
                            <input type="file" 
                                   class="form-control" 
                                   id="documentFile" 
                                   name="documentFile"
                                   required 
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   aria-describedby="documentFile-error documentFile-help">
                            <small id="documentFile-help" class="form-help">Max 10MB. PDF, JPG, PNG accepted.</small>
                            <div id="documentFile-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentNotes" class="form-label">Notes</label>
                            <textarea class="form-control" 
                                      id="documentNotes" 
                                      name="documentNotes"
                                      placeholder="Optional notes..."
                                      rows="3"
                                      aria-describedby="documentNotes-help"></textarea>
                            <small id="documentNotes-help" class="form-help">Additional information about the document</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('documentUploadModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="uploadDocument()" form="documentUploadForm">
                    Upload
                </button>
            </footer>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="addNoteModal" class="modal" role="dialog" aria-labelledby="addNoteTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="addNoteTitle" class="modal-title">Add Shift Note</h3>
                <button class="modal-close" 
                        onclick="closeModal('addNoteModal')" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="noteForm" novalidate>
                    <input type="hidden" id="noteShiftId" name="noteShiftId">
                    
                    <fieldset>
                        <legend class="sr-only">Note Details</legend>
                        
                        <div class="form-group">
                            <label for="noteType" class="form-label">Note Type *</label>
                            <select class="form-control" 
                                    id="noteType" 
                                    name="noteType"
                                    required 
                                    aria-describedby="noteType-error noteType-help">
                                <option value="shift">Shift Note (Visible to Manager)</option>
                                <option value="handover">Handover Note (Staff Only)</option>
                                <option value="incident">Incident Report</option>
                            </select>
                            <small id="noteType-help" class="form-help">Choose the appropriate note type</small>
                            <div id="noteType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="noteContent" class="form-label">Note *</label>
                            <textarea class="form-control" 
                                      id="noteContent" 
                                      name="noteContent"
                                      required 
                                      placeholder="Enter your note..."
                                      rows="4"
                                      aria-describedby="noteContent-error"></textarea>
                            <div id="noteContent-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset class="form-group">
                            <legend class="form-label">Attach Images</legend>
                            <div class="image-upload-area" role="region" aria-label="Image upload area">
                                <button type="button" 
                                        class="add-image-btn" 
                                        onclick="document.getElementById('noteImages').click()"
                                        aria-label="Add images">
                                    <i class="fa-solid fa-plus" aria-hidden="true"></i>
                                </button>
                                <div id="imagePreviewContainer" 
                                     role="region" 
                                     aria-label="Image previews"
                                     aria-live="polite"></div>
                            </div>
                            <input type="file" 
                                   id="noteImages" 
                                   name="noteImages"
                                   multiple 
                                   accept="image/*" 
                                   style="display: none;" 
                                   onchange="previewImages()"
                                   aria-describedby="noteImages-help">
                            <small id="noteImages-help" class="form-help">Optional: Add up to 5 images</small>
                        </fieldset>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" onclick="closeModal('addNoteModal')">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" onclick="submitNote()" form="noteForm">
                    Add Note
                </button>
            </footer>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://gqchhsayqxttewthcsah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxY2hoc2F5cXh0dGV3dGhjc2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTA0ODksImV4cCI6MjA3MjI2NjQ4OX0.iAGhrDZaHkpLwjJY07o-73l2OiePB2x1ZnnTEfUBd_M';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        //DAY OFFSETTER!
        const DATE_OFFSET_DAYS = -21; // Set to 0 to disable testing mode
        const PERIOD_LENGTH = 14; // 14-day pay periods
        const PAY_PERIOD_START = new Date('2024-07-28')
        // Global State
        let currentUser = null;
        let currentStaff = null;
        let allShifts = [];
        let myShifts = [];
        let participants = [];
        let staff = [];
        let dutyTypes = [];
        let locations = [];
        let notifications = [];
        let documents = [];
        let selectedImages = [];
        let currentPeriodStart = null;
        let currentPeriodEnd = null;
        let timesheetView = 'date';
        let weeklyAvailability = {};


        function getTestDate() {
    const date = new Date();
    date.setDate(date.getDate() + DATE_OFFSET_DAYS);
    return date;
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('Initializing application...');
        
        // Phase 1: Create DOM elements
        createStaffSelector();
        createMissingModals();
        if (typeof addButtonStyles === 'function') {
            addButtonStyles();
        }
        
        // Phase 2: Initialize app
        await initializeApp();
        await ensureStaffLoaded();
        
        // Phase 3: Setup all event listeners
        setupAllEventListeners();
        
        // Phase 4: Post-init tasks (with delay)
        setTimeout(async () => {
            if (AppState.staff.current) {
                await addStaffSelector();
                const selector = document.getElementById('staffSelector');
                if (selector) {
                    selector.style.display = 'block';
                }
            }
        }, 2000);
        
        // Phase 5: Initialize features
        window.currentPeriodOffset = 0;
        if (typeof setCurrentPayPeriod === 'function') {
            setCurrentPayPeriod();
        }
        
        console.log('Application ready');
        
    } catch (error) {
        console.error('Initialization failed:', error);
        showToast('Failed to start application', 'error');
    }
});

// 2. CONSOLIDATED Event Listener Setup
function setupAllEventListeners() {
    console.log('Setting up all event listeners...');
    
    // Quick Actions
    setupQuickActions();
    
    // Navigation
    setupNavigation();
    
    // Forms
    setupForms();
    
    // Modals
    setupModals();
    
    // Edit/Save Buttons
    setupEditButtons();
    
    // File Uploads
    setupFileUploads();
    
    // Keyboard Shortcuts
    setupKeyboardShortcuts();
    
    // Timesheet Controls
    setupTimesheetControls();
    
    console.log('Event listeners ready');
}

// 3. ORGANIZED Event Handler Groups

function setupQuickActions() {
    const quickActions = {
        'quickAddShift': showAddShiftModal,
        'quickTransfer': showTransferModal,
        'quickAdjustment': showAdjustmentModal,
        'quickLeave': showLeaveModal
    };
    
    Object.entries(quickActions).forEach(([id, handler]) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.onclick = handler;
        }
    });
}

function setupNavigation() {
    // Tab navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const view = this.getAttribute('data-view');
            if (view) switchView(view);
        });
    });
    
    // View selector
    const viewSelector = document.getElementById('viewSelector');
    if (viewSelector) {
        viewSelector.addEventListener('change', (e) => switchView(e.target.value));
    }
}

function setupForms() {
    const forms = {
        'noteForm': submitNote,
        'addShiftForm': submitShift,
        'transferForm': submitTransfer,
        'adjustmentForm': submitAdjustment,
        'leaveForm': submitLeave
    };
    
    Object.entries(forms).forEach(([id, handler]) => {
        const form = document.getElementById(id);
        if (form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                handler();
            });
        }
    });
}

async function loadAvailableTransfers() {
    try {
        const container = document.getElementById('availableList');
        if (!container) return;
        
        // Load shifts that are unassigned or available for pickup
        const { data: availableShifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                locations(name, address),
                duty_types(name)
            `)
            .is('staff_id', null) // Unassigned shifts
            .gte('date', getTestDate().toISOString().split('T')[0])
            .order('date', { ascending: true })
            .limit(20);
        
        if (error) {
            console.error('Error loading available shifts:', error);
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">Failed to load available shifts</div>';
            return;
        }
        
        if (!availableShifts || availableShifts.length === 0) {
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No available shifts at this time</div>';
            return;
        }
        
        // Render available shifts
        container.innerHTML = availableShifts.map(shift => `
            <div class="transfer-item">
                <div class="transfer-header">
                    <div>
                        <div class="transfer-date">${formatDateLong(shift.date)}</div>
                        <div class="transfer-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="claimShift('${shift.id}')">
                        Claim Shift
                    </button>
                </div>
                <div class="transfer-from">
                    Client: ${shift.participants ? 
                        `${shift.participants.first_name} ${shift.participants.last_name}` : 
                        'Unassigned'}
                </div>
                <div class="transfer-from">
                    Location: ${shift.locations?.name || 'Client Home'}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error in loadAvailableTransfers:', error);
        showToast('Failed to load available shifts', 'error');
    }
}

function filterSchedule() {
    const filterValue = document.getElementById('participantFilter').value;
    // Re-render schedule with filter
    loadSchedule(); // This should use the filter value
}
// Also add the claim shift function
async function claimShift(shiftId) {
    try {
        if (!confirm('Do you want to claim this shift?')) return;
        
        const { error } = await supabaseClient
            .from('shifts')
            .update({ staff_id: AppState.staff.current.id })
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showToast('Shift claimed successfully', 'success');
        loadAvailableTransfers(); // Reload the list
        
    } catch (error) {
        console.error('Error claiming shift:', error);
        showToast('Failed to claim shift', 'error');
    }
}

function setupModals() {
    // Close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) closeModal(modal.id);
        });
    });
    
    // Cancel buttons
    document.querySelectorAll('.modal .btn-secondary').forEach(btn => {
        if (btn.textContent.includes('Cancel')) {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) closeModal(modal.id);
            });
        }
    });
    
    // Click outside to close
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target.id);
        }
    });
}

function setupEditButtons() {
    const editButtons = {
        'editPersonalBtn': editPersonalInfo,
        'editContactBtn': editContactInfo,
        'editBankingBtn': editBankingInfo,
        'savePersonalBtn': savePersonalInfo,
        'saveContactBtn': saveContactInfo,
        'saveBankingBtn': saveBankingInfo,
        'saveAvailabilityBtn': saveAvailability
    };
    
    Object.entries(editButtons).forEach(([id, handler]) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.addEventListener('click', handler);
        }
    });
}

function setupFileUploads() {
    const bannerUpload = document.getElementById('bannerUpload');
    if (bannerUpload) {
        bannerUpload.addEventListener('change', handleBannerUpload);
    }
    
    const docUploadBtn = document.getElementById('uploadDocBtn');
    if (docUploadBtn) {
        docUploadBtn.addEventListener('click', uploadDocument);
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Alt+T: Toggle staff selector
        if (e.altKey && e.key === 't') {
            e.preventDefault();
            const selector = document.getElementById('staffSelector');
            if (selector) {
                selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Escape: Close active modal
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                closeModal(activeModal.id);
            }
        }
    });
}

function setupTimesheetControls() {
    // Period navigation
    document.querySelectorAll('.period-nav').forEach(button => {
        button.removeAttribute('onclick'); // Clean inline handlers
        
        if (button.textContent.includes('◀') || button.textContent.includes('Previous')) {
            button.addEventListener('click', () => {
                console.log('Navigate previous period');
                window.changePeriod(-1);
            });
        } else if (button.textContent.includes('▶') || button.textContent.includes('Next')) {
            button.addEventListener('click', () => {
                console.log('Navigate next period');
                window.changePeriod(1);
            });
        }
    });
    
    // View toggle buttons
    document.querySelectorAll('.view-toggle .toggle-btn').forEach(button => {
        button.removeAttribute('onclick'); // Clean inline handlers
        
        if (button.textContent.includes('Date')) {
            button.addEventListener('click', () => window.toggleTimesheetView('date'));
        } else if (button.textContent.includes('Client')) {
            button.addEventListener('click', () => window.toggleTimesheetView('participant'));
        }
    });
}

window.switchToStaff = async function(staffId) {
    try {
        if (!staffId) {
            showToast('No staff ID provided', 'error');
            return;
        }

        console.log('Switching to staff ID:', staffId);

        // Get the selected staff member
        const { data: selectedStaff, error } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('id', staffId)
            .single();
        
        if (error) {
            console.error('Error fetching staff:', error);
            showToast('Failed to load staff data', 'error');
            return;
        }
        
        console.log('Selected staff:', selectedStaff);
        
        // Store original if first time
        if (!AppState.staff.original) {
            AppState.staff.original = AppState.staff.current;
            console.log('Stored original staff:', AppState.staff.original);
        }
        
        // Switch to new staff member - CRITICAL: maintain currentStaff
        AppState.staff.current = selectedStaff;
        
        // Update the UI
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = `${selectedStaff.first_name} ${selectedStaff.last_name}`;
        }
        
        // Add/Update test mode banner
        let testBanner = document.getElementById('testModeBanner');
        if (!testBanner) {
            testBanner = document.createElement('div');
            testBanner.id = 'testModeBanner';
            testBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #ff9800;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            `;
            document.body.prepend(testBanner);
        }
        
        testBanner.innerHTML = `
            🧪 TEST MODE: Viewing as ${selectedStaff.first_name} ${selectedStaff.last_name}
            <button onclick="exitTestMode()" style="
                margin-left: 20px;
                padding: 5px 15px;
                background: white;
                color: #333;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: normal;
            ">Exit Test Mode</button>
        `;
        
        // Reload all their data
        const loaders = [];
        if (typeof loadDashboard === 'function') loaders.push(loadDashboard());
        if (typeof loadSchedule === 'function') loaders.push(loadSchedule());
        if (typeof loadTransfers === 'function') loaders.push(loadTransfers());
        if (typeof loadProfile === 'function') loaders.push(loadProfile());
        
        await Promise.all(loaders).catch(err => console.error('Error loading data:', err));
        
        // Stay on current section, don't force dashboard
        // The current section should reload with new staff data
        
        showToast(`Now viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name}`, 'success');
        
    } catch (error) {
        console.error('Error switching staff:', error);
        showToast('Failed to switch staff view', 'error');
    }
}

// Exit test mode function
window.exitTestMode = function() {
    if (AppState.staff.original) {
        console.log('Exiting test mode, restoring:', AppState.staff.original);
        
        AppState.staff.current = AppState.staff.original;
        delete AppState.staff.original;
        
        // Update UI
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = 
                `${AppState.staff.current.first_name} ${AppState.staff.current.last_name}`;
        }
        
        // Remove test banner
        const banner = document.getElementById('testModeBanner');
        if (banner) banner.remove();
        
        // Reload original data
        const loaders = [];
        if (typeof loadDashboard === 'function') loaders.push(loadDashboard());
        if (typeof loadSchedule === 'function') loaders.push(loadSchedule());
        if (typeof loadTransfers === 'function') loaders.push(loadTransfers());
        if (typeof loadProfile === 'function') loaders.push(loadProfile());
        
        Promise.all(loaders).catch(err => console.error('Error reloading data:', err));
        
        showToast('Returned to your account', 'success');
    }
}

window.debugStaffState = function() {
    console.log('=== Staff State Debug ===');
    console.log('currentStaff:', AppState.staff.current);
    console.log('originalStaff:', AppState.staff.original);
    console.log('currentUser:', window.currentUser);
    console.log('Test Mode Active:', !!AppState.staff.original);
    console.log('========================');
    return {
        currentStaff: AppState.staff.current,
        originalStaff: AppState.staff.original,
        testMode: !!AppState.staff.original
    };
}

async function initializeApp() {
    try {
        console.log('Initializing team app...');
        
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error || !session) {
            console.error('Authentication error:', error);
            window.location.href = 'index.html';
            return;
        }

        currentUser = session.user;
        console.log('User authenticated:', currentUser.email);
        
        // Try multiple methods to find staff record
        let staffData = null;
        
        // Method 1: Try by user_id
        let result = await supabaseClient
            .from('staff')
            .select('*')
            .eq('user_id', currentUser.id)
            .maybeSingle();
        
        staffData = result.data;
        
        // Method 2: Try by email match
        if (!staffData) {
            console.log('No staff found by user_id, trying email...');
            result = await supabaseClient
                .from('staff')
                .select('*')
                .eq('email', currentUser.email)
                .maybeSingle();
            
            staffData = result.data;
            
            // AUTO-LINK: If found by email but no user_id, update it
            if (staffData && !staffData.user_id) {
                console.log('Auto-linking staff record to user account...');
                const { error: updateError } = await supabaseClient
                    .from('staff')
                    .update({ user_id: currentUser.id })
                    .eq('id', staffData.id);
                
                if (!updateError) {
                    staffData.user_id = currentUser.id;
                    console.log('Staff record auto-linked successfully');
                }
            }
        }
        
        // Method 3: For testing - allow manual override
        if (!staffData && window.location.hostname === 'localhost') {
            console.warn('No staff found, checking for test override...');
            // You could load a default test staff here
        }
        
        if (!staffData) {
            console.error('No staff record found');
            showToast('No staff record found. Please contact administrator.', 'error');
            
            // Show helpful error with current user info
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: Arial;">
                    <h2>Staff Account Not Found</h2>
                    <p>No staff record found for: ${currentUser.email}</p>
                    <p style="color: #666; margin-top: 20px;">Please contact your administrator to link your account.</p>
                    <p style="font-size: 12px; color: #999; margin-top: 40px;">User ID: ${currentUser.id}</p>
                    <button onclick="logout()" style="margin-top: 20px; padding: 10px 20px;">Logout</button>
                </div>
            `;
            return;
        }
        
        // Set the staff data
        AppState.staff.current = staffData;
        currentStaff = staffData;
        
        console.log('Staff record loaded:', staffData.first_name, staffData.last_name);
        
        // Update UI
        document.getElementById('userName').textContent = 
            `${staffData.first_name} ${staffData.last_name}`;
        
        // Continue with initialization
        await loadReferenceData();
        setGreeting();
        showSection('dashboard');
        
    } catch (error) {
        console.error('Error in initializeApp:', error);
        showToast('Failed to initialize app', 'error');
    }
}

async function checkTableStructure() {
    // Run this once to determine actual column types
    const { data, error } = await supabaseClient
        .from('shift_adjustment_requests')
        .select('*')
        .limit(1);
    
    console.log('shift_adjustment_requests sample:', data);
    
    // Based on the error, shift_id appears to be UUID in this table
    // So we need to handle it differently
}



function ensureRequiredElements() {
    const requiredElements = [
        { id: 'userName', description: 'User name display' },
        { id: 'scheduleGrid', description: 'Schedule container' },
        { id: 'recentNotifications', description: 'Notifications container' },
        { id: 'incomingCount', description: 'Transfer count badge' },
        { id: 'periodDates', description: 'Pay period display' },
        { id: 'dashboardContent', description: 'Main dashboard content' }
    ];
    
    const missingElements = [];
    
    requiredElements.forEach(element => {
        const domElement = document.getElementById(element.id);
        if (!domElement) {
            console.warn(`Required element missing: ${element.id} (${element.description})`);
            missingElements.push(element.id);
        }
    });
    
    if (missingElements.length > 0) {
        console.warn('Missing DOM elements:', missingElements);
        // Could create placeholder elements here if needed
        missingElements.forEach(id => {
            if (id === 'scheduleGrid' || id === 'recentNotifications') {
                // Create essential containers if missing
                const container = document.createElement('div');
                container.id = id;
                container.innerHTML = '<div class="loading">Loading...</div>';
                
                // Try to find a good parent to attach to
                const parent = document.querySelector('.content-section') || document.body;
                parent.appendChild(container);
                
                console.log(`Created placeholder element: ${id}`);
            }
        });
    }
    
    return missingElements.length === 0;
}

        
        async function loadDashboard() {
    try {
        // Load current/upcoming shift
        await loadCurrentShift();
        
        // Load pending requests
        await loadPendingRequests();
        
        // Load notifications
        await loadNotifications();
        
        // Load upcoming leave
        const today = getTestDate().toISOString().split('T')[0];
        const thirtyDaysFromNow = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        const { data: myLeave } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('available', false)
            .gte('date', today)
            .lte('date', thirtyDaysFromNow)
            .order('date');

        if (myLeave && myLeave.length > 0) {
            // Group consecutive dates
            const leaveGroups = [];
            let currentGroup = null;
            
            myLeave.forEach(leave => {
                const leaveDate = new Date(leave.date);
                
                if (!currentGroup || 
                    leave.reason !== currentGroup.reason ||
                    (leaveDate - new Date(currentGroup.endDate)) > 24 * 60 * 60 * 1000) {
                    currentGroup = {
                        startDate: leave.date,
                        endDate: leave.date,
                        reason: leave.reason,
                        days: 1
                    };
                    leaveGroups.push(currentGroup);
                } else {
                    currentGroup.endDate = leave.date;
                    currentGroup.days++;
                }
            });

            // Create leave section HTML
            const leaveHTML = `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>📅 Upcoming Leave</h3>
                        <span class="badge">${leaveGroups.length}</span>
                    </div>
                    <div class="leave-list">
                        ${leaveGroups.map(group => {
                            const start = formatDateShort(group.startDate);
                            const end = formatDateShort(group.endDate);
                            const dateRange = group.startDate === group.endDate ? 
                                start : 
                                `${start} - ${end} (${group.days} days)`;
                            
                            const daysUntil = Math.floor((new Date(group.startDate) - getTestDate()) / (24 * 60 * 60 * 1000));
                            const urgency = daysUntil <= 7 ? 'urgent' : daysUntil <= 14 ? 'soon' : '';
                            
                            return `
                                <div class="leave-item ${urgency}">
                                    <div class="leave-info">
                                        <div class="leave-dates">${dateRange}</div>
                                        <div class="leave-type">${group.reason}</div>
                                    </div>
                                    ${daysUntil > 0 ? 
                                        `<div class="leave-countdown">In ${daysUntil} day${daysUntil !== 1 ? 's' : ''}</div>` : 
                                        daysUntil === 0 ? 
                                        '<div class="leave-countdown today">Today</div>' : 
                                        '<div class="leave-countdown ongoing">Ongoing</div>'
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Insert leave section into dashboard
            const dashboardContent = document.getElementById('dashboardContent');
            if (dashboardContent) {
                // Find or create leave container
                let leaveContainer = dashboardContent.querySelector('.leave-container');
                if (!leaveContainer) {
                    leaveContainer = document.createElement('div');
                    leaveContainer.className = 'leave-container';
                    
                    // Insert after pending requests or at the end
                    const pendingRequests = dashboardContent.querySelector('.dashboard-card');
                    if (pendingRequests) {
                        pendingRequests.insertAdjacentElement('afterend', leaveContainer);
                    } else {
                        dashboardContent.appendChild(leaveContainer);
                    }
                }
                leaveContainer.innerHTML = leaveHTML;
            }
        }
        
        // Update summary stats
        const { data: stats } = await supabaseClient
            .from('shifts')
            .select('id, status')
            .eq('staff_id', currentStaff.id)
            .gte('date', today);
        
        const upcomingShifts = stats?.filter(s => s.status === 'confirmed').length || 0;
        const pendingShifts = stats?.filter(s => s.status === 'pending').length || 0;
        
        // Update dashboard badges
        const homeBadge = document.getElementById('homeBadge');
        if (homeBadge) {
            const totalAlerts = pendingShifts + (myLeave?.length || 0);
            homeBadge.textContent = totalAlerts;
            homeBadge.classList.toggle('hidden', totalAlerts === 0);
        }
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Failed to load dashboard completely', 'error');
    }
}

function generateUUIDFromInt(id) {
    // Convert integer ID to UUID format for compatibility
    const hexId = parseInt(id).toString(16).padStart(12, '0');
    return `00000000-0000-0000-0000-${hexId}`;
}



        async function loadCurrentShift() {
            const now = getTestDate();
            const today = now.toISOString().split('T')[0];
            
            // Get today's and tomorrow's shifts
            const { data: upcomingShifts } = await supabaseClient
                .from('shifts')
                .select(`
                    *,
                    participant:participant_id(first_name, last_name),
                    location:location_id(name, address),
                    duty_type:duty_type_id(name)
                `)
                .eq('staff_id', currentStaff.id)
                .gte('date', today)
                .lte('date', new Date(now.getTime() + 24*60*60*1000).toISOString().split('T')[0])
                .is('deleted_at', null)
                .order('date')
                .order('start_time')
                .limit(1);

            const container = document.getElementById('currentShift');
            
            if (!upcomingShifts || upcomingShifts.length === 0) {
                container.innerHTML = `
                    <div class="shift-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="shift-card-header">
                            <div class="shift-time">No shifts today</div>
                            <div class="shift-participant">Enjoy your day off!</div>
                        </div>
                    </div>
                `;
                return;
            }

            const shift = upcomingShifts[0];
            const isToday = shift.date === today;
            const participantName = shift.participant ? 
                `${shift.participant.first_name} ${shift.participant.last_name}` :
                (shift.location?.name || 'Unassigned');
            
            container.innerHTML = `
            <div class="shift-card" data-shift-id="${shift.id}" onclick="toggleShiftDetails(this)">
                    <div class="shift-card-header">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                        <div class="shift-participant">${participantName}</div>
                        <div class="shift-location">
                            📍 ${shift.location?.name || shift.location?.address || 'Client Home'}
                        </div>
                        <div class="shift-status">${isToday ? 'TODAY' : 'TOMORROW'}</div>
                    </div>
                    <div class="shift-expand-icon">▼ Tap for details</div>
                    <div class="shift-details">
                        <div class="handover-section">
                            <div class="handover-title">Handover Notes</div>
                            <div id="handoverNotes">Loading...</div>
                            <button class="modal-btn primary mt-2" onclick="addNoteToShift(${shift.id})">Add Note</button>
                        </div>
                    </div>
                </div>
            `;

            // Load handover notes
            loadHandoverNotes(shift.id);
        }

function switchTransferTab(tab) {
    // Update tab styling
    document.querySelectorAll('.transfer-tab').forEach(t => {
        t.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Hide all transfer content divs
    document.getElementById('incomingTransfers').classList.remove('active');
    document.getElementById('outgoingTransfers').classList.remove('active');
    document.getElementById('availableTransfers').classList.remove('active');
    
    // Show selected tab content
    if (tab === 'incoming') {
        document.getElementById('incomingTransfers').classList.add('active');
    } else if (tab === 'outgoing') {
        document.getElementById('outgoingTransfers').classList.add('active');
    } else if (tab === 'available') {
        document.getElementById('availableTransfers').classList.add('active');
        // Load available shifts if needed
        if (typeof loadAvailableTransfers === 'function') {
            loadAvailableTransfers();
        }
    }
}


async function submitTransfer() {
    try {
        // Ensure authenticated
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            showToast('Not authenticated', 'error');
            return;
        }

        const shiftId = document.getElementById('transferShiftSelect').value;
        const toStaffId = document.getElementById('transferToStaff').value;
        const reason = document.getElementById('transferReason').value;

        if (!shiftId || !reason) {
            showToast('Please select a shift and provide a reason', 'error');
            return;
        }

        // Convert shift_id to integer
        const shiftIdInt = parseInt(shiftId, 10);
        if (isNaN(shiftIdInt)) {
            showToast('Invalid shift selected', 'error');
            return;
        }

        const { error } = await supabaseClient
            .from('transfer_requests')
            .insert({
                shift_id: shiftIdInt,  // INTEGER
                from_staff_id: currentStaff.id,  // UUID
                to_staff_id: toStaffId || null,  // UUID or null for open transfers
                reason: reason,
                status: 'pending',
                created_at: new Date().toISOString(),
                created_by: currentUser.id  // Add for RLS if needed
            });

        if (error) throw error;

        showToast('Transfer request sent successfully', 'success');
        closeModal('transferShiftModal');
        
        // Reload transfers if on that section
        const transfersSection = document.getElementById('transfers');
        if (transfersSection && transfersSection.classList.contains('active')) {
            loadTransfers();
        }

    } catch (error) {
        console.error('Error submitting transfer:', error);
        showToast('Failed to submit transfer request', 'error');
    }
}

function toggleTimeFields() {
    const dutyType = document.getElementById('shiftDutyType');
    const timeFields = document.getElementById('timeFields');
    
    if (dutyType && timeFields) {
        // Hide time fields for sleepover shifts
        if (dutyType.options[dutyType.selectedIndex]?.text?.toLowerCase().includes('sleepover')) {
            timeFields.style.display = 'none';
        } else {
            timeFields.style.display = 'block';
        }
    }
}



function showDocumentUploadModal() {
    // Open the document upload modal
    const modal = document.getElementById('documentUploadModal');
    if (modal) {
        modal.classList.add('active');
    } else {
        // If modal doesn't exist, show simple file input
        document.getElementById('documentFile')?.click();
    }
}

async function loadAvailableTransfers() {
    try {
        // Load shifts available for transfer (from other staff)
        const { data: available } = await supabaseClient
            .from('transfer_requests')
            .select(`
                *,
                shift:shift_id(date, start_time, end_time, participant:participant_id(first_name, last_name)),
                from_staff:from_staff_id(first_name, last_name)
            `)
            .is('to_staff_id', null) // Open to anyone
            .eq('status', 'pending')
            .neq('from_staff_id', currentStaff.id) // Not your own
            .order('created_at', { ascending: false });

        const container = document.getElementById('availableList');
        if (!container) return;
        
        if (!available || available.length === 0) {
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No available shifts to pick up</div>';
            return;
        }

        container.innerHTML = available.map(transfer => `
            <div class="transfer-item">
                <div class="transfer-header">
                    <div>
                        <div class="transfer-date">${formatDateLong(transfer.shift.date)}</div>
                        <div class="transfer-time">
                            ${transfer.shift.start_time ? formatTime(transfer.shift.start_time) : 'Sleepover'} - 
                            ${transfer.shift.end_time ? formatTime(transfer.shift.end_time) : ''}
                        </div>
                    </div>
                </div>
                <div class="transfer-from">
                    From: ${transfer.from_staff.first_name} ${transfer.from_staff.last_name}
                </div>
                ${transfer.reason ? `<div class="transfer-reason">"${transfer.reason}"</div>` : ''}
                <div class="transfer-actions">
                    <button class="transfer-btn accept" onclick="acceptTransfer('${transfer.id}')">Pick Up Shift</button>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading available transfers:', error);
    }
}

function toggleShiftDetails(element) {
    try {
        // Find the shift card element
        const shiftCard = element.closest('.shift-card') || element;
        
        // Toggle expanded class
        shiftCard.classList.toggle('expanded');
        
        // Get shift ID from the element - multiple ways to find it
        let shiftId = null;
        
        // Method 1: Look for data attribute
        shiftId = shiftCard.dataset.shiftId || shiftCard.getAttribute('data-shift-id');
        
        // Method 2: Look in onclick attribute for shift ID
        if (!shiftId) {
            const addNoteBtn = shiftCard.querySelector('[onclick*="addNoteToShift"]');
            if (addNoteBtn) {
                const onclickText = addNoteBtn.getAttribute('onclick');
                const match = onclickText.match(/addNoteToShift\((\d+)\)/);
                if (match) {
                    shiftId = match[1];
                }
            }
        }
        
        if (!shiftId) {
            console.error('No shift ID found in element:', shiftCard);
            return;
        }
        
        console.log('Toggle shift details for ID:', shiftId);
        
        // If expanding, load handover notes
        if (shiftCard.classList.contains('expanded')) {
            loadHandoverNotes(parseInt(shiftId));
        }
        
    } catch (error) {
        console.error('Error in toggleShiftDetails:', error);
    }
}



async function loadPendingRequests() {
 const { data: requests } = await supabaseClient
                .from('shift_adjustment_requests')
                .select('*')
                .eq('staff_id', currentStaff.id)
                .eq('status', 'pending');

            const { data: transfers } = await supabaseClient
                .from('transfer_requests')
                .select('*')
                .or(`from_staff_id.eq.${currentStaff.id},to_staff_id.eq.${currentStaff.id}`)
                .eq('status', 'pending');

            const { data: leaves } = await supabaseClient
                .from('leave_requests')
                .select('*')
                .eq('staff_id', currentStaff.id)
                .eq('status', 'pending');

            const container = document.getElementById('pendingRequestsList');
            const totalPending = (requests?.length || 0) + (transfers?.length || 0) + (leaves?.length || 0);

            if (totalPending === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-light);">No pending requests</div>';
                return;
            }

            let html = '';
            
            if (requests && requests.length > 0) {
                html += requests.map(req => `
                    <div class="request-item">
                        <div class="request-type">Time Adjustment</div>
                        <div class="request-status status-pending">Pending</div>
                    </div>
                `).join('');
            }

            if (transfers && transfers.length > 0) {
                html += transfers.map(req => `
                    <div class="request-item">
                        <div class="request-type">Shift Transfer</div>
                        <div class="request-status status-pending">Pending</div>
                    </div>
                `).join('');
            }

            if (leaves && leaves.length > 0) {
                html += leaves.map(req => `
                    <div class="request-item">
                        <div class="request-type">Leave Request</div>
                        <div class="request-status status-pending">Pending</div>
                    </div>
                `).join('');
            }

            container.innerHTML = html;
        }

        


function showLoading() {
    document.body.classList.add('loading');
}
function hideLoading() {
    document.body.classList.remove('loading');
}

        

        async function loadNotifications() {
    try {
        // Ensure we have currentUser from auth
        if (!currentUser) {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;
            currentUser = user;
        }

        // Use correct column names: user_id and read_at
        const { data: notifications, error } = await supabaseClient
            .from('notifications')
            .select('*')
            .eq('user_id', currentUser.id)
            .is('read_at', null)
            .order('created_at', { ascending: false })
            .limit(5);

        if (error) {
            console.error('Error loading notifications:', error);
            return;
        }

        const container = document.getElementById('recentNotifications');
        if (!container) return;

        if (!notifications || notifications.length === 0) {
            container.innerHTML = '<div class="notification-item">No new notifications</div>';
            return;
        }

        container.innerHTML = notifications.map(note => `
            <div class="notification-item ${note.notification_type || ''}" onclick="markAsRead('${note.id}')">
                <div class="notification-content">${note.message || 'New notification'}</div>
                <div class="notification-time">${formatDateTime(note.created_at)}</div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error in loadNotifications:', error);
        const container = document.getElementById('recentNotifications');
        if (container) {
            container.innerHTML = '<div class="notification-item">Unable to load notifications</div>';
        }
    }
}



        function loadShiftTimes() {
    try {
        const select = document.getElementById('adjustmentShift');
        const selected = select.options[select.selectedIndex];
        
        if (selected && selected.dataset.start) {
            document.getElementById('adjustmentStartTime').value = selected.dataset.start || '';
            document.getElementById('adjustmentEndTime').value = selected.dataset.end || '';
        } else {
            document.getElementById('adjustmentStartTime').value = '';
            document.getElementById('adjustmentEndTime').value = '';
        }
    } catch (error) {
        console.error('Error loading shift times:', error);
        // Don't show toast for this minor error
    }
}

async function loadTransfers() {
    try {
        if (!currentStaff || !currentStaff.id) {
            console.error('No current staff data for transfers');
            showToast('Staff data not loaded', 'error');
            return;
        }

        const { data: incoming, error: incomingError } = await supabaseClient
    .from('transfer_requests')
    .select(`
        *,
        shift:shifts!transfer_requests_shift_id_fkey(
            id,
            date, 
            start_time, 
            end_time,
            participant_id,
            staff_id,
            location_id,
            duty_type_id,
            participant:participants(first_name, last_name)
        ),
        from_staff:staff!transfer_requests_from_staff_id_fkey(
            id,
            first_name, 
            last_name,
            email
        )
    `)
    .eq('to_staff_id', currentStaff.id)
    .eq('status', 'pending')
    .order('created_at', { ascending: false });

        if (incomingError) {
            console.error('Error loading incoming transfers:', incomingError);
            // If nested join fails, try simpler approach
            const { data: simpleIncoming } = await supabaseClient
                .from('transfer_requests')
                .select('*')
                .eq('to_staff_id', currentStaff.id)
                .eq('status', 'pending')
                .order('created_at', { ascending: false });
            
            // Manually fetch related data
            if (simpleIncoming) {
                for (let transfer of simpleIncoming) {
                    // Fetch shift
                    if (transfer.shift_id) {
                        const { data: shift } = await supabaseClient
                            .from('shifts')
                            .select('*, participant:participants(first_name, last_name)')
                            .eq('id', transfer.shift_id)
                            .single();
                        transfer.shift = shift;
                    }
                    // Fetch from_staff
                    if (transfer.from_staff_id) {
                        const { data: staff } = await supabaseClient
                            .from('staff')
                            .select('id, first_name, last_name, email')
                            .eq('id', transfer.from_staff_id)
                            .single();
                        transfer.from_staff = staff;
                    }
                }
                renderIncomingTransfers(simpleIncoming);
                return;
            }
        }

        const { data: outgoing, error: outgoingError } = await supabaseClient
    .from('transfer_requests')
    .select(`
        *,
        shift:shifts!transfer_requests_shift_id_fkey(
            id,
            date, 
            start_time, 
            end_time,
            participant_id,
            staff_id,
            location_id,
            duty_type_id,
            participant:participants(first_name, last_name)
        ),
        to_staff:staff!transfer_requests_to_staff_id_fkey(
            id,
            first_name, 
            last_name,
            email
        )
    `)
    .eq('from_staff_id', currentStaff.id)
    .in('status', ['pending', 'approved', 'denied'])
    .order('created_at', { ascending: false });

        if (outgoingError) {
            console.error('Error loading outgoing transfers:', outgoingError);
            // Fallback to simpler query
            const { data: simpleOutgoing } = await supabaseClient
                .from('transfer_requests')
                .select('*')
                .eq('from_staff_id', currentStaff.id)
                .in('status', ['pending', 'approved', 'denied'])
                .order('created_at', { ascending: false });
            
            if (simpleOutgoing) {
                for (let transfer of simpleOutgoing) {
                    // Fetch shift
                    if (transfer.shift_id) {
                        const { data: shift } = await supabaseClient
                            .from('shifts')
                            .select('*, participant:participants(first_name, last_name)')
                            .eq('id', transfer.shift_id)
                            .single();
                        transfer.shift = shift;
                    }
                    // Fetch to_staff
                    if (transfer.to_staff_id) {
                        const { data: staff } = await supabaseClient
                            .from('staff')
                            .select('id, first_name, last_name, email')
                            .eq('id', transfer.to_staff_id)
                            .single();
                        transfer.to_staff = staff;
                    }
                }
                renderOutgoingTransfers(simpleOutgoing);
                return;
            }
        }

        // Render transfer lists
        renderIncomingTransfers(incoming || []);
        renderOutgoingTransfers(outgoing || []);
        
        // Update badge counts
        const incomingCount = document.getElementById('incomingCount');
        if (incomingCount) {
            const pendingCount = (incoming || []).filter(t => t.status === 'pending').length;
            incomingCount.textContent = pendingCount;
            incomingCount.style.display = pendingCount > 0 ? 'inline' : 'none';
        }
        
    } catch (error) {
        console.error('Error loading transfers:', error);
        showToast('Failed to load transfers', 'error');
    }
}

        
        async function acceptTransfer(transferId) {
    try {
        // Get the transfer request with shift data
        const { data: transfer, error: transferError } = await supabaseClient
            .from('transfer_requests')
            .select(`
                *,
                shift:shifts(*)
            `)
            .eq('id', transferId)
            .single();

        if (transferError || !transfer) {
            throw new Error('Transfer request not found');
        }

        // Check for conflicts with existing shifts
        if (transfer.shift) {
            const { data: myShifts } = await supabaseClient
                .from('shifts')
                .select('*')
                .eq('staff_id', currentStaff.id)
                .eq('date', transfer.shift.date);

            // Check for time conflicts
            if (myShifts && myShifts.length > 0) {
                for (let existing of myShifts) {
                    if (existing.start_time && existing.end_time && 
                        transfer.shift.start_time && transfer.shift.end_time) {
                        // Simple overlap check
                        const newStart = new Date(`2000-01-01 ${transfer.shift.start_time}`);
                        const newEnd = new Date(`2000-01-01 ${transfer.shift.end_time}`);
                        const existStart = new Date(`2000-01-01 ${existing.start_time}`);
                        const existEnd = new Date(`2000-01-01 ${existing.end_time}`);
                        
                        if (!(newEnd <= existStart || newStart >= existEnd)) {
                            showToast(`Cannot accept: Conflicts with your shift ${existing.start_time}-${existing.end_time}`, 'error');
                            return;
                        }
                    }
                }
            }
        }

        // Update shift assignment
        const { error: shiftError } = await supabaseClient
            .from('shifts')
            .update({ staff_id: currentStaff.id })
            .eq('id', transfer.shift_id);

        if (shiftError) throw shiftError;

        // Update transfer status
        const { error: updateError } = await supabaseClient
            .from('transfer_requests')
            .update({ 
                status: 'approved',
                responded_at: getTestDate().toISOString(),
                responded_by: currentStaff.id
            })
            .eq('id', transferId);

        if (updateError) throw updateError;

        showToast('Transfer accepted successfully', 'success');
        loadTransfers();
        loadDashboard();

    } catch (error) {
        console.error('Error accepting transfer:', error);
        showToast('Failed to accept transfer', 'error');
    }
}

async function fetchNotes() {
    try {
        console.log('Fetching notes...');
        
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return [];

        const { data: staffData } = await supabaseClient
            .from('staff')
            .select('id')
            .eq('email', user.email)
            .single();

        if (!staffData) return [];

        // Get user's shifts first
        const { data: userShifts } = await supabaseClient
            .from('shifts')
            .select('id, uuid')
            .eq('staff_id', staffData.id);

        if (!userShifts || userShifts.length === 0) return [];

        // Try integer IDs first (most likely to work)
        const integerIds = userShifts.map(shift => shift.id);
        
        // FIXED: Remove spaces in the foreign key join syntax
        let { data: notes, error } = await supabaseClient
            .from('shift_notes')
            .select(`
                *,
                staff:staff_id(first_name,last_name)
            `)
            .in('shift_id', integerIds)
            .in('note_type', ['handover', 'shift'])
            .order('created_at', { ascending: false });

        // If integer IDs fail, try UUIDs
        if (error && error.code === '22P02') {
            const uuidIds = userShifts.map(shift => shift.uuid).filter(Boolean);
            if (uuidIds.length > 0) {
                ({ data: notes, error } = await supabaseClient
                    .from('shift_notes')
                    .select(`
                        *,
                        staff:staff_id(first_name,last_name)
                    `)
                    .in('shift_id', uuidIds)
                    .in('note_type', ['handover', 'shift'])
                    .order('created_at', { ascending: false }));
            }
        }

        if (error) {
            console.error('Error fetching notes:', error);
            return [];
        }

        return notes || [];

    } catch (error) {
        console.error('Error in fetchNotes:', error);
        return [];
    }
}
        async function declineTransfer(transferId) {
            try {
                await supabaseClient
                    .from('transfer_requests')
                    .update({ 
                        status: 'denied',
                        responded_at: getTestDate().toISOString(),
                        responded_by: currentStaff.id
                    })
                    .eq('id', transferId);

                showToast('Transfer declined', 'success');
                loadTransfers();

            } catch (error) {
                console.error('Error declining transfer:', error);
                showToast('Failed to decline transfer', 'error');
            }
        }

        async function markAsRead(notificationId) {
    try {
        const { error } = await supabaseClient
            .from('notifications')
            .update({ read_at: new Date().toISOString() })
            .eq('id', notificationId);
        
        if (error) throw error;
        
        // Reload notifications
        loadNotifications();
        
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

    
async function logout() {
    try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        window.location.href = 'index.html';
    } catch (error) {
        console.error('Logout error:', error);
        showToast('Failed to logout', 'error');
    }
}


        async function loadTransferableShifts() {
    try {
        const tomorrow = getTestDate();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const { data: shifts } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participant:participants(first_name, last_name),
                duty_type:duty_type_id(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', tomorrow.toISOString().split('T')[0])
            .is('deleted_at', null)
            .eq('status', 'confirmed')
            .order('date')
            .order('start_time');

        const select = document.getElementById('transferShiftSelect');
        select.innerHTML = '<option value="">Select a shift</option>';
        
        if (shifts && shifts.length > 0) {
            shifts.forEach(shift => {
                const participant = shift.participant;
                const label = `${formatDateShort(shift.date)} ${shift.start_time || 'Sleepover'} - ${participant?.first_name} ${participant?.last_name}`;
                select.innerHTML += `<option value="${shift.id}" data-start="${shift.start_time}" data-end="${shift.end_time}">${label}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading transferable shifts:', error);
        showToast('Failed to load transferable shifts', 'error');
    }
}
        async function loadAdjustableShifts() {
            const yesterday = getTestDate();
            yesterday.setDate(yesterday.getDate() - 1);
            
            const { data: shifts } = await supabaseClient
                .from('shifts')
                .select(`
                    *,
                    participant:participants(first_name, last_name)
                `)
                .eq('staff_id', currentStaff.id)
                .gte('date', yesterday.toISOString().split('T')[0])
                .is('deleted_at', null)
                .in('status', ['confirmed', 'completed'])
                .order('date', { ascending: false })
                .order('start_time', { ascending: false })
                .limit(20);

            const select = document.getElementById('adjustmentShift');
            select.innerHTML = '<option value="">Select a shift</option>';
            
            if (shifts && shifts.length > 0) {
                shifts.forEach(shift => {
                    const participant = shift.participant;
                    const label = `${formatDateShort(shift.date)} ${shift.start_time || 'Sleepover'} - ${participant?.first_name} ${participant?.last_name}`;
                    select.innerHTML += `<option value="${shift.id}" data-start="${shift.start_time}" data-end="${shift.end_time}">${label}</option>`;
                });
            }
        }

async function loadParticipants() {
    try {
        const { data: participantsData } = await supabaseClient
            .from('participants')
            .select('*, care_home:care_home_id(name)')
            .is('deleted_at', null)
            .order('first_name');
        
        participants = participantsData || [];
        
        // Populate participant dropdowns with care home labels
        const selects = ['shiftParticipant', 'noteParticipant'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">Select Client</option>';
                participants.forEach(p => {
                    const careHomeLabel = p.care_home ? ` (${p.care_home.name})` : '';
                    select.innerHTML += `<option value="${p.id}">${p.first_name} ${p.last_name}${careHomeLabel}</option>`;
                });
            }
        });
    } catch (error) {
        console.error('Error loading participants:', error);
        showToast('Failed to load participants', 'error');
    }
}

async function loadWeeklyAvailability() {
    try {
        const { data } = await supabaseClient
            .from('staff_weekly_availability')
            .select('*')
            .eq('staff_id', currentStaff.id);
        
        // Clear existing availability
        weeklyAvailability = {};
        
        if (data && data.length > 0) {
            // Populate weeklyAvailability object
            data.forEach(slot => {
                const key = `${slot.day_of_week}_${slot.time_slot}`;
                weeklyAvailability[key] = slot.available;
            });
        }
        
        // Update UI grid
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const container = document.getElementById('availabilityGrid');
        
        if (container) {
            container.innerHTML = days.map((day, index) => {
                const hasAnySlot = weeklyAvailability[`${index}_0`] || 
                                  weeklyAvailability[`${index}_1`] || 
                                  weeklyAvailability[`${index}_2`] || 
                                  weeklyAvailability[`${index}_3`];
                
                return `
                    <div class="availability-day">
                        <div class="availability-day-header">
                            <span class="day-name">${day}</span>
                            <label class="availability-toggle">
                                <input type="checkbox" ${hasAnySlot ? 'checked' : ''} 
                                       onchange="toggleDayAvailability(${index}, this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="availability-times">
                            <div class="time-slot ${weeklyAvailability[`${index}_0`] ? 'selected' : ''}" 
                                 onclick="toggleTimeSlot(${index}, 0, this)">Morning</div>
                            <div class="time-slot ${weeklyAvailability[`${index}_1`] ? 'selected' : ''}"
                                 onclick="toggleTimeSlot(${index}, 1, this)">Afternoon</div>
                            <div class="time-slot ${weeklyAvailability[`${index}_2`] ? 'selected' : ''}"
                                 onclick="toggleTimeSlot(${index}, 2, this)">Evening</div>
                            <div class="time-slot ${weeklyAvailability[`${index}_3`] ? 'selected' : ''}"
                                 onclick="toggleTimeSlot(${index}, 3, this)">Night</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading availability:', error);
        showToast('Failed to load availability', 'error');
    }
}


// Also ensure saveWeeklyAvailability is correct
async function saveWeeklyAvailability() {
    try {
        const updates = [];
        for (let day = 0; day < 7; day++) {
            for (let slot = 0; slot < 4; slot++) {
                const key = `${day}_${slot}`;
                updates.push({
                    staff_id: currentStaff.id,
                    day_of_week: day,
                    time_slot: slot,
                    available: weeklyAvailability[key] || false
                });
            }
        }

        const { error } = await supabaseClient
            .from('staff_weekly_availability')
            .upsert(updates, { 
                onConflict: 'staff_id,day_of_week,time_slot' 
            });

        if (error) throw error;

        showToast('Availability updated successfully', 'success');

    } catch (error) {
        console.error('Error saving availability:', error);
        showToast('Failed to save availability', 'error');
    }
}


// Profile Functions
async function loadProfile() {
            // Personal Information
            document.getElementById('personalInfo').innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Full Name</div>
                    <div class="field-value">${currentStaff.first_name} ${currentStaff.middle_name || ''} ${currentStaff.last_name}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <div class="field-value">${currentStaff.date_of_birth ? formatDateShort(currentStaff.date_of_birth) : 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <div class="field-value">${currentStaff.ndis_worker_number || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Staff Code</div>
                    <div class="field-value">${currentStaff.staff_code || 'Not set'}</div>
                </div>
            `;

            // Contact Details
            document.getElementById('contactInfo').innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Email</div>
                    <div class="field-value">${currentStaff.email}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Phone</div>
                    <div class="field-value">${currentStaff.phone || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Address</div>
                    <div class="field-value">${currentStaff.address || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact</div>
                    <div class="field-value">${currentStaff.emergency_contact || 'Not set'}</div>
                </div>
            `;

            // Banking Details
            document.getElementById('bankingInfo').innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Bank</div>
                    <div class="field-value">${currentStaff.bank_name || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">BSB</div>
                    <div class="field-value">${currentStaff.bsb || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Account Number</div>
                    <div class="field-value">${currentStaff.account_number ? '****' + currentStaff.account_number.slice(-4) : 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Tax File Number</div>
                    <div class="field-value">${currentStaff.tax_file_number ? '***-***-' + currentStaff.tax_file_number.slice(-3) : 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Super Fund</div>
                    <div class="field-value">${currentStaff.super_fund || 'Not set'}</div>
                </div>
            `;

            // Load documents
            await loadDocuments();
            
            // Load availability
            await loadAvailability();
        }

        async function loadDocuments() {
            const { data: docs } = await supabaseClient
                .from('documents')
                .select('*, document_type:document_type_id(name)')
                .eq('entity_id', currentStaff.id)
                .eq('entity_type', 'staff')
                .is('deleted_at', null)
                .order('created_at', { ascending: false });

            documents = docs || [];
            
            const container = document.getElementById('documentList');
            
            if (documents.length === 0) {
                container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No documents uploaded</div>';
                return;
            }

            container.innerHTML = documents.map(doc => {
                let statusClass = 'status-verified';
                let statusText = 'Verified';
                
                if (!doc.is_verified) {
                    statusClass = 'status-pending';
                    statusText = 'Pending';
                }
                
                if (doc.expiry_date && new Date(doc.expiry_date) < getTestDate()) {
                    statusClass = 'status-expired';
                    statusText = 'Expired';
                }
                
                return `
                    <div class="document-item">
                        <div class="document-info">
                            <div class="document-name">${doc.title}</div>
                            <div class="document-meta">
                                ${doc.document_type?.name || 'Document'} • 
                                ${doc.expiry_date ? `Expires: ${formatDateShort(doc.expiry_date)}` : 'No expiry'}
                            </div>
                        </div>
                        <div class="document-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
        }

        async function loadAvailability() {
            const { data: availability } = await supabaseClient
                .from('staff_weekly_availability')
                .select('*')
                .eq('staff_id', currentStaff.id);

            if (availability) {
                availability.forEach(slot => {
                    const key = `${slot.day_of_week}_${slot.time_slot}`;
                    weeklyAvailability[key] = slot.available;
                });
            }

            renderAvailability();
        }



        async function approveTransfer(requestId) {
    try {
        // Show loading state
        showNotification('Processing transfer request...', 'info');
        
        // 1. GET THE TRANSFER REQUEST WITH ALL RELATED DATA
        const { data: request, error: requestError } = await supabaseClient
            .from('transfer_requests')
            .select(`
                *,
                shift:shifts!shift_id (
                    *,
                    participant:participants!participant_id (first_name, last_name),
                    location:locations!location_id (name),
                    duty_type:duty_types!duty_type_id (name)
                ),
                from_staff:staff!from_staff_id (first_name, last_name, email),
                to_staff:staff!to_staff_id (first_name, last_name, email, pay_rate_id, limits)
            `)
            .eq('id', requestId)
            .single();
        
        if (requestError) {
            console.error('Error fetching transfer request:', requestError);
            throw new Error('Failed to fetch transfer request');
        }
        
        if (!request) {
            throw new Error('Transfer request not found');
        }
        
        // Check if already processed
        if (request.status !== 'pending') {
            showNotification(`This request has already been ${request.status}`, 'warning');
            return;
        }
        
        // 2. VALIDATE THE RECEIVING STAFF EXISTS
        if (!request.to_staff_id) {
            throw new Error('No receiving staff specified for this transfer');
        }
        
        const shift = request.shift;
        if (!shift) {
            throw new Error('Associated shift not found');
        }
        
        // 3. CHECK STAFF AVAILABILITY
        const { data: availabilityCheck } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', request.to_staff_id)
            .eq('date', shift.date)
            .single();
        
        let proceedWithUnavailable = false;
        if (availabilityCheck && !availabilityCheck.available) {
            const toStaffName = request.to_staff ? 
                `${request.to_staff.first_name} ${request.to_staff.last_name}` : 
                'The receiving staff';
            const leaveReason = availabilityCheck.reason || 'unavailable';
            
            const message = `⚠️ AVAILABILITY WARNING\n\n` +
                `${toStaffName} is marked as ${leaveReason} on ${formatDateFriendly(shift.date)}.\n\n` +
                `Do you want to approve this transfer anyway?`;
            
            if (!confirm(message)) {
                showNotification('Transfer approval cancelled', 'info');
                return;
            }
            proceedWithUnavailable = true;
        }
        
        // 4. CHECK FOR SCHEDULING CONFLICTS
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', request.to_staff_id)
            .eq('date', shift.date)
            .is('deleted_at', null)
            .neq('status', 'cancelled');
        
        if (existingShifts && existingShifts.length > 0) {
            // Check for time conflicts
            for (const existingShift of existingShifts) {
                // Check for sleepover conflicts
                const isDutyTypeSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover');
                const isExistingSleepover = await checkIfSleepover(existingShift.duty_type_id);
                
                if (isDutyTypeSleepover && isExistingSleepover) {
                    throw new Error('Staff already has a sleepover shift on this date');
                }
                
                // Check for time overlap (if not sleepover)
                if (!isDutyTypeSleepover && shift.start_time && shift.end_time && 
                    existingShift.start_time && existingShift.end_time) {
                    
                    const newStart = parseTime(shift.start_time);
                    const newEnd = parseTime(shift.end_time);
                    const existingStart = parseTime(existingShift.start_time);
                    const existingEnd = parseTime(existingShift.end_time);
                    
                    // Check for overlap
                    if ((newStart < existingEnd && newEnd > existingStart)) {
                        const message = `⚠️ TIME CONFLICT WARNING\n\n` +
                            `${request.to_staff.first_name} already has a shift from ` +
                            `${formatTime12Hour(existingShift.start_time)} to ${formatTime12Hour(existingShift.end_time)}.\n` +
                            `This transfer is from ${formatTime12Hour(shift.start_time)} to ${formatTime12Hour(shift.end_time)}.\n\n` +
                            `Do you want to approve anyway?`;
                        
                        if (!confirm(message)) {
                            showNotification('Transfer approval cancelled due to conflict', 'info');
                            return;
                        }
                    }
                }
            }
        }
        
        // 5. CHECK WEEKLY HOUR LIMITS
        const weekStart = getWeekStart(new Date(shift.date));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        const { data: weekShifts } = await supabaseClient
            .from('shifts')
            .select('*, duty_type:duty_types!duty_type_id(name)')
            .eq('staff_id', request.to_staff_id)
            .gte('date', weekStart.toISOString().split('T')[0])
            .lte('date', weekEnd.toISOString().split('T')[0])
            .is('deleted_at', null)
            .neq('status', 'cancelled');
        
        let totalWeekHours = 0;
        if (weekShifts) {
            weekShifts.forEach(s => {
                if (s.duty_type?.name?.toLowerCase().includes('sleepover')) {
                    totalWeekHours += 2;
                } else if (s.duration_hours) {
                    totalWeekHours += s.duration_hours;
                } else if (s.start_time && s.end_time) {
                    const hours = calculateShiftDuration(s.start_time, s.end_time);
                    totalWeekHours += hours;
                }
            });
        }
        
        // Add the transfer shift hours
        let transferShiftHours = 0;
        if (shift.duty_type?.name?.toLowerCase().includes('sleepover')) {
            transferShiftHours = 2;
        } else if (shift.duration_hours) {
            transferShiftHours = shift.duration_hours;
        } else if (shift.start_time && shift.end_time) {
            transferShiftHours = calculateShiftDuration(shift.start_time, shift.end_time);
        }
        
        const newTotalHours = totalWeekHours + transferShiftHours;
        const weeklyLimit = request.to_staff?.limits || 76;
        
        if (newTotalHours > weeklyLimit) {
            const message = `⚠️ HOUR LIMIT WARNING\n\n` +
                `${request.to_staff.first_name} will have ${newTotalHours.toFixed(1)} hours this week.\n` +
                `Their limit is ${weeklyLimit} hours.\n\n` +
                `Do you want to approve anyway?`;
            
            if (!confirm(message)) {
                showNotification('Transfer approval cancelled due to hour limits', 'info');
                return;
            }
        }
        
        // 6. PERFORM THE TRANSFER
        // Start a transaction-like operation
        const updates = [];
        
        // Update the shift with new staff
        const shiftUpdate = supabaseClient
            .from('shifts')
            .update({
                staff_id: request.to_staff_id,
                transfer_status: 'completed',
                transfer_approved_by: currentStaffData?.id || currentUser.id,
                transfer_approved_at: getTestDate().toISOString(),
                updated_at: getTestDate().toISOString(),
                // Preserve the pay rate of the receiving staff
                pay_override_id: request.to_staff?.pay_rate_id || shift.pay_override_id
            })
            .eq('id', shift.id);
        
        // Update request status
        const requestUpdate = supabaseClient
            .from('transfer_requests')
            .update({
                status: 'approved',
                responded_at: getTestDate().toISOString(),
                responded_by: currentStaffData?.id || currentUser.id
            })
            .eq('id', requestId);
        
        // Execute both updates
        const [shiftResult, requestResult] = await Promise.all([shiftUpdate, requestUpdate]);
        
        if (shiftResult.error) {
            throw new Error('Failed to update shift: ' + shiftResult.error.message);
        }
        
        if (requestResult.error) {
            throw new Error('Failed to update request status: ' + requestResult.error.message);
        }
        
        // 7. CREATE AUDIT LOG (optional but recommended)
        const auditLog = {
            action: 'transfer_approved',
            shift_id: shift.id,
            from_staff_id: request.from_staff_id,
            to_staff_id: request.to_staff_id,
            approved_by: currentStaffData?.id || currentUser.id,
            notes: proceedWithUnavailable ? 'Approved despite availability warning' : null,
            created_at: getTestDate().toISOString()
        };
        
        // You might want to create an audit_logs table for this
        // await supabaseClient.from('audit_logs').insert(auditLog);
        
        // 8. SUCCESS - Refresh the UI
        showNotification('Transfer approved successfully', 'success');
        
        // Refresh the appropriate view
        await loadShifts();
        
        if (currentView === 'requests') {
            await renderRequests();
        } else {
            renderCurrentView();
        }
        
        // Log success for debugging
        console.log('Transfer approved:', {
            requestId,
            shiftId: shift.id,
            fromStaff: `${request.from_staff.first_name} ${request.from_staff.last_name}`,
            toStaff: `${request.to_staff.first_name} ${request.to_staff.last_name}`,
            date: shift.date,
            warnings: {
                unavailable: proceedWithUnavailable,
                overHourLimit: newTotalHours > weeklyLimit
            }
        });
        
    } catch (error) {
        console.error('Error approving transfer:', error);
        showNotification('Failed to approve transfer: ' + error.message, 'error');
    }
}

// Helper function to check if a duty type is a sleepover
async function checkIfSleepover(dutyTypeId) {
    if (!dutyTypeId) return false;
    
    const dutyType = dutyTypes.find(dt => dt.id === dutyTypeId);
    if (dutyType) {
        return dutyType.name?.toLowerCase().includes('sleepover');
    }
    
    // Fallback to database query if not in cache
    const { data } = await supabaseClient
        .from('duty_types')
        .select('name')
        .eq('id', dutyTypeId)
        .single();
    
    return data?.name?.toLowerCase().includes('sleepover') || false;
}

// Helper function to parse time string to minutes for comparison
function parseTime(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
}

// Helper function to calculate shift duration in hours
function calculateShiftDuration(startTime, endTime) {
    const start = parseTime(startTime);
    const end = parseTime(endTime);
    
    // Handle overnight shifts
    const duration = end > start ? end - start : (1440 - start) + end;
    return duration / 60;
}


async function submitShift() {
    try {
        const date = document.getElementById('shiftDate').value;
        const startTime = document.getElementById('shiftStartTime').value;
        const endTime = document.getElementById('shiftEndTime').value;
        const participantId = document.getElementById('shiftParticipant').value;
        const dutyTypeId = document.getElementById('shiftDutyType').value;
        const notes = document.getElementById('shiftNotes').value;

        if (!date || !participantId || !dutyTypeId) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        // CHECK IF ON LEAVE
        const { data: leaveCheck } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', AppState.staff.current.id)
            .eq('date', date)
            .eq('available', false)
            .maybeSingle();

        if (leaveCheck) {
            showToast(`Cannot add shift: You are on ${leaveCheck.reason} on this date`, 'error');
            return;
        }

        // Check for conflicts BEFORE insert
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', AppState.staff.current.id)
            .eq('date', date)
            .is('deleted_at', null);

        if (existingShifts && existingShifts.length > 0) {
            // Check for sleepover conflict
            const isSleepover = !startTime || !endTime;
            
            if (isSleepover) {
                showToast('You already have a shift on this date. Cannot add sleepover.', 'error');
                return;
            }
            
            // Check time overlap for regular shifts
            for (const existing of existingShifts) {
                if (!existing.start_time || !existing.end_time) {
                    showToast('You have a sleepover shift on this date. Cannot add another shift.', 'error');
                    return;
                }
                
                const newStart = new Date(`2000-01-01T${startTime}`);
                const newEnd = new Date(`2000-01-01T${endTime}`);
                const existStart = new Date(`2000-01-01T${existing.start_time}`);
                const existEnd = new Date(`2000-01-01T${existing.end_time}`);
                
                // Handle overnight shifts
                if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
                if (existEnd <= existStart) existEnd.setDate(existEnd.getDate() + 1);
                
                if (!(newEnd <= existStart || newStart >= existEnd)) {
                    showToast(`Conflict: You have a shift from ${existing.start_time} to ${existing.end_time}`, 'error');
                    return;
                }
            }
        }

        // Auto-select location based on participant
        let locationId = null;
        const selectedParticipant = participants.find(p => p.id === participantId);
        if (selectedParticipant) {
            // If participant has care home, find matching location
            if (selectedParticipant.care_home_id) {
                const careHomeLocation = locations.find(l => 
                    l.name.toLowerCase().includes('care') || 
                    l.name.toLowerCase().includes('saunders')
                );
                locationId = careHomeLocation ? careHomeLocation.id : '00000000-0000-0000-0000-000000000001';
            } else {
                // Default to Client Home
                locationId = '00000000-0000-0000-0000-000000000001';
            }
        }

        // Get default pay_override_id
        let payOverrideId = null;
        const { data: defaultOverride } = await supabaseClient
            .from('pay_overrides')
            .select('id')
            .limit(1)
            .maybeSingle();
        
        if (defaultOverride) {
            payOverrideId = defaultOverride.id;
        } else {
            // Use a default UUID if no pay_override exists
            payOverrideId = '00000000-0000-0000-0000-000000000001';
        }

        // Create shift with status 'scheduled' by default
        const { error } = await supabaseClient
            .from('shifts')
            .insert({
                date: date,
                start_time: startTime || null,
                end_time: endTime || null,
                staff_id: AppState.staff.current.id,
                participant_id: participantId,
                location_id: locationId,
                duty_type_id: dutyTypeId,
                status: 'scheduled', // Changed from 'pending' to 'scheduled'
                notes: notes || null,
                pay_override_id: payOverrideId, // Added required field
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            });

        if (error) throw error;

        showToast('Shift added successfully', 'success');
        closeModal('addShiftModal');
        
        // Clear form
        document.getElementById('shiftDate').value = '';
        document.getElementById('shiftStartTime').value = '';
        document.getElementById('shiftEndTime').value = '';
        document.getElementById('shiftParticipant').value = '';
        document.getElementById('shiftDutyType').value = '';
        document.getElementById('shiftNotes').value = '';
        
        // Reload relevant sections
        if (typeof loadDashboard === 'function') loadDashboard();
        if (typeof loadSchedule === 'function') loadSchedule();
        if (typeof loadTimesheet === 'function') loadTimesheet();

    } catch (error) {
        console.error('Error submitting shift:', error);
        showToast('Failed to submit shift', 'error');
    }
}
const ModalManager = {
    // Modal configurations
    modals: {
        addShift: {
            id: 'addShiftModal',
            onOpen: () => populateShiftModalDropdowns(),
            onClose: () => document.getElementById('addShiftForm')?.reset()
        },
        transfer: {
            id: 'transferModal',
            onOpen: () => loadTransferModalData(),
            onClose: () => document.getElementById('transferForm')?.reset()
        },
        adjustment: {
            id: 'adjustmentModal',
            onOpen: () => loadAdjustmentModalData(),
            onClose: () => document.getElementById('adjustmentForm')?.reset()
        },
        leave: {
            id: 'leaveModal',
            onOpen: null,
            onClose: () => document.getElementById('leaveForm')?.reset()
        }
    },
    
    // Current open modal
    currentModal: null,
    
    // Open modal by name
    show(modalName, data = null) {
        const config = this.modals[modalName];
        if (!config) {
            console.error(`Modal '${modalName}' not found`);
            return;
        }
        
        // Close any open modal first
        if (this.currentModal) {
            this.close();
        }
        
        const modalElement = document.getElementById(config.id);
        if (!modalElement) {
            console.error(`Modal element '${config.id}' not found`);
            return;
        }
        
        // Store current modal
        this.currentModal = {
            name: modalName,
            element: modalElement,
            config: config
        };
        
        // Show modal
        modalElement.classList.add('active');
        modalElement.style.display = 'flex';
        
        // Run onOpen callback if exists
        if (config.onOpen) {
            config.onOpen(data);
        }
        
        // Add escape key listener
        this.escapeHandler = (e) => {
            if (e.key === 'Escape') {
                this.close();
            }
        };
        document.addEventListener('keydown', this.escapeHandler);
    },
    
    // Close current modal
    close() {
        if (!this.currentModal) return;
        
        const { element, config } = this.currentModal;
        
        // Hide modal
        element.classList.remove('active');
        element.style.display = 'none';
        
        // Run onClose callback if exists
        if (config.onClose) {
            config.onClose();
        }
        
        // Remove escape handler
        if (this.escapeHandler) {
            document.removeEventListener('keydown', this.escapeHandler);
        }
        
        // Clear current modal
        this.currentModal = null;
    },
    
    // Check if a modal is open
    isOpen(modalName = null) {
        if (!modalName) {
            return this.currentModal !== null;
        }
        return this.currentModal?.name === modalName;
    },
    
    // Get current modal data
    getCurrent() {
        return this.currentModal;
    }
};

// ==========================================
// REPLACE YOUR OLD FUNCTIONS WITH THESE
// ==========================================

// Old way -> New way
function showAddShiftModal() {
    ModalManager.show('addShift');
}

function showTransferModal() {
    ModalManager.show('transfer');
}

function showAdjustmentModal() {
    ModalManager.show('adjustment');
}

function showLeaveModal() {
    ModalManager.show('leave');
}

// Update openModal and closeModal to use ModalManager
function openModal(modalId) {
    // Find modal name by ID
    const modalName = Object.keys(ModalManager.modals).find(
        name => ModalManager.modals[name].id === modalId
    );
    
    if (modalName) {
        ModalManager.show(modalName);
    } else {
        // Fallback for any modals not in the system yet
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            modal.style.display = 'flex';
        }
    }
}

function closeModal(modalId) {
    // Check if it's the current modal
    if (ModalManager.currentModal?.element.id === modalId) {
        ModalManager.close();
    } else {
        // Fallback for any modals not in the system yet
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            modal.style.display = 'none';
        }
    }
}

// ==========================================
// APPSTATE IMPLEMENTATION
// ==========================================

// Since you've already replaced window.* with AppState.*, here's the actual AppState object:

const AppState = {
    staff: {
        current: null,
        original: null,
        all: []
    },
    shifts: {
        my: [],
        filtered: [],
        all: []
    },
    ui: {
        currentSection: 'dashboard',
        timesheetView: 'date',
        periodOffset: 0,
        currentPeriod: null
    },
    cache: {
        participants: [],
        dutyTypes: [],
        locations: [],
        transfers: {
            incoming: [],
            outgoing: []
        }
    },
    
    // Helper methods
    reset() {
        this.staff.original = null;
        this.ui.periodOffset = 0;
        this.ui.timesheetView = 'date';
    },
    
    isInTestMode() {
        return this.staff.original !== null;
    },
    
    getCurrentStaff() {
        return this.staff.current;
    },
    
    setCurrentStaff(staff) {
        this.staff.current = staff;
    },
    
    switchToTestMode(testStaff) {
        if (!this.staff.original) {
            this.staff.original = this.staff.current;
        }
        this.staff.current = testStaff;
    },
    
    exitTestMode() {
        if (this.staff.original) {
            this.staff.current = this.staff.original;
            this.staff.original = null;
        }
    }
};

// Initialize currentStaff reference for backward compatibility
Object.defineProperty(window, 'currentStaff', {
    get() { return AppState.staff.current; },
    set(value) { AppState.staff.current = value; }
});


async function populateParticipantDropdown() {
    const select = document.getElementById('shiftParticipant');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Client</option>';
    
    // Check if participants array is populated
    if (!participants || participants.length === 0) {
        console.log('Participants array empty, loading...');
        await loadReferenceData();
    }
    
    if (participants.length === 0) {
        select.innerHTML += '<option value="">No clients available</option>';
        return;
    }
    
    participants.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.first_name} ${p.last_name}`;
        select.appendChild(option);
    });
}

async function populateDutyTypeDropdown() {
    const select = document.getElementById('shiftDutyType');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Type</option>';
    
    // Check if dutyTypes array is populated
    if (!dutyTypes || dutyTypes.length === 0) {
        console.log('Duty types array empty, loading...');
        await loadReferenceData();
    }
    
    if (dutyTypes.length === 0) {
        select.innerHTML += '<option value="">No duty types available</option>';
        return;
    }
    
    dutyTypes.forEach(dt => {
        const option = document.createElement('option');
        option.value = dt.id;
        option.textContent = dt.name;
        select.appendChild(option);
    });
}

async function populateTransferableShifts() {
    const select = document.getElementById('transferShiftSelect');
    if (!select) return;
    
    // Clear existing options
    select.innerHTML = '<option value="">Select a shift</option>';
    
    // Load shifts for current staff
    const { data: myShifts } = await supabaseClient
        .from('shifts')
        .select('*, participants(first_name, last_name)')
        .eq('staff_id', currentStaff.id)
        .gte('date', getTestDate().toISOString().split('T')[0])
        .order('date', { ascending: true });
    
    if (myShifts && myShifts.length > 0) {
        myShifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id; // This is already an INTEGER
            option.dataset.start = shift.start_time || '';
            option.dataset.end = shift.end_time || '';
            
            const clientName = shift.participants ? 
                `${shift.participants.first_name} ${shift.participants.last_name}` : 
                'Unknown Client';
            option.textContent = `${formatDateShort(shift.date)} - ${clientName} (${shift.start_time || 'Sleepover'})`;
            select.appendChild(option);
        });
    }
}


async function populateStaffDropdown() {
    const select = document.getElementById('transferToStaff');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select staff member (optional)</option>';
    
    // Check if staff array is populated
    if (!staff || staff.length === 0) {
        console.log('Staff array empty, loading...');
        await loadReferenceData();
    }
    
    // Filter out current staff
    const otherStaff = staff.filter(s => s.id !== currentStaff.id);
    
    if (otherStaff.length === 0) {
        select.innerHTML += '<option value="">No other staff available</option>';
        return;
    }
    
    otherStaff.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = `${s.first_name} ${s.last_name}`;
        select.appendChild(option);
    });
}

async function populateAdjustableShifts() {
    const select = document.getElementById('adjustmentShift');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select a shift</option>';
    
    const { data: myShifts } = await supabaseClient
        .from('shifts')
        .select('*, participants(first_name, last_name)')
        .eq('staff_id', currentStaff.id)
        .gte('date', getTestDate().toISOString().split('T')[0])
        .order('date', { ascending: true });
    
    if (myShifts && myShifts.length > 0) {
        myShifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id;  // Already INTEGER
            option.dataset.start = shift.start_time || '';
            option.dataset.end = shift.end_time || '';
            
            const clientName = shift.participants ? 
                `${shift.participants.first_name} ${shift.participants.last_name}` : 
                'Unknown Client';
            option.textContent = `${formatDateShort(shift.date)} - ${clientName} (${shift.start_time || 'Sleepover'})`;
            select.appendChild(option);
        });
    }
}

function ensureIntegerId(id) {
    if (typeof id === 'number') return id;
    const parsed = parseInt(id, 10);
    if (isNaN(parsed)) {
        throw new Error(`Invalid ID: ${id} cannot be converted to integer`);
    }
    return parsed;
}

async function submitAdjustment() {
    try {
        const shiftId = document.getElementById('adjustmentShift').value;
        const newStartTime = document.getElementById('adjustmentStartTime').value;
        const newEndTime = document.getElementById('adjustmentEndTime').value;
        const reason = document.getElementById('adjustmentReason').value;
        
        if (!shiftId || !reason) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        // Convert shift_id to integer (like the working version)
        const shiftIdInt = parseInt(shiftId, 10);
        if (isNaN(shiftIdInt)) {
            showToast('Invalid shift selected', 'error');
            return;
        }

        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            showToast('Not authenticated', 'error');
            return;
        }

        const { data: staffData } = await supabaseClient
            .from('staff')
            .select('id')
            .eq('email', user.email)
            .single();

        if (!staffData) {
            showToast('Staff data not found', 'error');
            return;
        }

        // Use integer IDs like the working version
        const { error } = await supabaseClient
            .from('shift_adjustment_requests')
            .insert({
                shift_id: shiftIdInt,  // INTEGER not UUID
                staff_id: staffData.id,  // Staff ID
                new_start_time: newStartTime || null,
                new_end_time: newEndTime || null,
                reason: reason,
                status: 'pending',
                created_at: new Date().toISOString()
            });
            
        if (error) throw error;
        
        showToast('Time adjustment request sent', 'success');
        closeModal('adjustmentModal');
        
        // Clear form
        document.getElementById('adjustmentForm').reset();
        
    } catch (error) {
        console.error('Error submitting adjustment:', error);
        showToast('Failed to send adjustment request: ' + error.message, 'error');
    }
}



async function submitLeave() {
    try {
        // Ensure we're authenticated
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            showToast('Not authenticated', 'error');
            return;
        }

        const leaveType = document.getElementById('leaveType').value;
        const startDate = document.getElementById('leaveStartDate').value;
        const endDate = document.getElementById('leaveEndDate').value;
        const reason = document.getElementById('leaveReason').value;

        if (!leaveType || !startDate || !endDate) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        // Generate all dates in range
        const dates = [];
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            dates.push(new Date(d).toISOString().split('T')[0]);
        }

        // Check for existing leave entries to avoid duplicates
        const { data: existingLeave } = await supabaseClient
            .from('staff_availability')
            .select('date')
            .eq('staff_id', AppState.staff.current.id)
            .in('date', dates);

        if (existingLeave && existingLeave.length > 0) {
            const conflictDates = existingLeave.map(l => l.date).join(', ');
            showToast(`You already have leave on: ${conflictDates}`, 'error');
            return;
        }

        // Check for existing shifts in this period
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('date')
            .eq('staff_id', AppState.staff.current.id)
            .in('date', dates)
            .is('deleted_at', null);

        if (existingShifts && existingShifts.length > 0) {
            showToast(`You have shifts on some of these dates. Please transfer them first.`, 'error');
            return;
        }

        // Create staff_availability entries for each date (WITHOUT created_by)
        const availabilityUpdates = dates.map(date => ({
            staff_id: AppState.staff.current.id,
            date: date,
            available: false,
            reason: `${leaveType}: ${reason || 'No reason provided'}`,
            created_at: new Date().toISOString()
            // REMOVED created_by - field doesn't exist in table
        }));

        // Use upsert to handle any potential conflicts
        const { error: availError } = await supabaseClient
            .from('staff_availability')
            .upsert(availabilityUpdates, {
                onConflict: 'staff_id,date'
            });

        if (availError) throw availError;

        // Also create a leave request record if table exists
        const { error: leaveError } = await supabaseClient
            .from('leave_requests')
            .insert({
                staff_id: AppState.staff.current.id,
                leave_type: leaveType,
                start_date: startDate,
                end_date: endDate,
                reason: reason,
                status: 'pending',
                created_at: new Date().toISOString()
                // Only add created_by if the table has this column
            });

        // Don't fail if leave_requests table doesn't exist
        if (leaveError && !leaveError.message.includes('does not exist')) {
            console.error('Leave request error (non-critical):', leaveError);
        }

        showToast('Leave request submitted successfully', 'success');
        closeModal('leaveModal');
        
        // Clear form
        document.getElementById('leaveType').value = '';
        document.getElementById('leaveStartDate').value = '';
        document.getElementById('leaveEndDate').value = '';
        document.getElementById('leaveReason').value = '';
        
        // Reload relevant sections
        if (typeof loadDashboard === 'function') loadDashboard();
        if (typeof loadSchedule === 'function') loadSchedule();

    } catch (error) {
        console.error('Error submitting leave:', error);
        showToast('Failed to submit leave request', 'error');
    }
}

async function loadShiftTimes() {
    const shiftId = document.getElementById('adjustmentShift').value;
    if (!shiftId) return;
    
    const { data: shift } = await supabaseClient
        .from('shifts')
        .select('start_time, end_time')
        .eq('id', shiftId)
        .single();
        
    if (shift) {
        document.getElementById('adjustmentStartTime').value = shift.start_time || '';
        document.getElementById('adjustmentEndTime').value = shift.end_time || '';
    }
}
async function loadLocations() {
    try {
        const { data: locationsData } = await supabaseClient
            .from('locations')
            .select('*')
            .is('deleted_at', null)
            .order('name');
        
        locations = locationsData || [];
        
        // Add default "Client Home" option with specific ID
        const defaultClientHome = {
            id: '00000000-0000-0000-0000-000000000001',
            name: 'Client Home'
        };
        
        // Ensure Client Home is in the list
        if (!locations.find(l => l.id === defaultClientHome.id)) {
            locations.unshift(defaultClientHome);
        }
        
        // Populate location dropdowns
        const selects = ['shiftLocation'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">Select Location</option>';
                locations.forEach(l => {
                    const isDefault = l.id === '00000000-0000-0000-0000-000000000001';
                    select.innerHTML += `<option value="${l.id}"${isDefault ? ' selected' : ''}>${l.name}</option>`;
                });
            }
        });
    } catch (error) {
        console.error('Error loading locations:', error);
        showToast('Failed to load locations', 'error');
    }
}


async function submitNote() {
    const shiftId = document.getElementById('noteShiftId').value;
    const noteType = document.getElementById('noteType').value;
    const content = document.getElementById('noteContent').value;
    
    if (!content.trim()) {
        showToast('Please enter a note', 'error');
        return;
    }
    
    try {
        // Get shift data first to check its type
        const { data: shiftData, error: shiftError } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('id', shiftId)
            .single();
        
        if (shiftError) throw shiftError;
        
        // Try to get UUID or generate one
        const shiftUuid = shiftData.uuid || generateUUIDFromInt(shiftData.id);
        
        // Insert with proper UUID handling
        const { error: noteError } = await supabaseClient
            .from('shift_notes')
            .insert({
                shift_id: shiftUuid,
                staff_id: currentStaff.id,
                note_type: noteType,
                note: content.trim(),
                created_at: new Date().toISOString()
            });
        
        if (noteError) {
            // Fallback to string ID if UUID fails
            if (noteError.code === '22P02') {
                const { error: retryError } = await supabaseClient
                    .from('shift_notes')
                    .insert({
                        shift_id: String(shiftId),
                        staff_id: currentStaff.id,
                        note_type: noteType,
                        note: content.trim(),
                        created_at: new Date().toISOString()
                    });
                
                if (retryError) throw retryError;
            } else {
                throw noteError;
            }
        }
        
        showToast('Note added successfully', 'success');
        closeModal('addNoteModal');
        
    } catch (error) {
        console.error('Error submitting note:', error);
        showToast('Failed to add note: ' + error.message, 'error');
    }
}



function previewImages() {
    const files = document.getElementById('noteImages').files;
    const container = document.getElementById('imagePreviewContainer');
    
    selectedImages = Array.from(files);
    container.innerHTML = '';
    
    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-preview';
            img.onclick = () => removeImage(index);
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedImages.splice(index, 1);
    previewImages();
}

async function uploadDocument() {
    const fileInput = document.getElementById('documentFile');
    const file = fileInput.files[0];
    const documentType = document.getElementById('documentType').value;
    const title = document.getElementById('documentTitle').value;
    const expiryDate = document.getElementById('documentExpiry').value;
    const notes = document.getElementById('documentNotes').value;
    
    if (!file || !documentType || !title) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    try {
        // Check file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            showToast('File size must be less than 10MB', 'error');
            return;
        }
        
        // Get file extension
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentStaff.id}/${Date.now()}_${title}.${fileExt}`;
        
        // Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('documents')
            .upload(fileName, file);
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from('documents')
            .getPublicUrl(fileName);
        
        // Save metadata to documents table
        const { error: dbError } = await supabaseClient
            .from('documents')
            .insert({
                entity_type: 'staff',
                entity_id: currentStaff.id,
                document_type: documentType,
                title: title,
                file_url: urlData.publicUrl,
                file_name: file.name,
                file_path: fileName,
                expiry_date: expiryDate || null,
                notes: notes || null,
                uploaded_by: currentStaff.id,
                created_at: new Date().toISOString()
            });
        
        if (dbError) throw dbError;
        
        showToast('Document uploaded successfully', 'success');
        closeModal('uploadDocumentModal');
        
        // Reload documents list
        if (typeof loadDocuments === 'function') {
            loadDocuments();
        }
        
    } catch (error) {
        console.error('Error uploading document:', error);
        showToast('Failed to upload document: ' + error.message, 'error');
    }
}

function createStaffSelector() {
    const selector = document.createElement('div');
    selector.id = 'staffSelector';
    selector.style.display = 'none';
    selector.style.position = 'fixed';
    selector.style.top = '60px';
    selector.style.right = '20px';
    selector.style.background = 'white';
    selector.style.border = '1px solid #ddd';
    selector.style.borderRadius = '8px';
    selector.style.padding = '10px';
    selector.style.zIndex = '1000';
    selector.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
    selector.innerHTML = `
        <h4 style="margin: 0 0 10px 0;">Quick Staff Switch</h4>
        <select id="staffQuickSelect" style="width: 200px; padding: 5px;">
            <option>Loading staff...</option>
        </select>
    `;
    document.body.appendChild(selector);
}


async function populateShiftModalDropdowns() {
    // Populate participants
    const participantSelect = document.getElementById('shiftParticipant');
    if (participantSelect && participants.length > 0) {
        participantSelect.innerHTML = '<option value="">Select Participant</option>' +
            participants.map(p => `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`).join('');
    }
    
    // Populate duty types
    const dutySelect = document.getElementById('shiftDutyType');
    if (dutySelect && dutyTypes.length > 0) {
        dutySelect.innerHTML = '<option value="">Select Duty Type</option>' +
            dutyTypes.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
    }
}



function checkExpiryRequired() {
    const documentType = document.getElementById('documentType').value;
    const expiryGroup = document.getElementById('expiryGroup');
    const expiryInput = document.getElementById('documentExpiry');
    
    const requiresExpiry = ['firstaid', 'wwcc', 'police', 'ndis', 'visa'].includes(documentType);
    
    if (requiresExpiry) {
        expiryGroup.style.display = 'block';
        expiryInput.required = true;
    } else {
        expiryGroup.style.display = 'block';
        expiryInput.required = false;
    }
}

// Profile editing functions
function editPersonalInfo() {
    const container = document.getElementById('personalInfo');
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">First Name</div>
            <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name}">
        </div>
        <div class="profile-field">
            <div class="field-label">Middle Name</div>
            <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Last Name</div>
            <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name}">
        </div>
        <div class="profile-field">
            <div class="field-label">Date of Birth</div>
            <input type="date" class="form-control" id="editDOB" value="${currentStaff.date_of_birth || ''}">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-primary" onclick="savePersonalInfo()">Save</button>
            <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
        </div>
    `;
}

async function savePersonalInfo() {
    try {
        const updates = {
            first_name: document.getElementById('editFirstName').value,
            middle_name: document.getElementById('editMiddleName').value || null,
            last_name: document.getElementById('editLastName').value,
            date_of_birth: document.getElementById('editDOB').value || null
        };

        const { error } = await supabaseClient
            .from('staff')
            .update(updates)
            .eq('id', currentStaff.id);

        if (error) throw error;

        currentStaff = { ...currentStaff, ...updates };
        showToast('Personal information updated', 'success');
        loadProfile();
        document.getElementById('userName').textContent = `${currentStaff.first_name} ${currentStaff.last_name}`;

    } catch (error) {
        console.error('Error updating personal info:', error);
        showToast('Failed to update personal information', 'error');
    }
}

function editContactInfo() {
    const container = document.getElementById('contactInfo');
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Email</div>
            <input type="email" class="form-control" id="editEmail" value="${currentStaff.email}">
        </div>
        <div class="profile-field">
            <div class="field-label">Phone</div>
            <input type="tel" class="form-control" id="editPhone" value="${currentStaff.phone || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Address</div>
            <textarea class="form-control" id="editAddress">${currentStaff.address || ''}</textarea>
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact</div>
            <input type="text" class="form-control" id="editEmergency" value="${currentStaff.emergency_contact || ''}" placeholder="Name and phone number">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-primary" onclick="saveContactInfo()">Save</button>
            <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
        </div>
    `;
}

async function saveContactInfo() {
    try {
        const updates = {
            email: document.getElementById('editEmail').value,
            phone: document.getElementById('editPhone').value || null,
            address: document.getElementById('editAddress').value || null,
            emergency_contact: document.getElementById('editEmergency').value || null
        };

        const { error } = await supabaseClient
            .from('staff')
            .update(updates)
            .eq('id', currentStaff.id);

        if (error) throw error;

        currentStaff = { ...currentStaff, ...updates };
        showToast('Contact information updated', 'success');
        loadProfile();

    } catch (error) {
        console.error('Error updating contact info:', error);
        showToast('Failed to update contact information', 'error');
    }
}

function editBankingInfo() {
    const container = document.getElementById('bankingInfo');
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Bank Name</div>
            <input type="text" class="form-control" id="editBankName" value="${currentStaff.bank_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">BSB</div>
            <input type="text" class="form-control" id="editBSB" value="${currentStaff.bsb || ''}" maxlength="6">
        </div>
        <div class="profile-field">
            <div class="field-label">Account Number</div>
            <input type="text" class="form-control" id="editAccountNumber" value="${currentStaff.account_number || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Tax File Number</div>
            <input type="text" class="form-control" id="editTFN" value="${currentStaff.tax_file_number || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Super Fund</div>
            <input type="text" class="form-control" id="editSuper" value="${currentStaff.super_fund || ''}">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-primary" onclick="saveBankingInfo()">Save</button>
            <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
        </div>
    `;
}

async function saveBankingInfo() {
    try {
        const updates = {
            bank_name: document.getElementById('editBankName').value || null,
            bsb: document.getElementById('editBSB').value || null,
            account_number: document.getElementById('editAccountNumber').value || null,
            tax_file_number: document.getElementById('editTFN').value || null,
            super_fund: document.getElementById('editSuper').value || null
        };

        const { error } = await supabaseClient
            .from('staff')
            .update(updates)
            .eq('id', currentStaff.id);

        if (error) throw error;

        currentStaff = { ...currentStaff, ...updates };
        showToast('Banking information updated', 'success');
        loadProfile();

    } catch (error) {
        console.error('Error updating banking info:', error);
        showToast('Failed to update banking information', 'error');
    }
}

// Availability functions
function toggleDayAvailability(day, available) {
    // Update all time slots for the day
    for (let slot = 0; slot < 4; slot++) {
        weeklyAvailability[`${day}_${slot}`] = available;
    }
    renderAvailability();
}

function toggleTimeSlot(day, slot, element) {
    const key = `${day}_${slot}`;
    weeklyAvailability[key] = !weeklyAvailability[key];
    element.classList.toggle('selected');
}

async function saveAvailability() {
    try {
        const updates = [];
        for (let day = 0; day < 7; day++) {
            for (let slot = 0; slot < 4; slot++) {
                updates.push({
                    staff_id: currentStaff.id,
                    day_of_week: day,
                    time_slot: slot,
                    available: weeklyAvailability[`${day}_${slot}`] || false
                });
            }
        }

        const { error } = await supabaseClient
            .from('staff_weekly_availability')
            .upsert(updates, { onConflict: 'staff_id,day_of_week,time_slot' });

        if (error) throw error;

        showToast('Availability updated successfully', 'success');

    } catch (error) {
        console.error('Error saving availability:', error);
        showToast('Failed to save availability', 'error');
    }
}

async function handleBannerUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
        // Check file size
        if (file.size > 5 * 1024 * 1024) {
            showToast('Banner image must be less than 5MB', 'error');
            return;
        }
        
        // Get file extension properly
        const fileExt = file.name.split('.').pop();
        const fileName = `profile-banners/${currentStaff.id}_${Date.now()}.${fileExt}`;
        
        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
            .from('assets')
            .upload(fileName, file);
        
        if (error) throw error;
        
        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from('assets')
            .getPublicUrl(fileName);
        
        // Update staff record with banner URL
        const { error: updateError } = await supabaseClient
            .from('staff')
            .update({ profile_banner_url: urlData.publicUrl })
            .eq('id', currentStaff.id);
        
        if (updateError) throw updateError;
        
        // Update UI
        loadProfileBanner();
        showToast('Banner uploaded successfully', 'success');
        
    } catch (error) {
        console.error('Error uploading banner:', error);
        showToast('Failed to upload banner', 'error');
    }
}

function createMissingModals() {
    const modalsHTML = `
        <!-- Add Shift Modal -->
        <div id="addShiftModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New Shift</h2>
                    <button class="modal-close" onclick="closeModal('addShiftModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addShiftForm">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="shiftDate" required>
                        </div>
                        <div class="form-group">
                            <label>Start Time</label>
                            <input type="time" id="shiftStartTime" required>
                        </div>
                        <div class="form-group">
                            <label>End Time</label>
                            <input type="time" id="shiftEndTime" required>
                        </div>
                        <div class="form-group">
                            <label>Participant</label>
                            <select id="shiftParticipant" required></select>
                        </div>
                        <div class="form-group">
                            <label>Duty Type</label>
                            <select id="shiftDutyType" required></select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('addShiftModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="submitShift()">Add Shift</button>
                </div>
            </div>
        </div>
        
        <!-- Transfer Request Modal -->
        <div id="transferModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Request Shift Transfer</h2>
                    <button class="modal-close" onclick="closeModal('transferModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="transferForm">
                        <div class="form-group">
                            <label>Select Shift to Transfer</label>
                            <select id="transferShift" required></select>
                        </div>
                        <div class="form-group">
                            <label>Transfer to Staff</label>
                            <select id="transferToStaff" required></select>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <textarea id="transferReason" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('transferModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="submitTransfer()">Submit Request</button>
                </div>
            </div>
        </div>
        
        <!-- Adjustment Request Modal -->
        <div id="adjustmentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Request Shift Adjustment</h2>
                    <button class="modal-close" onclick="closeModal('adjustmentModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="adjustmentForm">
                        <div class="form-group">
                            <label>Select Shift</label>
                            <select id="adjustmentShift" required></select>
                        </div>
                        <div class="form-group">
                            <label>Adjustment Type</label>
                            <select id="adjustmentType" required>
                                <option value="time_change">Time Change</option>
                                <option value="cancellation">Cancellation</option>
                                <option value="extension">Extension</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Details</label>
                            <textarea id="adjustmentDetails" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('adjustmentModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="submitAdjustment()">Submit Request</button>
                </div>
            </div>
        </div>
        
        <!-- Leave Request Modal -->
        <div id="leaveModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Request Leave</h2>
                    <button class="modal-close" onclick="closeModal('leaveModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="leaveForm">
                        <div class="form-group">
                            <label>Leave Type</label>
                            <select id="leaveType" required>
                                <option value="annual">Annual Leave</option>
                                <option value="sick">Sick Leave</option>
                                <option value="personal">Personal Leave</option>
                                <option value="unpaid">Unpaid Leave</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="leaveStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="leaveEndDate" required>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <textarea id="leaveReason" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('leaveModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="submitLeave()">Submit Request</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modals to body
    document.body.insertAdjacentHTML('beforeend', modalsHTML);
}


async function loadProfileBanner() {
    if (!currentStaff || !currentStaff.profile_banner_url) return;
    
    const bannerElement = document.getElementById('profileBanner');
    if (bannerElement) {
        bannerElement.style.backgroundImage = `url(${currentStaff.profile_banner_url})`;
        bannerElement.style.backgroundSize = 'cover';
        bannerElement.style.backgroundPosition = 'center';
    }
}


// Button styling classes to add to CSS
const additionalStyles = `
.btn {
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
}

.btn-secondary:hover {
    background: #d0d0d0;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 12px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-dark);
}

.btn-outline:hover {
    background: var(--bg-light);
}
`;

async function loadHandoverNotes(shiftId) {
    try {
        const container = document.getElementById('handoverNotes');
        
        if (!container) {
            console.warn('Handover notes container not found');
            return;
        }
        
        // First, get the shift to find its UUID if it exists
        const { data: shiftData } = await supabaseClient
            .from('shifts')
            .select('id, uuid')
            .eq('id', parseInt(shiftId))
            .single();
        
        if (!shiftData) {
            container.innerHTML = '<div style="color: var(--text-light);">Shift not found</div>';
            return;
        }
        
        // Try using UUID if it exists, otherwise convert integer to UUID format
        let queryId = shiftData.uuid || generateUUIDFromInt(shiftData.id);
        
        const { data: notes, error } = await supabaseClient
            .from('shift_notes')
            .select(`
                *,
                staff:staff_id(first_name, last_name)
            `)
            .eq('shift_id', queryId)
            .in('note_type', ['handover', 'shift'])
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error loading handover notes:', error);
            // If UUID fails, try as a string representation of the integer
            if (error.code === '22P02') {
                const { data: notesRetry } = await supabaseClient
                    .from('shift_notes')
                    .select(`
                        *,
                        staff:staff_id(first_name, last_name)
                    `)
                    .eq('shift_id', String(shiftId))
                    .in('note_type', ['handover', 'shift'])
                    .order('created_at', { ascending: false });
                
                if (notesRetry && notesRetry.length > 0) {
                    renderNotes(container, notesRetry);
                    return;
                }
            }
            container.innerHTML = '<div style="color: var(--text-light);">Failed to load notes</div>';
            return;
        }
        
        renderNotes(container, notes);
        
    } catch (error) {
        console.error('Error in loadHandoverNotes:', error);
        const container = document.getElementById('handoverNotes');
        if (container) {
            container.innerHTML = '<div style="color: var(--text-light);">Failed to load notes</div>';
        }
    }
}


function generateUUIDFromInt(intId) {
    // Create a padded hex representation
    const hex = intId.toString(16).padStart(8, '0');
    // Format as UUID-like string (not a real UUID but follows the format)
    return `00000000-0000-4000-8000-${hex.padStart(12, '0')}`;
}


async function addNoteToShift(shiftId) {
    try {
        // Open the modal
        const modal = document.getElementById('addNoteModal');
        if (!modal) {
            console.error('Add note modal not found');
            showToast('Note modal not available', 'error');
            return;
        }
        
        // Store the shift ID for later use
        window.currentNoteShiftId = shiftId;
        
        // Set the shift ID in a hidden field if it exists
        const shiftIdField = document.getElementById('noteShiftId');
        if (shiftIdField) {
            shiftIdField.value = shiftId;
        }
        
        // Open the modal
        openModal('addNoteModal');
        
        // Pre-select the shift if there's a dropdown
        const shiftSelect = document.getElementById('noteShift');
        if (shiftSelect) {
            setTimeout(() => {
                shiftSelect.value = shiftId;
            }, 100);
        }
        
    } catch (error) {
        console.error('Error in addNoteToShift:', error);
        showToast('Failed to open note form', 'error');
    }
}

async function loadSchedule() {
    try {
        const scheduleSection = document.getElementById('schedule');
        if (!scheduleSection) return;
        
        // Ensure we have current staff data
        if (!AppState.staff.current) {
            console.error('No current staff for schedule');
            return;
        }

        // Calculate current week (Monday to Sunday)
        const today = getTestDate();
        const currentDay = today.getDay();
        const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1); // Adjust when Sunday
        const weekStart = new Date(today.setDate(diff));
        weekStart.setHours(0, 0, 0, 0);
        
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);
        
        // Format dates for query
        const startDate = weekStart.toISOString().split('T')[0];
        const endDate = weekEnd.toISOString().split('T')[0];
        
        console.log('Loading schedule for week:', startDate, 'to', endDate);
        
        // Load shifts for the week
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(id, first_name, last_name, ndis_number),
                locations(name, address),
                duty_types(name)
            `)
            .eq('staff_id', AppState.staff.current.id)
            .gte('date', startDate)
            .lte('date', endDate)
            .order('date', { ascending: true })
            .order('start_time', { ascending: true });

        if (error) {
            console.error('Error loading schedule:', error);
            showToast('Failed to load schedule', 'error');
            return;
        }

        // Store shifts globally
        allShifts = shifts || [];
        myShifts = shifts || [];
        
        console.log('Schedule loaded:', allShifts.length, 'shifts');
        
        // Render the weekly schedule
        renderWeeklySchedule(weekStart, weekEnd, shifts || []);
        
    } catch (error) {
        console.error('Error in loadSchedule:', error);
        showToast('Failed to load schedule', 'error');
    }
}

function renderWeeklySchedule(weekStart, weekEnd, shifts) {
    const container = document.getElementById('scheduleGrid');
    if (!container) return;
    
    // Create week navigation header
    let html = `
        <div class="schedule-header">
            <button class="btn btn-sm" onclick="changeWeek(-1)">← Previous Week</button>
            <div class="week-display">
                <h3>${formatDateShort(weekStart.toISOString().split('T')[0])} - ${formatDateShort(weekEnd.toISOString().split('T')[0])}</h3>
            </div>
            <button class="btn btn-sm" onclick="changeWeek(1)">Next Week →</button>
        </div>
    `;
    
    // Group shifts by date
    const shiftsByDate = {};
    const daysOfWeek = [];
    
    // Generate all days of the week
    for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        daysOfWeek.push(dateStr);
        shiftsByDate[dateStr] = [];
    }
    
    // Populate shifts into their dates
    shifts.forEach(shift => {
        if (shiftsByDate[shift.date]) {
            shiftsByDate[shift.date].push(shift);
        }
    });
    
    // Render each day
    html += '<div class="weekly-schedule">';
    
    daysOfWeek.forEach(dateStr => {
        const date = new Date(dateStr + 'T12:00:00');
        const isToday = dateStr === getTestDate().toISOString().split('T')[0];
        const dayShifts = shiftsByDate[dateStr];
        
        html += `
            <div class="day-section ${isToday ? 'today' : ''}">
                <div class="day-header">
                    <div class="day-name">${date.toLocaleDateString('en-AU', { weekday: 'long' })}</div>
                    <div class="day-date">${date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })}</div>
                    ${dayShifts.length > 0 ? `<span class="shift-count">${dayShifts.length} shift${dayShifts.length > 1 ? 's' : ''}</span>` : ''}
                </div>
                <div class="day-shifts">
        `;
        
        if (dayShifts.length === 0) {
            html += '<div class="no-shifts">No shifts scheduled</div>';
        } else {
            dayShifts.forEach(shift => {
                const participant = shift.participants;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                html += `
                    <div class="shift-item" onclick="showParticipantShifts('${shift.participant_id}', '${participantName.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                        <div class="shift-participant">
                            <strong>${participantName}</strong>
                            ${participant?.ndis_number ? `<span class="ndis-number">(${participant.ndis_number})</span>` : ''}
                        </div>
                        <div class="shift-location">
                            📍 ${shift.locations?.name || 'Client Home'}
                        </div>
                        ${shift.duty_types ? `<div class="shift-duty-type">${shift.duty_types.name}</div>` : ''}
                    </div>
                `;
            });
        }
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    container.innerHTML = html;
}

// Function to change week
window.changeWeek = function(direction) {
    window.currentWeekOffset = (window.currentWeekOffset || 0) + direction;
    
    const today = getTestDate();
    const currentDay = today.getDay();
    const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
    const weekStart = new Date(today.setDate(diff + (window.currentWeekOffset * 7)));
    
    loadSchedule();
};

// Function to show all shifts for a participant
window.showParticipantShifts = async function(participantId, participantName) {
    try {
        if (!participantId || participantId === 'null') {
            showToast('No participant selected', 'info');
            return;
        }
        
        // Load all shifts for this participant
        const { data: participantShifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                staff(first_name, last_name),
                locations(name),
                duty_types(name)
            `)
            .eq('participant_id', participantId)
            .eq('staff_id', AppState.staff.current.id)
            .order('date', { ascending: false })
            .limit(50);
        
        if (error) {
            console.error('Error loading participant shifts:', error);
            showToast('Failed to load participant shifts', 'error');
            return;
        }
        
        // Create modal to show shifts
        const modalHtml = `
            <div id="participantShiftsModal" class="modal active" style="display: flex;">
                <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2>Shifts for ${participantName}</h2>
                        <button class="modal-close" onclick="closeModal('participantShiftsModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${participantShifts.length === 0 ? 
                            '<p>No shifts found for this participant</p>' :
                            participantShifts.map(shift => `
                                <div class="shift-history-item">
                                    <div class="shift-date-header">
                                        ${formatDateLong(shift.date)}
                                    </div>
                                    <div class="shift-details">
                                        <div>${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                             ${shift.end_time ? formatTime(shift.end_time) : ''}</div>
                                        <div>📍 ${shift.locations?.name || 'Client Home'}</div>
                                        ${shift.duty_types ? `<div>Type: ${shift.duty_types.name}</div>` : ''}
                                        <div class="shift-status-badge ${shift.status}">${shift.status}</div>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            </div>
        `;
        
        // Remove any existing modal
        const existingModal = document.getElementById('participantShiftsModal');
        if (existingModal) existingModal.remove();
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Error showing participant shifts:', error);
        showToast('Failed to load participant history', 'error');
    }
};

function changeSchedulePeriod(direction) {
    if (!window.currentPeriodStart) {
        setCurrentPayPeriod();
    }
    
    const weeks = direction * 2; // Move by 2 weeks (fortnight)
    window.currentPeriodStart.setDate(window.currentPeriodStart.getDate() + (weeks * 7));
    window.currentPeriodEnd.setDate(window.currentPeriodEnd.getDate() + (weeks * 7));
    
    loadSchedule();
}


// ==========================================
// SIMPLIFIED DATE/TIME CALCULATION SYSTEM
// ==========================================

// 1. Time Constants & Configuration
const TIME_CONFIG = {
    periods: {
        day: { start: 6, end: 20 },      // 6 AM - 8 PM
        evening: { start: 20, end: 24 },  // 8 PM - Midnight
        night: { start: 0, end: 6 }       // Midnight - 6 AM
    },
    days: {
        weekday: [1, 2, 3, 4, 5],  // Mon-Fri
        saturday: [6],
        sunday: [0]
    },
    sleepover: {
        hours: 2,  // Sleepovers count as 2 hours
        count: 1
    }
};

// 2. Main Shift Hours Calculator (Simplified)
function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };
    
    // Handle sleepover shifts
    if (isSleepoverShift(shift)) {
        result.sleepover = TIME_CONFIG.sleepover.count;
        result.total = TIME_CONFIG.sleepover.hours;
        return result;
    }
    
    // Validate shift has required times
    if (!shift.start_time || !shift.end_time) {
        return result;
    }
    
    // Parse shift times
    const { startTime, endTime } = parseShiftTimes(shift);
    if (!startTime || !endTime) return result;
    
    // Calculate total hours
    result.total = (endTime - startTime) / (1000 * 60 * 60);
    
    // Categorize hours by day type
    const shiftDate = new Date(shift.date + 'T12:00:00');
    const dayOfWeek = shiftDate.getDay();
    
    // Public holiday takes precedence
    if (shift.is_public_holiday === true) {
        result.publicHoliday = result.total;
        return result;
    }
    
    // Weekend shifts
    if (dayOfWeek === 0) {
        result.sunday = result.total;
        return result;
    }
    
    if (dayOfWeek === 6) {
        result.saturday = result.total;
        return result;
    }
    
    // Weekday shifts - break down by time period
    const breakdown = calculateWeekdayBreakdown(startTime, endTime);
    result.weekdayDay = breakdown.day;
    result.weekdayEvening = breakdown.evening;
    result.weekdayNight = breakdown.night;
    
    return result;
}

// 3. Helper Functions
function isSleepoverShift(shift) {
    const dutyType = shift.duty_types?.name || '';
    return dutyType.toLowerCase().includes('sleepover') || !shift.start_time;
}

function parseShiftTimes(shift) {
    const [startHour, startMin] = shift.start_time.split(':').map(Number);
    const [endHour, endMin] = shift.end_time.split(':').map(Number);
    
    const startTime = new Date(shift.date + 'T' + shift.start_time);
    let endTime = new Date(shift.date + 'T' + shift.end_time);
    
    // Handle overnight shifts
    if (endHour < startHour || (endHour === startHour && endMin < startMin)) {
        endTime.setDate(endTime.getDate() + 1);
    }
    
    return { startTime, endTime };
}

function calculateWeekdayBreakdown(startTime, endTime) {
    const breakdown = { day: 0, evening: 0, night: 0 };
    let current = new Date(startTime);
    
    while (current < endTime) {
        const hour = current.getHours();
        const nextHour = new Date(current);
        nextHour.setHours(hour + 1, 0, 0, 0);
        
        const periodEnd = nextHour > endTime ? endTime : nextHour;
        const periodHours = (periodEnd - current) / (1000 * 60 * 60);
        
        // Assign to correct period
        if (hour >= TIME_CONFIG.periods.day.start && hour < TIME_CONFIG.periods.day.end) {
            breakdown.day += periodHours;
        } else if (hour >= TIME_CONFIG.periods.evening.start) {
            breakdown.evening += periodHours;
        } else {
            breakdown.night += periodHours;
        }
        
        current = new Date(periodEnd);
    }
    
    return breakdown;
}

// 4. Unified Date/Time Formatter
const DateTimeFormatter = {
    // Locale configuration
    locale: 'en-AU',
    
    // Format configurations
    formats: {
        long: { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        },
        short: { 
            weekday: 'short',
            day: 'numeric', 
            month: 'short' 
        },
        friendly: { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short' 
        },
        date: {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        },
        datetime: {
            day: 'numeric',
            month: 'short',
            hour: 'numeric',
            minute: '2-digit'
        }
    },
    
    // Parse date consistently
    parseDate(dateString) {
        if (!dateString) return null;
        // Add noon time to avoid timezone issues
        if (!dateString.includes('T')) {
            dateString += 'T12:00:00';
        }
        return new Date(dateString);
    },
    
    // Format date with specified format
    format(dateString, formatType = 'short') {
        if (!dateString) return '';
        const date = this.parseDate(dateString);
        return date.toLocaleDateString(this.locale, this.formats[formatType]);
    },
    
    // Format time (12-hour with AM/PM)
    formatTime(timeString) {
        if (!timeString) return '';
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const period = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        return `${displayHour}:${minutes} ${period}`;
    },
    
    // Format datetime
    formatDateTime(dateString) {
        if (!dateString) return '';
        const date = this.parseDate(dateString);
        return date.toLocaleString(this.locale, this.formats.datetime);
    },
    
    // Get greeting based on time
    getGreeting(date = new Date()) {
        const hour = date.getHours();
        if (hour < 12) return 'Good morning';
        if (hour < 17) return 'Good afternoon';
        return 'Good evening';
    }
};

// 5. Convenience Functions (for backward compatibility)
const formatDateLong = (date) => DateTimeFormatter.format(date, 'long');
const formatDateShort = (date) => DateTimeFormatter.format(date, 'short');
const formatDateFriendly = (date) => DateTimeFormatter.format(date, 'friendly');
const formatDate = (date) => DateTimeFormatter.format(date, 'date');
const formatDateTime = (date) => DateTimeFormatter.formatDateTime(date);
const formatTime = (time) => DateTimeFormatter.formatTime(time);
const formatTime12Hour = (time) => DateTimeFormatter.formatTime(time); // Alias

// 6. Week/Period Utilities
function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday start
    return new Date(d.setDate(diff));
}

function setGreeting() {
    const testDate = typeof getTestDate === 'function' ? getTestDate() : new Date();
    const greeting = DateTimeFormatter.getGreeting(testDate);
    
    const greetingEl = document.getElementById('greeting');
    if (greetingEl && currentStaff) {
        greetingEl.textContent = `${greeting}, ${currentStaff.first_name}!`;
    }
    
    const dateEl = document.getElementById('currentDate');
    if (dateEl) {
        dateEl.textContent = formatDateLong(testDate.toISOString().split('T')[0]);
    }
}

// 7. Reference Data Loader (Simplified)
const DataLoader = {
    // Store for loaded data
    cache: {
        participants: [],
        staff: [],
        dutyTypes: [],
        locations: []
    },
    
    // Load all reference data
    async loadReferenceData() {
        console.log('Loading reference data...');
        
        const loaders = [
            this.loadParticipants(),
            this.loadStaff(),
            this.loadDutyTypes(),
            this.loadLocations()
        ];
        
        try {
            await Promise.all(loaders);
            console.log('Reference data loaded successfully');
            return this.cache;
        } catch (error) {
            console.error('Error loading reference data:', error);
            showToast('Failed to load reference data', 'error');
            return this.cache;
        }
    },
    
    async loadParticipants() {
        const { data, error } = await supabaseClient
            .from('participants')
            .select('*')
            .eq('is_active', true)
            .order('first_name');
        
        if (error) {
            console.error('Error loading participants:', error);
            return [];
        }
        
        this.cache.participants = data || [];
        participants = this.cache.participants; // Global compatibility
        console.log('Loaded participants:', this.cache.participants.length);
        return this.cache.participants;
    },
    
    async loadStaff() {
        const { data, error } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('is_active', true)
            .order('first_name');
        
        if (error) {
            console.error('Error loading staff:', error);
            return [];
        }
        
        this.cache.staff = data || [];
        staff = this.cache.staff; // Global compatibility
        console.log('Loaded staff:', this.cache.staff.length);
        return this.cache.staff;
    },
    
    async loadDutyTypes() {
        const { data, error } = await supabaseClient
            .from('duty_types')
            .select('*')
            .order('name');
        
        if (error) {
            console.error('Error loading duty types:', error);
            return [];
        }
        
        this.cache.dutyTypes = data || [];
        dutyTypes = this.cache.dutyTypes; // Global compatibility
        console.log('Loaded duty types:', this.cache.dutyTypes.length);
        return this.cache.dutyTypes;
    },
    
    async loadLocations() {
        const { data, error } = await supabaseClient
            .from('locations')
            .select('*')
            .order('name');
        
        if (error) {
            console.error('Error loading locations:', error);
            return [];
        }
        
        this.cache.locations = data || [];
        locations = this.cache.locations; // Global compatibility
        console.log('Loaded locations:', this.cache.locations.length);
        return this.cache.locations;
    }
};

// Replace the old loadReferenceData function with:
const loadReferenceData = () => DataLoader.loadReferenceData();



async function viewShiftDetails(shiftId) {
    try {
        const { data: shift, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participant:participant_id(first_name, last_name, phone),
                location:location_id(name, address),
                duty_type:duty_type_id(name),
                staff:staff_id(first_name, last_name)
            `)
            .eq('id', shiftId)
            .single();

        if (error) throw error;

        // Show details in a simple alert or modal
        const details = `
Shift Details:
Date: ${formatDateLong(shift.date)}
Time: ${shift.start_time || 'Sleepover'} - ${shift.end_time || ''}
Client: ${shift.participant ? `${shift.participant.first_name} ${shift.participant.last_name}` : 'Unassigned'}
Location: ${shift.location?.name || 'TBC'}
Service: ${shift.duty_type?.name || 'Standard Care'}
        `;
        
        if (confirm(details + '\n\nWould you like to request a transfer for this shift?')) {
            openTransferModal(shiftId);
        }

    } catch (error) {
        console.error('Error viewing shift:', error);
        showToast('Failed to load shift details', 'error');
    }
}

async function openTransferModal(shiftId) {
    try {
        // Load available staff
        await loadTransferableShifts(); // This populates the shift dropdown
        
        // Set the specific shift if provided
        if (shiftId) {
            document.getElementById('transferShiftSelect').value = shiftId;
        }
        
        // Load staff options
        const { data: staffList } = await supabaseClient
            .from('staff')
            .select('id, first_name, last_name')
            .neq('id', currentStaff.id)
            .eq('active', true)
            .order('first_name');

        const staffSelect = document.getElementById('transferToStaff');
        staffSelect.innerHTML = '<option value="">Select staff member (optional)</option>' +
            (staffList || []).map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('');
        
        openModal('transferShiftModal');
        
    } catch (error) {
        console.error('Error opening transfer modal:', error);
        showToast('Failed to load transfer options', 'error');
    }
}
function changeMonth(direction) {
    if (!window.currentMonthOffset) {
        window.currentMonthOffset = 0;
    }
    window.currentMonthOffset += direction;
    loadSchedule();
}

        function populateParticipantFilter() {
            const select = document.getElementById('participantFilter');
            const uniqueParticipants = {};
            
            allShifts.forEach(shift => {
                if (shift.participant) {
                    uniqueParticipants[shift.participant_id] = shift.participant;
                }
            });

            select.innerHTML = '<option value="">All My Clients</option>';
            Object.values(uniqueParticipants).forEach(participant => {
                select.innerHTML += `
                    <option value="${participant.id}">
                        ${participant.first_name} ${participant.last_name}
                    </option>
                `;
            });
        }


        // ==========================================
// MODULAR UI RENDERING SYSTEM
// ==========================================

// 1. UI Component Factory
const UIComponents = {
    // Security: HTML escaping
    escape(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },
    
    // Generic element creator
    createElement(tag, options = {}) {
        const element = document.createElement(tag);
        
        if (options.class) element.className = options.class;
        if (options.id) element.id = options.id;
        if (options.text) element.textContent = options.text;
        if (options.html) element.innerHTML = options.html;
        if (options.style) element.style.cssText = options.style;
        if (options.data) {
            Object.entries(options.data).forEach(([key, value]) => {
                element.dataset[key] = value;
            });
        }
        if (options.attrs) {
            Object.entries(options.attrs).forEach(([key, value]) => {
                element.setAttribute(key, value);
            });
        }
        if (options.events) {
            Object.entries(options.events).forEach(([event, handler]) => {
                element.addEventListener(event, handler);
            });
        }
        if (options.children) {
            options.children.forEach(child => {
                if (typeof child === 'string') {
                    element.insertAdjacentHTML('beforeend', child);
                } else if (child) {
                    element.appendChild(child);
                }
            });
        }
        
        return element;
    },
    
    // Empty state component
    emptyState(message) {
        return this.createElement('div', {
            class: 'p-2 text-center',
            style: 'color: var(--text-light);',
            text: message
        });
    },
    
    // Shift list item component
    shiftListItem(shift, options = {}) {
        const participant = shift.participants;
        const hours = calculateShiftHours(shift);
        const dutyType = shift.duty_types?.name || 'Regular';
        
        return this.createElement('div', {
            class: 'shift-list-item',
            data: { shiftId: shift.id },
            children: [
                this.createElement('div', {
                    class: 'shift-info',
                    children: [
                        this.createElement('div', {
                            class: 'shift-date-time',
                            html: `
                                ${options.showDate ? formatDateShort(shift.date) + ' - ' : ''}
                                ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                ${shift.end_time ? formatTime(shift.end_time) : ''}
                                ${dutyType !== 'Regular' ? `<span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">${dutyType}</span>` : ''}
                            `
                        }),
                        participant && this.createElement('div', {
                            class: 'shift-client',
                            text: `${participant.first_name} ${participant.last_name}${shift.locations ? ` - ${shift.locations.name}` : ''}`
                        })
                    ].filter(Boolean)
                }),
                this.createElement('div', {
                    class: 'shift-hours',
                    children: [
                        this.createElement('div', {
                            class: 'shift-hours-value',
                            text: `${hours.total.toFixed(1)}h`
                        })
                    ]
                })
            ]
        });
    },
    
    // Group header component
    groupHeader(title, totalHours, style = {}) {
        return this.createElement('div', {
            style: `font-weight: 600; padding: 12px 16px; background: var(--bg-light); border-bottom: 1px solid var(--border-color); ${style.css || ''}`,
            children: [
                this.createElement('span', { text: title }),
                this.createElement('span', {
                    style: 'float: right; color: var(--primary-color);',
                    text: `${totalHours.toFixed(1)}h`
                })
            ]
        });
    },
    
    // Transfer item component
    transferItem(transfer, type = 'incoming') {
        const statusClass = `status-${transfer.status || 'pending'}`;
        const isIncoming = type === 'incoming';
        
        return this.createElement('div', {
            class: 'transfer-item',
            data: { transferId: transfer.id },
            children: [
                // Header
                this.createElement('div', {
                    class: 'transfer-header',
                    children: [
                        this.createElement('div', {
                            children: [
                                this.createElement('div', {
                                    class: 'transfer-date',
                                    text: formatDateLong(transfer.shift?.date)
                                }),
                                this.createElement('div', {
                                    class: 'transfer-time',
                                    html: `
                                        ${transfer.shift?.start_time ? formatTime(transfer.shift.start_time) : 'Sleepover'} - 
                                        ${transfer.shift?.end_time ? formatTime(transfer.shift.end_time) : ''}
                                    `
                                })
                            ]
                        }),
                        this.createElement('div', {
                            class: `transfer-badge ${statusClass}`,
                            text: transfer.status || 'Pending'
                        })
                    ]
                }),
                
                // From/To line
                this.createElement('div', {
                    class: 'transfer-from',
                    text: isIncoming ? 
                        `From: ${transfer.from_staff?.first_name} ${transfer.from_staff?.last_name}` :
                        `To: ${transfer.to_staff?.first_name || 'Pending'} ${transfer.to_staff?.last_name || ''}`
                }),
                
                // Reason (if exists)
                transfer.reason && this.createElement('div', {
                    class: 'transfer-reason',
                    text: `"${this.escape(transfer.reason)}"`
                }),
                
                // Actions (only for pending incoming)
                isIncoming && transfer.status === 'pending' && this.createElement('div', {
                    class: 'transfer-actions',
                    children: [
                        this.createElement('button', {
                            class: 'transfer-btn accept',
                            text: 'Accept',
                            events: { click: () => acceptTransfer(transfer.id) }
                        }),
                        this.createElement('button', {
                            class: 'transfer-btn decline',
                            text: 'Decline',
                            events: { click: () => declineTransfer(transfer.id) }
                        })
                    ]
                })
            ].filter(Boolean)
        });
    },
    
    // Note item component
    noteItem(note) {
        const staffName = note.staff ? 
            `${note.staff.first_name} ${note.staff.last_name}` : 
            'Unknown Staff';
        
        return this.createElement('div', {
            class: 'note-item',
            children: [
                this.createElement('div', {
                    class: 'note-header',
                    children: [
                        this.createElement('span', {
                            class: 'note-author',
                            text: staffName
                        }),
                        this.createElement('span', {
                            class: 'note-time',
                            text: formatDateTime(note.created_at)
                        })
                    ]
                }),
                this.createElement('div', {
                    class: 'note-content',
                    text: note.note
                }),
                this.createElement('div', {
                    class: 'note-type',
                    text: note.note_type
                })
            ]
        });
    },
    
    // Availability day component
    availabilityDay(day, index, availability) {
        const isAvailable = availability[`${index}_0`] || 
                          availability[`${index}_1`] || 
                          availability[`${index}_2`] || 
                          availability[`${index}_3`];
        
        return this.createElement('div', {
            class: 'availability-day',
            children: [
                this.createElement('div', {
                    class: 'availability-day-header',
                    children: [
                        this.createElement('span', {
                            class: 'day-name',
                            text: day
                        }),
                        this.createElement('label', {
                            class: 'availability-toggle',
                            children: [
                                this.createElement('input', {
                                    attrs: {
                                        type: 'checkbox',
                                        checked: isAvailable
                                    },
                                    events: {
                                        change: (e) => toggleDayAvailability(index, e.target.checked)
                                    }
                                }),
                                this.createElement('span', {
                                    class: 'toggle-slider'
                                })
                            ]
                        })
                    ]
                }),
                this.createElement('div', {
                    class: 'availability-times',
                    children: [
                        { slot: 0, label: 'Morning' },
                        { slot: 1, label: 'Afternoon' },
                        { slot: 2, label: 'Evening' },
                        { slot: 3, label: 'Night' }
                    ].map(({ slot, label }) => 
                        this.createElement('div', {
                            class: `time-slot ${availability[`${index}_${slot}`] ? 'selected' : ''}`,
                            text: label,
                            events: {
                                click: function() { toggleTimeSlot(index, slot, this); }
                            }
                        })
                    )
                })
            ]
        });
    }
};

// 2. Refactored Render Functions

function renderTimesheetShifts() {
    const container = document.getElementById('timesheetShifts');
    if (!container) {
        console.error('Timesheet shifts container not found');
        return;
    }
    
    // Clear container
    container.innerHTML = '';
    
    if (!AppState.shifts.my || AppState.shifts.my.length === 0) {
        container.appendChild(UIComponents.emptyState('No shifts in this period'));
        return;
    }
    
    const fragment = document.createDocumentFragment();
    
    if (AppState.ui.timesheetView === 'date') {
        // Group by date
        const grouped = {};
        AppState.shifts.my.forEach(shift => {
            if (!grouped[shift.date]) grouped[shift.date] = [];
            grouped[shift.date].push(shift);
        });
        
        Object.keys(grouped).sort().forEach(date => {
            const dayShifts = grouped[date];
            const dayHours = dayShifts.reduce((sum, s) => 
                sum + (calculateShiftHours(s).total || 0), 0
            );
            
            // Add header
            fragment.appendChild(
                UIComponents.groupHeader(formatDateLong(date), dayHours)
            );
            
            // Add shifts
            dayShifts.forEach(shift => {
                fragment.appendChild(
                    UIComponents.shiftListItem(shift, { showDate: false })
                );
            });
        });
        
    } else {
        // Group by participant
        const grouped = {};
        AppState.shifts.my.forEach(shift => {
            const key = shift.participant_id || 'unassigned';
            if (!grouped[key]) {
                grouped[key] = {
                    participant: shift.participants,
                    shifts: []
                };
            }
            grouped[key].shifts.push(shift);
        });
        
        Object.values(grouped).forEach(group => {
            const totalHours = group.shifts.reduce((sum, s) => 
                sum + (calculateShiftHours(s).total || 0), 0
            );
            const name = group.participant ? 
                `${group.participant.first_name} ${group.participant.last_name}` : 
                'Unassigned';
            
            // Add header
            fragment.appendChild(
                UIComponents.groupHeader(name, totalHours)
            );
            
            // Add shifts
            group.shifts.forEach(shift => {
                fragment.appendChild(
                    UIComponents.shiftListItem(shift, { showDate: true })
                );
            });
        });
    }
    
    container.appendChild(fragment);
}

function renderIncomingTransfers(transfers) {
    const container = document.getElementById('incomingList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transfers.length === 0) {
        container.appendChild(
            UIComponents.emptyState('No incoming transfer requests')
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    transfers.forEach(transfer => {
        fragment.appendChild(
            UIComponents.transferItem(transfer, 'incoming')
        );
    });
    
    container.appendChild(fragment);
}

function renderOutgoingTransfers(transfers) {
    const container = document.getElementById('outgoingList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transfers.length === 0) {
        container.appendChild(
            UIComponents.emptyState('No outgoing transfer requests')
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    transfers.forEach(transfer => {
        fragment.appendChild(
            UIComponents.transferItem(transfer, 'outgoing')
        );
    });
    
    container.appendChild(fragment);
}

function renderNotes(container, notes) {
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!notes || notes.length === 0) {
        container.appendChild(
            UIComponents.createElement('div', {
                style: 'color: var(--text-light);',
                text: 'No handover notes yet'
            })
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    notes.forEach(note => {
        fragment.appendChild(UIComponents.noteItem(note));
    });
    
    container.appendChild(fragment);
}

function renderAvailability() {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const container = document.getElementById('availabilityGrid');
    if (!container) return;
    
    container.innerHTML = '';
    
    const fragment = document.createDocumentFragment();
    days.forEach((day, index) => {
        fragment.appendChild(
            UIComponents.availabilityDay(day, index, weeklyAvailability)
        );
    });
    
    container.appendChild(fragment);
}

// 3. Keep complex calendar renders as template functions for now
// (These are complex enough that DOM manipulation might be overkill)

const CalendarTemplates = {
    renderSchedule(container, filterValue, allShifts) {
        if (!container) return;
        
        let filteredShifts = filterValue ? 
            allShifts.filter(s => s.participant_id === filterValue) : 
            allShifts;
        
        // Group by date
        const grouped = {};
        filteredShifts.forEach(shift => {
            if (!grouped[shift.date]) grouped[shift.date] = [];
            grouped[shift.date].push(shift);
        });
        
        container.innerHTML = '';
        
        if (Object.keys(grouped).length === 0) {
            container.appendChild(UIComponents.emptyState('No shifts found'));
            return;
        }
        
        const fragment = document.createDocumentFragment();
        
        Object.keys(grouped).sort().forEach(date => {
            const dayShifts = grouped[date];
            const isToday = date === getTestDate().toISOString().split('T')[0];
            
            const daySection = UIComponents.createElement('div', {
                class: 'day-section',
                children: [
                    UIComponents.createElement('div', {
                        class: 'day-header',
                        style: isToday ? 'background: var(--primary-color); color: white;' : '',
                        children: [
                            UIComponents.createElement('div', {
                                class: 'day-date',
                                text: formatDateLong(date)
                            }),
                            UIComponents.createElement('div', {
                                class: 'day-shift-count',
                                text: dayShifts.length.toString()
                            })
                        ]
                    }),
                    UIComponents.createElement('div', {
                        class: 'day-shifts',
                        children: dayShifts.map(shift => {
                            const isMyShift = shift.staff_id === currentStaff.id;
                            const staffName = shift.staff ? 
                                `${shift.staff.first_name} ${shift.staff.last_name}` : 
                                'Unassigned';
                            
                            return UIComponents.createElement('div', {
                                class: 'schedule-shift',
                                style: isMyShift ? 
                                    'background: #e3f2fd; border-left: 3px solid var(--primary-color);' : '',
                                children: [
                                    UIComponents.createElement('div', {
                                        children: [
                                            UIComponents.createElement('div', {
                                                class: 'schedule-shift-time',
                                                html: `
                                                    ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                                    ${shift.end_time ? formatTime(shift.end_time) : ''}
                                                `
                                            }),
                                            UIComponents.createElement('div', {
                                                class: 'schedule-shift-staff',
                                                text: staffName
                                            })
                                        ]
                                    }),
                                    isMyShift && UIComponents.createElement('div', {
                                        class: 'schedule-shift-actions',
                                        children: [
                                            UIComponents.createElement('button', {
                                                class: 'action-btn secondary',
                                                text: 'Note',
                                                events: {
                                                    click: () => addNoteToShift(shift.id)
                                                }
                                            })
                                        ]
                                    })
                                ].filter(Boolean)
                            });
                        })
                    })
                ]
            });
            
            fragment.appendChild(daySection);
        });
        
        container.appendChild(fragment);
    }
};


function renderFortnightSchedule(startDate, endDate, shifts) {
    const container = document.getElementById('scheduleCalendar');
    if (!container) return;

    // Create navigation similar to timesheet
    let html = `
        <div class="schedule-wrapper">
            <div class="schedule-header">
                <button onclick="changeSchedulePeriod(-1)" class="btn-nav">‹ Previous</button>
                <h3 class="schedule-period">
                    ${startDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })} - 
                    ${endDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}
                </h3>
                <button onclick="changeSchedulePeriod(1)" class="btn-nav">Next ›</button>
            </div>
            <div class="fortnight-grid">
    `;

    // Generate 14 days
    for (let i = 0; i < 14; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        const dateStr = currentDate.toISOString().split('T')[0];
        const dayShifts = shifts.filter(s => s.date === dateStr);
        const isToday = getTestDate().toDateString() === currentDate.toDateString();
        const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
        
        html += `
            <div class="schedule-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''} ${dayShifts.length > 0 ? 'has-shifts' : ''}">
                <div class="day-header">
                    <div class="day-name">${currentDate.toLocaleDateString('en-AU', { weekday: 'short' })}</div>
                    <div class="day-date">${currentDate.getDate()}</div>
                </div>
                <div class="day-shifts">
        `;
        
        if (dayShifts.length > 0) {
            dayShifts.forEach(shift => {
                html += `
                    <div class="shift-block">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'}
                            ${shift.end_time ? ' - ' + formatTime(shift.end_time) : ''}
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<div class="no-shift">No shifts</div>';
        }
        
        html += `
                </div>
            </div>
        `;
    }
    
    html += `
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function renderCalendar(targetDate, shifts) {
    const container = document.getElementById('scheduleCalendar');
    if (!container) return;

    const year = targetDate.getFullYear();
    const month = targetDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    let html = `
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)" class="calendar-nav-btn">‹</button>
                <h3 class="calendar-month">${monthNames[month]} ${year}</h3>
                <button onclick="changeMonth(1)" class="calendar-nav-btn">›</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-weekdays">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
                    <div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-days">
    `;
    
    // Empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day empty"></div>';
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayShifts = shifts.filter(s => s.date === dateStr);
        const isToday = getTestDate().toDateString() === new Date(year, month, day).toDateString();
        
        html += `
            <div class="calendar-day ${isToday ? 'today' : ''} ${dayShifts.length > 0 ? 'has-shifts' : ''}">
                <div class="day-number">${day}</div>
                ${dayShifts.length > 0 ? `
                    <div class="shift-dots">
                        ${dayShifts.map(() => '<span class="shift-dot"></span>').join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Update the original renderSchedule function
function renderSchedule() {
    const container = document.getElementById('scheduleGrid');
    const filterValue = document.getElementById('participantFilter')?.value;
    
    CalendarTemplates.renderSchedule(container, filterValue, allShifts);
}

        
        // Add all the edit profile functions
        function editPersonalInfo() {
            const container = document.getElementById('personalInfo');
            container.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">First Name</div>
                    <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Middle Name</div>
                    <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Last Name</div>
                    <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <input type="date" class="form-control" id="editDOB" value="${currentStaff.date_of_birth || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <input type="text" class="form-control" id="editNDIS" value="${currentStaff.ndis_worker_number || ''}">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="savePersonalInfo()">Save</button>
                    <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
                </div>
            `;
        }

        async function savePersonalInfo() {
            try {
                const updates = {
                    first_name: document.getElementById('editFirstName').value,
                    middle_name: document.getElementById('editMiddleName').value || null,
                    last_name: document.getElementById('editLastName').value,
                    date_of_birth: document.getElementById('editDOB').value || null,
                    ndis_worker_number: document.getElementById('editNDIS').value || null
                };

                const { error } = await supabaseClient
                    .from('staff')
                    .update(updates)
                    .eq('id', currentStaff.id);

                if (error) throw error;

                currentStaff = { ...currentStaff, ...updates };
                showToast('Personal information updated', 'success');
                loadProfile();
                document.getElementById('userName').textContent = `${currentStaff.first_name} ${currentStaff.last_name}`;

            } catch (error) {
                console.error('Error updating personal info:', error);
                showToast('Failed to update personal information', 'error');
            }
        }


function showSection(sectionName) {
    try {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show target section
        const targetSection = document.getElementById(sectionName);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Update navigation
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
        });
        
        // Find and activate corresponding nav item
        const navItem = document.querySelector(`[onclick*="${sectionName}"]`);
        if (navItem) {
            navItem.classList.add('active');
        }
        
    } catch (error) {
        console.error('Error showing section:', error);
    }
}

// ============================================
// TIMESHEET FIXES - Complete Implementation
// ============================================

// Global variables needed for timesheet
AppState.shifts.my = [];
window.currentPeriodStart = null;
window.currentPeriodEnd = null;
AppState.ui.timesheetView = 'date'; // 'date' or 'participant'
window.currentPeriodOffset = 0;



// ============================================
// FIX 1: Proper Pay Period Initialization
// ============================================

function setCurrentPayPeriod() {
    try {
        const today = new Date();
        
        // Calculate which pay period we're in
        const daysSinceStart = Math.floor((today - PAY_PERIOD_START) / (1000 * 60 * 60 * 24));
        const periodNumber = Math.floor(daysSinceStart / PERIOD_LENGTH);
        
        // Apply any offset (for navigating periods)
        const adjustedPeriodNumber = periodNumber + (window.currentPeriodOffset || 0);
        
        // Calculate current period start (Sunday)
        window.currentPeriodStart = new Date(PAY_PERIOD_START);
        window.currentPeriodStart.setDate(PAY_PERIOD_START.getDate() + (adjustedPeriodNumber * PERIOD_LENGTH));
        
        // Calculate period end (Saturday, 13 days later)
        window.currentPeriodEnd = new Date(window.currentPeriodStart);
        window.currentPeriodEnd.setDate(window.currentPeriodStart.getDate() + 13);
        
        console.log('Pay period set:', {
            start: window.currentPeriodStart.toISOString(),
            end: window.currentPeriodEnd.toISOString()
        });
        
        // Update the display
        updatePeriodDisplay();
        
    } catch (error) {
        console.error('Error setting pay period:', error);
        // Emergency fallback
        window.currentPeriodStart = new Date();
        window.currentPeriodEnd = new Date();
        window.currentPeriodEnd.setDate(window.currentPeriodEnd.getDate() + 13);
    }
}

// ============================================
// FIX 2: Update Period Display
// ============================================

function updatePeriodDisplay() {
    const periodDatesElement = document.getElementById('periodDates');
    if (periodDatesElement && window.currentPeriodStart && window.currentPeriodEnd) {
        const options = { day: 'numeric', month: 'short', year: 'numeric' };
        const startStr = window.currentPeriodStart.toLocaleDateString('en-AU', options);
        const endStr = window.currentPeriodEnd.toLocaleDateString('en-AU', options);
        periodDatesElement.textContent = `${startStr} - ${endStr}`;
    }
}

async function loadTimesheet() {
    try {
        console.log('Loading timesheet...');
        
        // Ensure we have current staff data
        if (!AppState.staff.current) {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user) {
                const { data: staffData } = await supabaseClient
                    .from('staff')
                    .select('*')
                    .eq('email', user.email)
                    .single();
                
                AppState.staff.current = staffData;
            }
        }
        
        if (!AppState.staff.current) {
            console.error('No staff data available');
            showToast('Unable to load staff data', 'error');
            return;
        }
        
        // Initialize period if not set
        if (!window.currentPeriodStart || !window.currentPeriodEnd || 
            isNaN(window.currentPeriodStart.getTime()) || isNaN(window.currentPeriodEnd.getTime())) {
            
            console.log('Initializing pay period...');
            setCurrentPayPeriod();
        }
        
        const startDate = window.currentPeriodStart.toISOString().split('T')[0];
        const endDate = window.currentPeriodEnd.toISOString().split('T')[0];
        
        console.log('Loading shifts for period:', startDate, 'to', endDate);
        
        // Load shifts for the period with participant data
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants:participant_id(first_name, last_name),
                duty_types:duty_type_id(name),
                locations:location_id(name)
            `)
            .eq('staff_id', AppState.staff.current.id)
            .gte('date', startDate)
            .lte('date', endDate)
            .is('deleted_at', null)
            .order('date', { ascending: true })
            .order('start_time', { ascending: true });

        if (error) {
            console.error('Database error:', error);
            throw error;
        }

        console.log(`Loaded ${shifts ? shifts.length : 0} shifts`);
        
        // Store shifts globally - BOTH places for compatibility
        AppState.shifts.my = shifts || [];
        window.myShifts = shifts || [];  // For modal dropdowns that still check myShifts
        
        // Calculate hours breakdown
        calculateHoursBreakdown();
        
        // Render shift list
        renderTimesheetShifts();
        
    } catch (error) {
        console.error('Error loading timesheet:', error);
        showToast('Failed to load timesheet', 'error');
    }
}
async function loadTransferModalData() {
    try {
        // Ensure myShifts is loaded with current staff's shifts
        if (!myShifts || myShifts.length === 0) {
            const { data: shifts } = await supabaseClient
                .from('shifts')
                .select('*, participants(first_name, last_name)')
                .eq('staff_id', AppState.staff.current.id)  // Use AppState
                .gte('date', getTestDate().toISOString().split('T')[0])
                .order('date', { ascending: true });
            
            myShifts = shifts || [];
        }

        // Load upcoming shifts for transfer
        const transferSelect = document.getElementById('transferShift');
        if (transferSelect) {
            if (myShifts.length === 0) {
                transferSelect.innerHTML = '<option value="">No shifts available to transfer</option>';
            } else {
                const upcomingShifts = myShifts.filter(s => new Date(s.date) >= getTestDate());
                
                if (upcomingShifts.length === 0) {
                    transferSelect.innerHTML = '<option value="">No upcoming shifts to transfer</option>';
                } else {
                    transferSelect.innerHTML = '<option value="">Select Shift</option>' +
                        upcomingShifts.map(s => {
                            // Use participants from the joined query if available
                            const participant = s.participants || participants.find(p => p.id === s.participant_id);
                            const clientName = participant ? 
                                `${participant.first_name} ${participant.last_name}` : 
                                'Unassigned';
                            return `<option value="${s.id}">${formatDate(s.date)} - ${clientName}</option>`;
                        }).join('');
                }
            }
        }
        
        // Load other staff members
        const staffSelect = document.getElementById('transferToStaff');
        if (staffSelect && staff.length > 0) {
            const otherStaff = staff.filter(s => s.id !== AppState.staff.current.id);  // Use AppState
            staffSelect.innerHTML = '<option value="">Select Staff (Optional)</option>' +
                otherStaff.map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('');
        }
    } catch (error) {
        console.error('Error loading transfer modal data:', error);
        showToast('Failed to load transfer options', 'error');
    }
}

async function loadAdjustmentModalData() {
    try {
        // Ensure myShifts is loaded with current staff's shifts
        if (!myShifts || myShifts.length === 0) {
            const { data: shifts } = await supabaseClient
                .from('shifts')
                .select('*, participants(first_name, last_name)')
                .eq('staff_id', AppState.staff.current.id)  // Use AppState
                .gte('date', getTestDate().toISOString().split('T')[0])
                .order('date', { ascending: true });
            
            myShifts = shifts || [];
        }

        // Load upcoming shifts for adjustment
        const adjustmentSelect = document.getElementById('adjustmentShift');
        if (adjustmentSelect) {
            if (myShifts.length === 0) {
                adjustmentSelect.innerHTML = '<option value="">No shifts available to adjust</option>';
            } else {
                const upcomingShifts = myShifts.filter(s => new Date(s.date) >= getTestDate());
                
                if (upcomingShifts.length === 0) {
                    adjustmentSelect.innerHTML = '<option value="">No upcoming shifts to adjust</option>';
                } else {
                    adjustmentSelect.innerHTML = '<option value="">Select Shift</option>' +
                        upcomingShifts.map(s => {
                            // Use participants from the joined query if available
                            const participant = s.participants || participants.find(p => p.id === s.participant_id);
                            const clientName = participant ? 
                                `${participant.first_name} ${participant.last_name}` : 
                                'Unassigned';
                            // Include time data for pre-filling the form
                            return `<option value="${s.id}" data-start="${s.start_time || ''}" data-end="${s.end_time || ''}">${formatDate(s.date)} - ${clientName}</option>`;
                        }).join('');
                }
            }
        }
        
        // Add event listener to pre-fill times when shift is selected
        if (adjustmentSelect && !adjustmentSelect.hasAttribute('data-listener')) {
            adjustmentSelect.setAttribute('data-listener', 'true');
            adjustmentSelect.addEventListener('change', function() {
                const selected = this.options[this.selectedIndex];
                if (selected && selected.dataset.start) {
                    const startTimeInput = document.getElementById('adjustmentStartTime');
                    const endTimeInput = document.getElementById('adjustmentEndTime');
                    if (startTimeInput) startTimeInput.value = selected.dataset.start;
                    if (endTimeInput) endTimeInput.value = selected.dataset.end;
                }
            });
        }
    } catch (error) {
        console.error('Error loading adjustment modal data:', error);
        showToast('Failed to load adjustment options', 'error');
    }
}
// ============================================
// FIX 4: Calculate Hours Breakdown
// ============================================

function calculateHoursBreakdown() {
    const breakdown = {
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0,
        total: 0
    };
    
    AppState.shifts.my.forEach(shift => {
        const hours = calculateShiftHours(shift);
        Object.keys(hours).forEach(key => {
            if (breakdown[key] !== undefined) {
                breakdown[key] += hours[key] || 0;
            }
        });
    });
    
    // Update the hours grid display
    const hoursGrid = document.getElementById('hoursGrid');
    if (hoursGrid) {
        hoursGrid.innerHTML = `
            <div class="hour-item">
                <div class="hour-label">Weekday Day</div>
                <div class="hour-value">${breakdown.weekdayDay.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Weekday Evening</div>
                <div class="hour-value">${breakdown.weekdayEvening.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Weekday Night</div>
                <div class="hour-value">${breakdown.weekdayNight.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Saturday</div>
                <div class="hour-value">${breakdown.saturday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Sunday</div>
                <div class="hour-value">${breakdown.sunday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Public Holiday</div>
                <div class="hour-value">${breakdown.publicHoliday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Sleepovers</div>
                <div class="hour-value">${Math.floor(breakdown.sleepover)}x</div>
            </div>
        `;
    }
    
    // Update total hours
    const totalHours = document.getElementById('totalHours');
    if (totalHours) {
        totalHours.textContent = `${breakdown.total.toFixed(1)}h`;
    }
    
    return breakdown;
}

function changePeriod(direction) {
    try {
        // Update the period offset
        window.currentPeriodOffset = (window.currentPeriodOffset || 0) + direction;
        
        // Recalculate the period dates
        const today = getTestDate();
        const daysSinceStart = Math.floor((today - PAY_PERIOD_START) / (1000 * 60 * 60 * 24));
        const currentPeriodNumber = Math.floor(daysSinceStart / PERIOD_LENGTH);
        const adjustedPeriodNumber = currentPeriodNumber + window.currentPeriodOffset;
        
        // Calculate period start (Sunday)
        window.currentPeriodStart = new Date(PAY_PERIOD_START);
        window.currentPeriodStart.setDate(PAY_PERIOD_START.getDate() + (adjustedPeriodNumber * PERIOD_LENGTH));
        
        // Calculate period end (Saturday, 13 days later)
        window.currentPeriodEnd = new Date(window.currentPeriodStart);
        window.currentPeriodEnd.setDate(window.currentPeriodStart.getDate() + 13);
        
        // Update the display
        const periodDatesElement = document.getElementById('periodDates');
        if (periodDatesElement) {
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            const startStr = window.currentPeriodStart.toLocaleDateString('en-AU', options);
            const endStr = window.currentPeriodEnd.toLocaleDateString('en-AU', options);
            periodDatesElement.textContent = `${startStr} - ${endStr}`;
        }
        
        // Reload timesheet data for the new period
        if (typeof loadTimesheet === 'function') {
            loadTimesheet();
        }
        
    } catch (error) {
        console.error('Error changing period:', error);
        showToast('Failed to change period', 'error');
    }
}


// ============================================
// FIX 8: Toggle Timesheet View
// ============================================

function toggleTimesheetView(view) {
    AppState.ui.timesheetView = view;
    
    // Update button states
    document.querySelectorAll('.view-toggle .toggle-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Re-render with new view
    renderTimesheetShifts();
}



// ============================================
// FIX 10: Initialize on Section Switch
// ============================================

// Override or enhance the switchSection function
const originalSwitchSection = window.switchSection;
window.switchSection = function(section) {
    // Call original if it exists
    if (typeof originalSwitchSection === 'function') {
        originalSwitchSection(section);
    }
    
    // Update nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('onclick')?.includes(section)) {
            item.classList.add('active');
        }
    });
    
    // Update content sections
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const targetSection = document.getElementById(section);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Load section data
    if (section === 'timesheet') {
        loadTimesheet();
    }
}

// ============================================
// FIX FOR changePeriod FUNCTION
// ============================================

// Make sure the function is defined globally
window.changePeriod = function(direction) {
    try {
        // Validate direction parameter
        if (typeof direction !== 'number') {
            console.error('Invalid direction parameter:', direction);
            return;
        }
        
        // Initialize period if not set
        if (!window.currentPeriodStart || !window.currentPeriodEnd || 
            isNaN(window.currentPeriodStart.getTime()) || isNaN(window.currentPeriodEnd.getTime())) {
            
            console.log('Initializing pay period first...');
            setCurrentPayPeriod();
            
            // Check if it was set successfully
            if (!window.currentPeriodStart || !window.currentPeriodEnd) {
                console.error('Failed to initialize pay period');
                showToast('Failed to initialize pay period', 'error');
                return;
            }
        }
        
        // Update the offset
        window.currentPeriodOffset = (window.currentPeriodOffset || 0) + direction;
        
        // Recalculate the period with new offset
        setCurrentPayPeriod();
        
        // Reload the timesheet with new period
        loadTimesheet();
        
    } catch (error) {
        console.error('Error in changePeriod:', error);
        showToast('Failed to change period', 'error');
    }
}

// Also ensure setCurrentPayPeriod exists and works correctly
window.setCurrentPayPeriod = function() {
    try {
        const PERIOD_LENGTH = 14; // 14-day pay periods
        const PAY_PERIOD_START = new Date('2024-01-07'); // A known Sunday
        const today = new Date();
        
        // Calculate which pay period we're in
        const daysSinceStart = Math.floor((today - PAY_PERIOD_START) / (1000 * 60 * 60 * 24));
        const periodNumber = Math.floor(daysSinceStart / PERIOD_LENGTH);
        
        // Apply any offset (for navigating periods)
        const adjustedPeriodNumber = periodNumber + (window.currentPeriodOffset || 0);
        
        // Calculate current period start (Sunday)
        window.currentPeriodStart = new Date(PAY_PERIOD_START);
        window.currentPeriodStart.setDate(PAY_PERIOD_START.getDate() + (adjustedPeriodNumber * PERIOD_LENGTH));
        
        // Calculate period end (Saturday, 13 days later)
        window.currentPeriodEnd = new Date(window.currentPeriodStart);
        window.currentPeriodEnd.setDate(window.currentPeriodStart.getDate() + 13);
        
        console.log('Pay period set:', {
            start: window.currentPeriodStart.toISOString(),
            end: window.currentPeriodEnd.toISOString(),
            offset: window.currentPeriodOffset || 0
        });
        
        // Update the display
        updatePeriodDisplay();
        
    } catch (error) {
        console.error('Error setting pay period:', error);
        // Emergency fallback
        window.currentPeriodStart = new Date();
        window.currentPeriodEnd = new Date();
        window.currentPeriodEnd.setDate(window.currentPeriodEnd.getDate() + 13);
    }
}

// Ensure updatePeriodDisplay exists
window.updatePeriodDisplay = function() {
    const periodDatesElement = document.getElementById('periodDates');
    if (periodDatesElement && window.currentPeriodStart && window.currentPeriodEnd) {
        const options = { day: 'numeric', month: 'short', year: 'numeric' };
        const startStr = window.currentPeriodStart.toLocaleDateString('en-AU', options);
        const endStr = window.currentPeriodEnd.toLocaleDateString('en-AU', options);
        periodDatesElement.textContent = `${startStr} - ${endStr}`;
    }
}



// Also fix toggleTimesheetView if it has similar issues
window.toggleTimesheetView = function(view) {
    try {
        AppState.ui.timesheetView = view;
        
        // Update button states
        document.querySelectorAll('.view-toggle .toggle-btn').forEach(btn => {
            btn.classList.remove('active');
            // Check if this is the clicked button
            if (btn.textContent.includes(view === 'date' ? 'Date' : 'Client')) {
                btn.classList.add('active');
            }
        });
        
        // Re-render with new view
        if (typeof renderTimesheetShifts === 'function') {
            renderTimesheetShifts();
        }
        
    } catch (error) {
        console.error('Error toggling timesheet view:', error);
    }
}


async function ensureStaffLoaded() {
    console.log('Ensuring staff data is loaded...');
    
    if (AppState.staff.current) {
        console.log('Staff already loaded:', AppState.staff.current);
        return AppState.staff.current;
    }
    
    try {
        // Get current user first
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (userError || !user) {
            console.error('No authenticated user found:', userError);
            window.location.href = 'index.html';
            return null;
        }
        
        console.log('Current user:', user.email);
        window.currentUser = user;
        
        // Try to load staff by user_id first
        let { data: staffData, error: staffError } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('user_id', user.id)
            .maybeSingle();
        
        // If not found by user_id, try by email
        if (!staffData) {
            console.log('No staff found by user_id, trying email...');
            const result = await supabaseClient
                .from('staff')
                .select('*')
                .eq('email', user.email)
                .maybeSingle();
            
            staffData = result.data;
            staffError = result.error;
        }
        
        if (staffError) {
            console.error('Error loading staff data:', staffError);
            showToast('Failed to load staff data', 'error');
            return null;
        }
        
        if (!staffData) {
            console.error('No staff record found for user');
            showToast('No staff record found. Please contact administrator.', 'error');
            return null;
        }
        
        // Set the global currentStaff
        AppState.staff.current = staffData;
        console.log('Staff data loaded successfully:', staffData);
        
        // Update UI with staff name
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = `${staffData.first_name} ${staffData.last_name}`;
        }
        
        return staffData;
        
    } catch (error) {
        console.error('Failed to ensure staff loaded:', error);
        showToast('Failed to load staff data', 'error');
        return null;
    }
}



function showToast(message, type = 'info') {
    // Remove any existing toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    
    // Style the toast
    toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
        color: white;
        border-radius: 8px;
        z-index: 9999;
        animation: slideUp 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

if (!document.querySelector('#toastStyles')) {
    const style = document.createElement('style');
    style.id = 'toastStyles';
    style.textContent = `
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, 100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

function switchSection(section) {
    try {
        // Update mobile nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            item.setAttribute('aria-selected', 'false');
        });
        
        // Set active nav item
        const activeNavItem = document.getElementById(`nav-${section}`);
        if (activeNavItem) {
            activeNavItem.classList.add('active');
            activeNavItem.setAttribute('aria-selected', 'true');
        }
        
        // Update desktop nav if it exists
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        const activeTab = document.querySelector(`.nav-tab[data-view="${section}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        // Hide all content sections
        document.querySelectorAll('.content-section').forEach(sec => {
            sec.classList.remove('active');
            sec.style.display = 'none';
        });
        
        // Show selected section
        const targetSection = document.getElementById(section);
        if (targetSection) {
            targetSection.classList.add('active');
            targetSection.style.display = 'block';
        }
        
        // Update AppState
        AppState.ui.currentSection = section;
        
        // Load section data based on what's selected
        switch(section) {
            case 'dashboard':
                if (typeof loadDashboard === 'function') {
                    loadDashboard();
                }
                break;
            case 'timesheet':
                if (typeof loadTimesheet === 'function') {
                    loadTimesheet();
                }
                break;
            case 'schedule':
                if (typeof loadSchedule === 'function') {
                    loadSchedule();
                }
                break;
            case 'transfers':
                if (typeof loadTransfers === 'function') {
                    loadTransfers();
                }
                break;
            case 'profile':
                if (typeof loadProfile === 'function') {
                    loadProfile();
                }
                break;
            default:
                console.warn('Unknown section:', section);
        }
        
        // Scroll to top on mobile
        window.scrollTo(0, 0);
        
    } catch (error) {
        console.error('Error switching section:', error);
        showToast('Failed to switch section', 'error');
    }
}

        function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
}
        function addButtonStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .btn {
                    padding: 12px 20px;
                    border: none;
                    border-radius: var(--radius-md);
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-size: 14px;
                }
                .btn-primary {
                    background: var(--primary-color);
                    color: white;
                }
                .btn-primary:hover {
                    background: var(--primary-dark);
                }
                .btn-secondary {
                    background: var(--bg-light);
                    color: var(--text-dark);
                }
                .btn-secondary:hover {
                    background: #d0d0d0;
                }
                .btn-sm {
                    padding: 8px 16px;
                    font-size: 12px;
                }
                .btn-outline {
                    background: transparent;
                    border: 1px solid var(--border-color);
                    color: var(--text-dark);
                }
                .btn-outline:hover {
                    background: var(--bg-light);
                }
            `;
            document.head.appendChild(style);
        }

window.testSelectedStaff = async function() {
    const select = document.getElementById('staffTestSelect');
    const staffId = select.value;
    
    console.log('Test selected staff called with ID:', staffId);
    
    if (!staffId) {
        showToast('Please select a staff member', 'warning');
        return;
    }
    
    // First ensure we have the original staff loaded
    if (!AppState.staff.current) {
        console.log('Current staff not loaded, loading first...');
        await ensureStaffLoaded();
        
        if (!AppState.staff.current) {
            showToast('Failed to load your staff data first', 'error');
            return;
        }
    }
    
    // Now switch to test staff
    await switchToStaff(staffId);
    
    // Hide the selector after successful switch
    const selector = document.getElementById('staffSelector');
    if (selector) {
        selector.style.display = 'none';
    }
}

// ==========================================
// ENHANCED: Initialize App with Staff Check
// ==========================================

// Override or enhance the initializeApp function
const originalInitializeApp = window.initializeApp;

window.initializeApp = async function() {
    try {
        console.log('Enhanced initialization starting...');
        
        // Ensure staff is loaded first
        await ensureStaffLoaded();
        
        if (!AppState.staff.current) {
            console.error('Failed to load staff during initialization');
            showToast('Failed to load staff data. Please refresh the page.', 'error');
            return;
        }
        
        // Call original initialization if it exists
        if (typeof originalInitializeApp === 'function') {
            await originalInitializeApp();
        }
        
        // Load reference data if not already loaded
        if (typeof loadReferenceData === 'function') {
            await loadReferenceData();
        }
        
        console.log('Enhanced initialization complete');
        
    } catch (error) {
        console.error('Enhanced initialization error:', error);
        showToast('Initialization failed: ' + error.message, 'error');
    }
}

// ==========================================
// FIX: Add Staff Selector with Proper Check
// ==========================================

window.addStaffSelector = async function() {
    try {
        console.log('Adding staff selector...');
        
        // First ensure current staff is loaded
        if (!AppState.staff.current) {
            await ensureStaffLoaded();
            if (!AppState.staff.current) {
                console.error('Cannot add staff selector - no current staff');
                return;
            }
        }
        
        // Load all staff members
        const { data: allStaff, error } = await supabaseClient
            .from('staff')
            .select('id, first_name, last_name, email')
            .eq('is_active', true)
            .order('first_name');
        
        if (error) throw error;
        
        // Remove existing selector if present
        const existingSelector = document.getElementById('staffSelector');
        if (existingSelector) {
            existingSelector.remove();
        }
        
        // Create the selector UI
        const selectorHTML = `
            <div id="staffSelector" style="
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 9999;
                max-width: 300px;
                display: none;
            ">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333;">
                    🧪 Test as Different Staff:
                </div>
                <div style="margin-bottom: 5px; font-size: 12px; color: #666;">
                    Currently: ${AppState.staff.current.first_name} ${AppState.staff.current.last_name}
                </div>
                <select id="staffTestSelect" style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    margin-bottom: 10px;
                ">
                    <option value="">-- Select Staff Member --</option>
                    ${allStaff.map(s => `
                        <option value="${s.id}" ${s.id === AppState.staff.current.id ? 'disabled' : ''}>
                            ${s.first_name} ${s.last_name} 
                            ${s.id === AppState.staff.current.id ? '(You)' : ''}
                        </option>
                    `).join('')}
                </select>
                <button onclick="testSelectedStaff()" style="
                    width: 100%;
                    padding: 8px;
                    background: #004990;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                ">Switch View</button>
                <button onclick="document.getElementById('staffSelector').style.display='none'" style="
                    width: 100%;
                    padding: 8px;
                    background: #f0f0f0;
                    color: #666;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    margin-top: 5px;
                    font-size: 12px;
                ">Hide</button>
            </div>
        `;
        
        // Add to page
        document.body.insertAdjacentHTML('beforeend', selectorHTML);
        console.log('Staff selector added successfully');
        
    } catch (error) {
        console.error('Error loading staff list:', error);
        showToast('Failed to load staff list', 'error');
    }
}

// 7. Quick console command to test
window.testAsStaff = function(firstName) {
    const staffMember = staff.find(s => 
        s.first_name.toLowerCase().includes(firstName.toLowerCase())
    );
    if (staffMember) {
        switchToStaff(staffMember.id);
    } else {
        console.log('Staff not found. Available:', staff.map(s => s.first_name).join(', '));
    }
};


//Replace all getTestDate() with getTestDate()//
        </script>
        </body>
        </html>

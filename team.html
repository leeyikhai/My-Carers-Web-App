<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Portal - MC Care</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>

        
        :root {
            --primary-color: #004990;
            --primary-dark: #003670;
            --primary-light: #0056b3;
            --success-color: #88a542;
            --info-color: #359dca;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f8f9fa;
            --bg-dark: #1a2332;
            --border-color: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 70px; /* Space for mobile nav */
        }

        /* Header with Profile Banner */
        .header {
            background: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .profile-banner {
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .profile-banner-upload {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: var(--radius-md);
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .profile-info {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .user-details h2 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .user-role {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: var(--text-light);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item .badge {
            position: absolute;
            top: 4px;
            right: calc(50% - 20px);
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 16px;
        }

        /* Content Sections */
        .content-section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .dashboard-header {
            margin-bottom: 20px;
        }

        .greeting {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .date-display {
            color: var(--text-light);
            font-size: 14px;
        }

        .shift-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .shift-card:active {
            transform: scale(0.98);
        }

        .shift-card-header {
            padding: 20px;
            position: relative;
        }

        .shift-time {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .shift-participant {
            font-size: 16px;
            opacity: 0.95;
            margin-bottom: 4px;
        }

        .shift-location {
            font-size: 14px;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shift-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .shift-expand-icon {
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .shift-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(255,255,255,0.95);
            color: var(--text-dark);
        }

        .shift-card.expanded .shift-details {
            max-height: 500px;
        }

        .shift-card.expanded .shift-expand-icon {
            transform: rotate(180deg);
        }

        .handover-section {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .handover-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .handover-note {
            background: var(--bg-light);
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .handover-author {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .quick-action-btn:active {
            transform: scale(0.95);
            background: var(--bg-light);
        }

        .quick-action-btn .icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        /* Requests Summary */
        .requests-summary {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .requests-summary h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-dark);
        }

        .request-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-type {
            font-size: 14px;
            font-weight: 500;
        }

        .request-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-denied {
            background: #f8d7da;
            color: #721c24;
        }

        /* Timesheet View */
        .period-selector {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .period-display {
            text-align: center;
            flex: 1;
        }

        .period-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .period-dates {
            font-size: 16px;
            font-weight: 600;
        }

        .period-nav {
            padding: 8px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
        }

        /* Timesheet Summary */
        .timesheet-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .timesheet-summary h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        .hours-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .hour-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: var(--radius-md);
        }

        .hour-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .hour-value {
            font-size: 20px;
            font-weight: 600;
        }

        .total-section {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 16px;
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 600;
        }

        /* Shift List */
        .shift-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .shift-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .shift-list-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-list-item:last-child {
            border-bottom: none;
        }

        .shift-info {
            flex: 1;
        }

        .shift-date-time {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .shift-client {
            font-size: 14px;
            color: var(--text-light);
        }

        .shift-hours {
            text-align: right;
        }

        .shift-hours-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .shift-pay {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Schedule View */
        .calendar-header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .participant-filter {
            margin-bottom: 12px;
        }

        .participant-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: white;
        }

        .date-range-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-light);
            margin-top: 12px;
        }

        .schedule-grid {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .day-section {
            border-bottom: 1px solid var(--border-color);
        }

        .day-section:last-child {
            border-bottom: none;
        }

        .day-header {
            background: var(--bg-light);
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-date {
            font-size: 14px;
        }

        .day-shift-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .day-shifts {
            padding: 8px;
        }

        .schedule-shift {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-shift:last-child {
            margin-bottom: 0;
        }

        .schedule-shift-time {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .schedule-shift-staff {
            font-size: 13px;
            color: var(--text-light);
        }

        .schedule-shift-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .action-btn.secondary {
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        /* Transfers View */
        .transfer-tabs {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 16px;
            display: flex;
            box-shadow: var(--shadow-sm);
        }

        .transfer-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            font-weight: 500;
            transition: all 0.3s;
        }

        .transfer-tab:last-child {
            border-right: none;
        }

        .transfer-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .transfer-list {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .transfer-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .transfer-item:last-child {
            margin-bottom: 0;
        }

        .transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .transfer-date {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .transfer-time {
            font-size: 14px;
            color: var(--text-light);
        }

        .transfer-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .transfer-from {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .transfer-reason {
            font-size: 13px;
            color: var(--text-light);
            font-style: italic;
            padding: 8px;
            background: white;
            border-radius: var(--radius-sm);
            margin-top: 8px;
        }

        .transfer-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .transfer-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .transfer-btn.accept {
            background: var(--success-color);
            color: white;
        }

        .transfer-btn.decline {
            background: white;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        /* Profile View */
        .profile-section {
            background: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .profile-section-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-btn {
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .profile-content {
            padding: 16px;
        }

        .profile-field {
            margin-bottom: 16px;
        }

        .profile-field:last-child {
            margin-bottom: 0;
        }

        .field-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .field-value {
            font-size: 16px;
            color: var(--text-dark);
        }

        .field-value input,
        .field-value select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 16px;
        }

        /* Documents Section */
        .document-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .document-upload-area:hover {
            border-color: var(--primary-color);
            background: var(--bg-light);
        }

        .document-list {
            display: grid;
            gap: 12px;
        }

        .document-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 12px;
            color: var(--text-light);
        }

        .document-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Availability Pattern */
        .availability-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 16px;
        }

        .availability-day {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .availability-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .day-name {
            font-weight: 600;
        }

        .availability-toggle {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .availability-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        .availability-toggle input:checked + .toggle-slider {
            background: var(--success-color);
        }

        .availability-toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .availability-times {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .time-slot {
            padding: 8px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Modal System */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 73, 144, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Image Upload for Notes */
        .image-upload-area {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        .add-image-btn {
            width: 60px;
            height: 60px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-light);
        }

        /* Notifications */
        .notification-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .notification-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.unread {
            background: #f0f8ff;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-icon.info {
            background: #cce5ff;
            color: #004085;
        }

        .notification-icon.success {
            background: #d4edda;
            color: #155724;
        }

        .notification-icon.warning {
            background: #fff3cd;
            color: #856404;
        }

        .notification-content {
            flex: 1;
        }

        .notification-message {
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            animation: slideUp 0.3s ease-out;
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* Desktop Responsiveness */
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }

            .mobile-nav {
                display: none;
            }

            .desktop-nav {
                display: flex;
                background: white;
                border-bottom: 1px solid var(--border-color);
                padding: 0 20px;
            }

            .desktop-nav .nav-item {
                padding: 16px 24px;
                border-bottom: 3px solid transparent;
                transition: all 0.3s;
            }

            .desktop-nav .nav-item.active {
                border-bottom-color: var(--primary-color);
            }

            .content-section {
                max-width: 1200px;
                margin: 0 auto;
                padding: 40px;
            }

            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }

            .hours-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .document-list {
                grid-template-columns: repeat(2, 1fr);
            }

            .availability-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 600; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .p-2 { padding: 16px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Header with Profile Banner -->
    <header class="header">
        <div class="profile-banner" id="profileBanner">
            <div class="profile-banner-upload" id="bannerUploadBtn">
                üì∑ Change Banner
            </div>
            <input type="file" id="bannerUpload" accept="image/*" style="display: none;">
        </div>
        <div class="profile-info">
            <div class="user-details">
                <h2 id="userName">Loading...</h2>
                <span class="user-role" id="userRole">Staff</span>
            </div>
            <button class="btn btn-sm btn-outline" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Desktop Navigation (hidden on mobile) -->
    <nav class="desktop-nav hidden">
        <div class="nav-item active" onclick="switchSection('dashboard')">
            <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="switchSection('timesheet')">
            <span>Timesheet</span>
        </div>
        <div class="nav-item" onclick="switchSection('schedule')">
            <span>Schedule</span>
        </div>
        <div class="nav-item" onclick="switchSection('transfers')">
            <span>Transfers</span>
        </div>
        <div class="nav-item" onclick="switchSection('profile')">
            <span>Profile</span>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboard" class="content-section active">
        <div class="dashboard-header">
            <div class="greeting" id="greeting">Good morning!</div>
            <div class="date-display" id="currentDate">Monday, 5 January 2025</div>
        </div>

        <!-- Current/Upcoming Shift -->
        <div id="currentShift">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action-btn" onclick="showAddShiftModal()">
                <span class="icon">‚ûï</span>
                <span>Add Shift</span>
            </div>
            <div class="quick-action-btn" onclick="showTransferModal()">
                <span class="icon">üîÑ</span>
                <span>Transfer Shift</span>
            </div>
            <div class="quick-action-btn" onclick="showAdjustmentModal()">
                <span class="icon">‚è∞</span>
                <span>Adjust Time</span>
            </div>
            <div class="quick-action-btn" onclick="showLeaveModal()">
                <span class="icon">üèñÔ∏è</span>
                <span>Request Leave</span>
            </div>
        </div>

        <!-- Pending Requests Summary -->
        <div class="requests-summary">
            <h3>Pending Requests</h3>
            <div id="pendingRequestsList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Recent Notifications -->
        <div class="requests-summary">
            <h3>Recent Updates</h3>
            <div id="recentNotifications">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Timesheet Section -->
    <div id="timesheet" class="content-section">
        <div class="period-selector">
            <button class="period-nav" onclick="changePeriod(-1)">‚óÄ</button>
            <div class="period-display">
                <div class="period-label">Pay Period</div>
                <div class="period-dates" id="periodDates">28 Jul - 10 Aug 2025</div>
            </div>
            <button class="period-nav" onclick="changePeriod(1)">‚ñ∂</button>
        </div>

        <!-- Hours Summary -->
        <div class="timesheet-summary">
            <h3>Hours Breakdown</h3>
            <div class="hours-grid" id="hoursGrid">
                <!-- Will be populated dynamically -->
            </div>
            <div class="total-section">
                <span>Total Hours</span>
                <span id="totalHours">0.0h</span>
            </div>
        </div>

        <!-- Shift List with Toggle -->
        <div class="shift-list">
            <div class="shift-list-header">
                <h3>Shifts</h3>
                <div class="view-toggle">
                    <button class="toggle-btn active" onclick="toggleTimesheetView('date')">By Date</button>
                    <button class="toggle-btn" onclick="toggleTimesheetView('participant')">By Client</button>
                </div>
            </div>
            <div id="timesheetShifts">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Schedule Section -->
    <div id="schedule" class="content-section">
        <div class="calendar-header">
            <div class="participant-filter">
                <label class="field-label">Filter by Client</label>
                <select class="participant-select" id="participantFilter" onchange="filterSchedule()">
                    <option value="">All My Clients</option>
                </select>
            </div>
            <div class="date-range-info">
                <span>üìÖ</span>
                <span>Showing 2 weeks before and after today</span>
            </div>
        </div>

        <div class="schedule-grid" id="scheduleGrid">
            <!-- Will be populated dynamically -->
        </div>
    </div>

    <!-- Transfers Section -->
    <div id="transfers" class="content-section">
        <div class="transfer-tabs">
            <div class="transfer-tab active" onclick="switchTransferTab('incoming')">
                Incoming Requests
                <span class="badge" id="incomingCount">0</span>
            </div>
            <div class="transfer-tab" onclick="switchTransferTab('outgoing')">
                My Requests
            </div>
            <div class="transfer-tab" onclick="switchTransferTab('available')">
                Available Shifts
            </div>
        </div>

        <div id="incomingTransfers" class="transfer-content active">
            <div class="transfer-list" id="incomingList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <div id="outgoingTransfers" class="transfer-content">
            <div class="transfer-list" id="outgoingList">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <div id="availableTransfers" class="transfer-content">
            <div class="transfer-list" id="availableList">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Profile Section -->
    <div id="profile" class="content-section">
        <!-- Personal Information -->
        <div class="profile-section">
            <div class="profile-section-header">
                Personal Information
                <button class="edit-btn" onclick="editPersonalInfo()">Edit</button>
            </div>
            <div class="profile-content" id="personalInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Contact Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Contact Details
                <button class="edit-btn" onclick="editContactInfo()">Edit</button>
            </div>
            <div class="profile-content" id="contactInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Banking Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Banking & Super
                <button class="edit-btn" onclick="editBankingInfo()">Edit</button>
            </div>
            <div class="profile-content" id="bankingInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Documents -->
        <div class="profile-section">
            <div class="profile-section-header">
                Documents
            </div>
            <div class="profile-content">
                <div class="document-upload-area" onclick="showDocumentUploadModal()">
                    <div>üìé Upload Document</div>
                    <div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                        Click to upload certifications, ID, checks, etc.
                    </div>
                </div>
                <div class="document-list" id="documentList">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Availability Pattern -->
        <div class="profile-section">
            <div class="profile-section-header">
                Weekly Availability
                <button class="edit-btn" onclick="saveAvailability()">Save</button>
            </div>
            <div class="profile-content">
                <div class="availability-grid" id="availabilityGrid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="nav-item active" onclick="switchSection('dashboard')">
            <div class="icon">üè†</div>
            <div>Home</div>
            <span class="badge hidden" id="homeBadge">1</span>
        </div>
        <div class="nav-item" onclick="switchSection('timesheet')">
            <div class="icon">üìä</div>
            <div>Timesheet</div>
        </div>
        <div class="nav-item" onclick="switchSection('schedule')">
            <div class="icon">üìÖ</div>
            <div>Schedule</div>
        </div>
        <div class="nav-item" onclick="switchSection('transfers')">
            <div class="icon">üîÑ</div>
            <div>Transfers</div>
            <span class="badge hidden" id="transferBadge">0</span>
        </div>
        <div class="nav-item" onclick="switchSection('profile')">
            <div class="icon">üë§</div>
            <div>Profile</div>
        </div>
    </nav>

    <!-- Add Shift Modal -->
    <div id="addShiftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Shift</h3>
                <button class="modal-close" onclick="closeModal('addShiftModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addShiftForm">
                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-control" id="shiftDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Client *</label>
                        <select class="form-control" id="shiftParticipant" required>
                            <option value="">Select Client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Shift Type *</label>
                        <select class="form-control" id="shiftDutyType" required onchange="toggleTimeFields()">
                            <option value="">Select Type</option>
                        </select>
                    </div>
                    <div id="timeFields">
                        <div class="form-group">
                            <label class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="shiftStartTime">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Time</label>
                            <input type="time" class="form-control" id="shiftEndTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="shiftNotes" placeholder="Any additional information..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('addShiftModal')">Cancel</button>
                <button class="modal-btn primary" onclick="submitShift()">Submit for Approval</button>
            </div>
        </div>
    </div>

    <!-- Transfer Shift Modal -->
    <div id="transferShiftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Transfer Shift</h3>
                <button class="modal-close" onclick="closeModal('transferShiftModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <div class="form-group">
                        <label class="form-label">Select Shift to Transfer *</label>
                        <select class="form-control" id="transferShiftSelect" required>
                            <option value="">Select a shift</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transfer To *</label>
                        <select class="form-control" id="transferToStaff" required>
                            <option value="">Select staff member</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reason *</label>
                        <textarea class="form-control" id="transferReason" required placeholder="Please provide a reason for the transfer..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('transferShiftModal')">Cancel</button>
                <button class="modal-btn primary" onclick="submitTransfer()">Send Transfer Request</button>
            </div>
        </div>
    </div>

    <!-- Time Adjustment Modal -->
    <div id="adjustmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Request Time Adjustment</h3>
                <button class="modal-close" onclick="closeModal('adjustmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="adjustmentForm">
                    <div class="form-group">
                        <label class="form-label">Select Shift *</label>
                        <select class="form-control" id="adjustmentShift" required onchange="loadShiftTimes()">
                            <option value="">Select a shift</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Start Time</label>
                        <input type="time" class="form-control" id="adjustmentStartTime">
                    </div>
                    <div class="form-group">
                        <label class="form-label">New End Time</label>
                        <input type="time" class="form-control" id="adjustmentEndTime">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reason for Adjustment *</label>
                        <textarea class="form-control" id="adjustmentReason" required placeholder="Please explain the time adjustment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('adjustmentModal')">Cancel</button>
                <button class="modal-btn primary" onclick="submitAdjustment()">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- Leave Request Modal -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Request Leave</h3>
                <button class="modal-close" onclick="closeModal('leaveModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="leaveForm">
                    <div class="form-group">
                        <label class="form-label">Leave Type *</label>
                        <select class="form-control" id="leaveType" required>
                            <option value="">Select type</option>
                            <option value="annual">Annual Leave</option>
                            <option value="sick">Sick Leave</option>
                            <option value="personal">Personal Leave</option>
                            <option value="unpaid">Unpaid Leave</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date *</label>
                        <input type="date" class="form-control" id="leaveStartDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date *</label>
                        <input type="date" class="form-control" id="leaveEndDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reason</label>
                        <textarea class="form-control" id="leaveReason" placeholder="Optional: Provide additional details..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('leaveModal')">Cancel</button>
                <button class="modal-btn primary" onclick="submitLeave()">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- Document Upload Modal -->
    <div id="documentUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload Document</h3>
                <button class="modal-close" onclick="closeModal('documentUploadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="documentUploadForm">
                    <div class="form-group">
                        <label class="form-label">Document Type *</label>
                        <select class="form-control" id="documentType" required onchange="checkExpiryRequired()">
                            <option value="">Select type</option>
                            <option value="id">Photo ID</option>
                            <option value="resume">Resume/CV</option>
                            <option value="visa">Visa/Work Permit</option>
                            <option value="firstaid">First Aid/CPR Certificate</option>
                            <option value="wwcc">Working with Children Check</option>
                            <option value="police">Police Check</option>
                            <option value="ndis">NDIS Worker Check</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Document Title *</label>
                        <input type="text" class="form-control" id="documentTitle" required placeholder="e.g., Driver's License">
                    </div>
                    <div class="form-group" id="expiryGroup">
                        <label class="form-label">Expiry Date</label>
                        <input type="date" class="form-control" id="documentExpiry">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select File *</label>
                        <input type="file" class="form-control" id="documentFile" required accept=".pdf,.jpg,.jpeg,.png">
                        <small style="color: var(--text-light);">Max 10MB. PDF, JPG, PNG accepted.</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="documentNotes" placeholder="Optional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('documentUploadModal')">Cancel</button>
                <button class="modal-btn primary" onclick="uploadDocument()">Upload</button>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="addNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Shift Note</h3>
                <button class="modal-close" onclick="closeModal('addNoteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteShiftId">
                    <div class="form-group">
                        <label class="form-label">Note Type *</label>
                        <select class="form-control" id="noteType" required>
                            <option value="shift">Shift Note (Visible to Manager)</option>
                            <option value="handover">Handover Note (Staff Only)</option>
                            <option value="incident">Incident Report</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Note *</label>
                        <textarea class="form-control" id="noteContent" required placeholder="Enter your note..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Attach Images</label>
                        <div class="image-upload-area">
                            <div class="add-image-btn" onclick="document.getElementById('noteImages').click()">+</div>
                            <div id="imagePreviewContainer"></div>
                        </div>
                        <input type="file" id="noteImages" multiple accept="image/*" style="display: none;" onchange="previewImages()">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal('addNoteModal')">Cancel</button>
                <button class="modal-btn primary" onclick="submitNote()">Add Note</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://gqchhsayqxttewthcsah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxY2hoc2F5cXh0dGV3dGhjc2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTA0ODksImV4cCI6MjA3MjI2NjQ4OX0.iAGhrDZaHkpLwjJY07o-73l2OiePB2x1ZnnTEfUBd_M';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global State
        let currentUser = null;
        let currentStaff = null;
        let allShifts = [];
        let myShifts = [];
        let participants = [];
        let staff = [];
        let dutyTypes = [];
        let locations = [];
        let notifications = [];
        let documents = [];
        let selectedImages = [];
        let currentPeriodStart = null;
        let currentPeriodEnd = null;
        let timesheetView = 'date';
        let weeklyAvailability = {};

        // Pay Period Configuration (fortnightly starting July 28, 2025)
        const PAY_PERIOD_START = new Date('2025-07-28');
        const PERIOD_LENGTH = 14; // days

        // Initialize App
        async function initializeApp() {
            try {
                // Check authentication
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error || !session) {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = session.user;
                
                // Load staff record
                const { data: staffData } = await supabaseClient
                    .from('staff')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (!staffData) {
                    showToast('Staff record not found', 'error');
                    return;
                }
                
                currentStaff = staffData;
                
                // Update UI with user info
                document.getElementById('userName').textContent = `${currentStaff.first_name} ${currentStaff.last_name}`;
                
                // Set current pay period
                setCurrentPayPeriod();
                
                // Load initial data
                await loadReferenceData();
                await loadDashboard();
                
                // Set greeting
                setGreeting();
                
                // Load profile banner if exists
                loadProfileBanner();
                
                // Setup event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize app', 'error');
            }
        }

        // Load Reference Data
        async function loadReferenceData() {
            try {
                const [
                    { data: participantsData },
                    { data: staffData },
                    { data: dutyTypesData },
                    { data: locationsData }
                ] = await Promise.all([
                    supabaseClient.from('participants').select('*').eq('is_active', true).order('first_name'),
                    supabaseClient.from('staff').select('*').eq('is_active', true).order('first_name'),
                    supabaseClient.from('duty_types').select('*').order('name'),
                    supabaseClient.from('locations').select('*').order('name')
                ]);

                participants = participantsData || [];
                staff = staffData || [];
                dutyTypes = dutyTypesData || [];
                locations = locationsData || [];

                // Populate dropdowns
                populateDropdowns();

            } catch (error) {
                console.error('Error loading reference data:', error);
            }
        }

        async function loadDashboard() {
    try {
        // Load current/upcoming shift
        await loadCurrentShift();
        
        // Load pending requests
        await loadPendingRequests();
        
        // Load notifications
        await loadNotifications();
        
        // Load upcoming leave
        const today = new Date().toISOString().split('T')[0];
        const thirtyDaysFromNow = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        const { data: myLeave } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('available', false)
            .gte('date', today)
            .lte('date', thirtyDaysFromNow)
            .order('date');

        if (myLeave && myLeave.length > 0) {
            // Group consecutive dates
            const leaveGroups = [];
            let currentGroup = null;
            
            myLeave.forEach(leave => {
                const leaveDate = new Date(leave.date);
                
                if (!currentGroup || 
                    leave.reason !== currentGroup.reason ||
                    (leaveDate - new Date(currentGroup.endDate)) > 24 * 60 * 60 * 1000) {
                    currentGroup = {
                        startDate: leave.date,
                        endDate: leave.date,
                        reason: leave.reason,
                        days: 1
                    };
                    leaveGroups.push(currentGroup);
                } else {
                    currentGroup.endDate = leave.date;
                    currentGroup.days++;
                }
            });

            // Create leave section HTML
            const leaveHTML = `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>üìÖ Upcoming Leave</h3>
                        <span class="badge">${leaveGroups.length}</span>
                    </div>
                    <div class="leave-list">
                        ${leaveGroups.map(group => {
                            const start = formatDateShort(group.startDate);
                            const end = formatDateShort(group.endDate);
                            const dateRange = group.startDate === group.endDate ? 
                                start : 
                                `${start} - ${end} (${group.days} days)`;
                            
                            const daysUntil = Math.floor((new Date(group.startDate) - new Date()) / (24 * 60 * 60 * 1000));
                            const urgency = daysUntil <= 7 ? 'urgent' : daysUntil <= 14 ? 'soon' : '';
                            
                            return `
                                <div class="leave-item ${urgency}">
                                    <div class="leave-info">
                                        <div class="leave-dates">${dateRange}</div>
                                        <div class="leave-type">${group.reason}</div>
                                    </div>
                                    ${daysUntil > 0 ? 
                                        `<div class="leave-countdown">In ${daysUntil} day${daysUntil !== 1 ? 's' : ''}</div>` : 
                                        daysUntil === 0 ? 
                                        '<div class="leave-countdown today">Today</div>' : 
                                        '<div class="leave-countdown ongoing">Ongoing</div>'
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Insert leave section into dashboard
            const dashboardContent = document.getElementById('dashboardContent');
            if (dashboardContent) {
                // Find or create leave container
                let leaveContainer = dashboardContent.querySelector('.leave-container');
                if (!leaveContainer) {
                    leaveContainer = document.createElement('div');
                    leaveContainer.className = 'leave-container';
                    
                    // Insert after pending requests or at the end
                    const pendingRequests = dashboardContent.querySelector('.dashboard-card');
                    if (pendingRequests) {
                        pendingRequests.insertAdjacentElement('afterend', leaveContainer);
                    } else {
                        dashboardContent.appendChild(leaveContainer);
                    }
                }
                leaveContainer.innerHTML = leaveHTML;
            }
        }
        
        // Update summary stats
        const { data: stats } = await supabaseClient
            .from('shifts')
            .select('id, status')
            .eq('staff_id', currentStaff.id)
            .gte('date', today);
        
        const upcomingShifts = stats?.filter(s => s.status === 'confirmed').length || 0;
        const pendingShifts = stats?.filter(s => s.status === 'pending').length || 0;
        
        // Update dashboard badges
        const homeBadge = document.getElementById('homeBadge');
        if (homeBadge) {
            const totalAlerts = pendingShifts + (myLeave?.length || 0);
            homeBadge.textContent = totalAlerts;
            homeBadge.classList.toggle('hidden', totalAlerts === 0);
        }
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Failed to load dashboard completely', 'error');
    }
}


        async function loadCurrentShift() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // Get today's and tomorrow's shifts
            const { data: upcomingShifts } = await supabaseClient
                .from('shifts')
                .select(`
                    *,
                    participant:participant_id(first_name, last_name),
                    location:location_id(name, address),
                    duty_type:duty_type_id(name)
                `)
                .eq('staff_id', currentStaff.id)
                .gte('date', today)
                .lte('date', new Date(now.getTime() + 24*60*60*1000).toISOString().split('T')[0])
                .is('deleted_at', null)
                .order('date')
                .order('start_time')
                .limit(1);

            const container = document.getElementById('currentShift');
            
            if (!upcomingShifts || upcomingShifts.length === 0) {
                container.innerHTML = `
                    <div class="shift-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="shift-card-header">
                            <div class="shift-time">No shifts today</div>
                            <div class="shift-participant">Enjoy your day off!</div>
                        </div>
                    </div>
                `;
                return;
            }

            const shift = upcomingShifts[0];
            const isToday = shift.date === today;
            const participantName = shift.participant ? 
                `${shift.participant.first_name} ${shift.participant.last_name}` :
                (shift.location?.name || 'Unassigned');
            
            container.innerHTML = `
                <div class="shift-card" onclick="toggleShiftDetails(this)">
                    <div class="shift-card-header">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                        <div class="shift-participant">${participantName}</div>
                        <div class="shift-location">
                            üìç ${shift.location?.name || shift.location?.address || 'Client Home'}
                        </div>
                        <div class="shift-status">${isToday ? 'TODAY' : 'TOMORROW'}</div>
                    </div>
                    <div class="shift-expand-icon">‚ñº Tap for details</div>
                    <div class="shift-details">
                        <div class="handover-section">
                            <div class="handover-title">Handover Notes</div>
                            <div id="handoverNotes">Loading...</div>
                            <button class="modal-btn primary mt-2" onclick="addNoteToShift(${shift.id})">Add Note</button>
                        </div>
                    </div>
                </div>
            `;

            // Load handover notes
            loadHandoverNotes(shift.id);
        }

        async function loadHandoverNotes(shiftId) {
    try {
        const container = document.getElementById('handoverNotes');
        
        // Add null check for container
        if (!container) {
            console.warn('Handover notes container not found');
            return;
        }
        
        const { data: notes } = await supabaseClient
            .from('shift_notes')
            .select(`
                *,
                staff:staff_id(first_name, last_name)
            `)
            .eq('shift_id', shiftId)
            .in('note_type', ['handover', 'shift'])
            .order('created_at', { ascending: false });
        
        // Handle empty or null notes array
        if (!notes || notes.length === 0) {
            container.innerHTML = '<div style="color: var(--text-light);">No handover notes yet</div>';
            return;
        }
        
        container.innerHTML = notes.map(note => {
            // Ensure staff exists before accessing properties
            const staffName = note.staff ? 
                `${note.staff.first_name} ${note.staff.last_name}` : 
                'Unknown Staff';
            
            return `
                <div class="handover-note">
                    <div>${note.note}</div>
                    <div class="handover-author">
                        ${staffName} ‚Ä¢ ${formatDateTime(note.created_at)}
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading handover notes:', error);
        // Don't show error toast for handover notes to avoid spam
    }
}


        async function loadPendingRequests() {
            const { data: requests } = await supabaseClient
                .from('shift_adjustment_requests')
                .select('*')
                .eq('staff_id', currentStaff.id)
                .eq('status', 'pending');

            const { data: transfers } = await supabaseClient
                .from('transfer_requests')
                .select('*')
                .or(`from_staff_id.eq.${currentStaff.id},to_staff_id.eq.${currentStaff.id}`)
                .eq('status', 'pending');

            const { data: leaves } = await supabaseClient
                .from('leave_requests')
                .select('*')
                .eq('staff_id', currentStaff.id)
                .eq('status', 'pending');

            const container = document.getElementById('pendingRequestsList');
            const totalPending = (requests?.length || 0) + (transfers?.length || 0) + (leaves?.length || 0);

            if (totalPending === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-light);">No pending requests</div>';
                return;
            }

            let html = '';
            
            if (requests && requests.length > 0) {
                html += requests.map(req => `
                    <div class="request-item">
                        <div class="request-type">Time Adjustment</div>
                        <div class="request-status status-pending">Pending</div>
                    </div>
                `).join('');
            }

            if (transfers && transfers.length > 0) {
                html += transfers.map(req => `
                    <div class="request-item">
                        <div class="request-type">Shift Transfer</div>
                        <div class="request-status status-pending">Pending</div>
                    </div>
                `).join('');
            }

            if (leaves && leaves.length > 0) {
                html += leaves.map(req => `
                    <div class="request-item">
                        <div class="request-type">Leave Request</div>
                        <div class="request-status status-pending">Pending</div>
                    </div>
                `).join('');
            }

            container.innerHTML = html;
        }

        // Timesheet Functions
        async function loadTimesheet() {
            const { data: periodShifts } = await supabaseClient
                .from('shifts')
                .select(`
                    *,
                    participant:participant_id(first_name, last_name),
                    duty_type:duty_type_id(name)
                `)
                .eq('staff_id', currentStaff.id)
                .gte('date', currentPeriodStart.toISOString().split('T')[0])
                .lte('date', currentPeriodEnd.toISOString().split('T')[0])
                .is('deleted_at', null)
                .order('date')
                .order('start_time');

            myShifts = periodShifts || [];
            
            // Calculate hours breakdown
            calculateHoursBreakdown();
            
            // Render shift list
            renderTimesheetShifts();
        }

        function calculateHoursBreakdown() {
            const breakdown = {
                weekdayDay: 0,
                weekdayEvening: 0,
                weekdayNight: 0,
                saturday: 0,
                sunday: 0,
                publicHoliday: 0,
                sleepover: 0,
                total: 0
            };

            myShifts.forEach(shift => {
                const hours = calculateShiftHours(shift);
                Object.keys(breakdown).forEach(key => {
                    breakdown[key] += hours[key] || 0;
                });
            });

            // Update UI
            document.getElementById('hoursGrid').innerHTML = `
                <div class="hour-item">
                    <div class="hour-label">Weekday Day</div>
                    <div class="hour-value">${breakdown.weekdayDay.toFixed(1)}h</div>
                </div>
                <div class="hour-item">
                    <div class="hour-label">Weekday Eve</div>
                    <div class="hour-value">${breakdown.weekdayEvening.toFixed(1)}h</div>
                </div>
                <div class="hour-item">
                    <div class="hour-label">Weekday Night</div>
                    <div class="hour-value">${breakdown.weekdayNight.toFixed(1)}h</div>
                </div>
                <div class="hour-item">
                    <div class="hour-label">Saturday</div>
                    <div class="hour-value">${breakdown.saturday.toFixed(1)}h</div>
                </div>
                <div class="hour-item">
                    <div class="hour-label">Sunday</div>
                    <div class="hour-value">${breakdown.sunday.toFixed(1)}h</div>
                </div>
                <div class="hour-item">
                    <div class="hour-label">Public Holiday</div>
                    <div class="hour-value">${breakdown.publicHoliday.toFixed(1)}h</div>
                </div>
                <div class="hour-item">
                    <div class="hour-label">Sleepovers</div>
                    <div class="hour-value">${Math.floor(breakdown.sleepover / 2)} (${breakdown.sleepover}h)</div>
                </div>
                <div class="hour-item">
                    <div class="hour-label">Status</div>
                    <div class="hour-value" style="font-size: 14px;">Pending</div>
                </div>
            `;

            document.getElementById('totalHours').textContent = `${breakdown.total.toFixed(1)}h`;
        }

        function calculateShiftHours(shift) {
            const result = {
                total: 0,
                weekdayDay: 0,
                weekdayEvening: 0,
                weekdayNight: 0,
                saturday: 0,
                sunday: 0,
                publicHoliday: 0,
                sleepover: 0
            };

            // Check if sleepover
            if (shift.duty_type?.name?.toLowerCase().includes('sleepover')) {
                result.sleepover = 2;
                result.total = 2;
                return result;
            }

            // Calculate regular hours
            if (shift.start_time && shift.end_time) {
                const start = new Date(`2000-01-01T${shift.start_time}`);
                let end = new Date(`2000-01-01T${shift.end_time}`);
                
                if (end <= start) {
                    end.setDate(end.getDate() + 1);
                }

                const hours = (end - start) / (1000 * 60 * 60);
                const shiftDate = new Date(shift.date);
                const dayOfWeek = shiftDate.getDay();

                result.total = hours;

                if (dayOfWeek === 0) {
                    result.sunday = hours;
                } else if (dayOfWeek === 6) {
                    result.saturday = hours;
                } else {
                    // Split weekday hours by time of day
                    const startHour = parseInt(shift.start_time.split(':')[0]);
                    const endHour = parseInt(shift.end_time.split(':')[0]);
                    
                    // Simplified hour calculation
                    if (startHour >= 6 && endHour <= 14) {
                        result.weekdayDay = hours;
                    } else if (startHour >= 14 && endHour <= 22) {
                        result.weekdayEvening = hours;
                    } else {
                        result.weekdayNight = hours;
                    }
                }
            }

            return result;
        }

        function renderTimesheetShifts() {
            const container = document.getElementById('timesheetShifts');
            
            if (myShifts.length === 0) {
                container.innerHTML = '<div class="p-2 text-center" style="color: var(--text-light);">No shifts in this period</div>';
                return;
            }

            if (timesheetView === 'date') {
                // Group by date
                const grouped = {};
                myShifts.forEach(shift => {
                    if (!grouped[shift.date]) {
                        grouped[shift.date] = [];
                    }
                    grouped[shift.date].push(shift);
                });

                let html = '';
                Object.keys(grouped).sort().forEach(date => {
                    const dayShifts = grouped[date];
                    const dayHours = dayShifts.reduce((sum, s) => sum + (calculateShiftHours(s).total || 0), 0);
                    
                    html += `<div style="font-weight: 600; padding: 12px 16px; background: var(--bg-light);">${formatDateLong(date)}</div>`;
                    
                    dayShifts.forEach(shift => {
                        const participant = shift.participant;
                        const hours = calculateShiftHours(shift);
                        
                        html += `
                            <div class="shift-list-item">
                                <div class="shift-info">
                                    <div class="shift-date-time">
                                        ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                        ${shift.end_time ? formatTime(shift.end_time) : ''}
                                    </div>
                                    <div class="shift-client">
                                        ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                                    </div>
                                </div>
                                <div class="shift-hours">
                                    <div class="shift-hours-value">${hours.total.toFixed(1)}h</div>
                                </div>
                            </div>
                        `;
                    });
                });
                
                container.innerHTML = html;
            } else {
                // Group by participant
                const grouped = {};
                myShifts.forEach(shift => {
                    const key = shift.participant_id || 'unassigned';
                    if (!grouped[key]) {
                        grouped[key] = {
                            participant: shift.participant,
                            shifts: []
                        };
                    }
                    grouped[key].shifts.push(shift);
                });

                let html = '';
                Object.values(grouped).forEach(group => {
                    const totalHours = group.shifts.reduce((sum, s) => sum + (calculateShiftHours(s).total || 0), 0);
                    const participantName = group.participant ? 
                        `${group.participant.first_name} ${group.participant.last_name}` : 'Unassigned';
                    
                    html += `<div style="font-weight: 600; padding: 12px 16px; background: var(--bg-light);">${participantName} (${totalHours.toFixed(1)}h total)</div>`;
                    
                    group.shifts.forEach(shift => {
                        const hours = calculateShiftHours(shift);
                        
                        html += `
                            <div class="shift-list-item">
                                <div class="shift-info">
                                    <div class="shift-date-time">
                                        ${formatDateShort(shift.date)} ‚Ä¢ 
                                        ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                        ${shift.end_time ? formatTime(shift.end_time) : ''}
                                    </div>
                                </div>
                                <div class="shift-hours">
                                    <div class="shift-hours-value">${hours.total.toFixed(1)}h</div>
                                </div>
                            </div>
                        `;
                    });
                });
                
                container.innerHTML = html;
            }
        }

        async function loadNotifications() {
            const { data: notifs } = await supabaseClient
                .from('notifications')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(5);

            const container = document.getElementById('recentNotifications');
            
            if (!notifs || notifs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-light);">No recent updates</div>';
                return;
            }

            container.innerHTML = notifs.map(notif => `
                <div class="request-item">
                    <div class="request-type">${notif.message}</div>
                    <div style="font-size: 12px; color: var(--text-light);">${formatDateTime(notif.created_at)}</div>
                </div>
            `).join('');
        }


        function loadShiftTimes() {
    try {
        const select = document.getElementById('adjustmentShift');
        const selected = select.options[select.selectedIndex];
        
        if (selected && selected.dataset.start) {
            document.getElementById('adjustmentStartTime').value = selected.dataset.start || '';
            document.getElementById('adjustmentEndTime').value = selected.dataset.end || '';
        } else {
            document.getElementById('adjustmentStartTime').value = '';
            document.getElementById('adjustmentEndTime').value = '';
        }
    } catch (error) {
        console.error('Error loading shift times:', error);
        // Don't show toast for this minor error
    }
}


// Transfer Functions
async function loadTransfers() {
            // Load incoming transfer requests
            const { data: incoming } = await supabaseClient
                .from('transfer_requests')
                .select(`
                    *,
                    shift:shift_id(date, start_time, end_time, participant:participant_id(first_name, last_name)),
                    from_staff:from_staff_id(first_name, last_name)
                `)
                .eq('to_staff_id', currentStaff.id)
                .eq('status', 'pending')
                .order('created_at', { ascending: false });

            // Load outgoing transfer requests
            const { data: outgoing } = await supabaseClient
                .from('transfer_requests')
                .select(`
                    *,
                    shift:shift_id(date, start_time, end_time, participant:participant_id(first_name, last_name)),
                    to_staff:to_staff_id(first_name, last_name)
                `)
                .eq('from_staff_id', currentStaff.id)
                .in('status', ['pending', 'approved', 'denied'])
                .order('created_at', { ascending: false });

            // Update badge
            const incomingCount = incoming?.length || 0;
            document.getElementById('transferBadge').textContent = incomingCount;
            document.getElementById('transferBadge').classList.toggle('hidden', incomingCount === 0);

            // Render lists
            renderIncomingTransfers(incoming || []);
            renderOutgoingTransfers(outgoing || []);
        }

        function renderIncomingTransfers(transfers) {
            const container = document.getElementById('incomingList');
            
            if (transfers.length === 0) {
                container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No incoming transfer requests</div>';
                return;
            }

            container.innerHTML = transfers.map(transfer => `
                <div class="transfer-item">
                    <div class="transfer-header">
                        <div>
                            <div class="transfer-date">${formatDateLong(transfer.shift.date)}</div>
                            <div class="transfer-time">
                                ${transfer.shift.start_time ? formatTime(transfer.shift.start_time) : 'Sleepover'} - 
                                ${transfer.shift.end_time ? formatTime(transfer.shift.end_time) : ''}
                            </div>
                        </div>
                        <div class="transfer-badge status-pending">Pending</div>
                    </div>
                    <div class="transfer-from">
                        From: ${transfer.from_staff.first_name} ${transfer.from_staff.last_name}
                    </div>
                    ${transfer.reason ? `<div class="transfer-reason">"${transfer.reason}"</div>` : ''}
                    <div class="transfer-actions">
                        <button class="transfer-btn accept" onclick="acceptTransfer('${transfer.id}')">Accept</button>
                        <button class="transfer-btn decline" onclick="declineTransfer('${transfer.id}')">Decline</button>
                    </div>
                </div>
            `).join('');
        }

        function renderOutgoingTransfers(transfers) {
            const container = document.getElementById('outgoingList');
            
            if (transfers.length === 0) {
                container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No outgoing transfer requests</div>';
                return;
            }

            container.innerHTML = transfers.map(transfer => {
                let statusClass = 'status-pending';
                if (transfer.status === 'approved') statusClass = 'status-approved';
                if (transfer.status === 'denied') statusClass = 'status-denied';
                
                const toName = transfer.to_staff ? 
                    `${transfer.to_staff.first_name} ${transfer.to_staff.last_name}` : 'Pending';
                
                return `
                    <div class="transfer-item">
                        <div class="transfer-header">
                            <div>
                                <div class="transfer-date">${formatDateLong(transfer.shift.date)}</div>
                                <div class="transfer-time">
                                    ${transfer.shift.start_time ? formatTime(transfer.shift.start_time) : 'Sleepover'} - 
                                    ${transfer.shift.end_time ? formatTime(transfer.shift.end_time) : ''}
                                </div>
                            </div>
                            <div class="transfer-badge ${statusClass}">${transfer.status}</div>
                        </div>
                        <div class="transfer-from">To: ${toName}</div>
                        ${transfer.reason ? `<div class="transfer-reason">"${transfer.reason}"</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function acceptTransfer(transferId) {
    try {
        // Get transfer details
        const { data: transfer } = await supabaseClient
            .from('transfer_requests')
            .select('*, shift:shift_id(*)')
            .eq('id', transferId)
            .single();

        if (!transfer) {
            showToast('Transfer request not found', 'error');
            return;
        }

        // CHECK FOR LEAVE ON THIS DATE
        const { data: leaveCheck } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('date', transfer.shift.date)
            .eq('available', false)
            .single();

        if (leaveCheck) {
            showToast(`Cannot accept: You are on ${leaveCheck.reason} on ${formatDateShort(transfer.shift.date)}`, 'error');
            return;
        }

        // Check if accepting this shift creates conflict
        const { data: myShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('date', transfer.shift.date)
            .is('deleted_at', null);

        // Check for time conflicts
        if (myShifts && myShifts.length > 0) {
            const transferShift = transfer.shift;
            const isTransferSleepover = !transferShift.start_time || !transferShift.end_time;
            
            if (isTransferSleepover) {
                showToast('Cannot accept: You already have shifts on this date', 'error');
                return;
            }
            
            for (const existing of myShifts) {
                if (!existing.start_time || !existing.end_time) {
                    showToast('Cannot accept: You have a sleepover on this date', 'error');
                    return;
                }
                
                const newStart = new Date(`2000-01-01T${transferShift.start_time}`);
                const newEnd = new Date(`2000-01-01T${transferShift.end_time}`);
                const existStart = new Date(`2000-01-01T${existing.start_time}`);
                const existEnd = new Date(`2000-01-01T${existing.end_time}`);
                
                if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
                if (existEnd <= existStart) existEnd.setDate(existEnd.getDate() + 1);
                
                if (!(newEnd <= existStart || newStart >= existEnd)) {
                    showToast(`Cannot accept: Conflicts with your shift ${existing.start_time}-${existing.end_time}`, 'error');
                    return;
                }
            }
        }

        // Update shift assignment
        await supabaseClient
            .from('shifts')
            .update({ staff_id: currentStaff.id })
            .eq('id', transfer.shift_id);

        // Update transfer status
        await supabaseClient
            .from('transfer_requests')
            .update({ 
                status: 'approved',
                responded_at: new Date().toISOString(),
                responded_by: currentStaff.id
            })
            .eq('id', transferId);

        showToast('Transfer accepted successfully', 'success');
        loadTransfers();
        loadDashboard();

    } catch (error) {
        console.error('Error accepting transfer:', error);
        showToast('Failed to accept transfer', 'error');
    }
}

        async function declineTransfer(transferId) {
            try {
                await supabaseClient
                    .from('transfer_requests')
                    .update({ 
                        status: 'denied',
                        responded_at: new Date().toISOString(),
                        responded_by: currentStaff.id
                    })
                    .eq('id', transferId);

                showToast('Transfer declined', 'success');
                loadTransfers();

            } catch (error) {
                console.error('Error declining transfer:', error);
                showToast('Failed to decline transfer', 'error');
            }
        }

        async function loadTransferableShifts() {
    try {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const { data: shifts } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participant:participant_id(first_name, last_name),
                duty_type:duty_type_id(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', tomorrow.toISOString().split('T')[0])
            .is('deleted_at', null)
            .eq('status', 'confirmed')
            .order('date')
            .order('start_time');

        const select = document.getElementById('transferShiftSelect');
        select.innerHTML = '<option value="">Select a shift</option>';
        
        if (shifts && shifts.length > 0) {
            shifts.forEach(shift => {
                const participant = shift.participant;
                const label = `${formatDateShort(shift.date)} ${shift.start_time || 'Sleepover'} - ${participant?.first_name} ${participant?.last_name}`;
                select.innerHTML += `<option value="${shift.id}" data-start="${shift.start_time}" data-end="${shift.end_time}">${label}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading transferable shifts:', error);
        showToast('Failed to load transferable shifts', 'error');
    }
}
        async function loadAdjustableShifts() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            const { data: shifts } = await supabaseClient
                .from('shifts')
                .select(`
                    *,
                    participant:participant_id(first_name, last_name)
                `)
                .eq('staff_id', currentStaff.id)
                .gte('date', yesterday.toISOString().split('T')[0])
                .is('deleted_at', null)
                .in('status', ['confirmed', 'completed'])
                .order('date', { ascending: false })
                .order('start_time', { ascending: false })
                .limit(20);

            const select = document.getElementById('adjustmentShift');
            select.innerHTML = '<option value="">Select a shift</option>';
            
            if (shifts && shifts.length > 0) {
                shifts.forEach(shift => {
                    const participant = shift.participant;
                    const label = `${formatDateShort(shift.date)} ${shift.start_time || 'Sleepover'} - ${participant?.first_name} ${participant?.last_name}`;
                    select.innerHTML += `<option value="${shift.id}" data-start="${shift.start_time}" data-end="${shift.end_time}">${label}</option>`;
                });
            }
        }

async function loadParticipants() {
    try {
        const { data: participantsData } = await supabaseClient
            .from('participants')
            .select('*, care_home:care_home_id(name)')
            .is('deleted_at', null)
            .order('first_name');
        
        participants = participantsData || [];
        
        // Populate participant dropdowns with care home labels
        const selects = ['shiftParticipant', 'noteParticipant'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">Select Client</option>';
                participants.forEach(p => {
                    const careHomeLabel = p.care_home ? ` (${p.care_home.name})` : '';
                    select.innerHTML += `<option value="${p.id}">${p.first_name} ${p.last_name}${careHomeLabel}</option>`;
                });
            }
        });
    } catch (error) {
        console.error('Error loading participants:', error);
        showToast('Failed to load participants', 'error');
    }
}

async function loadWeeklyAvailability() {
    try {
        const { data } = await supabaseClient
            .from('staff_weekly_availability')
            .select('*')
            .eq('staff_id', currentStaff.id);
        
        // Clear existing availability
        weeklyAvailability = {};
        
        if (data && data.length > 0) {
            // Populate weeklyAvailability object
            data.forEach(slot => {
                const key = `${slot.day_of_week}_${slot.time_slot}`;
                weeklyAvailability[key] = slot.available;
            });
        }
        
        // Update UI grid
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const container = document.getElementById('availabilityGrid');
        
        if (container) {
            container.innerHTML = days.map((day, index) => {
                const hasAnySlot = weeklyAvailability[`${index}_0`] || 
                                  weeklyAvailability[`${index}_1`] || 
                                  weeklyAvailability[`${index}_2`] || 
                                  weeklyAvailability[`${index}_3`];
                
                return `
                    <div class="availability-day">
                        <div class="availability-day-header">
                            <span class="day-name">${day}</span>
                            <label class="availability-toggle">
                                <input type="checkbox" ${hasAnySlot ? 'checked' : ''} 
                                       onchange="toggleDayAvailability(${index}, this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="availability-times">
                            <div class="time-slot ${weeklyAvailability[`${index}_0`] ? 'selected' : ''}" 
                                 onclick="toggleTimeSlot(${index}, 0, this)">Morning</div>
                            <div class="time-slot ${weeklyAvailability[`${index}_1`] ? 'selected' : ''}"
                                 onclick="toggleTimeSlot(${index}, 1, this)">Afternoon</div>
                            <div class="time-slot ${weeklyAvailability[`${index}_2`] ? 'selected' : ''}"
                                 onclick="toggleTimeSlot(${index}, 2, this)">Evening</div>
                            <div class="time-slot ${weeklyAvailability[`${index}_3`] ? 'selected' : ''}"
                                 onclick="toggleTimeSlot(${index}, 3, this)">Night</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading availability:', error);
        showToast('Failed to load availability', 'error');
    }
}


// Also ensure saveWeeklyAvailability is correct
async function saveWeeklyAvailability() {
    try {
        const updates = [];
        for (let day = 0; day < 7; day++) {
            for (let slot = 0; slot < 4; slot++) {
                const key = `${day}_${slot}`;
                updates.push({
                    staff_id: currentStaff.id,
                    day_of_week: day,
                    time_slot: slot,
                    available: weeklyAvailability[key] || false
                });
            }
        }

        const { error } = await supabaseClient
            .from('staff_weekly_availability')
            .upsert(updates, { 
                onConflict: 'staff_id,day_of_week,time_slot' 
            });

        if (error) throw error;

        showToast('Availability updated successfully', 'success');

    } catch (error) {
        console.error('Error saving availability:', error);
        showToast('Failed to save availability', 'error');
    }
}


// Profile Functions
async function loadProfile() {
            // Personal Information
            document.getElementById('personalInfo').innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Full Name</div>
                    <div class="field-value">${currentStaff.first_name} ${currentStaff.middle_name || ''} ${currentStaff.last_name}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <div class="field-value">${currentStaff.date_of_birth ? formatDateShort(currentStaff.date_of_birth) : 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <div class="field-value">${currentStaff.ndis_worker_number || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Staff Code</div>
                    <div class="field-value">${currentStaff.staff_code || 'Not set'}</div>
                </div>
            `;

            // Contact Details
            document.getElementById('contactInfo').innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Email</div>
                    <div class="field-value">${currentStaff.email}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Phone</div>
                    <div class="field-value">${currentStaff.phone || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Address</div>
                    <div class="field-value">${currentStaff.address || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact</div>
                    <div class="field-value">${currentStaff.emergency_contact || 'Not set'}</div>
                </div>
            `;

            // Banking Details
            document.getElementById('bankingInfo').innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Bank</div>
                    <div class="field-value">${currentStaff.bank_name || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">BSB</div>
                    <div class="field-value">${currentStaff.bsb || 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Account Number</div>
                    <div class="field-value">${currentStaff.account_number ? '****' + currentStaff.account_number.slice(-4) : 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Tax File Number</div>
                    <div class="field-value">${currentStaff.tax_file_number ? '***-***-' + currentStaff.tax_file_number.slice(-3) : 'Not set'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Super Fund</div>
                    <div class="field-value">${currentStaff.super_fund || 'Not set'}</div>
                </div>
            `;

            // Load documents
            await loadDocuments();
            
            // Load availability
            await loadAvailability();
        }

        async function loadDocuments() {
            const { data: docs } = await supabaseClient
                .from('documents')
                .select('*, document_type:document_type_id(name)')
                .eq('entity_id', currentStaff.id)
                .eq('entity_type', 'staff')
                .is('deleted_at', null)
                .order('created_at', { ascending: false });

            documents = docs || [];
            
            const container = document.getElementById('documentList');
            
            if (documents.length === 0) {
                container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No documents uploaded</div>';
                return;
            }

            container.innerHTML = documents.map(doc => {
                let statusClass = 'status-verified';
                let statusText = 'Verified';
                
                if (!doc.is_verified) {
                    statusClass = 'status-pending';
                    statusText = 'Pending';
                }
                
                if (doc.expiry_date && new Date(doc.expiry_date) < new Date()) {
                    statusClass = 'status-expired';
                    statusText = 'Expired';
                }
                
                return `
                    <div class="document-item">
                        <div class="document-info">
                            <div class="document-name">${doc.title}</div>
                            <div class="document-meta">
                                ${doc.document_type?.name || 'Document'} ‚Ä¢ 
                                ${doc.expiry_date ? `Expires: ${formatDateShort(doc.expiry_date)}` : 'No expiry'}
                            </div>
                        </div>
                        <div class="document-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
        }

        async function loadAvailability() {
            const { data: availability } = await supabaseClient
                .from('staff_weekly_availability')
                .select('*')
                .eq('staff_id', currentStaff.id);

            if (availability) {
                availability.forEach(slot => {
                    const key = `${slot.day_of_week}_${slot.time_slot}`;
                    weeklyAvailability[key] = slot.available;
                });
            }

            renderAvailability();
        }

        function renderAvailability() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const container = document.getElementById('availabilityGrid');
            
            container.innerHTML = days.map((day, index) => `
                <div class="availability-day">
                    <div class="availability-day-header">
                        <span class="day-name">${day}</span>
                        <label class="availability-toggle">
                            <input type="checkbox" ${weeklyAvailability[`${index}_0`] || weeklyAvailability[`${index}_1`] || weeklyAvailability[`${index}_2`] || weeklyAvailability[`${index}_3`] ? 'checked' : ''} 
                                   onchange="toggleDayAvailability(${index}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="availability-times">
                        <div class="time-slot ${weeklyAvailability[`${index}_0`] ? 'selected' : ''}" 
                             onclick="toggleTimeSlot(${index}, 0, this)">Morning</div>
                        <div class="time-slot ${weeklyAvailability[`${index}_1`] ? 'selected' : ''}"
                             onclick="toggleTimeSlot(${index}, 1, this)">Afternoon</div>
                        <div class="time-slot ${weeklyAvailability[`${index}_2`] ? 'selected' : ''}"
                             onclick="toggleTimeSlot(${index}, 2, this)">Evening</div>
                        <div class="time-slot ${weeklyAvailability[`${index}_3`] ? 'selected' : ''}"
                             onclick="toggleTimeSlot(${index}, 3, this)">Night</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function submitAdjustment() {
    try {
        const shiftId = document.getElementById('adjustmentShift').value;
        const newStartTime = document.getElementById('adjustmentStartTime').value;
        const newEndTime = document.getElementById('adjustmentEndTime').value;
        const reason = document.getElementById('adjustmentReason').value;

        if (!shiftId || !reason) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        const { error } = await supabaseClient
            .from('shift_adjustment_requests')
            .insert({
                shift_id: shiftId,
                staff_id: currentStaff.id,
                new_start_time: newStartTime || null,
                new_end_time: newEndTime || null,
                adjustment_type: 'time_change',
                reason: reason,
                status: 'pending'
            });

        if (error) throw error;

        showToast('Adjustment request submitted for approval', 'success');
        closeModal('adjustmentModal');
        loadPendingRequests();

    } catch (error) {
        console.error('Error submitting adjustment:', error);
        showToast('Failed to submit adjustment request', 'error');
    }
}

async function submitShift() {
    try {
        const date = document.getElementById('shiftDate').value;
        const startTime = document.getElementById('shiftStartTime').value;
        const endTime = document.getElementById('shiftEndTime').value;
        const participantId = document.getElementById('shiftParticipant').value;
        const dutyTypeId = document.getElementById('shiftDutyType').value;
        const notes = document.getElementById('shiftNotes').value;

        if (!date || !participantId || !dutyTypeId) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        // CHECK IF ON LEAVE
        const { data: leaveCheck } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('date', date)
            .eq('available', false)
            .single();

        if (leaveCheck) {
            showToast(`Cannot add shift: You are on ${leaveCheck.reason} on this date`, 'error');
            return;
        }

        // Check for conflicts BEFORE insert
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('date', date)
            .is('deleted_at', null);

        if (existingShifts && existingShifts.length > 0) {
            // Check for sleepover conflict
            const isSleepover = !startTime || !endTime;
            
            if (isSleepover) {
                showToast('You already have a shift on this date. Cannot add sleepover.', 'error');
                return;
            }
            
            // Check time overlap for regular shifts
            for (const existing of existingShifts) {
                if (!existing.start_time || !existing.end_time) {
                    showToast('You have a sleepover shift on this date. Cannot add another shift.', 'error');
                    return;
                }
                
                const newStart = new Date(`2000-01-01T${startTime}`);
                const newEnd = new Date(`2000-01-01T${endTime}`);
                const existStart = new Date(`2000-01-01T${existing.start_time}`);
                const existEnd = new Date(`2000-01-01T${existing.end_time}`);
                
                // Handle overnight shifts
                if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
                if (existEnd <= existStart) existEnd.setDate(existEnd.getDate() + 1);
                
                if (!(newEnd <= existStart || newStart >= existEnd)) {
                    showToast(`Conflict: You have a shift from ${existing.start_time} to ${existing.end_time}`, 'error');
                    return;
                }
            }
        }

        // Auto-select location based on participant
        let locationId = null;
        const selectedParticipant = participants.find(p => p.id === participantId);
        if (selectedParticipant) {
            // If participant has care home, find matching location
            if (selectedParticipant.care_home_id) {
                const careHomeLocation = locations.find(l => 
                    l.name.toLowerCase().includes('care') || 
                    l.name.toLowerCase().includes('saunders')
                );
                locationId = careHomeLocation ? careHomeLocation.id : '00000000-0000-0000-0000-000000000001';
            } else {
                // Default to Client Home
                locationId = '00000000-0000-0000-0000-000000000001';
            }
        }

        // Create shift
        const { error } = await supabaseClient
            .from('shifts')
            .insert({
                date: date,
                start_time: startTime || null,
                end_time: endTime || null,
                staff_id: currentStaff.id,
                participant_id: participantId,
                location_id: locationId,
                duty_type_id: dutyTypeId,
                status: 'pending',
                notes: notes || null
            });

        if (error) throw error;

        showToast('Shift submitted for approval', 'success');
        closeModal('addShiftModal');
        
        // Clear form
        document.getElementById('shiftDate').value = '';
        document.getElementById('shiftStartTime').value = '';
        document.getElementById('shiftEndTime').value = '';
        document.getElementById('shiftParticipant').value = '';
        document.getElementById('shiftDutyType').value = '';
        document.getElementById('shiftNotes').value = '';
        
        loadDashboard();
        loadSchedule();

    } catch (error) {
        console.error('Error submitting shift:', error);
        showToast('Failed to submit shift', 'error');
    }
}


async function loadLocations() {
    try {
        const { data: locationsData } = await supabaseClient
            .from('locations')
            .select('*')
            .is('deleted_at', null)
            .order('name');
        
        locations = locationsData || [];
        
        // Add default "Client Home" option with specific ID
        const defaultClientHome = {
            id: '00000000-0000-0000-0000-000000000001',
            name: 'Client Home'
        };
        
        // Ensure Client Home is in the list
        if (!locations.find(l => l.id === defaultClientHome.id)) {
            locations.unshift(defaultClientHome);
        }
        
        // Populate location dropdowns
        const selects = ['shiftLocation'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">Select Location</option>';
                locations.forEach(l => {
                    const isDefault = l.id === '00000000-0000-0000-0000-000000000001';
                    select.innerHTML += `<option value="${l.id}"${isDefault ? ' selected' : ''}>${l.name}</option>`;
                });
            }
        });
    } catch (error) {
        console.error('Error loading locations:', error);
        showToast('Failed to load locations', 'error');
    }
}

async function submitLeave() {
    try {
        const leaveType = document.getElementById('leaveType').value;
        const startDate = document.getElementById('leaveStartDate').value;
        const endDate = document.getElementById('leaveEndDate').value;
        const reason = document.getElementById('leaveReason').value;

        if (!leaveType || !startDate || !endDate) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        // Validate dates
        if (new Date(startDate) > new Date(endDate)) {
            showToast('End date must be after start date', 'error');
            return;
        }

        // Generate all dates between start and end
        const dates = [];
        let currentDate = new Date(startDate);
        const end = new Date(endDate);
        
        while (currentDate <= end) {
            dates.push(new Date(currentDate).toISOString().split('T')[0]);
            currentDate.setDate(currentDate.getDate() + 1);
        }

        // Check for existing shifts during leave period
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('date')
            .eq('staff_id', currentStaff.id)
            .in('date', dates)
            .is('deleted_at', null);

        if (existingShifts && existingShifts.length > 0) {
            showToast(`You have ${existingShifts.length} shift(s) during this period. Please transfer them first.`, 'error');
            return;
        }

        // Insert blocked dates into staff_availability
        const availabilityBlocks = dates.map(date => ({
            staff_id: currentStaff.id,
            date: date,
            available: false,
            reason: `${leaveType.charAt(0).toUpperCase() + leaveType.slice(1)} leave${reason ? ': ' + reason : ''}`,
            created_at: new Date().toISOString()
        }));

        const { error } = await supabaseClient
            .from('staff_availability')
            .insert(availabilityBlocks);

        if (error) throw error;

        showToast(`Leave request submitted: ${dates.length} day(s) blocked`, 'success');
        closeModal('leaveModal');
        
        // Clear form
        document.getElementById('leaveType').value = '';
        document.getElementById('leaveStartDate').value = '';
        document.getElementById('leaveEndDate').value = '';
        document.getElementById('leaveReason').value = '';
        
        // Reload dashboard if visible
        if (document.getElementById('dashboard').classList.contains('active')) {
            loadDashboard();
        }
        
        // Reload schedule if visible
        if (document.getElementById('schedule').classList.contains('active')) {
            loadSchedule();
        }

    } catch (error) {
        console.error('Error submitting leave:', error);
        showToast('Failed to submit leave request', 'error');
    }
}

async function submitNote() {
    try {
        const shiftId = document.getElementById('noteShiftId').value;
        const noteType = document.getElementById('noteType').value;
        const content = document.getElementById('noteContent').value;

        if (!shiftId || !noteType || !content) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        // First, insert the note
        const { data: note, error: noteError } = await supabaseClient
            .from('shift_notes')
            .insert({
                shift_id: parseInt(shiftId),
                staff_id: currentStaff.id,
                note_type: noteType,
                note: content
            })
            .select()
            .single();

        if (noteError) throw noteError;

        // Handle image uploads if any
        if (selectedImages.length > 0) {
            for (const file of selectedImages) {
                const fileName = `shift-notes/${Date.now()}_${file.name}`;
                
                // Upload to storage
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('documents')
                    .upload(fileName, file);

                if (!uploadError) {
                    // Get public URL
                    const { data: urlData } = supabaseClient.storage
                        .from('documents')
                        .getPublicUrl(fileName);

                    // Create attachment record
                    await supabaseClient
                        .from('attachments')
                        .insert({
                            entity_type: 'shift_note',
                            entity_id: note.id,
                            file_type: 'image',
                            file_url: urlData.publicUrl,
                            file_name: file.name,
                            mime_type: file.type,
                            file_size: file.size,
                            uploaded_by: currentStaff.id
                        });
                }
            }
        }

        showToast('Note added successfully', 'success');
        closeModal('addNoteModal');
        
        // Refresh if on dashboard
        if (document.getElementById('dashboard').classList.contains('active')) {
            loadDashboard();
        }

    } catch (error) {
        console.error('Error adding note:', error);
        showToast('Failed to add note', 'error');
    }
}

function previewImages() {
    const files = document.getElementById('noteImages').files;
    const container = document.getElementById('imagePreviewContainer');
    
    selectedImages = Array.from(files);
    container.innerHTML = '';
    
    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-preview';
            img.onclick = () => removeImage(index);
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedImages.splice(index, 1);
    previewImages();
}

async function uploadDocument() {
    const fileInput = document.getElementById('documentFile');
    const file = fileInput.files[0];
    const documentType = document.getElementById('documentType').value;
    const title = document.getElementById('documentTitle').value;
    const expiryDate = document.getElementById('documentExpiry').value;
    const notes = document.getElementById('documentNotes').value;
    
    if (!file || !documentType || !title) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    try {
        // Check file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            showToast('File size must be less than 10MB', 'error');
            return;
        }
        
        // Upload to Supabase Storage
        const fileName = `${currentStaff.id}/${Date.now()}_${file.name}`;
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('documents')
            .upload(fileName, file);
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from('documents')
            .getPublicUrl(fileName);
        
        // Get or create document type
        let documentTypeId = null;
        const { data: docTypes } = await supabaseClient
            .from('document_types')
            .select('id')
            .eq('name', documentType)
            .single();

        if (docTypes) {
            documentTypeId = docTypes.id;
        } else {
            // Create new document type
            const { data: newType } = await supabaseClient
                .from('document_types')
                .insert({
                    name: documentType,
                    requires_expiry: ['firstaid', 'wwcc', 'police', 'ndis', 'visa'].includes(documentType.toLowerCase())
                })
                .select()
                .single();
            
            documentTypeId = newType.id;
        }
        
        // Save metadata to documents table
        const { error: dbError } = await supabaseClient
            .from('documents')
            .insert({
                entity_type: 'staff',
                entity_id: currentStaff.id,
                document_type_id: documentTypeId,
                title: title,
                file_url: urlData.publicUrl,
                file_name: file.name,
                file_path: fileName,
                expiry_date: expiryDate || null,
                notes: notes || null,
                is_verified: false,
                uploaded_at: new Date().toISOString()
            });
            
        if (dbError) throw dbError;
        
        showToast('Document uploaded successfully', 'success');
        closeModal('documentUploadModal');
        loadDocuments();
        
        // Clear form
        fileInput.value = '';
        document.getElementById('documentType').value = '';
        document.getElementById('documentTitle').value = '';
        document.getElementById('documentExpiry').value = '';
        document.getElementById('documentNotes').value = '';
        
    } catch (error) {
        console.error('Upload error:', error);
        showToast('Failed to upload document', 'error');
    }
}

function checkExpiryRequired() {
    const documentType = document.getElementById('documentType').value;
    const expiryGroup = document.getElementById('expiryGroup');
    const expiryInput = document.getElementById('documentExpiry');
    
    const requiresExpiry = ['firstaid', 'wwcc', 'police', 'ndis', 'visa'].includes(documentType);
    
    if (requiresExpiry) {
        expiryGroup.style.display = 'block';
        expiryInput.required = true;
    } else {
        expiryGroup.style.display = 'block';
        expiryInput.required = false;
    }
}

// Profile editing functions
function editPersonalInfo() {
    const container = document.getElementById('personalInfo');
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">First Name</div>
            <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name}">
        </div>
        <div class="profile-field">
            <div class="field-label">Middle Name</div>
            <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Last Name</div>
            <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name}">
        </div>
        <div class="profile-field">
            <div class="field-label">Date of Birth</div>
            <input type="date" class="form-control" id="editDOB" value="${currentStaff.date_of_birth || ''}">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-primary" onclick="savePersonalInfo()">Save</button>
            <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
        </div>
    `;
}

async function savePersonalInfo() {
    try {
        const updates = {
            first_name: document.getElementById('editFirstName').value,
            middle_name: document.getElementById('editMiddleName').value || null,
            last_name: document.getElementById('editLastName').value,
            date_of_birth: document.getElementById('editDOB').value || null
        };

        const { error } = await supabaseClient
            .from('staff')
            .update(updates)
            .eq('id', currentStaff.id);

        if (error) throw error;

        currentStaff = { ...currentStaff, ...updates };
        showToast('Personal information updated', 'success');
        loadProfile();
        document.getElementById('userName').textContent = `${currentStaff.first_name} ${currentStaff.last_name}`;

    } catch (error) {
        console.error('Error updating personal info:', error);
        showToast('Failed to update personal information', 'error');
    }
}

function editContactInfo() {
    const container = document.getElementById('contactInfo');
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Email</div>
            <input type="email" class="form-control" id="editEmail" value="${currentStaff.email}">
        </div>
        <div class="profile-field">
            <div class="field-label">Phone</div>
            <input type="tel" class="form-control" id="editPhone" value="${currentStaff.phone || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Address</div>
            <textarea class="form-control" id="editAddress">${currentStaff.address || ''}</textarea>
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact</div>
            <input type="text" class="form-control" id="editEmergency" value="${currentStaff.emergency_contact || ''}" placeholder="Name and phone number">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-primary" onclick="saveContactInfo()">Save</button>
            <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
        </div>
    `;
}

async function saveContactInfo() {
    try {
        const updates = {
            email: document.getElementById('editEmail').value,
            phone: document.getElementById('editPhone').value || null,
            address: document.getElementById('editAddress').value || null,
            emergency_contact: document.getElementById('editEmergency').value || null
        };

        const { error } = await supabaseClient
            .from('staff')
            .update(updates)
            .eq('id', currentStaff.id);

        if (error) throw error;

        currentStaff = { ...currentStaff, ...updates };
        showToast('Contact information updated', 'success');
        loadProfile();

    } catch (error) {
        console.error('Error updating contact info:', error);
        showToast('Failed to update contact information', 'error');
    }
}

function editBankingInfo() {
    const container = document.getElementById('bankingInfo');
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Bank Name</div>
            <input type="text" class="form-control" id="editBankName" value="${currentStaff.bank_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">BSB</div>
            <input type="text" class="form-control" id="editBSB" value="${currentStaff.bsb || ''}" maxlength="6">
        </div>
        <div class="profile-field">
            <div class="field-label">Account Number</div>
            <input type="text" class="form-control" id="editAccountNumber" value="${currentStaff.account_number || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Tax File Number</div>
            <input type="text" class="form-control" id="editTFN" value="${currentStaff.tax_file_number || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Super Fund</div>
            <input type="text" class="form-control" id="editSuper" value="${currentStaff.super_fund || ''}">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-primary" onclick="saveBankingInfo()">Save</button>
            <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
        </div>
    `;
}

async function saveBankingInfo() {
    try {
        const updates = {
            bank_name: document.getElementById('editBankName').value || null,
            bsb: document.getElementById('editBSB').value || null,
            account_number: document.getElementById('editAccountNumber').value || null,
            tax_file_number: document.getElementById('editTFN').value || null,
            super_fund: document.getElementById('editSuper').value || null
        };

        const { error } = await supabaseClient
            .from('staff')
            .update(updates)
            .eq('id', currentStaff.id);

        if (error) throw error;

        currentStaff = { ...currentStaff, ...updates };
        showToast('Banking information updated', 'success');
        loadProfile();

    } catch (error) {
        console.error('Error updating banking info:', error);
        showToast('Failed to update banking information', 'error');
    }
}

// Availability functions
function toggleDayAvailability(day, available) {
    // Update all time slots for the day
    for (let slot = 0; slot < 4; slot++) {
        weeklyAvailability[`${day}_${slot}`] = available;
    }
    renderAvailability();
}

function toggleTimeSlot(day, slot, element) {
    const key = `${day}_${slot}`;
    weeklyAvailability[key] = !weeklyAvailability[key];
    element.classList.toggle('selected');
}

async function saveAvailability() {
    try {
        const updates = [];
        for (let day = 0; day < 7; day++) {
            for (let slot = 0; slot < 4; slot++) {
                updates.push({
                    staff_id: currentStaff.id,
                    day_of_week: day,
                    time_slot: slot,
                    available: weeklyAvailability[`${day}_${slot}`] || false
                });
            }
        }

        const { error } = await supabaseClient
            .from('staff_weekly_availability')
            .upsert(updates, { onConflict: 'staff_id,day_of_week,time_slot' });

        if (error) throw error;

        showToast('Availability updated successfully', 'success');

    } catch (error) {
        console.error('Error saving availability:', error);
        showToast('Failed to save availability', 'error');
    }
}

// Profile Banner Functions
async function handleBannerUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        // Check file size
        if (file.size > 5 * 1024 * 1024) {
            showToast('Banner image must be less than 5MB', 'error');
            return;
        }

        // Upload to Supabase Storage
        const fileName = `profile-banners/${currentStaff.id}_${Date.now()}.${file.name.split('.').pop()}`;
        const { data, error } = await supabaseClient.storage
            .from('documents')
            .upload(fileName, file);

        if (error) throw error;

        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from('documents')
            .getPublicUrl(fileName);

        // Update staff record with banner URL
        await supabaseClient
            .from('staff')
            .update({ profile_banner_url: urlData.publicUrl })
            .eq('id', currentStaff.id);

        // Update UI
        document.getElementById('profileBanner').style.backgroundImage = `url(${urlData.publicUrl})`;
        document.getElementById('profileBanner').style.backgroundSize = 'cover';
        document.getElementById('profileBanner').style.backgroundPosition = 'center';

        showToast('Profile banner updated', 'success');

    } catch (error) {
        console.error('Error uploading banner:', error);
        showToast('Failed to upload banner', 'error');
    }
}

async function loadProfileBanner() {
    if (currentStaff.profile_banner_url) {
        document.getElementById('profileBanner').style.backgroundImage = `url(${currentStaff.profile_banner_url})`;
        document.getElementById('profileBanner').style.backgroundSize = 'cover';
        document.getElementById('profileBanner').style.backgroundPosition = 'center';
    }
    
    // Show upload button on hover
    document.getElementById('profileBanner').addEventListener('mouseenter', () => {
        document.getElementById('bannerUploadBtn').style.display = 'block';
    });
    
    document.getElementById('profileBanner').addEventListener('mouseleave', () => {
        document.getElementById('bannerUploadBtn').style.display = 'none';
    });
}

// Button styling classes to add to CSS
const additionalStyles = `
.btn {
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
}

.btn-secondary:hover {
    background: #d0d0d0;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 12px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-dark);
}

.btn-outline:hover {
    background: var(--bg-light);
}
`;

async function loadSchedule() {
    try {
        const currentDate = new Date();
        const monthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const monthEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        
        // Load shifts for the month
        const { data: monthShifts } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participant:participant_id(first_name, last_name),
                location:location_id(name),
                duty_type:duty_type_id(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', monthStart.toISOString().split('T')[0])
            .lte('date', monthEnd.toISOString().split('T')[0])
            .is('deleted_at', null)
            .order('date')
            .order('start_time');

        // Load leave days for the month
        const { data: leaveDays } = await supabaseClient
            .from('staff_availability')
            .select('date, reason')
            .eq('staff_id', currentStaff.id)
            .eq('available', false)
            .gte('date', monthStart.toISOString().split('T')[0])
            .lte('date', monthEnd.toISOString().split('T')[0]);

        // Create maps for quick lookup
        const shiftMap = {};
        const leaveMap = {};
        
        if (monthShifts) {
            monthShifts.forEach(shift => {
                if (!shiftMap[shift.date]) {
                    shiftMap[shift.date] = [];
                }
                shiftMap[shift.date].push(shift);
            });
        }
        
        if (leaveDays) {
            leaveDays.forEach(leave => {
                leaveMap[leave.date] = leave.reason;
            });
        }

        // Generate calendar HTML
        const container = document.getElementById('scheduleContent');
        const firstDay = monthStart.getDay();
        const daysInMonth = monthEnd.getDate();
        
        let calendarHTML = `
            <div class="calendar-header">
                <button onclick="changeMonth(-1)" class="nav-btn">‚Äπ</button>
                <h3>${monthStart.toLocaleDateString('en-AU', { month: 'long', year: 'numeric' })}</h3>
                <button onclick="changeMonth(1)" class="nav-btn">‚Ä∫</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-weekdays">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
                    <div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-days">
        `;
        
        // Add empty cells for days before month start
        for (let i = 0; i < firstDay; i++) {
            calendarHTML += '<div class="calendar-day empty"></div>';
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayShifts = shiftMap[dateStr] || [];
            const isLeave = leaveMap[dateStr];
            const isToday = dateStr === new Date().toISOString().split('T')[0];
            
            calendarHTML += `
                <div class="calendar-day${isToday ? ' today' : ''}${isLeave ? ' on-leave' : ''}${dayShifts.length > 0 ? ' has-shifts' : ''}">
                    <div class="calendar-day-number">${day}</div>
            `;
            
            if (isLeave) {
                calendarHTML += `<div class="leave-indicator" title="${isLeave}">LEAVE</div>`;
            }
            
            if (dayShifts.length > 0) {
                calendarHTML += `<div class="shift-count">${dayShifts.length} shift${dayShifts.length > 1 ? 's' : ''}</div>`;
                dayShifts.forEach(shift => {
                    const time = shift.start_time ? 
                        `${formatTime(shift.start_time)}-${formatTime(shift.end_time)}` : 
                        'Sleepover';
                    const participant = shift.participant ? 
                        `${shift.participant.first_name} ${shift.participant.last_name}` : 
                        'Unassigned';
                    
                    calendarHTML += `
                        <div class="calendar-shift status-${shift.status}" 
                             onclick="viewShiftDetails('${shift.id}')"
                             title="${participant} - ${time}">
                            <div class="shift-time">${time}</div>
                            <div class="shift-client">${participant}</div>
                        </div>
                    `;
                });
            }
            
            calendarHTML += '</div>';
        }
        
        calendarHTML += `
                </div>
            </div>
        `;
        
        container.innerHTML = calendarHTML;
        
    } catch (error) {
        console.error('Error loading schedule:', error);
        showToast('Failed to load schedule', 'error');
    }
}

        function populateParticipantFilter() {
            const select = document.getElementById('participantFilter');
            const uniqueParticipants = {};
            
            allShifts.forEach(shift => {
                if (shift.participant) {
                    uniqueParticipants[shift.participant_id] = shift.participant;
                }
            });

            select.innerHTML = '<option value="">All My Clients</option>';
            Object.values(uniqueParticipants).forEach(participant => {
                select.innerHTML += `
                    <option value="${participant.id}">
                        ${participant.first_name} ${participant.last_name}
                    </option>
                `;
            });
        }

        function filterSchedule() {
            renderSchedule();
        }

        function renderSchedule() {
            const container = document.getElementById('scheduleGrid');
            const filterValue = document.getElementById('participantFilter').value;
            
            let filteredShifts = allShifts;
            if (filterValue) {
                filteredShifts = allShifts.filter(s => s.participant_id === filterValue);
            }

            // Group by date
            const grouped = {};
            filteredShifts.forEach(shift => {
                if (!grouped[shift.date]) {
                    grouped[shift.date] = [];
                }
                grouped[shift.date].push(shift);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(date => {
                const dayShifts = grouped[date];
                const isToday = date === new Date().toISOString().split('T')[0];
                
                html += `
                    <div class="day-section">
                        <div class="day-header" style="${isToday ? 'background: var(--primary-color); color: white;' : ''}">
                            <div class="day-date">${formatDateLong(date)}</div>
                            <div class="day-shift-count">${dayShifts.length}</div>
                        </div>
                        <div class="day-shifts">
                `;

                dayShifts.forEach(shift => {
                    const isMyShift = shift.staff_id === currentStaff.id;
                    const staffName = shift.staff ? `${shift.staff.first_name} ${shift.staff.last_name}` : 'Unassigned';
                    
                    html += `
                        <div class="schedule-shift" style="${isMyShift ? 'background: #e3f2fd; border-left: 3px solid var(--primary-color);' : ''}">
                            <div>
                                <div class="schedule-shift-time">
                                    ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                    ${shift.end_time ? formatTime(shift.end_time) : ''}
                                </div>
                                <div class="schedule-shift-staff">${staffName}</div>
                            </div>
                            ${isMyShift ? `
                                <div class="schedule-shift-actions">
                                    <button class="action-btn secondary" onclick="addNoteToShift(${shift.id})">Note</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<div class="p-2 text-center">No shifts found</div>';
        }

        // Add all the edit profile functions
        function editPersonalInfo() {
            const container = document.getElementById('personalInfo');
            container.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">First Name</div>
                    <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Middle Name</div>
                    <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Last Name</div>
                    <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <input type="date" class="form-control" id="editDOB" value="${currentStaff.date_of_birth || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <input type="text" class="form-control" id="editNDIS" value="${currentStaff.ndis_worker_number || ''}">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="savePersonalInfo()">Save</button>
                    <button class="btn btn-secondary" onclick="loadProfile()">Cancel</button>
                </div>
            `;
        }

        async function savePersonalInfo() {
            try {
                const updates = {
                    first_name: document.getElementById('editFirstName').value,
                    middle_name: document.getElementById('editMiddleName').value || null,
                    last_name: document.getElementById('editLastName').value,
                    date_of_birth: document.getElementById('editDOB').value || null,
                    ndis_worker_number: document.getElementById('editNDIS').value || null
                };

                const { error } = await supabaseClient
                    .from('staff')
                    .update(updates)
                    .eq('id', currentStaff.id);

                if (error) throw error;

                currentStaff = { ...currentStaff, ...updates };
                showToast('Personal information updated', 'success');
                loadProfile();
                document.getElementById('userName').textContent = `${currentStaff.first_name} ${currentStaff.last_name}`;

            } catch (error) {
                console.error('Error updating personal info:', error);
                showToast('Failed to update personal information', 'error');
            }
        }

        // Continue with all other edit functions (editContactInfo, editBankingInfo, etc.)
        // ... [Include all the edit/save functions from the previous code]

        // Helper Functions
        function setGreeting() {
            const hour = new Date().getHours();
            let greeting = 'Good morning';
            
            if (hour >= 12 && hour < 17) {
                greeting = 'Good afternoon';
            } else if (hour >= 17) {
                greeting = 'Good evening';
            }
            
            document.getElementById('greeting').textContent = `${greeting}, ${currentStaff.first_name}!`;
            document.getElementById('currentDate').textContent = formatDateLong(new Date().toISOString().split('T')[0]);
        }

        function setCurrentPayPeriod() {
            const now = new Date();
            const daysSinceStart = Math.floor((now - PAY_PERIOD_START) / (1000 * 60 * 60 * 24));
            const periodNumber = Math.floor(daysSinceStart / PERIOD_LENGTH);
            
            currentPeriodStart = new Date(PAY_PERIOD_START);
            currentPeriodStart.setDate(currentPeriodStart.getDate() + (periodNumber * PERIOD_LENGTH));
            
            currentPeriodEnd = new Date(currentPeriodStart);
            currentPeriodEnd.setDate(currentPeriodEnd.getDate() + PERIOD_LENGTH - 1);
            
            updatePeriodDisplay();
        }

        function changePeriod(direction) {
            currentPeriodStart.setDate(currentPeriodStart.getDate() + (direction * PERIOD_LENGTH));
            currentPeriodEnd.setDate(currentPeriodEnd.getDate() + (direction * PERIOD_LENGTH));
            
            updatePeriodDisplay();
            loadTimesheet();
        }

        function updatePeriodDisplay() {
            const startStr = formatDateShort(currentPeriodStart.toISOString().split('T')[0]);
            const endStr = formatDateShort(currentPeriodEnd.toISOString().split('T')[0]);
            document.getElementById('periodDates').textContent = `${startStr} - ${endStr}`;
        }

        // Format functions
        function formatTime(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minutes} ${period}`;
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString + 'T12:00:00');
            return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        }

        function formatDateLong(dateString) {
            const date = new Date(dateString + 'T12:00:00');
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return `${days[date.getDay()]}, ${date.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' })}`;
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Navigation functions
        function switchSection(section) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Update content sections
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            
            // Load section data
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'timesheet':
                    loadTimesheet();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'transfers':
                    loadTransfers();
                    break;
                case 'profile':
                    loadProfile();
                    break;
            }
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Reset form if exists
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
            
            // Clear selected images
            selectedImages = [];
            const previewContainer = document.getElementById('imagePreviewContainer');
            if (previewContainer) previewContainer.innerHTML = '';
        }

        // Initialize button style
        function addButtonStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .btn {
                    padding: 12px 20px;
                    border: none;
                    border-radius: var(--radius-md);
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-size: 14px;
                }
                .btn-primary {
                    background: var(--primary-color);
                    color: white;
                }
                .btn-primary:hover {
                    background: var(--primary-dark);
                }
                .btn-secondary {
                    background: var(--bg-light);
                    color: var(--text-dark);
                }
                .btn-secondary:hover {
                    background: #d0d0d0;
                }
                .btn-sm {
                    padding: 8px 16px;
                    font-size: 12px;
                }
                .btn-outline {
                    background: transparent;
                    border: 1px solid var(--border-color);
                    color: var(--text-dark);
                }
                .btn-outline:hover {
                    background: var(--bg-light);
                }
            `;
            document.head.appendChild(style);
        }

        // Call on load
        document.addEventListener('DOMContentLoaded', () => {
            addButtonStyles();
        });

        </script>
        </body>
        </html>

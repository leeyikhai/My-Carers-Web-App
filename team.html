
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Google Maps Configuration
        const GOOGLE_MAPS_API_KEY = 'AIzaSyDo5V32Ix0Xi40HdORZ5XGtxYxMBGbUJfw'; 
        
       
        
        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadGoogleMapsForTeam();
        });
        </script>
    <title>My Carers</title>
  
    <!-- favicon links -->
    <link rel="icon" type="image/png" sizes="16x16" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-32x32.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <style>



#step2Content {
    display: none;
}

#step2Content.active {
    display: block;
}

#transportMap {
    width: 100%;
    height: 400px;
    border-radius: 8px;
    margin-bottom: 20px;
    background: #e5e3df;
    position: relative; /* Important for Google Maps */
}

/* Ensure Google Maps renders properly */
#transportMap > div {
    border-radius: 8px;
}

    /* Transport Claim Specific Styles */
    .transport-claim-wrapper {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }
        
        /* Step Navigation */
        .transport-steps {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
        }
        
        .transport-steps-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .transport-steps-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .step-indicators {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
        }
        
        .step-dot.active {
            width: 30px;
            border-radius: 5px;
            background: white;
        }
        
        .step-dot.completed {
            background: #28a745;
        }
        
        /* Transport Content Area */
        .transport-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .transport-section {
            display: none;
        }
        
        .transport-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Quick Routes Cards */
        .quick-routes-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .route-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .route-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .route-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        
        .route-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .route-name {
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        .route-actions {
            display: flex;
            gap: 8px;
        }
        
        .route-favorite {
            color: #ffc107;
            font-size: 0.9rem;
        }
        
        .route-delete {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .route-delete:hover {
            opacity: 1;
        }
        
        .route-info {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .route-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .route-stat.highlight {
            color: #28a745;
            font-weight: 600;
        }
        
        .route-addresses {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }
        
        .route-address-line {
            margin: 3px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* New Route Form */
        .new-route-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .address-input-group {
    display: flex;
    gap: 10px;
    align-items: stretch;
}

.address-input {
    flex: 1;
    width: 100%; /* Ensure full width */
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
}
        .address-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-home {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .btn-home:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        /* Map Container */
        .map-container {
            width: 100%;
            height: 350px;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            border: 1px solid #ddd;
            background: #f0f0f0;
            position: relative;
        }
        
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        /* Route Options */
        .route-options-list {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }
        
        .route-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .route-option:hover {
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.15);
        }
        
        .route-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }
        
        .route-option-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .route-option-header input[type="radio"] {
            margin: 0;
        }
        
        .route-label {
            font-weight: 600;
            color: #333;
        }
        
        .badge-recommended {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: auto;
        }
        
        .route-details {
            margin-left: 25px;
        }
        
        .route-via {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        /* Confirmation Section */
        .confirmation-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        
        .trip-summary {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            color: #666;
            font-weight: 500;
        }
        
        .summary-value {
            color: #333;
            text-align: right;
        }
        
        .summary-row.total {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
            margin: 10px -20px -20px;
            padding: 15px 20px;
            border-radius: 0 0 8px 8px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .summary-row.total .summary-value {
            color: #28a745;
        }
        
        /* Save Route Checkbox */
        .save-route-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .save-route-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Action Footer */
        .transport-actions {
            background: #f8f9fa;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .btn-transport {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-transport:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-back {
            background: #6c757d;
            color: white;
        }
        
        .btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-submit {
            background: #28a745;
            color: white;
        }
        
        .btn-transport:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* Loading States */
        .route-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Divider */
        .divider-text {
            text-align: center;
            margin: 30px 0;
            color: #999;
            position: relative;
        }
        
        .divider-text::before,
        .divider-text::after {
            content: '';
            position: absolute;
            top: 50%;
            width: calc(50% - 30px);
            height: 1px;
            background: #e0e0e0;
        }
        
        .divider-text::before {
            left: 0;
        }
        
        .divider-text::after {
            right: 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .transport-claim-wrapper {
                height: calc(100vh - 100px);
            }
            
            .map-container {
                height: 250px;
            }
            
            .route-info {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .btn-home {
                padding: 10px;
            }
            
            .btn-home span {
                display: none;
            }
        }

        /*end transport styles*/

        
        :root {
            --primary-color: #004990;
            --primary-dark: #003670;
            --primary-light: #0056b3;
            --success-color: #88a542;
            --info-color: #359dca;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f8f9fa;
            --bg-dark: #1a2332;
            --border-color: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        .shift-note {
    margin: 15px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-left: 3px solid #ffd93d;
    border-radius: 4px;
}

.shift-note-header {
    font-size: 12px;
    font-weight: 600;
    color: #ffd93d;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.shift-note-content {
    font-size: 14px;
    color: rgba(0, 0, 0, 0.8); /* Dark color for contrast */
    line-height: 1.5;
    white-space: pre-wrap; /* Preserves line breaks */
}
        .claim-filter-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.claim-filter-btn.active {
    font-weight: 600;
}

.shift-item {
    position: relative;
    transition: all 0.2s ease;
}

.shift-item:hover {
    background: #f8f9fa;
}

/* Loading overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.98);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}

.loading-content {
    text-align: center;
    max-width: 400px;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-content h2 {
    color: #333;
    margin-bottom: 10px;
    font-size: 24px;
}

#loadingStatus {
    color: #666;
    margin-bottom: 20px;
    font-size: 14px;
}

.loading-progress {
    width: 100%;
    height: 6px;
    background: #f0f0f0;
    border-radius: 3px;
    overflow: hidden;
}

.loading-progress-bar {
    height: 100%;
    background: var(--primary);
    width: 0%;
    transition: width 0.3s ease;
}

/* Hide everything else while loading */
body.loading {
    overflow: hidden;
}
        /* Filter bar */
.notes-filter-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: white;
    border-bottom: 1px solid #e0e0e0;
}

.filter-toggle-btn {
    padding: 6px 12px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.filter-toggle-btn:hover {
    background: #f5f5f5;
}

.notes-info {
    font-size: 14px;
    color: #666;
}

/* Filter panel */
.filter-panel {
    padding: 15px;
    background: #f9f9f9;
    border-bottom: 1px solid #e0e0e0;
}

.filter-section {
    margin-bottom: 15px;
}

.filter-section label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    font-weight: 500;
}

.date-range {
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-input, .filter-select {
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.filter-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}
.filter-bar {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: var(--bg-light);
    border-bottom: 1px solid var(--border-color);
    align-items: center;
}

.filter-select {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: white;
}

.request-item {
    display: flex;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    gap: 12px;
    transition: background 0.2s;
}

.request-item:hover {
    background: var(--bg-light);
}

.request-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-full);
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
}

.request-details {
    flex: 1;
}

.request-title {
    font-weight: 600;
    margin-bottom: 4px;
}

.request-info {
    font-size: 14px;
    color: var(--text-secondary);
}

.request-meta {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 4px;
}

.status-pill {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    text-transform: capitalize;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-approved {
    background: #d4edda;
    color: #155724;
}

.status-rejected {
    background: #f8d7da;
    color: #721c24;
}

.btn-icon {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
}

.btn-icon:hover {
    background: var(--bg-light);
    color: var(--text-dark);
}

/* Load more buttons */
.load-more-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 20px;
}

.load-btn {
    padding: 8px 16px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
}

.load-btn:hover {
    background: #f5f5f5;
}

        .quick-image-preview {
    display: flex;
    gap: 8px;
    margin: 8px 0;
    flex-wrap: wrap;
}

.preview-item {
    position: relative;
    width: 60px;
    height: 60px;
}

.preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}

.preview-item .remove-btn {
    position: absolute;
    top: -5px;
    right: -5px;
    background: red;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 10px;
}

.message-images {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    flex-wrap: wrap;
}

.message-image {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
}

.message-image:hover {
    opacity: 0.9;
}
 



.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
}

.message-content {
    max-width: 95%;
    background: white;
    border-radius: 12px;
    padding: 12px 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    color: #000000; /* Force black text */
}

.own-message .message-content {
    background: var(--primary);
    color: white;
}

.other-message .message-content {
    color: #000000;
}




.compose-toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
}



.compose-input-wrapper {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

/* Fix compose toolbar button states */
.compose-toolbar button {
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    background: white;
    border-radius: 4px;
    cursor: pointer;
    color: #333; /* Ensure icons are visible */
    transition: all 0.2s;
}

.compose-toolbar button:hover {
    background: #f0f0f0;
    color: #000;
}

/* Active/selected state for formatting buttons */
.compose-toolbar button.active {
    background: var(--primary, #2196f3);
    color: white !important;
    border-color: var(--primary, #2196f3);
}

.compose-toolbar button.active i {
    color: white !important;
}

.send-button:hover {
    transform: scale(1.1);
}
/* Image attachment display */
.attachment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
    margin: 10px 0;
}

.attachment-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    aspect-ratio: 1;
}

.attachment-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s;
}

.attachment-item:hover img {
    transform: scale(1.05);
}

.attachment-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
}

.attachment-item:hover .attachment-overlay {
    opacity: 1;
}

.attachment-overlay i {
    color: white;
    font-size: 24px;
}

.attachment-count {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 5px;
}

/* Image viewer modal */
.image-viewer-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-viewer-content {
    position: relative;
    max-width: 90%;
    max-height: 90%;
}

.image-viewer-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
}

.viewer-close {
    position: absolute;
    top: -40px;
    right: 0;
    background: none;
    border: none;
    color: white;
    font-size: 30px;
    cursor: pointer;
}

.viewer-navigation {
    position: absolute;
    bottom: -50px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    align-items: center;
    color: white;
}

/* Navigation buttons grid */
.participant-menu {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.btn-nav {
    padding: 20px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.btn-nav:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-nav i {
    font-size: 24px;
}

/* Slide-over panel */

.slide-panel.active {
    right: 0;
}


/* Make panel non-transparent */
.slide-panel {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    max-width: 600px;
    height: 100vh;
    background: var(--bg-color, #ffffff); /* Solid background */
    box-shadow: -4px 0 20px rgba(0,0,0,0.2);
    transition: right 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
}

/* Roster grid similar to schedule */
.roster-period-selector {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: var(--card-bg);
    border-radius: 8px;
    margin-bottom: 20px;
}

.roster-shifts-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* Shift note cards using existing shift-card styles */
.shift-note-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.shift-note-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.shift-note-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.shift-note-meta {
    color: var(--text-light);
    font-size: 0.9em;
    margin-top: 5px;
}

.shift-note-content {
    color: var(--text-color);
    line-height: 1.6;
}

.shift-note-category {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 500;
}

.category-medical {
    background: #fee;
    color: #c00;
}

.category-behavioral {
    background: #fef;
    color: #909;
}

.category-general {
    background: #eef;
    color: #009;
}
/* Panel header */
.panel-header {
    position: sticky;
    top: 0;
    background: var(--card-bg, #ffffff); /* Solid background */
    padding: 15px 20px;
    border-bottom: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 100;
    backdrop-filter: none; /* Remove any blur/transparency */
}


.back-btn {
    padding: 8px 15px;
    background: none;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.back-btn:hover {
    background: var(--primary);
    color: white;
}

.panel-content {
    padding: 20px;
}

/* Comments wrapper - fixed height */
.comments-wrapper {
    height: calc(100vh - 200px); /* Adjust based on your header */
    display: flex;
    flex-direction: column;
    position: relative;
}


/* Messages container - scrollable */
.messages-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 5px;
    background: #f9fafb;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
}

/* Message styling with fixed width */
.message {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

.message-content {
    width: 85%; /* Fixed width instead of max-width */
    background: white;
    border-radius: 12px;
    padding: 12px 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    color: #000000;
}

.own-message {
    flex-direction: row-reverse;
}

.own-message .message-content {
    background: #e3f2fd;
    color: #000000;
}

.message-header {
    display: flex;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 12px;
    color: #666666;
}

.message-body {
    line-height: 1.5;
    color: #000000;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Fix bullet points */
.message-body ul {
    margin: 8px 0;
    padding-left: 20px; /* Proper indentation */
}

.message-body li {
    margin: 4px 0;
    list-style-position: inside;
}

/* Compose container - fixed at bottom */
.compose-container {
    position: sticky;
    bottom: 0;
    background: white;
    border-top: 1px solid #e0e0e0;
    padding: 12px;
    z-index: 100;
}

/* Compose input that expands upward */
.compose-input {
    flex: 1;
    min-height: 40px;
    max-height: 120px;
    overflow-y: auto;
    padding: 10px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    outline: none;
    color: #000000;
    background: white;
    font-size: 16px; /* Prevents zoom on iOS */
    resize: none;
    line-height: 1.4;
}

.compose-input:focus {
    border-color: #2196f3;
}

/* Send button styling */
.send-button {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #2196f3;
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-left: 8px;
    align-self: flex-end;
}

/* Mobile-specific fixes */
@media (max-width: 768px) {
    .comments-wrapper {
        height: calc(100vh - 100px);
    }
    
    .compose-container {
        padding-bottom: env(safe-area-inset-bottom); /* For iPhone notch */
    }
    
    /* Hide autofill icons on mobile */
    input::-webkit-credentials-auto-fill-button,
    input::-webkit-caps-lock-indicator,
    input::-ms-clear,
    input::-ms-reveal {
        display: none !important;
    }
    
    /* Prevent keyboard accessories */
    .compose-input {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
}

/* Ensure panel takes full height */
.slide-panel .panel-content {
    height: 100vh;
    padding: 0;
    display: flex;
    flex-direction: column;
}

#notesView {
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* Dark overlay when panel is open */
.panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 999;
}

.panel-overlay.active {
    display: block;
}

        .participant-tabs {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    border-bottom: 2px solid var(--border-color);
}

/* Container styles */
.requests-tabs {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    border-bottom: 2px solid var(--border-color);
    overflow-x: auto;
}

.requests-content {
    padding: 20px 0;
}

/* Badge in tab */
.tab-btn .badge {
    margin-left: 5px;
    padding: 2px 6px;
    background: var(--primary);
    color: white;
    border-radius: 10px;
    font-size: 11px;
    display: inline-block;
}

/* Request cards */
.request-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 12px;
}

.request-card.incoming {
    border-left: 4px solid var(--primary);
}

.request-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.request-actions {
    display: flex;
    gap: 8px;
}

.request-actions button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.tab-btn {
    padding: 10px 20px;
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.3s;
}

.tab-btn.active {
    color: var(--primary);
    border-bottom: 3px solid var(--primary);
}

.participant-content {
    padding: 20px;
    background: var(--card-bg);
    border-radius: 8px;
    margin-top: 20px;
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 70px; /* Space for mobile nav */
        }

        /* Header with Profile Banner */
        .header {
            background: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .profile-banner {
    position: relative;
    height: 150px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    cursor: pointer;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

/* Add a class when banner has an image */
.profile-banner.has-image .banner-overlay {
    opacity: 0;
}

.profile-banner.has-image:hover .banner-overlay {
    opacity: 0.7;  /* Show on hover to allow changing */
}

.banner-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.5);
    color: white;
    opacity: 0.7;  /* Show by default when no image */
    transition: opacity 0.3s;
}
        .profile-info {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .user-details h2 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .user-role {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        .search-dropdown {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-dropdown-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}

.search-dropdown-item:hover {
    background: #f5f5f5;
}

.search-dropdown-item.selected {
    background: #e3f2fd;
}
        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: var(--text-light);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item .badge {
            position: absolute;
            top: 4px;
            right: calc(50% - 20px);
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 16px;
        }

        /* Content Sections */
        .content-section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .dashboard-header {
            margin-bottom: 20px;
        }

        .greeting {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .date-display {
            color: var(--text-light);
            font-size: 14px;
        }

        .shift-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .shift-card:active {
            transform: scale(0.98);
        }

        .shift-card-header {
            padding: 20px;
            position: relative;
        }

        .shift-time {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .shift-participant {
            font-size: 16px;
            opacity: 0.95;
            margin-bottom: 4px;
        }

        .shift-location {
            font-size: 14px;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shift-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .shift-expand-icon {
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .shift-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(255,255,255,0.95);
            color: var(--text-dark);
        }

        .shift-card.expanded .shift-details {
            max-height: 500px;
        }

        .shift-card.expanded .shift-expand-icon {
            transform: rotate(180deg);
        }

        .handover-section {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .handover-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .handover-note {
            background: var(--bg-light);
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .handover-author {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .quick-action-btn:active {
            transform: scale(0.95);
            background: var(--bg-light);
        }

        .quick-action-btn .icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        /* Requests Summary */
        .requests-summary {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .requests-summary h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-dark);
        }

        .request-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-type {
            font-size: 14px;
            font-weight: 500;
        }

        .request-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Timesheet View */
        .period-selector {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .period-display {
            text-align: center;
            flex: 1;
        }

        .period-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .period-dates {
            font-size: 16px;
            font-weight: 600;
        }

        .period-nav {
            padding: 8px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
        }


        /* Timesheet Summary */
        .timesheet-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .timesheet-summary h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        .hours-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .hour-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: var(--radius-md);
        }

        .hour-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .hour-value {
            font-size: 20px;
            font-weight: 600;
        }

        .total-section {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 16px;
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 600;
        }

        /* Shift List */
        .shift-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .shift-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .shift-list-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-list-item:last-child {
            border-bottom: none;
        }

        .shift-info {
            flex: 1;
        }

        .shift-date-time {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .shift-client {
            font-size: 14px;
            color: var(--text-light);
        }

        .shift-hours {
            text-align: right;
        }

        .btn {
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
}

.btn-secondary:hover {
    background: #d0d0d0;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 12px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-dark);
}

.btn-outline:hover {
    background: var(--bg-light);
}

        .shift-hours-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .shift-pay {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Schedule View */
        .calendar-header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .participant-filter {
            margin-bottom: 12px;
        }

        .participant-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: white;
        }

        .date-range-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-light);
            margin-top: 12px;
        }

        .schedule-grid {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .day-section {
            border-bottom: 1px solid var(--border-color);
        }

        .day-section:last-child {
            border-bottom: none;
        }

        .day-header {
            background: var(--bg-light);
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-date {
            font-size: 14px;
        }

        .fortnight-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--border-color);
    margin-top: 20px;
}

.schedule-day {
    background: white;
    min-height: 100px;
    padding: 8px;
}

.schedule-day.weekend {
    background: #f8f9fa;
}

.schedule-day.today {
    background: #e3f2fd;
}

.day-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border-color);
}

.day-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--text-light);
}

.day-date {
    font-weight: 600;
    font-size: 14px;
}

.shift-block {
    background: var(--primary-color);
    color: white;
    padding: 4px 6px;
    border-radius: 4px;
    margin-bottom: 4px;
    font-size: 11px;
}

.no-shift {
    color: var(--text-light);
    font-size: 11px;
    text-align: center;
    margin-top: 10px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}



        .day-shift-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .day-shifts {
            padding: 8px;
        }

        .schedule-shift {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-shift:last-child {
            margin-bottom: 0;
        }

        .schedule-shift-time {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .schedule-shift-staff {
            font-size: 13px;
            color: var(--text-light);
        }

        .schedule-shift-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .action-btn.secondary {
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .transfer-content {
    display: none;
}

.transfer-content.active {
    display: block;
}

        /* Transfers View */
        .transfer-tabs {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 16px;
            display: flex;
            box-shadow: var(--shadow-sm);
        }

        .transfer-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            font-weight: 500;
            transition: all 0.3s;
        }

        .transfer-tab:last-child {
            border-right: none;
        }

        .transfer-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .transfer-list {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .transfer-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .transfer-item:last-child {
            margin-bottom: 0;
        }

        .transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .transfer-date {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .transfer-time {
            font-size: 14px;
            color: var(--text-light);
        }

        .transfer-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .transfer-from {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .transfer-reason {
            font-size: 13px;
            color: var(--text-light);
            font-style: italic;
            padding: 8px;
            background: white;
            border-radius: var(--radius-sm);
            margin-top: 8px;
        }

        .transfer-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .transfer-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .transfer-btn.accept {
            background: var(--success-color);
            color: white;
        }

        .transfer-btn.decline {
            background: white;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        /* Profile View */
        .profile-section {
            background: white;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .profile-section-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-btn {
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        .profile-content {
            padding: 16px;
        }

        .profile-field {
            margin-bottom: 16px;
        }

        .profile-field:last-child {
            margin-bottom: 0;
        }

        .field-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .field-value {
            font-size: 16px;
            color: var(--text-dark);
        }

        .field-value input,
        .field-value select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 16px;
        }

        /* Documents Section */
        .document-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .document-upload-area:hover {
            border-color: var(--primary-color);
            background: var(--bg-light);
        }

        .document-list {
            display: grid;
            gap: 12px;
        }

        .document-item {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 12px;
            color: var(--text-light);
        }

        .document-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Availability Pattern */
        .availability-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 16px;
        }

        .availability-day {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .availability-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .day-name {
            font-weight: 600;
        }

        .availability-toggle {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .availability-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        .availability-toggle input:checked + .toggle-slider {
            background: var(--success-color);
        }

        .availability-toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .availability-times {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .time-slot {
            padding: 8px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }



/* iOS specific fixes */
@supports (-webkit-touch-callout: none) {
    .modal {
        min-height: -webkit-fill-available !important;
    }
}

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 73, 144, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Image Upload for Notes */
        .image-upload-area {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        .add-image-btn {
            width: 60px;
            height: 60px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-light);
        }

        /* Notifications */
        .notification-list {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .notification-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.unread {
            background: #f0f8ff;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-icon.info {
            background: #cce5ff;
            color: #004085;
        }

        .notification-icon.success {
            background: #d4edda;
            color: #155724;
        }

        .notification-icon.warning {
            background: #fff3cd;
            color: #856404;
        }

        .notification-content {
            flex: 1;
        }

        .notification-message {
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            animation: slideUp 0.3s ease-out;
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* Desktop Responsiveness */
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }

            .mobile-nav {
                display: none;
            }

            .desktop-nav {
                display: flex;
                background: white;
                border-bottom: 1px solid var(--border-color);
                padding: 0 20px;
            }

            .desktop-nav .nav-item {
                padding: 16px 24px;
                border-bottom: 3px solid transparent;
                transition: all 0.3s;
            }

            .desktop-nav .nav-item.active {
                border-bottom-color: var(--primary-color);
            }

            .content-section {
                max-width: 1200px;
                margin: 0 auto;
                padding: 40px;
            }

            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }

            .hours-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .document-list {
                grid-template-columns: repeat(2, 1fr);
            }

            .availability-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 600; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .p-2 { padding: 16px; }
        .hidden { display: none; }

        .modal .form-control,
.modal select,
.modal input[type="date"],
.modal input[type="time"],
.modal input[type="text"],
.modal textarea {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box; /* This is key - includes padding/border in width */
}

/* Fix for select dropdowns specifically */
.modal select.form-control {
    width: 100%;
    min-width: 0; /* Prevents minimum width issues */
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Fix for date/time inputs that tend to be wider */
.modal input[type="date"],
.modal input[type="time"] {
    width: 100%;
    min-width: 0;
    padding-right: 2px; /* Reduce padding if needed */
}

/* Ensure form groups don't overflow */
.modal .form-group {
    width: 100%;
    max-width: 100%;
    overflow: hidden; /* Hide any overflow */
}

/* FIX FOR MODAL SCROLLING - THIS IS THE KEY ADDITION */
.modal-dialog {
    max-height: 90vh; /* Prevent dialog from being taller than viewport */
    display: flex;
    flex-direction: column;
    margin: 1.75rem auto; /* Center with some top margin */
}

.modal-content {
    position: relative !important;
    background: #ffffff !important;
    border-radius: 8px !important;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important;
    width: 95% !important;
    max-width: 600px !important;
    max-height: 90vh !important;
    max-height: 90dvh !important;
    margin: 20px auto !important;
    z-index: 2147483646 !important;
    overflow: visible !important; /* CRITICAL - NOT hidden */
    display: flex !important;
    flex-direction: column !important;
    /* Remove any transform on mobile */
}

.modal-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 1.5rem !important;
    border-bottom: 1px solid #e5e5e5 !important;
    background: #f8f9fa !important;
    border-radius: 8px 8px 0 0 !important;
    flex-shrink: 0 !important;
}

.modal-body {
    padding: 1.5rem !important;
    max-height: 60vh !important;
    max-height: 60dvh !important;
    overflow-y: auto !important; /* Scrolling ONLY in body */
    -webkit-overflow-scrolling: touch !important;
    flex: 1 1 auto !important;
}

.modal-footer {
    display: flex !important;
    justify-content: flex-end !important;
    gap: 10px !important;
    padding: 1.5rem !important;
    border-top: 1px solid #e5e5e5 !important;
    background: #f8f9fa !important;
    border-radius: 0 0 8px 8px !important;
    flex-shrink: 0 !important;
}

/* Ensure scrollbar is always visible when needed */
.modal-body::-webkit-scrollbar {
    width: 8px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* For very tall modals on mobile */
@media (max-width: 576px) {
    .modal-dialog {
        margin: 0.5rem;
        max-height: calc(100vh - 1rem);
    }
    
    .modal-body {
        max-height: calc(100vh - 160px); /* Smaller header/footer on mobile */
    }
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.form-legend {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--text-dark);
    border: none;
    padding: 0;
}

.form-help {
    display: block;
    margin-top: 4px;
    font-size: 12px;
    color: var(--text-light);
}

.error-message {
    display: none;
    margin-top: 4px;
    font-size: 12px;
    color: var(--danger-color);
    font-weight: 500;
}

.error-message.show {
    display: block;
}

.form-control:invalid {
    border-color: var(--danger-color);
}

.form-control:invalid + .error-message {
    display: block;
}

/* Navigation improvements */
.nav-item {
    border: none;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s;
}

.nav-item:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

.nav-item[aria-selected="true"] {
    color: var(--primary-color);
}

/* Modal improvements */
.modal[aria-hidden="true"] {
    display: none;
}

.modal[aria-hidden="false"] {
    display: flex;
}

.modal-close:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* Header improvements */
.header {
    background: white;
    border-bottom: 1px solid var(--border-color);
    padding: 0;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.logo img {
    max-height: 40px;
    width: auto;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-name {
    font-weight: 500;
    color: var(--text-dark);
}

.user-role {
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
}

/* Image upload improvements */
.add-image-btn {
    width: 60px;
    height: 60px;
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 24px;
    color: var(--text-light);
}

.add-image-btn:hover,
.add-image-btn:focus {
    border-color: var(--primary-color);
    color: var(--primary-color);
    outline: none;
}

.image-upload-area {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 8px;
}

#imagePreviewContainer {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.image-preview {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius-md);
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
}

.image-preview:hover {
    border-color: var(--danger-color);
    opacity: 0.8;
}

.weekly-schedule {
    background: white;
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.day-section {
    border-bottom: 1px solid var(--border-color);
}

.day-section:last-child {
    border-bottom: none;
}

.day-section.today {
    background: #f0f8ff;
}

.day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--bg-light);
    border-bottom: 1px solid var(--border-color);
}

.day-name {
    font-weight: 600;
    font-size: 16px;
}

.shift-count {
    background: var(--primary-color);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.shift-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light);
    transition: background 0.2s;
}

.shift-item:hover {
    background: var(--bg-light);
}

.shift-item:last-child {
    border-bottom: none;
}

.no-shifts {
    padding: 20px;
    text-align: center;
    color: var(--text-light);
    font-style: italic;
}

.shift-history-item {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
}

.shift-date-header {
    font-weight: 600;
    margin-bottom: 8px;
}
    </style>

    
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Loading My Carers Portal</h2>
            <p id="loadingStatus">Quality Care From People Who Care</p>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loadingProgressBar"></div>
            </div>
        </div>
    </div>
    
     <!-- Header with Profile Banner -->
     <header class="header">
        <div class="profile-info">
            <div class="user-details">
                <h2 id="userName">Loading...</h2>
                <span class="user-role" id="userRole">Staff</span>
            </div>
            <button class="btn btn-sm btn-outline" data-action="logout">Logout</button>
        </div>
    </header>

    <!-- Desktop Navigation (hidden on mobile) -->
    <nav class="desktop-nav hidden">
        <button class="nav-item" data-section="dashboard" 
                aria-label="Navigate to dashboard" 
                role="tab" 
                aria-selected="true">
            <div class="icon"><i class="fa-solid fa-house" aria-hidden="true"></i></div>
            <div>Home</div>
        </button>
        <div class="nav-item" data-section="timesheet">
            <span>Timesheet</span>
        </div>
        <div class="nav-item" data-section="schedule">
            <span>Schedule</span>
        </div>
        <div class="nav-item" data-section="transfers">
            <span>Transfers</span>
        </div>
        <div class="nav-item" data-section="profile">
            <span>Profile</span>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboard" class="content-section active">
        <div class="dashboard-header">
            <div class="greeting" id="greeting">Good morning!</div>
            <div class="date-display" id="currentDate">Monday, 5 January 2025</div>
        </div>

        <!-- Current/Upcoming Shift -->
        <div id="currentShift">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action-btn" data-action="showAddShiftModal">
                <span class="icon"><i class="fa-solid fa-plus"></i></span>
                <span>Add Shift</span>
            </div>
            <div class="quick-action-btn" data-action="showTransferModal">
                <span class="icon"><i class="fa-solid fa-arrow-right-arrow-left"></i></span>
                <span>Transfer Shift</span>
            </div>
            <div class="quick-action-btn" data-action="showAdjustmentModal">
                <span class="icon"><i class="fa-solid fa-clock"></i></span>
                <span>Adjust Time</span>
            </div>
            <div class="quick-action-btn" data-action="showLeaveModal">
                <span class="icon"><i class="fa-solid fa-umbrella-beach"></i></span>
                <span>Request Leave</span>
            </div>
            <div class="quick-action-btn" data-action="showSchoolHolidayModal">
                <span class="icon"><i class="fa-solid fa-graduation-cap"></i></span>
                <span>School Holidays</span>
            </div>
        </div>
    
        <!-- Pending Requests Summary -->
        <div class="requests-summary">
            <h3>Pending Requests</h3>
            <div id="pendingRequestsList">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Timesheet Section -->
    <div id="timesheet" class="content-section">
        <div class="period-selector">
            <button class="period-nav" id="prevPeriodBtn">◀</button>
            <div class="period-display">
                <div class="period-label">Pay Period</div>
                <div class="period-dates" id="periodDates">Loading...</div>
            </div>
            <button class="period-nav" id="nextPeriodBtn">▶</button>
        </div>
        <!-- Hours Summary -->
        <div class="timesheet-summary">
            <h3>Hours Breakdown</h3>
            <div class="hours-grid" id="hoursGrid">
                <!-- Will be populated dynamically -->
            </div>
            <div class="total-section">
                <span>Total Hours</span>
                <span id="totalHours">0.0h</span>
            </div>
        </div>

        <!-- Shift List with Toggle -->
        <div class="shift-list">
            <div class="shift-list-header">
                <h3>Shifts</h3>
                <div class="view-toggle">
                    <button class="toggle-btn active" data-timesheet-view="date">By Date</button>
                    <button class="toggle-btn" data-timesheet-view="participant">By Participant</button>
                </div>
            </div>
            <div id="timesheetShifts">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Schedule Section -->
    <div id="schedule" class="content-section">
        <div class="calendar-header">
            <div class="participant-filter">
                <label class="field-label">Filter by Participant</label>
                <select class="participant-select" id="participantFilter" onchange="filterSchedule()">
                    <option value="">All My Participants</option>
                </select>
            </div>
            <div class="date-range-info">
                <span>📅</span>
                <span>Showing 2 weeks before and after today</span>
            </div>
        </div>

        <div class="schedule-grid" id="scheduleGrid">
            <!-- Will be populated dynamically -->
        </div>
    </div>

    <!-- My Requests Section -->
<div id="requests" class="content-section">
    <h2>My Requests & Transfers</h2>
    
    <div class="transfer-tabs">
        <div class="transfer-tab active" data-transfer-tab="incoming">
            Incoming Requests
            <span class="badge" id="incomingCount">0</span>
        </div>
        <div class="transfer-tab" data-transfer-tab="my-requests">
            My Requests
        </div>
        <div class="transfer-tab" data-transfer-tab="available">
            Available Shifts
        </div>
    </div>

    <!-- Incoming Transfers Content -->
    <div id="incomingRequests" class="transfer-content active">
        <div class="transfer-list" id="incomingList">
            <!-- Incoming transfers from other staff -->
        </div>
    </div>

    <!-- My Requests Content -->
    <div id="myRequestsContent" class="transfer-content">
        <div class="transfer-list" id="myRequestsList">
            <!-- All user's outgoing requests -->
        </div>
    </div>

    <!-- Available Shifts Content -->
    <div id="availableContent" class="transfer-content">
        <div class="transfer-list" id="availableList">
            <!-- Available shifts to pick up -->
        </div>
    </div>
</div>

      <!-- Profile Section -->
<div id="profile" class="content-section">
    <div class="profile-banner" id="profileBanner" onclick="document.getElementById('bannerUpload').click()">
        <div class="banner-overlay">
            <i class="fas fa-camera"></i>
            <span>Tap to upload photo</span>
        </div>
        <input type="file" 
               id="bannerUpload" 
               accept="image/*" 
               style="display: none;">
    </div>

        <!-- Personal Information -->
        <div class="profile-section">
            <div class="profile-section-header">
                Personal Information
                <button class="edit-btn" data-action="editPersonalInfo">Edit</button>
            </div>
            <div class="profile-content" id="personalInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Contact Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Contact Details
                <button class="edit-btn" data-action="editContactInfo">Edit</button>
            </div>
            <div class="profile-content" id="contactInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Banking Details -->
        <div class="profile-section">
            <div class="profile-section-header">
                Banking & Super
                <button class="edit-btn" onclick="editBankingInfo()">Edit</button>
            </div>
            <div class="profile-content" id="bankingInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Documents -->
        <div class="profile-section">
            <h3>Documents</h3>
            <button class="edit-btn" onclick="openUploadDocumentModal()">
                <i class="fa-solid fa-file-arrow-up"></i>
                Upload Document
            </button>
            <div id="documentsList" class="documents-list">
                <!-- Documents list here -->
            </div>
        </div>
        </div>
    </div>
        
<!-- Mobile Navigation -->
<nav class="mobile-nav" role="tablist" aria-label="Main navigation">
    <button class="nav-item active" 
            data-section="dashboard" 
            aria-label="Navigate to dashboard" 
            role="tab" 
            aria-selected="true"
            id="nav-dashboard">
        <div class="icon"><i class="fa-solid fa-house" aria-hidden="true"></i></div>
        <div>Home</div>
        <span class="badge hidden" id="homeBadge" aria-label="pending items">1</span>
    </button>
    
    <button class="nav-item" 
            data-section="timesheet" 
            aria-label="Navigate to Schedule" 
            role="tab" 
            aria-selected="false"
            id="nav-timesheet">
        <div class="icon"><i class="fa-solid fa-calendar-days" aria-hidden="true"></i></div>
        <div>Schedule</div>
    </button>
    
    <button class="nav-item" 
            data-section="participants" 
            aria-label="Navigate to Participants" 
            role="tab" 
            aria-selected="false"
            id="nav-participants">
        <div class="icon"><i class="fa-solid fa-users" aria-hidden="true"></i></div>
        <div>Participants</div>
    </button>
    
    <button class="nav-item" 
    data-section="requests" 
    aria-label="Navigate to requests" 
    role="tab" 
    aria-selected="false"
    id="nav-requests">
<div class="icon"><i class="fa-solid fa-inbox"></i></div>
<div>My Requests</div>
<span class="badge hidden" id="requestsBadge">0</span>
</button>


<!-- Continue with profile button -->
<button class="nav-item" 
data-section="profile" 
aria-label="Navigate to profile" 
role="tab" 
aria-selected="false"
id="nav-profile">
<div class="icon"><i class="fa-solid fa-user" aria-hidden="true"></i></div>
<div>Profile</div>
</button>
</nav>

<!-- Updated Participants Section with Menu -->
<div id="participants" class="content-section" style="display: none;">
    <!-- Participant Selector -->
    <div class="participant-selector">
        <label class="field-label">Select Participant</label>
        <select class="participant-select" id="participantSelect" onchange="loadParticipantData()">
            <option value="">Select a participant...</option>
        </select>
    </div>
    
    <!-- Navigation Buttons Grid -->
    <div class="participant-menu" id="participantMenu" style="display: none;">
        <button class="btn-nav" data-participant-view="roster">
            <i class="fa-solid fa-calendar-week"></i>
            <span>View Roster</span>
        </button>
        <button class="btn-nav" data-participant-view="profile">
            <i class="fa-solid fa-user"></i>
            <span>Profile</span>
        </button>
        <button class="btn-nav" data-participant-view="schedule">
            <i class="fa-solid fa-calendar-plus"></i>
            <span>Schedule</span>
        </button>
        <button class="btn-nav" data-participant-view="notes">
            <i class="fa-solid fa-clipboard"></i>
            <span>Shift Notes</span>
        </button>       
        <button class="btn-nav" data-participant-view="transport">
            <i class="fa-solid fa-car"></i>
            <span>Transport Claim</span>
        </button>
    </div>
</div>

<!-- Slide-over Panel for Participant Views -->
<div id="participantPanel" class="slide-panel">
    <div class="panel-header">
        <button class="back-btn" onclick="closeParticipantPanel()">
            <i class="fa-solid fa-arrow-left"></i> Back
        </button>
        <h2 id="panelTitle">Participant View</h2>
    </div>
    
    <div class="panel-content">
        <!-- Roster View -->
        <div id="rosterView" class="panel-view" style="display: none;">
            <div class="roster-period-selector">
                <button class="period-nav" onclick="changeRosterPeriod(-1)">◀</button>
                <div class="period-display">
                    <div class="period-label">Pay Period</div>
                    <div id="rosterPeriod">Loading...</div>
                </div>
                <button class="period-nav" onclick="changeRosterPeriod(1)">▶</button>
            </div>
            <div id="rosterGrid">
                <!-- Roster content will be populated here -->
            </div>
        </div>
        
        <!-- Profile View -->
        <div id="profileView" class="panel-view" style="display: none;">
            <div id="profileContent">
                <!-- Profile content -->
            </div>
        </div>
        
        <!-- Schedule View -->
        <div id="scheduleView" class="panel-view" style="display: none;">
            <p class="info-text">Family members can request schedule changes here (coming soon)</p>
        </div>
        
        <!-- Notes View - FIXED -->
        <div id="notesView" class="panel-view" style="display: none;">
            <!-- This will be populated by renderNotesView() -->
            <div class="comments-container" id="notesTimeline">
                <!-- Notes will be loaded here -->
            </div>
        </div>

        <div id="transportView" class="panel-view" style="display: none;">
            <div class="transport-claim-wrapper">
                <!-- Step Header -->
                <div class="transport-steps">
                    <div class="transport-steps-header">
                        <h3>Transport Claim</h3>
                        <div class="step-indicators">
                            <span class="step-dot active" id="step1Dot"></span>
                            <span class="step-dot" id="step2Dot"></span>
                            <span class="step-dot" id="step3Dot"></span>
                        </div>
                    </div>
                    <div id="stepTitle" style="font-size: 0.9rem; opacity: 0.9;">
                        Step 1: Select or Create Route
                    </div>
                </div>
                
                <!-- Content Area -->
                <div class="transport-content" id="transportContent">
                    <!-- Step 1: Route Selection -->
                    <div id="step1Content" class="transport-section active">
                        <div class="quick-routes-grid" id="quickRoutesGrid">
                            <!-- Quick routes will be loaded here -->
                        </div>
                        
                        <div class="divider-text">OR</div>
                        
                        <div class="new-route-form">
                            <h4 style="margin-top: 0; margin-bottom: 20px; color: #333;">Create New Route</h4>
                            
                            <div class="form-group">
                                <label>Pickup Location</label>
                                <div class="address-input-group">
                                    <input type="text" 
                                           id="routeOrigin" 
                                           class="address-input" 
                                           placeholder="Enter pickup address...">
                                    <button class="btn-home" onclick="useClientHome()">
                                        <i class="fas fa-home"></i>
                                        <span>Client Home</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Destination</label>
                                <input type="text" 
                                       id="routeDestination" 
                                       class="address-input" 
                                       placeholder="Enter destination address...">
                            </div>
                            
                            <button class="btn-transport btn-next" 
        onclick="nextTransportStep()" 
        style="width: 100%;">
    Continue <i class="fas fa-arrow-right"></i>
</button>

                        </div>
                    </div>
                    
                    <!-- Step 2: Route Options -->
<div id="step2Content" class="transport-section">
    <h4 style="margin-top: 0; color: #333;">Select Your Route</h4>
    
    <!-- Loading indicator -->
    <div id="routeLoadingIndicator" style="display: none; text-align: center; padding: 20px; color: #666;">
        <i class="fas fa-spinner fa-spin"></i> Calculating routes...
    </div>
    
    <div class="map-container">
        <div id="transportMap"></div>
        <div class="map-loading" id="mapLoading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading map...</p>
        </div>
    </div>
    
    <div class="route-options-list" id="routeOptionsContainer">
        <!-- Route options will be loaded here -->
    </div>
</div>
                    <!-- Step 3: Confirmation -->
                    <div id="step3Content" class="transport-section">
                        <div class="confirmation-form">
                            <h4 style="margin-top: 0; margin-bottom: 20px; color: #333;">Confirm Details</h4>
                            
                            <div class="form-group">
                                <label>Date of Travel</label>
                                <input type="date" 
                                       id="transportDate" 
                                       class="address-input" 
                                       required>
                            </div>
                            
                            <div class="form-group">
                                <label>Reason for Travel</label>
                                <input type="text" 
                                       id="transportReason" 
                                       class="address-input" 
                                       placeholder="e.g., Client support visit" 
                                       required>
                            </div>
                            
                            <div class="trip-summary" id="tripSummary">
                                <!-- Summary will be populated here -->
                            </div>
                            
                            <div class="save-route-option">
                                <input type="checkbox" id="saveRouteCheck">
                                <label for="saveRouteCheck">
                                    Save this route for quick access next time
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Footer -->
                <div class="transport-actions">
                    <button class="btn-transport btn-back" 
                            id="btnBack" 
                            onclick="previousTransportStep()" 
                            style="display: none;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    
                    <button class="btn-transport btn-submit" 
                            id="btnSubmit" 
                            onclick="submitTransportClaim()" 
                            style="display: none;">
                        <i class="fas fa-check"></i> Submit Claim
                    </button>
                </div>
            </div>
        </div>         
    </div>



<!-- Place this with your other content sections (after dashboard, timesheet, etc.) -->
<div id="requests" class="content-section" style="display: none;">
    <h2>My Requests & Submissions</h2>
    
    <!-- Tab Navigation -->
    <div class="requests-tabs">
        <button class="tab-btn active" data-request-tab="incoming">
            Incoming <span class="badge" id="incomingCount">0</span>
        </button>
        <button class="tab-btn" data-request-tab="shifts">My Shifts</button>
        <button class="tab-btn" data-request-tab="leave">Leave</button>
        <button class="tab-btn" data-request-tab="transfers">Transfers</button>
        <button class="tab-btn" data-request-tab="adjustments">Adjustments</button>
    </div>
    
    <!-- Content Container -->
    <div id="requestsContent" class="requests-content">
        <!-- Content loads here -->
    </div>
</div>
    <!-- MODALS SECTION -->
    

    <!-- Upload Document Modal -->
<div id="uploadDocumentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Document</h3>
            <button class="modal-close" onclick="closeModal('uploadDocumentModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="uploadDocumentForm">
                <div class="form-group">
                    <label class="required">Document Type</label>
                    <select id="documentType" class="form-control" required>
                        <option value="">Select type...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="required">Title</label>
                    <input type="text" id="documentTitle" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Expiry Date</label>
                    <input type="date" id="documentExpiry" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="documentNotes" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="required">Select File</label>
                    <input type="file" id="documentFile" class="form-control" 
                           accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn secondary" onclick="closeModal('uploadDocumentModal')">Cancel</button>
            <button class="modal-btn primary" onclick="uploadDocument()">Upload</button>
        </div>
    </div>
</div>

    <!-- Profile Photo Editor Modal -->
<div id="photoEditorModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">Adjust Profile Banner</h3>
            <button class="modal-close" onclick="closePhotoEditor()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="cropperContainer" style="max-height: 400px;">
                <img id="imageToCrop" style="max-width: 100%;">
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="rotateCropper(-90)" class="edit-btn" style="background: var(--text-secondary);">
                    <i class="fas fa-rotate-left"></i> Rotate Left
                </button>
                <button onclick="rotateCropper(90)" class="edit-btn" style="background: var(--text-secondary);">
                    <i class="fas fa-rotate-right"></i> Rotate Right
                </button>
                <button onclick="resetCropper()" class="edit-btn" style="background: var(--text-secondary);">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="edit-btn" style="background: var(--text-secondary);" onclick="closePhotoEditor()">Cancel</button>
            <button class="edit-btn" onclick="saveCroppedImage()">Save Banner</button>
        </div>
    </div>
</div>


    <!-- Add Shift Modal -->
    <div id="addShiftModal" class="modal" role="dialog">
        <div class="modal-content">
            <header class="modal-header">
                <h3 class="modal-title">Add New Shift</h3>
                <button class="modal-close" data-modal-close="addShiftModal" type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="addShiftForm" novalidate>
                    <div class="form-group">
                        <label for="shiftDate">Date *</label>
                        <input type="date" 
                               id="shiftDate" 
                               name="shiftDate" 
                               class="form-control" 
                               required>
                        <small class="form-text text-muted">You can only submit shifts for past dates up to tomorrow</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="shiftParticipant">Participant *</label>
                        <select id="shiftParticipant" name="shiftParticipant" class="form-control" required>
                            <option value="">Select participant</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="shiftDutyType">Duty Type *</label>
                        <select id="shiftDutyType" name="shiftDutyType" class="form-control" required onchange="toggleTimeFields()">
                            <option value="">Select duty type</option>
                        </select>
                    </div>
                    
                    <div id="timeFields">
                        <div class="form-group">
                            <label for="shiftStartTime">Start Time</label>
                            <select id="shiftStartTime" name="shiftStartTime" class="form-control">
                                <option value="">Select start time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="shiftEndTime">End Time</label>
                            <select id="shiftEndTime" name="shiftEndTime" class="form-control">
                                <option value="">Select end time</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="shiftNotes">Notes</label>
                        <textarea id="shiftNotes" name="shiftNotes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" data-modal-close="addShiftModal">Cancel</button>
                <button type="button" class="modal-btn primary" onclick="submitShift()">Submit for Approval</button>
            </footer>
        </div>
    </div>

<!-- Transport Claim Modal -->
<div id="transportModal" class="modal" role="dialog">
    <div class="modal-content">
        <header class="modal-header">
            <h3 class="modal-title">Transport/Parking Claim</h3>
            <button class="modal-close" data-modal-close="transportModal" type="button">&times;</button>
        </header>
        
        <div class="modal-body">
            <form id="transportForm" novalidate>
                <div class="form-group">
                    <label for="transportDate">Date *</label>
                    <input type="date" id="transportDate" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="transportParticipant">Related to Participant (Optional)</label>
                    <select id="transportParticipant" class="form-control">
                        <option value="">Not participant specific</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transportKilometres">Kilometres Travelled</label>
                    <input type="number" id="transportKilometres" class="form-control" 
                           min="0" step="0.1" placeholder="0.0">
                </div>
                
                <div class="form-group">
                    <label for="transportParkingCost">Parking Cost ($)</label>
                    <input type="number" id="transportParkingCost" class="form-control" 
                           min="0" step="0.01" placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label for="transportTollCost">Toll Cost ($)</label>
                    <input type="number" id="transportTollCost" class="form-control" 
                           min="0" step="0.01" placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label for="transportReason">Reason/Purpose *</label>
                    <textarea id="transportReason" class="form-control" required 
                              placeholder="e.g., Client appointment"></textarea>
                </div>
                <div class="form-group">
    <label>Evidence/Receipt (optional)</label>
    <input type="file" id="transportEvidence" 
           accept="image/*,.pdf" 
           onchange="previewTransportEvidence(this)">
    <small class="text-muted">Upload receipt or photo (max 5MB)</small>
    <div id="evidencePreview"></div>
</div>
            </form>
        </div>
        
        <footer class="modal-footer">
            <button type="button" class="modal-btn secondary" data-modal-close="transportModal">Cancel</button>
            <button type="button" class="modal-btn primary" data-action="submitTransportClaim">Submit Claim</button>
        </footer>
    </div>
</div>

    <!-- Transfer Shift Modal -->
<div id="transferShiftModal" class="modal" role="dialog" aria-labelledby="transferShiftTitle" aria-hidden="true">
    <div class="modal-content" role="document">
        <header class="modal-header">
            <h3 id="transferShiftTitle" class="modal-title">Transfer Shift</h3>
            <button class="modal-close" 
                    data-modal-close="transferShiftModal" 
                    aria-label="Close modal"
                    type="button">&times;</button>
        </header>
        
        <div class="modal-body">
            <form id="transferForm" novalidate>
                <fieldset>
                    <legend class="sr-only">Transfer Details</legend>
                    
                    <!-- MISSING: Shift selection dropdown -->
                    <div class="form-group">
                        <label for="transferShiftSelect" class="form-label">Select Shift to Transfer *</label>
                        <select class="form-control" 
                                id="transferShiftSelect" 
                                name="transferShiftSelect"
                                required
                                aria-describedby="transferShift-error">
                            <option value="">Select a shift</option>
                        </select>
                        <div id="transferShift-error" class="error-message" role="alert" aria-live="polite"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="transferToStaff" class="form-label">Transfer To *</label>
                        <select class="form-control" 
                                id="transferToStaff" 
                                name="transferToStaff"
                                required>
                            <option value="">Select a shift first</option>
                        </select>
                        <small class="form-help">Only staff assigned to this participant are shown</small>
                    </div>                    
                    
                    <!-- Add warning div for conflicts -->
                    <div id="transferConflictWarning" style="display: none; margin-top: 10px;"></div>
                    
                    <div class="form-group">
                        <label for="transferReason" class="form-label">Reason *</label>
                        <textarea class="form-control" 
                                  id="transferReason" 
                                  name="transferReason"
                                  required 
                                  placeholder="Please provide a reason for the transfer..."
                                  rows="3"
                                  aria-describedby="transferReason-error transferReason-help"></textarea>
                        <small id="transferReason-help" class="form-help">Explain why you need to transfer this shift</small>
                        <div id="transferReason-error" class="error-message" role="alert" aria-live="polite"></div>
                    </div>
                </fieldset>
            </form>
        </div>
        
        <footer class="modal-footer">
            <button type="button" class="modal-btn secondary" data-modal-close="transferShiftModal">
                Cancel
            </button>
            <button type="submit" class="modal-btn primary" data-action="submitTransfer" form="transferForm">
                Send Transfer Request
            </button>
        </footer>
    </div>
</div>

    <!-- Time Adjustment Modal -->
    <div id="adjustmentModal" class="modal" role="dialog" aria-labelledby="adjustmentTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="adjustmentTitle" class="modal-title">Request Time Adjustment</h3>
                <button class="modal-close" 
                        data-modal-close="adjustmentModal" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="adjustmentForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Time Adjustment Details</legend>
                        
                        <div class="form-group">
                            <label for="adjustmentShift" class="form-label">Select Shift *</label>
                            <select class="form-control" 
                                    id="adjustmentShift" 
                                    name="adjustmentShift"
                                    required 
                                    onchange="loadShiftTimes()"
                                    aria-describedby="adjustmentShift-error">
                                <option value="">Select a shift</option>
                            </select>
                            <div id="adjustmentShift-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset>
                            <legend class="form-legend">New Times</legend>
                            
                            <div class="form-group">
                                <label for="adjustmentStartTime" class="form-label">New Start Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="adjustmentStartTime" 
                                       name="adjustmentStartTime"
                                       aria-describedby="adjustmentStartTime-help">
                                <small id="adjustmentStartTime-help" class="form-help">Current time will be shown when shift is selected</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="adjustmentEndTime" class="form-label">New End Time</label>
                                <input type="time" 
                                       class="form-control" 
                                       id="adjustmentEndTime" 
                                       name="adjustmentEndTime"
                                       aria-describedby="adjustmentEndTime-help">
                                <small id="adjustmentEndTime-help" class="form-help">Current time will be shown when shift is selected</small>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="adjustmentReason" class="form-label">Reason for Adjustment *</label>
                            <textarea class="form-control" 
                                      id="adjustmentReason" 
                                      name="adjustmentReason"
                                      required 
                                      placeholder="Please explain the time adjustment..."
                                      rows="3"
                                      aria-describedby="adjustmentReason-error adjustmentReason-help"></textarea>
                            <small id="adjustmentReason-help" class="form-help">Explain why the times need to be adjusted</small>
                            <div id="adjustmentReason-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" data-modal-close="adjustmentModal">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" data-action="submitAdjustment" form="adjustmentForm">
                    Submit Request
                </button>
            </footer>
        </div>
    </div>

    <!-- School Holiday Modal -->
<div id="schoolHolidayModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Submit School Holiday Period</h3>
            <button class="modal-close" 
                        data-modal-close="leaveModal" 
                        aria-label="Close modal"
                        type="button">&times;</button>
        </div>
        <div class="modal-body">
            <form id="schoolHolidayForm">
                <div class="form-group">
                    <label class="required">Start Date</label>
                    <input type="date" 
                           id="schoolStartDate" 
                           class="form-control" 
                           required>
                </div>
                
                <div class="form-group">
                    <label class="required">End Date</label>
                    <input type="date" 
                           id="schoolEndDate" 
                           class="form-control" 
                           required>
                </div>
                
                <div class="info-box">
                    <i class="fa-solid fa-info-circle"></i>
                    Submit your school holiday periods for roster planning and limit management
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="modal-btn secondary" onclick="closeModal('schoolHolidayModal')">
                Cancel
            </button>
            <button type="button" class="modal-btn primary" onclick="submitSchoolHoliday()">
                Submit
            </button>
        </div>
    </div>
</div>

    <!-- Leave Request Modal -->
    <div id="leaveModal" class="modal" role="dialog" aria-labelledby="leaveTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="leaveTitle" class="modal-title">Request Leave</h3>
                <button class="modal-close" 
                        data-modal-close="leaveModal" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="leaveForm" novalidate>
                    <fieldset>
                        <legend class="sr-only">Leave Request Details</legend>
                        
                        <div class="form-group">
                            <label for="leaveType" class="form-label">Leave Type *</label>
                            <select class="form-control" 
                                    id="leaveType" 
                                    name="leaveType"
                                    required 
                                    aria-describedby="leaveType-error">
                                <option value="">Select type</option>
                                <option value="annual">Annual Leave</option>
                                <option value="sick">Sick Leave</option>
                                <option value="personal">Personal Leave</option>
                                <option value="unpaid">Unpaid Leave</option>
                            </select>
                            <div id="leaveType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset>
                            <legend class="form-legend">Leave Dates</legend>
                            
                            <div class="form-group">
                                <label for="leaveStartDate" class="form-label">Start Date *</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="leaveStartDate" 
                                       name="leaveStartDate"
                                       required 
                                       aria-describedby="leaveStartDate-error">
                                <div id="leaveStartDate-error" class="error-message" role="alert" aria-live="polite"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="leaveEndDate" class="form-label">End Date *</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="leaveEndDate" 
                                       name="leaveEndDate"
                                       required 
                                       aria-describedby="leaveEndDate-error">
                                <div id="leaveEndDate-error" class="error-message" role="alert" aria-live="polite"></div>
                            </div>
                        </fieldset>
                        
                        <div class="form-group">
                            <label for="leaveReason" class="form-label">Reason</label>
                            <textarea class="form-control" 
                                      id="leaveReason" 
                                      name="leaveReason"
                                      placeholder="Optional: Provide additional details..."
                                      rows="3"
                                      aria-describedby="leaveReason-help"></textarea>
                            <small id="leaveReason-help" class="form-help">Additional details about your leave request</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" data-modal-close="leaveModal">
                    Cancel
                </button>
                <button type="button" class="modal-btn primary" data-action="submitLeave">
                    Submit Request
                </button>
            </footer>
        </div>
    </div>

    <!-- Document Upload Modal -->
    <div id="documentUploadModal" class="modal" role="dialog" aria-labelledby="documentUploadTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="documentUploadTitle" class="modal-title">Upload Document</h3>
                <button class="modal-close" 
                        data-modal-close="documentUploadModal" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="documentUploadForm" enctype="multipart/form-data" novalidate>
                    <fieldset>
                        <legend class="sr-only">Document Information</legend>
                        
                        <div class="form-group">
                            <label for="documentType" class="form-label">Document Type *</label>
                            <select class="form-control" 
                                    id="documentType" 
                                    name="documentType"
                                    required 
                                    onchange="checkExpiryRequired()"
                                    aria-describedby="documentType-error">
                                <option value="">Select type</option>
                                <option value="id">Photo ID</option>
                                <option value="resume">Resume/CV</option>
                                <option value="visa">Visa/Work Permit</option>
                                <option value="firstaid">First Aid/CPR Certificate</option>
                                <option value="wwcc">Working with Children Check</option>
                                <option value="police">Police Check</option>
                                <option value="ndis">NDIS Worker Check</option>
                                <option value="other">Other</option>
                            </select>
                            <div id="documentType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentTitle" class="form-label">Document Title *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="documentTitle" 
                                   name="documentTitle"
                                   required 
                                   placeholder="e.g., Driver's License"
                                   aria-describedby="documentTitle-error">
                            <div id="documentTitle-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group" id="expiryGroup">
                            <label for="documentExpiry" class="form-label">Expiry Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="documentExpiry" 
                                   name="documentExpiry"
                                   aria-describedby="documentExpiry-help">
                            <small id="documentExpiry-help" class="form-help">Required for certain document types</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentFile" class="form-label">Select File *</label>
                            <input type="file" 
                                   class="form-control" 
                                   id="documentFile" 
                                   name="documentFile"
                                   required 
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   aria-describedby="documentFile-error documentFile-help">
                            <small id="documentFile-help" class="form-help">Max 10MB. PDF, JPG, PNG accepted.</small>
                            <div id="documentFile-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="documentNotes" class="form-label">Notes</label>
                            <textarea class="form-control" 
                                      id="documentNotes" 
                                      name="documentNotes"
                                      placeholder="Optional notes..."
                                      rows="3"
                                      aria-describedby="documentNotes-help"></textarea>
                            <small id="documentNotes-help" class="form-help">Additional information about the document</small>
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" data-modal-close="documentUploadModal">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" data-action="uploadDocument" form="documentUploadForm">
                    Upload
                </button>
            </footer>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="addNoteModal" class="modal" role="dialog" aria-labelledby="addNoteTitle" aria-hidden="true">
        <div class="modal-content" role="document">
            <header class="modal-header">
                <h3 id="addNoteTitle" class="modal-title">Add Shift Note</h3>
                <button class="modal-close" 
                        data-modal-close="addNoteModal" 
                        aria-label="Close modal"
                        type="button">&times;</button>
            </header>
            
            <div class="modal-body">
                <form id="noteForm" novalidate>
                    <input type="hidden" id="noteShiftId" name="noteShiftId">
                    
                    <fieldset>
                        <legend class="sr-only">Note Details</legend>
                        
                        <div class="form-group">
                            <label for="noteType" class="form-label">Note Type *</label>
                            <select class="form-control" 
                                    id="noteType" 
                                    name="noteType"
                                    required 
                                    aria-describedby="noteType-error noteType-help">
                                <option value="shift">Shift Note (Visible to Manager)</option>
                                <option value="handover">Handover Note (Staff Only)</option>
                                <option value="incident">Incident Report</option>
                            </select>
                            <small id="noteType-help" class="form-help">Choose the appropriate note type</small>
                            <div id="noteType-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="noteContent" class="form-label">Note *</label>
                            <textarea class="form-control" 
                                      id="noteContent" 
                                      name="noteContent"
                                      required 
                                      placeholder="Enter your note..."
                                      rows="4"
                                      aria-describedby="noteContent-error"></textarea>
                            <div id="noteContent-error" class="error-message" role="alert" aria-live="polite"></div>
                        </div>
                        
                        <fieldset class="form-group">
                            <legend class="form-label">Attach Images</legend>
                            <div class="image-upload-area" role="region" aria-label="Image upload area">
                                <button type="button" 
                                        class="add-image-btn" 
                                        data-trigger-click="noteImages"
                                        aria-label="Add images">
                                    <i class="fa-solid fa-plus" aria-hidden="true"></i>
                                </button>
                                <div id="imagePreviewContainer" 
                                     role="region" 
                                     aria-label="Image previews"
                                     aria-live="polite"></div>
                            </div>
                            <input type="file" 
                                   id="noteImages" 
                                   name="noteImages"
                                   multiple 
                                   accept="image/*" 
                                   style="display: none;" 
                                   onchange="previewImages()"
                                   aria-describedby="noteImages-help">
                            <small id="noteImages-help" class="form-help">Optional: Add up to 5 images</small>
                        </fieldset>
                    </fieldset>
                </form>
            </div>
            
            <footer class="modal-footer">
                <button type="button" class="modal-btn secondary" data-modal-close="addNoteModal">
                    Cancel
                </button>
                <button type="submit" class="modal-btn primary" data-action="submitNote" form="noteForm">
                    Add Note
                </button>
            </footer>
        </div>
    </div>

    
        

    <script>

      

        // Supabase Configuration
        const SUPABASE_URL = 'https://gqchhsayqxttewthcsah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxY2hoc2F5cXh0dGV3dGhjc2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTA0ODksImV4cCI6MjA3MjI2NjQ4OX0.iAGhrDZaHkpLwjJY07o-73l2OiePB2x1ZnnTEfUBd_M';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        //DAY OFFSETTER!
        const DATE_OFFSET_DAYS = 0; // Set to 0 to disable testing mode
        const PERIOD_LENGTH = 14; // 14-day pay periods
        const DB_ERRORS = {
    FOREIGN_KEY_VIOLATION: "23503",
    UNIQUE_VIOLATION: "23505",
    NOT_NULL_VIOLATION: "23502"
};

let googleMapsLoaded = false;
let directionsService;
let directionsRenderer;
let placesService;
let map = null;
let autocompleteOrigin;
let autocompleteDestination;


        let isValidAddressSelected = false;
        let currentUser = null;
        let currentStaff = null;
        let allShifts = [];
        let myShifts = [];
        let participants = [];
        let staff = [];
        let dutyTypes = [];
        let locations = [];
        let notifications = [];
        let documents = [];
        let selectedImages = [];
        let currentPeriodStart = null;
        let currentPeriodEnd = null;
        let timesheetView = 'date';
        let weeklyAvailability = {};
        let participantDefaultLocations = new Map();
        let careHomeLocations = new Set();
        let isSubmittingLeave = false;
        let id = null;
        let isSubmittingTransport = false;
        let staffClaimFilter = 'all';

window.shifts = window.shifts || [];
window.participants = window.participants || [];
window.locations = window.locations || [];
window.staff = window.staff || [];
window.dutyTypes = window.dutyTypes || [];
        window.AppState = {
    staff: {
        current: null,
        original: null,
        all: []
    },
    shifts: {
        my: [],
        all: []
    },
    ui: {
        currentSection: 'dashboard',
        timesheetView: 'date',
        periodOffset: 0
    },
    cache: {
        participants: [],
        dutyTypes: [],
        locations: [],
        transfers: {
            incoming: [],
            outgoing: []
        }
    }
};

// Loading manager
const LoadingManager = {
    progress: 0,
    steps: [
        'Authenticating user...',
        'Loading user data...',
        'Loading reference data...',
        'Loading shifts...',
    ],
    currentStep: 0,
    
    updateStatus(message) {
        const statusElement = document.getElementById('loadingStatus');
        if (statusElement) {
            statusElement.textContent = message;
        }
    },
    
    updateProgress(percent) {
        const progressBar = document.getElementById('loadingProgressBar');
        if (progressBar) {
            progressBar.style.width = `${percent}%`;
        }
    },
    
    nextStep() {
        if (this.currentStep < this.steps.length) {
            this.updateStatus(this.steps[this.currentStep]);
            this.currentStep++;
            const percent = (this.currentStep / this.steps.length) * 100;
            this.updateProgress(percent);
        }
    },
    
    complete() {
        this.updateStatus('Welcome');
        this.updateProgress(100);
        
        setTimeout(() => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    document.body.classList.remove('loading');
                }, 300);
            }
        }, 500);
    },
    
    error(message) {
        this.updateStatus(`Error: ${message}`);
        const spinner = document.querySelector('.loading-spinner');
        if (spinner) {
            spinner.style.borderTopColor = '#dc3545';
        }
    }
};



// Create currentStaff as a property that syncs with AppState
Object.defineProperty(window, 'currentStaff', {
    get() { 
        return AppState.staff.current; 
    },
    set(value) { 
        AppState.staff.current = value;
        console.log('Staff updated:', value?.first_name, value?.last_name);
    },
    configurable: true
});

// Make sure offset persists correctly
function changePeriod(direction) {
    if (typeof direction !== 'number') {
        console.error('changePeriod: direction must be a number');
        return;
    }
    
    const currentOffset = window.periodOffset || 0;
    const newOffset = currentOffset + direction;
    
    window.periodOffset = newOffset;
    if (AppState.payPeriod) {
        AppState.payPeriod.offset = newOffset;
    }
    
    console.log(`Period navigation: ${currentOffset} → ${newOffset}`);
    
    setCurrentPayPeriod();
    
    // Reload timesheet
    if (typeof loadTimesheet === 'function') {
        loadTimesheet().then(() => {
            console.log('Timesheet reloaded for new period');
        });
    }
    
    // ALSO reload schedule if it's currently visible
    const scheduleSection = document.getElementById('schedule');
    if (scheduleSection && scheduleSection.style.display !== 'none') {
        if (typeof loadSchedule === 'function') {
            loadSchedule().then(() => {
                console.log('Schedule reloaded for new period');
            });
        }
    }
}

// Make sure setCurrentPayPeriod uses the stored offset
function setCurrentPayPeriod() {
    // Use the stored offset, don't reset it
    const offset = window.periodOffset || 0;
    console.log('Setting period with offset:', offset);
    
    const testDate = getTestDate();
    const period = calculatePayPeriod(testDate, offset);
    
    window.currentPeriodStart = period.start;
    window.currentPeriodEnd = period.end;
    
    // Preserve the offset
    window.periodOffset = offset;
    
    if (window.AppState) {
        AppState.payPeriod = {
            start: period.start,
            end: period.end,
            offset: offset // Keep the offset
        };
    }
    
    console.log('Period set:', {
        start: period.start.toLocaleDateString('en-AU'),
        end: period.end.toLocaleDateString('en-AU'),
        offset: offset
    });
    
    updatePeriodDisplay();
}

// Make sure getTestDate is using DATE_OFFSET_DAYS
function getTestDate() {
    const now = new Date();
    if (typeof DATE_OFFSET_DAYS !== 'undefined' && DATE_OFFSET_DAYS !== 0) {
        now.setDate(now.getDate() + DATE_OFFSET_DAYS);
        console.log('Test mode: Using date', now.toLocaleDateString('en-AU'));
    }
    return now;
}

const ModalManager = {
    // Modal configurations
    modals: {
        addShift: {
            id: 'addShiftModal',
            onOpen: () => populateShiftModalDropdowns(),
            onClose: () => document.getElementById('addShiftForm')?.reset()
        },
        transfer: {
            id: 'transferShiftModal',
            onOpen: () => {
                loadTransferableShifts();
            },
            onClose: () => {
                document.getElementById('transferForm')?.reset();
                const warning = document.getElementById('transferConflictWarning');
                if (warning) warning.style.display = 'none';
            }
        },
        adjustment: {
            id: 'adjustmentModal',
            onOpen: () => loadAdjustmentShifts(),
            onClose: () => document.getElementById('adjustmentForm')?.reset()
        },
        leave: {
            id: 'leaveModal',
            onOpen: () => loadLeaveRequestModal(),
            onClose: () => {
                document.getElementById('leaveForm')?.reset();
                isSubmittingLeave = false;
            }
        },
        transport: {
            id: 'transportModal',
            onOpen: () => loadTransportModal(),
            onClose: () => document.getElementById('transportForm')?.reset()
        }
    },
    
    // Current open modal
    currentModal: null,
    
    // Open modal by name
    show(modalName, data = null) {
        const config = this.modals[modalName];
        if (!config) {
            console.error(`Modal '${modalName}' not found`);
            return;
        }
        
        // Close any open modal first
        if (this.currentModal) {
            this.close();
        }
        
        const modalElement = document.getElementById(config.id);
        if (!modalElement) {
            console.error(`Modal element '${config.id}' not found`);
            return;
        }
        
        // Store current modal
        this.currentModal = {
            name: modalName,
            element: modalElement,
            config: config
        };
        
        // Show modal
        modalElement.classList.add('active');
        modalElement.style.display = 'flex';
        
        // Run onOpen callback if exists
        if (config.onOpen) {
            config.onOpen(data);
        }
        
        // Add escape key listener
        this.escapeHandler = (e) => {
            if (e.key === 'Escape') {
                this.close();
            }
        };
        document.addEventListener('keydown', this.escapeHandler);
    },
    
    // Close current modal
    close() {
        if (!this.currentModal) return;
        
        const { element, config } = this.currentModal;
        
        // Hide modal
        element.classList.remove('active');
        element.style.display = 'none';
        
        // Run onClose callback if exists
        if (config.onClose) {
            config.onClose();
        }
        
        // Remove escape handler
        if (this.escapeHandler) {
            document.removeEventListener('keydown', this.escapeHandler);
        }
        
        // Clear current modal
        this.currentModal = null;
    },
    
    // Check if a modal is open
    isOpen(modalName = null) {
        if (!modalName) {
            return this.currentModal !== null;
        }
        return this.currentModal?.name === modalName;
    },
    
    // Get current modal data
    getCurrent() {
        return this.currentModal;
    }
};

// ==========================================
// ENHANCED: Initialize App with Staff Check
// ==========================================
const originalInitializeApp = window.initializeApp;
// Updated initialization with loading states
window.initializeApp = async function() {
    try {
        // Add loading class to body
        document.body.classList.add('loading');
        
        console.log('Enhanced initialization starting...');
        LoadingManager.nextStep(); // Authenticating
        
         console.log('Loading public holidays...');
        await loadPublicHolidays();
        // Ensure staff is loaded first
        await ensureStaffLoaded();
        
        if (!AppState.staff.current) {
            LoadingManager.error('Failed to load staff data');
            console.error('Failed to load staff during initialization');
            showToast('Failed to load staff data. Please refresh the page.', 'error');
            return;
        }
        
        LoadingManager.nextStep(); // Loading staff data
        
        // Call original initialization if exists
        if (typeof originalInitializeApp === 'function') {
            await originalInitializeApp();
        }
        
        LoadingManager.nextStep(); // Loading reference data
        
        // Load reference data if not already loaded
        if (typeof loadReferenceData === 'function') {
            await loadReferenceData();
        }
        
        LoadingManager.nextStep(); // Loading shifts
        
        // Check visibility buttons
        await checkLeaveButtonVisibility();
        await checkSchoolHolidayVisibility();
        
        // Load current shift card on dashboard
        if (typeof loadCurrentShift === 'function') {
            console.log('Loading current shift for dashboard...');
            await loadCurrentShift();
        }
        
        LoadingManager.nextStep(); // Setting up interface
        
        // Load other dashboard components
        if (typeof updateDashboard === 'function') {
            await updateDashboard();
        }
        
        // Initialize timesheet view and render
        initializeTimesheetView();
        
        // Set up period navigation
        setupPeriodNavigationButtons();
        
        // Initialize participant management
        if (typeof initializeParticipantManagement === 'function') {
            await initializeParticipantManagement();
        }
        
        // Ensure timesheet is rendered on init
        if (typeof renderTimesheetShifts === 'function') {
            setTimeout(() => {
                console.log('Initial timesheet render');
                renderTimesheetShifts();
            }, 100);
        }
        
        // Set up transport claim button
        const transportBtn = document.getElementById('submitTransportClaim');
        if (transportBtn) {
            transportBtn.replaceWith(transportBtn.cloneNode(true));
            document.getElementById('submitTransportClaim').addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                await submitTransportClaim();
            });
        }
        
        // Set up transport input formatters
        setupTransportInputFormatters();
        
        LoadingManager.nextStep(); // Finalizing
        
        console.log('Enhanced initialization complete');
        
        // Complete loading
        LoadingManager.complete();
        
    } catch (error) {
        console.error('Enhanced initialization error:', error);
        LoadingManager.error(error.message);
        showToast('Initialization failed: ' + error.message, 'error');
        
        // Still hide overlay after error so user can refresh
        setTimeout(() => {
            LoadingManager.complete();
        }, 3000);
    }
}

// Start initialization when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Show loading immediately
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'flex';
    }
    document.body.classList.add('loading');
    
    // Start initialization
    initializeApp();
});

// Add this new function to handle timesheet initialization
// SINGLE function to handle timesheet view - replaces all three versions
function initializeTimesheetView() {
    console.log('Initializing timesheet view...');
    
    // Set default view if not already set
    if (!AppState.ui.timesheetView) {
        AppState.ui.timesheetView = 'date';
    }
    
    // Set up toggle button event listeners (only once!)
    const toggleButtons = document.querySelectorAll('[data-timesheet-view]');
    
    toggleButtons.forEach(button => {
        // Set initial active state
        if (button.dataset.timesheetView === AppState.ui.timesheetView) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
        
        // Add click listener - this will NOT duplicate because we only call initializeTimesheetView once
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active states
            toggleButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Update view state
            AppState.ui.timesheetView = this.dataset.timesheetView;
            
            // Re-render ONCE
            console.log(`Switching to ${this.dataset.timesheetView} view`);
            renderTimesheetShifts();
        });
    });
}

async function initializeApp() {
    try {        
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error || !session) {
            console.error('Authentication error:', error);
            window.location.href = 'index.html';
            return;
        }

        currentUser = session.user;

        
        // Try multiple methods to find staff record
        let staffData = null;
        
        // Method 1: Try by user_id (fastest - already linked)
        let result = await supabaseClient
            .from('staff')
            .select('*')
            .eq('user_id', currentUser.id)
            .maybeSingle();
        
        staffData = result.data;
        
        if (staffData) {
            console.log(' Staff found by user_id - already linked');
        }
        
        // Method 2: Try by email match (auto-link if needed)
        if (!staffData) {
            console.log('🔍 No staff found by user_id, searching by email...');
            result = await supabaseClient
                .from('staff')
                .select('*')
                .eq('email', currentUser.email)
                .maybeSingle();
            
            staffData = result.data;
            
            if (staffData) {
                console.log('📧 Staff found by email match');
                
                // AUTO-LINK: If found by email but no user_id, create the link
                if (!staffData.user_id) {
                    console.log('🔗 Creating link between staff and auth user...');
                    
                    const { data: updatedStaff, error: updateError } = await supabaseClient
                        .from('staff')
                        .update({ user_id: currentUser.id })
                        .eq('id', staffData.id)
                        .select()
                        .single();
                    
                    if (updateError) {
                        console.error('❌ Failed to link staff record:', updateError);
                        showToast('Warning: Could not link your account. Contact admin.', 'warning');
                    } else {
                        staffData = updatedStaff;
                        console.log(' Staff record auto-linked successfully!');
                        console.log('   Staff ID:', staffData.id);
                        console.log('   Now linked to Auth ID:', staffData.user_id);
                        showToast('Account linked successfully', 'success');
                    }
                } else {
                    console.log(' Staff already has user_id, updating to current auth user');
                    // Update to current auth user (in case auth account was recreated)
                    const { data: updatedStaff } = await supabaseClient
                        .from('staff')
                        .update({ user_id: currentUser.id })
                        .eq('id', staffData.id)
                        .select()
                        .single();
                    
                    if (updatedStaff) {
                        staffData = updatedStaff;
                    }
                }
            }
        }
        
        // Method 3: For testing - allow manual override
        if (!staffData && window.location.hostname === 'localhost') {
            console.warn('⚠️ No staff found, checking for test override...');
            // You could load a default test staff here
        }
        
        // If still no staff record found
        if (!staffData) {
            console.error('❌ No staff record found for this user');
            console.error('   Auth Email:', currentUser.email);
            console.error('   Auth ID:', currentUser.id);
            
            showToast('No staff record found. Please contact administrator.', 'error');
            
            // Show helpful error with current user info
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: Arial;">
                    <h2>Staff Account Not Found</h2>
                    <p>No staff record found for: <strong>${currentUser.email}</strong></p>
                    <p style="color: #666; margin-top: 20px;">Please contact your administrator to:</p>
                    <ol style="text-align: left; display: inline-block; color: #666;">
                        <li>Create a staff record for your email address</li>
                        <li>Or update your staff record email to match your login email</li>
                    </ol>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 20px;">
                        <p style="font-size: 12px; color: #999; margin: 5px;">Debug Info:</p>
                        <p style="font-size: 11px; color: #999; margin: 5px;">Auth User ID: ${currentUser.id}</p>
                        <p style="font-size: 11px; color: #999; margin: 5px;">Email: ${currentUser.email}</p>
                    </div>
                    <button data-action="logout" style="margin-top: 20px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
                </div>
            `;
            return;
        }
        
        // Success - Set the staff data
        AppState.staff.current = staffData;
        currentStaff = staffData;
        window.currentStaff = staffData; // Ensure global access
        
        console.log(' Staff record loaded:', staffData.first_name, staffData.last_name);
        console.log('   Staff ID:', staffData.id);
        console.log('   Linked to Auth ID:', staffData.user_id);
        
        // Update UI with staff name
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = `${staffData.first_name} ${staffData.last_name}`;
        }
        
        
        // ============================================
        // LOAD ALL REFERENCE DATA (CRITICAL FOR ENRICHREQUESTDATA)
        // ============================================
        console.log('Loading reference data...');
        
        try {
            // Load all reference data in parallel for better performance
            const [participantsResult, staffResult, locationsResult, dutyTypesResult] = await Promise.all([
                supabaseClient.from('participants').select('*').eq('is_active', true).order('first_name'),
                supabaseClient.from('staff').select('*').eq('is_active', true).order('first_name'),
                supabaseClient.from('locations').select('*').eq('is_active', true).order('name'),  // Added is_active filter
                supabaseClient.from('duty_types').select('id, name').order('name')  // FIXED: Removed pay_multiplier
            ]);
            
            // Check for errors
            if (participantsResult.error) console.error('Error loading participants:', participantsResult.error);
            if (staffResult.error) console.error('Error loading staff:', staffResult.error);
            if (locationsResult.error) console.error('Error loading locations:', locationsResult.error);
            if (dutyTypesResult.error) console.error('Error loading duty types:', dutyTypesResult.error);
            
            // Populate global arrays (needed for enrichRequestData and other functions)
            participants = participantsResult.data || [];
            staff = staffResult.data || [];
            locations = locationsResult.data || [];
            dutyTypes = dutyTypesResult.data || [];
            
            // Ensure global window access for compatibility
            window.participants = participants;
            window.staff = staff;
            window.locations = locations;
            window.dutyTypes = dutyTypes;
            
            // Also update AppState cache if it exists
            if (window.AppState && window.AppState.cache) {
                AppState.cache.participants = participants;
                AppState.cache.dutyTypes = dutyTypes;
                AppState.cache.locations = locations;
            }
            
            console.log('Reference data loaded:', {
                participants: participants.length,
                staff: staff.length,
                locations: locations.length,
                dutyTypes: dutyTypes.length,
                careHomes: locations.filter(l => l.is_care_home).length
            });
            
            // NEW: Build participant-location mapping for care homes
            await initializeParticipantLocationMapping();
            
        } catch (refError) {
            console.error('Error loading reference data:', refError);
            showToast('Warning: Some reference data failed to load', 'warning');
        }
        
        
        function setupLeaveFormListener() {
    const leaveForm = document.getElementById('leaveForm');
    const submitBtn = document.getElementById('submitLeaveBtn');
    
    if (leaveForm) {
        // Remove any existing listeners first
        leaveForm.removeEventListener('submit', handleLeaveSubmit);
        // Add new listener
        leaveForm.addEventListener('submit', handleLeaveSubmit);
    }
    
    if (submitBtn) {
    // Remove any existing listeners
    submitBtn.replaceWith(submitBtn.cloneNode(true));
    const newSubmitBtn = document.querySelector('[data-action="submitLeaveWithProtection"]');
    if (newSubmitBtn) {
        newSubmitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!this.disabled) {
                submitLeaveWithProtection();
            }
        });
    }
}
}



        // ============================================
        // LOAD STAFF'S SHIFTS (FIXED: No pay_multiplier)
        // ============================================
        console.log('Loading staff shifts...');
        
        try {
            const { data: myShiftsData, error: shiftsError } = await supabaseClient
    .from('shifts')
    .select(`
        *,
        participants:participant_id(first_name, last_name, address),
        locations:location_id(id, name, address, is_care_home),
        duty_types:duty_type_id(name)
    `)
    .eq('staff_id', staffData.id)
    .is('deleted_at', null)
    .order('date', { ascending: false })
    .limit(100);

            if (shiftsError) {
                console.error('Error loading shifts:', shiftsError);
                myShifts = [];
                shifts = [];
            } else {
                myShifts = myShiftsData || [];
                shifts = myShiftsData || []; // Populate both arrays
                
                // Ensure global access
                window.myShifts = myShifts;
                window.shifts = shifts;
                
                // Update AppState if exists
                if (window.AppState && window.AppState.shifts) {
                    AppState.shifts.my = myShifts;
                    AppState.shifts.all = shifts;
                }
                
                console.log('Shifts loaded:', myShifts.length);
            }
            
        } catch (shiftsError) {
            console.error('Error loading shifts:', shiftsError);
            showToast('Warning: Could not load shifts', 'warning');
        }
        
        // ============================================
        // NEW: Load Participants with Care Home Mapping
        // ============================================
        await loadParticipantsWithCareHomes();
        
        // ============================================
        // INITIALIZE UI COMPONENTS
        // ============================================
        
        // Set greeting
        if (typeof setGreeting === 'function') {
            setGreeting();
        }
        
        // Initialize pay period
        if (typeof setCurrentPayPeriod === 'function') {
            setCurrentPayPeriod();
        }
        
        // Show default section
        if (typeof showSection === 'function') {
            showSection('dashboard');
        } else {
            // Fallback: show dashboard
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection) {
                dashboardSection.style.display = 'block';
            }
        }
        
        // NEW: Setup participant select event listeners
        setupParticipantSelectListeners();
        
        initializeTimesheetView();

        // ============================================
        // LOAD ADDITIONAL FEATURES (NON-BLOCKING)
        // ============================================
        
        // Load these in background, don't wait
        setTimeout(async () => {
            try {
                // Load transfers
                if (typeof loadTransfers === 'function') {
                    console.log('Loading transfers...');
                    await loadTransfers();
                }
                
                // Load notifications
                if (typeof loadNotifications === 'function') {
                    console.log('Loading notifications...');
                    await loadNotifications();
                }
                
                // Load documents
                if (typeof loadDocuments === 'function') {
                    console.log('Loading documents...');
                    await loadDocuments();
                }
                
                // Load availability
                if (typeof loadAvailability === 'function') {
                    console.log('Loading availability...');
                    await loadAvailability();
                }
                
                // Update dashboard metrics
                if (typeof updateDashboard === 'function') {
                    updateDashboard();
                }
                
                // Render schedule
                if (typeof renderSchedule === 'function') {
                    renderSchedule();
                }
                
                // Check for incoming transfers count
                if (typeof updateTransferBadge === 'function') {
                    updateTransferBadge();
                }
                
            } catch (featureError) {
                console.error('Error loading additional features:', featureError);
                // Non-critical, don't show error to user
            }
        }, 100);
        
        // ============================================
        // SETUP EVENT LISTENERS
        // ============================================
        
        // Setup all event listeners if function exists
        if (typeof setupAllEventListeners === 'function') {
            setupAllEventListeners();
        }
        
        // Populate modal dropdowns
        if (typeof populateModalDropdowns === 'function') {
            populateModalDropdowns();
        }
        
        // ============================================
        // FINAL SUCCESS MESSAGE
        // ============================================
        
        console.log(' Application initialized successfully');
        console.log('   Current Staff:', currentStaff.first_name, currentStaff.last_name);
        console.log('   Global Arrays:', {
            participants: participants.length,
            staff: staff.length,
            locations: locations.length,
            dutyTypes: dutyTypes.length,
            shifts: shifts.length,
            careHomes: locations.filter(l => l.is_care_home).map(l => l.name)
        });
        
        // Show success message (optional)
        // showToast('Welcome back, ' + staffData.first_name + '!', 'success');
        
    } catch (error) {
        console.error('❌ Fatal error in initializeApp:', error);
        showToast('Failed to initialize app: ' + error.message, 'error');
        
        // Show error UI
        const errorContainer = document.getElementById('errorContainer');
        if (errorContainer) {
            errorContainer.innerHTML = `
                <div style="padding: 20px; background: #f8d7da; color: #721c24; border-radius: 5px;">
                    <h3>Initialization Error</h3>
                    <p>${error.message}</p>
                    <button data-action="reloadPage" style="margin-top: 10px; padding: 5px 15px;">Retry</button>
                </div>
            `;
            errorContainer.style.display = 'block';
        }
    }
}

async function initializeParticipantLocationMapping() {
    // Build a map of participant addresses to identify care home residents
    const participantLocationMap = new Map();
    
    participants.forEach(p => {
        if (p.address) {
            const addressLower = p.address.toLowerCase();
            
            // Check if this participant is in Saunders Care Home
            if (addressLower.includes('saunders')) {
                const saundersLocation = locations.find(loc => 
                    loc.name.toLowerCase().includes('saunders') || 
                    (loc.address && loc.address.toLowerCase().includes('saunders'))
                );
                
                if (saundersLocation) {
                    participantLocationMap.set(p.id, saundersLocation.id);
                }
            } 
            // Check for other care homes
            else {
                const matchingLocation = locations.find(loc => {
                    if (!loc.address || !loc.is_care_home) return false;
                    const locAddressLower = loc.address.toLowerCase();
                    const participantAddressParts = addressLower.split(',')[0].trim();
                    return locAddressLower.includes(participantAddressParts);
                });
                
                if (matchingLocation) {
                    participantLocationMap.set(p.id, matchingLocation.id);
                }
            }
        }
    });
    
    // Store the map globally for use in shift creation
    window.participantDefaultLocations = participantLocationMap;
    
    console.log('Participant location mapping created:', {
        totalParticipants: participants.length,
        mappedToCareHomes: participantLocationMap.size
    });
}

async function loadParticipantsWithCareHomes() {
    // Populate participant dropdowns with care home indicators
    const selects = ['shiftParticipant', 'noteParticipant'];
    
    selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            select.innerHTML = '<option value="">Select Participant</option>';
            
            // Group participants by care home
            const careHomeParticipants = [];
            const homeParticipants = [];
            
            participants.forEach(p => {
                const locationId = window.participantDefaultLocations?.get(p.id);
                const location = locationId ? locations.find(l => l.id === locationId) : null;
                
                if (location && location.is_care_home) {
                    careHomeParticipants.push({
                        participant: p,
                        careHomeName: location.name
                    });
                } else {
                    homeParticipants.push(p);
                }
            });
            
            // Add care home participants with labels
            if (careHomeParticipants.length > 0) {
                select.innerHTML += '<optgroup label="Care Home Residents">';
                careHomeParticipants.forEach(item => {
                    select.innerHTML += `<option value="${item.participant.id}" data-location-id="${window.participantDefaultLocations.get(item.participant.id) || ''}">${item.participant.first_name} ${item.participant.last_name} (${item.careHomeName})</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
            
            // Add home participants
            if (homeParticipants.length > 0) {
                select.innerHTML += '<optgroup label="Home Clients">';
                homeParticipants.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
        }
    });
}

function setupParticipantSelectListeners() {
    // For shift creation modal
    const shiftParticipant = document.getElementById('shiftParticipant');
    if (shiftParticipant) {
        shiftParticipant.addEventListener('change', function() {
            onParticipantSelect(this.value, 'shiftLocation');
        });
    }
    
    // For note creation modal
    const noteParticipant = document.getElementById('noteParticipant');
    if (noteParticipant) {
        noteParticipant.addEventListener('change', function() {
            // Notes don't have location, but we could use this for context
            console.log('Participant selected for note');
        });
    }
}

function onParticipantSelect(participantId, locationSelectId) {
    const locationSelect = document.getElementById(locationSelectId || 'shiftLocation');
    if (!locationSelect || !participantId) return;
    
    // Check if we have a default location for this participant
    if (window.participantDefaultLocations && window.participantDefaultLocations.has(participantId)) {
        const defaultLocationId = window.participantDefaultLocations.get(participantId);
        locationSelect.value = defaultLocationId;
        console.log('Auto-selected care home location for participant');
        return;
    }
    
    // Otherwise, try to find "Client Home" as default
    // Use constants from LOCATION_IDS
const clientHomeLocation = locations?.find(l => 
    l.name.toLowerCase().includes('client home') || 
    l.id === LOCATION_IDS.CLIENT_HOME  // Use constant
);
    if (clientHomeLocation) {
        locationSelect.value = clientHomeLocation.id;
        console.log('Auto-selected Client Home as default');
    }
}

// Open participant panel with specific view
function openParticipantPanel(view) {
    const panel = document.getElementById('participantPanel');
    const overlay = document.createElement('div');
    overlay.className = 'panel-overlay';
    overlay.onclick = closeParticipantPanel;
    document.body.appendChild(overlay);
    
    // Hide all views first
    document.querySelectorAll('.panel-view').forEach(v => {
        v.style.display = 'none';
    });
    
    // Show requested view
    const viewElement = document.getElementById(view + 'View');
    if (viewElement) {
        viewElement.style.display = 'block';
    }
    
    // Update panel title
    const titles = {
        'roster': 'Participant Roster',
        'profile': 'Participant Profile',
        'schedule': 'Schedule Management',
        'notes': 'Shift Notes'
    };
    document.getElementById('panelTitle').textContent = titles[view] || 'Participant View';
    
    // Activate panel
    panel.classList.add('active');
    overlay.classList.add('active');
    
    // Load data for the view
    const participantId = document.getElementById('participantSelect').value;
    if (participantId) {
        switch(view) {
            case 'roster':
                loadParticipantRoster(participantId);
                break;
            case 'profile':
                loadParticipantProfile(participantId);
                break;
            case 'notes':
                loadParticipantNotes(participantId);
                break;
        }
    }
}

// Helper to ensure date comparisons work correctly
function normalizeDateForQuery(date) {
    // Format as YYYY-MM-DD in local timezone
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

async function loadParticipantRoster(participantId, offset = 0) {
    window.rosterOffset = offset || 0;
    
    // Get current pay period with offset
    const period = calculatePayPeriod(getTestDate(), offset);
    
    // Format dates for Supabase query (avoiding timezone issues)
    const startQuery = normalizeDateForQuery(period.start);
    const endQuery = normalizeDateForQuery(period.end);
    
    console.log('Loading roster for period:', startQuery, 'to', endQuery);
    
    // Update period display
    const periodElement = document.getElementById('rosterPeriod');
    if (periodElement) {
        const formatOptions = { day: 'numeric', month: 'short', year: 'numeric' };
        const startStr = period.start.toLocaleDateString('en-AU', formatOptions);
        const endStr = period.end.toLocaleDateString('en-AU', formatOptions);
        periodElement.textContent = `${startStr} - ${endStr}`;
    }
    
    // Load shifts with properly formatted dates
    const { data: shifts, error } = await supabaseClient
        .from('shifts')
        .select(`
            *,
            staff:staff_id(first_name, last_name),
            duty_types:duty_type_id(name)
        `)
        .eq('participant_id', participantId)
        .gte('date', startQuery)
        .lte('date', endQuery)
        .is('deleted_at', null)
        .order('date')
        .order('start_time');
    
    if (error) {
        console.error('Error loading roster:', error);
        return;
    }
    
    renderParticipantRoster(shifts);
}

function renderParticipantRoster(shifts) {
    const container = document.getElementById('rosterGrid');
    if (!container) return;
    
    if (!shifts || shifts.length === 0) {
        container.innerHTML = '<div class="no-data">No shifts scheduled for this period</div>';
        return;
    }
    
    // Group shifts by date
    const shiftsByDate = {};
    shifts.forEach(shift => {
        if (!shiftsByDate[shift.date]) {
            shiftsByDate[shift.date] = [];
        }
        shiftsByDate[shift.date].push(shift);
    });
    
    // Use shift-list style instead of cards
    let html = '<div class="shift-list">';
    
    Object.keys(shiftsByDate).sort().forEach(date => {
        const dayShifts = shiftsByDate[date];
        const dateObj = new Date(date + 'T00:00:00');
        const dayName = dateObj.toLocaleDateString('en-AU', { weekday: 'long' });
        const dateStr = dateObj.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        
        html += `
            <div class="shift-group">
                <div class="shift-group-header">
                    <span>${dayName}, ${dateStr}</span>
                    <span class="shift-group-hours">${dayShifts.length} shift(s)</span>
                </div>
        `;
        
        dayShifts.forEach(shift => {
            const staff = shift.staff || {};
            const dutyType = shift.duty_types || {};
            const hours = calculateShiftHours(shift);
            
            html += `
                <div class="shift-list-item">
                    <div class="shift-info">
                        <div class="shift-date-time">
                            ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                        </div>
                        <div class="shift-staff">
                            Staff: ${staff.first_name || ''} ${staff.last_name || ''}
                        </div>
                        <div class="shift-duty">
                            ${dutyType.name || ''}
                        </div>
                    </div>
                    <div class="shift-hours">
                        <div class="shift-hours-value">${hours.total.toFixed(1)}h</div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Change roster period
function changeRosterPeriod(direction) {
    const participantId = document.getElementById('participantSelect').value;
    if (!participantId) return;
    
    const newOffset = (window.rosterOffset || 0) + direction;
    loadParticipantRoster(participantId, newOffset);
}



// Handle image upload in chat
async function handleQuickImageUpload(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    const maxFiles = 3;
    const maxSizeMB = 5;
    
    if ((window.pendingNoteImages?.length || 0) + files.length > maxFiles) {
        showToast(`Maximum ${maxFiles} images per note`, 'error');
        return;
    }
    
    window.pendingNoteImages = window.pendingNoteImages || [];
    
    for (let file of files) {
        if (file.size > maxSizeMB * 1024 * 1024) {
            showToast(`${file.name} exceeds ${maxSizeMB}MB`, 'error');
            continue;
        }
        
        try {
            // Compress image
            const compressed = await compressImage(file, 1200, 0.8);
            
            // Upload to Supabase
            const filename = `notes/${Date.now()}-${Math.random().toString(36).substring(7)}.jpg`;
            
            const { data, error } = await supabaseClient.storage
                .from('shift-note-images')
                .upload(filename, compressed);
            
            if (error) throw error;
            
            const { data: { publicUrl } } = supabaseClient.storage
                .from('shift-note-images')
                .getPublicUrl(filename);
            
            window.pendingNoteImages.push(publicUrl);
            showQuickImagePreview(publicUrl);
            
        } catch (err) {
            console.error('Upload error:', err);
            showToast('Failed to upload image', 'error');
        }
    }
    
    // Reset input
    event.target.value = '';
}

// Show preview of uploaded images
function showQuickImagePreview(url) {
    const preview = document.getElementById('quickImagePreview');
    if (!preview) return;
    
    const item = document.createElement('div');
    item.className = 'preview-item';
    item.innerHTML = `
        <img src="${url}" alt="Preview">
        <button onclick="removeQuickImage(this, '${url}')" class="remove-btn">
            <i class="fa-solid fa-times"></i>
        </button>
    `;
    preview.appendChild(item);
}

// Remove image from preview
function removeQuickImage(btn, url) {
    btn.parentElement.remove();
    window.pendingNoteImages = window.pendingNoteImages.filter(u => u !== url);
}

function renderNotesView(notes, participantId) {
    const container = document.getElementById('notesView');
    if (!container) return;
    
    container.innerHTML = `
        <div class="comments-wrapper">
            <!-- Messages/Notes Area - Scrollable -->
            <div class="messages-container" id="notesContainer">
                <button onclick="loadParticipantNotes('${participantId}', 1, {})" class="load-btn" style="text-align: center; width: 100%; padding: 10px;">
                    Load All Messages with Filters
                </button>
                <div class="messages-list">
                    ${renderNotesList(notes.reverse())}
                </div>
            </div>
            
            <!-- Fixed Compose Area at Bottom -->
            <div class="compose-container">
                <div class="compose-toolbar">
                    <button onclick="formatText('bold')" title="Bold">
                        <i class="fa-solid fa-bold"></i>
                    </button>
                    <button onclick="formatText('italic')" title="Italic">
                        <i class="fa-solid fa-italic"></i>
                    </button>
                    <button onclick="formatText('underline')" title="Underline">
                        <i class="fa-solid fa-underline"></i>
                    </button>
                    <button onclick="formatText('list')" title="Bullet List">
                        <i class="fa-solid fa-list"></i>
                    </button>
                    <button onclick="document.getElementById('noteImageInput').click()" title="Add Image">
                        <i class="fa-solid fa-image"></i>
                    </button>
                </div>
                
                <input type="file" 
                       id="noteImageInput" 
                       accept="image/*" 
                       multiple 
                       style="display: none;"
                       onchange="handleQuickImageUpload(event)">
                
                <div id="quickImagePreview" class="quick-image-preview"></div>
                
                <div class="compose-input-wrapper">
                    <div id="noteCompose" 
                         contenteditable="true" 
                         class="compose-input" 
                         placeholder="Type your note here..."
                         onkeydown="handleNoteKeypress(event)"></div>
                    <button class="send-button" onclick="confirmAndSubmitNote('${participantId}')">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Scroll to bottom to show latest messages
    setTimeout(() => {
        const container = document.getElementById('notesContainer');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }, 100);
}

document.addEventListener('selectionchange', () => {
    const compose = document.getElementById('noteCompose');
    if (compose && document.activeElement === compose) {
        updateToolbarStates();
    }
});


async function loadParticipantNotes(participantId, page = 1, filters = {}) {
    try {
        const notesPerPage = 20;
        const offset = (page - 1) * notesPerPage;
        
        let query = supabaseClient
            .from('shift_notes')
            .select(`
                id,
                note,
                attachments,
                created_at,
                staff:staff_id (
                    id,
                    first_name,
                    last_name
                )
            `, { count: 'exact' })
            .eq('participant_id', participantId);
        
        // Apply filters...
        
        // Get data - CHANGE TO ASCENDING for chat view
        const { data: notes, error, count } = await query
            .order('created_at', { ascending: true })  // Changed to ascending
            .range(offset, offset + notesPerPage - 1);
        
        if (error) throw error;
        
        // For chat view, we want newest at bottom
        // Page 1 should be the most recent notes
        // So we need to calculate offset from the END
        const totalNotes = count;
        const actualOffset = Math.max(0, totalNotes - (page * notesPerPage));
        const actualEnd = totalNotes - ((page - 1) * notesPerPage) - 1;
        
        // Re-query with correct offset from end
        const { data: correctNotes, error: error2 } = await supabaseClient
            .from('shift_notes')
            .select(`
                id,
                note,
                attachments,
                created_at,
                staff:staff_id (
                    id,
                    first_name,
                    last_name
                )
            `)
            .eq('participant_id', participantId)
            .order('created_at', { ascending: true })
            .range(actualOffset, actualEnd);
        
        if (error2) throw error2;
        
        renderNotesViewWithControls(correctNotes, participantId, page, Math.ceil(count / notesPerPage));
        
    } catch (error) {
        console.error('Error loading notes:', error);
    }
}

function renderNotesViewWithControls(notes, participantId, currentPage, totalPages) {
    const container = document.getElementById('notesView');
    if (!container) return;
    
    container.innerHTML = `
        <div class="comments-wrapper">
            <!-- Filter Bar -->
            <div class="notes-filter-bar">
                <button class="filter-toggle-btn" onclick="toggleFilterPanel()">
                    <i class="fa-solid fa-filter"></i> Filters
                </button>
                <div class="notes-info">
                    Page ${currentPage} of ${totalPages || 1}
                </div>
            </div>
            
            <!-- Hidden Filter Panel -->
            <div id="filterPanel" class="filter-panel" style="display: none;">
                <div class="filter-section">
                    <label>Date Range</label>
                    <div class="date-range">
                        <input type="date" id="filterStartDate" class="filter-input">
                        <span>to</span>
                        <input type="date" id="filterEndDate" class="filter-input">
                    </div>
                </div>
                <div class="filter-section">
                    <label>Staff Member</label>
                    <select id="filterStaff" class="filter-select">
                        <option value="">All Staff</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button class="modal-btn secondary" onclick="clearFilters()">Clear</button>
                    <button class="modal-btn primary" onclick="applyFilters('${participantId}')">Apply</button>
                </div>
            </div>
            
            <!-- Messages/Notes Area - Scrollable -->
            <div class="messages-container" id="notesContainer">
                ${currentPage < totalPages ? `
                    <div class="load-more-container" style="text-align: center; padding: 10px;">
                        <button onclick="loadMoreNotes('${participantId}', ${currentPage + 1})" class="load-btn">
                            <i class="fa-solid fa-chevron-up"></i> Load Earlier Messages
                        </button>
                    </div>
                ` : ''}
                
                <div class="messages-list">
                    ${renderNotesList(notes.reverse())}
                </div>
            </div>
            
            <!-- Fixed Compose Area remains the same -->
            <div class="compose-container">
                <div class="compose-toolbar">
                    <button onclick="formatText('bold')" title="Bold">
                        <i class="fa-solid fa-bold"></i>
                    </button>
                    <button onclick="formatText('italic')" title="Italic">
                        <i class="fa-solid fa-italic"></i>
                    </button>
                    <button onclick="formatText('underline')" title="Underline">
                        <i class="fa-solid fa-underline"></i>
                    </button>
                    <button onclick="formatText('list')" title="Bullet List">
                        <i class="fa-solid fa-list"></i>
                    </button>
                    <button onclick="document.getElementById('noteImageInput').click()" title="Add Image">
                        <i class="fa-solid fa-image"></i>
                    </button>
                </div>
                
                <input type="file" 
                       id="noteImageInput" 
                       accept="image/*" 
                       multiple 
                       style="display: none;"
                       onchange="handleQuickImageUpload(event)">
                
                <div id="quickImagePreview" class="quick-image-preview"></div>
                
                <div class="compose-input-wrapper">
                    <div id="noteCompose" 
                         contenteditable="true" 
                         class="compose-input" 
                         placeholder="Type your note here..."></div>
                    <button class="send-button" onclick="confirmAndSubmitNote('${participantId}')">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Populate staff filter
    populateStaffFilter(participantId);
    
    // Scroll to bottom for latest
    setTimeout(() => {
        const container = document.getElementById('notesContainer');
        if (container && currentPage === 1) {
            container.scrollTop = container.scrollHeight;
        }
    }, 100);
}

// Toggle filter panel
function toggleFilterPanel() {
    const panel = document.getElementById('filterPanel');
    if (panel) {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
}

// Apply filters
function applyFilters(participantId) {
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const staffId = document.getElementById('filterStaff').value;
    
    const filters = {};
    if (startDate) filters.startDate = startDate;
    if (endDate) filters.endDate = endDate;
    if (staffId) filters.staffId = staffId;
    
    loadParticipantNotes(participantId, 1, filters);
}

async function populateStaffFilter(participantId) {
    try {
        // Get unique staff IDs who have written notes for this participant
        const { data: notes, error } = await supabaseClient
            .from('shift_notes')
            .select('staff_id, staff:staff_id(first_name, last_name)')
            .eq('participant_id', participantId)
            .not('staff_id', 'is', null);
        
        if (error) throw error;
        
        // Get unique staff members
        const uniqueStaff = new Map();
        notes?.forEach(note => {
            if (note.staff && note.staff_id) {
                uniqueStaff.set(note.staff_id, {
                    id: note.staff_id,
                    name: `${note.staff.first_name} ${note.staff.last_name}`
                });
            }
        });
        
        // Populate the dropdown
        const select = document.getElementById('filterStaff');
        if (select) {
            select.innerHTML = '<option value="">All Staff</option>';
            uniqueStaff.forEach(staff => {
                select.innerHTML += `<option value="${staff.id}">${staff.name}</option>`;
            });
        }
        
    } catch (error) {
        console.error('Error populating staff filter:', error);
    }
}

function clearFilters() {
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    document.getElementById('filterStaff').value = '';
    const participantId = document.getElementById('participantSelect').value;
    loadParticipantNotes(participantId, 1, {});
}

// Load more notes
function loadMoreNotes(participantId, page) {
    loadParticipantNotes(participantId, page, window.currentNotesFilters || {});
}


async function submitQuickNote(participantId) {
    const compose = document.getElementById('noteCompose');
    const noteText = compose.innerHTML.trim();
    const attachments = window.pendingNoteImages || [];
    
    if (!noteText || noteText === '<br>') {
        if (attachments.length === 0) return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('shift_notes')
            .insert({
                staff_id: currentStaff.id,
                participant_id: participantId,  //  CRITICAL: Link to participant
                note: noteText || 'Image attachment',
                shift_id: null,  //  OK to be null - not shift-specific
                attachments: attachments,
                created_at: new Date().toISOString()
            });
        
        if (error) throw error;
        
        // Clear inputs
        compose.innerHTML = '';
        window.pendingNoteImages = [];
        document.getElementById('quickImagePreview').innerHTML = '';
        
        // Reload with current filters and page
        await loadParticipantNotes(participantId, 1, window.currentNotesFilters || {});
        
        showToast('Note added successfully', 'success');
        
    } catch (error) {
        console.error('Error adding note:', error);
        showToast('Failed to add note', 'error');
    }
}

function formatText(command) {
    const compose = document.getElementById('noteCompose');
    compose.focus();
    
    switch(command) {
        case 'bold':
            document.execCommand('bold', false, null);
            break;
        case 'italic':
            document.execCommand('italic', false, null);
            break;
        case 'underline':
            document.execCommand('underline', false, null);
            break;
        case 'list':
            document.execCommand('insertUnorderedList', false, null);
            break;
    }
    
    // Update button states after executing command
    updateToolbarStates();
}

// Add this new function
function updateToolbarStates() {
    const buttons = document.querySelectorAll('.compose-toolbar button');
    
    buttons.forEach(btn => {
        const icon = btn.querySelector('i');
        if (!icon) return;
        
        let isActive = false;
        
        if (icon.classList.contains('fa-bold')) {
            isActive = document.queryCommandState('bold');
        } else if (icon.classList.contains('fa-italic')) {
            isActive = document.queryCommandState('italic');
        } else if (icon.classList.contains('fa-underline')) {
            isActive = document.queryCommandState('underline');
        } else if (icon.classList.contains('fa-list')) {
            isActive = document.queryCommandState('insertUnorderedList');
        }
        
        if (isActive) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}


// Updated keypress handler - Enter for new line, not submit
function handleNoteKeypress(event) {
    // Remove the enter key submit - let it create new lines naturally
    // Only Ctrl+Enter or Cmd+Enter will submit
    if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
        event.preventDefault();
        const participantId = document.getElementById('participantSelect').value;
        confirmAndSubmitNote(participantId);
    }
}

// Confirm before submitting
function confirmAndSubmitNote(participantId) {
    if (confirm('Submit this note? Once submitted, it cannot be edited or deleted.')) {
        submitQuickNote(participantId);
    }
}

// Updated render notes list with better date display
function renderNotesList(notes) {
    if (!notes || notes.length === 0) {
        return `
            <div class="no-messages">
                <i class="fa-solid fa-comment-slash"></i>
                <p>No notes yet.</p>
            </div>
        `;
    }
    
    return notes.map(note => {
        const staff = note.staff || {};
        const createdDate = new Date(note.created_at);
        const isOwnNote = staff.id === currentStaff.id;
        
        return `
            <div class="message ${isOwnNote ? 'own-message' : 'other-message'}">
                <div class="message-avatar">
                    ${staff.first_name?.[0] || 'U'}${staff.last_name?.[0] || ''}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${staff.first_name} ${staff.last_name}</span>
                        <span class="message-date">${createdDate.toLocaleDateString('en-AU', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric' 
                        })}</span>
                        <span class="message-time">${createdDate.toLocaleTimeString('en-AU', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })}</span>
                    </div>
                    <div class="message-body">
                        ${note.note}
                    </div>
                    ${note.attachments && note.attachments.length > 0 ? `
                        <div class="message-images">
                            ${note.attachments.map(url => `
                                <img src="${url}" 
                                     class="message-image" 
                                     onclick="window.open('${url}', '_blank')"
                                     alt="Attachment">
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}



function formatMessageTime(date) {
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) {
        return date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
    } else if (days === 1) {
        return 'Yesterday';
    } else if (days < 7) {
        return date.toLocaleDateString('en-AU', { weekday: 'short' });
    } else {
        return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
    }
}



async function populateParticipantShifts(participantId) {
    const select = document.getElementById('noteShiftSelect');
    if (!select) return;
    
    try {
        const { data: shifts } = await supabaseClient
            .from('shifts')
            .select('id, date, start_time, end_time')
            .eq('participant_id', participantId)
            .eq('staff_id', currentStaff.id)
            .order('date', { ascending: false })
            .limit(20);
        
        select.innerHTML = '<option value="">Select a shift...</option>';
        shifts?.forEach(shift => {
            const shiftDate = new Date(shift.date + 'T00:00:00');
            const label = `${shiftDate.toLocaleDateString('en-AU')} ${shift.start_time || 'Sleepover'}`;
            select.innerHTML += `<option value="${shift.id}">${label}</option>`;
        });
    } catch (error) {
        console.error('Error loading shifts:', error);
    }
}
function renderNotesTimeline(notes) {
    const container = document.getElementById('notesTimeline');
    if (!container) return;
    
    if (!notes || notes.length === 0) {
        container.innerHTML = `
            <div class="empty-comments">
                <i class="fa-solid fa-comment-slash"></i>
                <p>No shift notes yet</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="comments-timeline">';
    
    notes.forEach((note, index) => {
        const staff = note.staff || {};
        const shift = note.shifts || {};
        const createdDate = new Date(note.created_at);
        const shiftDate = new Date(shift.date + 'T00:00:00');
        const timeAgo = getTimeAgo(createdDate);
        
        html += `
            <div class="comment-item ${index === 0 ? 'latest' : ''}">
                <div class="comment-avatar">
                    ${staff.first_name ? staff.first_name.charAt(0) : 'U'}${staff.last_name ? staff.last_name.charAt(0) : ''}
                </div>
                <div class="comment-content">
                    <div class="comment-header">
                        <div class="comment-author">${staff.first_name || ''} ${staff.last_name || ''}</div>
                        <div class="comment-meta">
                            <span class="comment-time" title="${createdDate.toLocaleString('en-AU')}">
                                ${timeAgo}
                            </span>
                            <span class="comment-shift">
                                Shift: ${shiftDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })}
                                ${shift.start_time ? ` at ${formatTime12Hour(shift.start_time)}` : ''}
                            </span>
                        </div>
                    </div>
                    <div class="comment-body">
                        ${escapeHtml(note.note || '')}
                    </div>
                    ${note.attachments && note.attachments.length > 0 ? `
                        <div class="comment-attachments">
                            <div class="attachment-grid">
                                ${note.attachments.map((url, i) => `
                                    <div class="attachment-item" onclick="window.open('${url}', '_blank')">
                                        <img src="${url}" alt="Attachment ${i + 1}" loading="lazy">
                                        <div class="attachment-overlay">
                                            <i class="fa-solid fa-expand"></i>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="attachment-count">
                                <i class="fa-solid fa-camera"></i> ${note.attachments.length} photo${note.attachments.length > 1 ? 's' : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
                ${index < notes.length - 1 ? '<div class="timeline-connector"></div>' : ''}
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Simple image viewer
function openImageViewer(noteId, imageIndex) {
    // Find the note and get all images
    const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
    const images = AppState.currentNoteImages[noteId] || [];
    
    if (images.length === 0) return;
    
    // Create viewer modal
    const viewer = document.createElement('div');
    viewer.className = 'image-viewer-modal';
    viewer.innerHTML = `
        <div class="image-viewer-content">
            <button class="viewer-close" onclick="this.parentElement.parentElement.remove()">
                <i class="fa-solid fa-times"></i>
            </button>
            <img src="${images[imageIndex]}" alt="Full size image">
            <div class="viewer-navigation">
                ${imageIndex > 0 ? `
                    <button onclick="navigateImage('${noteId}', ${imageIndex - 1})">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                ` : '<span></span>'}
                <span>${imageIndex + 1} / ${images.length}</span>
                ${imageIndex < images.length - 1 ? `
                    <button onclick="navigateImage('${noteId}', ${imageIndex + 1})">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                ` : '<span></span>'}
            </div>
        </div>
    `;
    document.body.appendChild(viewer);
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + ' years ago';
    
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + ' months ago';
    
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + ' days ago';
    
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + ' hours ago';
    
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + ' minutes ago';
    
    return 'just now';
}

// Helper function to escape HTML
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Format time helper
function formatTime12Hour(time) {
    if (!time) return '';
    const [hours, minutes] = time.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

// Open school holiday modal
function showSchoolHolidayModal() {
    const modal = document.getElementById('schoolHolidayModal');
    if (modal) {
        // REMOVED: Don't set minimum date - allow backdating
        // Staff can submit school holidays for past dates
        
        // Optional: Set a reasonable past limit (e.g., start of current year)
        // const yearStart = new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0];
        // document.getElementById('schoolStartDate').min = yearStart;
        // document.getElementById('schoolEndDate').min = yearStart;
        
        modal.style.display = 'flex';
    }
}

async function submitSchoolHoliday() {
    const submitBtn = document.querySelector('[onclick="submitSchoolHoliday()"]');
    if (!submitBtn || submitBtn.disabled) return;
    
    try {
        submitBtn.disabled = true;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        
        const startDate = document.getElementById('schoolStartDate').value;
        const endDate = document.getElementById('schoolEndDate').value;
        
        // Validation
        if (!startDate || !endDate) {
            showToast('Please select both start and end dates', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }
        
        if (new Date(endDate) < new Date(startDate)) {
            showToast('End date must be after start date', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }
        
        // Check for overlapping submissions
        const { data: existing } = await supabaseClient
            .from('school_holidays')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .lte('start_date', endDate)
            .gte('end_date', startDate)
            .in('status', ['pending', 'approved']);
        
        if (existing && existing.length > 0) {
            showToast('You already have a holiday submission overlapping this period', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }
        
        // Submit - ONLY use columns that exist in your table
        const { error } = await supabaseClient
            .from('school_holidays')
            .insert({
                staff_id: currentStaff.id,
                start_date: startDate,
                end_date: endDate,
                status: 'pending'
                // created_at will auto-populate if it has a default value
            });
        
        if (error) throw error;
        
        showToast('School holiday period submitted successfully', 'success');
        closeModal('schoolHolidayModal');
        document.getElementById('schoolHolidayForm').reset();
        
        if (typeof loadSchoolHolidays === 'function') {
            loadSchoolHolidays();
        }
        
        setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }, 2000);
        
    } catch (error) {
        console.error('Error submitting school holiday:', error);
        showToast('Failed to submit school holiday', 'error');
        
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
        }
    }
}

// Update date validation to only set minimum relationships, not restrict past dates
document.getElementById('schoolStartDate')?.addEventListener('change', function() {
    const endDate = document.getElementById('schoolEndDate');
    // Only ensure end date is after start date, don't restrict past dates
    endDate.min = this.value;
    
    if (endDate.value && endDate.value < this.value) {
        endDate.value = this.value;
    }
});


async function checkSchoolHolidayVisibility() {
    try {
        // Fetch the limits value from database (note: column is 'limits' not 'limit')
        const { data, error } = await supabaseClient
            .from('staff')
            .select('limits')
            .eq('id', currentStaff.id)
            .single();
        
        if (error) {
            console.error('Error fetching staff limits:', error);
            return;
        }
        
        const staffLimits = data?.limits;
        console.log('Fetched staff limits from DB:', staffLimits);
        
        // Store it for future use
        if (currentStaff) {
            currentStaff.limits = staffLimits;
        }
        
        // Check if limits equals 48
        const hasSchoolHolidayAccess = staffLimits === 48 || staffLimits === '48';
        
        // Wait for DOM
        setTimeout(() => {
            const holidayBtn = document.querySelector('[data-action="showSchoolHolidayModal"]');
            console.log('School holiday button in DOM:', !!holidayBtn);
            
            if (holidayBtn) {
                if (hasSchoolHolidayAccess) {
                    console.log('✓ Keeping school holiday button - limits is 48');
                } else {
                    console.log('✗ Removing school holiday button - limits is:', staffLimits);
                    holidayBtn.remove();
                }
            }
        }, 1000);
        
    } catch (error) {
        console.error('Error in checkSchoolHolidayVisibility:', error);
    }
}

async function loadParticipantProfile(participantId) {
    const container = document.getElementById('profileContent');
    if (!container) return;
    
    try {
        const { data: participant, error } = await supabaseClient
            .from('participants')
            .select('*')
            .eq('id', participantId)
            .single();
        
        if (error) throw error;
        
        container.innerHTML = `
            <div class="profile-details">
                <h3>${participant.first_name} ${participant.last_name}</h3>
                <p>Address: ${participant.address || 'Not provided'}</p>
                <p>NDIS Number: ${participant.ndis_number || 'Not provided'}</p>
                <p>Phone: ${participant.phone || 'Not provided'}</p>
            </div>
        `;
    } catch (error) {
        console.error('Error loading profile:', error);
        container.innerHTML = '<div class="error">Failed to load profile</div>';
    }
}
function renderShiftNotes(notes) {
    const container = document.getElementById('notesTimeline');
    if (!container) return;
    
    if (!notes || notes.length === 0) {
        container.innerHTML = '<div class="no-data">No shift notes available</div>';
        return;
    }
    
    let html = '';
    notes.forEach(note => {
        const staff = note.staff || {};
        const createdDate = new Date(note.created_at);
        
        // Determine category style
        const categoryClass = note.category ? `category-${note.category.toLowerCase()}` : 'category-general';
        
        html += `
            <div class="shift-note-card">
                <div class="shift-note-header">
                    <div>
                        <div class="shift-note-staff">
                            ${staff.first_name || ''} ${staff.last_name || ''}
                        </div>
                        <div class="shift-note-meta">
                            ${createdDate.toLocaleDateString('en-AU')} at ${createdDate.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                    </div>
                    <span class="shift-note-category ${categoryClass}">
                        ${note.category || 'General'}
                    </span>
                </div>
                <div class="shift-note-content">
                    ${note.note || 'No notes'}
                </div>
                ${note.attachments && note.attachments.length > 0 ? `
                    <div class="shift-note-attachments">
                        <i class="fa-solid fa-paperclip"></i> ${note.attachments.length} Attachment(s)
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function submitShiftNote() {
    try {
        const participantId = document.getElementById('participantSelect').value; // Get participant ID
        const noteText = document.getElementById('noteText').value;
        const attachments = window.pendingNoteImages || [];
        
        if (!participantId || !noteText.trim()) {
            showToast('Please select a participant and enter a note', 'error');
            return;
        }
        
        const { error } = await supabaseClient
            .from('shift_notes')
            .insert({
                participant_id: participantId,  
                staff_id: currentStaff.id,
                note: noteText.trim(),
                attachments: attachments,
                created_at: new Date().toISOString()
            });
        
        if (error) throw error;
        
        // Clean up
        window.pendingNoteImages = [];
        const previewContainer = document.getElementById('imagePreviewContainer');
        if (previewContainer) {
            previewContainer.innerHTML = '';
        }
        
        // Refresh notes for this participant only
        await loadParticipantNotes(participantId);
        
        // Reset form and close
        document.getElementById('shiftNoteForm').reset();
        closeModal('addShiftNoteModal');
        showToast('Note added successfully', 'success');
        
    } catch (error) {
        console.error('Error adding note:', error);
        showToast('Failed to add note', 'error');
    }
}


async function handleNoteImageUpload(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    const maxFiles = 3; // Limit number of images
    const maxSizeMB = 5; // Max size per image
    const targetWidth = 1200; // Resize to max 1200px wide
    const quality = 0.8; // JPEG quality

    if (files.length > maxFiles) {
        showToast(`Maximum ${maxFiles} images allowed`, 'error');
        return;
    }
    
    const uploadedUrls = [];
    
    for (let file of files) {
        try {
            // Check file size
            if (file.size > maxSizeMB * 1024 * 1024) {
                showToast(`Image ${file.name} exceeds ${maxSizeMB}MB limit`, 'error');
                continue;
            }
            
            // Compress and resize image
            const compressedBlob = await compressImage(file, targetWidth, quality);
            
            // Generate unique filename
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(7);
            const filename = `shift-notes/${currentStaff.id}/${timestamp}-${randomStr}.jpg`;
            
            // Upload to Supabase Storage
            const { data, error } = await supabaseClient.storage
                .from('shift-note-images') // Create this bucket in Supabase
                .upload(filename, compressedBlob, {
                    contentType: 'image/jpeg',
                    cacheControl: '3600'
                });
            
            if (error) throw error;
            
            // Get public URL
            const { data: { publicUrl } } = supabaseClient.storage
                .from('shift-note-images')
                .getPublicUrl(filename);
            
            uploadedUrls.push(publicUrl);
            
            // Show preview
            showImagePreview(publicUrl);
            
        } catch (error) {
            console.error('Error uploading image:', error);
            showToast(`Failed to upload ${file.name}`, 'error');
        }
    }
    
    // Store URLs for submission
    window.pendingNoteImages = uploadedUrls;
}

// Image compression function
async function compressImage(file, maxWidth, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Calculate new dimensions
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(
                    (blob) => resolve(blob),
                    'image/jpeg',
                    quality
                );
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Show image preview in modal
function showImagePreview(url) {
    const container = document.getElementById('imagePreviewContainer');
    if (!container) return;
    
    const preview = document.createElement('div');
    preview.className = 'image-preview-item';
    preview.innerHTML = `
        <img src="${url}" alt="Preview">
        <button onclick="removeImagePreview(this, '${url}')" class="remove-preview">
            <i class="fa-solid fa-times"></i>
        </button>
    `;
    container.appendChild(preview);
}

// Remove image preview
function removeImagePreview(button, url) {
    button.parentElement.remove();
    if (window.pendingNoteImages) {
        window.pendingNoteImages = window.pendingNoteImages.filter(u => u !== url);
    }
}




// Helper function for time formatting
function formatTime12Hour(time) {
    if (!time) return '';
    const [hours, minutes] = time.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

function closeParticipantPanel() {
    const panel = document.getElementById('participantPanel');
    const overlay = document.querySelector('.panel-overlay');
    
    panel.classList.remove('active');
    
    // Remove ALL overlays, not just one
    document.querySelectorAll('.panel-overlay').forEach(overlay => {
        overlay.classList.remove('active');
        overlay.remove();
    });
}

function debounceButton(button, callback, delay = 1000) {
    let isProcessing = false;
    
    return async function(...args) {
        if (isProcessing) return;
        
        isProcessing = true;
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'Processing...';
        
        try {
            await callback.apply(this, args);
        } finally {
            setTimeout(() => {
                isProcessing = false;
                button.disabled = false;
                button.textContent = originalText;
            }, delay);
        }
    };
}


// Update initialization
async function initializeParticipantManagement() {
    const select = document.getElementById('participantSelect');
    if (!select) return;
    
    // Load participants (same as before)
    const { data: assignments, error } = await supabaseClient
        .from('staff_participant_assignments')
        .select(`
            participant_id,
            participants!inner(
                id,
                first_name,
                last_name,
                is_active
            )
        `)
        .eq('staff_id', currentStaff.id)
        .eq('participants.is_active', true);
    
    if (!error && assignments) {
        select.innerHTML = '<option value="">Select participant...</option>';
        assignments.forEach(assignment => {
            const participant = assignment.participants;
            if (participant) {
                const option = document.createElement('option');
                option.value = participant.id;
                option.textContent = `${participant.first_name} ${participant.last_name}`;
                select.appendChild(option);
            }
        });
    }
    
    // Set up navigation button listeners
    document.querySelectorAll('[data-participant-view]').forEach(btn => {
        btn.addEventListener('click', function() {
            const view = this.dataset.participantView;
            openParticipantPanel(view);
        });
    });
}

// Show/hide menu when participant selected
function loadParticipantData() {
    const participantId = document.getElementById('participantSelect').value;
    const menu = document.getElementById('participantMenu');
    
    if (participantId) {
        menu.style.display = 'grid';
    } else {
        menu.style.display = 'none';
    }
}

// Switch between participant tabs
function switchParticipantTab(tab) {
    // Update active tab
    document.querySelectorAll('[data-participant-tab]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.participantTab === tab);
    });
    
    // Show corresponding content
    document.querySelectorAll('.participant-content').forEach(content => {
        content.style.display = 'none';
    });
    
    const participantId = document.getElementById('participantSelect').value;
    
    switch(tab) {
        case 'roster':
            document.getElementById('participantRoster').style.display = 'block';
            loadParticipantRoster(participantId);
            break;
        case 'profile':
            document.getElementById('participantProfile').style.display = 'block';
            loadParticipantProfile(participantId);
            break;
        case 'schedule':
            document.getElementById('participantSchedule').style.display = 'block';
            // Future implementation
            break;
        case 'notes':
            document.getElementById('participantNotes').style.display = 'block';
            loadParticipantNotes(participantId);
            break;
    }
}



async function loadReferenceData() {
    try {
        console.log('Loading reference data for team...');
        
        // Load all reference data in parallel
        const [participantsData, staffData, locationsData, dutyTypesData] = await Promise.all([
            supabaseClient.from('participants').select('*').eq('is_active', true).order('first_name'),
            supabaseClient.from('staff').select('*').eq('is_active', true).order('first_name'),
            supabaseClient.from('locations').select('*').order('name'),
            supabaseClient.from('duty_types').select('*').order('name')
        ]);
        
        // Populate global arrays
        participants = participantsData.data || [];
        staff = staffData.data || [];
        locations = locationsData.data || [];
        dutyTypes = dutyTypesData.data || [];
        
        // Also update window references
        window.participants = participants;
        window.staff = staff;
        window.locations = locations;
        window.dutyTypes = dutyTypes;
        
        console.log('Reference data loaded:', {
            participants: participants.length,
            staff: staff.length,
            locations: locations.length,
            dutyTypes: dutyTypes.length
        });
        
        return true;
        
    } catch (error) {
        console.error('Error loading reference data:', error);
        showToast('Failed to load reference data', 'error');
        return false;
    }
}

function createSearchableDropdown(selectId, options = {}) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'searchable-dropdown-wrapper';
    wrapper.style.position = 'relative';
    
    // Create search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control searchable-input';
    searchInput.placeholder = options.placeholder || 'Type to search...';
    searchInput.style.cssText = `
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    `;
    
    // Create dropdown list
    const dropdownList = document.createElement('div');
    dropdownList.className = 'searchable-dropdown-list';
    dropdownList.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        display: none;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    
    // Store selected value
    let selectedValue = select.value;
    let selectedText = '';
    
    // Get options from original select
    const originalOptions = Array.from(select.options).map(opt => ({
        value: opt.value,
        text: opt.textContent,
        data: opt.dataset
    }));
    
    // Function to update dropdown list
    function updateDropdownList(searchTerm = '') {
        dropdownList.innerHTML = '';
        
        const filtered = originalOptions.filter(opt => 
            opt.text.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        if (filtered.length === 0) {
            dropdownList.innerHTML = '<div style="padding: 8px; color: #999;">No results found</div>';
            return;
        }
        
        filtered.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                transition: background 0.2s;
            `;
            item.textContent = opt.text;
            item.dataset.value = opt.value;
            
            // Copy any data attributes
            Object.keys(opt.data || {}).forEach(key => {
                item.dataset[key] = opt.data[key];
            });
            
            item.onmouseover = () => item.style.background = '#f0f0f0';
            item.onmouseout = () => item.style.background = 'white';
            
            item.addEventListener('click', () => {
    selectedValue = opt.value;
    selectedText = opt.text;
    searchInput.value = opt.text;
    select.value = opt.value;
    
    // Trigger change event on original select
    const event = new Event('change', { bubbles: true });
    select.dispatchEvent(event);
    
    dropdownList.style.display = 'none';
});
            
            dropdownList.appendChild(item);
        });
    }
    
    // Event handlers
    searchInput.onfocus = () => {
        updateDropdownList('');
        dropdownList.style.display = 'block';
    };
    
    searchInput.oninput = (e) => {
        updateDropdownList(e.target.value);
        dropdownList.style.display = 'block';
    };
    
    // Click outside to close
    document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // Set initial value
    if (select.value) {
        const initial = originalOptions.find(opt => opt.value === select.value);
        if (initial) {
            searchInput.value = initial.text;
            selectedText = initial.text;
        }
    }
    
    // Replace select with wrapper
    select.style.display = 'none';
    wrapper.appendChild(searchInput);
    wrapper.appendChild(dropdownList);
    select.parentNode.insertBefore(wrapper, select.nextSibling);
    
    // Store reference for later updates
    select._searchableDropdown = {
        update: () => updateDropdownList(''),
        setValue: (value) => {
            const opt = originalOptions.find(o => o.value === value);
            if (opt) {
                selectedValue = opt.value;
                selectedText = opt.text;
                searchInput.value = opt.text;
                select.value = opt.value;
            }
        },
        getValue: () => selectedValue
    };
    
    return select._searchableDropdown;
}



async function refreshAfterChange() {
    try {
        // Reload shifts if function exists
        if (typeof loadShifts === 'function') {
            await loadShifts();
        }
        
        // Reload my shifts for team.html
        if (typeof loadMyShifts === 'function') {
            await loadMyShifts();
        }
        
        // Refresh current view
        if (typeof renderCurrentView === 'function') {
            renderCurrentView();
        }
        
        // Update dashboard if on team.html
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
        
    } catch (error) {
        console.error('Error refreshing after change:', error);
    }
}

async function loadMyShifts() {
    try {
        const { data: myShiftsData, error: shiftsError } = await supabaseClient
    .from('shifts')
    .select(`
        *,
        participants:participant_id(first_name, last_name, address),
        locations:location_id(id, name, address, is_care_home),
        duty_types:duty_type_id(name)
    `)
    .eq('staff_id', staffData.id)
    .is('deleted_at', null)
    .order('date', { ascending: false })
    .limit(100);

        if (shiftsError) {
            console.error('Error loading shifts:', shiftsError);
            throw shiftsError;
        }
        
        myShifts = myShiftsData || [];
        window.myShifts = myShifts;
        
        console.log('Shifts loaded:', myShifts.length);
        return myShifts;
        
    } catch (error) {
        console.error('Error in loadMyShifts:', error);
        showToast('Failed to load shifts', 'error');
        return [];
    }
}



// 2. CONSOLIDATED Event Listener Setup
function setupAllEventListeners() {
    console.log('Setting up all event listeners...');
    
    // Quick Actions
    setupQuickActions();
    
    // Navigation
    setupNavigation();
    
    // Forms
    setupForms();
    
    // Modals
    setupModals();
    
    // Edit/Save Buttons
    setupEditButtons();
    
    // File Uploads
    setupFileUploads();
    
    // Keyboard Shortcuts
    setupKeyboardShortcuts();
    
    // Timesheet Controls
    setTimeout(() => {
    const prevBtn = document.getElementById('prevPeriodBtn');
    const nextBtn = document.getElementById('nextPeriodBtn');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            console.log('Previous period clicked');
            changePeriod(-1);
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            console.log('Next period clicked');
            changePeriod(1);
        });
    }
}, 100);
    
    console.log('Event listeners ready');
}

window.showNotification = function(message, type) {
    showToast(message, type);
};

function setupQuickActions() {
    // Quick actions are now handled by data attributes
    // Just ensure the buttons have the right data-action attributes
    console.log('Quick actions setup via data attributes');
}
function setupNavigation() {
    // Tab navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const view = this.getAttribute('data-view');
            if (view) switchView(view);
        });
    });
    
    // View selector
    const viewSelector = document.getElementById('viewSelector');
    if (viewSelector) {
        viewSelector.addEventListener('change', (e) => switchView(e.target.value));
    }
}

function setupForms() {
    const forms = {
        'noteForm': submitNote,
        'addShiftForm': submitShift,
        'transferForm': submitTransfer,
        'adjustmentForm': submitAdjustment,
        'leaveForm': submitLeave
    };
    
    Object.entries(forms).forEach(([id, handler]) => {
        const form = document.getElementById(id);
        if (form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                handler();
            });
        }
    });
}

async function loadAvailableTransfers() {
    try {
        const container = document.getElementById('availableList');
        if (!container) return;
        
        // Load shifts that are unassigned or available for pickup
        const { data: availableShifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                locations(name, address),
                duty_types(name)
            `)
            .is('staff_id', null) // Unassigned shifts
            .gte('date', getTestDate().toISOString().split('T')[0])
            .order('date', { ascending: true })
            .limit(20);
        
        if (error) {
            console.error('Error loading available shifts:', error);
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">Failed to load available shifts</div>';
            return;
        }
        
        if (!availableShifts || availableShifts.length === 0) {
            container.innerHTML = '<div class="text-center p-2" style="color: var(--text-light);">No available shifts at this time</div>';
            return;
        }
        
        // Render available shifts
        container.innerHTML = availableShifts.map(shift => `
            <div class="transfer-item">
                <div class="transfer-header">
                    <div>
                        <div class="transfer-date">${formatDateLong(shift.date)}</div>
                        <div class="transfer-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary" data-action-with-param="claimShift" data-param="${shift.id}">
                        Claim Shift
                    </button>
                </div>
                <div class="transfer-from">
                    Client: ${shift.participants ? 
                        `${shift.participants.first_name} ${shift.participants.last_name}` : 
                        'Unassigned'}
                </div>
                <div class="transfer-from">
                    Location: ${shift.locations?.name || 'Client Home'}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error in loadAvailableTransfers:', error);
        showToast('Failed to load available shifts', 'error');
    }
}

function filterSchedule() {
    const filterValue = document.getElementById('participantFilter').value;
    // Re-render schedule with filter
    loadSchedule(); // This should use the filter value
}

async function claimShift(shiftId) {
    try {
        if (!confirm('Do you want to claim this shift?')) return;
        
        const { error } = await supabaseClient
            .from('shifts')
            .update({ staff_id: AppState.staff.current.id })
            .eq('id', parseInt(shiftId));
        
        if (error) throw error;
        
        showToast('Shift claimed successfully', 'success');
        loadAvailableTransfers(); // Reload the list
        
    } catch (error) {
        console.error('Error claiming shift:', error);
        showToast('Failed to claim shift', 'error');
    }
}

function setupModals() {
    // Close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) closeModal(modal.id);
        });
    });
    
    // Cancel buttons
    document.querySelectorAll('.modal .btn-secondary').forEach(btn => {
        if (btn.textContent.includes('Cancel')) {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) closeModal(modal.id);
            });
        }
    });
    
    // Click outside to close
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target.id);
        }
    });
}

function setupEditButtons() {
    const editButtons = {
        'editPersonalBtn': editPersonalInfo,
        'editContactBtn': editContactInfo,
        'editBankingBtn': editBankingInfo,
        'savePersonalBtn': savePersonalInfo,
        'saveContactBtn': saveContactInfo,
        'saveBankingBtn': saveBankingInfo,
        'saveAvailabilityBtn': saveAvailability
    };
    
    Object.entries(editButtons).forEach(([id, handler]) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.addEventListener('click', handler);
        }
    });
}

function setupFileUploads() {
    
    const docUploadBtn = document.getElementById('uploadDocBtn');
    if (docUploadBtn) {
        docUploadBtn.addEventListener('click', uploadDocument);
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Alt+T: Toggle staff selector
        if (e.altKey && e.key === 't') {
            e.preventDefault();
            const selector = document.getElementById('staffSelector');
            if (selector) {
                selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Escape: Close active modal
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                closeModal(activeModal.id);
            }
        }
    });
}


async function checkTableStructure() {
    // Run this once to determine actual column types
    const { data, error } = await supabaseClient
        .from('shift_adjustment_requests')
        .select('*')
        .limit(1);
    
    console.log('shift_adjustment_requests sample:', data);
    
    
}



function ensureRequiredElements() {
    const requiredElements = [
        { id: 'userName', description: 'User name display' },
        { id: 'scheduleGrid', description: 'Schedule container' },
        { id: 'recentNotifications', description: 'Notifications container' },
        { id: 'incomingCount', description: 'Transfer count badge' },
        { id: 'periodDates', description: 'Pay period display' },
        { id: 'dashboardContent', description: 'Main dashboard content' }
    ];
    
    const missingElements = [];
    
    requiredElements.forEach(element => {
        const domElement = document.getElementById(element.id);
        if (!domElement) {
            console.warn(`Required element missing: ${element.id} (${element.description})`);
            missingElements.push(element.id);
        }
    });
    
    if (missingElements.length > 0) {
        console.warn('Missing DOM elements:', missingElements);
        // Could create placeholder elements here if needed
        missingElements.forEach(id => {
            if (id === 'scheduleGrid' || id === 'recentNotifications') {
                // Create essential containers if missing
                const container = document.createElement('div');
                container.id = id;
                container.innerHTML = '<div class="loading">Loading...</div>';
                
                // Try to find a good parent to attach to
                const parent = document.querySelector('.content-section') || document.body;
                parent.appendChild(container);
                
                console.log(`Created placeholder element: ${id}`);
            }
        });
    }
    
    return missingElements.length === 0;
}

        
        async function loadDashboard() {
    try {
        // Load current/upcoming shift
        await loadCurrentShift();
        
        // Load pending requests
        await loadPendingRequests();
        
        // Load notifications
        await loadNotifications();
        
        // Load upcoming leave
        const today = getTestDate().toISOString().split('T')[0];
        const thirtyDaysFromNow = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        const { data: myLeave } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('available', false)
            .gte('date', today)
            .lte('date', thirtyDaysFromNow)
            .order('date');

        if (myLeave && myLeave.length > 0) {
            // Group consecutive dates
            const leaveGroups = [];
            let currentGroup = null;
            
            myLeave.forEach(leave => {
                const leaveDate = new Date(leave.date);
                
                if (!currentGroup || 
                    leave.reason !== currentGroup.reason ||
                    (leaveDate - new Date(currentGroup.endDate)) > 24 * 60 * 60 * 1000) {
                    currentGroup = {
                        startDate: leave.date,
                        endDate: leave.date,
                        reason: leave.reason,
                        days: 1
                    };
                    leaveGroups.push(currentGroup);
                } else {
                    currentGroup.endDate = leave.date;
                    currentGroup.days++;
                }
            });

            // Create leave section HTML
            const leaveHTML = `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>📅 Upcoming Leave</h3>
                        <span class="badge">${leaveGroups.length}</span>
                    </div>
                    <div class="leave-list">
                        ${leaveGroups.map(group => {
                            const start = formatDateShort(group.startDate);
                            const end = formatDateShort(group.endDate);
                            const dateRange = group.startDate === group.endDate ? 
                                start : 
                                `${start} - ${end} (${group.days} days)`;
                            
                            const daysUntil = Math.floor((new Date(group.startDate) - getTestDate()) / (24 * 60 * 60 * 1000));
                            const urgency = daysUntil <= 7 ? 'urgent' : daysUntil <= 14 ? 'soon' : '';
                            
                            return `
                                <div class="leave-item ${urgency}">
                                    <div class="leave-info">
                                        <div class="leave-dates">${dateRange}</div>
                                        <div class="leave-type">${group.reason}</div>
                                    </div>
                                    ${daysUntil > 0 ? 
                                        `<div class="leave-countdown">In ${daysUntil} day${daysUntil !== 1 ? 's' : ''}</div>` : 
                                        daysUntil === 0 ? 
                                        '<div class="leave-countdown today">Today</div>' : 
                                        '<div class="leave-countdown ongoing">Ongoing</div>'
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Insert leave section into dashboard
            const dashboardContent = document.getElementById('dashboardContent');
            if (dashboardContent) {
                // Find or create leave container
                let leaveContainer = dashboardContent.querySelector('.leave-container');
                if (!leaveContainer) {
                    leaveContainer = document.createElement('div');
                    leaveContainer.className = 'leave-container';
                    
                    // Insert after pending requests or at the end
                    const pendingRequests = dashboardContent.querySelector('.dashboard-card');
                    if (pendingRequests) {
                        pendingRequests.insertAdjacentElement('afterend', leaveContainer);
                    } else {
                        dashboardContent.appendChild(leaveContainer);
                    }
                }
                leaveContainer.innerHTML = leaveHTML;
            }
        }
        
        // Update summary stats
        const { data: stats } = await supabaseClient
            .from('shifts')
            .select('id, status')
            .eq('staff_id', currentStaff.id)
            .gte('date', today);
        
        const upcomingShifts = stats?.filter(s => s.status === 'confirmed').length || 0;
        const pendingShifts = stats?.filter(s => s.status === 'pending').length || 0;
        
        // Update dashboard badges
        const homeBadge = document.getElementById('homeBadge');
        if (homeBadge) {
            const totalAlerts = pendingShifts + (myLeave?.length || 0);
            homeBadge.textContent = totalAlerts;
            homeBadge.classList.toggle('hidden', totalAlerts === 0);
        }
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Failed to load dashboard completely', 'error');
    }
}

// Shift state constants
const SHIFT_STATES = {
    TOO_EARLY: 'too_early',
    READY_TO_CLOCK_IN: 'ready_to_clock_in',
    IN_PROGRESS: 'in_progress',
    OVERTIME: 'overtime',
    MISSED: 'missed',
    MISSED_CLOCK_OUT: 'missed_clock_out',
    COMPLETED: 'completed'
};


// Fixed getShiftState function - now uses getTestDate()
function getShiftState(shift) {
    const now = getTestDate(); // FIXED: Use getTestDate() instead of new Date()
    const shiftDate = new Date(shift.date);
    
    // Check if it's a sleepover shift
    const isSleepover = !shift.start_time || !shift.end_time || 
                        shift.start_time === 'Sleepover' || 
                        shift.duty_type?.name?.toLowerCase().includes('sleepover');
    
    let shiftStart, shiftEnd, clockInStart, clockInEnd, clockOutEnd;
    
    if (isSleepover) {
        // Sleepover shifts: 8pm to 9am next day
        shiftStart = new Date(shiftDate);
        shiftStart.setHours(20, 0, 0, 0); // 8 PM
        
        shiftEnd = new Date(shiftDate);
        shiftEnd.setDate(shiftEnd.getDate() + 1); // Next day
        shiftEnd.setHours(9, 0, 0, 0); // 9 AM
        
        // Clock in: 7:30 PM - 9:30 PM
        clockInStart = new Date(shiftDate);
        clockInStart.setHours(19, 30, 0, 0); // 7:30 PM
        
        clockInEnd = new Date(shiftDate);
        clockInEnd.setHours(21, 30, 0, 0); // 9:30 PM
        
        // Clock out: 8:30 AM - 9:30 AM next day
        clockOutEnd = new Date(shiftDate);
        clockOutEnd.setDate(clockOutEnd.getDate() + 1);
        clockOutEnd.setHours(9, 30, 0, 0); // 9:30 AM next day
    } else {
        // Regular shifts
        const [startHour, startMin] = shift.start_time.split(':').map(Number);
        const [endHour, endMin] = shift.end_time.split(':').map(Number);
        
        shiftStart = new Date(shiftDate);
        shiftStart.setHours(startHour, startMin, 0, 0);
        
        shiftEnd = new Date(shiftDate);
        shiftEnd.setHours(endHour, endMin, 0, 0);
        
        // 30 minute grace periods
        clockInStart = new Date(shiftStart.getTime() - 30 * 60 * 1000);
        clockInEnd = new Date(shiftStart.getTime() + 30 * 60 * 1000);
        clockOutEnd = new Date(shiftEnd.getTime() + 30 * 60 * 1000);
    }
    
    // Check if already clocked in/out
    if (shift.clock_out_time) {
        return SHIFT_STATES.COMPLETED;
    }
    
    if (shift.clock_in_time) {
        // Clocked in but not out
        if (now > clockOutEnd) {
            return SHIFT_STATES.MISSED_CLOCK_OUT; // Missed the clock out window
        }
        if (now > shiftEnd) {
            return SHIFT_STATES.OVERTIME;
        }
        return SHIFT_STATES.IN_PROGRESS;
    }
    
    // Not clocked in yet
    if (now < clockInStart) {
        return SHIFT_STATES.TOO_EARLY;
    }
    
    if (now >= clockInStart && now <= clockInEnd) {
        return SHIFT_STATES.READY_TO_CLOCK_IN;
    }
    
    if (now > clockInEnd && now <= clockOutEnd) {
        // Within shift hours but missed clock in window
        return SHIFT_STATES.MISSED;
    }
    
    if (now > clockOutEnd) {
        return SHIFT_STATES.MISSED_CLOCK_OUT;
    }
    
    return SHIFT_STATES.TOO_EARLY;
}

// Helper function to format time
function formatTime(timeString) {
    if (!timeString) return '';
    
    // If it's already a formatted time, return it
    if (timeString === 'Sleepover') return 'Sleepover';
    
    // Handle ISO datetime strings
    if (timeString.includes('T')) {
        const date = new Date(timeString);
        const hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
        return `${displayHours}:${displayMinutes} ${ampm}`;
    }
    
    // Handle HH:MM format
    const [hours, minutes] = timeString.split(':').map(Number);
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
    return `${displayHours}:${displayMinutes} ${ampm}`;
}

async function loadCurrentShift() {
    if (!currentStaff || !currentStaff.id) {
        console.log('Current staff not loaded yet, skipping shift load');
        return;
    }
    const now = getTestDate();
    const today = now.toISOString().split('T')[0];
    
    const { data: upcomingShifts } = await supabaseClient
        .from('shifts')
        .select(`
            *,
            participant:participant_id(first_name, last_name, address, location_lat, location_lng, location_radius_meters),
            location:location_id(name, address),
            duty_type:duty_type_id(name)
        `)
        .eq('staff_id', currentStaff.id)
        .gte('date', today)
        .lte('date', new Date(now.getTime() + 48*60*60*1000).toISOString().split('T')[0])
        .is('deleted_at', null)
        .order('date')
        .order('start_time')
        .limit(5); // Get more shifts to find next valid one

    const container = document.getElementById('currentShift');
    
    if (!upcomingShifts || upcomingShifts.length === 0) {
        container.innerHTML = `
        <div class="shift-card" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">

<div class="shift-card-header">
                    <div class="shift-time">No shifts today</div>
                    <div class="shift-participant">Enjoy your day off!</div>
                </div>
            </div>
        `;
        return;
    }

    // Find the first shift that isn't missed/completed
    let shiftToShow = null;
    for (const shift of upcomingShifts) {
        const state = getShiftState(shift);
        // Skip shifts that are completed or have missed clock out
        if (state !== SHIFT_STATES.COMPLETED && state !== SHIFT_STATES.MISSED_CLOCK_OUT) {
            shiftToShow = shift;
            break;
        }
    }

    if (!shiftToShow) {
        // All shifts are completed or missed
        container.innerHTML = `
        <div class="shift-card" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                <div class="shift-card-header">
                    <div class="shift-time">No active shifts</div>
                    <div class="shift-participant">All shifts completed</div>
                </div>
            </div>
        `;
        return;
    }

    const shift = shiftToShow;
    const isToday = shift.date === today;
    const isSleepover = !shift.start_time || !shift.end_time || shift.start_time === 'Sleepover';
    const participantName = shift.participant ? 
        `${shift.participant.first_name} ${shift.participant.last_name}` :
        (shift.location?.name || 'Unassigned');
    
    // Determine card background based on shift state
    const state = getShiftState(shift);
    let cardStyle = 'background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);'; // Blue gradient default

    if (shift.clock_in_time && !shift.clock_out_time) {
    cardStyle = 'background: linear-gradient(135deg, #2d5a3d 0%, #3a6b4a 100%);'; // Green gradient when clocked in
}
    container.innerHTML = `
        <div class="shift-card" id="shift-card-${shift.id}" data-shift-id="${shift.id}" style="${cardStyle}">
            <div class="shift-card-header" style="cursor: pointer;">
                <div class="shift-time">
                    ${isSleepover ? 'Sleepover (8PM - 9AM)' : 
                      `${formatTime(shift.start_time)} - ${formatTime(shift.end_time)}`}
                </div>
                <div class="shift-participant">${participantName}</div>
                <div class="shift-location">
                    <i class="fa-solid fa-location-dot"></i> ${shift.location?.name || 'Client Home'}
                </div>
                <div class="shift-status">${isToday ? 'TODAY' : 'TOMORROW'}</div>
            </div>
            <div class="shift-expand-icon">▼</div>
            <div class="shift-details" id="shift-details-${shift.id}">
                <div id="clock-section-${shift.id}"></div>
                ${shift.notes ? `
                    <div class="shift-note">
                        <div class="shift-note-content">${shift.notes}</div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    // Add click handler
    setTimeout(() => {
        const card = document.getElementById(`shift-card-${shift.id}`);
        const cardHeader = card?.querySelector('.shift-card-header');
        const details = document.getElementById(`shift-details-${shift.id}`);
        const icon = card?.querySelector('.shift-expand-icon');
        
        if (cardHeader && details) {
            cardHeader.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                details.classList.toggle('expanded');
                if (icon) {
                    icon.textContent = details.classList.contains('expanded') ? '▲' : '▼';
                }
                
                // Load clock UI when expanding
                if (details.classList.contains('expanded')) {
                    await loadShiftClockingUI(shift.id, shift);
                }
            });
            
            // Auto-expand if shift is in progress
            if (shift.clock_in_time && !shift.clock_out_time) {
                details.classList.add('expanded');
                icon.textContent = '▲';
                loadShiftClockingUI(shift.id, shift);
            }
        }
    }, 100);
    
    // Ensure styles are added
    addClockStyles();
}

function formatTimeNSW(timeString) {
    if (!timeString) return '';
    
    // If it's already a formatted time like "Sleepover", return it
    if (timeString === 'Sleepover') return 'Sleepover';
    
    // Handle ISO datetime strings (from database)
    if (timeString.includes('T') || timeString.includes('-')) {
        const date = new Date(timeString);
        // Convert to NSW timezone
        const nswTime = new Date(date.toLocaleString("en-US", {timeZone: "Australia/Sydney"}));
        const hours = nswTime.getHours();
        const minutes = nswTime.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
        return `${displayHours}:${displayMinutes} ${ampm}`;
    }
    
    // Handle HH:MM format (already in local time)
    const [hours, minutes] = timeString.split(':').map(Number);
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
    return `${displayHours}:${displayMinutes} ${ampm}`;
}

// Updated Clock in handler with NSW timezone
async function handleClockIn(shiftId) {
    console.log('Handling clock in for shift:', shiftId);
    
    const btn = event.target.closest('.clock-btn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="location-spinner"></span> Getting location...';
    }
    
    try {
        // Get current location
        const position = await getCurrentPosition();
        const coords = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
        };
        
        // Get shift details with participant location info
        const { data: shift, error: shiftError } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participant:participant_id(location_lat, location_lng, location_radius_meters, address),
                location:location_id(name, address)
            `)
            .eq('id', shiftId)
            .single();
            
        if (shiftError) throw shiftError;
        
        // Calculate distance if participant has location coordinates
        let distance = null;
        let isWithinRange = true;
        
        if (shift.participant?.location_lat && shift.participant?.location_lng) {
            distance = calculateDistance(
                coords.latitude, 
                coords.longitude,
                shift.participant.location_lat, 
                shift.participant.location_lng
            );
            
            const maxDistance = shift.participant.location_radius_meters || 500;
            isWithinRange = distance <= maxDistance;
        }
        
        // Get address for the current location
        const address = await reverseGeocode(coords.latitude, coords.longitude);
        
        // Store clock-in time in UTC (database handles this)
        const { error: updateError } = await supabaseClient
            .from('shifts')
            .update({
                clock_in_time: new Date().toISOString(),
                clock_in_lat: coords.latitude,
                clock_in_lng: coords.longitude,
                clock_in_address: address,
                clock_in_distance_meters: distance,
                clock_in_location: { 
                    lat: coords.latitude, 
                    lng: coords.longitude, 
                    address: address,
                    distance_meters: distance,
                    within_range: isWithinRange
                }
            })
            .eq('id', shiftId);
            
        if (updateError) throw updateError;
        
        // Reload the shift display
        await loadCurrentShift();
        
        // Show success message if function exists
        if (typeof showNotification === 'function') {
            showNotification('Successfully clocked in!', 'success');
        }
        
    } catch (error) {
        console.error('Clock in error:', error);
        if (typeof showNotification === 'function') {
            showNotification('Failed to clock in. Please try again.', 'error');
        }
        
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-clock"></i> Clock In';
        }
    }
}

// Updated Clock out handler with distance calculation and NSW timezone
async function handleClockOut(shiftId) {
    console.log('Handling clock out for shift:', shiftId);
    
    const btn = event.target.closest('.clock-btn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="location-spinner"></span> Getting location...';
    }
    
    try {
        // Get current location
        const position = await getCurrentPosition();
        const coords = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
        };
        
        // Get shift details with participant location info
        const { data: shift, error: shiftError } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participant:participant_id(location_lat, location_lng, location_radius_meters, address),
                location:location_id(name, address)
            `)
            .eq('id', shiftId)
            .single();
            
        if (shiftError) throw shiftError;
        
        // Calculate distance if participant has location coordinates
        let distance = null;
        let isWithinRange = true;
        
        if (shift.participant?.location_lat && shift.participant?.location_lng) {
            distance = calculateDistance(
                coords.latitude, 
                coords.longitude,
                shift.participant.location_lat, 
                shift.participant.location_lng
            );
            
            const maxDistance = shift.participant.location_radius_meters || 500;
            isWithinRange = distance <= maxDistance;
        }
        
        // Get address
        const address = await reverseGeocode(coords.latitude, coords.longitude);
        
        // Update shift with clock out data - store in UTC
        const { error: updateError } = await supabaseClient
            .from('shifts')
            .update({
                clock_out_time: new Date().toISOString(),
                clock_out_lat: coords.latitude,
                clock_out_lng: coords.longitude,
                clock_out_address: address,
                clock_out_distance_meters: distance, // Now including distance
                clock_out_location: {
                    lat: coords.latitude,
                    lng: coords.longitude,
                    address: address,
                    distance_meters: distance,
                    within_range: isWithinRange
                }
            })
            .eq('id', shiftId);
            
        if (updateError) throw updateError;
        
        // Reload the shift display
        await loadCurrentShift();
        
        // Show success message if function exists
        if (typeof showNotification === 'function') {
            showNotification('Successfully clocked out!', 'success');
        }
        
    } catch (error) {
        console.error('Clock out error:', error);
        if (typeof showNotification === 'function') {
            showNotification('Failed to clock out. Please try again.', 'error');
        }
        
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-clock"></i> Clock Out';
        }
    }
}

async function loadShiftClockingUI(shiftId, shiftData) {
    const clockSection = document.getElementById(`clock-section-${shiftId}`);
    if (!clockSection) return;
    
    // Check if clock-in is required for this shift
    if (shiftData.clock_in_required === false) {
        // Self-submitted shift - no clock-in required
        clockSection.innerHTML = `
            <div class="clock-info-message">
                <i class="fa-solid fa-info-circle"></i>
                <span>Clock-in not required for this shift</span>
            </div>
            <div class="shift-status-info">
                <p class="status-label">Status: ${shiftData.status || 'Pending'}</p>
                <p class="shift-type-label">Self-submitted shift</p>
            </div>
        `;
        return;
    }
    
    // Regular shift with clock-in required
    const now = getTestDate();
    const shiftDate = new Date(shiftData.date);
    const isToday = shiftDate.toDateString() === now.toDateString();
    
    if (!isToday) {
        clockSection.innerHTML = `
            <div class="clock-message">
                <i class="fa-solid fa-clock"></i>
                <span>Clock-in will be available on the day of your shift</span>
            </div>
        `;
        return;
    }
    
    // Determine shift state
    const state = getShiftState(shiftData);
    
    if (shiftData.clock_in_time && !shiftData.clock_out_time) {
        // Currently clocked in
        const clockInTime = new Date(shiftData.clock_in_time);
        const duration = Math.floor((now - clockInTime) / 1000 / 60); // minutes
        const hours = Math.floor(duration / 60);
        const minutes = duration % 60;
        
        clockSection.innerHTML = `
            <div class="clock-status active">
                <div class="clock-status-header">
                    <i class="fa-solid fa-business-time"></i>
                    <span>Currently Working</span>
                </div>
                <div class="clock-info">
                    <p>Clocked in at ${formatTime(shiftData.clock_in_time)}</p>
                    <p>Duration: ${hours}h ${minutes}m</p>
                    ${shiftData.clock_in_address ? `<p class="location-text"><i class="fa-solid fa-location-dot"></i> ${shiftData.clock_in_address}</p>` : ''}
                </div>
                <button class="clock-btn clock-out" onclick="handleClockOut('${shiftId}')">
                    <i class="fa-solid fa-stop"></i> Clock Out
                </button>
            </div>
        `;
    } else if (shiftData.clock_out_time) {
        // Shift completed
        clockSection.innerHTML = `
            <div class="clock-status completed">
                <div class="clock-status-header">
                    <i class="fa-solid fa-check-circle"></i>
                    <span>Shift Completed</span>
                </div>
                <div class="clock-info">
                    <p>Clocked in: ${formatTime(shiftData.clock_in_time)}</p>
                    <p>Clocked out: ${formatTime(shiftData.clock_out_time)}</p>
                </div>
            </div>
        `;
    } else if (state === SHIFT_STATES.READY_TO_CLOCK_IN || state === SHIFT_STATES.CAN_CLOCK_IN_EARLY) {
        // Ready to clock in
        const message = state === SHIFT_STATES.CAN_CLOCK_IN_EARLY ? 
            'You can clock in up to 30 minutes early' : 
            'Ready to start your shift';
            
        clockSection.innerHTML = `
            <div class="clock-ready">
                <p class="clock-message">${message}</p>
                <button class="clock-btn clock-in" onclick="handleClockIn('${shiftId}')">
                    <i class="fa-solid fa-play"></i> Clock In
                </button>
            </div>
        `;
    } else if (state === SHIFT_STATES.TOO_EARLY) {
        const shiftStart = new Date(`${shiftData.date}T${shiftData.start_time}`);
        const thirtyMinBefore = new Date(shiftStart.getTime() - 30 * 60 * 1000);
        const timeUntilCanClock = Math.ceil((thirtyMinBefore - now) / 1000 / 60);
        
        clockSection.innerHTML = `
            <div class="clock-message">
                <i class="fa-solid fa-hourglass-half"></i>
                <span>You can clock in ${timeUntilCanClock} minutes before shift start</span>
            </div>
        `;
    } else {
        // Missed shift or other state
        clockSection.innerHTML = `
            <div class="clock-message warning">
                <i class="fa-solid fa-exclamation-triangle"></i>
                <span>Please contact your supervisor about this shift</span>
            </div>
        `;
    }
}

// Add CSS for the clock info message
function addClockInfoStyles() {
    if (document.getElementById('clock-info-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'clock-info-styles';
    style.textContent = `
        .clock-info-message {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #black;
            margin-bottom: 10px;
        }
        
        .clock-info-message i {
            font-size: 18px;
            color: #64b5f6;
        }
        
        .shift-status-info {
            padding: 10px 16px;
            color: #64b5f6;
        }
        
        .shift-status-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .status-label {
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .shift-type-label {
            font-style: italic;
            color: black;
            font-size: 13px;
        }
        
        .clock-ready, .clock-status, .clock-message {
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .clock-btn {
            margin-top: 10px;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .clock-btn.clock-in {
            background: #4caf50;
            color: white;
        }
        
        .clock-btn.clock-in:hover {
            background: #45a049;
        }
        
        .clock-btn.clock-out {
            background: #f44336;
            color: white;
        }
        
        .clock-btn.clock-out:hover {
            background: #da190b;
        }
    `;
    
    document.head.appendChild(style);
}

// Call this when the page loads
document.addEventListener('DOMContentLoaded', function() {
    addClockInfoStyles();
});


// Helper function to get current position
function getCurrentPosition() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Geolocation not supported'));
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            resolve,
            reject,
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    });
}

// Helper function to calculate distance between two points
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth radius in meters
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180;
    const Δλ = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; // Distance in meters
}

// Update your addClockStyles function to include the note styles
function addClockStyles() {
    if (!document.getElementById('clock-styles')) {
        const styleElement = document.createElement('style');
        styleElement.id = 'clock-styles';
        styleElement.textContent = `
            .shift-card {
                border-radius: 8px;
                color: white;
                margin-bottom: 16px;
                transition: all 0.3s ease;
            }

            .clock-section {
                padding: 15px;
                border-top: 1px solid rgba(255,255,255,0.1);
                margin-top: 10px;
            }

            .clock-status {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 10px;
                background: rgba(255, 255, 255, 0.05);
            }

            .clock-btn {
                width: 100%;
                padding: 12px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.3s ease;
                background: #1976d2;
                color: white;
            }

            .clock-btn:hover {
                background: #1565c0;
            }

            .clock-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .location-info {
                padding: 8px;
                background: rgba(255,255,255,0.05);
                border-radius: 4px;
                font-size: 12px;
                margin-top: 8px;
            }

            .distance {
                display: block;
                font-size: 11px;
                color: rgba(255, 255, 255, 0.7);
                margin-top: 4px;
            }

            .overtime-warning {
                padding: 8px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
                color: #ffd93d;
                text-align: center;
                margin-top: 10px;
                font-size: 12px;
            }

            .shift-details {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .shift-details.expanded {
                max-height: 800px;
            }

            .location-spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255,255,255,.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
            }

            .clock-message {
    font-size: 12px;
    color: rgba(0, 0, 0, 0.8); /* Dark color for contrast */
    font-style: italic;
    margin-top: 8px;
    line-height: 1.4;
}

            .shift-note {
                margin: 15px;
                padding: 12px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 4px;
            }

            .shift-note-content {
    font-size: 14px;
    color: rgba(0, 0, 0, 0.8); /* Dark color for contrast */
    font-style: italic;
    line-height: 1.5;
    white-space: pre-wrap;
}

            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(styleElement);
    }
}


async function enrichRequestData(requests, type) {
    if (!requests || requests.length === 0) return [];
    
    return await Promise.all(requests.map(async req => {
        const shift = shifts.find(s => s.id === req.shift_id);
        const participant = shift ? participants.find(p => p.id === shift.participant_id) : null;
        const location = shift ? locations.find(l => l.id === shift.location_id) : null;
        
        const baseEnrichment = {
            ...req,
            shift: shift ? {
                ...shift,
                participant,
                location,
                participantName: participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    (location?.name || 'Unassigned')
            } : null
        };
        
        if (type === 'transfer') {
            return {
                ...baseEnrichment,
                fromStaff: staff.find(s => s.id === req.from_staff_id),
                toStaff: req.to_staff_id ? staff.find(s => s.id === req.to_staff_id) : null
            };
        } else if (type === 'adjustment') {
            return {
                ...baseEnrichment,
                staff: staff.find(s => s.id === req.staff_id)
            };
        }
        
        return baseEnrichment;
    }));
}

async function requestTransfer(shiftId, targetStaffId = null, notes = '') {
    try {
        console.log('Requesting transfer for shift:', shiftId);
        
        // Step 1: Create the transfer request record
        const { data: transferRequest, error: insertError } = await supabaseClient
            .from('transfer_requests')
            .insert({
                shift_id: shiftId,
                from_staff_id: currentStaff.id,
                to_staff_id: targetStaffId, // null if open to anyone
                status: 'pending',
                reason: notes || 'Personal reason',
                created_at: new Date().toISOString()
            })
            .select()
            .single();
        
        if (insertError) {
            console.error('Error creating transfer request:', insertError);
            showToast('Failed to create transfer request: ' + insertError.message, 'error');
            return;
        }
        
        console.log('Transfer request created:', transferRequest);
        
        // Step 2: Update the shifts table with reference columns
        const { error: updateError } = await supabaseClient
            .from('shifts')
            .update({
                transfer_requested_by: currentStaff.id,
                transfer_status: 'pending',
                transfer_to_staff: targetStaffId, // null if open to anyone
                transfer_notes: notes || null,
                transfer_request_id: transferRequest.id // Link back to the request
            })
            .eq('id', shiftId);
        
        if (updateError) {
            console.error('Error updating shift:', updateError);
            
            // Rollback: delete the transfer request we just created
            await supabaseClient
                .from('transfer_requests')
                .delete()
                .eq('id', transferRequest.id);
            
            showToast('Failed to update shift: ' + updateError.message, 'error');
            return;
        }
        
        showToast('Transfer request submitted successfully', 'success');
        
        // Refresh the timesheet to show updated status
        if (typeof loadTimesheet === 'function') {
            await loadTimesheet();
        }
        
    } catch (err) {
        console.error('Unexpected error:', err);
        showToast('Unexpected error occurred', 'error');
    }
}

function toggleTimeFields() {
    const dutyType = document.getElementById('shiftDutyType');
    const timeFields = document.getElementById('timeFields');
    
    if (dutyType && timeFields) {
        // Hide time fields for sleepover shifts
        if (dutyType.options[dutyType.selectedIndex]?.text?.toLowerCase().includes('sleepover')) {
            timeFields.style.display = 'none';
        } else {
            timeFields.style.display = 'block';
        }
    }
}

function showTransportModal() {
    loadTransportModal();
    ModalManager.show('transport');
}



function showDocumentUploadModal() {
    // Open the document upload modal
    const modal = document.getElementById('documentUploadModal');
    if (modal) {
        modal.classList.add('active');
    } else {
        // If modal doesn't exist, show simple file input
        document.getElementById('documentFile')?.click();
    }
}

async function fetchNotes(participantId) {  // Changed parameter
    try {
        const { data, error } = await supabaseClient
            .from('shift_notes')
            .select(`
                *,
                staff:staff_id(first_name, last_name)
            `)
            .eq('participant_id', participantId)  // Changed from shift_id
            .is('deleted_at', null)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Error fetching notes:', error);
        return [];
    }
}

    
async function logout() {
    try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        window.location.href = 'index.html';
    } catch (error) {
        console.error('Logout error:', error);
        showToast('Failed to logout', 'error');
    }
}



async function buildParticipantLocationMapping() {
    // Clear existing mappings
    participantDefaultLocations.clear();
    careHomeLocations.clear();
    
    // First, identify all care home locations
    if (locations && locations.length > 0) {
        locations.forEach(loc => {
            if (loc.is_care_home) {
                careHomeLocations.add(loc.id);
            }
        });
    }
    
    // Map participants to their default locations based on address
    participants.forEach(p => {
        if (!p.address) return;
        
        const addressLower = p.address.toLowerCase();
        
        // Check for Saunders Care Home
        if (addressLower.includes('saunders')) {
            const saundersLocation = locations.find(loc => 
                loc.name.toLowerCase().includes('saunders') || 
                (loc.address && loc.address.toLowerCase().includes('saunders'))
            );
            
            if (saundersLocation) {
                participantDefaultLocations.set(p.id, saundersLocation.id);
                console.log(`Mapped ${p.first_name} ${p.last_name} to Saunders Care Home`);
            }
        } 
        // Check for other care homes by matching addresses
        else {
            const matchingCareHome = locations.find(loc => {
                if (!loc.is_care_home || !loc.address) return false;
                
                // Extract street/building name from both addresses
                const locStreet = loc.address.toLowerCase().split(',')[0].trim();
                const participantStreet = addressLower.split(',')[0].trim();
                
                // Check if participant's address contains the care home's street
                return participantStreet.includes(locStreet) || locStreet.includes(participantStreet);
            });
            
            if (matchingCareHome) {
                participantDefaultLocations.set(p.id, matchingCareHome.id);
                console.log(`Mapped ${p.first_name} ${p.last_name} to ${matchingCareHome.name}`);
            }
        }
    });
    
    console.log(`Mapped ${participantDefaultLocations.size} participants to care homes`);
}



function onParticipantSelect(participantSelectId, locationSelectId) {
    const participantSelect = document.getElementById(participantSelectId);
    const locationSelect = document.getElementById(locationSelectId);
    
    if (!participantSelect || !locationSelect) return;
    
    const participantId = participantSelect.value;
    
    if (!participantId) {
        locationSelect.value = '';
        return;
    }
    
    // Check if this participant has a default care home location
    if (participantDefaultLocations.has(participantId)) {
        const defaultLocationId = participantDefaultLocations.get(participantId);
        locationSelect.value = defaultLocationId;
        
        const location = locations.find(l => l.id === defaultLocationId);
        console.log(`Auto-selected location: ${location ? location.name : 'Unknown'}`);
        
        // Show a brief notification
        const locationName = location ? location.name : 'care home';
        showToast(`Auto-selected ${locationName}`, 'info');
    } else {
        // Try to select "Client Home" as default for non-care home residents
        const clientHome = locations.find(l => 
            l.name.toLowerCase().includes('client home') || 
            l.id === '00000000-0000-0000-0000-000000000001'
        );
        
        if (clientHome) {
            locationSelect.value = clientHome.id;
            console.log('Auto-selected Client Home as default');
        }
    }
}

function setupParticipantLocationListeners() {
    // For shift creation modal
    const shiftParticipant = document.getElementById('shiftParticipant');
    if (shiftParticipant) {
        shiftParticipant.addEventListener('change', function() {
            onParticipantSelect('shiftParticipant', 'shiftLocation');
        });
    }
    
    // For transfer request modal (if it has location)
    const transferParticipant = document.getElementById('transferParticipant');
    if (transferParticipant) {
        transferParticipant.addEventListener('change', function() {
            // Transfers might not have location, but we can still track it
            console.log('Participant selected for transfer');
        });
    }
    
    // For any edit modals
    const editParticipant = document.getElementById('editShiftParticipant');
    if (editParticipant) {
        editParticipant.addEventListener('change', function() {
            onParticipantSelect('editShiftParticipant', 'editShiftLocation');
        });
    }
}



async function initializeParticipantLocations() {
    // Make sure locations are loaded first
    if (!locations || locations.length === 0) {
        await loadLocations();
    }
    
    // Then load participants with location mapping
    await loadParticipants();
    
    // Setup event listeners
    setupParticipantSelects();
}



async function saveWeeklyAvailability() {
    try {
        const startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        
        // Get next 4 weeks of dates
        const records = [];
        for (let week = 0; week < 4; week++) {
            for (let day = 0; day < 7; day++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + (week * 7) + day);
                
                // Check if this day is marked as available
                const checkbox = document.querySelector(`input[data-day="${day}"][data-week="${week}"]`);
                if (checkbox && checkbox.checked) {
                    records.push({
                        staff_id: currentStaff.id,
                        date: date.toISOString().split('T')[0],
                        is_available: true,
                        start_time: '09:00:00',
                        end_time: '17:00:00',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                }
            }
        }
        
        if (records.length === 0) {
            showToast('Please select at least one available day', 'warning');
            return;
        }
        
        // Clear old availability for this period
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 28);
        
        await supabaseClient
            .from('staff_availability')
            .delete()
            .eq('staff_id', currentStaff.id)
            .gte('date', startDate.toISOString().split('T')[0])
            .lte('date', endDate.toISOString().split('T')[0]);
        
        // Insert new availability
        const { error } = await supabaseClient
            .from('staff_availability')
            .insert(records);
        
        if (error) throw error;
        
        showToast('Weekly availability saved successfully', 'success');
        
    } catch (error) {
        console.error('Error saving weekly availability:', error);
        showToast('Failed to save availability: ' + error.message, 'error');
    }
}


async function loadDocuments() {
    if (!currentStaff) {
        console.log('No current staff to load documents for');
        return;
    }
    
    try {
        // Load documents WITHOUT the join
        const { data: documents, error } = await supabaseClient
            .from('documents')
            .select('*')
            .eq('entity_type', 'staff')
            .eq('entity_id', currentStaff.id)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error loading documents:', error);
            return;
        }
        
        // Load document types separately
        const { data: documentTypes } = await supabaseClient
            .from('document_types')
            .select('*');
        
        // Enrich documents with type information
        if (documents && documentTypes) {
            documents.forEach(doc => {
                doc.document_type = documentTypes.find(t => t.id === doc.type_id);
            });
        }
        
        displayDocuments(documents || []);
        
    } catch (error) {
        console.error('Error in loadDocuments:', error);
        showToast('Failed to load documents', 'error');
    }
}

function displayDocuments(documents) {
    const container = document.getElementById('documentsList');
    if (!container) return;
    
    if (!documents || documents.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-file-alt"></i>
                <p>No documents uploaded yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = documents.map(doc => {
        // Get type info from enriched data
        const typeName = doc.document_type?.name || 'Unknown Type';
        const requiresExpiry = doc.document_type?.requires_expiry || false;
        
        // Check if document is expired
        const isExpired = doc.expiry_date && new Date(doc.expiry_date) < new Date();
        const expiryClass = isExpired ? 'expired' : '';
        const expiryWarning = isExpired ? '<span class="badge danger">Expired</span>' : '';
        
        return `
            <div class="document-item ${expiryClass}">
                <div class="document-info">
                    <h4>${doc.title}</h4>
                    <p class="document-type">${typeName}</p>
                    ${doc.expiry_date ? `
                        <p class="expiry-date">
                            Expires: ${formatDate(doc.expiry_date)}
                            ${expiryWarning}
                        </p>
                    ` : ''}
                    ${doc.notes ? `<p class="notes">${doc.notes}</p>` : ''}
                </div>
                <div class="document-actions">
                    <a href="${doc.file_url}" target="_blank" class="btn btn-sm btn-primary">View</a>
                    <button data-action-with-param="deleteDocument" data-param="${doc.id}" class="btn btn-sm btn-danger">Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

        async function loadAvailability() {
            const { data: availability } = await supabaseClient
                .from('staff_weekly_availability')
                .select('*')
                .eq('staff_id', currentStaff.id);

            if (availability) {
                availability.forEach(slot => {
                    const key = `${slot.day_of_week}_${slot.time_slot}`;
                    weeklyAvailability[key] = slot.available;
                });
            }

            renderAvailability();
        }


        async function approveTransfer(shiftId) {
    try {
        if (!confirm('Accept this shift transfer?')) return;

        // Get the shift details
        const { data: shift } = await supabaseClient
            .from('shifts')
            .select('*')
            .is('deleted_at', null)
            .eq('id', parseInt(shiftId))
            .single();

        if (!shift) {
            showToast('Shift not found', 'error');
            return;
        }

        // Check for conflicts before accepting
        const { data: conflicts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .eq('date', shift.date)
            .is('deleted_at', null);

        if (conflicts && conflicts.length > 0) {
            if (!confirm(`You already have ${conflicts.length} shift(s) on this date. Continue anyway?`)) {
                return;
            }
        }

        // Approve the transfer by updating the shift
        const { error } = await supabaseClient
            .from('shifts')
            .update({
                staff_id: currentStaff.id,  // Take ownership
                transfer_status: 'completed',
                transfer_approved_by: currentStaff.id,
                updated_at: new Date().toISOString()
            })
            .eq('id', parseInt(shiftId));

        if (error) throw error;

        showToast('Transfer accepted successfully', 'success');
        loadTransfers();
        loadDashboard();

    } catch (error) {
        console.error('Error accepting transfer:', error);
        showToast('Failed to accept transfer', 'error');
    }
}

// Helper function to check if a duty type is a sleepover
async function checkIfSleepover(dutyTypeId) {
    if (!dutyTypeId) return false;
    
    const dutyType = dutyTypes.find(dt => dt.id === dutyTypeId);
    if (dutyType) {
        return dutyType.name?.toLowerCase().includes('sleepover');
    }
    
    // Fallback to database query if not in cache
    const { data } = await supabaseClient
        .from('duty_types')
        .select('name')
        .is('deleted_at', null)
        .eq('id', dutyTypeId)
        .single();
    
    return data?.name?.toLowerCase().includes('sleepover') || false;
}


// Helper function to parse time string to minutes for comparison
function parseTime(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
}

// Helper function to calculate shift duration in hours
function calculateShiftDuration(startTime, endTime) {
    const start = parseTime(startTime);
    const end = parseTime(endTime);
    
    // Handle overnight shifts
    const duration = end > start ? end - start : (1440 - start) + end;
    return duration / 60;
}

async function displayShiftNotes(participantId) {  // Changed parameter
    const container = document.getElementById('shiftNotesList');
    if (!container) return;
    
    const notes = await fetchNotes(participantId);  // Pass participant ID
    
    if (notes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-sticky-note"></i>
                <p>No notes for this participant</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = notes.map(note => `
        <div class="note-item">
            <div class="note-header">
                <span class="note-type badge">${note.note_type || 'General'}</span>
                <span class="note-author">${note.staff?.first_name || 'Unknown'} ${note.staff?.last_name || ''}</span>
            </div>
            <div class="note-content">${escapeHtml(note.note)}</div>
            <div class="note-footer">
                <span class="note-time">${formatDateTime(note.created_at)}</span>
                ${note.staff_id === currentStaff.id ? `
                    <button data-action-with-param="deleteNote" data-param="${note.id}" class="btn-delete-note">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
}

async function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('shift_notes')
            .update({ deleted_at: new Date().toISOString() })
            .eq('id', noteId)
            .eq('staff_id', currentStaff.id);
        
        if (error) throw error;
        
        showToast('Note deleted successfully', 'success');
        
        if (typeof refreshCurrentView === 'function') {
            refreshCurrentView();
        }
        
    } catch (error) {
        console.error('Error deleting note:', error);
        showToast('Failed to delete note', 'error');
    }
}



function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function checkShiftHasNotes(participantId) {  // Changed parameter
    const { count, error } = await supabaseClient
        .from('shift_notes')
        .select('*', { count: 'exact', head: true })
        .eq('participant_id', participantId)  // Changed to participant_id
        .is('deleted_at', null);
    
    return count > 0;
}

function populateLocationDropdown() {
    const select = document.getElementById('shiftLocation');
    if (!select || !locations) return;
    
    select.innerHTML = '<option value="">Select Location</option>';
    
    // Group by care home status
    const careHomes = locations.filter(l => l.is_care_home);
    const otherLocations = locations.filter(l => !l.is_care_home);
    
    if (careHomes.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Care Homes';
        careHomes.forEach(l => {
            const option = document.createElement('option');
            option.value = l.id;
            option.textContent = l.name;
            optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
    }
    
    if (otherLocations.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Other Locations';
        otherLocations.forEach(l => {
            const option = document.createElement('option');
            option.value = l.id;
            option.textContent = l.name;
            optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
    }
}

function showAddShiftModal() {
    populateShiftModalDropdowns();
    ModalManager.show('addShift');
}




function showTransferModal() {
    loadTransferableShifts();
    ModalManager.show('transfer');
}

async function loadTransferableShifts() {
    try {
        const today = getTestDate();
        today.setHours(0, 0, 0, 0);
        
        const fourteenDaysFromNow = new Date(today);
        fourteenDaysFromNow.setDate(fourteenDaysFromNow.getDate() + 14);
        
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                id,
                date,
                start_time,
                end_time,
                participant_id,
                duty_type_id,
                participant:participants(first_name, last_name),
                duty_type:duty_types(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', today.toISOString().split('T')[0])
            .lte('date', fourteenDaysFromNow.toISOString().split('T')[0])
            .is('deleted_at', null)
            .order('date', { ascending: true });

        if (error) throw error;

        const select = document.getElementById('transferShiftSelect');
        select.innerHTML = '<option value="">Select a shift to transfer</option>';
        
        if (!shifts || shifts.length === 0) {
            select.innerHTML += '<option value="" disabled>No upcoming shifts to transfer</option>';
            return;
        }
        
        shifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id;
            option.dataset.participantId = shift.participant_id;
            
            const date = new Date(shift.date);
            const dayName = date.toLocaleDateString('en-AU', { weekday: 'short' });
            const day = date.getDate();
            const month = date.toLocaleDateString('en-AU', { month: 'short' });
            
            const participantName = shift.participant 
                ? `${shift.participant.first_name} ${shift.participant.last_name}`
                : 'Unassigned';
            
            const isSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover') || false;
            
            let timeRange = '';
            if (!isSleepover && shift.start_time && shift.end_time) {
                const startTime = formatTimeDisplay(shift.start_time);
                const endTime = formatTimeDisplay(shift.end_time);
                timeRange = `, ${startTime}-${endTime}`;
            } else if (isSleepover) {
                timeRange = ', Sleepover';
            }
            
            option.textContent = `${dayName} ${day} ${month} - ${participantName}${timeRange}`;
            option.dataset.date = shift.date;
            option.dataset.startTime = shift.start_time || '';
            option.dataset.endTime = shift.end_time || '';
            option.dataset.isSleepover = isSleepover.toString();
            
            select.appendChild(option);
        });
        
        // Add change listener to update staff options
        select.addEventListener('change', updateTransferStaffOptions);
        
    } catch (error) {
        console.error('Error loading transferable shifts:', error);
        showToast('Failed to load shifts', 'error');
    }
}

async function updateTransferStaffOptions() {
    const shiftSelect = document.getElementById('transferShiftSelect');
    const selectedOption = shiftSelect.options[shiftSelect.selectedIndex];
    
    if (!selectedOption || !selectedOption.value) {
        document.getElementById('transferToStaff').innerHTML = '<option value="">Select a shift first</option>';
        return;
    }
    
    const participantId = selectedOption.dataset.participantId;
    
    try {
        // Get all staff assigned to this participant
        const { data: assignments, error } = await supabaseClient
            .from('staff_participant_assignments')
            .select('staff_id')
            .eq('participant_id', participantId)
            .neq('staff_id', currentStaff.id);
        
        if (error) throw error;
        
        const staffSelect = document.getElementById('transferToStaff');
        staffSelect.innerHTML = '<option value="">Select staff member</option>';
        
        if (assignments && assignments.length > 0) {
            // Get all staff in one query
            const staffIds = assignments.map(a => a.staff_id);
            
            const { data: staffMembers } = await supabaseClient
                .from('staff')
                .select('id, first_name, last_name, is_active')
                .in('id', staffIds)
                .eq('is_active', true);
            
            if (staffMembers) {
                staffMembers.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = `${staff.first_name} ${staff.last_name}`;
                    staffSelect.appendChild(option);
                });
            }
        } else {
            staffSelect.innerHTML = '<option value="" disabled>No other staff assigned to this participant</option>';
        }
        
        staffSelect.onchange = checkTransferConflicts;
        
    } catch (error) {
        console.error('Error loading staff:', error);
        showToast('Failed to load available staff', 'error');
    }
}

async function checkTransferConflicts() {
    const shiftSelect = document.getElementById('transferShiftSelect');
    const targetStaffId = document.getElementById('transferToStaff').value;
    
    if (!shiftSelect.value || !targetStaffId) {
        document.getElementById('transferConflictWarning').style.display = 'none';
        return;
    }
    
    const selectedShift = shiftSelect.options[shiftSelect.selectedIndex];
    const shiftDate = selectedShift.dataset.date;
    const shiftStart = selectedShift.dataset.startTime;
    const shiftEnd = selectedShift.dataset.endTime;
    const isSleepover = selectedShift.dataset.isSleepover === 'true';
    
    const { data: targetShifts, error } = await supabaseClient
        .from('shifts')
        .select(`
            id, 
            start_time, 
            end_time,
            duty_type:duty_types(name)
        `)
        .eq('staff_id', targetStaffId)
        .eq('date', shiftDate)
        .is('deleted_at', null);
    
    if (error) {
        console.error('Error checking conflicts:', error);
        return;
    }
    
    const warningDiv = document.getElementById('transferConflictWarning');
    let hasConflict = false;
    let requiresApproval = false;
    let conflictMessage = '';
    
    if (targetShifts && targetShifts.length > 0) {
        for (const existingShift of targetShifts) {
            const existingIsSleepover = existingShift.duty_type?.name?.toLowerCase().includes('sleepover');
            
            // Check if either is a sleepover
            if (isSleepover || existingIsSleepover) {
                hasConflict = true;
                conflictMessage = '⛔ Cannot transfer: Selected staff already has a shift on this date (sleepover conflict)';
                break;
            }
            
            if (shiftStart && shiftEnd && existingShift.start_time && existingShift.end_time) {
                const newStart = parseTimeToMinutes(shiftStart);
                const newEnd = parseTimeToMinutes(shiftEnd);
                const existingStart = parseTimeToMinutes(existingShift.start_time);
                const existingEnd = parseTimeToMinutes(existingShift.end_time);
                
                // Check for direct overlap
                if (!(newEnd <= existingStart || newStart >= existingEnd)) {
                    hasConflict = true;
                    conflictMessage = `⛔ Cannot transfer: Overlaps with existing shift (${formatTimeDisplay(existingShift.start_time)}-${formatTimeDisplay(existingShift.end_time)})`;
                    break;
                }
                
                // Check for 1-hour buffer
                const gapBefore = newStart - existingEnd;
                const gapAfter = existingStart - newEnd;
                
                if ((gapBefore >= 0 && gapBefore < 60) || (gapAfter >= 0 && gapAfter < 60)) {
                    requiresApproval = true;
                    conflictMessage = `⚠️ Warning: Less than 1 hour gap with existing shift (${formatTimeDisplay(existingShift.start_time)}-${formatTimeDisplay(existingShift.end_time)}). Transfer requires manager approval.`;
                }
            }
        }
    }
    
    if (hasConflict) {
        warningDiv.innerHTML = `<div class="alert alert-danger">${conflictMessage}</div>`;
        warningDiv.style.display = 'block';
        document.querySelector('[data-action="submitTransfer"]').disabled = true;
    } else if (requiresApproval) {
        warningDiv.innerHTML = `<div class="alert alert-warning">${conflictMessage}</div>`;
        warningDiv.style.display = 'block';
        document.querySelector('[data-action="submitTransfer"]').disabled = false;
        // Store that this requires approval
        window.transferRequiresApproval = true;
    } else {
        warningDiv.style.display = 'none';
        document.querySelector('[data-action="submitTransfer"]').disabled = false;
        window.transferRequiresApproval = false;
    }
}

// Helper function to parse time
function parseTimeToMinutes(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
}

async function submitTransfer() {
    try {
        const shiftId = document.getElementById('transferShiftSelect').value;
        const toStaffId = document.getElementById('transferToStaff').value;
        const reason = document.getElementById('transferReason').value;
        
        if (!shiftId) {
            showToast('Please select a shift to transfer', 'error');
            return;
        }
        
        // Reason is required, but toStaffId is optional (open transfer)
        if (!reason) {
            showToast('Please provide a reason for the transfer', 'error');
            return;
        }
        
        // Create transfer request
        const transferData = {
            shift_id: parseInt(shiftId),
            from_staff_id: currentStaff.id,
            to_staff_id: toStaffId || null, // null means open to all eligible staff
            status: 'pending', // Always pending initially
            reason: reason,
            created_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('transfer_requests')
            .insert(transferData)
            .select()
            .single();
        
        if (error) {
            console.error('Transfer request error:', error);
            showToast('Failed to submit transfer request', 'error');
            return;
        }
        
        // Update shift transfer status
        const { error: updateError } = await supabaseClient
            .from('shifts')
            .update({
                transfer_status: 'requested',
                updated_at: new Date().toISOString()
            })
            .eq('id', parseInt(shiftId));
        
        if (updateError) {
            console.error('Error updating shift status:', updateError);
        }
        
        // Success message
        const message = toStaffId 
            ? 'Transfer request sent to staff member' 
            : 'Transfer request posted - available to all eligible staff';
        
        showToast(message, 'success');
        closeModal('transferShiftModal');
        document.getElementById('transferForm').reset();
        document.getElementById('transferToStaff').value = '';
        
        // Refresh displays
        if (typeof loadMyRequests === 'function') {
            await loadMyRequests();
        }
        if (typeof loadSchedule === 'function') {
            await loadSchedule();
        }
        
    } catch (error) {
        console.error('Error submitting transfer:', error);
        showToast('Failed to submit transfer request', 'error');
    }
}
function showAdjustmentModal() {
    loadAdjustmentShifts();
    ModalManager.show('adjustment');
}

function showLeaveModal() {
    ModalManager.show('leave');
}

// ==========================================
// REQUESTS SECTION - COMPLETE REPLACEMENT
// ==========================================

// Initialize requests tabs when switching to requests section
function initializeRequestsTabs() {
    if (window.requestsTabsInitialized) return;
    
    document.querySelectorAll('[data-transfer-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.transferTab;
            
            // Update active tab
            document.querySelectorAll('.transfer-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Hide ALL content areas first
            document.getElementById('incomingRequests').classList.remove('active');
            document.getElementById('myRequestsContent').classList.remove('active');
            document.getElementById('availableContent').classList.remove('active');
            
            // Show only the selected content
            switch(tabName) {
                case 'incoming':
                    document.getElementById('incomingRequests').classList.add('active');
                    loadIncomingRequests();
                    break;
                case 'my-requests':
                    document.getElementById('myRequestsContent').classList.add('active');
                    loadMyRequests();
                    break;
                case 'available':
                    document.getElementById('availableContent').classList.add('active');
                    loadAvailableShifts();
                    break;
            }
        });
    });
    
    window.requestsTabsInitialized = true;
}

// Add these global variables at the top of your team.html file
let staffLeaveFilter = 'all'; // 'pending', 'approved', 'rejected', 'all'
let staffShiftFilter = 'pending'; // 'pending', 'rejected' only (no approved for shifts)
let staffAdjustmentFilter = 'all'; // 'pending', 'approved', 'rejected', 'all'

async function loadMyRequests() {
    const container = document.getElementById('myRequestsList');
    if (!container) return;
    
    try {
        // Build queries with filters
        let transportQuery = supabaseClient
            .from('transport_claims')
            .select(`
                *,
                shift:shift_id(
                    date,
                    participants(first_name, last_name)
                )
            `)
            .eq('staff_id', currentStaff.id)
            .order('date', { ascending: false })
            .limit(50);
        
        if (staffClaimFilter !== 'all') {
            transportQuery = transportQuery.eq('status', staffClaimFilter);
        }
        
        let leaveQuery = supabaseClient
            .from('leave_requests')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .order('created_at', { ascending: false });
        
        if (staffLeaveFilter !== 'all') {
            leaveQuery = leaveQuery.eq('status', staffLeaveFilter);
        }
        
        let shiftsQuery = supabaseClient
            .from('shifts')
            .select('*, participants(first_name, last_name), duty_types(name)')
            .eq('staff_id', currentStaff.id)
            .in('status', staffShiftFilter === 'rejected' ? ['rejected'] : ['pending'])
            .order('date', { ascending: false });
        
        let adjustmentQuery = supabaseClient
            .from('shift_adjustment_requests')
            .select(`
                *,
                shift:shift_id(
                    date,
                    start_time,
                    end_time,
                    participants(first_name, last_name),
                    duty_types(name)
                )
            `)
            .eq('staff_id', currentStaff.id)
            .order('created_at', { ascending: false });
        
        if (staffAdjustmentFilter !== 'all') {
            adjustmentQuery = adjustmentQuery.eq('status', staffAdjustmentFilter);
        }
        
        // Load all data
        const [shifts, leave, transport, holidays, adjustments] = await Promise.all([
            shiftsQuery,
            leaveQuery,
            transportQuery,
            supabaseClient
                .from('school_holidays')
                .select('*')
                .eq('staff_id', currentStaff.id)
                .order('created_at', { ascending: false }),
            adjustmentQuery
        ]);
        
        let html = '<div class="shift-list">';
        
        // ==========================================
        // SHIFT REQUESTS SECTION
        // ==========================================
        html += `
            <div class="shift-group">
                <div class="shift-group-header">
                    <span>Shift Requests</span>
                    <span class="shift-count">${shifts.data?.length || 0}</span>
                </div>
                
                <div class="claims-filter-container" style="
                    display: flex;
                    gap: 8px;
                    margin: 10px 0;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    flex-wrap: wrap;
                    align-items: center;
                ">
                    <span style="font-size: 12px; font-weight: 600; color: #666; margin-right: 8px;">View:</span>
                    <button 
                        class="claim-filter-btn ${staffShiftFilter === 'pending' ? 'active' : ''}" 
                        onclick="filterStaffShifts('pending')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffShiftFilter === 'pending' ? '#ff9800' : '#ddd'};
                            background: ${staffShiftFilter === 'pending' ? '#ff9800' : 'white'};
                            color: ${staffShiftFilter === 'pending' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        Pending
                    </button>
                    <button 
                        class="claim-filter-btn ${staffShiftFilter === 'rejected' ? 'active' : ''}" 
                        onclick="filterStaffShifts('rejected')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffShiftFilter === 'rejected' ? '#dc3545' : '#ddd'};
                            background: ${staffShiftFilter === 'rejected' ? '#dc3545' : 'white'};
                            color: ${staffShiftFilter === 'rejected' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        Rejected
                    </button>
                </div>`;
        
        if (shifts.data?.length > 0) {
            shifts.data.forEach(shift => {
                const statusColor = shift.status === 'rejected' ? '#dc3545' : '#ff9800';
                const statusBg = shift.status === 'rejected' ? '#f8d7da' : '#fff3cd';
                const dutyType = shift.duty_types?.name || 'Regular';
                
                html += `
                    <div class="shift-list-item" style="border-left: 3px solid ${statusColor};">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${formatDateShort(shift.date)} - 
                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                                ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                                ${dutyType !== 'Regular' ? `<span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">${dutyType}</span>` : ''}
                            </div>
                            <div class="shift-client">
                                ${shift.participants?.first_name || ''} ${shift.participants?.last_name || 'Unassigned'}
                            </div>
                            <div class="shift-location">
                                <span class="status-badge" style="
                                    background: ${statusBg};
                                    color: ${statusColor};
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    font-size: 11px;
                                    font-weight: 600;
                                    text-transform: capitalize;
                                ">${shift.status}</span>
                            </div>
                        </div>
                    </div>`;
            });
        } else {
            html += `<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">
                ${staffShiftFilter === 'pending' ? 'No pending shift requests' : 'No rejected shift requests'}
            </div>`;
        }
        html += '</div>';
        
        // ==========================================
        // LEAVE REQUESTS SECTION
        // ==========================================
        html += `
            <div class="shift-group">
                <div class="shift-group-header">
                    <span>Leave Requests</span>
                    <span class="shift-count">${leave.data?.length || 0}</span>
                </div>
                
                <div class="claims-filter-container" style="
                    display: flex;
                    gap: 8px;
                    margin: 10px 0;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    flex-wrap: wrap;
                    align-items: center;
                ">
                    <span style="font-size: 12px; font-weight: 600; color: #666; margin-right: 8px;">View:</span>
                    <button 
                        class="claim-filter-btn ${staffLeaveFilter === 'all' ? 'active' : ''}" 
                        onclick="filterStaffLeave('all')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffLeaveFilter === 'all' ? '#4CAF50' : '#ddd'};
                            background: ${staffLeaveFilter === 'all' ? '#4CAF50' : 'white'};
                            color: ${staffLeaveFilter === 'all' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        All Leave
                    </button>
                    <button 
                        class="claim-filter-btn ${staffLeaveFilter === 'pending' ? 'active' : ''}" 
                        onclick="filterStaffLeave('pending')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffLeaveFilter === 'pending' ? '#ff9800' : '#ddd'};
                            background: ${staffLeaveFilter === 'pending' ? '#ff9800' : 'white'};
                            color: ${staffLeaveFilter === 'pending' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        Pending
                    </button>
                    <button 
                        class="claim-filter-btn ${staffLeaveFilter === 'approved' ? 'active' : ''}" 
                        onclick="filterStaffLeave('approved')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffLeaveFilter === 'approved' ? '#28a745' : '#ddd'};
                            background: ${staffLeaveFilter === 'approved' ? '#28a745' : 'white'};
                            color: ${staffLeaveFilter === 'approved' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        Approved
                    </button>
                    <button 
                        class="claim-filter-btn ${staffLeaveFilter === 'rejected' ? 'active' : ''}" 
                        onclick="filterStaffLeave('rejected')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffLeaveFilter === 'rejected' ? '#dc3545' : '#ddd'};
                            background: ${staffLeaveFilter === 'rejected' ? '#dc3545' : 'white'};
                            color: ${staffLeaveFilter === 'rejected' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        Rejected
                    </button>
                </div>`;
        
        if (leave.data?.length > 0) {
            leave.data.forEach(req => {
                let statusColor = '#666';
                let statusBg = '#f0f0f0';
                if (req.status === 'approved') {
                    statusColor = '#28a745';
                    statusBg = '#d4edda';
                } else if (req.status === 'pending') {
                    statusColor = '#ff9800';
                    statusBg = '#fff3cd';
                } else if (req.status === 'rejected') {
                    statusColor = '#dc3545';
                    statusBg = '#f8d7da';
                }
                
                html += `
                    <div class="shift-list-item" style="border-left: 3px solid ${statusColor};">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${formatDateShort(req.start_date)} - ${formatDateShort(req.end_date)}
                                <span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">${req.leave_type || 'Leave'}</span>
                            </div>
                            ${req.reason ? `<div class="shift-client">${req.reason}</div>` : ''}
                            <div class="shift-location">
                                <span class="status-badge" style="
                                    background: ${statusBg};
                                    color: ${statusColor};
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    font-size: 11px;
                                    font-weight: 600;
                                    text-transform: capitalize;
                                ">${req.status}</span>
                            </div>
                        </div>
                    </div>`;
            });
        } else {
            html += `<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">
                ${staffLeaveFilter === 'all' ? 'No leave requests' : 
                  staffLeaveFilter === 'pending' ? 'No pending leave requests' :
                  staffLeaveFilter === 'approved' ? 'No approved leave requests' :
                  'No rejected leave requests'}
            </div>`;
        }
        html += '</div>';
        
        // ==========================================
        // TRANSPORT CLAIMS SECTION
        // ==========================================
        html += `
            <div class="shift-group">
                <div class="shift-group-header">
                    <span>Transport Claims</span>
                    <span class="shift-count">${transport.data?.length || 0}</span>
                </div>
                
                <div class="claims-filter-container" style="
                    display: flex;
                    gap: 8px;
                    margin: 10px 0;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    flex-wrap: wrap;
                    align-items: center;
                ">
                    <span style="font-size: 12px; font-weight: 600; color: #666; margin-right: 8px;">View:</span>
                    <button 
                        class="claim-filter-btn ${staffClaimFilter === 'all' ? 'active' : ''}" 
                        onclick="filterStaffClaims('all')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffClaimFilter === 'all' ? '#4CAF50' : '#ddd'};
                            background: ${staffClaimFilter === 'all' ? '#4CAF50' : 'white'};
                            color: ${staffClaimFilter === 'all' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        All Claims
                    </button>
                    <button 
                        class="claim-filter-btn ${staffClaimFilter === 'pending' ? 'active' : ''}" 
                        onclick="filterStaffClaims('pending')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffClaimFilter === 'pending' ? '#ff9800' : '#ddd'};
                            background: ${staffClaimFilter === 'pending' ? '#ff9800' : 'white'};
                            color: ${staffClaimFilter === 'pending' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        Pending
                    </button>
                    <button 
                        class="claim-filter-btn ${staffClaimFilter === 'approved' ? 'active' : ''}" 
                        onclick="filterStaffClaims('approved')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffClaimFilter === 'approved' ? '#28a745' : '#ddd'};
                            background: ${staffClaimFilter === 'approved' ? '#28a745' : 'white'};
                            color: ${staffClaimFilter === 'approved' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        Approved
                    </button>
                    <button 
                        class="claim-filter-btn ${staffClaimFilter === 'rejected' ? 'active' : ''}" 
                        onclick="filterStaffClaims('rejected')"
                        style="
                            padding: 6px 12px;
                            border: 1px solid ${staffClaimFilter === 'rejected' ? '#dc3545' : '#ddd'};
                            background: ${staffClaimFilter === 'rejected' ? '#dc3545' : 'white'};
                            color: ${staffClaimFilter === 'rejected' ? 'white' : '#666'};
                            border-radius: 20px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                        Rejected
                    </button>
                </div>`;
        
        if (transport.data?.length > 0) {
            // Calculate totals
            const totalAmount = transport.data.reduce((sum, claim) => sum + (claim.total_claim || 0), 0);
            const totalKm = transport.data.reduce((sum, claim) => sum + (claim.total_km || 0), 0);
            
            // Summary stats
            html += `
                <div style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                    gap: 10px;
                    margin-bottom: 10px;
                    padding: 10px;
                    background: #f0f4f8;
                    border-radius: 8px;
                    font-size: 12px;
                ">
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 4px;">Total Claims</div>
                        <div style="font-weight: bold; color: #333;">${transport.data.length}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 4px;">Total KM</div>
                        <div style="font-weight: bold; color: #333;">${totalKm.toFixed(0)} km</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 4px;">Total Amount</div>
                        <div style="font-weight: bold; color: #4CAF50;">$${totalAmount.toFixed(2)}</div>
                    </div>
                </div>`;
            
            // Claims list
            transport.data.forEach(claim => {
                let statusColor = '#666';
                let statusBg = '#f0f0f0';
                if (claim.status === 'approved') {
                    statusColor = '#28a745';
                    statusBg = '#d4edda';
                } else if (claim.status === 'pending') {
                    statusColor = '#ff9800';
                    statusBg = '#fff3cd';
                } else if (claim.status === 'rejected') {
                    statusColor = '#dc3545';
                    statusBg = '#f8d7da';
                }
                
                const participantName = claim.shift?.participants ? 
                    `${claim.shift.participants.first_name} ${claim.shift.participants.last_name}` : 
                    'Not linked to shift';
                
                html += `
                    <div class="shift-list-item" style="border-left: 3px solid ${statusColor};">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${formatDateShort(claim.date)}
                                <span style="margin-left: 8px; font-size: 14px; color: #4CAF50; font-weight: 600;">$${claim.total_claim?.toFixed(2) || '0.00'}</span>
                            </div>
                            <div class="shift-client">
                                ${claim.kilometres || 0}km claimed${claim.shift?.participants ? ` - ${participantName}` : ''}
                            </div>
                            <div class="shift-location">
                                <span class="status-badge" style="
                                    background: ${statusBg};
                                    color: ${statusColor};
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    font-size: 11px;
                                    font-weight: 600;
                                    text-transform: capitalize;
                                ">${claim.status || 'submitted'}</span>
                                ${claim.evidence_url ? 
                                    `<span style="margin-left: 8px; font-size: 11px; color: #666;">
                                        <i class="fas fa-paperclip"></i> Evidence
                                    </span>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
        } else {
            html += `
                <div style="
                    text-align: center;
                    padding: 20px;
                    color: #999;
                    font-size: 14px;
                ">
                    ${staffClaimFilter === 'all' ? 'No transport claims found' : 
                      staffClaimFilter === 'pending' ? 'No pending claims' :
                      staffClaimFilter === 'approved' ? 'No approved claims' :
                      'No rejected claims'}
                </div>`;
        }
        html += '</div>';
        
        // ==========================================
        // SHIFT ADJUSTMENT REQUESTS SECTION
        // ==========================================
        if (adjustments.data?.length > 0 || staffAdjustmentFilter !== 'all') {
    html += `
        <div class="shift-group">
            <div class="shift-group-header">
                <span>Shift Adjustment Requests</span>
                <span class="shift-count">${adjustments.data?.length || 0}</span>
            </div>
            
            <div class="claims-filter-container" style="
                display: flex;
                gap: 8px;
                margin: 10px 0;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
                flex-wrap: wrap;
                align-items: center;
            ">
                <span style="font-size: 12px; font-weight: 600; color: #666; margin-right: 8px;">View:</span>
                <button 
                    class="claim-filter-btn ${staffAdjustmentFilter === 'all' ? 'active' : ''}" 
                    onclick="filterStaffAdjustments('all')"
                    style="
                        padding: 6px 12px;
                        border: 1px solid ${staffAdjustmentFilter === 'all' ? '#4CAF50' : '#ddd'};
                        background: ${staffAdjustmentFilter === 'all' ? '#4CAF50' : 'white'};
                        color: ${staffAdjustmentFilter === 'all' ? 'white' : '#666'};
                        border-radius: 20px;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">
                    All Adjustments
                </button>
                <button 
                    class="claim-filter-btn ${staffAdjustmentFilter === 'pending' ? 'active' : ''}" 
                    onclick="filterStaffAdjustments('pending')"
                    style="
                        padding: 6px 12px;
                        border: 1px solid ${staffAdjustmentFilter === 'pending' ? '#ff9800' : '#ddd'};
                        background: ${staffAdjustmentFilter === 'pending' ? '#ff9800' : 'white'};
                        color: ${staffAdjustmentFilter === 'pending' ? 'white' : '#666'};
                        border-radius: 20px;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">
                    Pending
                </button>
                <button 
                    class="claim-filter-btn ${staffAdjustmentFilter === 'approved' ? 'active' : ''}" 
                    onclick="filterStaffAdjustments('approved')"
                    style="
                        padding: 6px 12px;
                        border: 1px solid ${staffAdjustmentFilter === 'approved' ? '#28a745' : '#ddd'};
                        background: ${staffAdjustmentFilter === 'approved' ? '#28a745' : 'white'};
                        color: ${staffAdjustmentFilter === 'approved' ? 'white' : '#666'};
                        border-radius: 20px;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">
                    Approved
                </button>
                <button 
                    class="claim-filter-btn ${staffAdjustmentFilter === 'rejected' ? 'active' : ''}" 
                    onclick="filterStaffAdjustments('rejected')"
                    style="
                        padding: 6px 12px;
                        border: 1px solid ${staffAdjustmentFilter === 'rejected' ? '#dc3545' : '#ddd'};
                        background: ${staffAdjustmentFilter === 'rejected' ? '#dc3545' : 'white'};
                        color: ${staffAdjustmentFilter === 'rejected' ? 'white' : '#666'};
                        border-radius: 20px;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">
                    Rejected
                </button>
            </div>`;
    
    if (adjustments.data?.length > 0) {
        adjustments.data.forEach(adjustment => {
            let statusColor = '#666';
            let statusBg = '#f0f0f0';
            if (adjustment.status === 'approved') {
                statusColor = '#28a745';
                statusBg = '#d4edda';
            } else if (adjustment.status === 'pending') {
                statusColor = '#ff9800';
                statusBg = '#fff3cd';
            } else if (adjustment.status === 'rejected') {
                statusColor = '#dc3545';
                statusBg = '#f8d7da';
            }
            
            const shift = adjustment.shift;
            const dutyType = shift?.duty_types?.name || 'Regular';
            
            html += `
                <div class="shift-list-item" style="border-left: 3px solid ${statusColor};">
                    <div class="shift-info">
                        <div class="shift-date-time">
                            ${shift ? formatDateShort(shift.date) : 'N/A'}
                            <span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">${adjustment.adjustment_type || 'Time Change'}</span>
                        </div>
                        <div class="shift-client">
                            ${shift?.participants ? 
                                `${shift.participants.first_name} ${shift.participants.last_name}` : 
                                'Unknown Client'}
                            ${dutyType !== 'Regular' ? ` - ${dutyType}` : ''}
                        </div>
                        <div class="shift-location" style="font-size: 13px; color: #666; margin-top: 4px;">
                            <span style="font-weight: 600;">Original:</span> 
                            ${shift?.start_time ? formatTime12Hour(shift.start_time) : 'N/A'} - 
                            ${shift?.end_time ? formatTime12Hour(shift.end_time) : 'N/A'}
                        </div>
                        <div class="shift-location" style="font-size: 13px; color: #2196F3; font-weight: 600; margin-top: 2px;">
                            <span>Requested:</span> 
                            ${adjustment.new_start_time ? formatTime12Hour(adjustment.new_start_time) : 'N/A'} - 
                            ${adjustment.new_end_time ? formatTime12Hour(adjustment.new_end_time) : 'N/A'}
                        </div>
                        ${adjustment.reason ? `
                            <div class="shift-location" style="font-size: 12px; color: #888; font-style: italic; margin-top: 6px;">
                                "${adjustment.reason}"
                            </div>
                        ` : ''}
                        <div class="shift-location" style="margin-top: 8px;">
                            <span class="status-badge" style="
                                background: ${statusBg};
                                color: ${statusColor};
                                padding: 4px 8px;
                                border-radius: 4px;
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: capitalize;
                            ">${adjustment.status}</span>
                        </div>
                    </div>
                </div>`;
        });
    } else {
        html += `<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">
            ${staffAdjustmentFilter === 'all' ? 'No shift adjustment requests' : 
              staffAdjustmentFilter === 'pending' ? 'No pending adjustment requests' :
              staffAdjustmentFilter === 'approved' ? 'No approved adjustment requests' :
              'No rejected adjustment requests'}
        </div>`;
    }
    html += '</div>';
}
        
        // ==========================================
        // SCHOOL HOLIDAYS SECTION
        // ==========================================
        if (holidays.data?.length > 0) {
            html += `
                <div class="shift-group">
                    <div class="shift-group-header">
                        <span>School Holidays</span>
                        <span class="shift-count">${holidays.data.length}</span>
                    </div>`;
            
            holidays.data.forEach(holiday => {
                let statusColor = '#666';
                let statusBg = '#f0f0f0';
                if (holiday.status === 'approved') {
                    statusColor = '#28a745';
                    statusBg = '#d4edda';
                } else if (holiday.status === 'pending') {
                    statusColor = '#ff9800';
                    statusBg = '#fff3cd';
                } else if (holiday.status === 'rejected') {
                    statusColor = '#dc3545';
                    statusBg = '#f8d7da';
                }
                
                html += `
                    <div class="shift-list-item" style="border-left: 3px solid ${statusColor};">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${formatDateShort(holiday.start_date)} - ${formatDateShort(holiday.end_date)}
                                <span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">School Holiday</span>
                            </div>
                            <div class="shift-location">
                                <span class="status-badge" style="
                                    background: ${statusBg};
                                    color: ${statusColor};
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    font-size: 11px;
                                    font-weight: 600;
                                    text-transform: capitalize;
                                ">${holiday.status}</span>
                            </div>
                        </div>
                    </div>`;
            });
            html += '</div>';
        }
        
        html += '</div>';
        
        container.innerHTML = html || '<p class="no-data">No requests submitted</p>';
        
    } catch (error) {
        console.error('Error loading my requests:', error);
        container.innerHTML = '<p class="error">Failed to load requests</p>';
    }
}
// Filter functions
function filterStaffClaims(status) {
    staffClaimFilter = status;
    loadMyRequests();
}

function filterStaffLeave(status) {
    staffLeaveFilter = status;
    loadMyRequests();
}

function filterStaffShifts(status) {
    staffShiftFilter = status;
    loadMyRequests();
}

function filterStaffAdjustments(status) {
    staffAdjustmentFilter = status;
    loadMyRequests();
}

// Optional: Reset all filters
function resetAllFilters() {
    staffClaimFilter = 'all';
    staffLeaveFilter = 'all';
    staffShiftFilter = 'pending';
    staffAdjustmentFilter = 'all';
    loadMyRequests();
}
// Update available shifts similarly
async function loadAvailableShifts() {
    const container = document.getElementById('availableList');
    if (!container) return;
    
    container.innerHTML = `
        <div class="shift-list">
            <div class="empty-state">
                <i class="fa-solid fa-calendar-plus"></i>
                <p>Available shifts feature coming soon</p>
            </div>
        </div>`;
}
async function loadPendingShifts() {
    const container = document.getElementById('shiftsList');
    if (!container) return;
    
    try {
        const { data: shifts } = await supabaseClient
            .from('shifts')
            .select('*, participants(first_name, last_name), locations(name)')
            .eq('staff_id', currentStaff.id)
            .eq('status', 'pending')
            .order('date', { ascending: false });
        
        container.innerHTML = shifts?.length ? shifts.map(shift => `
            <div class="request-card">
                <div class="request-header">
                    <span>${new Date(shift.date).toLocaleDateString('en-AU')}</span>
                    <span class="status-badge status-pending">Pending Approval</span>
                </div>
                <div class="request-body">
                    <p><strong>${shift.participants?.first_name} ${shift.participants?.last_name}</strong></p>
                    <p>Time: ${shift.start_time || 'Sleepover'} ${shift.end_time ? `- ${shift.end_time}` : ''}</p>
                    <p>Location: ${shift.locations?.name || 'Client Home'}</p>
                </div>
            </div>
        `).join('') : '<p class="no-data">No pending shift requests</p>';
        
    } catch (error) {
        console.error('Error loading shifts:', error);
        container.innerHTML = '<p class="error">Failed to load shift requests</p>';
    }
}

// Load leave requests
async function loadLeaveRequests() {
    const container = document.getElementById('leaveList');
    if (!container) return;
    
    try {
        const { data: leave } = await supabaseClient
            .from('leave_requests')
            .select('*')
            .eq('staff_id', currentStaff.id)
            .order('created_at', { ascending: false });
        
        container.innerHTML = leave?.length ? leave.map(req => `
            <div class="request-card">
                <div class="request-header">
                    <span>${new Date(req.start_date).toLocaleDateString('en-AU')} - ${new Date(req.end_date).toLocaleDateString('en-AU')}</span>
                    <span class="status-badge status-${req.status}">${req.status}</span>
                </div>
                <div class="request-body">
                    <p>Type: ${req.leave_type}</p>
                    <p>Reason: ${req.reason || 'N/A'}</p>
                </div>
            </div>
        `).join('') : '<p class="no-data">No leave requests</p>';
        
    } catch (error) {
        console.error('Error loading leave:', error);
        container.innerHTML = '<p class="error">Failed to load leave requests</p>';
    }
}

// Load outgoing transfers
async function loadOutgoingTransfers() {
    const container = document.getElementById('transferList');
    if (!container) return;
    
    try {
        const { data: transfers } = await supabaseClient
            .from('shift_transfers')
            .select(`
                *,
                shifts(date, start_time, end_time, participants(first_name, last_name)),
                to_staff:to_staff_id(first_name, last_name)
            `)
            .eq('from_staff_id', currentStaff.id)
            .order('created_at', { ascending: false });
        
        container.innerHTML = transfers?.length ? transfers.map(transfer => `
            <div class="request-card">
                <div class="request-header">
                    <span>${new Date(transfer.shifts?.date).toLocaleDateString('en-AU')}</span>
                    <span class="status-badge status-${transfer.status}">${transfer.status}</span>
                </div>
                <div class="request-body">
                    <p>To: ${transfer.to_staff?.first_name || 'Open to all'} ${transfer.to_staff?.last_name || ''}</p>
                    <p>Client: ${transfer.shifts?.participants?.first_name} ${transfer.shifts?.participants?.last_name}</p>
                    ${transfer.reason ? `<p>Reason: ${transfer.reason}</p>` : ''}
                </div>
            </div>
        `).join('') : '<p class="no-data">No outgoing transfer requests</p>';
        
    } catch (error) {
        console.error('Error loading transfers:', error);
        container.innerHTML = '<p class="error">Failed to load transfer requests</p>';
    }
}

// Load time adjustments
async function loadTimeAdjustments() {
    const container = document.getElementById('adjustmentList');
    if (!container) return;
    
    try {
        const { data: adjustments } = await supabaseClient
            .from('time_adjustments')
            .select('*, shifts(date, participants(first_name, last_name))')
            .eq('staff_id', currentStaff.id)
            .order('created_at', { ascending: false });
        
        container.innerHTML = adjustments?.length ? adjustments.map(adj => `
            <div class="request-card">
                <div class="request-header">
                    <span>${adj.shifts?.date ? new Date(adj.shifts.date).toLocaleDateString('en-AU') : 'Unknown date'}</span>
                    <span class="status-badge status-${adj.status}">${adj.status}</span>
                </div>
                <div class="request-body">
                    <p>Client: ${adj.shifts?.participants?.first_name} ${adj.shifts?.participants?.last_name}</p>
                    <p>Original: ${adj.original_start || 'N/A'} - ${adj.original_end || 'N/A'}</p>
                    <p>Requested: ${adj.new_start || 'N/A'} - ${adj.new_end || 'N/A'}</p>
                    <p>Reason: ${adj.reason || 'N/A'}</p>
                </div>
            </div>
        `).join('') : '<p class="no-data">No time adjustment requests</p>';
        
    } catch (error) {
        console.error('Error loading adjustments:', error);
        container.innerHTML = '<p class="error">Failed to load time adjustments</p>';
    }
}

async function loadIncomingRequests() {
    const container = document.getElementById('incomingList');
    if (!container) return;
    
    try {
        // Load incoming transfer requests where current staff is the target
        const { data: transfers, error } = await supabaseClient
            .from('transfer_requests')
            .select(`
                *,
                shift:shift_id(
                    id,
                    date,
                    start_time,
                    end_time,
                    participants(first_name, last_name),
                    locations(name),
                    duty_types(name)
                ),
                from_staff:from_staff_id(
                    id,
                    first_name,
                    last_name
                )
            `)
            .eq('to_staff_id', currentStaff.id)
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!transfers || transfers.length === 0) {
            container.innerHTML = `
                <div class="shift-list">
                    <div class="empty-state">
                        <i class="fa-solid fa-inbox"></i>
                        <p>No incoming transfer requests</p>
                    </div>
                </div>`;
            updateIncomingCount(0);
            return;
        }

        // Render incoming transfers using shift-list structure
        let html = '<div class="shift-list">';
        
        transfers.forEach(req => {
            const shift = req.shift;
            if (!shift) return; // Skip if shift data is missing
            
            const participant = shift.participants;
            const dutyType = shift.duty_types?.name || 'Regular';
            const location = shift.locations?.name || 'Client Home';
            const fromStaff = req.from_staff;
            
            html += `
                <div class="shift-list-item" style="border-left: 3px solid #2196F3;">
                    <div class="shift-info">
                        <div class="shift-date-time">
                            ${formatDateShort(shift.date)} - 
                            ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                            ${dutyType !== 'Regular' ? `<span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">${dutyType}</span>` : ''}
                        </div>
                        <div class="shift-client">
                            ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                        </div>
                        <div class="shift-location">
                            <i class="fa-solid fa-location-dot"></i> ${location}
                        </div>
                        <div class="shift-location" style="color: #666; font-size: 12px; margin-top: 4px;">
                            <i class="fa-solid fa-user-arrow-left"></i> From: ${fromStaff ? `${fromStaff.first_name} ${fromStaff.last_name}` : 'Unknown'}
                        </div>
                        ${req.reason ? `
                            <div class="shift-location" style="color: #888; font-size: 11px; font-style: italic; margin-top: 4px;">
                                "${req.reason}"
                            </div>
                        ` : ''}
                    </div>
                    <div class="shift-actions" style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                        <button class="btn btn-sm btn-success" onclick="acceptTransfer('${req.id}')" style="
                            padding: 8px 16px;
                            background: #28a745;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 13px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                            <i class="fa-solid fa-check"></i> Accept
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="declineTransfer('${req.id}')" style="
                            padding: 8px 16px;
                            background: #dc3545;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 13px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                            <i class="fa-solid fa-times"></i> Decline
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        updateIncomingCount(transfers.length);

    } catch (error) {
        console.error('Error loading incoming requests:', error);
        container.innerHTML = `
            <div class="shift-list">
                <div class="empty-state">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <p>Error loading transfer requests</p>
                </div>
            </div>`;
        updateIncomingCount(0);
    }
}

async function acceptTransfer(transferId) {
    try {
        // Get the transfer request details
        const { data: transfer, error: fetchError } = await supabaseClient
            .from('transfer_requests')
            .select('*, shift:shift_id(*)')
            .eq('id', transferId)
            .single();

        if (fetchError) throw fetchError;

        // Update the shift with new staff + clear transfer fields
        const { error: shiftError } = await supabaseClient
            .from('shifts')
            .update({
                staff_id: currentStaff.id,  // Assign to accepting staff
                transfer_status: 'accepted',
                transfer_approved_by: currentStaff.id,  // Track who approved
                updated_at: new Date().toISOString()
            })
            .eq('id', transfer.shift_id);

        if (shiftError) throw shiftError;

        // Update transfer request status
        const { error: transferError } = await supabaseClient
            .from('transfer_requests')
            .update({
                status: 'accepted',
                responded_at: new Date().toISOString(),  // Use responded_at
                responded_by: currentStaff.id  // Track who responded
            })
            .eq('id', transferId);

        if (transferError) throw transferError;

        showToast('Transfer accepted successfully', 'success');
        await loadIncomingRequests();
        await loadTimesheet(); // Refresh timesheet to show new shift
        if (typeof loadSchedule === 'function') {
            await loadSchedule();
        }

    } catch (error) {
        console.error('Error accepting transfer:', error);
        showToast('Failed to accept transfer', 'error');
    }
}

async function declineTransfer(transferId) {
    try {
        // Get the transfer request details to find the shift
        const { data: transfer, error: fetchError } = await supabaseClient
            .from('transfer_requests')
            .select('shift_id')
            .eq('id', transferId)
            .single();

        if (fetchError) throw fetchError;

        // Update the shift status
        const { error: shiftError } = await supabaseClient
            .from('shifts')
            .update({
                transfer_status: 'rejected',
                transfer_approved_by: currentStaff.id  // Track who rejected
            })
            .eq('id', transfer.shift_id);

        if (shiftError) throw shiftError;

        // Update transfer request status
        const { error: transferError } = await supabaseClient
            .from('transfer_requests')
            .update({
                status: 'rejected',  // Changed from 'declined' to match your schema
                responded_at: new Date().toISOString(),
                responded_by: currentStaff.id
            })
            .eq('id', transferId);

        if (transferError) throw transferError;

        showToast('Transfer declined', 'info');
        await loadIncomingRequests();

    } catch (error) {
        console.error('Error declining transfer:', error);
        showToast('Failed to decline transfer', 'error');
    }
}


async function loadAvailableShifts() {
    const container = document.getElementById('availableList');
    if (!container) return;
    
    try {
        const { data: available } = await supabaseClient
            .from('transfer_requests')
            .select(`
                *,
                shifts(date, start_time, end_time, participants(first_name, last_name)),
                from_staff:from_staff_id(first_name, last_name)
            `)
            .is('to_staff_id', null)
            .eq('status', 'pending')
            .neq('from_staff_id', currentStaff.id)
            .order('shifts(date)', { ascending: true });
        
        container.innerHTML = available?.length ? available.map(transfer => `
            <div class="request-card available">
                <div class="request-header">
                    <span>${new Date(transfer.shifts?.date).toLocaleDateString('en-AU')}</span>
                    <span class="available-badge">Available to Pick Up</span>
                </div>
                <div class="request-body">
                    <p><strong>${transfer.shifts?.participants?.first_name} ${transfer.shifts?.participants?.last_name}</strong></p>
                    <p>Time: ${transfer.shifts?.start_time || 'Sleepover'}</p>
                    <p>From: ${transfer.from_staff?.first_name} ${transfer.from_staff?.last_name}</p>
                </div>
                <div class="request-actions">
                    <button onclick="pickUpShift('${transfer.id}')" class="btn-primary">Pick Up Shift</button>
                </div>
            </div>
        `).join('') : '<p class="no-data">No available shifts</p>';
        
    } catch (error) {
        console.error('Error loading available shifts:', error);
        container.innerHTML = '<p class="error">Failed to load available shifts</p>';
    }
}

async function loadNotifications() {
    try {
        // Check if notifications table exists, otherwise show placeholder
        const { data: notifications, error } = await supabaseClient
            .from('notifications')
            .select('*')
            .eq('user_id', currentUser?.id || currentStaff.user_id)
            .is('read_at', null)
            .order('created_at', { ascending: false })
            .limit(5);

        const container = document.getElementById('recentNotifications');
        if (!container) return;

        // If notifications table doesn't exist, show default message
        if (error || !notifications || notifications.length === 0) {
            container.innerHTML = '<div class="notification-item">No new notifications</div>';
            return;
        }

        container.innerHTML = notifications.map(note => `
            <div class="notification-item">
                <div class="notification-content">${note.message || 'New notification'}</div>
                <div class="notification-time">${new Date(note.created_at).toLocaleDateString('en-AU')}</div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading notifications:', error);
        const container = document.getElementById('recentNotifications');
        if (container) {
            container.innerHTML = '<div class="notification-item">No new notifications</div>';
        }
    }
}
async function loadPendingRequests() {
    try {
        // Load all types of pending requests
        const [transfers, adjustments, pendingShifts] = await Promise.all([
            // Transfer requests where this staff is involved
            supabaseClient
                .from('transfer_requests')
                .select(`
                    *,
                    shifts(date, start_time, end_time, participants(first_name, last_name)),
                    from_staff:staff!transfer_requests_from_staff_id_fkey(first_name, last_name),
                    to_staff:staff!transfer_requests_to_staff_id_fkey(first_name, last_name)
                `)
                .or(`from_staff_id.eq.${currentStaff.id},to_staff_id.eq.${currentStaff.id}`)
                .eq('status', 'pending')
                .order('created_at', { ascending: false })
                .limit(5),
            
            // Adjustment requests for this staff's shifts
            supabaseClient
                .from('shift_adjustment_requests')
                .select(`
                    *,
                    shifts(date, start_time, end_time, participants(first_name, last_name)),
                    staff(first_name, last_name)
                `)
                .eq('staff_id', currentStaff.id)
                .eq('status', 'pending')
                .order('created_at', { ascending: false })
                .limit(5),
            
            // Pending shifts awaiting approval
            supabaseClient
                .from('shifts')
                .select('*, participants(first_name, last_name)')
                .eq('staff_id', currentStaff.id)
                .eq('status', 'pending')
                .order('date', { ascending: true })
                .limit(5)
        ]);

        const container = document.getElementById('pendingRequestsList');
        if (!container) return;

        const allRequests = [];

        // Add transfer requests
        if (transfers.data) {
            transfers.data.forEach(req => {
                const isIncoming = req.to_staff_id === currentStaff.id;
                allRequests.push({
                    type: 'transfer',
                    date: req.shifts?.date || 'Unknown',
                    time: req.shifts?.start_time ? `${formatTime12Hour(req.shifts.start_time)} - ${formatTime12Hour(req.shifts.end_time)}` : 'Sleepover',
                    details: isIncoming ? 
                        `Transfer from ${req.from_staff?.first_name || 'Unknown'} ${req.from_staff?.last_name || ''}` :
                        `Transfer to ${req.to_staff ? `${req.to_staff.first_name} ${req.to_staff.last_name}` : 'Open'}`,
                    participant: req.shifts?.participants ? `${req.shifts.participants.first_name} ${req.shifts.participants.last_name}` : 'Unknown',
                    status: 'pending',
                    created: req.created_at
                });
            });
        }

        // Add adjustment requests
        if (adjustments.data) {
            adjustments.data.forEach(req => {
                allRequests.push({
                    type: 'adjustment',
                    date: req.shifts?.date || 'Unknown',
                    time: `${formatTime12Hour(req.requested_start_time)} - ${formatTime12Hour(req.requested_end_time)}`,
                    details: 'Time adjustment request',
                    participant: req.shifts?.participants ? `${req.shifts.participants.first_name} ${req.shifts.participants.last_name}` : 'Unknown',
                    status: 'pending',
                    created: req.created_at
                });
            });
        }

        // Add pending shifts
        if (pendingShifts.data) {
            pendingShifts.data.forEach(shift => {
                allRequests.push({
                    type: 'shift',
                    date: shift.date,
                    time: shift.start_time ? `${formatTime12Hour(shift.start_time)} - ${formatTime12Hour(shift.end_time)}` : 'Sleepover',
                    details: 'Shift approval pending',
                    participant: `${shift.participants?.first_name || ''} ${shift.participants?.last_name || ''}`,
                    status: 'pending',
                    created: shift.created_at
                });
            });
        }

        // Sort all requests by date
        allRequests.sort((a, b) => new Date(b.created) - new Date(a.created));

        if (allRequests.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No pending requests</p>';
            return;
        }

        // Render combined requests
        container.innerHTML = allRequests.slice(0, 5).map(req => `
            <div class="request-item">
                <div class="request-badge">${req.type.charAt(0).toUpperCase() + req.type.slice(1)}</div>
                <div class="request-date">${new Date(req.date).toLocaleDateString('en-AU')}</div>
                <div class="request-details">
                    <strong>${req.participant}</strong><br>
                    ${req.time}<br>
                    <small>${req.details}</small>
                </div>
                <div class="status-badge status-${req.status}">${req.status.charAt(0).toUpperCase() + req.status.slice(1)}</div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading pending requests:', error);
        const container = document.getElementById('pendingRequestsList');
        if (container) {
            container.innerHTML = '<p style="color: var(--text-light);">Unable to load pending requests</p>';
        }
    }
}

// Pick up available shift
async function pickUpShift(transferId) {
    try {
        await acceptTransfer(transferId);
        loadAvailableShifts();
    } catch (error) {
        console.error('Error picking up shift:', error);
        showToast('Failed to pick up shift', 'error');
    }
}

// Update incoming count badge
function updateIncomingCount(count) {
    const badge = document.getElementById('incomingCount');
    if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-block' : 'none';
    }
    
    // Also update main nav badge
    const navBadge = document.getElementById('requestsBadge');
    if (navBadge) {
        navBadge.textContent = count;
        navBadge.classList.toggle('hidden', count === 0);
    }
}

// Add to your switchSection function
function handleRequestsSection() {
    initializeRequestsTabs();
    loadIncomingRequests(); 
}


// ==========================================
// APPSTATE IMPLEMENTATION
// ==========================================


const AppState = {
    staff: {
        current: null,
        original: null,
        all: []
    },
    shifts: {
        my: [],
        filtered: [],
        all: []
    },
    ui: {
        currentSection: 'dashboard',
        timesheetView: 'date',
        periodOffset: 0,
        currentPeriod: null
    },
    cache: {
        participants: [],
        dutyTypes: [],
        locations: [],
        transfers: {
            incoming: [],
            outgoing: []
        }
    },
    
    // Helper methods
    reset() {
        this.staff.original = null;
        this.ui.periodOffset = 0;
        this.ui.timesheetView = 'date';
    },
    
    isInTestMode() {
        return this.staff.original !== null;
    },
    
    getCurrentStaff() {
        return this.staff.current;
    },
    
    setCurrentStaff(staff) {
        this.staff.current = staff;
    },
    
    switchToTestMode(testStaff) {
        if (!this.staff.original) {
            this.staff.original = this.staff.current;
        }
        this.staff.current = testStaff;
    },
    
    exitTestMode() {
        if (this.staff.original) {
            this.staff.current = this.staff.original;
            this.staff.original = null;
        }
    }
};

// Initialize currentStaff reference for backward compatibility
Object.defineProperty(window, 'currentStaff', {
    get() { return AppState.staff.current; },
    set(value) { AppState.staff.current = value; }
});


async function populateParticipantDropdown() {
    const select = document.getElementById('shiftParticipant');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Client</option>';
    
    // Check if participants array is populated
    if (!participants || participants.length === 0) {
        console.log('Participants array empty, loading...');
        await loadReferenceData();
    }
    
    if (participants.length === 0) {
        select.innerHTML += '<option value="">No clients available</option>';
        return;
    }
    
    participants.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.first_name} ${p.last_name}`;
        select.appendChild(option);
    });
}

async function populateDutyTypeDropdown() {
    const select = document.getElementById('shiftDutyType');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Type</option>';
    
    // Check if dutyTypes array is populated
    if (!dutyTypes || dutyTypes.length === 0) {
        console.log('Duty types array empty, loading...');
        await loadReferenceData();
    }
    
    if (dutyTypes.length === 0) {
        select.innerHTML += '<option value="">No duty types available</option>';
        return;
    }
    
    dutyTypes.forEach(dt => {
        const option = document.createElement('option');
        option.value = dt.id;
        option.textContent = dt.name;
        select.appendChild(option);
    });
}

async function populateTransferableShifts() {
    const select = document.getElementById('transferShiftSelect');
    if (!select) return;
    
    // Clear existing options
    select.innerHTML = '<option value="">Select a shift</option>';
    
    // Load shifts for current staff
    const { data: myShifts } = await supabaseClient
        .from('shifts')
        .select('*, participants(first_name, last_name)')
        .eq('staff_id', currentStaff.id)
        .gte('date', getTestDate().toISOString().split('T')[0])
        .order('date', { ascending: true });
    
    if (myShifts && myShifts.length > 0) {
        myShifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id; // This is already an INTEGER
            option.dataset.start = shift.start_time || '';
            option.dataset.end = shift.end_time || '';
            
            const clientName = shift.participants ? 
                `${shift.participants.first_name} ${shift.participants.last_name}` : 
                'Unknown Client';
            option.textContent = `${formatDateShort(shift.date)} - ${clientName} (${shift.start_time || 'Sleepover'})`;
            select.appendChild(option);
        });
    }
}


async function populateStaffDropdown() {
    const select = document.getElementById('transferToStaff');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select staff member (optional)</option>';
    
    // Check if staff array is populated
    if (!staff || staff.length === 0) {
        console.log('Staff array empty, loading...');
        await loadReferenceData();
    }
    
    // Filter out current staff
    const otherStaff = staff.filter(s => s.id !== currentStaff.id);
    
    if (otherStaff.length === 0) {
        select.innerHTML += '<option value="">No other staff available</option>';
        return;
    }
    
    otherStaff.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = `${s.first_name} ${s.last_name}`;
        select.appendChild(option);
    });
}

function ensureIntegerId(id) {
    if (typeof id === 'number') return id;
    const parsed = parseInt(id, 10);
    if (isNaN(parsed)) {
        throw new Error(`Invalid ID: ${id} cannot be converted to integer`);
    }
    return parsed;
}


async function loadAdjustmentShifts() {
    try {
        // Use getTestDate() which applies your DATE_OFFSET_DAYS
        const today = getTestDate();
        today.setHours(23, 59, 59, 999);
        
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        sevenDaysAgo.setHours(0, 0, 0, 0);
        
        console.log('Date range with test offset:', {
            from: sevenDaysAgo.toISOString().split('T')[0],
            to: today.toISOString().split('T')[0]
        });
        
        // Get shifts for the current staff member
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                id,
                date,
                start_time,
                end_time,
                participant_id,
                duty_type_id,
                participant:participants(first_name, last_name),
                duty_type:duty_types(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', sevenDaysAgo.toISOString().split('T')[0])
            .lte('date', today.toISOString().split('T')[0])
            .is('deleted_at', null)
            .order('date', { ascending: false });

        if (error) throw error;

        const select = document.getElementById('adjustmentShift');
        select.innerHTML = '<option value="">Select a shift</option>';
        
        if (!shifts || shifts.length === 0) {
            select.innerHTML += '<option value="" disabled>No shifts in the past 7 days</option>';
            return;
        }
        
        shifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = shift.id;
            
            const date = new Date(shift.date);
            const dayName = date.toLocaleDateString('en-AU', { weekday: 'short' });
            const day = date.getDate();
            const month = date.toLocaleDateString('en-AU', { month: 'short' });
            
            const participantName = shift.participant 
                ? `${shift.participant.first_name} ${shift.participant.last_name}`
                : 'Unassigned';
            
            const isSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover') || false;
            
            let timeRange = '';
            if (!isSleepover && shift.start_time && shift.end_time) {
                const startTime = formatTimeDisplay(shift.start_time);
                const endTime = formatTimeDisplay(shift.end_time);
                timeRange = `, ${startTime}-${endTime}`;
            } else if (isSleepover) {
                timeRange = ', Sleepover';
            }
            
            const dutyTypeLabel = shift.duty_type?.name || 'Active Shift';
            option.textContent = `${dayName} ${day} ${month} - ${participantName}${timeRange} (${dutyTypeLabel})`;
            
            option.dataset.startTime = shift.start_time || '';
            option.dataset.endTime = shift.end_time || '';
            option.dataset.isSleepover = isSleepover.toString();
            
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading shifts:', error);
        showToast('Failed to load shifts', 'error');
    }
}
// Helper function to format time for display (e.g., "11am", "10:30pm")
function formatTimeDisplay(timeString) {
    if (!timeString) return '';
    const [hours, minutes] = timeString.split(':');
    const hour = parseInt(hours);
    const min = parseInt(minutes);
    const period = hour >= 12 ? 'pm' : 'am';
    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
    const displayMin = min > 0 ? `:${min.toString().padStart(2, '0')}` : '';
    return `${displayHour}${displayMin}${period}`;
}


async function loadLeaveRequestModal() {
    try {
        const today = getTestDate();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Set default start date to tomorrow
        const startDateInput = document.getElementById('leaveStartDate');
        if (startDateInput) {
            startDateInput.value = tomorrow.toISOString().split('T')[0];
            startDateInput.min = tomorrow.toISOString().split('T')[0];
        }
        
        // Set default end date to same as start
        const endDateInput = document.getElementById('leaveEndDate');
        if (endDateInput) {
            endDateInput.value = tomorrow.toISOString().split('T')[0];
            endDateInput.min = tomorrow.toISOString().split('T')[0];
        }
        
    } catch (error) {
        console.error('Error loading leave modal:', error);
    }
}


async function submitLeave() {
    // Prevent multiple simultaneous submissions
    if (isSubmittingLeave) {
        console.log('Leave submission already in progress, ignoring duplicate call');
        return;
    }
    
    isSubmittingLeave = true;
    
    try {
        const leaveType = document.getElementById('leaveType').value;
        const startDate = document.getElementById('leaveStartDate').value;
        const endDate = document.getElementById('leaveEndDate').value;
        const reason = document.getElementById('leaveReason').value;

        // ADD THIS DEBUGGING
        console.log('Leave form values:', {
            leaveType,
            startDate,
            endDate,
            reason,
            leaveTypeElement: document.getElementById('leaveType'),
            startDateElement: document.getElementById('leaveStartDate'),
            endDateElement: document.getElementById('leaveEndDate')
        });

        if (!leaveType || !startDate || !endDate) {
            // ADD MORE DEBUGGING
            console.log('Validation failed:', {
                leaveType: leaveType || 'EMPTY',
                startDate: startDate || 'EMPTY',
                endDate: endDate || 'EMPTY'
            });
            showToast('Please fill all required fields', 'error');
            isSubmittingLeave = false;
            return;
        }

        // Validate dates - only check that end is after start
        // REMOVED check for past dates to allow backdating
        if (new Date(endDate) < new Date(startDate)) {
            showToast('End date must be after start date', 'error');
            isSubmittingLeave = false;
            return;
        }

        // Check if this is a backdated submission
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const isBackdated = new Date(startDate) < today;
        
        if (isBackdated) {
            console.log('Backdated leave request detected');
        }

        const { data, error } = await supabaseClient
            .from('leave_requests')
            .insert({
                staff_id: currentStaff.id,
                leave_type: leaveType,
                start_date: startDate,
                end_date: endDate,
                reason: reason,
                status: 'pending',
                is_backdated: isBackdated,  // Add flag for backdated requests
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .select()
            .single();

        if (error) throw error;

        showToast('Leave request submitted for approval', 'success');
        closeModal('leaveModal');
        document.getElementById('leaveForm').reset();
        
    } catch (error) {
        console.error('Error submitting leave:', error);
        showToast('Failed to submit leave request: ' + error.message, 'error');
    } finally {
        // Always reset the flag
        isSubmittingLeave = false;
    }
}

function loadShiftTimes() {
    const select = document.getElementById('adjustmentShift');
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption || !selectedOption.value) return;
    
    const startTimeInput = document.getElementById('adjustmentStartTime');
    const endTimeInput = document.getElementById('adjustmentEndTime');
    const isSleepover = selectedOption.dataset.isSleepover === 'true';
    
    // Populate with original times (without seconds)
    if (selectedOption.dataset.startTime) {
        // Remove seconds from time
        startTimeInput.value = selectedOption.dataset.startTime.substring(0, 5);
    }
    if (selectedOption.dataset.endTime) {
        endTimeInput.value = selectedOption.dataset.endTime.substring(0, 5);
    }
    
    // Handle sleepover shifts
    if (isSleepover) {
        startTimeInput.disabled = true;
        endTimeInput.disabled = true;
        startTimeInput.removeAttribute('required');
        endTimeInput.removeAttribute('required');
        document.querySelector('label[for="adjustmentStartTime"]').textContent = 'Start Time (Not required for sleepover)';
        document.querySelector('label[for="adjustmentEndTime"]').textContent = 'End Time (Not required for sleepover)';
    } else {
        startTimeInput.disabled = false;
        endTimeInput.disabled = false;
        startTimeInput.setAttribute('required', 'required');
        endTimeInput.setAttribute('required', 'required');
        document.querySelector('label[for="adjustmentStartTime"]').textContent = 'New Start Time';
        document.querySelector('label[for="adjustmentEndTime"]').textContent = 'New End Time';
    }
    
    // Set 30-minute step intervals
    startTimeInput.step = '1800'; // 30 minutes in seconds
    endTimeInput.step = '1800';
    
    // Add validation listeners
    startTimeInput.removeEventListener('change', validateTimes);
    endTimeInput.removeEventListener('change', validateTimes);
    startTimeInput.addEventListener('change', validateTimes);
    endTimeInput.addEventListener('change', validateTimes);
}

function validateTimes() {
    const startTimeInput = document.getElementById('adjustmentStartTime');
    const endTimeInput = document.getElementById('adjustmentEndTime');
    
    if (!startTimeInput.value || !endTimeInput.value) return;
    
    const startTime = startTimeInput.value;
    const endTime = endTimeInput.value;
    
    // Compare times
    if (endTime <= startTime) {
        endTimeInput.setCustomValidity('End time must be after start time');
        showToast('End time must be after start time', 'error');
        endTimeInput.value = ''; // Clear invalid end time
    } else {
        endTimeInput.setCustomValidity('');
    }
}

function showTransportFields() {
    const transportFields = document.getElementById('transportFields');
    if (transportFields) {
        transportFields.style.display = 'block';
    }
}

function hideTransportFields() {
    const transportFields = document.getElementById('transportFields');
    if (transportFields) {
        transportFields.style.display = 'none';
        document.getElementById('transportKilometres').value = '';
        document.getElementById('transportParking').value = '';
    }
}

async function submitAdjustment() {
    try {
        const select = document.getElementById('adjustmentShift');
        const selectedOption = select.options[select.selectedIndex];
        const shiftId = select.value;
        const reason = document.getElementById('adjustmentReason').value;
        const newStartTime = document.getElementById('adjustmentStartTime').value;
        const newEndTime = document.getElementById('adjustmentEndTime').value;
        const isSleepover = selectedOption.dataset.isSleepover === 'true';
        
        if (!shiftId || !reason) {
            showToast('Please fill in required fields', 'error');
            return;
        }
        
        // Validate times for non-sleepover shifts
        if (!isSleepover) {
            if (!newStartTime || !newEndTime) {
                showToast('Start and end times are required for non-sleepover shifts', 'error');
                return;
            }
            
            if (newEndTime <= newStartTime) {
                showToast('End time must be after start time', 'error');
                return;
            }
        }
        
        // Add seconds to times for database storage
        const formattedStartTime = newStartTime ? `${newStartTime}:00` : null;
        const formattedEndTime = newEndTime ? `${newEndTime}:00` : null;
        
        // Create adjustment request
        const { data, error } = await supabaseClient
            .from('shift_adjustment_requests')
            .insert({
                shift_id: parseInt(shiftId),
                staff_id: currentStaff.id,
                new_start_time: formattedStartTime,  //  FIXED
                new_end_time: formattedEndTime,      //  FIXED
                adjustment_type: 'time_change',      //  ADDED (required field)
                reason: reason,
                status: 'pending',
                created_at: new Date().toISOString()
            });
        
        if (error) {
            console.error('Adjustment request error:', error);
            showToast('Failed to submit adjustment request', 'error');
        } else {
            // Update shift adjustment_status
            await supabaseClient
                .from('shifts')
                .update({
                    adjustment_status: 'requested'
                })
                .eq('id', parseInt(shiftId));
            
            showToast('Adjustment request submitted', 'success');
            closeModal('adjustmentModal');
            document.getElementById('adjustmentForm').reset();
            
            // Refresh the schedule and requests
            if (document.getElementById('schedule').classList.contains('active')) {
                loadSchedule();
            }
            if (typeof loadMyRequests === 'function') {
                await loadMyRequests();
            }
        }
    } catch (error) {
        console.error('Error submitting adjustment:', error);
        showToast('Failed to submit adjustment request', 'error');
    }
}

async function loadDutyTypes() {
    try {
        const { data, error } = await supabaseClient
            .from('duty_types')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        if (error) {
            console.error('Error loading duty types:', error);
            return [];
        }
        
        dutyTypes = data || [];
        console.log('Loaded duty types:', dutyTypes.length);
        return dutyTypes;
        
    } catch (error) {
        console.error('Error in loadDutyTypes:', error);
        return [];
    }
}

async function loadLocations() {
    try {
        const { data, error } = await supabaseClient
            .from('locations')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        if (error) {
            console.error('Error loading locations:', error);
            return [];
        }
        
        locations = data || [];
        console.log('Loaded locations:', locations.length);
        return locations;
        
    } catch (error) {
        console.error('Error in loadLocations:', error);
        return [];
    }
}

async function submitNote() {
    const participantId = document.getElementById('noteParticipantId').value; // Change to participant ID
    const noteType = document.getElementById('noteType').value;
    const noteText = document.getElementById('noteText').value;
    
    if (!participantId || !noteType || !noteText.trim()) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    try {
        const { data: noteData, error: noteError } = await supabaseClient
            .from('shift_notes')
            .insert({
                participant_id: participantId,  // Changed from shift_id to participant_id
                staff_id: currentStaff.id,
                note_type: noteType,
                note: noteText,
                created_at: new Date().toISOString()
            })
            .select()
            .single();
        
        if (noteError) {
            console.error('Note creation error:', noteError);
            showToast('Failed to add note', 'error');
        } else {
            showToast('Note added successfully', 'success');
            closeModal('addNoteModal');
            await loadShiftNotes(participantId);  // Pass participant ID
        }
    } catch (error) {
        console.error('Error submitting note:', error);
        showToast('Failed to add note', 'error');
    }
}

function previewImages() {
    const files = document.getElementById('noteImages').files;
    const container = document.getElementById('imagePreviewContainer');
    
    selectedImages = Array.from(files);
    container.innerHTML = '';
    
    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-preview';
            img.setAttribute('data-action-with-param', 'removeImage');
img.setAttribute('data-param', index);            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedImages.splice(index, 1);
    previewImages();
}

async function uploadDocument() {
    const uploadBtn = document.querySelector('[onclick="uploadDocument()"]');
    
    // Prevent double submission
    if (uploadBtn && uploadBtn.disabled) return;
    
    const fileInput = document.getElementById('documentFile');
    const file = fileInput.files[0];
    const documentTypeId = document.getElementById('documentType').value;
    const title = document.getElementById('documentTitle').value;
    const expiryDate = document.getElementById('documentExpiry').value;
    const notes = document.getElementById('documentNotes').value;
    
    if (!file || !documentTypeId || !title) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    try {
        // Disable button and show loading
        if (uploadBtn) {
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
        }
        
        // Check file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            showToast('File size must be less than 10MB', 'error');
            if (uploadBtn) {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload';
            }
            return;
        }
        
        // Get file extension
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentStaff.id}/${Date.now()}_${title.replace(/[^a-z0-9]/gi, '_')}.${fileExt}`;
        
        // Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('documents')
            .upload(fileName, file);
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = supabaseClient.storage
            .from('documents')
            .getPublicUrl(fileName);
        
        // Save to database
        const { error: dbError } = await supabaseClient
    .from('documents')
    .insert({
        entity_type: 'staff',
        entity_id: currentStaff.id,
        document_type_id: documentTypeId,  // CHANGED from type_id to document_type_id
        title: title,
        file_url: urlData.publicUrl,
        expiry_date: expiryDate || null,
        notes: notes || null,
        created_at: new Date().toISOString()
    });

        
        if (dbError) throw dbError;
        
        showToast('Document uploaded successfully', 'success');
        closeModal('uploadDocumentModal');
        document.getElementById('uploadDocumentForm').reset();
        
        // Reload documents list
        await loadDocuments();
        
    } catch (error) {
        console.error('Error uploading document:', error);
        showToast('Failed to upload document', 'error');
    } finally {
        // Re-enable button
        if (uploadBtn) {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload';
        }
    }
}

// Add this function to open the document upload modal
function openUploadDocumentModal() {
    const modal = document.getElementById('uploadDocumentModal');
    if (modal) {
        // Load document types for dropdown
        loadDocumentTypes();
        modal.style.display = 'flex';
    }
}

// Load document types for the dropdown
async function loadDocumentTypes() {
    try {
        const { data: types, error } = await supabaseClient
            .from('document_types')
            .select('id, name')
            .order('name');
        
        if (error) throw error;
        
        const select = document.getElementById('documentType');
        if (select) {
            select.innerHTML = '<option value="">Select type...</option>';
            types?.forEach(type => {
                select.innerHTML += `<option value="${type.id}">${type.name}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading document types:', error);
    }
}
function loadProfilePicture() {
    const profileImg = document.getElementById('profileImage');
    if (profileImg) {
        // Since profile_picture doesn't exist in DB, use default avatar
        profileImg.src = '/assets/default-avatar.png';
        // OR generate avatar from initials
        if (currentStaff) {
            const initials = `${currentStaff.first_name?.[0] || ''}${currentStaff.last_name?.[0] || ''}`;
            profileImg.alt = initials;
            // Could use a service like ui-avatars.com
            profileImg.src = `https://ui-avatars.com/api/?name=${currentStaff.first_name}+${currentStaff.last_name}&background=random`;
        }
    }
}



function displayUserRole() {
    // Since there's no role field, use a default or derive from other data
    const userRole = document.getElementById('userRole');
    if (userRole) {
        userRole.textContent = 'Support Worker'; // Default role
        // OR you could check if they have manager permissions some other way
    }
}

async function populateShiftModalDropdowns() {
    try {
        // Get assigned participants - My Carers will be filtered out even if assigned
        const { data: assignments, error } = await supabaseClient
            .from('staff_participant_assignments')
            .select(`
                participant_id,
                pay_rate_id,
                participants!inner(
                    id,
                    first_name,
                    last_name,
                    address,
                    is_active
                )
            `)
            .eq('staff_id', currentStaff.id)
            .eq('participants.is_active', true);
        
        if (error) throw error;
        
        const participantSelect = document.getElementById('shiftParticipant');
        participantSelect.innerHTML = '<option value="">Select Participant</option>';
        
        // Filter out My Carers at the JavaScript level (failsafe)
        const filteredAssignments = assignments?.filter(assignment => {
            const p = assignment.participants;
            const isMyCarers = 
                p.first_name?.toLowerCase().includes('my carers') ||
                p.last_name?.toLowerCase().includes('my carers') ||
                p.first_name?.toLowerCase().includes('mycarers') ||
                p.last_name?.toLowerCase().includes('mycarers');
            
            return !isMyCarers; // Exclude if it's My Carers
        }) || [];
        
        if (filteredAssignments.length === 0) {
            participantSelect.innerHTML += '<option value="" disabled>No participants assigned</option>';
            return;
        }
        
        // Store assignments with location data
        window.staffAssignments = {};
        
        filteredAssignments.forEach(assignment => {
            const participant = assignment.participants;
            const option = document.createElement('option');
            option.value = participant.id;
            
            // Determine location based on address
            let locationId;
            if (participant.address?.toLowerCase().includes('saunders')) {
                locationId = '82be1e0c-7036-4063-b161-1ab91162c3e1'; // Saunders
            } else {
                locationId = '00000000-0000-0000-0000-000000000001'; // Client Home
            }
            
            option.dataset.payRateId = assignment.pay_rate_id || currentStaff.pay_rate_id;
            option.dataset.locationId = locationId;
            option.textContent = `${participant.first_name} ${participant.last_name}`;
            participantSelect.appendChild(option);
            
            // Store for later use
            window.staffAssignments[participant.id] = {
                payRateId: assignment.pay_rate_id || currentStaff.pay_rate_id,
                locationId: locationId
            };
        });
        
        // ONLY load specific duty types
        const allowedDutyTypes = ['Active Shift', 'Sleepover', 'Placement', 'Training'];
        
        const { data: dutyTypes } = await supabaseClient
            .from('duty_types')
            .select('id, name')
            .eq('is_active', true)
            .in('name', allowedDutyTypes)
            .order('name');
        
        const dutySelect = document.getElementById('shiftDutyType');
        dutySelect.innerHTML = '<option value="">Select Duty Type</option>';
        
        let activeShiftId = null;
        dutyTypes?.forEach(dt => {
            const option = document.createElement('option');
            option.value = dt.id;
            option.textContent = dt.name;
            
            // Set Active Shift as default
            if (dt.name === 'Active Shift') {
                option.selected = true;
                activeShiftId = dt.id;
            }
            
            dutySelect.appendChild(option);
        });
        
        // Trigger duty type change to set up fields correctly
        if (activeShiftId) {
            onDutyTypeChange();
        }
        
    } catch (error) {
        console.error('Error loading dropdowns:', error);
        showToast('Failed to load options', 'error');
    }
}

// Auto-populate location when participant selected (no user selection)
function onParticipantChange() {
    const select = document.getElementById('shiftParticipant');
    const selectedParticipantId = select.value;
    
    if (!selectedParticipantId || !window.staffAssignments[selectedParticipantId]) return;
    
    // Store the location internally but don't show to user
    window.selectedLocationId = window.staffAssignments[selectedParticipantId].locationId;
}

// Updated onDutyTypeChange - remove transport handling
function onDutyTypeChange() {
    const dutySelect = document.getElementById('shiftDutyType');
    const selectedOption = dutySelect.options[dutySelect.selectedIndex];
    const dutyTypeName = selectedOption?.textContent?.toLowerCase() || '';
    
    const timeFields = document.getElementById('timeFields');
    const startTimeInput = document.getElementById('shiftStartTime');
    const endTimeInput = document.getElementById('shiftEndTime');
    
    if (dutyTypeName.includes('sleepover')) {
        // Hide time fields for sleepover
        timeFields.style.display = 'none';
        startTimeInput.value = '';
        endTimeInput.value = '';
        startTimeInput.required = false;
        endTimeInput.required = false;
    } else {
        // Show time fields for all other shifts
        timeFields.style.display = 'block';
        startTimeInput.required = true;
        endTimeInput.required = true;
    }
}

//TRANSPORT
let transportState = {
            currentStep: 1,
            participantId: null,
            participant: null,
            selectedRoute: null,
            selectedQuickRoute: null,
            googleMapsLoaded: false
        };

        // Main async function to load transport claim view
        async function loadTransportClaim(participantId) {
            try {
                transportState.participantId = participantId;
                transportState.currentStep = 1;
                
                // Load participant data
                const { data: participant, error } = await supabaseClient
                    .from('participants')
                    .select('*')
                    .eq('id', participantId)
                    .single();
                
                if (error) throw error;
                
                transportState.participant = participant;
                
                // Load Google Maps if not loaded
                if (!transportState.googleMapsLoaded) {
                    await loadGoogleMapsForTeam();
                    transportState.googleMapsLoaded = true;
                }
                
                // Initialize the view
                initializeTransportView();
                
                // Load quick routes
                await loadQuickRoutes(participantId);
                
                // Set today's date
                document.getElementById('transportDate').valueAsDate = new Date();
                
                // Setup autocomplete after a delay to ensure Google Maps is ready
                setTimeout(() => {
                    setupAddressAutocomplete(document.getElementById('routeOrigin'), true);
                    setupAddressAutocomplete(document.getElementById('routeDestination'), false);
                }, 500);
                
            } catch (error) {
                console.error('Error loading transport claim:', error);
                showToast('Failed to load transport claim', 'error');
            }
        }

        // Initialize transport view
        function initializeTransportView() {
            updateTransportStep(1);
        }

        // Load quick routes for the participant
        async function loadQuickRoutes(participantId) {
    const container = document.getElementById('quickRoutesGrid');
    container.innerHTML = `
        <div class="route-loading">
            <div class="spinner"></div>
            <p>Loading saved routes...</p>
        </div>
    `;
    
    try {
        const { data: routes, error } = await supabaseClient
            .from('saved_routes')
            .select('*')
            .eq('staff_id', currentStaff.id)      // ✅ Only current user's routes
            .eq('participant_id', participantId)  // ✅ Only for this participant
            .order('use_count', { ascending: false })
            .order('created_at', { ascending: false })
            .limit(5);
        
        if (error) throw error;
        
        if (!routes || routes.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fas fa-route" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>No saved routes yet. Create your first route below!</p>
                </div>
            `;
            return;
        }
        
        let html = '<h4 style="margin-top: 0; margin-bottom: 15px; color: #333;">Quick Routes</h4>';
        
        routes.forEach((route, index) => {
            html += `
                <div class="route-card" onclick="selectQuickRoute('${route.id}', ${JSON.stringify(route).replace(/"/g, '&quot;')})">
                    <div class="route-card-header">
                        <div class="route-name">${route.route_name || `Route ${index + 1}`}</div>
                        <div class="route-actions">
                            ${route.is_favorite ? '<i class="fas fa-star route-favorite"></i>' : ''}
                            <button class="route-delete" onclick="event.stopPropagation(); deleteTransportRoute('${route.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="route-info">
                        <div class="route-stat">
                            <i class="fas fa-road"></i>
                            <span>${parseFloat(route.distance_km).toFixed(1)} km</span>
                        </div>
                        <div class="route-stat">
                            <i class="fas fa-clock"></i>
                            <span>${route.duration_minutes || '~'} mins</span>
                        </div>
                        <div class="route-stat highlight">
                            <i class="fas fa-dollar-sign"></i>
                            <span>$${parseFloat(route.distance_km).toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="route-addresses">
                        <div class="route-address-line"><strong>From:</strong> ${route.origin_address}</div>
                        <div class="route-address-line"><strong>To:</strong> ${route.destination_address}</div>
                        ${route.route_via ? `<div class="route-address-line"><strong>Via:</strong> ${route.route_via}</div>` : ''}
                    </div>
                    
                    ${route.use_count > 0 ? `
                        <div style="margin-top: 8px; color: #999; font-size: 0.8rem;">
                            Used ${route.use_count} time${route.use_count > 1 ? 's' : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading quick routes:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle"></i> Failed to load saved routes
            </div>
        `;
    }
}
function selectQuickRoute(routeId, routeData) {
    // ✅ Log what's happening for debugging
    console.log('🚗 Quick Route Selected:', {
        claimWillBeFor: {
            staff: currentStaff.id,
            staffName: `${currentStaff.first_name} ${currentStaff.last_name}`,
            participant: transportState.participantId,
            participantName: transportState.participant ? 
                `${transportState.participant.first_name} ${transportState.participant.last_name}` : 
                'Unknown'
        },
        routeDetails: {
            from: routeData.origin_address,
            to: routeData.destination_address,
            distance: routeData.distance_km
        }
    });
    
    transportState.selectedQuickRoute = routeData;
    
    // Mark as selected
    document.querySelectorAll('.route-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Set route data
    window.selectedOrigin = {
        address: routeData.origin_address,
        placeId: routeData.origin_place_id
    };
    
    window.selectedDestination = {
        address: routeData.destination_address,
        placeId: routeData.destination_place_id
    };
    
    window.selectedRouteData = {
        distance: routeData.distance_km,
        duration: routeData.duration_minutes,
        via: routeData.route_via,
        polyline: routeData.route_polyline,
        hasTolls: false,
        warnings: []
    };
    
    window.selectedRouteIndex = 0;
    
    // Update use count
    supabaseClient.rpc('use_saved_route', { p_route_id: routeId });
    
    // Skip to confirmation step
    updateTransportStep(3);
    
    // Auto-populate form fields
    const dateInput = document.getElementById('transportDate');
    if (dateInput && !dateInput.value) {
        dateInput.valueAsDate = new Date();
    }
    
    // Auto-populate reason with route name or default
    const reasonInput = document.getElementById('transportReason');
    if (reasonInput && !reasonInput.value) {
        const routeName = routeData.route_name || `${routeData.origin_address.split(',')[0]} to ${routeData.destination_address.split(',')[0]}`;
        reasonInput.value = `Client support visit - ${routeName}`;
    }
}
        // Use client's home address
        function useClientHome() {
            if (!transportState.participant) return;
            
            const homeAddress = getParticipantHomeAddress(transportState.participant);
            if (homeAddress && homeAddress !== 'Address not available') {
                document.getElementById('routeOrigin').value = homeAddress;
                
                // Trigger place changed event for autocomplete
                const event = new Event('input', { bubbles: true });
                document.getElementById('routeOrigin').dispatchEvent(event);
                
                showToast('Client home address added', 'success');
            } else {
                showToast('Client home address not available', 'warning');
            }
        }

        // Proceed to route options
        async function proceedToRouteOptions() {
    const origin = document.getElementById('routeOrigin').value;
    const destination = document.getElementById('routeDestination').value;
    
    console.log('Proceeding to route options:', { origin, destination });
    
    if (!origin || !destination) {
        showToast('Please enter both pickup and destination addresses', 'warning');
        return;
    }
    
    if (!window.selectedOrigin || !window.selectedDestination) {
        showToast('Please select addresses from the dropdown suggestions', 'warning');
        return;
    }
    
    // Move to step 2
    updateTransportStep(2);
    
    // Wait for DOM update
    await new Promise(resolve => setTimeout(resolve, 200));
    
    // Initialize map if needed
    const mapElement = document.getElementById('transportMap');
    if (mapElement && !map) {
        console.log('Initializing map...');
        initializeMapServices(mapElement);
        await new Promise(resolve => setTimeout(resolve, 300));
    }
    
    // Calculate and display routes
    calculateRoutes();
}

        // Update step display
        function updateTransportStep(step) {
    transportState.currentStep = step;
    
    // Update step indicators
    ['step1Dot', 'step2Dot', 'step3Dot'].forEach((id, index) => {
        const dot = document.getElementById(id);
        if (dot) {
            if (index + 1 < step) {
                dot.classList.add('completed');
                dot.classList.remove('active');
            } else if (index + 1 === step) {
                dot.classList.add('active');
                dot.classList.remove('completed');
            } else {
                dot.classList.remove('active', 'completed');
            }
        }
    });
    
    // Update step title
    const titles = [
        'Step 1: Select or Create Route',
        'Step 2: Choose Your Path',
        'Step 3: Confirm Details'
    ];
    const stepTitle = document.getElementById('stepTitle');
    if (stepTitle) {
        stepTitle.textContent = titles[step - 1];
    }
    
    // Update content sections
    ['step1Content', 'step2Content', 'step3Content'].forEach((id, index) => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.toggle('active', index + 1 === step);
        }
    });
    
    // Update buttons
    const btnBack = document.getElementById('btnBack');
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');
    
    if (btnBack) btnBack.style.display = step > 1 ? 'block' : 'none';
    if (btnNext) btnNext.style.display = step < 3 ? 'block' : 'none';
    if (btnSubmit) btnSubmit.style.display = step === 3 ? 'block' : 'none';
    
    // Update summary if on step 3
    if (step === 3) {
        console.log('Updating trip summary with data:', window.selectedRouteData);
        updateTripSummary();
    }
}

        // Navigate steps
        function nextTransportStep() {
    if (transportState.currentStep === 1) {
        // Validate that addresses are selected
        const origin = document.getElementById('routeOrigin').value;
        const destination = document.getElementById('routeDestination').value;
        
        if (!origin || !destination) {
            showToast('Please enter both pickup and destination addresses', 'warning');
            return;
        }
        
        if (!window.selectedOrigin || !window.selectedDestination) {
            showToast('Please select addresses from the dropdown suggestions', 'warning');
            return;
        }
        
        // If quick route is selected, skip to step 3
        if (transportState.selectedQuickRoute) {
            updateTransportStep(3);
        } else {
            // Otherwise go to route selection (step 2)
            proceedToRouteOptions();
        }
        
    } else if (transportState.currentStep === 2) {
        // Validate route is selected
        if (!window.selectedRouteData) {
            showToast('Please select a route option', 'warning');
            return;
        }
        updateTransportStep(3);
    }
}


        function previousTransportStep() {
            if (transportState.currentStep > 1) {
                updateTransportStep(transportState.currentStep - 1);
            }
        }

        // Update trip summary
        function updateTripSummary() {
            if (!window.selectedRouteData) return;
            
            const summary = document.getElementById('tripSummary');
            const distance = parseFloat(window.selectedRouteData.distance);
            const reimbursement = distance * 1; // $1 per km
            
            summary.innerHTML = `
                <div class="summary-row">
                    <span class="summary-label">From:</span>
                    <span class="summary-value">${window.selectedOrigin?.address || 'N/A'}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">To:</span>
                    <span class="summary-value">${window.selectedDestination?.address || 'N/A'}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Via:</span>
                    <span class="summary-value">${window.selectedRouteData.via || 'Direct route'}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Distance:</span>
                    <span class="summary-value">${distance.toFixed(1)} km</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Duration:</span>
                    <span class="summary-value">${window.selectedRouteData.duration || '~'} minutes</span>
                </div>
                <div class="summary-row total">
                    <span class="summary-label">Reimbursement:</span>
                    <span class="summary-value">$${reimbursement.toFixed(2)}</span>
                </div>
            `;
        }

        async function submitTransportClaim() {
    const btn = document.getElementById('btnSubmit');
    
    // Prevent double submission
    if (btn.disabled) return;
    
    // Validate we have all required data FIRST
    if (!window.selectedRouteData) {
        showToast('Please select a route first', 'warning');
        return;
    }
    
    if (!window.selectedOrigin || !window.selectedDestination) {
        showToast('Route information is incomplete', 'error');
        return;
    }
    
    // Validate form fields
    const date = document.getElementById('transportDate')?.value;
    const reason = document.getElementById('transportReason')?.value;
    
    if (!date) {
        showToast('Please select a date', 'warning');
        return;
    }
    
    if (!reason || reason.trim() === '') {
        showToast('Please enter a reason for travel', 'warning');
        return;
    }
    
    // Show loading state
    btn.disabled = true;
    const originalBtnText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    try {
        // Submit the claim - this will return the data or undefined if cancelled
        const result = await submitTransportClaimWithRoute(transportState.participantId);
        
        // Only show success if claim was actually submitted
        if (result) {
            showToast('Transport claim submitted successfully!', 'success');
        } else {
            // User cancelled or submission was stopped
            console.log('Submission cancelled by user');
        }
        
    } catch (error) {
        console.error('Error submitting claim:', error);
        showToast('Failed to submit transport claim: ' + (error.message || 'Unknown error'), 'error');
    } finally {
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
}
        // Delete a saved route
        async function deleteTransportRoute(routeId) {
            if (confirm('Delete this saved route?')) {
                try {
                    const { error } = await supabaseClient
                        .from('saved_routes')
                        .delete()
                        .eq('id', routeId)
                        .eq('staff_id', currentStaff.id);
                    
                    if (error) throw error;
                    
                    showToast('Route deleted', 'success');
                    await loadQuickRoutes(transportState.participantId);
                    
                } catch (error) {
                    console.error('Error deleting route:', error);
                    showToast('Failed to delete route', 'error');
                }
            }
        }

        // Add to your participant view switch handler
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handler for transport button
            document.querySelector('[data-participant-view="transport"]')?.addEventListener('click', function() {
                const participantId = document.getElementById('participantSelect').value;
                if (participantId) {
                    openParticipantPanel('transport');
                    loadTransportClaim(participantId);
                } else {
                    showToast('Please select a participant first', 'warning');
                }
            });
        });


// Initialize Google Maps Services
function initializeMapServices(mapElement) {
    if (!mapElement) {
        console.error('Map element not found');
        return;
    }
    
    if (!window.google || !window.google.maps) {
        console.error('Google Maps not loaded yet');
        return;
    }
    
    try {
        // Clear any existing map
        if (map) {
            map = null;
        }
        
        // Initialize map
        map = new google.maps.Map(mapElement, {
            zoom: 11,
            center: { lat: -33.8688, lng: 151.2093 },
            mapTypeControl: true,
            fullscreenControl: true,
            streetViewControl: false,
            mapTypeControlOptions: {
                position: google.maps.ControlPosition.TOP_RIGHT
            }
        });
        
        directionsService = new google.maps.DirectionsService();
        
        // Important: Create NEW renderer
        if (directionsRenderer) {
            directionsRenderer.setMap(null); // Clear old renderer
        }
        
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: false,
            preserveViewport: false,
            draggable: false,
            polylineOptions: {
                strokeColor: '#4285F4',
                strokeWeight: 5,
                strokeOpacity: 0.7
            }
        });
        
        console.log('Map initialized successfully', {
            map: map,
            center: map.getCenter().toString(),
            zoom: map.getZoom()
        });
        
        // Force a resize after initialization
        setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
        }, 100);
        
    } catch (error) {
        console.error('Error initializing map:', error);
        showToast('Failed to initialize map', 'error');
    }
}

function setupAddressAutocomplete(inputElement, isOrigin = true) {
    if (!inputElement || !google) {
        console.error('Cannot setup autocomplete:', { inputElement, hasGoogle: !!google });
        return;
    }
    
    console.log('Setting up autocomplete for:', inputElement.id, 'isOrigin:', isOrigin);
    
    const autocomplete = new google.maps.places.Autocomplete(inputElement, {
        componentRestrictions: { country: 'au' },
        fields: ['place_id', 'formatted_address', 'geometry']
    });
    
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        
        console.log('Place selected:', place);
        
        if (!place.geometry) {
            console.warn('Place has no geometry');
            return;
        }
        
        // Store the selected place data
        if (isOrigin) {
            window.selectedOrigin = {
                address: place.formatted_address,
                placeId: place.place_id,
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            };
            console.log('Origin set:', window.selectedOrigin);
        } else {
            window.selectedDestination = {
                address: place.formatted_address,
                placeId: place.place_id,
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            };
            console.log('Destination set:', window.selectedDestination);
        }
        
        // Force close the dropdown
        inputElement.blur();
        setTimeout(() => {
            inputElement.focus();
            inputElement.blur();
        }, 100);
        
        // If both locations selected, enable the next button or auto-calculate
        if (window.selectedOrigin && window.selectedDestination) {
            console.log('Both locations selected, ready to calculate routes');
            // You might want to enable a "Calculate Routes" button here
            // or call calculateRoutes() directly if in step 2
        }
    });
    
    // Fix 2: Handle Enter key to close dropdown
    inputElement.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            // Allow Google to process the selection first
            setTimeout(() => {
                this.blur();
            }, 100);
        }
    });
    
    // Fix 3: Handle clicks on autocomplete suggestions
    // This uses MutationObserver to detect when user clicks on dropdown
    let observer = new MutationObserver(() => {
        const pacContainer = document.querySelector('.pac-container');
        if (pacContainer) {
            pacContainer.addEventListener('mousedown', (e) => {
                // Prevent default to allow selection
                e.stopPropagation();
                
                // Close dropdown after selection
                setTimeout(() => {
                    inputElement.blur();
                    // Hide all pac-containers
                    document.querySelectorAll('.pac-container').forEach(container => {
                        container.style.display = 'none';
                    });
                }, 300);
            });
            
            // Disconnect observer once we've attached the listener
            observer.disconnect();
        }
    });
    
    // Start observing
    observer.observe(document.body, { childList: true, subtree: true });
    
    return autocomplete;
}

function closeAutocompleteDropdown(inputElement) {
    // Method 1: Blur and refocus
    inputElement.blur();
    
    // Method 2: Hide pac-container directly
    setTimeout(() => {
        const containers = document.querySelectorAll('.pac-container');
        containers.forEach(container => {
            container.style.display = 'none';
        });
    }, 100);
    
    // Method 3: Trigger a click outside
    setTimeout(() => {
        document.body.click();
    }, 150);
    
    // Method 4: Dispatch blur event
    setTimeout(() => {
        inputElement.dispatchEvent(new Event('blur', { bubbles: true }));
    }, 200);
}

// For staff address modal - specific implementation
function setupStaffAddressAutocomplete(inputElement) {
    if (!inputElement || !google) return;
    
    const autocomplete = new google.maps.places.Autocomplete(inputElement, {
        componentRestrictions: { country: 'au' },
        fields: ['address_components', 'formatted_address', 'geometry'],
        types: ['address'] // More specific for home addresses
    });
    
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        
        if (!place.geometry) {
            showToast('Please select a valid address from the dropdown', 'warning');
            return;
        }
        
        // Parse address components for staff profile
        const addressComponents = {};
        place.address_components.forEach(component => {
            const types = component.types;
            if (types.includes('street_number')) {
                addressComponents.streetNumber = component.long_name;
            } else if (types.includes('route')) {
                addressComponents.streetName = component.long_name;
            } else if (types.includes('locality')) {
                addressComponents.suburb = component.long_name;
            } else if (types.includes('administrative_area_level_1')) {
                addressComponents.state = component.short_name;
            } else if (types.includes('postal_code')) {
                addressComponents.postcode = component.long_name;
            }
        });
        
        // Auto-fill staff address fields if they exist
        if (document.getElementById('staffStreetNumber')) {
            document.getElementById('staffStreetNumber').value = addressComponents.streetNumber || '';
        }
        if (document.getElementById('staffStreetName')) {
            document.getElementById('staffStreetName').value = addressComponents.streetName || '';
        }
        if (document.getElementById('staffSuburb')) {
            document.getElementById('staffSuburb').value = addressComponents.suburb || '';
        }
        if (document.getElementById('staffState')) {
            document.getElementById('staffState').value = addressComponents.state || '';
        }
        if (document.getElementById('staffPostcode')) {
            document.getElementById('staffPostcode').value = addressComponents.postcode || '';
        }
        
        // Store the full address
        inputElement.value = place.formatted_address;
        
        // Store location coordinates if needed
        if (place.geometry && place.geometry.location) {
            window.staffLocation = {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng(),
                address: place.formatted_address
            };
        }
        
        // Force close the dropdown
        closeAutocompleteDropdown(inputElement);
        
        // Show success
        showToast('Address selected successfully', 'success');
    });
    
    // Handle focus/blur to ensure dropdown closes
    inputElement.addEventListener('blur', function() {
        setTimeout(() => {
            const containers = document.querySelectorAll('.pac-container');
            containers.forEach(container => {
                container.style.display = 'none';
            });
        }, 200);
    });
    
    return autocomplete;
}

function initializeAutocompleteFixes() {
    // Add global CSS to ensure dropdowns close properly
    const style = document.createElement('style');
    style.textContent = `
        .pac-container {
            z-index: 10000 !important;
        }
        .pac-container:empty {
            display: none !important;
        }
    `;
    document.head.appendChild(style);
    
    // Global click handler to close dropdowns
    document.addEventListener('click', function(e) {
        // If clicking outside of autocomplete input
        if (!e.target.classList.contains('address-input') && 
            !e.target.closest('.pac-container')) {
            setTimeout(() => {
                document.querySelectorAll('.pac-container').forEach(container => {
                    container.style.display = 'none';
                });
            }, 100);
        }
    });
}

// Initialize fixes when Google Maps loads
window.initGoogleMaps = function() {
    googleMapsLoaded = true;
    initializeAutocompleteFixes();
    
    // Setup autocomplete for any existing inputs
    const transportOrigin = document.getElementById('routeOrigin');
    const transportDestination = document.getElementById('routeDestination');
    const staffAddressInput = document.getElementById('staffAddress');
    
    if (transportOrigin) {
        setupAddressAutocompleteV2(transportOrigin, true);
    }
    
    if (transportDestination) {
        setupAddressAutocompleteV2(transportDestination, false);
    }
    
    if (staffAddressInput) {
        setupStaffAddressAutocomplete(staffAddressInput);
    }
};

// Enhanced initialization for transport claim
async function initTransportAutocomplete() {
    // Wait for Google Maps to be ready
    if (!window.google || !window.google.maps) {
        await loadGoogleMapsForTeam();
    }
    
    // Small delay to ensure DOM is ready
    setTimeout(() => {
        const originInput = document.getElementById('routeOrigin');
        const destInput = document.getElementById('routeDestination');
        
        if (originInput && !originInput.hasAttribute('data-autocomplete-initialized')) {
            setupAddressAutocompleteV2(originInput, true);
            originInput.setAttribute('data-autocomplete-initialized', 'true');
        }
        
        if (destInput && !destInput.hasAttribute('data-autocomplete-initialized')) {
            setupAddressAutocompleteV2(destInput, false);
            destInput.setAttribute('data-autocomplete-initialized', 'true');
        }
    }, 500);
}

async function calculateRoutes() {
    console.log('=== CALCULATE ROUTES START ===');
    console.log('Selected Origin:', window.selectedOrigin);
    console.log('Selected Destination:', window.selectedDestination);
    
    if (!window.selectedOrigin || !window.selectedDestination) {
        showToast('Please select both origin and destination', 'warning');
        return;
    }
    
    // Ensure map services are initialized
    if (!directionsService || !directionsRenderer) {
        console.log('Map services not initialized, initializing now...');
        const mapElement = document.getElementById('transportMap');
        if (mapElement) {
            initializeMapServices(mapElement);
            await new Promise(resolve => setTimeout(resolve, 500));
        } else {
            console.error('Map element not found!');
            showToast('Map not available', 'error');
            return;
        }
    }
    
    console.log('Map services ready:', {
        hasDirectionsService: !!directionsService,
        hasDirectionsRenderer: !!directionsRenderer,
        hasMap: !!map
    });
    
    const loadingEl = document.getElementById('routeLoadingIndicator');
    const routesContainer = document.getElementById('routeOptionsContainer');
    
    if (loadingEl) loadingEl.style.display = 'block';
    if (routesContainer) routesContainer.innerHTML = '';
    
    const request = {
        origin: { placeId: window.selectedOrigin.placeId },
        destination: { placeId: window.selectedDestination.placeId },
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC,
        provideRouteAlternatives: true,
        region: 'AU'
    };
    
    console.log('Directions request:', request);
    
    directionsService.route(request, (response, status) => {
        console.log('Directions response status:', status);
        console.log('Directions response:', response);
        
        if (loadingEl) loadingEl.style.display = 'none';
        
        if (status === 'OK') {
            console.log('Routes found:', response.routes.length);
            response.routes.forEach((route, i) => {
                console.log(`Route ${i}:`, {
                    summary: route.summary,
                    distance: route.legs[0].distance,
                    duration: route.legs[0].duration
                });
            });
            
            window.availableRoutes = response.routes;
            displayRouteOptions(response.routes);
            
            // Display first route on map
            console.log('Setting directions on map...');
            directionsRenderer.setDirections(response);
            directionsRenderer.setRouteIndex(0);
            console.log('Directions set successfully');
        } else {
            console.error('Directions request failed:', status, response);
            showToast('Could not calculate route: ' + status, 'error');
        }
    });
}

// Display route options for user to choose
function displayRouteOptions(routes) {
    const container = document.getElementById('routeOptionsContainer');
    if (!container) return;
    
    let html = '<div class="routes-display-container">';
    
    // Left side: Route cards
    html += '<div class="route-cards-list">';
    
    routes.forEach((route, index) => {
        const leg = route.legs[0];
        const distance = leg.distance.value / 1000; // km
        const duration = Math.ceil(leg.duration.value / 60); // minutes
        const viaRoute = route.summary;
        
        // Check for tolls and warnings
        const hasTolls = route.warnings?.some(w => 
            w.toLowerCase().includes('toll') || 
            w.toLowerCase().includes('toll road')
        ) || false;
        
        const hasWarnings = route.warnings && route.warnings.length > 0;
        
        html += `
            <div class="route-card-interactive ${index === 0 ? 'selected' : ''}" 
                 data-route-index="${index}"
                 onclick="selectRouteInteractive(${index})"
                 onmouseenter="highlightRouteOnMap(${index})"
                 onmouseleave="unhighlightRoute()">
                
                <div class="route-card-header">
                    <div class="route-title-section">
                        <input type="radio" 
                               name="routeSelection" 
                               id="route_${index}"
                               value="${index}" 
                               ${index === 0 ? 'checked' : ''}
                               onchange="selectRouteInteractive(${index})">
                        <label for="route_${index}" class="route-label">
                            <strong>Route ${index + 1}</strong>
                            ${index === 0 ? '<span class="badge-recommended">Fastest</span>' : ''}
                        </label>
                    </div>
                    
                    <div class="route-badges">
                        ${hasTolls ? '<span class="badge-toll"><i class="fas fa-coins"></i> Toll</span>' : ''}
                    </div>
                </div>
                
                <div class="route-via-text">
                    <i class="fas fa-route"></i> via ${viaRoute}
                </div>
                
                <div class="route-stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon"><i class="fas fa-road"></i></div>
                        <div class="stat-details">
                            <div class="stat-value">${distance.toFixed(1)} km</div>
                            <div class="stat-label">Distance</div>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-details">
                            <div class="stat-value">${duration} min</div>
                            <div class="stat-label">Duration</div>
                        </div>
                    </div>
                
                </div>
                
                ${hasWarnings ? `
                    <div class="route-warnings">
                        <i class="fas fa-exclamation-triangle"></i>
                        ${route.warnings.join(', ')}
                    </div>
                ` : ''}
                
                <div class="route-steps-summary">
                    <button class="btn-view-steps" onclick="event.stopPropagation(); toggleRouteSteps(${index})">
                        <i class="fas fa-list"></i> View Turn-by-Turn
                    </button>
                </div>
                
                <div class="route-steps-detail" id="routeSteps_${index}" style="display: none;">
                    ${generateTurnByTurn(leg.steps)}
                </div>
            </div>
        `;
        
        // Store route data
        route._calculatedData = {
            distance: distance,
            duration: duration,
            via: viaRoute,
            polyline: route.overview_polyline,
            hasTolls: hasTolls,
            warnings: route.warnings || []
        };
    });
    
    html += '</div>'; // End route-cards-list
    html += '</div>'; // End routes-display-container
    
    container.innerHTML = html;
    
    // Store routes globally
    window.availableRoutes = routes;
    
    // Set first route as default
    if (routes.length > 0) {
        window.selectedRouteData = routes[0]._calculatedData;
        window.selectedRouteIndex = 0;
    }
}

function generateTurnByTurn(steps) {
    let html = '<ol class="turn-by-turn-list">';
    
    steps.forEach((step, index) => {
        const distance = (step.distance.value / 1000).toFixed(1);
        const instruction = step.instructions.replace(/<[^>]*>/g, ''); // Strip HTML
        
        html += `
            <li class="turn-item">
                <div class="turn-instruction">${instruction}</div>
                <div class="turn-distance">${distance} km</div>
            </li>
        `;
    });
    
    html += '</ol>';
    return html;
}

// Toggle turn-by-turn view
function toggleRouteSteps(index) {
    const stepsEl = document.getElementById(`routeSteps_${index}`);
    const isVisible = stepsEl.style.display !== 'none';
    
    // Hide all other route steps
    document.querySelectorAll('.route-steps-detail').forEach(el => {
        el.style.display = 'none';
    });
    
    // Toggle current
    stepsEl.style.display = isVisible ? 'none' : 'block';
    
    // Update button text
    const btn = event.currentTarget;
    btn.innerHTML = isVisible 
        ? '<i class="fas fa-list"></i> View Turn-by-Turn'
        : '<i class="fas fa-times"></i> Hide Details';
}

// Interactive route selection
function selectRouteInteractive(index) {
    // Update UI selection
    document.querySelectorAll('.route-card-interactive').forEach((card, i) => {
        card.classList.toggle('selected', i === index);
    });
    
    // Update radio button
    document.getElementById(`route_${index}`).checked = true;
    
    // Update map display
    if (directionsRenderer && window.availableRoutes) {
        directionsRenderer.setRouteIndex(index);
    }
    
    // Store selected route data
    if (window.availableRoutes && window.availableRoutes[index]) {
        window.selectedRouteData = window.availableRoutes[index]._calculatedData;
        window.selectedRouteIndex = index;
    }
    
    // Update total display if it exists
    if (typeof updateTransportClaimTotal === 'function') {
        updateTransportClaimTotal();
    }
}

// Highlight route on hover
function highlightRouteOnMap(index) {
    if (directionsRenderer && window.availableRoutes) {
        directionsRenderer.setRouteIndex(index);
    }
}

// Remove highlight when mouse leaves
function unhighlightRoute() {
    // Return to selected route
    if (directionsRenderer && window.selectedRouteIndex !== undefined) {
        directionsRenderer.setRouteIndex(window.selectedRouteIndex);
    }
}

// Add custom styling for the routes display
function addRouteDisplayStyles() {
    const styleId = 'route-display-styles';
    if (document.getElementById(styleId)) return;
    
    const style = document.createElement('style');
    style.id = styleId;
    style.textContent = `
        .routes-display-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .route-cards-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .route-card-interactive {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .route-card-interactive:hover {
            border-color: #4285F4;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.15);
            transform: translateY(-2px);
        }
        
        .route-card-interactive.selected {
            border-color: #4285F4;
            background: #f8fbff;
            box-shadow: 0 4px 16px rgba(66, 133, 244, 0.2);
        }
        
        .route-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .route-title-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .route-title-section input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .route-label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }
        
        .badge-recommended {
            background: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .route-badges {
            display: flex;
            gap: 6px;
        }
        
        .badge-toll {
            background: #ff9800;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .route-via-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .route-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .stat-item.highlight-stat {
            background: #e8f5e9;
        }
        
        .stat-icon {
            font-size: 20px;
            color: #666;
            width: 30px;
            text-align: center;
        }
        
        .highlight-stat .stat-icon {
            color: #4CAF50;
        }
        
        .stat-details {
            flex: 1;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            line-height: 1.2;
        }
        
        .stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .route-warnings {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 13px;
            color: #856404;
            margin-top: 10px;
        }
        
        .route-warnings i {
            margin-right: 6px;
        }
        
        .route-steps-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn-view-steps {
            background: transparent;
            border: 1px solid #4285F4;
            color: #4285F4;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn-view-steps:hover {
            background: #4285F4;
            color: white;
        }
        
        .route-steps-detail {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .turn-by-turn-list {
            list-style: none;
            counter-reset: step-counter;
            padding: 0;
            margin: 0;
        }
        
        .turn-item {
            counter-increment: step-counter;
            position: relative;
            padding: 12px 12px 12px 40px;
            border-left: 2px solid #e0e0e0;
            margin-bottom: 10px;
        }
        
        .turn-item:last-child {
            border-left: none;
        }
        
        .turn-item::before {
            content: counter(step-counter);
            position: absolute;
            left: -12px;
            top: 12px;
            width: 24px;
            height: 24px;
            background: #4285F4;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .turn-instruction {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }
        
        .turn-distance {
            font-size: 12px;
            color: #999;
        }
    `;
    document.head.appendChild(style);
}

// Initialize styles when document loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addRouteDisplayStyles);
} else {
    addRouteDisplayStyles();
}

// Select a specific route
function selectRoute(index) {
    // Update map display
    directionsRenderer.setRouteIndex(index);
    
    // Update UI selection
    document.querySelectorAll('.route-option').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });
    
    // Store selected route data
    window.selectedRouteData = window.availableRoutes[index]._calculatedData;
    window.selectedRouteIndex = index;
    
    // Update total display
    updateTransportClaimTotal();
}

async function saveRoute(participantId, routeName = null) {
    if (!window.selectedOrigin || !window.selectedDestination || !window.selectedRouteData) {
        showToast('Please select a complete route first', 'warning');
        return;
    }
    
    try {
        // ✅ Check if this exact route already exists for this staff member
        const { data: existingRoutes, error: checkError } = await supabaseClient
            .from('saved_routes')
            .select('id, route_name')
            .eq('staff_id', currentStaff.id)
            .eq('participant_id', participantId)
            .eq('origin_place_id', window.selectedOrigin.placeId)
            .eq('destination_place_id', window.selectedDestination.placeId);
        
        if (checkError) throw checkError;
        
        if (existingRoutes && existingRoutes.length > 0) {
            showToast(`This route is already saved as "${existingRoutes[0].route_name}"`, 'info');
            return existingRoutes[0]; // Return existing route
        }
        
        // Route doesn't exist, create it
        const routeData = {
            participant_id: participantId,
            staff_id: currentStaff.id,
            origin_address: window.selectedOrigin.address,
            destination_address: window.selectedDestination.address,
            origin_place_id: window.selectedOrigin.placeId,
            destination_place_id: window.selectedDestination.placeId,
            route_polyline: window.selectedRouteData.polyline,
            distance_km: window.selectedRouteData.distance,
            duration_minutes: window.selectedRouteData.duration,
            route_via: window.selectedRouteData.via,
            route_name: routeName || `${window.selectedOrigin.address.split(',')[0]} to ${window.selectedDestination.address.split(',')[0]}`
        };
        
        const { data, error } = await supabaseClient
            .from('saved_routes')
            .insert(routeData)
            .select()
            .single();
        
        if (error) throw error;
        
        showToast('Route saved for future use!', 'success');
        return data;
    } catch (error) {
        console.error('Error saving route:', error);
        showToast('Failed to save route', 'error');
    }
}
// Delete a saved route
async function deleteSavedRoute(routeId) {
    try {
        const { error } = await supabaseClient
            .from('saved_routes')
            .delete()
            .eq('id', routeId)
            .eq('staff_id', currentStaff.id); // Ensure staff can only delete their own routes
        
        if (error) throw error;
        
        showToast('Route deleted', 'success');
        return true;
    } catch (error) {
        console.error('Error deleting route:', error);
        showToast('Failed to delete route', 'error');
        return false;
    }
}

// Use a saved route
async function useSavedRoute(routeId, routeData) {
    // Set the origin and destination
    window.selectedOrigin = {
        address: routeData.origin_address,
        placeId: routeData.origin_place_id
    };
    
    window.selectedDestination = {
        address: routeData.destination_address,
        placeId: routeData.destination_place_id
    };
    
    window.selectedRouteData = {
        distance: routeData.distance_km,
        duration: routeData.duration_minutes,
        via: routeData.route_via,
        polyline: routeData.route_polyline
    };
    
    // Update use count
    await supabaseClient.rpc('use_saved_route', { p_route_id: routeId });
    
    // Display on map if available
    if (map && routeData.route_polyline) {
        const decodedPath = google.maps.geometry.encoding.decodePath(routeData.route_polyline);
        const bounds = new google.maps.LatLngBounds();
        decodedPath.forEach(point => bounds.extend(point));
        map.fitBounds(bounds);
    }
    
    // Move to submission step
    showTransportClaimStep('confirm');
}

async function checkDuplicateClaim(participantId, date) {
    if (!window.selectedOrigin || !window.selectedDestination) return null;
    
    try {
        const { data, error } = await supabaseClient
            .rpc('check_duplicate_transport_claim', {
                p_staff_id: currentStaff.id,
                p_participant_id: participantId,
                p_date: date,
                p_origin: window.selectedOrigin.address,
                p_destination: window.selectedDestination.address
            });
        
        if (error) throw error;
        
        return data && data.length > 0 ? data[0] : null;
    } catch (error) {
        console.error('Error checking duplicate:', error);
        return null; // Don't block submission if check fails
    }
}
async function submitTransportClaimWithRoute(participantId) {
    console.log('=== SUBMIT TRANSPORT CLAIM ===');
    console.log('Participant ID:', participantId);
    
    if (!window.selectedOrigin || !window.selectedDestination || !window.selectedRouteData) {
        console.error('Missing required data!');
        showToast('Please complete route selection first', 'error');
        return null; // ✅ Return null instead of undefined
    }
    
    try {
        // Get form values
        const date = document.getElementById('transportDate')?.value;
        const reason = document.getElementById('transportReason')?.value;
        const saveRouteCheck = document.getElementById('saveRouteCheck');
        
        // Validation
        if (!date) {
            showToast('Please select a date', 'warning');
            return null; // ✅ Return null
        }
        
        if (!reason) {
            showToast('Please enter a reason for travel', 'warning');
            return null; // ✅ Return null
        }
        
        // Check for duplicates
        const duplicate = await checkDuplicateClaim(participantId, date);
        if (duplicate && duplicate.has_duplicate) {
            const confirmSubmit = window.confirm(
                `A similar trip was already claimed on this date for $${duplicate.existing_total.toFixed(2)}.\n\n` +
                `Continue with submission?`
            );
            if (!confirmSubmit) {
                console.log('User cancelled duplicate submission');
                return null; // ✅ Return null when user cancels
            }
        }
        
        // Calculate total ($1 per km)
        const total = window.selectedRouteData.distance;
        
        // Prepare claim data
        const claimData = {
            staff_id: currentStaff.id,
            participant_id: participantId,
            date: date,
            kilometres: window.selectedRouteData.distance,
            route_origin: window.selectedOrigin.address,
            route_destination: window.selectedDestination.address,
            route_origin_place_id: window.selectedOrigin.placeId,
            route_destination_place_id: window.selectedDestination.placeId,
            route_polyline: window.selectedRouteData.polyline,
            calculated_distance: window.selectedRouteData.distance,
            route_duration_minutes: window.selectedRouteData.duration,
            route_via: window.selectedRouteData.via,
            selected_route_index: window.selectedRouteIndex || 0,
            reason: reason,
            total_claim: total,
            has_tolls: window.selectedRouteData.hasTolls || false,
            status: 'pending'
        };
        
        console.log('Submitting claim data:', claimData);
        
        // Submit to database
        const { data, error } = await supabaseClient
            .from('transport_claims')
            .insert(claimData)
            .select()
            .single();
        
        if (error) throw error;
        
        // Save route if checkbox is checked
        if (saveRouteCheck && saveRouteCheck.checked) {
            await saveRoute(participantId);
        }
        
        // Success message with toll warning if applicable
        let successMsg = `Transport claim submitted!\nReimbursement: $${total.toFixed(2)} (${window.selectedRouteData.distance.toFixed(1)}km @ $1/km)`;
        if (window.selectedRouteData.hasTolls) {
            successMsg += '\n⚠️ Note: This route has tolls';
        }
        
        showToast(successMsg, 'success');
        
        // Reset state
        transportState.currentStep = 1;
        transportState.selectedQuickRoute = null;
        window.selectedOrigin = null;
        window.selectedDestination = null;
        window.selectedRouteData = null;
        window.selectedRouteIndex = null;
        
        // Clear form
        document.getElementById('routeOrigin').value = '';
        document.getElementById('routeDestination').value = '';
        document.getElementById('transportReason').value = '';
        if (saveRouteCheck) saveRouteCheck.checked = false;
        
        // Reload quick routes
        await loadQuickRoutes(participantId);
        
        // Update transport step back to 1
        updateTransportStep(1);
        
        return data; // ✅ Return the submitted data
        
    } catch (error) {
        console.error('Error submitting transport claim:', error);
        showToast('Failed to submit transport claim: ' + error.message, 'error');
        return null; // ✅ Return null on error
    }
}
// Get participant home address
function getParticipantHomeAddress(participant) {
    if (!participant) return null;
    
    // Construct address from components
    const parts = [];
    
    if (participant.unit_number) parts.push(participant.unit_number);
    if (participant.street_number) parts.push(participant.street_number);
    if (participant.street_name) parts.push(participant.street_name);
    
    const streetAddress = parts.join(' ');
    
    const fullParts = [];
    if (streetAddress) fullParts.push(streetAddress);
    if (participant.suburb) fullParts.push(participant.suburb);
    if (participant.state) fullParts.push(participant.state);
    if (participant.postcode) fullParts.push(participant.postcode);
    if (participant.country) fullParts.push(participant.country || 'Australia');
    
    return fullParts.join(', ');
}

// Helper function to update total display
function updateTransportClaimTotal() {
    if (!window.selectedRouteData) return;
    
    const total = window.selectedRouteData.distance; // $1 per km
    const totalDisplay = document.getElementById('transportClaimTotal');
    const summaryDisplay = document.getElementById('claimSummary');
    
    if (totalDisplay) {
        totalDisplay.innerHTML = `
            <div class="claim-total">
                <span class="label">Reimbursement Amount:</span>
                <span class="amount">$${total.toFixed(2)}</span>
                <span class="calculation">(${window.selectedRouteData.distance.toFixed(1)}km × $1/km)</span>
            </div>
        `;
    }
    
    if (summaryDisplay) {
        summaryDisplay.innerHTML = `
            <div class="claim-summary-details">
                <div class="summary-item">
                    <label>From:</label>
                    <span>${window.selectedOrigin.address}</span>
                </div>
                <div class="summary-item">
                    <label>To:</label>
                    <span>${window.selectedDestination.address}</span>
                </div>
                <div class="summary-item">
                    <label>Via:</label>
                    <span>${window.selectedRouteData.via}</span>
                </div>
                <div class="summary-item">
                    <label>Distance:</label>
                    <span>${window.selectedRouteData.distance.toFixed(1)} km</span>
                </div>
                <div class="summary-item highlight">
                    <label>Reimbursement:</label>
                    <span>$${total.toFixed(2)}</span>
                </div>
            </div>
        `;
    }
}

// Add this warning when opening transport modal
async function loadTransportModal() {
    try {
        // Show warning first
        const warningDiv = document.createElement('div');
        warningDiv.className = 'alert alert-warning';
        warningDiv.innerHTML = `
            <strong>⚠️ Important: Transport Claims Policy</strong><br><br>
            Transport claims are ONLY for:<br>
            • Taking participants to/from appointments<br>
            • Pre-approved work-related travel<br>
            NOT for:<br>
            • Your regular commute to/from work<br>
            • Personal travel<br><br>
            <strong>All claims without prior approval may be rejected.</strong>
        `;
        
        const modalBody = document.querySelector('#transportModal .modal-body');
        const existingWarning = modalBody.querySelector('.alert-warning');
        if (!existingWarning) {
            modalBody.insertBefore(warningDiv, modalBody.firstChild);
        }
        
        // Rest of function...
        document.getElementById('transportDate').value = getTestDate().toISOString().split('T')[0];
        
        // Load participants (excluding My Carers)
        const { data: assignments } = await supabaseClient
            .from('staff_participant_assignments')
            .select(`
                participant_id,
                participants!inner(
                    id,
                    first_name,
                    last_name
                )
            `)
            .eq('staff_id', currentStaff.id)
            .eq('participants.is_active', true);
        
        const select = document.getElementById('transportParticipant');
        select.innerHTML = '<option value="">Not participant specific</option>';
        
        assignments?.forEach(assignment => {
            const p = assignment.participants;
            // Filter out My Carers
            if (!p.first_name?.toLowerCase().includes('my carers') && 
                !p.last_name?.toLowerCase().includes('my carers')) {
                select.innerHTML += `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`;
            }
        });
        
    } catch (error) {
        console.error('Error loading transport modal:', error);
    }
}



// Add preview function for evidence files
function previewTransportEvidence(input) {
    const preview = document.getElementById('evidencePreview');
    if (!preview) return;
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate file size
        if (file.size > 5 * 1024 * 1024) {
            showToast('File too large. Maximum 5MB allowed', 'error');
            input.value = '';
            preview.innerHTML = '';
            return;
        }
        
        // Show preview
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `
                    <div style="margin-top: 10px;">
                        <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                        <p style="font-size: 12px; color: #666;">${file.name}</p>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = `
                <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                    <i class="fas fa-file-pdf"></i> ${file.name}
                    <span style="font-size: 12px; color: #666;">(${(file.size / 1024).toFixed(1)} KB)</span>
                </div>
            `;
        }
    } else {
        preview.innerHTML = '';
    }
}

// Real-time total calculation display
function updateTransportTotal() {
    const kilometres = parseFloat(document.getElementById('transportKilometres').value) || 0;
    const parking = parseFloat(document.getElementById('transportParkingCost').value) || 0;
    const tolls = parseFloat(document.getElementById('transportTollCost').value) || 0;
    
    const kmRate = 0.72;
    const mileageReimbursement = kilometres * kmRate;
    const total = mileageReimbursement + parking + tolls;
    
    // Display total somewhere in the modal
    const totalDisplay = document.getElementById('transportTotalDisplay');
    if (totalDisplay) {
        totalDisplay.textContent = `Estimated Total: $${total.toFixed(2)}`;
        
        // Also show breakdown if elements exist
        const breakdownEl = document.getElementById('transportBreakdown');
        if (breakdownEl) {
            let breakdown = '';
            if (kilometres > 0) {
                breakdown += `Mileage: ${kilometres}km × $${kmRate}/km = $${mileageReimbursement.toFixed(2)}<br>`;
            }
            if (parking > 0) {
                breakdown += `Parking: $${parking.toFixed(2)}<br>`;
            }
            if (tolls > 0) {
                breakdown += `Tolls: $${tolls.toFixed(2)}<br>`;
            }
            breakdownEl.innerHTML = breakdown;
        }
    }
}

// Attach to all relevant inputs
document.addEventListener('DOMContentLoaded', function() {
    ['transportKilometres', 'transportParkingCost', 'transportTollCost'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateTransportTotal);
        }
    });
});

function initializeDatePicker() {
    const dateInput = document.getElementById('shiftDate');
    if (!dateInput) return;
    
    // Calculate date limits
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    // Set max to tomorrow and min to 30 days ago
    dateInput.max = tomorrow.toISOString().split('T')[0];
    dateInput.min = thirtyDaysAgo.toISOString().split('T')[0];
    
    // Set default to today
    dateInput.value = today.toISOString().split('T')[0];
}

// Generate time options in 30-minute increments
function populateTimeSelects() {
    const startTimeSelect = document.getElementById('shiftStartTime');
    const endTimeSelect = document.getElementById('shiftEndTime');
    
    if (!startTimeSelect || !endTimeSelect) return;
    
    // Clear existing options
    startTimeSelect.innerHTML = '<option value="">Select start time</option>';
    endTimeSelect.innerHTML = '<option value="">Select end time</option>';
    
    // Generate time options from 00:00 to 23:30 in 30-minute increments
    for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
            const hourStr = hour.toString().padStart(2, '0');
            const minuteStr = minute.toString().padStart(2, '0');
            const timeValue = `${hourStr}:${minuteStr}`;
            
            let displayHour = hour;
            let period = 'AM';
            if (hour === 0) {
                displayHour = 12;
            } else if (hour === 12) {
                period = 'PM';
            } else if (hour > 12) {
                displayHour = hour - 12;
                period = 'PM';
            }
            const displayText = `${displayHour}:${minuteStr} ${period}`;
            
            // Add options to both selects
            const startOption = new Option(displayText, timeValue);
            const endOption = new Option(displayText, timeValue);
            
            startTimeSelect.appendChild(startOption);
            endTimeSelect.appendChild(endOption);
        }
    }
    
    // Add 11:59 PM as the last option for end time only (for shifts ending at midnight)
    const midnightOption = new Option('11:59 PM', '23:59');
    endTimeSelect.appendChild(midnightOption);
}

// Modified submitShift function
async function submitShift() {
    try {
        const date = document.getElementById('shiftDate').value;
        const participantId = document.getElementById('shiftParticipant').value;
        const dutyTypeId = document.getElementById('shiftDutyType').value;
        const notes = document.getElementById('shiftNotes').value;
        
        if (!date || !participantId || !dutyTypeId) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        // Validate date is not beyond tomorrow
        const selectedDate = new Date(date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        if (selectedDate > tomorrow) {
            showToast('Cannot submit shifts for dates beyond tomorrow', 'error');
            return;
        }
        
        const dutyTypeName = document.getElementById('shiftDutyType').
            options[document.getElementById('shiftDutyType').selectedIndex]?.textContent?.toLowerCase() || '';
        
        let startTime = null;
        let endTime = null;
        
        // Only get times for non-sleepover shifts
        if (!dutyTypeName.includes('sleepover')) {
            startTime = document.getElementById('shiftStartTime').value;
            endTime = document.getElementById('shiftEndTime').value;
            
            if (!startTime || !endTime) {
                showToast('Please select start and end times', 'error');
                return;
            }
            
            // Validate end time is after start time
            if (startTime >= endTime) {
                showToast('End time must be after start time', 'error');
                return;
            }
        }
        
        // Get location from stored assignment
        const locationId = window.staffAssignments?.[participantId]?.locationId;
        const payRateId = window.staffAssignments?.[participantId]?.payRateId || currentStaff.pay_rate_id;
        
        // Create shift with clock_in_required = false for self-submitted shifts
        const shiftData = {
            date: date,
            staff_id: currentStaff.id,
            participant_id: participantId,
            location_id: locationId,
            duty_type_id: dutyTypeId,
            pay_override_id: payRateId,
            start_time: startTime ? `${startTime}:00` : null,
            end_time: endTime ? `${endTime}:00` : null,
            status: 'pending',
            notes: notes,
            created_by: currentStaff.id,
            created_at: new Date().toISOString(),
            
            // Self-submitted shifts don't require clock-in
            clock_in_required: false,
            
            // Set all clock-in/out fields to null for self-submitted shifts
            clock_in_time: null,
            clock_out_time: null,
            clock_in_lat: null,
            clock_in_lng: null,
            clock_out_lat: null,
            clock_out_lng: null,
            clock_in_address: null,
            clock_out_address: null,
            clock_in_distance_meters: null
        };
        
        const { data: newShift, error } = await supabaseClient
            .from('shifts')
            .insert(shiftData)
            .select()
            .single();
        
        if (error) throw error;
        
        showToast('Shift submitted for approval', 'success');
        closeModal('addShiftModal');
        document.getElementById('addShiftForm').reset();
        
        // Refresh any shift displays if needed
        if (typeof loadCurrentShift === 'function') {
            loadCurrentShift();
        }
        
    } catch (error) {
        console.error('Error submitting shift:', error);
        showToast('Failed to submit shift', 'error');
    }
}

// Toggle time fields based on duty type
function toggleTimeFields() {
    const dutyTypeSelect = document.getElementById('shiftDutyType');
    const timeFields = document.getElementById('timeFields');
    
    if (!dutyTypeSelect || !timeFields) return;
    
    const dutyTypeName = dutyTypeSelect.options[dutyTypeSelect.selectedIndex]?.textContent?.toLowerCase() || '';
    
    // Hide time fields for sleepover shifts
    if (dutyTypeName.includes('sleepover')) {
        timeFields.style.display = 'none';
        // Clear time values
        document.getElementById('shiftStartTime').value = '';
        document.getElementById('shiftEndTime').value = '';
    } else {
        timeFields.style.display = 'block';
    }
}

// Initialize when modal is opened
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date and time selects
    initializeDatePicker();
    populateTimeSelects();
    
    // Re-initialize when modal is opened
    const addShiftBtn = document.querySelector('[data-modal-open="addShiftModal"]');
    if (addShiftBtn) {
        addShiftBtn.addEventListener('click', function() {
            initializeDatePicker();
            populateTimeSelects();
        });
    }
});


// 1. Load Profile Data
async function loadProfile() {
    try {
        if (!currentStaff) {
            showToast('Staff data not loaded', 'error');
            return;
        }
        
        // Display Personal Information
        const personalInfo = document.getElementById('personalInfo');
        if (personalInfo) {
            personalInfo.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">First Name</div>
                    <div class="field-value">${currentStaff.first_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Middle Name</div>
                    <div class="field-value">${currentStaff.middle_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Last Name</div>
                    <div class="field-value">${currentStaff.last_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Email</div>
                    <div class="field-value">${currentStaff.email || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Phone</div>
                    <div class="field-value">${currentStaff.phone || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <div class="field-value">${currentStaff.date_of_birth ? formatDate(currentStaff.date_of_birth) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Gender</div>
                    <div class="field-value">${currentStaff.sex || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Staff Code</div>
                    <div class="field-value">${currentStaff.staff_code || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <div class="field-value">${currentStaff.ndis_worker_number || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Start Date</div>
                    <div class="field-value">${currentStaff.start_date ? formatDate(currentStaff.start_date) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Hour Limit</div>
                    <div class="field-value">${currentStaff.limits || '76'} hours/fortnight</div>
                </div>
            `;
        }
        
        // Display Contact Information
        const contactInfo = document.getElementById('contactInfo');
        if (contactInfo) {
            contactInfo.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Address</div>
                    <div class="field-value">${currentStaff.address || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact Name</div>
                    <div class="field-value">${currentStaff.emergency_contact_name || currentStaff.emergency_contact || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact Phone</div>
                    <div class="field-value">${currentStaff.emergency_contact_phone || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Emergency Contact Relationship</div>
                    <div class="field-value">${currentStaff.emergency_contact_relationship || '-'}</div>
                </div>
            `;
        }
        
        // Display Banking Information
        const bankingInfo = document.getElementById('bankingInfo');
        if (bankingInfo) {
            bankingInfo.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">Bank Name</div>
                    <div class="field-value">${currentStaff.bank_name || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">BSB</div>
                    <div class="field-value">${currentStaff.bsb || '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Account Number</div>
                    <div class="field-value">${currentStaff.account_number ? '****' + currentStaff.account_number.slice(-4) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Tax File Number</div>
                    <div class="field-value">${currentStaff.tax_file_number ? '***-***-' + currentStaff.tax_file_number.slice(-3) : '-'}</div>
                </div>
                <div class="profile-field">
                    <div class="field-label">Superannuation Fund</div>
                    <div class="field-value">${currentStaff.super_fund || '-'}</div>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading profile:', error);
        showToast('Failed to load profile', 'error');
    }
}

// 2. Edit Personal Information
function editPersonalInfo() {
    const container = document.getElementById('personalInfo');
    if (!container) return;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">First Name</div>
            <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Middle Name</div>
            <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Last Name</div>
            <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Email</div>
            <input type="email" class="form-control" id="editEmail" value="${currentStaff.email || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Phone</div>
            <input type="tel" class="form-control" id="editPhone" value="${currentStaff.phone || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Date of Birth</div>
            <input type="date" class="form-control" id="editBirthday" value="${currentStaff.date_of_birth || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Gender</div>
            <select class="form-control" id="editSex">
                <option value="">Select</option>
                <option value="Male" ${currentStaff.sex === 'Male' ? 'selected' : ''}>Male</option>
                <option value="Female" ${currentStaff.sex === 'Female' ? 'selected' : ''}>Female</option>
                <option value="Other" ${currentStaff.sex === 'Other' ? 'selected' : ''}>Other</option>
            </select>
        </div>
        <div class="profile-field">
            <div class="field-label">NDIS Worker Number</div>
            <input type="text" class="form-control" id="editNDISNumber" value="${currentStaff.ndis_worker_number || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" data-action="savePersonalInfo">Save Changes</button>
            <button class="btn btn-secondary" data-action="loadProfile">Cancel</button>
        </div>
    `;
}

// 3. Save Personal Information
async function savePersonalInfo() {
    try {
        const updateData = {
            first_name: document.getElementById('editFirstName')?.value || currentStaff.first_name,
            middle_name: document.getElementById('editMiddleName')?.value || null,
            last_name: document.getElementById('editLastName')?.value || currentStaff.last_name,
            email: document.getElementById('editEmail')?.value || currentStaff.email,
            phone: document.getElementById('editPhone')?.value || null,
            date_of_birth: document.getElementById('editBirthday')?.value || null,
            sex: document.getElementById('editSex')?.value || null,
            ndis_worker_number: document.getElementById('editNDISNumber')?.value || null,
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('staff')
            .update(updateData)
            .eq('id', currentStaff.id)
            .select()
            .single();
        
        if (error) throw error;
        
        // Update local state
        currentStaff = data;
        AppState.staff.current = data;
        
        // Update header name
        document.getElementById('userName').textContent = 
            `${data.first_name} ${data.last_name}`;
        
        loadProfile();
        showToast('Personal information updated successfully', 'success');
        
    } catch (error) {
        console.error('Error saving personal info:', error);
        showToast('Failed to save changes: ' + error.message, 'error');
    }
}

function editContactInfo() {
    const container = document.getElementById('contactInfo');
    if (!container) return;
    
    // Reset the validation flag when entering edit mode
    isValidAddressSelected = false;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Address <span style="color: red;">*</span></div>
            <input type="text" 
                   class="form-control" 
                   id="editAddress" 
                   placeholder="Start typing address..."
                   value="${currentStaff.address || ''}"
                   autocomplete="off">
            <small class="form-hint" id="addressHint" style="color: #666; font-size: 0.85em;">
                ⚠️ Please select an address from the dropdown
            </small>
            <!-- Store coordinates in hidden fields -->
            <input type="hidden" id="addressLat" value="${currentStaff.location_lat || ''}">
            <input type="hidden" id="addressLng" value="${currentStaff.location_lng || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Name</div>
            <input type="text" class="form-control" id="editEmergencyName"
                   value="${currentStaff.emergency_contact_name || currentStaff.emergency_contact || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Phone</div>
            <input type="tel" class="form-control" id="editEmergencyPhone"
                   value="${currentStaff.emergency_contact_phone || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Relationship</div>
            <input type="text" class="form-control" id="editEmergencyRelationship"
                   value="${currentStaff.emergency_contact_relationship || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" data-action="saveContactInfo">Save Changes</button>
            <button class="btn btn-secondary" data-action="loadProfile">Cancel</button>
        </div>
    `;
    
    // If there's already a valid address with coordinates, mark as valid
    if (currentStaff.location_lat && currentStaff.location_lng) {
        isValidAddressSelected = true;
        updateAddressValidationUI(true);
    }
    
    // Initialize autocomplete after rendering the HTML
    setTimeout(() => {
        initAddressAutocomplete();
    }, 100);
}



// Initialize address autocomplete for the staff address field
function initAddressAutocomplete() {
    // Check if Google Maps is loaded
    if (!window.google || !window.google.maps || !window.google.maps.places) {
        console.warn('Google Maps not loaded, trying to load...');
        loadGoogleMapsForTeam();
        return;
    }
    
    const addressInput = document.getElementById('editAddress');
    if (!addressInput) {
        console.warn('Address input not found');
        return;
    }
    
    // Add input event listener to detect manual typing
    addressInput.addEventListener('input', function(event) {
        // If user is typing manually, reset validation
        if (!event.isAutocompleteSelection) {
            isValidAddressSelected = false;
            // Clear the hidden coordinate fields
            document.getElementById('addressLat').value = '';
            document.getElementById('addressLng').value = '';
            updateAddressValidationUI(false);
        }
    });
    
    // Add blur event to show warning if they leave without selecting
    addressInput.addEventListener('blur', function() {
        if (addressInput.value && !isValidAddressSelected) {
            updateAddressValidationUI(false, true); // Show error state
        }
    });
    
    // Prevent Enter key from submitting
    addressInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            return false;
        }
    });
    
    try {
        // Create autocomplete
        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
            componentRestrictions: { country: 'au' },
            fields: ['formatted_address', 'geometry']
        });
        
        // Handle place selection
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            
            if (!place || !place.geometry || !place.geometry.location) {
                console.log('No valid place selected');
                isValidAddressSelected = false;
                updateAddressValidationUI(false);
                return;
            }
            
            // Get coordinates
            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();
            
            // Update hidden fields
            document.getElementById('addressLat').value = lat;
            document.getElementById('addressLng').value = lng;
            
            // Update the address field with formatted address
            addressInput.value = place.formatted_address || '';
            
            // Mark as valid selection
            isValidAddressSelected = true;
            updateAddressValidationUI(true);
            
            // Trigger a custom event to mark this as autocomplete selection
            const inputEvent = new Event('input');
            inputEvent.isAutocompleteSelection = true;
            addressInput.dispatchEvent(inputEvent);
            
            console.log(' Valid address selected:', {
                address: place.formatted_address,
                lat: lat,
                lng: lng
            });
        });
        
        console.log(' Address autocomplete initialized');
        
    } catch (error) {
        console.error('Error initializing autocomplete:', error);
    }
}
function updateAddressValidationUI(isValid, showError = false) {
    const addressInput = document.getElementById('editAddress');
    const addressHint = document.getElementById('addressHint');
    
    if (!addressInput || !addressHint) return;
    
    if (isValid) {
        // Valid selection
        addressInput.style.borderColor = '#28a745';
        addressInput.style.backgroundColor = '#f8fff9';
        addressHint.innerHTML = ' Valid address selected';
        addressHint.style.color = '#28a745';
    } else if (showError && addressInput.value) {
        // Invalid - user typed but didn't select
        addressInput.style.borderColor = '#dc3545';
        addressInput.style.backgroundColor = '#fff8f8';
        addressHint.innerHTML = '❌ Please select an address from the dropdown';
        addressHint.style.color = '#dc3545';
    } else {
        // Neutral state
        addressInput.style.borderColor = '';
        addressInput.style.backgroundColor = '';
        addressHint.innerHTML = '⚠️ Please select an address from the dropdown';
        addressHint.style.color = '#666';
    }
}

function editContactInfo() {
    const container = document.getElementById('contactInfo');
    if (!container) return;
    
    // Reset the validation flag when entering edit mode
    isValidAddressSelected = false;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Address <span style="color: red;">*</span></div>
            <input type="text" 
                   class="form-control" 
                   id="editAddress" 
                   placeholder="Start typing address..."
                   value="${currentStaff.address || ''}"
                   autocomplete="off">
            <small class="form-hint" id="addressHint" style="color: #666; font-size: 0.85em;">
                ⚠️ Please select an address from the dropdown
            </small>
            <!-- Store coordinates in hidden fields -->
            <input type="hidden" id="addressLat" value="${currentStaff.location_lat || ''}">
            <input type="hidden" id="addressLng" value="${currentStaff.location_lng || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Name</div>
            <input type="text" class="form-control" id="editEmergencyName"
                   value="${currentStaff.emergency_contact_name || currentStaff.emergency_contact || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Phone</div>
            <input type="tel" class="form-control" id="editEmergencyPhone"
                   value="${currentStaff.emergency_contact_phone || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Emergency Contact Relationship</div>
            <input type="text" class="form-control" id="editEmergencyRelationship"
                   value="${currentStaff.emergency_contact_relationship || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" data-action="saveContactInfo">Save Changes</button>
            <button class="btn btn-secondary" data-action="loadProfile">Cancel</button>
        </div>
    `;
    
    // If there's already a valid address with coordinates, mark as valid
    if (currentStaff.location_lat && currentStaff.location_lng) {
        isValidAddressSelected = true;
        updateAddressValidationUI(true);
    }
    
    // Initialize autocomplete after rendering the HTML
    setTimeout(() => {
        initAddressAutocomplete();
    }, 100);
}

// Initialize address autocomplete for the staff address field
function initAddressAutocomplete() {
    // Check if Google Maps is loaded
    if (!window.google || !window.google.maps || !window.google.maps.places) {
        console.warn('Google Maps not loaded, trying to load...');
        loadGoogleMapsForTeam();
        return;
    }
    
    const addressInput = document.getElementById('editAddress');
    if (!addressInput) {
        console.warn('Address input not found');
        return;
    }
    
    // Add input event listener to detect manual typing
    addressInput.addEventListener('input', function(event) {
        // If user is typing manually, reset validation
        if (!event.isAutocompleteSelection) {
            isValidAddressSelected = false;
            // Clear the hidden coordinate fields
            document.getElementById('addressLat').value = '';
            document.getElementById('addressLng').value = '';
            updateAddressValidationUI(false);
        }
    });
    
    // Add blur event to show warning if they leave without selecting
    addressInput.addEventListener('blur', function() {
        if (addressInput.value && !isValidAddressSelected) {
            updateAddressValidationUI(false, true); // Show error state
        }
    });
    
    // Prevent Enter key from submitting
    addressInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            return false;
        }
    });
    
    try {
        // Create autocomplete
        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
            componentRestrictions: { country: 'au' },
            fields: ['formatted_address', 'geometry']
        });
        
        // Handle place selection
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            
            if (!place || !place.geometry || !place.geometry.location) {
                console.log('No valid place selected');
                isValidAddressSelected = false;
                updateAddressValidationUI(false);
                return;
            }
            
            // Get coordinates
            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();
            
            // Update hidden fields
            document.getElementById('addressLat').value = lat;
            document.getElementById('addressLng').value = lng;
            
            // Update the address field with formatted address
            addressInput.value = place.formatted_address || '';
            
            // Mark as valid selection
            isValidAddressSelected = true;
            updateAddressValidationUI(true);
            
            // Trigger a custom event to mark this as autocomplete selection
            const inputEvent = new Event('input');
            inputEvent.isAutocompleteSelection = true;
            addressInput.dispatchEvent(inputEvent);
            
            console.log(' Valid address selected:', {
                address: place.formatted_address,
                lat: lat,
                lng: lng
            });
        });
        
        console.log(' Address autocomplete initialized');
        
    } catch (error) {
        console.error('Error initializing autocomplete:', error);
    }
}

// Update UI to show validation state
function updateAddressValidationUI(isValid, showError = false) {
    const addressInput = document.getElementById('editAddress');
    const addressHint = document.getElementById('addressHint');
    
    if (!addressInput || !addressHint) return;
    
    if (isValid) {
        // Valid selection
        addressInput.style.borderColor = '#28a745';
        addressInput.style.backgroundColor = '#f8fff9';
        addressHint.innerHTML = ' Valid address selected';
        addressHint.style.color = '#28a745';
    } else if (showError && addressInput.value) {
        // Invalid - user typed but didn't select
        addressInput.style.borderColor = '#dc3545';
        addressInput.style.backgroundColor = '#fff8f8';
        addressHint.innerHTML = '❌ Please select an address from the dropdown';
        addressHint.style.color = '#dc3545';
    } else {
        // Neutral state
        addressInput.style.borderColor = '';
        addressInput.style.backgroundColor = '';
        addressHint.innerHTML = '⚠️ Please select an address from the dropdown';
        addressHint.style.color = '#666';
    }
}

// Modified saveContactInfo with validation
async function saveContactInfo() {
    try {
        // Get the address and coordinates
        const address = document.getElementById('editAddress')?.value || '';
        const lat = document.getElementById('addressLat')?.value;
        const lng = document.getElementById('addressLng')?.value;
        
        // Validate that an address was selected from dropdown
        if (address && !isValidAddressSelected) {
            // Show error state
            updateAddressValidationUI(false, true);
            
            // Show notification
            showNotification('Please select a valid address from the dropdown', 'error');
            
            // Focus the address field
            document.getElementById('editAddress')?.focus();
            
            // Scroll to the address field
            document.getElementById('editAddress')?.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            return; // Don't save
        }
        
        // Optional: Make address required
        if (!address) {
            showNotification('Address is required', 'error');
            document.getElementById('editAddress')?.focus();
            return;
        }
        
        const updates = {
            address: address,
            location_lat: lat ? parseFloat(lat) : null,
            location_lng: lng ? parseFloat(lng) : null,
            emergency_contact_name: document.getElementById('editEmergencyName')?.value || null,
            emergency_contact_phone: document.getElementById('editEmergencyPhone')?.value || null,
            emergency_contact_relationship: document.getElementById('editEmergencyRelationship')?.value || null
        };
        
        console.log('Saving contact info with location:', {
            address: updates.address,
            lat: updates.location_lat,
            lng: updates.location_lng
        });
        
        const { error } = await supabaseClient
            .from('staff')
            .update(updates)
            .eq('id', currentStaff.id);
        
        if (error) throw error;
        
        // Update current staff object
        Object.assign(currentStaff, updates);
        
        showNotification('Contact information updated successfully', 'success');
        loadProfile(); // Reload profile view
        
    } catch (error) {
        console.error('Error saving contact info:', error);
        showNotification('Failed to save contact information', 'error');
    }
}

// Enhanced CSS for validation states
if (!document.getElementById('team-autocomplete-css')) {
    const style = document.createElement('style');
    style.id = 'team-autocomplete-css';
    style.innerHTML = `
        /* Fix Google Places dropdown visibility */
        .pac-container {
            z-index: 10000 !important;
            background: white !important;
            border: 1px solid #ccc !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
        }
        
        .pac-item {
            padding: 10px 14px !important;
            cursor: pointer !important;
            font-size: 14px !important;
        }
        
        .pac-item:hover {
            background-color: #f5f5f5 !important;
        }
        
        .form-hint {
            display: block;
            margin-top: 4px;
            color: #666;
            font-size: 0.85em;
            transition: color 0.3s ease;
        }
        
        /* Validation states */
        #editAddress {
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        
        #editAddress:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
    `;
    document.head.appendChild(style);
}


// Load Google Maps if not already loaded
function loadGoogleMapsForTeam() {
    if (window.google && window.google.maps) {
        console.log('Google Maps already loaded');
        return;
    }
    
    // Check if script is already loading
    if (document.querySelector('script[src*="maps.googleapis.com"]')) {
        console.log('Google Maps script already in DOM, waiting...');
        // Wait for it to load
        const checkInterval = setInterval(() => {
            if (window.google && window.google.maps && window.google.maps.places) {
                clearInterval(checkInterval);
                initAddressAutocomplete();
            }
        }, 500);
        return;
    }
        
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=onGoogleMapsLoaded`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}

// Callback when Google Maps loads
window.onGoogleMapsLoaded = function() {
    console.log('Google Maps loaded');
    // Check if we're in edit mode and need to initialize autocomplete
    if (document.getElementById('editAddress')) {
        initAddressAutocomplete();
    }
}

// CSS for dropdown visibility (add this once to your page)
if (!document.getElementById('team-autocomplete-css')) {
    const style = document.createElement('style');
    style.id = 'team-autocomplete-css';
    style.innerHTML = `
        /* Fix Google Places dropdown visibility */
        .pac-container {
            z-index: 10000 !important;
            background: white !important;
            border: 1px solid #ccc !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
        }
        
        .pac-item {
            padding: 10px 14px !important;
            cursor: pointer !important;
            font-size: 14px !important;
        }
        
        .pac-item:hover {
            background-color: #f5f5f5 !important;
        }
        
        .form-hint {
            display: block;
            margin-top: 4px;
            color: #666;
            font-size: 0.85em;
        }
    `;
    document.head.appendChild(style);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load Google Maps proactively
    loadGoogleMapsForTeam();
});

// 6. Edit Banking Information
function editBankingInfo() {
    const container = document.getElementById('bankingInfo');
    if (!container) return;
    
    container.innerHTML = `
        <div class="profile-field">
            <div class="field-label">Bank Name</div>
            <input type="text" class="form-control" id="editBankName" value="${currentStaff.bank_name || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">BSB</div>
            <input type="text" class="form-control" id="editBSB" value="${currentStaff.bsb || ''}" 
                   maxlength="7" placeholder="XXX-XXX">
        </div>
        <div class="profile-field">
            <div class="field-label">Account Number</div>
            <input type="text" class="form-control" id="editAccountNumber" value="${currentStaff.account_number || ''}">
        </div>
        <div class="profile-field">
            <div class="field-label">Tax File Number</div>
            <input type="text" class="form-control" id="editTFN" value="${currentStaff.tax_file_number || ''}" 
                   maxlength="9" placeholder="XXX XXX XXX">
        </div>
        <div class="profile-field">
            <div class="field-label">Superannuation Fund</div>
            <input type="text" class="form-control" id="editSuper" value="${currentStaff.super_fund || ''}">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" data-action="saveBankingInfo">Save Changes</button>
            <button class="btn btn-secondary" data-action="loadProfile">Cancel</button>
        </div>
    `;
}

// 7. Save Banking Information
async function saveBankingInfo() {
    try {
        const updateData = {
            bank_name: document.getElementById('editBankName')?.value || null,
            bsb: document.getElementById('editBSB')?.value || null,
            account_number: document.getElementById('editAccountNumber')?.value || null,
            tax_file_number: document.getElementById('editTFN')?.value || null,
            super_fund: document.getElementById('editSuper')?.value || null,
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('staff')
            .update(updateData)
            .eq('id', currentStaff.id)
            .select()
            .single();
        
        if (error) throw error;
        
        currentStaff = data;
        AppState.staff.current = data;
        
        loadProfile();
        showToast('Banking information updated successfully', 'success');
        
    } catch (error) {
        console.error('Error saving banking info:', error);
        showToast('Failed to save changes: ' + error.message, 'error');
    }
}

async function saveAvailability() {
    try {
        const form = document.getElementById('availabilityForm');
        const selectedDates = form ? form.querySelectorAll('input[type="date"]') : [];
        
        if (selectedDates.length === 0) {
            // Fallback to checkbox method if using different UI
            return saveWeeklyAvailability();
        }
        
        const records = [];
        selectedDates.forEach(input => {
            if (input.value) {
                const isAvailable = input.dataset.available === 'true';
                const startTime = document.getElementById(`start_${input.id}`)?.value;
                const endTime = document.getElementById(`end_${input.id}`)?.value;
                
                records.push({
                    staff_id: currentStaff.id,
                    date: input.value,
                    is_available: isAvailable, // Correct column name
                    start_time: startTime || null,
                    end_time: endTime || null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                });
            }
        });
        
        if (records.length === 0) {
            showToast('Please select at least one date', 'warning');
            return;
        }
        
        // Use upsert to handle unique constraint
        const { error } = await supabaseClient
            .from('staff_availability')
            .upsert(records, {
                onConflict: 'staff_id,date',
                ignoreDuplicates: false
            });
        
        if (error) throw error;
        
        showToast('Availability saved successfully', 'success');
        
    } catch (error) {
        console.error('Error saving availability:', error);
        showToast('Failed to save availability: ' + error.message, 'error');
    }
}

async function populateDocumentTypes() {
    const select = document.getElementById('documentType');
    if (!select) return;
    
    try {
        // Load document types from the document_types table
        const { data: types, error } = await supabaseClient
            .from('document_types')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        if (error) {
            console.error('Error loading document types:', error);
            select.innerHTML = '<option value="">Failed to load types</option>';
            return;
        }
        
        // Clear existing options
        select.innerHTML = '<option value="">Select document type</option>';
        
        if (types && types.length > 0) {
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                option.dataset.requiresExpiry = type.requires_expiry;
                select.appendChild(option);
            });
            
            // Add event listener to show/hide expiry date field based on type
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const requiresExpiry = selectedOption.dataset.requiresExpiry === 'true';
                const expiryField = document.getElementById('documentExpiryField');
                
                if (expiryField) {
                    expiryField.style.display = requiresExpiry ? 'block' : 'none';
                    if (!requiresExpiry) {
                        // Clear expiry date if not required
                        const expiryInput = document.getElementById('documentExpiry');
                        if (expiryInput) expiryInput.value = '';
                    }
                }
            });
        } else {
            select.innerHTML += '<option value="">No document types available</option>';
        }
        
    } catch (error) {
        console.error('Error populating document types:', error);
        select.innerHTML = '<option value="">Error loading types</option>';
    }
}

function checkExpiryRequired() {
    const documentType = document.getElementById('documentType');
    const selectedOption = documentType.options[documentType.selectedIndex];
    const expiryGroup = document.getElementById('expiryGroup');
    const expiryInput = document.getElementById('documentExpiry');
    
    if (selectedOption && selectedOption.dataset.requiresExpiry === 'true') {
        expiryGroup.style.display = 'block';
        expiryInput.required = true;
    } else {
        expiryGroup.style.display = 'none';
        expiryInput.required = false;
    }
}


// Availability functions
function toggleDayAvailability(day, available) {
    // Update all time slots for the day
    for (let slot = 0; slot < 4; slot++) {
        weeklyAvailability[`${day}_${slot}`] = available;
    }
    renderAvailability();
}

function toggleTimeSlot(day, slot, element) {
    const key = `${day}_${slot}`;
    weeklyAvailability[key] = !weeklyAvailability[key];
    element.classList.toggle('selected');
}



let cropper = null;
let selectedFile = null;

// When user selects a file, open the editor instead of uploading directly
document.getElementById('bannerUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Check file type
    if (!file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
    }
    
    // Check file size
    if (file.size > 10 * 1024 * 1024) {
        showToast('File size must be less than 10MB', 'error');
        return;
    }
    
    selectedFile = file;
    openPhotoEditor(file);
});

function openPhotoEditor(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const modal = document.getElementById('photoEditorModal');
        const image = document.getElementById('imageToCrop');
        
        image.src = e.target.result;
        modal.classList.add('active');
        
        // Initialize Cropper.js
        if (cropper) {
            cropper.destroy();
        }
        
        cropper = new Cropper(image, {
            aspectRatio: 3, // 3:1 ratio for banner
            viewMode: 1,
            guides: true,
            center: true,
            highlight: true,
            background: true,
            autoCrop: true,
            movable: true,
            rotatable: true,
            scalable: true,
            zoomable: true,
            cropBoxMovable: true,
            cropBoxResizable: true,
        });
    };
    reader.readAsDataURL(file);
}

function closePhotoEditor() {
    const modal = document.getElementById('photoEditorModal');
    modal.classList.remove('active');
    
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    // Reset file input
    document.getElementById('bannerUpload').value = '';
}

function rotateCropper(degrees) {
    if (cropper) {
        cropper.rotate(degrees);
    }
}

function resetCropper() {
    if (cropper) {
        cropper.reset();
    }
}

async function saveCroppedImage() {
    if (!cropper) return;
    
    try {
        showToast('Processing image...', 'info');
        
        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
            width: 1200,  // Output width
            height: 400,  // Output height
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });
        
        // Convert to blob
        canvas.toBlob(async (blob) => {
            // Convert blob to base64
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Data = reader.result;
                
                try {
                    // Delete existing banner
                    await supabaseClient
                        .from('attachments')
                        .delete()
                        .eq('entity_type', 'staff')
                        .eq('entity_id', currentStaff.id)
                        .eq('file_type', 'profile_banner');
                    
                    // Save new banner
                    const { data, error } = await supabaseClient
                        .from('attachments')
                        .insert({
                            entity_type: 'staff',
                            entity_id: currentStaff.id,
                            file_type: 'profile_banner',
                            file_name: selectedFile.name,
                            file: base64Data,
                            file_url: 'stored-in-db',
                            file_size: blob.size,
                            mime_type: 'image/jpeg',
                            uploaded_by: currentUser.id
                        })
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update UI immediately
                    const bannerElement = document.getElementById('profileBanner');
                    if (bannerElement) {
                        bannerElement.style.backgroundImage = `url(${base64Data})`;
                        bannerElement.classList.add('has-image');  // ADD THIS LINE
                    }
                    
                    closePhotoEditor();
                    showToast('Banner updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error saving banner:', error);
                    showToast('Failed to save banner', 'error');
                }
            };
            reader.readAsDataURL(blob);
            
        }, 'image/jpeg', 0.9);
        
    } catch (error) {
        console.error('Error processing image:', error);
        showToast('Failed to process image', 'error');
    }
}


async function uploadProfileBanner() {
    const fileInput = document.getElementById('bannerUpload');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select a file', 'error');
        return;
    }
    
    try {
        // Check file size (5MB limit for banners)
        if (file.size > 5 * 1024 * 1024) {
            showToast('File size must be less than 5MB', 'error');
            return;
        }
        
        // Check if image type
        if (!file.type.startsWith('image/')) {
            showToast('Please select an image file', 'error');
            return;
        }
        
        // Compress/resize image before upload
        const compressedFile = await compressImage(file, 1200, 0.8); // Max width 1200px, 80% quality
        
        // Convert to base64 for storing in attachments table
        const reader = new FileReader();
        reader.onloadend = async () => {
            try {
                const base64Data = reader.result;
                
                // Delete existing banner if exists
                await supabaseClient
                    .from('attachments')
                    .delete()
                    .eq('entity_type', 'staff')
                    .eq('entity_id', currentStaff.id)
                    .eq('file_type', 'profile_banner');
                
                // Insert new banner to attachments table
                const { data, error } = await supabaseClient
    .from('attachments')
    .insert({
        entity_type: 'staff',
        entity_id: currentStaff.id,
        file_type: 'profile_banner',
        file_name: file.name,
        file: base64Data,  // CHANGED from file_data to file
        file_size: compressedFile.size,
        mime_type: compressedFile.type,
        uploaded_by: currentUser.id
    })
    .select()
    .single();

                if (error) throw error;
                
                // Update UI immediately
                const bannerElement = document.getElementById('profileBanner');
                if (bannerElement) {
                    bannerElement.style.backgroundImage = `url(${base64Data})`;
                }
                
                showToast('Banner uploaded successfully', 'success');
                
            } catch (error) {
                console.error('Error saving banner:', error);
                showToast('Failed to upload banner', 'error');
            }
        };
        
        reader.readAsDataURL(compressedFile);
        
    } catch (error) {
        console.error('Error uploading banner:', error);
        showToast('Failed to upload banner', 'error');
    }
}

async function loadProfileBanner() {
    if (!currentStaff) return;
    
    const bannerElement = document.getElementById('profileBanner');
    
    try {
        const { data } = await supabaseClient
            .from('attachments')
            .select('file')
            .eq('entity_type', 'staff')
            .eq('entity_id', currentStaff.id)
            .eq('file_type', 'profile_banner')
            .single();
        
        if (data && data.file && bannerElement) {
            bannerElement.style.backgroundImage = `url(${data.file})`;
            bannerElement.classList.add('has-image');  // ADD THIS
        }
    } catch (error) {
        // No banner - remove the class
        if (bannerElement) {
            bannerElement.classList.remove('has-image');
        }
    }
}

// Helper function to compress/resize image
async function compressImage(file, maxWidth, quality) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Calculate new dimensions
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(
                    (blob) => {
                        resolve(new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        }));
                    },
                    'image/jpeg',
                    quality
                );
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

async function loadHandoverNotes(participantId, shiftDate) {
    if (!participantId || !shiftDate) return [];
    
    try {
        // Get recent shifts for this participant
        const startDate = new Date(shiftDate);
        startDate.setDate(startDate.getDate() - 7); // Look back 7 days
        
        const { data: recentShifts, error: shiftsError } = await supabaseClient
            .from('shifts')
            .select('id')
            .eq('participant_id', participantId)
            .gte('date', startDate.toISOString().split('T')[0])
            .lte('date', shiftDate)
            .is('deleted_at', null);
        
        if (shiftsError || !recentShifts || recentShifts.length === 0) {
            return [];
        }
        
        // Get shift IDs as integers
        const shiftIds = recentShifts.map(shift => shift.id);
        
        // Fetch notes for these shifts - no UUID conversion needed!
        const { data: notes, error: notesError } = await supabaseClient
            .from('shift_notes')
            .select(`
                *,
                staff:staff_id(first_name, last_name)
            `)
            .in('shift_id', shiftIds)  // Direct integer array
            .is('deleted_at', null)
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (notesError) {
            console.error('Error loading handover notes:', notesError);
            return [];
        }
        
        return notes || [];
        
    } catch (error) {
        console.error('Error in loadHandoverNotes:', error);
        return [];
    }
}


async function addNoteToShift(shiftId) {
    try {
        // Open the modal
        const modal = document.getElementById('addNoteModal');
        if (!modal) {
            console.error('Add note modal not found');
            showToast('Note modal not available', 'error');
            return;
        }
        
        // Store the shift ID for later use
        window.currentNoteShiftId = shiftId;
        
        // Set the shift ID in a hidden field if it exists
        const shiftIdField = document.getElementById('noteShiftId');
        if (shiftIdField) {
            shiftIdField.value = shiftId;
        }
        
        // Open the modal
        openModal('addNoteModal');
        
        // Pre-select the shift if there's a dropdown
        const shiftSelect = document.getElementById('noteShift');
        if (shiftSelect) {
            setTimeout(() => {
                shiftSelect.value = shiftId;
            }, 100);
        }
        
    } catch (error) {
        console.error('Error in addNoteToShift:', error);
        showToast('Failed to open note form', 'error');
    }
}

async function loadSchedule() {
    try {
        // Use the same period as timesheet - no separate period tracking
        if (!window.currentPeriodStart || !window.currentPeriodEnd) {
            console.warn('Period not set, initializing...');
            setCurrentPayPeriod();
        }
        
        // Format dates for query
        const startQuery = normalizeDateForQuery(window.currentPeriodStart);
        const endQuery = normalizeDateForQuery(window.currentPeriodEnd);
        
        console.log('Loading schedule for period:', startQuery, 'to', endQuery);
        
        // Get participant filter value
        const participantFilter = document.getElementById('participantFilter')?.value || '';
        
        // Build query
        let query = supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                locations(name),
                duty_types(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', startQuery)
            .lte('date', endQuery)
            .is('deleted_at', null)
            .order('date')
            .order('start_time');
        
        // Apply participant filter if selected
        if (participantFilter) {
            query = query.eq('participant_id', participantFilter);
        }
        
        const { data: shifts, error } = await query;
        
        if (error) throw error;
        
        // Render the schedule
        if (typeof renderScheduleGrid === 'function') {
            renderScheduleGrid(shifts);
        } else if (typeof renderSchedule === 'function') {
            renderSchedule(shifts);
        }
        
    } catch (error) {
        console.error('Error loading schedule:', error);
        showToast('Failed to load schedule', 'error');
    }
}



function renderWeeklySchedule(weekStart, weekEnd, shifts) {
    const container = document.getElementById('scheduleGrid');
    if (!container) return;
    
    // Create week navigation header
    let html = `
        <div class="schedule-header">
            <button class="btn btn-sm" data-action-with-param="changeWeek" data-param="-1">← Previous Week</button>
            <div class="week-display">
                <h3>${formatDateShort(weekStart.toISOString().split('T')[0])} - ${formatDateShort(weekEnd.toISOString().split('T')[0])}</h3>
            </div>
            <button class="btn btn-sm" data-action-with-param="changeWeek" data-param="1">Next Week →</button>
        </div>
    `;
    
    // Group shifts by date
    const shiftsByDate = {};
    const daysOfWeek = [];
    
    // Generate all days of the week
    for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        daysOfWeek.push(dateStr);
        shiftsByDate[dateStr] = [];
    }
    
    // Populate shifts into their dates
    shifts.forEach(shift => {
        if (shiftsByDate[shift.date]) {
            shiftsByDate[shift.date].push(shift);
        }
    });
    
    // Render each day
    html += '<div class="weekly-schedule">';
    
    daysOfWeek.forEach(dateStr => {
        const date = new Date(dateStr + 'T12:00:00');
        const isToday = dateStr === getTestDate().toISOString().split('T')[0];
        const dayShifts = shiftsByDate[dateStr];
        
        html += `
            <div class="day-section ${isToday ? 'today' : ''}">
                <div class="day-header">
                    <div class="day-name">${date.toLocaleDateString('en-AU', { weekday: 'long' })}</div>
                    <div class="day-date">${date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })}</div>
                    ${dayShifts.length > 0 ? `<span class="shift-count">${dayShifts.length} shift${dayShifts.length > 1 ? 's' : ''}</span>` : ''}
                </div>
                <div class="day-shifts">
        `;
        
        if (dayShifts.length === 0) {
            html += '<div class="no-shifts">No shifts scheduled</div>';
        } else {
            dayShifts.forEach(shift => {
                const participant = shift.participants;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                html += `
                    <div class="shift-item" data-action="showParticipantShifts" data-participant-id="${shift.participant_id}" data-participant-name="${participantName}" style="cursor: pointer;">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                            ${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                        <div class="shift-participant">
                            <strong>${participantName}</strong>
                            ${participant?.ndis_number ? `<span class="ndis-number">(${participant.ndis_participant_number})</span>` : ''}
                        </div>
                        <div class="shift-location">
    <i class="fa-solid fa-location-dot"></i> ${shift.locations?.name || 'Client Home'}
</div>
                        ${shift.duty_types ? `<div class="shift-duty-type">${shift.duty_types.name}</div>` : ''}
                    </div>
                `;
            });
        }
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    container.innerHTML = html;
}

// Function to change week
window.changeWeek = function(direction) {
    window.currentWeekOffset = (window.currentWeekOffset || 0) + direction;
    
    const today = getTestDate();
    const currentDay = today.getDay();
    const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
    const weekStart = new Date(today.setDate(diff + (window.currentWeekOffset * 7)));
    
    loadSchedule();
};

window.showParticipantShifts = async function(participantId, participantName) {
    try {
        if (!participantId) return;
        
        // Get ALL shifts for this participant (any staff)
        const { data: participantShifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                locations(name, address),
                duty_types(name)
            `)
            .eq('participant_id', participantId)
            .is('deleted_at', null)
            .order('date', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        
        // Get staff names separately to avoid the foreign key ambiguity
        const staffIds = [...new Set(participantShifts?.map(s => s.staff_id) || [])];
        const { data: staffData } = await supabaseClient
    .from('staff')
    .select('id, user_id, ndis_worker_number, pay_rate_id, first_name, last_name, email, phone, limit') // <-- Add limit here
    .eq('user_id', currentUser.id)
    .single();

        
        const staffMap = {};
        staffData?.forEach(s => {
            staffMap[s.id] = `${s.first_name} ${s.last_name}`;
        });
        
        // Create modal
        const modalHtml = `
            <div id="participantShiftsModal" class="modal active" style="display: flex;">
                <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Shift History: ${participantName}</h3>
                        <button class="modal-close" data-action="removeModal" data-modal-id="participantShiftsModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="padding: 20px;">
                            ${!participantShifts || participantShifts.length === 0 ? 
                                '<p>No shifts found for this participant</p>' :
                                participantShifts.map(shift => `
                                    <div class="shift-history-item" style="margin-bottom: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">
                                            ${formatDateLong(shift.date)}
                                        </div>
                                        <div style="color: #666;">
                                            <div>
                                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                                                ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                                            </div>
                                            <div>Staff: ${staffMap[shift.staff_id] || 'Unassigned'}</div>
                                            <div class="shift-location">
    <i class="fa-solid fa-location-dot"></i> ${shift.locations?.name || 'Client Home'}
</div>
                                            ${shift.duty_types ? `<div>Type: ${shift.duty_types.name}</div>` : ''}
                                            <div style="display: inline-block; margin-top: 5px; padding: 2px 8px; background: ${shift.status === 'confirmed' ? '#28a745' : '#ffc107'}; color: white; border-radius: 4px; font-size: 12px;">
                                                ${shift.status || 'confirmed'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal and add new one
        document.getElementById('participantShiftsModal')?.remove();
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Error showing participant shifts:', error);
        showToast('Failed to load participant history', 'error');
    }
};


// ==========================================
// SIMPLIFIED DATE/TIME CALCULATION SYSTEM
// ==========================================

// 1. Time Constants & Configuration
const TIME_CONFIG = {
    periods: {
        day: { start: 6, end: 20 },      // 6 AM - 8 PM
        evening: { start: 20, end: 24 },  // 8 PM - Midnight
        night: { start: 0, end: 6 }       // Midnight - 6 AM
    },
    days: {
        weekday: [1, 2, 3, 4, 5],  // Mon-Fri
        saturday: [6],
        sunday: [0]
    },
    sleepover: {
        hours: 2,  // Sleepovers count as 2 hours
        count: 1
    }
};

function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };

    // Check if this shift falls on a public holiday
    const shiftDateKey = shift.date.split('T')[0];
    const isPublicHoliday = publicHolidays.has(shiftDateKey);
    const holidayInfo = isPublicHoliday ? publicHolidays.get(shiftDateKey) : null;

    // Set the flag on the shift object for rendering
    shift.is_public_holiday = isPublicHoliday;
    if (isPublicHoliday) {
        shift.public_holiday_name = publicHolidays.get(shiftDateKey).name;
    }

    // Sleepover check
    const isSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover') || 
                       (!shift.start_time && !shift.end_time);

    if (shift.start_time && shift.end_time) {
        // Calculate active hours
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const totalHours = (endTime - startTime) / (1000 * 60 * 60);
        result.total = totalHours;
        
        // Apply penalty logic - PUBLIC HOLIDAY TAKES PRECEDENCE
        if (isPublicHoliday) {
            result.publicHoliday = totalHours;
        } else {
            const shiftDate = new Date(shift.date);
            const dayOfWeek = shiftDate.getDay();
            
            if (dayOfWeek === 6) {
                result.saturday = totalHours;
            } else if (dayOfWeek === 0) {
                result.sunday = totalHours;
            } else {
                // For weekdays, you might need to add time-of-day splitting logic here
                result.weekdayDay = totalHours;
            }
        }
        
        // Add sleepover hours if applicable
        if (isSleepover) {
            result.sleepover = 2;
            result.total += 2;
        }
    } else if (isSleepover) {
        // Just a sleepover
        result.sleepover = 2;
        result.total = 2;
    }
    
    return result;
}
// 3. Helper Functions
function isSleepoverShift(shift) {
    const dutyType = shift.duty_types?.name || '';
    return dutyType.toLowerCase().includes('sleepover') || !shift.start_time;
}

function parseShiftTimes(shift) {
    const [startHour, startMin] = shift.start_time.split(':').map(Number);
    const [endHour, endMin] = shift.end_time.split(':').map(Number);
    
    const startTime = new Date(shift.date + 'T' + shift.start_time);
    let endTime = new Date(shift.date + 'T' + shift.end_time);
    
    // Handle overnight shifts
    if (endHour < startHour || (endHour === startHour && endMin < startMin)) {
        endTime.setDate(endTime.getDate() + 1);
    }
    
    return { startTime, endTime };
}

function calculateWeekdayBreakdown(startTime, endTime) {
    const breakdown = { day: 0, evening: 0, night: 0 };
    let current = new Date(startTime);
    
    while (current < endTime) {
        const hour = current.getHours();
        const nextHour = new Date(current);
        nextHour.setHours(hour + 1, 0, 0, 0);
        
        const periodEnd = nextHour > endTime ? endTime : nextHour;
        const periodHours = (periodEnd - current) / (1000 * 60 * 60);
        
        // Assign to correct period
        if (hour >= TIME_CONFIG.periods.day.start && hour < TIME_CONFIG.periods.day.end) {
            breakdown.day += periodHours;
        } else if (hour >= TIME_CONFIG.periods.evening.start) {
            breakdown.evening += periodHours;
        } else {
            breakdown.night += periodHours;
        }
        
        current = new Date(periodEnd);
    }
    
    return breakdown;
}

// 4. Unified Date/Time Formatter
const DateTimeFormatter = {
    // Locale configuration
    locale: 'en-AU',
    
    // Format configurations
    formats: {
        long: { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        },
        short: { 
            weekday: 'short',
            day: 'numeric', 
            month: 'short' 
        },
        friendly: { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short' 
        },
        date: {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        },
        datetime: {
            day: 'numeric',
            month: 'short',
            hour: 'numeric',
            minute: '2-digit'
        }
    },
    
    // Parse date consistently
    parseDate(dateString) {
        if (!dateString) return null;
        // Add noon time to avoid timezone issues
        if (!dateString.includes('T')) {
            dateString += 'T12:00:00';
        }
        return new Date(dateString);
    },
    
    // Format date with specified format
    format(dateString, formatType = 'short') {
        if (!dateString) return '';
        const date = this.parseDate(dateString);
        return date.toLocaleDateString(this.locale, this.formats[formatType]);
    },
    
    // Format time (12-hour with AM/PM)
    formatTime(timeString) {
        if (!timeString) return '';
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const period = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        return `${displayHour}:${minutes} ${period}`;
    },
    
    // Format datetime
    formatDateTime(dateString) {
        if (!dateString) return '';
        const date = this.parseDate(dateString);
        return date.toLocaleString(this.locale, this.formats.datetime);
    },
    
    // Get greeting based on time
    getGreeting(date = new Date()) {
        const hour = date.getHours();
        if (hour < 12) return 'Good morning';
        if (hour < 17) return 'Good afternoon';
        return 'Good evening';
    }
};

// 6. Week/Period Utilities
function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday start
    return new Date(d.setDate(diff));
}

function setGreeting() {
    const testDate = typeof getTestDate === 'function' ? getTestDate() : new Date();
    const greeting = DateTimeFormatter.getGreeting(testDate);
    
    const greetingEl = document.getElementById('greeting');
    if (greetingEl && currentStaff) {
        greetingEl.textContent = `${greeting}, ${currentStaff.first_name}!`;
    }
    
    const dateEl = document.getElementById('currentDate');
    if (dateEl) {
        // Get local date string in YYYY-MM-DD format WITHOUT timezone conversion
        const year = testDate.getFullYear();
        const month = String(testDate.getMonth() + 1).padStart(2, '0');
        const day = String(testDate.getDate()).padStart(2, '0');
        const localDateString = `${year}-${month}-${day}`;
        
        dateEl.textContent = formatDateLong(localDateString);
    }
}

function changeMonth(direction) {
    if (!window.currentMonthOffset) {
        window.currentMonthOffset = 0;
    }
    window.currentMonthOffset += direction;
    loadSchedule();
}

        function populateParticipantFilter() {
            const select = document.getElementById('participantFilter');
            const uniqueParticipants = {};
            
            allShifts.forEach(shift => {
                if (shift.participant) {
                    uniqueParticipants[shift.participant_id] = shift.participant;
                }
            });

            select.innerHTML = '<option value="">All My Clients</option>';
            Object.values(uniqueParticipants).forEach(participant => {
                select.innerHTML += `
                    <option value="${participant.id}">
                        ${participant.first_name} ${participant.last_name}
                    </option>
                `;
            });
        }


        // ==========================================
// MODULAR UI RENDERING SYSTEM
// ==========================================

// 1. UI Component Factory
const UIComponents = {
    // Security: HTML escaping
    escape(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },
    
    // Generic element creator
    createElement(tag, options = {}) {
        const element = document.createElement(tag);
        
        if (options.class) element.className = options.class;
        if (options.id) element.id = options.id;
        if (options.text) element.textContent = options.text;
        if (options.html) element.innerHTML = options.html;
        if (options.style) element.style.cssText = options.style;
        if (options.data) {
            Object.entries(options.data).forEach(([key, value]) => {
                element.dataset[key] = value;
            });
        }
        if (options.attrs) {
            Object.entries(options.attrs).forEach(([key, value]) => {
                element.setAttribute(key, value);
            });
        }
        if (options.events) {
            Object.entries(options.events).forEach(([event, handler]) => {
                element.addEventListener(event, handler);
            });
        }
        if (options.children) {
            options.children.forEach(child => {
                if (typeof child === 'string') {
                    element.insertAdjacentHTML('beforeend', child);
                } else if (child) {
                    element.appendChild(child);
                }
            });
        }
        
        return element;
    },
    
    // Empty state component
    emptyState(message) {
        return this.createElement('div', {
            class: 'p-2 text-center',
            style: 'color: var(--text-light);',
            text: message
        });
    },
    
    // Shift list item component
    shiftListItem(shift, options = {}) {
        const participant = shift.participants;
        const hours = calculateShiftHours(shift);
        const dutyType = shift.duty_types?.name || 'Regular';
        
        return this.createElement('div', {
            class: 'shift-list-item',
            data: { shiftId: shift.id },
            children: [
                this.createElement('div', {
                    class: 'shift-info',
                    children: [
                        this.createElement('div', {
                            class: 'shift-date-time',
                            html: `
                                ${options.showDate ? formatDateShort(shift.date) + ' - ' : ''}
                                ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                ${shift.end_time ? formatTime(shift.end_time) : ''}
                                ${dutyType !== 'Regular' ? `<span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">${dutyType}</span>` : ''}
                            `
                        }),
                        participant && this.createElement('div', {
                            class: 'shift-client',
                            text: `${participant.first_name} ${participant.last_name}${shift.locations ? ` - ${shift.locations.name}` : ''}`
                        })
                    ].filter(Boolean)
                }),
                this.createElement('div', {
                    class: 'shift-hours',
                    children: [
                        this.createElement('div', {
                            class: 'shift-hours-value',
                            text: `${hours.total.toFixed(1)}h`
                        })
                    ]
                })
            ]
        });
    },
    
    // Group header component
    groupHeader(title, totalHours, style = {}) {
        return this.createElement('div', {
            style: `font-weight: 600; padding: 12px 16px; background: var(--bg-light); border-bottom: 1px solid var(--border-color); ${style.css || ''}`,
            children: [
                this.createElement('span', { text: title }),
                this.createElement('span', {
                    style: 'float: right; color: var(--primary-color);',
                    text: `${totalHours.toFixed(1)}h`
                })
            ]
        });
    },
    
    // Transfer item component
    transferItem(transfer, type = 'incoming') {
        const statusClass = `status-${transfer.status || 'pending'}`;
        const isIncoming = type === 'incoming';
        
        return this.createElement('div', {
            class: 'transfer-item',
            data: { transferId: transfer.id },
            children: [
                // Header
                this.createElement('div', {
                    class: 'transfer-header',
                    children: [
                        this.createElement('div', {
                            children: [
                                this.createElement('div', {
                                    class: 'transfer-date',
                                    text: formatDateLong(transfer.shift?.date)
                                }),
                                this.createElement('div', {
                                    class: 'transfer-time',
                                    html: `
                                        ${transfer.shift?.start_time ? formatTime(transfer.shift.start_time) : 'Sleepover'} - 
                                        ${transfer.shift?.end_time ? formatTime(transfer.shift.end_time) : ''}
                                    `
                                })
                            ]
                        }),
                        this.createElement('div', {
                            class: `transfer-badge ${statusClass}`,
                            text: transfer.status || 'Pending'
                        })
                    ]
                }),
                
                // From/To line
                this.createElement('div', {
                    class: 'transfer-from',
                    text: isIncoming ? 
                        `From: ${transfer.from_staff?.first_name} ${transfer.from_staff?.last_name}` :
                        `To: ${transfer.to_staff?.first_name || 'Pending'} ${transfer.to_staff?.last_name || ''}`
                }),
                
                // Reason (if exists)
                transfer.reason && this.createElement('div', {
                    class: 'transfer-reason',
                    text: `"${this.escape(transfer.reason)}"`
                }),
                
                // Actions (only for pending incoming)
                isIncoming && transfer.status === 'pending' && this.createElement('div', {
                    class: 'transfer-actions',
                    children: [
                        this.createElement('button', {
                            class: 'transfer-btn accept',
                            text: 'Accept',
                            events: { click: () => acceptTransfer(transfer.id) }
                        }),
                        this.createElement('button', {
                            class: 'transfer-btn decline',
                            text: 'Decline',
                            events: { click: () => declineTransfer(transfer.id) }
                        })
                    ]
                })
            ].filter(Boolean)
        });
    },
    
    // Note item component
    noteItem(note) {
        const staffName = note.staff ? 
            `${note.staff.first_name} ${note.staff.last_name}` : 
            'Unknown Staff';
        
        return this.createElement('div', {
            class: 'note-item',
            children: [
                this.createElement('div', {
                    class: 'note-header',
                    children: [
                        this.createElement('span', {
                            class: 'note-author',
                            text: staffName
                        }),
                        this.createElement('span', {
                            class: 'note-time',
                            text: formatDateTime(note.created_at)
                        })
                    ]
                }),
                this.createElement('div', {
                    class: 'note-content',
                    text: note.note
                }),
                this.createElement('div', {
                    class: 'note-type',
                    text: note.note_type
                })
            ]
        });
    },
    
    // Availability day component
    availabilityDay(day, index, availability) {
        const isAvailable = availability[`${index}_0`] || 
                          availability[`${index}_1`] || 
                          availability[`${index}_2`] || 
                          availability[`${index}_3`];
        
        return this.createElement('div', {
            class: 'availability-day',
            children: [
                this.createElement('div', {
                    class: 'availability-day-header',
                    children: [
                        this.createElement('span', {
                            class: 'day-name',
                            text: day
                        }),
                        this.createElement('label', {
                            class: 'availability-toggle',
                            children: [
                                this.createElement('input', {
                                    attrs: {
                                        type: 'checkbox',
                                        checked: isAvailable
                                    },
                                    events: {
                                        change: (e) => toggleDayAvailability(index, e.target.checked)
                                    }
                                }),
                                this.createElement('span', {
                                    class: 'toggle-slider'
                                })
                            ]
                        })
                    ]
                }),
                this.createElement('div', {
                    class: 'availability-times',
                    children: [
                        { slot: 0, label: 'Morning' },
                        { slot: 1, label: 'Afternoon' },
                        { slot: 2, label: 'Evening' },
                        { slot: 3, label: 'Night' }
                    ].map(({ slot, label }) => 
                        this.createElement('div', {
                            class: `time-slot ${availability[`${index}_${slot}`] ? 'selected' : ''}`,
                            text: label,
                            events: {
                                click: function() { toggleTimeSlot(index, slot, this); }
                            }
                        })
                    )
                })
            ]
        });
    }
};



function renderIncomingTransfers(transfers) {
    const container = document.getElementById('incomingList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transfers.length === 0) {
        container.appendChild(
            UIComponents.emptyState('No incoming transfer requests')
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    transfers.forEach(transfer => {
        fragment.appendChild(
            UIComponents.transferItem(transfer, 'incoming')
        );
    });
    
    container.appendChild(fragment);
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
    });
}

function formatDateFriendly(dateStr) {
    if (!dateStr) return 'Unknown';
    const date = new Date(dateStr);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-AU', options);
}

function formatTime12Hour(timeStr) {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    const date = new Date(dateTimeStr);
    return date.toLocaleDateString('en-AU', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-AU', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function formatDateShort(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-AU', { 
        month: 'short', 
        day: 'numeric' 
    });
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleString('en-AU', { 
        year: 'numeric',
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}



function formatDateShort(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {
        day: 'numeric',
        month: 'short'
    });
}

function formatDateLong(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
}


function renderShiftRow(shift) {
    const participant = shift.participants;
    const location = shift.locations;
    const dutyType = shift.duty_types;
    const hours = calculateShiftHours(shift);
    
    return `
        <div class="shift-row">
            <div class="shift-info">
                <div class="shift-time">
                    ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'} - 
                    ${shift.end_time ? formatTime12Hour(shift.end_time) : ''}
                </div>
                <div class="shift-client">
                    ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                </div>
                <div class="shift-location">
    <i class="fa-solid fa-location-dot"></i> ${shift.locations?.name || 'Client Home'}
</div>
            </div>
            <div class="shift-hours">
                ${hours.total.toFixed(1)}h
            </div>
        </div>
    `;
}

function renderOutgoingTransfers(transfers) {
    const container = document.getElementById('outgoingList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transfers.length === 0) {
        container.appendChild(
            UIComponents.emptyState('No outgoing transfer requests')
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    transfers.forEach(transfer => {
        fragment.appendChild(
            UIComponents.transferItem(transfer, 'outgoing')
        );
    });
    
    container.appendChild(fragment);
}

function renderNotes(container, notes) {
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!notes || notes.length === 0) {
        container.appendChild(
            UIComponents.createElement('div', {
                style: 'color: var(--text-light);',
                text: 'No handover notes yet'
            })
        );
        return;
    }
    
    const fragment = document.createDocumentFragment();
    notes.forEach(note => {
        fragment.appendChild(UIComponents.noteItem(note));
    });
    
    container.appendChild(fragment);
}

function renderAvailability() {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const container = document.getElementById('availabilityGrid');
    if (!container) return;
    
    container.innerHTML = '';
    
    const fragment = document.createDocumentFragment();
    days.forEach((day, index) => {
        fragment.appendChild(
            UIComponents.availabilityDay(day, index, weeklyAvailability)
        );
    });
    
    container.appendChild(fragment);
}

// 3. Keep complex calendar renders as template functions for now
// (These are complex enough that DOM manipulation might be overkill)

const CalendarTemplates = {
    renderSchedule(container, filterValue, allShifts) {
        if (!container) return;
        
        let filteredShifts = filterValue ? 
            allShifts.filter(s => s.participant_id === filterValue) : 
            allShifts;
        
        // Group by date
        const grouped = {};
        filteredShifts.forEach(shift => {
            if (!grouped[shift.date]) grouped[shift.date] = [];
            grouped[shift.date].push(shift);
        });
        
        container.innerHTML = '';
        
        if (Object.keys(grouped).length === 0) {
            container.appendChild(UIComponents.emptyState('No shifts found'));
            return;
        }
        
        const fragment = document.createDocumentFragment();
        
        Object.keys(grouped).sort().forEach(date => {
            const dayShifts = grouped[date];
            const isToday = date === getTestDate().toISOString().split('T')[0];
            
            const daySection = UIComponents.createElement('div', {
                class: 'day-section',
                children: [
                    UIComponents.createElement('div', {
                        class: 'day-header',
                        style: isToday ? 'background: var(--primary-color); color: white;' : '',
                        children: [
                            UIComponents.createElement('div', {
                                class: 'day-date',
                                text: formatDateLong(date)
                            }),
                            UIComponents.createElement('div', {
                                class: 'day-shift-count',
                                text: dayShifts.length.toString()
                            })
                        ]
                    }),
                    UIComponents.createElement('div', {
                        class: 'day-shifts',
                        children: dayShifts.map(shift => {
                            const isMyShift = shift.staff_id === currentStaff.id;
                            const staffName = shift.staff ? 
                                `${shift.staff.first_name} ${shift.staff.last_name}` : 
                                'Unassigned';
                            
                            return UIComponents.createElement('div', {
                                class: 'schedule-shift',
                                style: isMyShift ? 
                                    'background: #e3f2fd; border-left: 3px solid var(--primary-color);' : '',
                                children: [
                                    UIComponents.createElement('div', {
                                        children: [
                                            UIComponents.createElement('div', {
                                                class: 'schedule-shift-time',
                                                html: `
                                                    ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'} - 
                                                    ${shift.end_time ? formatTime(shift.end_time) : ''}
                                                `
                                            }),
                                            UIComponents.createElement('div', {
                                                class: 'schedule-shift-staff',
                                                text: staffName
                                            })
                                        ]
                                    }),
                                    isMyShift && UIComponents.createElement('div', {
                                        class: 'schedule-shift-actions',
                                        children: [
                                            UIComponents.createElement('button', {
                                                class: 'action-btn secondary',
                                                text: 'Note',
                                                events: {
                                                    click: () => addNoteToShift(shift.id)
                                                }
                                            })
                                        ]
                                    })
                                ].filter(Boolean)
                            });
                        })
                    })
                ]
            });
            
            fragment.appendChild(daySection);
        });
        
        container.appendChild(fragment);
    }
};


function renderFortnightSchedule(startDate, endDate, shifts) {
    const container = document.getElementById('scheduleCalendar');
    if (!container) return;

    // Create navigation similar to timesheet
    let html = `
        <div class="schedule-wrapper">
            <div class="schedule-header">
                <button data-action-with-param="changeSchedulePeriod" data-param="-1" class="btn-nav">‹ Previous</button>
                <h3 class="schedule-period">
                    ${startDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })} - 
                    ${endDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}
                </h3>
                <button data-action-with-param="changeSchedulePeriod" data-param="1" class="btn-nav">Next ›</button>
            </div>
            <div class="fortnight-grid">
    `;

    // Generate 14 days
    for (let i = 0; i < 14; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        const dateStr = currentDate.toISOString().split('T')[0];
        const dayShifts = shifts.filter(s => s.date === dateStr);
        const isToday = getTestDate().toDateString() === currentDate.toDateString();
        const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
        
        html += `
            <div class="schedule-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''} ${dayShifts.length > 0 ? 'has-shifts' : ''}">
                <div class="day-header">
                    <div class="day-name">${currentDate.toLocaleDateString('en-AU', { weekday: 'short' })}</div>
                    <div class="day-date">${currentDate.getDate()}</div>
                </div>
                <div class="day-shifts">
        `;
        
        if (dayShifts.length > 0) {
            dayShifts.forEach(shift => {
                html += `
                    <div class="shift-block">
                        <div class="shift-time">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'}
                            ${shift.end_time ? ' - ' + formatTime(shift.end_time) : ''}
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<div class="no-shift">No shifts</div>';
        }
        
        html += `
                </div>
            </div>
        `;
    }
    
    html += `
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function renderCalendar(targetDate, shifts) {
    const container = document.getElementById('scheduleCalendar');
    if (!container) return;

    const year = targetDate.getFullYear();
    const month = targetDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    let html = `
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <button data-action-with-param="changeMonth" data-param="-1" class="calendar-nav-btn">‹</button>
                <h3 class="calendar-month">${monthNames[month]} ${year}</h3>
                <button data-action-with-param="changeMonth" data-param="1" class="calendar-nav-btn">›</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-weekdays">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
                    <div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-days">
    `;
    
    // Empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day empty"></div>';
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayShifts = shifts.filter(s => s.date === dateStr);
        const isToday = getTestDate().toDateString() === new Date(year, month, day).toDateString();
        
        html += `
            <div class="calendar-day ${isToday ? 'today' : ''} ${dayShifts.length > 0 ? 'has-shifts' : ''}">
                <div class="day-number">${day}</div>
                ${dayShifts.length > 0 ? `
                    <div class="shift-dots">
                        ${dayShifts.map(() => '<span class="shift-dot"></span>').join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function renderScheduleDay(date, dayShifts) {
    const dayName = date.toLocaleDateString('en-AU', { weekday: 'long' });
    const dateStr = date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
    
    return `
        <div class="shift-group">
            <div class="shift-group-header">
                <span>${dayName}, ${dateStr}</span>
                <span class="shift-count">${dayShifts.length} shift(s)</span>
                <!-- Removed: <span class="shift-group-hours">${totalHours}h</span> -->
            </div>
            <!-- shifts content -->
        </div>
    `;
}
        
        // Add all the edit profile functions
        function editPersonalInfo() {
            const container = document.getElementById('personalInfo');
            container.innerHTML = `
                <div class="profile-field">
                    <div class="field-label">First Name</div>
                    <input type="text" class="form-control" id="editFirstName" value="${currentStaff.first_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Middle Name</div>
                    <input type="text" class="form-control" id="editMiddleName" value="${currentStaff.middle_name || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Last Name</div>
                    <input type="text" class="form-control" id="editLastName" value="${currentStaff.last_name}">
                </div>
                <div class="profile-field">
                    <div class="field-label">Date of Birth</div>
                    <input type="date" class="form-control" id="editDOB" value="${currentStaff.date_of_birth || ''}">
                </div>
                <div class="profile-field">
                    <div class="field-label">NDIS Worker Number</div>
                    <input type="text" class="form-control" id="editNDIS" value="${currentStaff.ndis_worker_number || ''}">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" data-action="savePersonalInfo">Save</button>
                    <button class="btn btn-secondary" data-action="loadProfile">Cancel</button>
                </div>
            `;
        }

        async function savePersonalInfo() {
            try {
                const updates = {
                    first_name: document.getElementById('editFirstName').value,
                    middle_name: document.getElementById('editMiddleName').value || null,
                    last_name: document.getElementById('editLastName').value,
                    date_of_birth: document.getElementById('editDOB').value || null,
                    ndis_worker_number: document.getElementById('editNDIS').value || null
                };

                const { error } = await supabaseClient
                    .from('staff')
                    .update(updates)
                    .eq('id', currentStaff.id);

                if (error) throw error;

                currentStaff = { ...currentStaff, ...updates };
                showToast('Personal information updated', 'success');
                loadProfile();
                document.getElementById('userName').textContent = `${currentStaff.first_name} ${currentStaff.last_name}`;

            } catch (error) {
                console.error('Error updating personal info:', error);
                showToast('Failed to update personal information', 'error');
            }
        }


function showSection(sectionName) {
    try {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show target section
        const targetSection = document.getElementById(sectionName);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Update navigation
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
        });
        
        // Find and activate corresponding nav item
        const navItem = document.querySelector(`[data-section="${sectionName}"]`);
        if (navItem) {
            navItem.classList.add('active');
        }
        
    } catch (error) {
        console.error('Error showing section:', error);
    }
}

// ============================================
// TIMESHEET FIXES - Complete Implementation
// ============================================

// Global variables needed for timesheet
AppState.shifts.my = [];
window.currentPeriodStart = null;
window.currentPeriodEnd = null;
AppState.ui.timesheetView = 'date'; // 'date' or 'participant'
window.currentPeriodOffset = 0;


// ==================================================
// PAY PERIOD MANAGEMENT - SINGLE CLEAN IMPLEMENTATION
// ==================================================

// Configuration constants
const PAY_PERIOD_CONFIG = {
    BASE_DATE: new Date('2024-01-07'), // Sunday - adjust to your org's actual base date
    LENGTH_DAYS: 14, // Fortnightly pay periods
    LOCALE: 'en-AU'
};

// Single source of truth for period offset
if (!window.hasOwnProperty('periodOffset')) {
    window.periodOffset = 0;
}

/**
 * Calculate pay period for any given date
 * @param {Date} date - The date to calculate period for
 * @param {number} offset - Number of periods to offset (negative = past, positive = future)
 * @returns {Object} Period start and end dates
 */
/**
 * Get pay period for a specific date (utility function)
 */
function getPayPeriodForDate(date) {
    return calculatePayPeriod(date, 0);
}

function calculatePayPeriod(date = new Date(), offset = 0) {
    // Clone date to avoid mutations
    const currentDate = new Date(date);
    currentDate.setHours(12, 0, 0, 0); // Set to noon to avoid DST issues
    
    // Find the Monday of the current week
    const dayOfWeek = currentDate.getDay();
    const daysFromMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    currentDate.setDate(currentDate.getDate() + daysFromMonday);
    
    // Find which fortnight we're in (assuming fortnights start on Mondays)
    // Use a known reference Monday for consistent fortnight boundaries
    const referenceMonday = new Date('2024-07-15'); // A known Monday
    referenceMonday.setHours(12, 0, 0, 0);
    
    const daysDiff = Math.floor((currentDate - referenceMonday) / (1000 * 60 * 60 * 24));
    const fortnightsSinceReference = Math.floor(daysDiff / 14);
    
    // Calculate the start of the current fortnight
    const currentFortnightStart = new Date(referenceMonday);
    currentFortnightStart.setDate(referenceMonday.getDate() + (fortnightsSinceReference * 14));
    
    // Apply the offset
    const periodStart = new Date(currentFortnightStart);
    periodStart.setDate(currentFortnightStart.getDate() + (offset * 14));
    
    // Period end is 13 days later (14 days total)
    const periodEnd = new Date(periodStart);
    periodEnd.setDate(periodStart.getDate() + 13);
    
    console.log(`Period ${offset}: ${periodStart.toLocaleDateString()} to ${periodEnd.toLocaleDateString()}`);
    
    return {
        start: periodStart,
        end: periodEnd,
        number: fortnightsSinceReference + offset
    };
}

function loadTimesheetForPeriod(startDate, endDate) {
    console.log(`Loading timesheet for period: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`);
    
    // Call your existing timesheet loading function
    if (typeof loadTimesheet === 'function') {
        loadTimesheet();
    }
    
    // Or if you have a different function, call it here
    // For now, just filter shifts for the period
    if (window.shifts && window.shifts.my) {
        const periodShifts = window.shifts.my.filter(shift => {
            const shiftDate = new Date(shift.date);
            return shiftDate >= startDate && shiftDate <= endDate;
        });
        console.log(`Found ${periodShifts.length} shifts in period`);
        
        // Update timesheet display if needed
        if (typeof renderTimesheet === 'function') {
            renderTimesheet(periodShifts);
        }
    }
}


function updatePeriodDisplay() {
    const periodDatesElement = document.getElementById('periodDates');
    if (!periodDatesElement || !window.currentPeriodStart || !window.currentPeriodEnd) {
        return;
    }
    
    const formatOptions = { day: 'numeric', month: 'short', year: 'numeric' };
    const startStr = window.currentPeriodStart.toLocaleDateString(PAY_PERIOD_CONFIG.LOCALE, formatOptions);
    const endStr = window.currentPeriodEnd.toLocaleDateString(PAY_PERIOD_CONFIG.LOCALE, formatOptions);
    
    periodDatesElement.textContent = `${startStr} - ${endStr}`;
}

async function checkNavigationBoundaries() {
    const prevBtn = document.getElementById('prevPeriodBtn');
    const nextBtn = document.getElementById('nextPeriodBtn');
    
    if (!prevBtn || !nextBtn) return;
    
    const currentOffset = window.periodOffset || 0;
    
    // Check if there are shifts in previous period
    const prevPeriod = calculatePayPeriod(getTestDate(), currentOffset - 1);
    const { data: prevShifts } = await supabaseClient
        .from('shifts')
        .select('id')
        .eq('staff_id', currentStaff.id)
        .gte('date', normalizeDateForQuery(prevPeriod.start))
        .lte('date', normalizeDateForQuery(prevPeriod.end))
        .is('deleted_at', null)
        .limit(1);
    
    // Check if there are shifts in next period
    const nextPeriod = calculatePayPeriod(getTestDate(), currentOffset + 1);
    const { data: nextShifts } = await supabaseClient
        .from('shifts')
        .select('id')
        .eq('staff_id', currentStaff.id)
        .gte('date', normalizeDateForQuery(nextPeriod.start))
        .lte('date', normalizeDateForQuery(nextPeriod.end))
        .is('deleted_at', null)
        .limit(1);
    
    // Disable/enable buttons based on shift availability
    if (prevShifts && prevShifts.length === 0) {
        prevBtn.disabled = true;
        prevBtn.style.opacity = '0.3';
        prevBtn.style.cursor = 'not-allowed';
    } else {
        prevBtn.disabled = false;
        prevBtn.style.opacity = '1';
        prevBtn.style.cursor = 'pointer';
    }
    
    if (nextShifts && nextShifts.length === 0) {
        nextBtn.disabled = true;
        nextBtn.style.opacity = '0.3';
        nextBtn.style.cursor = 'not-allowed';
    } else {
        nextBtn.disabled = false;
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
    }
}

function setupPeriodNavigationButtons() {
    const prevButton = document.getElementById('prevPeriodBtn');
    if (prevButton) {
        const newPrevButton = prevButton.cloneNode(true);
        prevButton.parentNode.replaceChild(newPrevButton, prevButton);
        
        newPrevButton.addEventListener('click', debounceButton(newPrevButton, (e) => {
            e.preventDefault();
            changePeriod(-1);
        }, 500));
    }
    
    const nextButton = document.getElementById('nextPeriodBtn');
    if (nextButton) {
        const newNextButton = nextButton.cloneNode(true);
        nextButton.parentNode.replaceChild(newNextButton, nextButton);
        
        newNextButton.addEventListener('click', debounceButton(newNextButton, (e) => {
            e.preventDefault();
            changePeriod(1);
        }, 500));
    }
}


function resetToCurrentPeriod() {
    console.log('Resetting to current period (offset 0)');
    window.periodOffset = 0;
    setCurrentPayPeriod();
    
    if (typeof loadTimesheet === 'function') {
        loadTimesheet();
    }
}

// Make functions globally available
window.setCurrentPayPeriod = setCurrentPayPeriod;
window.changePeriod = changePeriod;
window.updatePeriodDisplay = updatePeriodDisplay;
window.resetToCurrentPeriod = resetToCurrentPeriod;
window.getPayPeriodForDate = getPayPeriodForDate;

function calculateTimesheetHours(shifts) {
    const breakdown = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0,
        sleepoverCount: 0
    };
    
    shifts.forEach(shift => {
        const hours = calculateShiftHours(shift);
        
        breakdown.total += hours.total || 0;
        breakdown.weekdayDay += hours.weekdayDay || 0;
        breakdown.weekdayEvening += hours.weekdayEvening || 0;
        breakdown.weekdayNight += hours.weekdayNight || 0;
        breakdown.saturday += hours.saturday || 0;
        breakdown.sunday += hours.sunday || 0;
        breakdown.publicHoliday += hours.publicHoliday || 0;
        breakdown.sleepover += hours.sleepover || 0;
        
        // Count sleepovers (not hours)
        if (hours.sleepover > 0) {
            breakdown.sleepoverCount++;
        }
    });
    
    // Update the hours grid display
    const hoursGrid = document.getElementById('hoursGrid');
    if (hoursGrid) {
        hoursGrid.innerHTML = `
            <div class="hours-item">
                <span class="hours-label">Weekday Day</span>
                <span class="hours-value">${breakdown.weekdayDay.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Evening</span>
                <span class="hours-value">${breakdown.weekdayEvening.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Night</span>
                <span class="hours-value">${breakdown.weekdayNight.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Saturday</span>
                <span class="hours-value">${breakdown.saturday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sunday</span>
                <span class="hours-value">${breakdown.sunday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Public Holiday</span>
                <span class="hours-value">${breakdown.publicHoliday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sleepovers</span>
                <span class="hours-value">${breakdown.sleepoverCount}</span>
            </div>
        `;
    }
    
    // Update total
    const totalElement = document.getElementById('totalHours');
    if (totalElement) {
        totalElement.textContent = `${breakdown.total.toFixed(1)}h`;
    }
    
    return breakdown;
}
// Ensure loadTimesheet renders the shifts
async function loadTimesheet() {
    try {
        if (!window.currentPeriodStart || !window.currentPeriodEnd) {
            setCurrentPayPeriod();
        }
        
        const startQuery = normalizeDateForQuery(window.currentPeriodStart);
        const endQuery = normalizeDateForQuery(window.currentPeriodEnd);
        
        console.log('Loading timesheet for period:', startQuery, 'to', endQuery);
        
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                participants(first_name, last_name),
                duty_types(name),
                locations(name)
            `)
            .eq('staff_id', currentStaff.id)
            .gte('date', startQuery)
            .lte('date', endQuery)
            .is('deleted_at', null)
            .order('date', { ascending: true });
        
        if (error) throw error;
        
        // Store shifts
        AppState.shifts.my = shifts || [];
        
        // Update period display
        updatePeriodDisplay();
        
        // Render shifts ONCE
        console.log(`Rendering ${shifts?.length || 0} shifts`);
        renderTimesheetShifts();
        
        // Update hours display
        if (shifts && shifts.length > 0) {
            calculateTimesheetHours(shifts);
        } else {
            // Clear hours display when no shifts
            const totalHoursElement = document.getElementById('totalHours');
            if (totalHoursElement) totalHoursElement.textContent = '0.0h';
            
            const hoursGrid = document.getElementById('hoursGrid');
            if (hoursGrid) hoursGrid.innerHTML = '<div class="no-data">No hours this period</div>';
        }
        
        await checkNavigationBoundaries();
        
    } catch (error) {
        console.error('Error loading timesheet:', error);
        showToast('Failed to load timesheet', 'error');
    }
}

function calculateHoursBreakdown() {
    const breakdown = {
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0,
        total: 0
    };
    
    AppState.shifts.my.forEach(shift => {
        const hours = calculateShiftHours(shift);
        Object.keys(hours).forEach(key => {
            if (breakdown[key] !== undefined) {
                breakdown[key] += hours[key] || 0;
            }
        });
    });
    
    // Update the hours grid display
    const hoursGrid = document.getElementById('hoursGrid');
    if (hoursGrid) {
        hoursGrid.innerHTML = `
            <div class="hour-item">
                <div class="hour-label">Weekday Day</div>
                <div class="hour-value">${breakdown.weekdayDay.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Weekday Evening</div>
                <div class="hour-value">${breakdown.weekdayEvening.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Weekday Night</div>
                <div class="hour-value">${breakdown.weekdayNight.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Saturday</div>
                <div class="hour-value">${breakdown.saturday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Sunday</div>
                <div class="hour-value">${breakdown.sunday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Public Holiday</div>
                <div class="hour-value">${breakdown.publicHoliday.toFixed(1)}h</div>
            </div>
            <div class="hour-item">
                <div class="hour-label">Sleepovers</div>
                <div class="hour-value">${Math.floor(breakdown.sleepover)}x</div>
            </div>
        `;
    }
    
    // Update total hours
    const totalHours = document.getElementById('totalHours');
    if (totalHours) {
        totalHours.textContent = `${breakdown.total.toFixed(1)}h`;
    }
    
    return breakdown;
}

const timesheetStyles = `
    .shift-group {
        margin-bottom: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .shift-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-light, #f5f5f5);
        border-bottom: 1px solid var(--border-color, #e0e0e0);
        font-weight: 600;
    }
    
    .shift-group-hours {
        color: var(--primary-color, #004990);
        font-size: 16px;
    }
    
    .shift-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-light, #f0f0f0);
        transition: background 0.2s;
    }
    
    .shift-list-item:hover {
        background: var(--bg-light, #f9f9f9);
    }
    
    .shift-list-item:last-child {
        border-bottom: none;
    }
    
    .shift-info {
        flex: 1;
    }
    
    .shift-date-time {
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .shift-client {
        font-size: 14px;
        color: var(--text-light, #666);
        margin-bottom: 2px;
    }
    
    .shift-location {
        font-size: 13px;
        color: var(--text-light, #888);
    }
    
    .shift-hours {
        text-align: right;
        min-width: 60px;
    }
    
    .shift-hours-value {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-color, #004990);
    }
    
    .shift-pay {
        font-size: 12px;
        color: var(--text-light, #888);
        margin-top: 2px;
    }
`;

// Add styles if they don't exist
if (!document.getElementById('timesheetStyles')) {
    const styleElement = document.createElement('style');
    styleElement.id = 'timesheetStyles';
    styleElement.textContent = timesheetStyles;
    document.head.appendChild(styleElement);
}

let publicHolidays = new Map();

// Fetch public holidays from Supabase
async function loadPublicHolidays() {
    try {
        const { data: holidays, error } = await supabaseClient
            .from('public_holidays')
            .select('*')
            .order('date');
        
        if (error) throw error;
        
        // Clear and repopulate the Map
        publicHolidays.clear();
        holidays.forEach(holiday => {
            // Store date in YYYY-MM-DD format as key
            const dateKey = holiday.date.split('T')[0];
            publicHolidays.set(dateKey, {
                id: holiday.id,
                name: holiday.name,
                date: holiday.date
            });
        });
        
        console.log(`Loaded ${publicHolidays.size} public holidays for team portal`);
        return publicHolidays;
        
    } catch (error) {
        console.error('Error loading public holidays:', error);
        // Don't show notification during init, just log
        return publicHolidays;
    }
}

// Check if a date is a public holiday
function isPublicHoliday(dateStr) {
    const dateKey = dateStr.split('T')[0];
    return publicHolidays.has(dateKey);
}

// Get public holiday name
function getPublicHolidayName(dateStr) {
    const dateKey = dateStr.split('T')[0];
    const holiday = publicHolidays.get(dateKey);
    return holiday ? holiday.name : null;
}



// 5. Helper function for formatting hours
function formatHours(hours) {
    return (hours || 0).toFixed(1);
}



function toggleTimesheetView(view) {
    console.log('Toggling view to:', view);
    
    AppState.ui.timesheetView = view;
    
    // Update button states
    document.querySelectorAll('.view-toggle .toggle-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(view === 'date' ? 'Date' : 'Client')) {
            btn.classList.add('active');
        }
    });
    
    // Re-render with new view
    renderTimesheetShifts();
}



// Toggle shift details expansion
function toggleShiftDetails(shiftId) {
    const shiftCard = document.querySelector(`[data-shift-id="${shiftId}"]`);
    if (!shiftCard) return;
    
    const details = shiftCard.querySelector('.shift-details');
    const expandIcon = shiftCard.querySelector('.shift-expand-icon');
    
    if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        expandIcon.textContent = '▼';
    } else {
        details.classList.add('expanded');
        expandIcon.textContent = '▲';
        
        // Load clock in/out UI if appropriate
        loadClockInOutUI(shiftId);
    }
}

function attachClockEventListeners(shiftId, shift) {
    // Clock In button
    const clockInBtn = document.getElementById(`clock-in-btn-${shiftId}`);
    if (clockInBtn) {
        clockInBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await handleClockIn(shiftId);
        });
    }
    
    // Clock Out button
    const clockOutBtn = document.getElementById(`clock-out-btn-${shiftId}`);
    if (clockOutBtn) {
        clockOutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await handleClockOut(shiftId);
        });
    }
}

function addEnhancedClockStyles() {
    if (!document.getElementById('enhanced-clock-styles')) {
        const styleElement = document.createElement('style');
        styleElement.id = 'enhanced-clock-styles';
        styleElement.textContent = `
            .clock-info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .clock-info-item {
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
                color: rgba(255, 255, 255, 0.9);
            }
            
            .clock-info-item i {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.7);
            }
            
            .status-icon {
                font-size: 32px;
                margin-bottom: 10px;
                opacity: 0.8;
            }
            
            .status-message {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 8px;
            }
            
            .distance.in-range {
                color: #51cf66;
            }
            
            .distance.out-range {
                color: #ffd93d;
            }
            
            .shift-complete-message {
                text-align: center;
                padding: 12px;
                background: rgba(81, 207, 102, 0.2);
                border-radius: 8px;
                color: #51cf66;
                font-weight: 600;
                margin-top: 10px;
            }
            
            .location-precheck {
                text-align: center;
                margin-top: 10px;
                color: rgba(255, 255, 255, 0.6);
            }
            
            .clock-status {
                text-align: center;
            }
            
            .clock-status.ready .status-icon {
                color: #51cf66;
            }
            
            .clock-status.too-early .status-icon {
                color: #ffd93d;
            }
            
            .clock-status.missed .status-icon {
                color: #ff6b6b;
            }
            
            .clock-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .clock-btn:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }
        `;
        document.head.appendChild(styleElement);
    }
}

// Initialize enhanced clock styles
document.addEventListener('DOMContentLoaded', () => {
    addEnhancedClockStyles();
});

// Function to manually trigger clock UI refresh for a specific shift
async function refreshClockUI(shiftId) {
    const { data: shift, error } = await supabaseClient
        .from('shifts')
        .select(`
            *,
            participant:participant_id(
                first_name, 
                last_name, 
                address,
                location_lat, 
                location_lng, 
                location_radius_meters
            ),
            location:location_id(name, address)
        `)
        .eq('id', shiftId)
        .single();
        
    if (!error && shift) {
        await loadShiftClockingUI(shiftId, shift);
    }
}

// Auto-refresh clock UI every minute for active shifts
let clockRefreshInterval = null;

function startClockRefresh(shiftId) {
    stopClockRefresh(); // Clear any existing interval
    
    clockRefreshInterval = setInterval(() => {
        const clockSection = document.getElementById(`clock-section-${shiftId}`);
        if (clockSection && clockSection.closest('.shift-details.expanded')) {
            refreshClockUI(shiftId);
        }
    }, 60000); // Refresh every minute
}

function stopClockRefresh() {
    if (clockRefreshInterval) {
        clearInterval(clockRefreshInterval);
        clockRefreshInterval = null;
    }
}


// Helper function to get current position
function getCurrentPosition() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Geolocation not supported'));
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            resolve,
            reject,
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    });
}



// Placeholder for reverse geocoding
async function reverseGeocode(lat, lng) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
            {
                headers: {
                    'User-Agent': 'NDIS-Care-App/1.0' // Required by Nominatim
                }
            }
        );
        
        if (!response.ok) {
            throw new Error('Geocoding failed');
        }
        
        const data = await response.json();
        
        // Build a readable address
        const parts = [];
        if (data.address.house_number) parts.push(data.address.house_number);
        if (data.address.road) parts.push(data.address.road);
        if (data.address.suburb || data.address.city) {
            parts.push(data.address.suburb || data.address.city);
        }
        if (data.address.state) parts.push(data.address.state);
        if (data.address.postcode) parts.push(data.address.postcode);
        
        return parts.join(', ') || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        
    } catch (error) {
        console.error('Reverse geocoding error:', error);
        // Fallback to coordinates if geocoding fails
        return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
}

// Initialize everything when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Add notification styles
    addNotificationStyles();
    
    // Load current shift
    if (typeof loadCurrentShift === 'function') {
        loadCurrentShift();
    }
    
    // Refresh shift display every 5 minutes
    setInterval(() => {
        if (typeof loadCurrentShift === 'function') {
            loadCurrentShift();
        }
    }, 5 * 60 * 1000);

});


// Simple toast notification if you don't have one already
function showToast(message, type = 'info') {
    // If you already have a showToast function, remove this one
    console.log(`[${type.toUpperCase()}]: ${message}`);
    
    // Basic toast implementation
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        background: ${type === 'success' ? '#51cf66' : type === 'error' ? '#ff6b6b' : '#339af0'};
        color: white;
        border-radius: 8px;
        z-index: 9999;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

document.addEventListener('DOMContentLoaded', async () => {
    try {        
        // ===== UNIVERSAL EVENT DELEGATION (ONLY ONCE, COMPREHENSIVE VERSION) =====
        document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-modal-close], [data-modal-open], [data-timesheet-view], [data-transfer-tab], [data-section], [data-action], [data-action-with-param], [data-action-with-two-params]');
            
            if (!target) return;
            
            // Handle modal closes
            if (target.dataset.modalClose) {
                closeModal(target.dataset.modalClose);
                return;
            }
            
            // Handle modal opens
            if (target.dataset.modalOpen) {
                const modalName = target.dataset.modalOpen;
                const modal = document.getElementById(modalName);
                if (modal) {
                    modal.style.display = 'flex';
                }
                return;
            }
            
            // Handle specific actions FIRST (before generic handler)
            if (target.dataset.action === 'submitTransfer') {
                submitTransfer();
                return;
            }
            if (target.dataset.action === 'submitAdjustment') {
                submitAdjustment();
                return;
            }
            if (target.dataset.action === 'submitLeave') {
                submitLeave();
                return;
            }
            if (target.dataset.action === 'acceptTransfer') {
                const transferId = target.dataset.transferId;
                if (transferId) acceptTransfer(transferId);
                return;
            }
            if (target.dataset.action === 'declinetransfer') {
                const transferId = target.dataset.transferId;
                if (transferId) declinetransfer(transferId);
                return;
            }
            
            // Handle remove modal (special case for .remove())
            if (target.dataset.action === 'removeModal' && target.dataset.modalId) {
                const modal = document.getElementById(target.dataset.modalId);
                if (modal) {
                    modal.remove();
                }
                return;
            }
            
            // Handle reload page
            if (target.dataset.action === 'reloadPage') {
                location.reload();
                return;
            }
            
            // Handle toggle shift details (special case - needs 'this')
            if (target.dataset.action === 'toggleShiftDetails') {
                toggleShiftDetails(target);
                return;
            }
            
            // Handle show participant shifts (special case - multiple params)
            if (target.dataset.action === 'showParticipantShifts') {
                const participantId = target.dataset.participantId;
                const participantName = target.dataset.participantName;
                if (participantId && participantName) {
                    showParticipantShifts(participantId, participantName);
                }
                return;
            }
            
            // Handle timesheet view toggles
            if (target.dataset.timesheetView) {
                toggleTimesheetView(target.dataset.timesheetView);
                // Update active state for toggle buttons
                document.querySelectorAll('[data-timesheet-view]').forEach(btn => {
                    btn.classList.remove('active');
                });
                target.classList.add('active');
                return;
            }
            
            // Handle section switches
            if (target.dataset.section) {
                switchSection(target.dataset.section);
                return;
            }
            
            // Handle trigger click
            if (target.dataset.triggerClick) {
                const elementToClick = document.getElementById(target.dataset.triggerClick);
                if (elementToClick) {
                    elementToClick.click();
                }
                return;
            }
            
            // Handle generic actions (no parameters) - LAST
            if (target.dataset.action && !target.dataset.param) {
                const actionName = target.dataset.action;
                if (typeof window[actionName] === 'function') {
                    window[actionName]();
                }
                return;
            }
            
            // Handle actions with single parameter
            if (target.dataset.actionWithParam && target.dataset.param) {
                const actionName = target.dataset.actionWithParam;
                const param = target.dataset.param;
                
                if (typeof window[actionName] === 'function') {
                    // Handle numeric parameters
                    if (!isNaN(param) && param !== '') {
                        window[actionName](parseInt(param));
                    } else {
                        window[actionName](param);
                    }
                }
                return;
            }
        });
        
        // Add banner upload listeners
        const bannerUploadBtn = document.getElementById('bannerUploadBtn');
        if (bannerUploadBtn) {
            bannerUploadBtn.addEventListener('click', () => {
                document.getElementById('bannerUpload').click();
            });
        }
        
        const bannerUpload = document.getElementById('bannerUpload');
        if (bannerUpload) {
            bannerUpload.addEventListener('change', uploadProfileBanner);
        }
        
        // Phase 2: Initialize app
        await initializeApp();
        await ensureStaffLoaded();
    
        
        // Phase 4: Post-init tasks (with delay)
        setTimeout(async () => {
            if (AppState.staff.current) {
                const selector = document.getElementById('staffSelector');
                if (selector) {
                    selector.style.display = 'block';
                }
            }
        }, 2000);
        
        // Initialize pay period - ONLY call the GOOD setCurrentPayPeriod
        // Make sure you've deleted the OLD one that uses currentPeriodOffset
        if (typeof setCurrentPayPeriod === 'function') {
            setCurrentPayPeriod();
        }
        
        // Phase 6: Setup any remaining event listeners for special cases
        // For example, if you have file inputs or other special elements
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                if (e.target.id === 'documentFile') {
                    // Handle document upload preview if needed
                    if (typeof previewDocument === 'function') {
                        previewDocument(e);
                    }
                }
            });
        });
        
        // Load profile banner
        await loadProfileBanner();
        
        console.log('Application ready');
        console.log('Event delegation active for:', {
            modals: 'data-modal-close, data-modal-open',
            navigation: 'data-section',
            actions: 'data-action, data-action-with-param',
            timesheets: 'data-timesheet-view',
            transfers: 'data-transfer-tab',
            special: 'toggleShiftDetails, showParticipantShifts, removeModal'
        });
        
    } catch (error) {
        console.error('Initialization failed:', error);
        showToast('Failed to start application', 'error');
    }
});

// ============================================
// FIX 10: Initialize on Section Switch
// ============================================

// Override or enhance the switchSection function
const originalSwitchSection = window.switchSection;
window.switchSection = function(section) {
    // Call original if it exists
    if (typeof originalSwitchSection === 'function') {
        originalSwitchSection(section);
    }
    
    // Update nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.section === section) {
            item.classList.add('active');
        }
    });
    
    // Update content sections
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const targetSection = document.getElementById(section);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Load section data
    if (section === 'timesheet') {
        loadTimesheet();
    }
}

window.toggleTimesheetView = function(view) {
    try {
        AppState.ui.timesheetView = view;
        
        // Update button states
        document.querySelectorAll('.view-toggle .toggle-btn').forEach(btn => {
            btn.classList.remove('active');
            // Check if this is the clicked button
            if (btn.textContent.includes(view === 'date' ? 'Date' : 'Client')) {
                btn.classList.add('active');
            }
        });
        
        // Re-render with new view
        if (typeof renderTimesheetShifts === 'function') {
            renderTimesheetShifts();
        }
        
    } catch (error) {
        console.error('Error toggling timesheet view:', error);
    }
}

function renderTimesheetShifts() {
    const container = document.getElementById('timesheetShifts');
    if (!container) {
        console.error('Timesheet shifts container not found');
        return;
    }
    
    const shifts = AppState.shifts.my || [];
    
    // ALWAYS clear and re-render
    if (shifts.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-light);">
                <i class="fa-solid fa-calendar-xmark" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                <div>No shifts in this pay period</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    if (AppState.ui.timesheetView === 'date') {
        // Group by date
        const grouped = {};
        shifts.forEach(shift => {
            if (!grouped[shift.date]) grouped[shift.date] = [];
            grouped[shift.date].push(shift);
        });
        
        // Sort dates and render
        Object.keys(grouped).sort().forEach(date => {
            const dayShifts = grouped[date];
            
            // Check if this date is a public holiday
            const dateKey = date.split('T')[0];
            const isHoliday = publicHolidays.has(dateKey);
            const holidayName = isHoliday ? publicHolidays.get(dateKey).name : null;
            
            html += `
                <div class="shift-group">
                    <div class="shift-group-header" style="${isHoliday ? 'background: linear-gradient(135deg, #1976d2, #42a5f5);' : ''}">
                        <span>${formatDateLong(date)}</span>
                        ${isHoliday ? `
                            <span style="background: white; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${holidayName}
                            </span>
                        ` : ''}
                    </div>
            `;
            
            dayShifts.forEach(shift => {
                const hours = calculateShiftHours(shift);
                const participant = shift.participants;
                
                // Build time display based on whether it's a sleepover
                let timeDisplay = '';
                if (shift.start_time && shift.end_time) {
                    timeDisplay = `${formatTime12Hour(shift.start_time)} - ${formatTime12Hour(shift.end_time)}`;
                } else if (!shift.start_time && !shift.end_time) {
                    timeDisplay = 'Sleepover';
                } else if (shift.start_time && !shift.end_time) {
                    timeDisplay = `${formatTime12Hour(shift.start_time)} - End`;
                } else {
                    timeDisplay = `Start - ${formatTime12Hour(shift.end_time)}`;
                }
                
                html += `
                    <div class="shift-list-item">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${timeDisplay}
                                ${shift.is_public_holiday ? 
                                    '<span style="margin-left: 8px; background: #1976d2; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">PH</span>' 
                                    : ''}
                            </div>
                            <div class="shift-client">
                                ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                            </div>
                            <div class="shift-location">
    <i class="fa-solid fa-location-dot"></i> ${shift.locations?.name || 'Client Home'}
</div>
                        </div>
                        <div class="shift-hours">
                            <div class="shift-hours-value">${hours.total.toFixed(1)}h</div>
                            ${hours.publicHoliday > 0 ? 
                                `<div class="shift-pay" style="color: #1976d2; font-weight: 600;">PH Rate</div>` : 
                                hours.sleepover > 0 ? '<div class="shift-pay">Sleepover</div>' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        });
        
    } else {
        // Group by participant view remains similar but with holiday indicators
        const grouped = {};
        shifts.forEach(shift => {
            const key = shift.participant_id || 'unassigned';
            if (!grouped[key]) {
                grouped[key] = {
                    participant: shift.participants,
                    shifts: []
                };
            }
            grouped[key].shifts.push(shift);
        });
        
        Object.values(grouped).forEach(group => {
            const totalHours = group.shifts.reduce((sum, s) => {
                const hours = calculateShiftHours(s);
                return sum + (hours.total || 0);
            }, 0);
            
            const name = group.participant ? 
                `${group.participant.first_name} ${group.participant.last_name}` : 
                'Unassigned';
            
            html += `
                <div class="shift-group">
                    <div class="shift-group-header">
                        <span>${name}</span>
                        <span class="shift-group-hours">${totalHours.toFixed(1)}h</span>
                    </div>
            `;
            
            group.shifts.sort((a, b) => a.date.localeCompare(b.date)).forEach(shift => {
                const hours = calculateShiftHours(shift);
                
                // Build time display based on whether it's a sleepover
                let timeDisplay = '';
                if (shift.start_time && shift.end_time) {
                    timeDisplay = `${formatTime12Hour(shift.start_time)} - ${formatTime12Hour(shift.end_time)}`;
                } else if (!shift.start_time && !shift.end_time) {
                    timeDisplay = 'Sleepover';
                } else if (shift.start_time && !shift.end_time) {
                    timeDisplay = `${formatTime12Hour(shift.start_time)} - End`;
                } else {
                    timeDisplay = `Start - ${formatTime12Hour(shift.end_time)}`;
                }
                
                html += `
                    <div class="shift-list-item">
                        <div class="shift-info">
                            <div class="shift-date-time">
                                ${formatDateShort(shift.date)} - ${timeDisplay}
                                ${shift.is_public_holiday ? 
                                    '<span style="margin-left: 8px; background: #1976d2; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">PH</span>' 
                                    : ''}
                            </div>
                            <div class="shift-location">
                    <i class="fa-solid fa-location-dot"></i> ${shift.location?.name || 'Client Home'}
                </div>
                        </div>
                        <div class="shift-hours">
                            <div class="shift-hours-value">${hours.total.toFixed(1)}h</div>
                            ${hours.publicHoliday > 0 ? 
                                `<div class="shift-pay" style="color: #1976d2; font-weight: 600;">PH Rate</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        });
    }
    
    container.innerHTML = html;
}

async function ensureStaffLoaded() {
    console.log('Ensuring staff data is loaded...');
    
    if (AppState.staff.current) {
        console.log('Staff already loaded:', AppState.staff.current);
        return AppState.staff.current;
    }
    
    try {
        // Get current user first
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (userError || !user) {
            console.error('No authenticated user found:', userError);
            window.location.href = 'index.html';
            return null;
        }
        
        console.log('Current user:', user.email);
        window.currentUser = user;
        
        // Try to load staff by user_id first
        let { data: staffData, error: staffError } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('user_id', user.id)
            .maybeSingle();
        
        // If not found by user_id, try by email
        if (!staffData) {
            console.log('No staff found by user_id, trying email...');
            const result = await supabaseClient
                .from('staff')
                .select('*')
                .eq('email', user.email)
                .maybeSingle();
            
            staffData = result.data;
            staffError = result.error;
        }
        
        if (staffError) {
            console.error('Error loading staff data:', staffError);
            showToast('Failed to load staff data', 'error');
            return null;
        }
        
        if (!staffData) {
            console.error('No staff record found for user');
            showToast('No staff record found. Please contact administrator.', 'error');
            return null;
        }
        
        // Set the global currentStaff
        AppState.staff.current = staffData;
        console.log('Staff data loaded successfully:', staffData);
        
        // Update UI with staff name
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = `${staffData.first_name} ${staffData.last_name}`;
        }
        
        return staffData;
        
    } catch (error) {
        console.error('Failed to ensure staff loaded:', error);
        showToast('Failed to load staff data', 'error');
        return null;
    }
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
        color: white;
        border-radius: 4px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showNotification(message, type = 'info') {
    // Remove any existing notifications
    const existingNotification = document.querySelector('.notification-toast');
    if (existingNotification) {
        existingNotification.remove();
    }

    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification-toast ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            ${type === 'success' ? '<i class="fa-solid fa-check-circle"></i>' : ''}
            ${type === 'error' ? '<i class="fa-solid fa-exclamation-circle"></i>' : ''}
            ${type === 'warning' ? '<i class="fa-solid fa-exclamation-triangle"></i>' : ''}
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Add CSS for notifications
function addNotificationStyles() {
    if (!document.getElementById('notification-styles')) {
        const styleElement = document.createElement('style');
        styleElement.id = 'notification-styles';
        styleElement.textContent = `
            .notification-toast {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
                max-width: 400px;
                background: #1e3a5f;
                color: white;
            }
            
            .notification-toast.success {
                background: #2d5a3d;
            }
            
            .notification-toast.error {
                background: #d32f2f;
            }
            
            .notification-toast.warning {
                background: #f57c00;
            }
            
            .notification-content {
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
                font-weight: 500;
            }
            
            .notification-toast.fade-out {
                animation: slideOut 0.3s ease;
                opacity: 0;
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(styleElement);
    }
}


// Update your switchSection function to handle participants
function switchSection(section) {
    try {
        // Update mobile nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            item.setAttribute('aria-selected', 'false');
        });
        
        // Set active nav item
        const activeNavItem = document.getElementById(`nav-${section}`);
        if (activeNavItem) {
            activeNavItem.classList.add('active');
            activeNavItem.setAttribute('aria-selected', 'true');
        }
        
        // Hide all content sections
        document.querySelectorAll('.content-section').forEach(sec => {
            sec.classList.remove('active');
            sec.style.display = 'none';
        });
        
        // Show selected section
        const targetSection = document.getElementById(section);
        if (targetSection) {
            targetSection.classList.add('active');
            targetSection.style.display = 'block';
        }
        
        // Update AppState
        AppState.ui.currentSection = section;
        
        // Load section data based on what's selected
        switch(section) {
            case 'dashboard':
                if (typeof loadDashboard === 'function') {
                    loadDashboard();
                }
                break;
            case 'timesheet':
                if (typeof loadTimesheet === 'function') {
                    loadTimesheet();
                }
                break;
            case 'participants': // ADD THIS CASE
                // Participants section doesn't need to load anything on switch
                // It loads when a participant is selected
                break;
            case 'transfers':
                if (typeof loadTransfers === 'function') {
                    loadTransfers();
                }
                break;
                case 'requests':
    handleRequestsSection();
    break;
            case 'profile':
                if (typeof loadProfile === 'function') {
                    loadProfile();
                }
                break;
            default:
                console.warn('Unknown section:', section);
        }
        
        // Scroll to top on mobile
        window.scrollTo(0, 0);
        
    } catch (error) {
        console.error('Error switching section:', error);
        showToast('Failed to switch section', 'error');
    }
}
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        
        // Clear form if exists
        const form = modal.querySelector('form');
        if (form) {
            form.reset();
        }
    }
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
    }
}



        function addButtonStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .btn {
                    padding: 12px 20px;
                    border: none;
                    border-radius: var(--radius-md);
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-size: 14px;
                }
                .btn-primary {
                    background: var(--primary-color);
                    color: white;
                }
                .btn-primary:hover {
                    background: var(--primary-dark);
                }
                .btn-secondary {
                    background: var(--bg-light);
                    color: var(--text-dark);
                }
                .btn-secondary:hover {
                    background: #d0d0d0;
                }
                .btn-sm {
                    padding: 8px 16px;
                    font-size: 12px;
                }
                .btn-outline {
                    background: transparent;
                    border: 1px solid var(--border-color);
                    color: var(--text-dark);
                }
                .btn-outline:hover {
                    background: var(--bg-light);
                }
            `;
            document.head.appendChild(style);
        }

window.testSelectedStaff = async function() {
    const select = document.getElementById('staffTestSelect');
    const staffId = select.value;
    
    console.log('Test selected staff called with ID:', staffId);
    
    if (!staffId) {
        showToast('Please select a staff member', 'warning');
        return;
    }
    
    // First ensure we have the original staff loaded
    if (!AppState.staff.current) {
        console.log('Current staff not loaded, loading first...');
        await ensureStaffLoaded();
        
        if (!AppState.staff.current) {
            showToast('Failed to load your staff data first', 'error');
            return;
        }
    }
    
    // Now switch to test staff
    await switchToStaff(staffId);
    
    // Hide the selector after successful switch
    const selector = document.getElementById('staffSelector');
    if (selector) {
        selector.style.display = 'none';
    }
}

async function checkLeaveButtonVisibility() {
    try {
        const staffId = currentStaff?.id || AppState.staff.current?.id;
        const staffPayRate = currentStaff?.pay_rate_id || AppState.staff.current?.pay_rate_id;
        
        console.log('Checking leave visibility - Staff ID:', staffId, 'Pay Rate ID:', staffPayRate);
        
        if (!staffId || !staffPayRate) {
            console.log('No staff ID or pay rate available for leave button check');
            // Remove leave button if no pay rate
            const leaveButton = document.querySelector('[data-action="showLeaveModal"]');
            if (leaveButton) {
                leaveButton.remove();
            }
            return;
        }
        
        // Get the pay rate label
        const { data, error } = await supabaseClient
            .from('pay_rate_labels')
            .select('label')
            .eq('id', staffPayRate)
            .single();
        
        if (error) throw error;
        
        console.log('Pay rate label found:', data?.label);
        
        const label = data?.label?.toLowerCase() || '';
        const hasEmploymentType = (label.includes('full') && label.includes('time')) || 
                                 (label.includes('part') && label.includes('time'));
        
        console.log('Has employment type (Full/Part Time)?', hasEmploymentType, 'Label:', data?.label);
        
        // Find the leave button
        const leaveButton = document.querySelector('[data-action="showLeaveModal"]');
        
        if (leaveButton) {
            if (!hasEmploymentType) {
                // REMOVE the button completely for Casual staff
                const parentContainer = leaveButton.parentElement;
                leaveButton.remove();
                console.log(`Leave button REMOVED for Casual staff: "${data?.label}"`);
                
                // Clean up empty parent container if needed
                if (parentContainer && parentContainer.children.length === 0) {
                    parentContainer.remove();
                }
            } else {
                // Keep button for Full/Part Time staff
                console.log(`Leave button kept for Full/Part Time staff: "${data?.label}"`);
            }
        } else {
            console.log('Leave button not found in DOM - will retry');
            // Retry after a short delay in case DOM isn't ready
            setTimeout(() => {
                const retryButton = document.querySelector('[data-action="showLeaveModal"]');
                if (retryButton && !hasEmploymentType) {
                    const parentContainer = retryButton.parentElement;
                    retryButton.remove();
                    console.log('Leave button REMOVED on retry for Casual staff');
                    
                    // Clean up empty parent container
                    if (parentContainer && parentContainer.children.length === 0) {
                        parentContainer.remove();
                    }
                }
            }, 500);
        }
        
    } catch (error) {
        console.error('Error checking leave button visibility:', error);
        // Remove button on error to be safe
        const leaveButton = document.querySelector('[data-action="showLeaveModal"]');
        if (leaveButton) {
            leaveButton.remove();
        }
    }
}

function setupTransportInputFormatters() {
    // Format number inputs to 2 decimal places on blur
    document.getElementById('transportKilometres')?.addEventListener('blur', function() {
        if (this.value) {
            this.value = parseFloat(this.value).toFixed(1);
        }
    });

    document.getElementById('transportParkingCost')?.addEventListener('blur', function() {
        if (this.value) {
            this.value = parseFloat(this.value).toFixed(2);
        }
    });

    document.getElementById('transportTollCost')?.addEventListener('blur', function() {
        if (this.value) {
            this.value = parseFloat(this.value).toFixed(2);
        }
    });
}

(function() {
    console.log('🚨 MOBILE-OPTIMIZED MODAL FIX LOADING...');
    
    // Store scroll position for mobile
    let scrollPosition = 0;
    
    window.openModal = function(modalId) {
    console.log('Opening modal:', modalId);
    
    // Close all
    document.querySelectorAll('.modal').forEach(m => {
        m.classList.remove('active', 'show');
        m.style.display = 'none';
    });
    
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    // Lock scroll
    const scrollPos = window.pageYOffset;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPos}px`;
    document.body.style.width = '100%';
    document.body.classList.add('modal-open');
    
    // Open modal - NO TRANSFORMS
    modal.style.cssText = `
        display: block !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 999999 !important;
        background: rgba(0, 0, 0, 0.85) !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
        padding: 20px 0 !important;
    `;
    
    modal.classList.add('active');
    
    // Force content visibility - NO TRANSFORMS
    const content = modal.querySelector('.modal-content');
    if (content) {
        content.style.cssText = `
            position: relative !important;
            display: flex !important;
            flex-direction: column !important;
            margin: 50px auto !important;
            background: white !important;
            border-radius: 12px !important;
            width: 90% !important;
            max-width: 600px !important;
            overflow: visible !important;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5) !important;
        `;
    }
    
    console.log('✅ Modal opened');
};
    window.closeModal = function(modalId) {
        console.log('🔒 CLOSING (MOBILE):', modalId || 'all');
        
        if (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active', 'show');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            }
        } else {
            document.querySelectorAll('.modal').forEach(m => {
                m.classList.remove('active', 'show');
                m.style.display = 'none';
                m.setAttribute('aria-hidden', 'true');
            });
        }
        
        // Restore scroll position (mobile fix)
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        document.body.classList.remove('modal-open');
        
        window.scrollTo(0, scrollPosition);
        
        console.log('✅ CLOSED (MOBILE)');
    };
    
    // Quick action functions
    window.showAddShiftModal = () => openModal('addShiftModal');
    window.showTransferModal = () => openModal('transferShiftModal');
    window.showAdjustmentModal = () => openModal('adjustmentModal');
    window.showLeaveModal = () => openModal('leaveModal');
    window.showTransportModal = () => openModal('transportModal');
    window.showSchoolHolidayModal = () => openModal('schoolHolidayModal');
    
    // Event delegation with TOUCH support for mobile
    document.addEventListener('click', function(e) {
        handleModalInteraction(e);
    });
    
    // Add touch support
    document.addEventListener('touchend', function(e) {
        handleModalInteraction(e);
    });
    
    function handleModalInteraction(e) {
        // Close button clicked
        if (e.target.matches('[data-modal-close]') || e.target.closest('[data-modal-close]')) {
            e.preventDefault();
            e.stopPropagation();
            const btn = e.target.matches('[data-modal-close]') ? e.target : e.target.closest('[data-modal-close]');
            const modalId = btn.getAttribute('data-modal-close');
            closeModal(modalId);
            return;
        }
        
        // Backdrop clicked (be careful on mobile)
        if (e.target.classList.contains('modal') && e.target.classList.contains('active')) {
            // Only close if directly clicking backdrop, not modal content
            const rect = e.target.getBoundingClientRect();
            const modalContent = e.target.querySelector('.modal-content');
            if (modalContent) {
                const contentRect = modalContent.getBoundingClientRect();
                const clickX = e.clientX || (e.touches && e.touches[0].clientX);
                const clickY = e.clientY || (e.touches && e.touches[0].clientY);
                
                // Only close if click is outside modal content
                if (clickX < contentRect.left || clickX > contentRect.right ||
                    clickY < contentRect.top || clickY > contentRect.bottom) {
                    closeModal();
                }
            }
        }
    }
    
    // ESC key (still works on mobile keyboards)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' || e.keyCode === 27) {
            closeModal();
        }
    });
    
    // Debug function
    window.debugModals = function() {
        console.log('=== MOBILE MODAL DEBUG ===');
        console.log('Screen size:', window.innerWidth, 'x', window.innerHeight);
        console.log('User agent:', navigator.userAgent);
        const modals = document.querySelectorAll('.modal');
        console.log('Total modals:', modals.length);
        modals.forEach(m => {
            const styles = window.getComputedStyle(m);
            console.log('Modal:', m.id, {
                display: styles.display,
                position: styles.position,
                zIndex: styles.zIndex,
                top: styles.top,
                left: styles.left,
                width: styles.width,
                height: styles.height,
                visibility: styles.visibility,
                opacity: styles.opacity
            });
        });
    };
    
    console.log('✅ MOBILE-OPTIMIZED MODAL FIX LOADED');
    console.log('Device:', /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop');
})();

        </script>
        </body>
        </html>

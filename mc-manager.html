<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MC Manager - Complete System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
        <script>
        // Google Maps Configuration
        const GOOGLE_MAPS_API_KEY = 'AIzaSyDo5V32Ix0Xi40HdORZ5XGtxYxMBGbUJfw'; // Replace with your actual API key
        
        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadGoogleMapsScript();
        });
        </script>
    <title>My Carers</title>
  
    <!-- favicon links -->
    <link rel="icon" type="image/png" sizes="16x16" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-32x32.png">

    <style>

      
        :root {

            .participant-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    color: white;
    white-space: nowrap;
}

.accordion-content { 
    display: none; 
}

.accordion-content.active { 
    display: table-row;
}
/* Pay Rate Badges */
.participant-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-default {
    background: #e9ecef;
    color: #495057;
}

.badge-assignment {
    background: #d4edda;
    color: #155724;
}

.badge-override {
    background: #fff3cd;
    color: #856404;
}

.badge-holiday {
    background: #f8d7da;
    color: #721c24;
}

.badge-sleepover {
    background: #cce5ff;
    color: #004085;
}

/* Shift Cards */
.shift-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    background: white;
    transition: box-shadow 0.2s;
}

.shift-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.shift-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.shift-badges {
    display: flex;
    gap: 6px;
}

.rate-summary {
    margin-top: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.rate-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.rate-summary-item {
    background: white;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.location-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    white-space: nowrap;
}
          

          /* Add to your existing styles */
@media (max-width: 768px) {
    /* Header adjustments */
    .header-content {
        flex-direction: column;
        padding: 12px;
        gap: 8px;
    }
    
    /* View toggle stack vertically */
    .view-toggle {
        flex-direction: column;
        width: 100%;
    }
    
    .view-toggle button {
        width: 100%;
        padding: 12px;
    }
    
    /* Table responsive */
    .roster-table {
        font-size: 11px;
    }
    
    .roster-table th,
    .roster-table td {
        padding: 8px 4px;
    }
    
    /* Hide less important columns on mobile */
    .roster-table th:nth-child(5),
    .roster-table td:nth-child(5) {
        display: none; /* Hide location column */
    }
    
    /* Timesheet responsive */
    .timesheet-table {
        font-size: 11px;
    }
    
    .timesheet-table th,
    .timesheet-table td {
        padding: 8px 4px;
    }
    
    /* Stack hour breakdown vertically */
    .hour-breakdown-item {
        display: block;
        margin-bottom: 4px;
    }
    
    /* Modal full screen on mobile */
    .modal {
        max-width: 100%;
        width: 100%;
        height: 100vh;
        border-radius: 0;
    }
    
    /* Filters stack vertically */
    .filter-row {
        grid-template-columns: 1fr;
    }
    
    /* Week navigation stack */
    .week-nav {
        flex-direction: column;
        gap: 12px;
    }
    
    .week-nav button {
        width: 100%;
    }
    
    /* Cards full width */
    .card {
        margin: 8px;
    }
    
    /* Request items stack content */
    .request-item {
        font-size: 13px;
    }
    
    .request-actions {
        flex-direction: column;
    }
    
    .request-actions .btn {
        width: 100%;
    }
    
    /* Summary cards stack */
    .summary-grid {
        grid-template-columns: 1fr;
    }
    
    /* Availability grid smaller */
    .availability-grid {
        font-size: 10px;
        grid-template-columns: 80px repeat(7, 1fr);
    }
    
    .availability-cell {
        padding: 6px;
        min-height: 35px;
    }
}

@media (max-width: 480px) {
    /* Even smaller screens */
    .roster-table {
        font-size: 10px;
    }
    
    /* Show only essential columns */
    .roster-table th:nth-child(6),
    .roster-table td:nth-child(6) {
        display: none; /* Hide duty type */
    }
    
    /* Compact timesheet */
    .timesheet-wrapper {
        margin: 0;
        border-radius: 0;
    }
    
    /* Smaller buttons */
    .btn {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 11px;
    }
}
            --primary-color: #004990;
            --primary-hover: #003d75;
            --success-color: #88a542;
            --success-hover: #7a9339;
            --info-color: #359dca;
            --info-hover: #2e8bb5;
            --warning-color: #f39c12;
            --warning-hover: #e67e22;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            
            --text-primary: #2c3e50;
            --text-secondary: #34495e;
            --text-muted: #7f8c8d;
            --text-light: #95a5a6;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-light: #ecf0f1;
            
            --border-color: #bdc3c7;
            --border-light: #ecf0f1;
            
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            --transition: all 0.2s ease-in-out;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: var(--font-size-base);
        }

        /* Header Styles */
        .header {
            background: var(--bg-primary);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-light);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }

        .logo {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: -0.5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-name {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: var(--font-size-base);
        }

        .user-role {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Button System */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            line-height: 1.4;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: var(--success-hover);
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: var(--warning-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--danger-hover);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--bg-light);
            border-color: var(--text-secondary);
        }

        .btn-sm {
            padding: 4px 12px;
            font-size: var(--font-size-xs);
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: var(--font-size-base);
        }

        /* Card System */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }

        .card-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .card-content {
            padding: 24px;
        }

        /* View Controls */
        .view-controls {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .view-toggle {
            display: flex;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 4px;
            gap: 2px;
        }

        .view-toggle button {
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
        }

        .view-toggle button.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .view-toggle button:hover:not(.active) {
            color: var(--text-secondary);
        }

        .view-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Week Navigation */
        .week-nav {
            background: var(--bg-primary);
            padding: 20px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
        }

        .week-display {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            min-width: 250px;
            text-align: center;
        }

        /* Filters */
        .filters {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .filter-group input, 
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            background: var(--bg-primary);
            transition: var(--transition);
        }

        .filter-group input:focus, 
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 73, 144, 0.1);
        }

        .searchable-dropdown {
            position: relative;
        }

        .searchable-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            background: var(--bg-primary);
            transition: var(--transition);
        }

        .searchable-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 73, 144, 0.1);
        }

        /* Table System */
        .table-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 24px;
            border: 1px solid var(--border-light);
        }

        .table-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        .roster-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .roster-table th {
            background: var(--bg-light);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 2px solid var(--border-color);
        }

        .roster-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: top;
            line-height: 1.4;
        }

        .roster-table tr:hover:not(.day-header) {
            background: var(--bg-secondary);
        }

        /* Day Color Coding - Subtle Left Border */
        .monday-shift { border-left: 4px solid #e91e63; }
        .tuesday-shift { border-left: 4px solid #ff9800; }
        .wednesday-shift { border-left: 4px solid #4caf50; }
        .thursday-shift { border-left: 4px solid #2196f3; }
        .friday-shift { border-left: 4px solid #9c27b0; }
        .saturday-shift { border-left: 4px solid #673ab7; }
        .sunday-shift { border-left: 4px solid #f44336; }

        /* Day Headers */
        .day-header {
            background: linear-gradient(135deg, var(--primary-color), var(--info-color)) !important;
        }

        .day-header td {
            color: white !important;
            font-weight: 600;
            padding: 12px 16px;
        }

        .day-stats {
            float: right;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        /* Status System */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-scheduled, .status-confirmed {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-completed {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-no_show, .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }

        .status-pending {
            background: #fff8e1;
            color: #f57c00;
        }

        /* Hour and Pay Display */
        .hour-breakdown {
            cursor: help;
            border-bottom: 1px dotted var(--text-muted);
            position: relative;
            font-weight: 600;
        }

        .pay-breakdown {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-top: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            line-height: 1.3;
        }

        .pay-override {
            background: #fff3cd;
            border-left: 3px solid var(--warning-color);
            padding: 4px 8px;
            font-size: var(--font-size-xs);
            border-radius: var(--radius-sm);
            margin-top: 4px;
            color: #856404;
        }

        .transfer-pending, .adjustment-pending {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 500;
            margin-top: 4px;
        }

        .transfer-pending {
            background: #fff3cd;
            color: #856404;
        }

        .adjustment-pending {
            background: #e1d5ff;
            color: #5b21b6;
        }

        .hour-warning {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin-top: 12px;
            border: 1px solid #f5c6cb;
        }

        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .modal.large {
            max-width: 800px;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-light);
            color: var(--text-primary);
        }

        .modal-content {
            padding: 24px;
            overflow: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .modal-footer .btn-danger {
            margin-right: auto;
        }

        .modal-footer .modal-actions {
            display: flex;
            gap: 12px;
        }

        /* Form System */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            background: var(--bg-primary);
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 73, 144, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            line-height: 1.5;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* View Content */
        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
        }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .summary-card h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: var(--font-size-lg);
            font-weight: 600;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 12px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item-details {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.4;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--text-muted);
            flex-direction: column;
            gap: 12px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-light);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            border: 1px solid transparent;
        }

        .notification.success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-hover);
        }

        .notification.error {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-hover);
        }

        .notification.info {
            background: var(--info-color);
            color: white;
            border-color: var(--info-hover);
        }

        .notification.warning {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-hover);
        }

        @keyframes slideIn {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .empty-state p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* Holiday Management */
        .holiday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border: 1px solid var(--border-light);
        }

        .holiday-form {
            padding: 20px;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            border: 1px solid var(--border-light);
        }

        .overlap-indicator {
    display: inline-block;
    background: #ffc107;
    color: #000;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 8px;
    cursor: help;
}

.overlap-tooltip {
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 10000;
    max-width: 300px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}



.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-confirmed {
    background: #d4edda;
    color: #155724;
}

.status-completed {
    background: #cce5ff;
    color: #004085;
}
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header-content {
                padding: 0 16px;
                flex-direction: column;
                height: auto;
                gap: 12px;
                padding-top: 12px;
                padding-bottom: 12px;
            }
            
            .view-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .view-toggle {
                justify-content: center;
            }
            
            .view-actions {
                justify-content: center;
            }
            
            .week-nav {
                flex-direction: column;
                gap: 16px;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .table-actions {
                justify-content: center;
            }
            
            .roster-table {
                font-size: var(--font-size-xs);
            }

            .roster-table th,
            .roster-table td {
                padding: 12px 8px;
            }
            
            .modal {
                max-width: 95%;
                margin: 0 auto;
            }
            
            .modal-footer {
                flex-direction: column;
                gap: 12px;
            }
            
            .modal-footer .btn-danger {
                margin-right: 0;
                order: 2;
            }
            
            .modal-footer .modal-actions {
                order: 1;
                width: 100%;
                justify-content: stretch;
            }
            
            .modal-actions .btn {
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .roster-table th,
            .roster-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <img src="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/LOGO%20No%20Background.png" 
            alt="My Carers Logo" 
            width="200">
                        <div class="user-info">
                <span class="user-name" id="userName">Loading...</span>
                <span class="user-role" id="userRole">Staff</span>
                <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- View Controls -->
        <section class="view-controls">
            <div class="view-toggle">
                <button onclick="switchView('table')" class="active" id="tableViewBtn">Roster</button>
                <button onclick="switchView('requests')" id="requestsViewBtn">Requests</button>
                <button onclick="switchView('assignments')" id="assignmentsViewBtn">Assignments</button> <!-- ADD THIS -->
                <button onclick="switchView('templates')" data-view="templates" id="templatesViewBtn">Templates</button>
                <button onclick="switchView('conflicts')" id="conflictsViewBtn" class="btn btn-danger btn-sm">Conflicts</button>
                <button onclick="switchView('summary')" id="summaryViewBtn">Summary</button>
                <button onclick="switchView('timesheet')" id="timesheetViewBtn">Timesheet</button>
                <button onclick="switchView('notes')" id="notesViewBtn">Notes</button>
                <button onclick="switchView('availability')" id="availabilityViewBtn">Availability</button>
                <button onclick="switchView('participants')" id="participantsViewBtn">Participants</button>
            </div>
            <div class="view-actions">
                <button class="btn btn-outline btn-sm" id="undoBtn" onclick="UndoRedoManager.undo()" disabled title="Nothing to undo (Ctrl+Z)">‚Ü∂ Undo</button>
                <button class="btn btn-outline btn-sm" id="redoBtn" onclick="UndoRedoManager.redo()" disabled title="Nothing to redo (Ctrl+Y)">‚Ü∑ Redo</button>
                <span style="border-left: 1px solid var(--border-color); margin: 0 8px; height: 24px;"></span>
                <button class="btn btn-primary" onclick="showAddShiftModal()">Add Shift</button>
                <button class="btn btn-warning" onclick="showPublicHolidayModal()">Holidays</button>
                <button class="btn btn-success btn-sm" onclick="generatePayrollSummary()">Payroll</button>
                <button class="btn btn-success btn-sm" onclick="exportData()">Export</button>
                <button class="btn btn-outline btn-sm" onclick="debugDataLoading()" style="background: #ff6b6b; color: white;">Debug</button>
            </div>
        </section>

        <!-- Week Navigation -->
<section class="week-nav">
    <button class="btn btn-outline" onclick="previousFortnight()">Previous Fortnight</button>
    <div class="week-display" id="weekDisplay">Loading...</div>
    <button class="btn btn-outline" onclick="nextFortnight()">Next Fortnight</button>
    <button class="btn btn-primary btn-sm" onclick="goToCurrentWeek()">Current Period</button>
</section>

        <!-- Filters -->
        <section class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>End Date</label>
                    <input type="date" id="endDate" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Staff</label>
                    <input type="text" class="searchable-input" id="staffFilterInput" 
                           placeholder="Type to search staff..." 
                           list="staffFilterList" onchange="updateStaffFilter()">
                    <datalist id="staffFilterList"></datalist>
                </div>
                <div class="filter-group">
                    <label>Participant</label>
                    <input type="text" class="searchable-input" id="participantFilterInput" 
                           placeholder="Type to search participants..." 
                           list="participantFilterList" onchange="updateParticipantFilter()">
                    <datalist id="participantFilterList"></datalist>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="statusFilter" onchange="applyFilters()">
                        <option value="">All Status</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="completed">Completed</option>
                        <option value="no_show">No Show</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Actions</label>
                    <button class="btn btn-outline btn-sm" onclick="clearAllFilters()" style="width: 100%;">Clear Filters</button>
                </div>
            </div>
        </section>

        <!-- Table View -->
        <div id="tableView" class="view-content active">
            <div class="table-container">
                <header class="table-header">
                    <h2 class="table-title">Shift Roster</h2>
                    <div class="table-actions">
                        <button class="btn btn-outline btn-sm" onclick="refreshData()">Refresh</button>
                    </div>
                </header>
                <div style="overflow-x: auto;">
                  <table class="roster-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Staff</th>
                            <th>Client</th>
                            <th>Location</th>
                            <th>Duty Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="shiftsTableBody">
                        <tr>
                            <td colspan="8" class="loading">
                                <div class="spinner"></div>
                                <span>Loading shifts...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>                
                </div>
            </div>
        </div>
       <div id="requestsView" class="view-content">
    <div class="table-container">
        <header class="table-header">
            <h2 class="table-title">Requests Management</h2>
            <div class="table-actions">
                <button class="btn btn-outline btn-sm" onclick="renderRequests()">
                    <span style="margin-right: 4px;"></span> Refresh
                </button>
            </div>
        </header>
        <div class="card-content" id="requestsContent">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading requests...</span>
            </div>
        </div>
    </div>
</div>
        <!-- Summary View -->
        <div id="summaryView" class="view-content">
            <div class="summary-grid" id="summaryGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading summary...</span>
                </div>
            </div>
        </div>

        <div id="templatesView" class="view-content" style="display: none;">
            <div class="table-container">
                <header class="table-header">
                    <h2 class="table-title">Roster Templates</h2>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="openCreateTemplateModal()">
                            <span style="margin-right: 4px;"></span> New Template
                        </button>
                        <button class="btn btn-outline" onclick="loadTemplates()">
                            <span style="margin-right: 4px;"></span> Refresh
                        </button>
                    </div>
                </header>
                <div id="templatesContent" style="padding: 24px;">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Timesheet View -->
        <div id="timesheetView" class="view-content">
            <div class="table-container">
                <header class="table-header">
                    <h2 class="table-title">Detailed Timesheet</h2>
                    <div class="table-actions">
                        <button class="btn btn-success btn-sm" onclick="exportTimesheet()">Export Timesheet</button>
                    </div>
                </header>
                <div class="card-content" id="timesheetContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading timesheet...</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="conflictsView" class="view-content">
          <div id="conflictsContent"></div>
      </div>

      <!-- Assignments View -->
<div id="assignmentsView" class="view-content" style="display: none;">
    <div class="table-container">
        <header class="table-header">
            <h2 class="table-title">Staff-Participant Assignments</h2>
            <div class="table-actions">
                <button class="btn btn-primary" onclick="switchAssignmentView('participant')">
                    By Participant
                </button>
                <button class="btn btn-outline" onclick="switchAssignmentView('staff')">
                    By Staff
                </button>
            </div>
        </header>
        <div class="card-content" id="assignmentContent">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading assignments...</span>
            </div>
        </div>
    </div>
</div>

<div id="notesView" class="view-content">
    <div class="table-container">
        <header class="table-header">
            <h2 class="table-title">Shift Notes</h2>
            <div class="table-actions">
                <!-- Change this button to call addShiftNote() -->
                <button class="btn btn-primary btn-sm" onclick="addShiftNote()">Add Shift Note</button>
            </div>
        </header>
        <div class="card-content" id="notesContent">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading notes...</span>
            </div>
        </div>
    </div>
</div>

<!-- STEP 2: ADD THIS VIEW SECTION (after availabilityView or at the end of view sections) -->
<div id="participantsView" class="view-content">
    <div class="table-container">
        <header class="table-header">
            <h2 class="table-title">Participant Management</h2>
            <div class="table-actions">
                <button class="btn btn-outline btn-sm" onclick="showParticipantMapOverview()">
                    üìç Map Overview
                </button>
                <button class="btn btn-primary" onclick="openParticipantModal()">
                    Add Participant
                </button>
                <button class="btn btn-outline btn-sm" onclick="loadParticipantsTable()">Refresh</button>
            </div>
        </header>
        
        <!-- Search and Filter Bar -->
        <div class="filters" style="padding: 1rem;">
            <div class="filter-row">
                <div class="filter-group" style="flex: 2;">
                    <label>Search</label>
                    <input type="text" id="participantSearch" placeholder="Search participants..." onkeyup="filterParticipants()">
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="participantStatusFilter" onchange="filterParticipants()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Service Type</label>
                    <select id="participantServiceFilter" onchange="filterParticipants()">
                        <option value="">All Services</option>
                        <option value="SIL">SIL</option>
                        <option value="SDA">SDA</option>
                        <option value="respite">Respite</option>
                        <option value="community">Community Access</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Actions</label>
                    <button class="btn btn-outline btn-sm" onclick="clearParticipantFilters()" style="width: 100%;">Clear Filters</button>
                </div>
            </div>
        </div>

        <!-- Participants Table -->
        <div style="overflow-x: auto;">
            <table class="roster-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>NDIS Number</th>
                        <th>Service Type</th>
                        <th>Location</th>
                        <th>Primary Contact</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="participantsTableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            <span>Loading participants...</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

    </main>

    
<!--Participant Modals-->
<div id="participantModal" class="modal-overlay" style="display: none;">
    <div class="modal large">
        <header class="modal-header">
            <h3 class="modal-title" id="participantModalTitle">Add Participant</h3>
            <button class="modal-close" onclick="closeModal('participantModal')">&times;</button>
        </header>
        <div class="modal-content">
            <!-- Tab Navigation -->
            <div class="modal-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e0e0e0;">
                <button type="button" class="tab-btn active" onclick="switchParticipantTab('details', event)" style="padding: 0.75rem 1rem; background: none; border: none; cursor: pointer;">Details</button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('medical', event)" style="padding: 0.75rem 1rem; background: none; border: none; cursor: pointer;">Medical</button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('contacts', event)" style="padding: 0.75rem 1rem; background: none; border: none; cursor: pointer;">Contacts</button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('location', event)" style="padding: 0.75rem 1rem; background: none; border: none; cursor: pointer;">Location</button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('documents', event)" style="padding: 0.75rem 1rem; background: none; border: none; cursor: pointer;">Documents</button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('staff', event)" style="padding: 0.75rem 1rem; background: none; border: none; cursor: pointer;">Staff</button>
            </div>

            <form id="participantForm" onsubmit="saveParticipant(event)">
                <input type="hidden" id="participantId" value="">
                
                <!-- Details Tab -->
                <div id="detailsTab" class="tab-content active">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="firstName" name="first_name" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="lastName" name="last_name" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Preferred Name</label>
                            <input type="text" id="preferredName" name="preferred_name">
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="dateOfBirth" name="date_of_birth">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>NDIS Number</label>
                            <input type="text" id="ndisNumber" name="ndis_number" pattern="[0-9]{9}" placeholder="9 digits">
                        </div>
                        <div class="form-group">
                            <label>Service Type</label>
                            <select id="serviceType" name="service_type">
                                <option value="">Select Service</option>
                                <option value="SIL">SIL (Supported Independent Living)</option>
                                <option value="SDA">SDA (Specialist Disability Accommodation)</option>
                                <option value="respite">Respite</option>
                                <option value="community">Community Access</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="participantPhone" name="phone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="participantEmail" name="email">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status</label>
                            <select id="participantStatus" name="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Plan Manager</label>
                            <input type="text" id="planManager" name="plan_manager">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Plan Start Date</label>
                            <input type="date" id="planStartDate" name="plan_start_date">
                        </div>
                        <div class="form-group">
                            <label>Plan End Date</label>
                            <input type="date" id="planEndDate" name="plan_end_date">
                        </div>
                    </div>

                    <!-- Address Section -->
                    <h4 style="margin-top: 1.5rem; margin-bottom: 1rem;">Address</h4>
                    <div class="form-group">
                        <label>Search Address</label>
                        <input type="text" id="addressAutocomplete" placeholder="Start typing address..." style="width: 100%;">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">Type to search and select from suggestions</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit/Apartment</label>
                            <input type="text" id="unitNumber" name="unit_number">
                        </div>
                        <div class="form-group">
                            <label>Street Number</label>
                            <input type="text" id="streetNumber" name="street_number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Street Name</label>
                        <input type="text" id="streetName" name="street_name">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Suburb</label>
                            <input type="text" id="suburb" name="suburb">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <select id="state" name="state">
                                <option value="">Select State</option>
                                <option value="NSW">NSW</option>
                                <option value="VIC">VIC</option>
                                <option value="QLD">QLD</option>
                                <option value="SA">SA</option>
                                <option value="WA">WA</option>
                                <option value="TAS">TAS</option>
                                <option value="ACT">ACT</option>
                                <option value="NT">NT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Postcode</label>
                            <input type="text" id="postcode" name="postcode" pattern="[0-9]{4}">
                        </div>
                    </div>
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="participantNotes" name="notes" rows="4"></textarea>
                    </div>
                </div>

                <!-- Medical Tab -->
                <div id="medicalTab" class="tab-content" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Medicare Number</label>
                            <input type="text" id="medicareNumber" name="medicare_number">
                        </div>
                        <div class="form-group">
                            <label>Private Health Insurance</label>
                            <input type="text" id="privateHealth" name="private_health">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>GP Name</label>
                            <input type="text" id="gpName" name="gp_name">
                        </div>
                        <div class="form-group">
                            <label>GP Phone</label>
                            <input type="tel" id="gpPhone" name="gp_phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Medical Conditions</label>
                        <textarea id="medicalConditions" name="medical_conditions" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Allergies</label>
                        <textarea id="allergies" name="allergies" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Dietary Requirements</label>
                        <textarea id="dietaryRequirements" name="dietary_requirements" rows="2"></textarea>
                    </div>

                    <!-- Medications Section -->
                    <h4 style="margin-top: 1.5rem;">Medications</h4>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addMedicationRow()">Add Medication</button>
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="roster-table">
                            <thead>
                                <tr>
                                    <th>Medication Name</th>
                                    <th>Dosage</th>
                                    <th>Frequency</th>
                                    <th>Prescriber</th>
                                    <th>Start Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="medicationsTableBody">
                                <!-- Medications will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Contacts Tab -->
                <div id="contactsTab" class="tab-content" style="display: none;">
                    <h4>Primary Contact</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="primaryContactName" name="primary_contact_name">
                        </div>
                        <div class="form-group">
                            <label>Relationship</label>
                            <input type="text" id="primaryContactRelationship" name="primary_contact_relationship">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="primaryContactPhone" name="primary_contact_phone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="primaryContactEmail" name="primary_contact_email">
                        </div>
                    </div>

                    <h4 style="margin-top: 1.5rem;">Emergency Contacts</h4>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addEmergencyContact()">Add Emergency Contact</button>
                    <div id="emergencyContactsList" style="margin-top: 1rem;">
                        <!-- Emergency contacts will be added here -->
                    </div>
                </div>

                <!-- Location Tab -->
                <div id="locationTab" class="tab-content" style="display: none;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button type="button" class="btn btn-outline btn-sm" onclick="getCurrentLocation()">
                            üìç Get Current Location
                        </button>
                        <div class="form-group" style="max-width: 200px;">
                            <label>Geofence Radius (meters)</label>
                            <input type="number" id="geofenceRadius" value="100" min="50" max="1000" step="50" onchange="updateGeofence()">
                        </div>
                    </div>
                
                    
                    <!-- Map Container -->
                    <div id="participantMap" style="height: 400px; border: 1px solid #ddd; border-radius: 8px;"></div>
<!-- Location Tab -->
<div id="locationTab" class="tab-content" style="display: none;">
    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <button type="button" class="btn btn-outline btn-sm" onclick="getCurrentLocation()">
            üìç Get Current Location
        </button>
        <div class="form-group" style="max-width: 200px;">
            <label>Geofence Radius (meters)</label>
            <input type="number" id="geofenceRadius" value="100" min="50" max="1000" step="50" onchange="updateGeofence()">
        </div>
    </div>
    
    <!-- Map Container -->
    <div id="participantMap" style="height: 400px; border: 1px solid #ddd; border-radius: 8px;"></div>
    
    <!-- Show current coordinates (for debugging/verification) -->
    <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
        <h4 style="margin-top: 0;">Location Information</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <strong>Address:</strong><br>
                <span id="locationAddressDisplay">
                    <!-- This will show the formatted address -->
                </span>
            </div>
            <div>
                <strong>Coordinates:</strong><br>
                Latitude: <span id="latDisplay">Not set</span><br>
                Longitude: <span id="lngDisplay">Not set</span>
            </div>
        </div>
        <div style="margin-top: 0.5rem;">
            <small style="color: #666;">
                üìç Drag the map marker to manually adjust location<br>
                üîÑ Address selection automatically updates coordinates<br>
                ‚úÖ Coordinates save to database as location_lat and location_lng
            </small>
        </div>
    </div>
    
    <!-- Note about shift tracking -->
    <div style="margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
        <strong>‚ÑπÔ∏è Location Tracking:</strong><br>
        Staff clock-in/clock-out locations are tracked in the Shifts section.
        This location is the participant's primary residence/location.
    </div>
</div>
</div>

                <!-- Documents Tab -->
                <div id="documentsTab" class="tab-content" style="display: none;">
                    <div style="padding: 1rem; background: #f5f5f5; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Document Type</label>
                                <select id="documentType">
                                    <option value="">Select Type</option>
                                    <option value="schedule_of_supports">Schedule of Supports</option>
                                    <option value="care_plan">Care Plan</option>
                                    <option value="behavior_support">Behavior Support Plan</option>
                                    <option value="medical_report">Medical Report</option>
                                    <option value="assessment">Assessment</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Document Name</label>
                                <input type="text" id="documentName" placeholder="Enter document name">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Expiry Date (if applicable)</label>
                                <input type="date" id="documentExpiry">
                            </div>
                            <div class="form-group">
                                <label>Upload File</label>
                                <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" onclick="uploadDocument()">Upload Document</button>
                    </div>

                    <h4>Documents</h4>
                    <input type="text" placeholder="Search documents..." onkeyup="filterDocuments(this.value)" style="width: 300px; margin-bottom: 1rem;">
                    <div style="overflow-x: auto;">
                        <table class="roster-table">
                            <thead>
                                <tr>
                                    <th>Document Name</th>
                                    <th>Type</th>
                                    <th>Uploaded</th>
                                    <th>Expiry</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTableBody">
                                <tr><td colspan="5" style="text-align: center;">No documents uploaded</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Staff Tab -->
                <div id="staffTab" class="tab-content" style="display: none;">
                    <h4>Assigned Staff</h4>
                    <div class="form-group">
                        <label>Add Staff Member</label>
                        <select id="staffToAdd">
                            <option value="">Select Staff</option>
                            <!-- Staff options will be populated here -->
                        </select>
                        <button type="button" class="btn btn-outline btn-sm" onclick="assignStaff()" style="margin-top: 0.5rem;">Assign Staff</button>
                    </div>

                    <h4 style="margin-top: 1.5rem;">Currently Assigned</h4>
                    <table class="roster-table">
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Role</th>
                                <th>Primary</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignedStaffTable">
                            <tr><td colspan="4" style="text-align: center;">No staff assigned</td></tr>
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
        <footer class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('participantModal')">Cancel</button>
            <button class="btn btn-primary" onclick="document.getElementById('participantForm').requestSubmit()">Save Participant</button>
        </footer>
    </div>
</div>

    <!-- Edit Shift Modal -->
    <div id="editShiftModal" class="modal-overlay" style="display: none;">
        <div class="modal large">
            <header class="modal-header">
                <h3 class="modal-title">Edit Shift</h3>
                <button class="modal-close" onclick="closeModal('editShiftModal')">&times;</button>
            </header>
            <div class="modal-content">
                <form id="editShiftForm">
                    <input type="hidden" id="editShiftId">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="editShiftDate" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Time</label>
                            <input type="time" id="editShiftStartTime">
                        </div>
                        <div class="form-group">
                            <label>End Time</label>
                            <input type="time" id="editShiftEndTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Staff *</label>
                        <input type="text" class="searchable-input" id="editShiftStaffInput" 
                               placeholder="Type to search staff..." 
                               list="editStaffList" required onchange="updateEditStaffSelection()">
                        <datalist id="editStaffList"></datalist>
                        <input type="hidden" id="editShiftStaff">
                    </div>
                    <div class="form-group">
                        <label>Participant</label>
                        <input type="text" class="searchable-input" id="editShiftParticipantInput" 
                               placeholder="Type to search participants..." 
                               list="editParticipantList" onchange="updateEditParticipantSelection()">
                        <datalist id="editParticipantList"></datalist>
                        <input type="hidden" id="editShiftParticipant">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <select id="editShiftLocation">
                            <option value="">Select Location</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duty Type *</label>
                        <select id="editShiftDutyType" required onchange="updateEditTimeFields()">
                            <option value="">Select Duty Type</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pay Rate Override</label>
                        <select id="editShiftPayRate">
                            <option value="">Use Staff Default</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editShiftStatus">
                            <option value="scheduled">Scheduled</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="no_show">No Show</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editShiftNotes" placeholder="Shift notes..."></textarea>
                    </div>
                </form>
            </div>
            <footer class="modal-footer">
                <button class="btn btn-danger" onclick="deleteShiftConfirm()">Delete Shift</button>
                <div class="modal-actions">
                    <button class="btn btn-outline" onclick="closeModal('editShiftModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="updateShift()">Save Changes</button>
                </div>
            </footer>
        </div>
    </div>

    <!-- Add Shift Modal -->
    <div id="addShiftModal" class="modal-overlay" style="display: none;">
        <div class="modal large">
            <header class="modal-header">
                <h3 class="modal-title">Add New Shift</h3>
                <button class="modal-close" onclick="closeModal('addShiftModal')">&times;</button>
            </header>
            <div class="modal-content">
                <form id="addShiftForm">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="shiftDate" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Time</label>
                            <input type="time" id="shiftStartTime">
                        </div>
                        <div class="form-group">
                            <label>End Time</label>
                            <input type="time" id="shiftEndTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Staff *</label>
                        <input type="text" class="searchable-input" id="shiftStaffInput" 
                               placeholder="Type to search staff..." 
                               list="staffDataList" required onchange="updateStaffSelection()">
                        <datalist id="staffDataList"></datalist>
                        <input type="hidden" id="shiftStaff">
                    </div>
                    <div class="form-group">
                        <label>Participant</label>
                        <input type="text" class="searchable-input" id="shiftParticipantInput" 
                               placeholder="Type to search participants..." 
                               list="participantDataList" onchange="updateParticipantSelection()">
                        <datalist id="participantDataList"></datalist>
                        <input type="hidden" id="shiftParticipant">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <select id="shiftLocation">
                            <option value="">Select Location</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duty Type *</label>
                        <select id="shiftDutyType" required onchange="updateTimeFields()">
                            <option value="">Select Duty Type</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pay Rate Override</label>
                        <select id="shiftPayRate">
                            <option value="">Use Staff Default</option>
                        </select>
                    </div>
                    <div id="hourWarningText" style="display: none;" class="hour-warning"></div>
                </form>
            </div>
            <footer class="modal-footer">
                <div class="modal-actions">
                    <button class="btn btn-outline" onclick="closeModal('addShiftModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="createShift()">Create Shift</button>
                </div>
            </footer>
        </div>
    </div>



    <!-- Public Holiday Modal -->
    <div id="publicHolidayModal" class="modal-overlay" style="display: none;">
        <div class="modal large">
            <header class="modal-header">
                <h3 class="modal-title">Public Holidays Management</h3>
                <button class="modal-close" onclick="closeModal('publicHolidayModal')">&times;</button>
            </header>
            <div class="modal-content">
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-primary btn-sm" onclick="showAddHolidayForm()">Add Holiday</button>
                </div>
                
                <div id="addHolidayForm" class="holiday-form" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Holiday Date</label>
                            <input type="date" id="holidayDate">
                        </div>
                        <div class="form-group">
                            <label>Holiday Name</label>
                            <input type="text" id="holidayName" placeholder="e.g., Christmas Day">
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-success btn-sm" onclick="addHoliday()">Add Holiday</button>
                        <button class="btn btn-outline btn-sm" onclick="cancelAddHoliday()">Cancel</button>
                    </div>
                </div>

                <div>
                    <h4 style="margin-bottom: 16px; color: var(--text-secondary);">Current Public Holidays</h4>
                    <div id="holidayList" style="max-height: 300px; overflow-y: auto;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Loading holidays...</span>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="modal-footer">
                <div class="modal-actions">
                    <button class="btn btn-outline" onclick="closeModal('publicHolidayModal')">Close</button>
                </div>
            </footer>
        </div>
    </div>

    <script>
    
        // Initialize Supabase
        const supabaseUrl = 'https://gqchhsayqxttewthcsah.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxY2hoc2F5cXh0dGV3dGhjc2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTA0ODksImV4cCI6MjA3MjI2NjQ4OX0.iAGhrDZaHkpLwjJY07o-73l2OiePB2x1ZnnTEfUBd_M';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        let requestViewMode = 'staff';
        let publicHolidays = new Map();
        let rosterTemplates = [];
        let currentTemplate = null;
        let templateShifts = [];
        let payRateLabels = new Map();
        
        let currentUser = null;
        let currentUserRole = 'staff';
        let currentStaffData = null;
        let shifts = [];
        let shiftId= [];
        let staff = [];
        let participants = [];
        let locations = [];
        let dutyTypes = [];
        let payRates = [];
        let filteredShifts = [];
        let currentView = 'table';
        let currentWeekStart = new Date();
        let staffFilterValue = '';
        let participantFilterValue = '';
        let undoStack = [];
        let redoStack = [];
        let assignmentViewMode = 'participant';
        let currentRequestType = 'transport_claims';
        let currentRequestStatus = 'pending';
        let isLoadingRequest = false;
        let currentManagerStaff = null;
        let currentParticipantId = null;
        let participantMap = null;
        let participantMarker = null;
        let geofenceCircle = null;
        let autocomplete = null;
        let participantsData = [];


const MAX_UNDO_STACK = 20;
let careHomes = new Map(); 
let activeCareHomeFilter = null; 
const TIMEZONE = 'Australia/Sydney';
const LOCALE = 'en-AU';
const LOCATION_IDS = {
    SAUNDERS_CARE_HOME: "82be1e0c-7036-4063-b161-1ab91162c3e1",
    CLIENT_HOME: "00000000-0000-0000-0000-000000000001", 
    MY_CARERS_OFFICE: "e020835c-b8d8-46d2-81ac-4761cbe77f17"
};

const DB_ERRORS = {
    FOREIGN_KEY_VIOLATION: "23503", // Referenced record doesn't exist
    UNIQUE_VIOLATION: "23505",      // Duplicate entry
    NOT_NULL_VIOLATION: "23502"     // Required field missing
};

async function verifyDataConnections() {
    console.log('=== VERIFYING DATA CONNECTIONS ===');
    
    const tests = {
        // Test shifts table structure
        'Shifts ID type': async () => {
            const { data } = await supabaseClient.from('shifts').select('id').limit(1);
            return data?.[0]?.id ? `‚úÖ Type: ${typeof data[0].id}` : '‚ùå No shifts';
        },
        
        // Test shift_adjustment_requests
        'Adjustment Request shift_id': async () => {
            const { error } = await supabaseClient
                .from('shift_adjustment_requests')
                .insert({ 
                    shift_id: 1, // Try integer
                    staff_id: staff[0]?.id,
                    reason: 'test'
                })
                .select();
            await supabaseClient.from('shift_adjustment_requests').delete().eq('reason', 'test');
            return error ? `‚ùå Error: ${error.message}` : '‚úÖ Accepts integers';
        },
        
        // Test template day_of_week constraint
        'Template day_of_week range': async () => {
            const { data } = await supabaseClient
                .from('roster_template_shifts')
                .select('day_of_week')
                .order('day_of_week');
            const days = [...new Set(data?.map(d => d.day_of_week) || [])];
            return `Range: ${Math.min(...days)}-${Math.max(...days)} (Should be 0-6)`;
        },
        
        // Check loaded data
        'Staff loaded': staff?.length || 0,
        'Participants loaded': participants?.length || 0,
        'Locations loaded': locations?.length || 0,
        'Duty Types loaded': dutyTypes?.length || 0,
        'Current Staff': currentStaffData?.id ? '‚úÖ' : '‚ùå'
    };
    
    for (const [test, check] of Object.entries(tests)) {
        const result = typeof check === 'function' ? await check() : check;
        console.log(`${test}: ${result}`);
    }
}

// ========================================
// FORTNIGHT NAVIGATION
// ========================================

function setCurrentWeek(skipDateRange = false) {
    const today = new Date();
    currentWeekStart = getFortnightStart(today);
    updateWeekDisplay(skipDateRange);
}

function previousFortnight() {
    const prevFortnight = new Date(currentWeekStart);
    prevFortnight.setDate(prevFortnight.getDate() - 14);
    // Recalculate to ensure we're on a Monday
    currentWeekStart = getFortnightStart(prevFortnight);
    updateWeekDisplay();
    applyFilters();
}

function nextFortnight() {
    const nextFortnight = new Date(currentWeekStart);
    nextFortnight.setDate(nextFortnight.getDate() + 14);
    // Recalculate to ensure we're on a Monday
    currentWeekStart = getFortnightStart(nextFortnight);
    updateWeekDisplay();
    applyFilters();
}
function goToCurrentWeek() {
    setCurrentWeek();
    applyFilters();
}

function updateWeekDisplay(skipDateRange = false) {
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 13);
    
    const startStr = currentWeekStart.toLocaleDateString('en-AU', { 
        day: 'numeric', month: 'short' 
    });
    const endStr = weekEnd.toLocaleDateString('en-AU', { 
        day: 'numeric', month: 'short', year: 'numeric' 
    });
    
    const display = document.getElementById('weekDisplay');
    if (display) {
        display.textContent = `${startStr} - ${endStr}`;
    }
    
    // Only set date range if not skipping
    if (!skipDateRange) {
        setFortnightDateRange();
    }
}


function getFortnightStart(date) {
    console.log('Input:', date.toDateString(), 'Day:', ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][date.getDay()]);
    
    const start = new Date(date);
    const day = start.getDay();
    
    let daysBack;
    if (day === 0) {
        daysBack = 6;
    } else {
        daysBack = day - 1;
    }
    
    start.setDate(start.getDate() - daysBack);
    start.setHours(0, 0, 0, 0);
    console.log('After Monday calc:', start.toDateString(), 'Day:', ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][start.getDay()]);
    
    // Fortnight alignment
    const referenceDate = new Date('2025-09-29');
    const daysDiff = Math.floor((start - referenceDate) / (1000 * 60 * 60 * 24));
    const weekNumber = Math.floor(daysDiff / 7);
    
    if (weekNumber % 2 === 1) {
        start.setDate(start.getDate() - 7);
        console.log('After fortnight align:', start.toDateString(), 'Day:', ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][start.getDay()]);
    }
    
    console.log('Final result:', start.toDateString(), 'Day:', ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][start.getDay()]);
    return start;
}

function setFortnightDateRange() {
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 13);
    
    // Create new dates to avoid timezone issues
    const startYear = currentWeekStart.getFullYear();
    const startMonth = String(currentWeekStart.getMonth() + 1).padStart(2, '0');
    const startDay = String(currentWeekStart.getDate()).padStart(2, '0');
    const startDateStr = `${startYear}-${startMonth}-${startDay}`;
    
    const endYear = weekEnd.getFullYear();
    const endMonth = String(weekEnd.getMonth() + 1).padStart(2, '0');
    const endDay = String(weekEnd.getDate()).padStart(2, '0');
    const endDateStr = `${endYear}-${endMonth}-${endDay}`;
    
    console.log('Setting dates:', {
        start: startDateStr,
        end: endDateStr,
        startDay: currentWeekStart.getDay(),
        endDay: weekEnd.getDay()
    });
    
    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    
    if (startInput) startInput.value = startDateStr;
    if (endInput) endInput.value = endDateStr;
}

// Backward compatibility for any code still calling old functions
const previousWeek = previousFortnight;
const nextWeek = nextFortnight;

async function initializeApp() {
    try {
        console.log('=== INITIALIZING MC MANAGER ===');
        
        // Check authentication
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error) throw error;
        
        if (!session) {
            window.location.href = 'index.html';
            return;
        }

        currentUser = session.user;
        
        // Check both possible locations for role
        currentUserRole = currentUser.user_metadata?.role || 
                         currentUser.raw_user_meta_data?.role || 
                         'staff';
        
        console.log('User authenticated:', currentUser.email);
        console.log('User role detected:', currentUserRole);
        
        // Get staff record if linked
        if (currentUser.id) {
            const { data: staffData, error: staffError } = await supabaseClient
                .from('staff')
                .select('*')
                .eq('user_id', currentUser.id)
                .maybeSingle();
            
            if (staffError) {
                console.error('Error loading staff data:', staffError);
            }
            
            currentStaffData = staffData;
            currentManagerStaff = staffData; // ADD THIS LINE - Set global for approval functions
            console.log('Current staff data loaded:', currentStaffData);
        }

        // Update UI
        let displayName = 'Unknown User';
        
        if (currentStaffData) {
            displayName = `${currentStaffData.first_name} ${currentStaffData.last_name}`;
        } else if (currentUser.user_metadata?.first_name) {
            displayName = `${currentUser.user_metadata.first_name} ${currentUser.user_metadata.last_name || ''}`;
        } else if (currentUser.email) {
            displayName = currentUser.email.split('@')[0];
        }
        
        
        // Update the UI elements
        document.getElementById('userName').textContent = displayName;
        document.getElementById('userRole').textContent = 
            currentUserRole.charAt(0).toUpperCase() + currentUserRole.slice(1);

        // Initialize week navigation
        setCurrentWeek(false);            
        
        // Load all data - make sure these functions exist
        await loadInitialData();
        
        // ADD THIS LINE - Load duty types for template dropdowns
        await loadDutyTypes();
        
        await loadPublicHolidays();
        
        await loadShifts();

        console.log('=== INITIALIZATION COMPLETE ===');

    } catch (error) {
        console.error('CRITICAL: Initialization error:', error);
        document.getElementById('userName').textContent = 'Error Loading';
        document.getElementById('userRole').textContent = 'Error';
        showNotification('Failed to initialize: ' + error.message, 'error');
    }
}

async function saveHoliday() {
    try {
        const name = document.getElementById('holidayName').value;
        const date = document.getElementById('holidayDate').value;
        const recurring = document.getElementById('holidayRecurring').checked;
        const state = document.getElementById('holidayState')?.value || 'National';
        
        if (!name || !date) {
            showNotification('Please enter holiday name and date', 'error');
            return;
        }
        
        const { data, error } = await supabaseClient
            .from('public_holidays')
            .insert({
                name: name,
                date: date,
                is_recurring: recurring,
                state: state,
                created_at: new Date().toISOString()
            })
            .select();
        
        if (error) throw error;
        
        showNotification('Holiday saved successfully', 'success');
        
        // Clear form
        document.getElementById('holidayName').value = '';
        document.getElementById('holidayDate').value = '';
        document.getElementById('holidayRecurring').checked = false;
        
        // Reload the holidays display
        await loadPublicHolidays();
        
    } catch (error) {
        console.error('Error saving holiday:', error);
        showNotification('Failed to save holiday: ' + error.message, 'error');
    }
}


function getPayRateAbbreviation(label) {
    if (!label) return 'STD';
    
    // Special cases
    if (label.toLowerCase().includes('sleepover')) return 'SLP';
    if (label.toLowerCase().includes('public holiday')) return 'PH';
    
    // Extract first letter/number after each space
    const words = label.trim().split(/\s+/);
    const abbrev = words.map(word => {
        const match = word.match(/[A-Z0-9]/i);
        return match ? match[0].toUpperCase() : '';
    }).join('');
    
    return abbrev || 'STD';
}

async function initAssignmentManager() {
    const container = document.getElementById('assignmentContent');
    if (!container) {
        console.error('Assignment content container not found');
        return;
    }
    
    // Show loading
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Loading assignments...</span>
        </div>
    `;
    
    await loadAssignmentData();
}

// Load assignment data
async function loadAssignmentData() {
    try {
        const [assignments, staff, participants, payRates] = await Promise.all([
            supabaseClient
                .from('staff_participant_assignments')
                .select('*'),
            
            supabaseClient
                .from('staff')
                .select('*')
                .eq('is_active', true)
                .order('first_name'),
            
            supabaseClient
                .from('participants')
                .select('*')
                .eq('is_active', true)
                .neq('first_name', 'My Carers')
                .order('first_name'),
            
            supabaseClient
                .from('pay_rates')
                .select('*')
                .order('category, level, pay_point')
        ]);
        
        // Create lookup maps
        const staffMap = new Map();
        staff.data?.forEach(s => staffMap.set(s.id, s));
        
        const participantMap = new Map();
        participants.data?.forEach(p => participantMap.set(p.id, p));
        
        const payRateMap = new Map();
        payRates.data?.forEach(pr => {
            const label = `${pr.category} ${pr.level}${pr.pay_point ? ' ' + pr.pay_point : ''}`;
            payRateMap.set(pr.id, {
                ...pr,
                label: label,
                abbreviation: getPayRateAbbreviation(label)
            });
        });
        
        // Store data globally
        window.assignmentData = {
            assignments: assignments.data || [],
            staffMap: staffMap,
            participantMap: participantMap,
            payRateMap: payRateMap,
            staff: staff.data || [],
            participants: participants.data || [],
            payRates: payRates.data || []
        };
        
        // Set default view mode if not set
        if (!window.assignmentViewMode) {
            window.assignmentViewMode = 'participant';
        }
        
        renderAssignments();
        
    } catch (error) {
        console.error('Error loading assignment data:', error);
        const container = document.getElementById('assignmentContent');
        container.innerHTML = `
            <div class="error-message" style="text-align: center; padding: 40px;">
                <p style="color: red;">Failed to load assignments: ${error.message}</p>
                <button class="btn btn-primary" onclick="initAssignmentManager()">Retry</button>
            </div>
        `;
    }
}

// Helper function to generate pay rate abbreviations
function getPayRateAbbreviation(label) {
    if (!label) return 'STD';
    
    // Common patterns
    if (label.includes('SCHADS')) return 'SCH';
    if (label.includes('Social')) return 'SOC';
    if (label.includes('Home Care')) return 'HC';
    if (label.includes('Disability')) return 'DSW';
    
    // Otherwise use first letter of each word
    return label.split(' ')
        .map(word => word[0])
        .join('')
        .substring(0, 3)
        .toUpperCase();
}

function renderAssignments() {
    const assignmentContent = document.getElementById('assignmentContent');
    if (!assignmentContent || !window.assignmentData) return;
    
    const { assignments, staffMap, participantMap, payRateMap, staff, participants } = window.assignmentData;
    
    // Use both dropdown filters AND global filters
    const dropdownStaffFilter = document.getElementById('staffSelect')?.value;
    const dropdownParticipantFilter = document.getElementById('participantSelect')?.value;
    
    // Get global filters from the top bar
    const globalFilters = window.currentFilters || {};
    
    // Prioritize dropdown filters, fall back to global filters
    const staffFilter = dropdownStaffFilter || globalFilters.staffId;
    const participantFilter = dropdownParticipantFilter || globalFilters.participantId;
    
    let filteredAssignments = assignments;
    if (staffFilter && staffFilter !== 'all' && staffFilter !== '') {
        filteredAssignments = filteredAssignments.filter(a => a.staff_id === staffFilter);
    }
    if (participantFilter && participantFilter !== 'all' && participantFilter !== '') {
        filteredAssignments = filteredAssignments.filter(a => a.participant_id === participantFilter);
    }
    
    let html = `
        <style>
            /* Assignment-specific accordion styles with unique selectors */
            .assignment-accordion-content { 
                display: none !important; 
                background: #f8f9fa;
            }
            
            .assignment-accordion-content.active { 
                display: table-row !important;
                animation: slideDown 0.3s ease;
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .assignment-accordion-arrow { 
                display: inline-block; 
                margin-right: 10px; 
                transition: transform 0.3s ease; 
                font-size: 12px;
                color: var(--primary-color);
                font-weight: bold;
                cursor: pointer;
            }
            
            .assignment-accordion-arrow.open { 
                transform: rotate(90deg); 
            }
            
            /* Rest of your existing styles... */
            .timesheet-wrapper {
                background: white;
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            .timesheet-table { 
                width: 100%; 
                border-collapse: separate;
                border-spacing: 0;
                background: white;
            }
            
            .timesheet-table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .timesheet-table th { 
                padding: 16px 12px; 
                text-align: left; 
                font-weight: 600; 
                font-size: 11px; 
                text-transform: uppercase;
                letter-spacing: 1px;
                color: white;
                border: none;
            }
            
            .timesheet-row { 
                cursor: pointer; 
                transition: all 0.2s ease;
                background: white;
                position: relative;
            }
            
            .timesheet-row:hover { 
                background: #f8f9fa;
                transform: translateX(2px);
            }
            
            .timesheet-row td { 
                padding: 16px 12px; 
                border-bottom: 1px solid #e9ecef; 
                font-size: 14px;
                vertical-align: middle;
            }
            
            .staff-name {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 15px;
            }
            
            .pay-rate-badge {
                display: inline-block;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 500;
                letter-spacing: 0.5px;
            }
            
            .shifts-detail-container {
                padding: 24px;
                background: white;
                margin: 16px;
                border-radius: 8px;
                box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            }
            
            .shifts-detail-header {
                margin-bottom: 16px;
                color: var(--text-secondary);
                font-size: 13px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .shifts-detail-table { 
                width: 100%;
                font-size: 13px;
                border-collapse: separate;
                border-spacing: 0;
                overflow: hidden;
                border-radius: 6px;
                border: 1px solid #e9ecef;
            }
            
            .shifts-detail-table th { 
                background: #f8f9fa;
                padding: 10px 12px; 
                text-align: left;
                font-weight: 600;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-secondary);
                border-bottom: 1px solid #e9ecef;
            }
            
            .shifts-detail-table td { 
                padding: 12px; 
                border-bottom: 1px solid #f1f3f4;
                background: white;
            }
            
            .assignment-modal {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                z-index: 9999 !important;
                background: white;
                border-radius: 8px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                max-width: 500px;
                width: 90%;
            }
            
            .modal-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9998;
            }
            
            .assignment-detail-row {
                background: white;
                border-bottom: 1px solid #e9ecef;
                transition: background 0.2s;
            }
            
            .assignment-detail-row:hover {
                background: #f8f9fa;
            }
            
            .assignment-detail-row td {
                padding: 12px 16px !important;
                vertical-align: middle;
            }
            
            .action-btn {
                padding: 6px 12px !important;
                font-size: 13px !important;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }
        </style>
        
        <div class="timesheet-wrapper">
            <table class="timesheet-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">${assignmentViewMode === 'participant' ? 'Participant' : 'Staff Member'}</th>
                        <th style="width: 20%;">Identifier</th>
                        <th style="width: 15%;">Assignments</th>
                        <th style="width: 20%;">Default Rate</th>
                        <th style="width: 15%; text-align: center;">Action</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    let accordionIndex = 0;
    
    if (assignmentViewMode === 'participant') {
        // Participant view
        let displayParticipants = participantFilter && participantFilter !== 'all' && participantFilter !== '' ? 
            participants.filter(p => p.id === participantFilter) : 
            participants;
            
        displayParticipants.forEach(participant => {
            const participantAssignments = filteredAssignments.filter(a => 
                a.participant_id === participant.id
            );
            
            if (staffFilter && staffFilter !== 'all' && staffFilter !== '' && participantAssignments.length === 0) {
                return;
            }
            
            html += `
                <tr class="timesheet-row" onclick="toggleAssignmentAccordion(${accordionIndex})">
                    <td>
                        <span class="assignment-accordion-arrow" id="assignment-arrow-${accordionIndex}">‚ñ∂</span>
                        <span class="staff-name">${participant.first_name} ${participant.last_name}</span>
                    </td>
                    <td>
                        <span style="color: var(--text-muted);">${participant.ndis_participant_number || 'No NDIS'}</span>
                    </td>
                    <td>
                        <span class="pay-rate-badge">${participantAssignments.length} staff</span>
                    </td>
                    <td>‚Äî</td>
                    <td style="text-align: center;">
                        <button class="btn btn-primary btn-sm action-btn" 
                                onclick="event.stopPropagation(); showAddAssignmentModal('participant', '${participant.id}')">
                            <i class="fas fa-plus"></i> Add Staff
                        </button>
                    </td>
                </tr>
                <tr class="assignment-accordion-content" id="assignment-accordion-${accordionIndex}">
                    <td colspan="5" style="padding: 0;">
                        <div class="shifts-detail-container" style="background: #f8f9fa; padding: 20px;">
                            <h4 class="shifts-detail-header" style="margin-bottom: 16px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Assigned Staff Members (${participantAssignments.length})
                            </h4>
                            ${participantAssignments.length > 0 ? `
                                <table class="shifts-detail-table" style="width: 100%; background: white; border-radius: 6px; overflow: hidden;">
                                    <thead style="background: #667eea;">
                                        <tr>
                                            <th style="padding: 10px 16px; text-align: left;">Staff Member</th>
                                            <th style="padding: 10px 16px;">Staff Code</th>
                                            <th style="padding: 10px 16px;">Pay Rate</th>
                                            <th style="padding: 10px 16px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${participantAssignments.map(assignment => {
                                            const staff = staffMap.get(assignment.staff_id);
                                            const payRate = payRateMap.get(assignment.pay_rate_id);
                                            const staffDefaultRate = staff ? payRateMap.get(staff.pay_rate_id) : null;
                                            const isUsingDefault = staff && assignment.pay_rate_id === staff.pay_rate_id;
                                            
                                            return `
                                                <tr class="assignment-detail-row">
                                                    <td><strong>${staff?.first_name || 'Unknown'} ${staff?.last_name || ''}</strong></td>
                                                    <td><span class="text-muted">${staff?.staff_code || '‚Äî'}</span></td>
                                                    <td>
                                                        <span class="participant-badge">${payRate?.abbreviation || 'STD'}</span>
                                                        <span class="text-muted" style="margin-left: 8px; font-size: 12px;">
                                                            ${payRate?.label || 'Standard'}${isUsingDefault ? ' (Staff Default)' : ''}
                                                        </span>
                                                    </td>
                                                    <td style="text-align: center;">
                                                        <button class="btn btn-secondary btn-sm action-btn" 
                                                                onclick="event.stopPropagation(); showEditAssignmentModal('${assignment.staff_id}', '${assignment.participant_id}')">
                                                            <i class="fas fa-edit"></i> Edit Rate
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            ` : `
                                <div style="padding: 40px; text-align: center; background: white; border-radius: 6px; color: var(--text-muted);">
                                    <i class="fas fa-user-slash" style="font-size: 32px; margin-bottom: 16px; opacity: 0.3;"></i>
                                    <p>No staff members assigned to this participant</p>
                                    <button class="btn btn-primary" onclick="event.stopPropagation(); showAddAssignmentModal('participant', '${participant.id}')">
                                        <i class="fas fa-plus"></i> Assign First Staff Member
                                    </button>
                                </div>
                            `}
                        </div>
                    </td>
                </tr>
            `;
            accordionIndex++;
        });
        
    } else {
        // Staff view - same changes with unique IDs
        let displayStaff = staffFilter && staffFilter !== 'all' && staffFilter !== '' ? 
            staff.filter(s => s.id === staffFilter) : 
            staff;
            
        displayStaff.forEach(staffMember => {
            const staffAssignments = filteredAssignments.filter(a => 
                a.staff_id === staffMember.id
            );
            
            if (participantFilter && participantFilter !== 'all' && participantFilter !== '' && staffAssignments.length === 0) {
                return;
            }
            
            const defaultPayRate = payRateMap.get(staffMember.pay_rate_id);
            
            html += `
                <tr class="timesheet-row" onclick="toggleAssignmentAccordion(${accordionIndex})">
                    <td>
                        <span class="assignment-accordion-arrow" id="assignment-arrow-${accordionIndex}">‚ñ∂</span>
                        <span class="staff-name">${staffMember.first_name} ${staffMember.last_name}</span>
                    </td>
                    <td>
                        <span style="color: var(--text-muted);">${staffMember.staff_code || 'No Code'}</span>
                    </td>
                    <td>
                        <span class="pay-rate-badge">${staffAssignments.length} participants</span>
                    </td>
                    <td>
                        ${staffMember.pay_rate_id && defaultPayRate ? `
                            <span class="participant-badge">${defaultPayRate.abbreviation}</span>
                            <span style="margin-left: 8px; color: var(--text-muted); font-size: 12px;">
                                ${defaultPayRate.label} (Default)
                            </span>
                        ` : '<span style="color: var(--text-muted);">No default rate set</span>'}
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-primary btn-sm action-btn" 
                                onclick="event.stopPropagation(); showAddAssignmentModal('staff', '${staffMember.id}')">
                            <i class="fas fa-plus"></i> Add Client
                        </button>
                    </td>
                </tr>
                <tr class="assignment-accordion-content" id="assignment-accordion-${accordionIndex}">
                    <td colspan="5" style="padding: 0;">
                        <div class="shifts-detail-container" style="background: #f8f9fa; padding: 20px;">
                            <h4 class="shifts-detail-header" style="margin-bottom: 16px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Assigned Participants (${staffAssignments.length})
                            </h4>
                            ${staffAssignments.length > 0 ? `
                                <table class="shifts-detail-table" style="width: 100%; background: white; border-radius: 6px; overflow: hidden;">
                                    <thead style="background: #667eea;">
                                        <tr>
                                            <th style="padding: 10px 16px; text-align: left;">Participant</th>
                                            <th style="padding: 10px 16px;">NDIS Number</th>
                                            <th style="padding: 10px 16px;">Pay Rate</th>
                                            <th style="padding: 10px 16px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${staffAssignments.map(assignment => {
                                            const participant = participantMap.get(assignment.participant_id);
                                            const payRate = payRateMap.get(assignment.pay_rate_id);
                                            const isUsingDefault = assignment.pay_rate_id === staffMember.pay_rate_id;
                                            
                                            return `
                                                <tr class="assignment-detail-row">
                                                    <td><strong>${participant?.first_name || 'Unknown'} ${participant?.last_name || ''}</strong></td>
                                                    <td><span class="text-muted">${participant?.ndis_participant_number || '‚Äî'}</span></td>
                                                    <td>
                                                        <span class="participant-badge">${payRate?.abbreviation || 'STD'}</span>
                                                        <span class="text-muted" style="margin-left: 8px; font-size: 12px;">
                                                            ${payRate?.label || 'Standard'}${isUsingDefault ? ' (Staff Default)' : ''}
                                                        </span>
                                                    </td>
                                                    <td style="text-align: center;">
                                                        <button class="btn btn-secondary btn-sm action-btn" 
                                                                onclick="event.stopPropagation(); showEditAssignmentModal('${assignment.staff_id}', '${assignment.participant_id}')">
                                                            <i class="fas fa-edit"></i> Edit Rate
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            ` : `
                                <div style="padding: 40px; text-align: center; background: white; border-radius: 6px; color: var(--text-muted);">
                                    <i class="fas fa-users-slash" style="font-size: 32px; margin-bottom: 16px; opacity: 0.3;"></i>
                                    <p>No participants assigned to this staff member</p>
                                    <button class="btn btn-primary" onclick="event.stopPropagation(); showAddAssignmentModal('staff', '${staffMember.id}')">
                                        <i class="fas fa-plus"></i> Assign First Participant
                                    </button>
                                </div>
                            `}
                        </div>
                    </td>
                </tr>
            `;
            accordionIndex++;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    assignmentContent.innerHTML = html;
}

window.toggleAssignmentAccordion = function(index) {
    const content = document.getElementById(`assignment-accordion-${index}`);
    const arrow = document.getElementById(`assignment-arrow-${index}`);
    
    if (content && arrow) {
        content.classList.toggle('active');
        arrow.classList.toggle('open');
    }
};

// Switch view mode
function switchAssignmentView(mode) {
    assignmentViewMode = mode;
    renderAssignments();
}

// Show edit assignment modal
// Show edit assignment modal
async function showEditAssignmentModal(staffId, participantId) {
    try {
        const assignment = window.assignmentData.assignments.find(a => 
            a.staff_id === staffId && a.participant_id === participantId
        );
        
        const staff = window.assignmentData.staffMap.get(staffId);
        const participant = window.assignmentData.participantMap.get(participantId);
        const currentPayRate = window.assignmentData.payRateMap.get(assignment.pay_rate_id);
        
        // Get the staff's default pay rate
        const staffDefaultPayRate = staff?.pay_rate_id ? 
            window.assignmentData.payRateMap.get(staff.pay_rate_id) : null;
        
        // Add backdrop and modal with proper positioning
        const modalHtml = `
            <div class="modal-backdrop" id="editAssignmentBackdrop" onclick="closeModal('editAssignmentModal')" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9998;
            "></div>
            <div class="modal" id="editAssignmentModal" style="
                display: block;
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                z-index: 9999 !important;
                max-width: 500px;
                width: 90%;
            ">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5>Edit Assignment</h5>
                            <button class="close" onclick="closeModal('editAssignmentModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="assignment-info" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <div><strong>Staff:</strong> ${staff?.first_name} ${staff?.last_name}</div>
                                <div><strong>Participant:</strong> ${participant?.first_name} ${participant?.last_name}</div>
                                <div>
                                    <strong>Current Rate:</strong> 
                                    <span class="participant-badge">${currentPayRate?.abbreviation}</span>
                                    ${currentPayRate?.label} - $${currentPayRate?.hourly_pay_rate?.toFixed(2)}/hr
                                </div>
                                <div style="margin-top: 8px; color: #6c757d; font-size: 13px;">
                                    <strong>Staff Default:</strong> 
                                    ${staffDefaultPayRate ? `
                                        <span class="participant-badge" style="font-size: 10px;">${staffDefaultPayRate.abbreviation}</span>
                                        ${staffDefaultPayRate.label} (Default)
                                    ` : 'No default rate set'}
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Change Pay Rate</label>
                                <select id="editPayRate" class="form-control">
                                    ${window.assignmentData.payRates.map(rate => {
                                        const label = `${rate.category} ${rate.level}${rate.pay_point ? ' ' + rate.pay_point : ''} - $${rate.hourly_pay_rate.toFixed(2)}/hr`;
                                        const selected = rate.id === assignment.pay_rate_id ? 'selected' : '';
                                        const isStaffDefault = staff?.pay_rate_id === rate.id;
                                        const displayLabel = isStaffDefault ? `${label} (Staff Default)` : label;
                                        return `<option value="${rate.id}" ${selected}>${displayLabel}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="removeAssignment('${staffId}', '${participantId}')">
                                <i class="fas fa-trash"></i> Remove Assignment
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal('editAssignmentModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="updateAssignment('${staffId}', '${participantId}')">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal and backdrop if present
        const existingModal = document.getElementById('editAssignmentModal');
        const existingBackdrop = document.getElementById('editAssignmentBackdrop');
        if (existingModal) existingModal.remove();
        if (existingBackdrop) existingBackdrop.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Error showing edit modal:', error);
        showNotification('Failed to open edit dialog', 'error');
    }
}
// Show add assignment modal
async function showAddAssignmentModal(type, id) {
    const isParticipantView = type === 'participant';
    const fixedPerson = isParticipantView ? 
        window.assignmentData.participantMap.get(id) : 
        window.assignmentData.staffMap.get(id);
    
    // Add backdrop and modal with proper positioning
    const modalHtml = `
        <div class="modal-backdrop" id="addAssignmentBackdrop" onclick="closeModal('addAssignmentModal')" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        "></div>
        <div class="modal" id="addAssignmentModal" style="
            display: block;
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 9999 !important;
            max-width: 500px;
            width: 90%;
        ">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5>Add Assignment</h5>
                        <button class="close" onclick="closeModal('addAssignmentModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <strong>${isParticipantView ? 'Participant' : 'Staff'}:</strong> 
                            ${fixedPerson.first_name} ${fixedPerson.last_name}
                        </div>
                        
                        <div class="form-group">
                            <label>${isParticipantView ? 'Select Staff Member' : 'Select Participant'} *</label>
                            <select id="addAssignmentPerson" class="form-control" required>
                                <option value="">Choose...</option>
                                ${isParticipantView ? 
                                    window.assignmentData.staff.map(s => 
                                        `<option value="${s.id}">${s.first_name} ${s.last_name} (${s.staff_code || 'N/A'})</option>`
                                    ).join('') :
                                    window.assignmentData.participants.map(p => 
                                    `<option value="${p.id}">${p.first_name} ${p.last_name} (${p.ndis_participant_number || 'N/A'})</option>`
                                    ).join('')
                                }
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Pay Rate *</label>
                            <select id="addAssignmentPayRate" class="form-control" required>
                                <option value="">Select Pay Rate...</option>
                                ${window.assignmentData.payRates.map(rate => {
                                    const label = `${rate.category} ${rate.level}${rate.pay_point ? ' ' + rate.pay_point : ''} - $${rate.hourly_pay_rate.toFixed(2)}/hr`;
                                    return `<option value="${rate.id}">${label}</option>`;
                                }).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal('addAssignmentModal')">Cancel</button>
                        <button class="btn btn-primary" onclick="saveNewAssignment('${type}', '${id}')">
                            Create Assignment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal and backdrop if present
    const existingModal = document.getElementById('addAssignmentModal');
    const existingBackdrop = document.getElementById('addAssignmentBackdrop');
    if (existingModal) existingModal.remove();
    if (existingBackdrop) existingBackdrop.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}
// Save new assignment
async function saveNewAssignment(type, fixedId) {
    try {
        const personId = document.getElementById('addAssignmentPerson').value;
        const payRateId = document.getElementById('addAssignmentPayRate').value;
        
        if (!personId || !payRateId) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }
        
        const assignmentData = {
            staff_id: type === 'participant' ? personId : fixedId,
            participant_id: type === 'participant' ? fixedId : personId,
            pay_rate_id: payRateId,
            created_at: new Date().toISOString()
        };
        
        const { error } = await supabaseClient
            .from('staff_participant_assignments')
            .insert(assignmentData);
        
        if (error) throw error;
        
        showNotification('Assignment created successfully', 'success');
        closeModal('addAssignmentModal');
        await initAssignmentManager();
        
    } catch (error) {
        console.error('Error creating assignment:', error);
        if (error.message?.includes('duplicate')) {
            showNotification('This assignment already exists', 'error');
        } else {
            showNotification('Failed to create assignment', 'error');
        }
    }
}

// Update assignment
async function updateAssignment(staffId, participantId) {
    try {
        const payRateId = document.getElementById('editPayRate').value;
        
        const { error } = await supabaseClient
            .from('staff_participant_assignments')
            .update({
                pay_rate_id: payRateId,
                updated_at: new Date().toISOString()
            })
            .eq('staff_id', staffId)
            .eq('participant_id', participantId);
        
        if (error) throw error;
        
        showNotification('Assignment updated successfully', 'success');
        closeModal('editAssignmentModal');
        await initAssignmentManager();
        
    } catch (error) {
        console.error('Error updating assignment:', error);
        showNotification('Failed to update assignment', 'error');
    }
}

// Remove assignment
async function removeAssignment(staffId, participantId) {
    if (!confirm('Are you sure you want to remove this assignment? This action cannot be undone.')) {
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('staff_participant_assignments')
            .delete()
            .eq('staff_id', staffId)
            .eq('participant_id', participantId);
        
        if (error) throw error;
        
        showNotification('Assignment removed successfully', 'success');
        closeModal('editAssignmentModal');
        await initAssignmentManager();
        
    } catch (error) {
        console.error('Error removing assignment:', error);
        showNotification('Failed to remove assignment', 'error');
    }
}

// Helper function to format dates
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-AU', { 
        day: '2-digit', 
        month: 'short', 
        year: 'numeric' 
    });
}

async function displayShiftsWithAssignments(weekStart, weekEnd) {
    try {
        // Load shifts with all related data including assignments
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                staff:staff_id(
                    id, 
                    first_name, 
                    last_name, 
                    pay_rate_id
                ),
                participant:participant_id(
                    id, 
                    first_name, 
                    last_name
                ),
                location:location_id(name),
                duty_type:duty_type_id(name)
            `)
            .gte('date', weekStart)
            .lte('date', weekEnd)
            .eq('status', 'approved')
            .order('date, start_time');
        
        if (error) throw error;
        
        // Load all assignments for these staff/participant pairs
        const staffIds = [...new Set(shifts.map(s => s.staff_id).filter(Boolean))];
        const participantIds = [...new Set(shifts.map(s => s.participant_id).filter(Boolean))];
        
        const { data: assignments } = await supabaseClient
            .from('staff_participant_assignments')
            .select(`
                *,
                pay_rate:pay_rate_id(
                    id,
                    category,
                    level,
                    pay_point,
                    hourly_pay_rate,
                    saturday,
                    sunday,
                    public_holiday,
                    sleepover
                )
            `)
            .in('staff_id', staffIds)
            .in('participant_id', participantIds);
        
        // Load pay rates for staff defaults
        const { data: payRates } = await supabaseClient
            .from('pay_rates')
            .select('*');
        
        // Create lookup maps
        const assignmentMap = new Map();
        assignments?.forEach(a => {
            const key = `${a.staff_id}-${a.participant_id}`;
            assignmentMap.set(key, a);
        });
        
        const payRateMap = new Map();
        payRates?.forEach(pr => {
            const label = `${pr.category} ${pr.level}${pr.pay_point ? ' ' + pr.pay_point : ''}`;
            payRateMap.set(pr.id, {
                ...pr,
                label: label,
                abbreviation: getPayRateAbbreviation(label)
            });
        });
        
        // Build shift display with pay rate badges
        let html = '<div class="shifts-with-rates">';
        
        const shiftsByDate = {};
        shifts.forEach(shift => {
            if (!shiftsByDate[shift.date]) {
                shiftsByDate[shift.date] = [];
            }
            
            // Determine which pay rate applies
            const assignmentKey = `${shift.staff_id}-${shift.participant_id}`;
            const assignment = assignmentMap.get(assignmentKey);
            
            let payRate = null;
            let rateSource = 'default';
            let rateLabel = '';
            let rateAbbrev = '';
            
            if (shift.pay_override_id) {
                // Manual override takes precedence
                payRate = payRateMap.get(shift.pay_override_id);
                rateSource = 'override';
                rateLabel = payRate?.label || 'Override';
                rateAbbrev = payRate?.abbreviation || 'OVR';
            } else if (assignment?.pay_rate_id) {
                // Assignment rate
                payRate = payRateMap.get(assignment.pay_rate_id);
                rateSource = 'assignment';
                rateLabel = payRate?.label || 'Assigned';
                rateAbbrev = payRate?.abbreviation || 'ASG';
            } else if (shift.staff?.pay_rate_id) {
                // Staff default rate
                payRate = payRateMap.get(shift.staff.pay_rate_id);
                rateSource = 'default';
                rateLabel = payRate?.label || 'Default';
                rateAbbrev = payRate?.abbreviation || 'DFT';
            }
            
            // Check for special rates (public holiday, sleepover)
            const isPublicHoliday = false; // TODO: Check against public_holidays table
            const isSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover');
            
            if (isPublicHoliday) {
                rateAbbrev = 'PH';
                rateSource = 'public_holiday';
            } else if (isSleepover) {
                rateAbbrev = 'SLP';
                rateSource = 'sleepover';
            }
            
            shiftsByDate[shift.date].push({
                ...shift,
                payRate,
                rateSource,
                rateLabel,
                rateAbbrev
            });
        });
        
        // Display shifts grouped by date
        Object.keys(shiftsByDate).sort().forEach(date => {
            const dayShifts = shiftsByDate[date];
            const dateObj = new Date(date + 'T00:00:00');
            const dayName = dateObj.toLocaleDateString('en-AU', { weekday: 'long' });
            const dateStr = dateObj.toLocaleDateString('en-AU', { 
                day: 'numeric', 
                month: 'short' 
            });
            
            html += `
                <div class="shift-day">
                    <div class="shift-day-header">
                        <h4>${dayName}, ${dateStr}</h4>
                        <span class="shift-count">${dayShifts.length} shifts</span>
                    </div>
                    <div class="shift-day-content">
            `;
            
            dayShifts.forEach(shift => {
                const startTime = shift.start_time ? 
                    formatTime12Hour(shift.start_time) : 'Sleepover';
                const endTime = shift.end_time ? 
                    formatTime12Hour(shift.end_time) : '';
                
                // Determine badge color based on rate source
                let badgeClass = 'participant-badge';
                if (shift.rateSource === 'override') {
                    badgeClass += ' badge-override';
                } else if (shift.rateSource === 'assignment') {
                    badgeClass += ' badge-assignment';
                } else if (shift.rateSource === 'public_holiday') {
                    badgeClass += ' badge-holiday';
                } else if (shift.rateSource === 'sleepover') {
                    badgeClass += ' badge-sleepover';
                } else {
                    badgeClass += ' badge-default';
                }
                
                html += `
                    <div class="shift-card" data-shift-id="${shift.id}">
                        <div class="shift-header">
                            <div class="shift-time-block">
                                <span class="shift-time">${startTime}</span>
                                ${endTime ? `<span class="shift-time-separator">-</span>
                                <span class="shift-time">${endTime}</span>` : ''}
                            </div>
                            <div class="shift-badges">
                                <span class="${badgeClass}" 
                                      title="${shift.rateLabel} - $${shift.payRate?.hourly_pay_rate?.toFixed(2) || '0.00'}/hr">
                                    ${shift.rateAbbrev}
                                </span>
                                ${shift.adjustment_status === 'requested' ? 
                                    '<span class="badge badge-warning">ADJ</span>' : ''}
                                ${shift.transfer_status === 'requested' ? 
                                    '<span class="badge badge-info">TRF</span>' : ''}
                            </div>
                        </div>
                        <div class="shift-body">
                            <div class="shift-staff">
                                <i class="fas fa-user"></i>
                                ${shift.staff?.first_name || 'Unassigned'} ${shift.staff?.last_name || ''}
                            </div>
                            <div class="shift-participant">
                                <i class="fas fa-user-friends"></i>
                                ${shift.participant?.first_name || ''} ${shift.participant?.last_name || ''}
                            </div>
                            <div class="shift-location">
                                <i class="fas fa-location-dot"></i>
                                ${shift.location?.name || 'Client Home'}
                            </div>
                        </div>
                        <div class="shift-actions">
                            <button class="btn btn-sm btn-secondary" 
                                    onclick="editShiftRate(${shift.id})">
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" 
                                    onclick="viewShiftDetails(${shift.id})">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        // Add summary section
        html += generateRateSummary(shifts, assignmentMap, payRateMap);
        
        return html;
        
    } catch (error) {
        console.error('Error displaying shifts with assignments:', error);
        return '<div class="alert alert-danger">Failed to load shifts</div>';
    }
}


// Generate summary of rates being used
function generateRateSummary(shifts, assignmentMap, payRateMap) {
    const rateSummary = new Map();
    
    shifts.forEach(shift => {
        const assignmentKey = `${shift.staff_id}-${shift.participant_id}`;
        const assignment = assignmentMap.get(assignmentKey);
        
        let rateId = shift.pay_override_id || 
                    assignment?.pay_rate_id || 
                    shift.staff?.pay_rate_id;
        
        if (rateId) {
            const rate = payRateMap.get(rateId);
            if (rate) {
                if (!rateSummary.has(rateId)) {
                    rateSummary.set(rateId, {
                        rate: rate,
                        count: 0,
                        hours: 0
                    });
                }
                
                const summary = rateSummary.get(rateId);
                summary.count++;
                
                // Calculate hours
                if (shift.start_time && shift.end_time) {
                    const start = new Date(`2000-01-01T${shift.start_time}`);
                    const end = new Date(`2000-01-01T${shift.end_time}`);
                    let hours = (end - start) / (1000 * 60 * 60);
                    if (hours < 0) hours += 24; // Handle overnight shifts
                    summary.hours += hours;
                }
            }
        }
    });
    
    let html = `
        <div class="rate-summary">
            <h4>Pay Rate Summary</h4>
            <div class="rate-summary-grid">
    `;
    
    rateSummary.forEach((summary, rateId) => {
        html += `
            <div class="rate-summary-item">
                <div class="rate-summary-header">
                    <span class="participant-badge">${summary.rate.abbreviation}</span>
                    <span class="rate-label">${summary.rate.label}</span>
                </div>
                <div class="rate-summary-details">
                    <div>Shifts: ${summary.count}</div>
                    <div>Hours: ${summary.hours.toFixed(1)}</div>
                    <div>Rate: $${summary.rate.hourly_pay_rate.toFixed(2)}/hr</div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

// Edit shift rate override
async function editShiftRate(shiftId) {
    try {
        // Get shift details
        const { data: shift } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                staff:staff_id(first_name, last_name, pay_rate_id),
                participant:participant_id(first_name, last_name)
            `)
            .eq('id', shiftId)
            .single();
        
        // Get assignment if exists
        const { data: assignment } = await supabaseClient
            .from('staff_participant_assignments')
            .select('*, pay_rate:pay_rate_id(*)')
            .eq('staff_id', shift.staff_id)
            .eq('participant_id', shift.participant_id)
            .single();
        
        // Get all pay rates
        const { data: payRates } = await supabaseClient
            .from('pay_rates')
            .select('*')
            .order('category, level, pay_point');
        
        const modal = `
            <div class="modal" id="editShiftRateModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5>Edit Shift Pay Rate</h5>
                            <button class="close" onclick="closeModal('editShiftRateModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <strong>Shift:</strong> ${formatDate(shift.date)}<br>
                                <strong>Staff:</strong> ${shift.staff.first_name} ${shift.staff.last_name}<br>
                                <strong>Participant:</strong> ${shift.participant.first_name} ${shift.participant.last_name}
                            </div>
                            
                            <div class="form-group">
                                <label>Pay Rate Selection</label>
                                <select id="shiftPayOverride" class="form-control">
                                    <option value="">Use Assignment Rate (${assignment ? 
                                        assignment.pay_rate.category + ' ' + assignment.pay_rate.level : 
                                        'Use Staff Default'})</option>
                                    ${payRates.map(rate => {
                                        const label = `${rate.category} ${rate.level}${rate.pay_point ? ' ' + rate.pay_point : ''} - $${rate.hourly_pay_rate.toFixed(2)}/hr`;
                                        const selected = shift.pay_override_id === rate.id ? 'selected' : '';
                                        return `<option value="${rate.id}" ${selected}>${label}</option>`;
                                    }).join('')}
                                </select>
                                <small class="form-text text-muted">
                                    Override only for this specific shift
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('editShiftRateModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="updateShiftRate(${shiftId})">Update Rate</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
        document.getElementById('editShiftRateModal').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading shift:', error);
        showNotification('Failed to load shift details', 'error');
    }
}

// Update shift rate
async function updateShiftRate(shiftId) {
    try {
        const payOverrideId = document.getElementById('shiftPayOverride').value;
        
        const { error } = await supabaseClient
            .from('shifts')
            .update({
                pay_override_id: payOverrideId || null,
                updated_at: new Date().toISOString()
            })
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showNotification('Shift rate updated successfully', 'success');
        closeModal('editShiftRateModal');
        
        // Refresh display
        await loadCurrentView();
        
    } catch (error) {
        console.error('Error updating shift rate:', error);
        showNotification('Failed to update shift rate', 'error');
    }
}

async function enrichRequestData(requests, type) {
    if (!requests || requests.length === 0) return [];
    
    return await Promise.all(requests.map(async req => {
        const shift = shifts.find(s => s.id === req.shift_id);
        const participant = shift ? participants.find(p => p.id === shift.participant_id) : null;
        const location = shift ? locations.find(l => l.id === shift.location_id) : null;
        
        const baseEnrichment = {
            ...req,
            shift: shift ? {
                ...shift,
                participant,
                location,
                participantName: participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    (location?.name || 'Unassigned')
            } : null
        };
        
        if (type === 'transfer') {
            return {
                ...baseEnrichment,
                fromStaff: staff.find(s => s.id === req.from_staff_id),
                toStaff: req.to_staff_id ? staff.find(s => s.id === req.to_staff_id) : null
            };
        } else if (type === 'adjustment') {
            return {
                ...baseEnrichment,
                staff: staff.find(s => s.id === req.staff_id)
            };
        }
        
        return baseEnrichment;
    }));
}

async function requestTransfer(shiftId) {
    const { data, error } = await supabaseClient
        .from('transfer_requests')
        .insert({
            shift_id: parseInt(shiftId), // CRITICAL: Convert to INTEGER
            from_staff_id: currentStaff.id,
            to_staff_id: null,
            status: 'pending',
            reason: 'Personal reason',
            created_at: new Date().toISOString() // Add required field
        });
    
    if (error) {
        console.error('Transfer request error:', error);
        if (error.code === DB_ERRORS.FOREIGN_KEY_VIOLATION) {
            showToast('Invalid shift reference', 'error');
        } else {
            showToast('Failed to request transfer', 'error');
        }
    } else {
        showToast('Transfer request submitted', 'success');
    }
}

async function refreshAfterChange() {
    await loadShifts(); // Reload base data
    
    // Refresh the current active view
    if (currentView === 'conflicts') {
        await renderConflicts();
    } else if (currentView === 'requests') {
        await renderRequests();
    } else if (currentView === 'timesheet') {
        await renderTimesheet();
    } else if (currentView === 'notes') {
        await renderNotes();
    } else if (currentView === 'summary') {
        await renderSummary();
    } else if (currentView === 'table') {
        renderTable();
    } else {
        renderCurrentView();
    }
}

async function renderRequests() {
    const requestsContent = document.getElementById('requestsContent');
    if (!requestsContent) return;
    
    try {
        // Show loading state
        requestsContent.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading requests...</span>
            </div>
        `;
        
        const isManager = currentUserRole === 'admin' || currentUserRole === 'manager';
        
        // Build the filter UI and container
        let html = `
            <style>
                /* Filter Container Styles */
                .requests-filter-container {
                    display: flex;
                    gap: 20px;
                    align-items: center;
                    padding: 20px;
                    background: white;
                    border-radius: 10px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    margin-bottom: 20px;
                    flex-wrap: wrap;
                }
                
                .filter-group {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .filter-label {
                    font-weight: 600;
                    color: #333;
                    font-size: 14px;
                }
                
                .filter-select {
                    padding: 8px 12px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    background: white;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    min-width: 150px;
                }
                
                .filter-select:hover {
                    border-color: #667eea;
                }
                
                .filter-select:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                }
                
                .status-tabs {
                    display: flex;
                    gap: 5px;
                    background: #f5f5f5;
                    padding: 4px;
                    border-radius: 8px;
                }
                
                .status-tab {
                    padding: 8px 16px;
                    border: none;
                    background: transparent;
                    color: #666;
                    font-weight: 500;
                    cursor: pointer;
                    border-radius: 6px;
                    transition: all 0.3s ease;
                    font-size: 14px;
                }
                
                .status-tab:hover {
                    background: white;
                    color: #333;
                }
                
                .status-tab.active {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
                }
                
                /* Summary Stats */
                .requests-summary {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 15px;
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 10px;
                    margin-bottom: 20px;
                }
                
                .summary-item {
                    text-align: center;
                    padding: 15px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                
                .summary-label {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 5px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .summary-value {
                    font-size: 24px;
                    font-weight: bold;
                    color: #333;
                }
                
                /* Loading spinner for buttons */
                .btn-loading {
                    position: relative;
                    color: transparent !important;
                    pointer-events: none;
                }
                
                .btn-loading::after {
                    content: '';
                    position: absolute;
                    width: 16px;
                    height: 16px;
                    top: 50%;
                    left: 50%;
                    margin-left: -8px;
                    margin-top: -8px;
                    border: 2px solid #ffffff;
                    border-radius: 50%;
                    border-top-color: transparent;
                    animation: spinner 0.6s linear infinite;
                }
                
                @keyframes spinner {
                    to { transform: rotate(360deg); }
                }
                
                /* Table Styles */
                .request-table {
                    width: 100%;
                    background: white;
                    border-radius: 10px;
                    overflow: hidden;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                
                .request-table thead {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                }
                
                .request-table th {
                    padding: 15px;
                    text-align: left;
                    color: white;
                    font-weight: 600;
                    font-size: 12px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .request-table td {
                    padding: 15px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .request-table tbody tr:hover {
                    background: #f8f9fa;
                }
                
                .request-table tbody tr:last-child td {
                    border-bottom: none;
                }
                
                /* Badge Styles */
                .badge {
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 11px;
                    font-weight: 600;
                    text-transform: uppercase;
                }
                
                .badge-pending {
                    background: #fff3cd;
                    color: #856404;
                }
                
                .badge-approved {
                    background: #d4edda;
                    color: #155724;
                }
                
                .badge-rejected, .badge-denied {
                    background: #f8d7da;
                    color: #721c24;
                }
                
                /* Action Buttons */
                .action-buttons {
                    display: flex;
                    gap: 5px;
                    justify-content: center;
                }
                
                .btn-sm {
                    padding: 6px 10px;
                    font-size: 12px;
                    border-radius: 4px;
                    border: none;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 5px;
                }
                
                .btn-success {
                    background: #28a745;
                    color: white;
                }
                
                .btn-success:hover {
                    background: #218838;
                }
                
                .btn-danger {
                    background: #dc3545;
                    color: white;
                }
                
                .btn-danger:hover {
                    background: #c82333;
                }
                
                .btn-primary {
                    background: #667eea;
                    color: white;
                }
                
                .btn-primary:hover {
                    background: #5a67d8;
                }
            </style>
            
            <!-- Filter Controls -->
            <div class="requests-filter-container">
    <div class="filter-group">
        <span class="filter-label">Request Type:</span>
        <select class="filter-select" id="requestTypeFilter" onchange="changeRequestType(this.value)">
            <option value="transport_claims">Transport Claims</option>
            <option value="school_holidays">School Holidays</option>
            <option value="leave_requests">Leave Requests</option>
            <option value="shifts">Shift Approvals</option>
            <option value="shift_adjustments">Shift Adjustments</option>
        </select>
    </div>
    
    <div class="filter-group">
        <span class="filter-label">Status:</span>
        <div class="status-tabs">
            <button class="status-tab ${currentRequestStatus === 'pending' ? 'active' : ''}" 
                    onclick="changeRequestStatus('pending')">
                Pending
            </button>
            <button class="status-tab ${currentRequestStatus === 'approved' ? 'active' : ''}" 
                    onclick="changeRequestStatus('approved')">
                Approved
            </button>
            <button class="status-tab ${currentRequestStatus === 'all' ? 'active' : ''}" 
                    onclick="changeRequestStatus('all')">
                All
            </button>
        </div>
    </div>
    
    <div class="filter-group" style="margin-left: auto;">
        <span class="filter-label">View By:</span>
        <button class="btn-sm" 
                onclick="switchRequestView('staff')"
                style="margin-right: 8px; padding: 8px 16px; border-radius: 6px; background: ${requestViewMode === 'staff' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#6c757d'}; color: white; border: none; cursor: pointer;">
            <i class="fas fa-user-tie"></i> Staff
        </button>
        <button class="btn-sm" 
                onclick="switchRequestView('participant')"
                style="padding: 8px 16px; border-radius: 6px; background: ${requestViewMode === 'participant' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#6c757d'}; color: white; border: none; cursor: pointer;">
            <i class="fas fa-users"></i> Participant
        </button>
    </div>
</div>
            
            <!-- Dynamic Content Area -->
            <div id="requestsTableContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading data...</span>
                </div>
            </div>
        `;
        
        requestsContent.innerHTML = html;
        
        // Load the appropriate data based on current filters
        await loadRequestData();
        
    } catch (error) {
        console.error('Error rendering requests:', error);
        requestsContent.innerHTML = `
            <div class="alert alert-danger">
                Failed to load requests: ${error.message}
            </div>
        `;
    }
}

// Switch between staff and participant view
function switchRequestView(mode) {
    requestViewMode = mode;
    loadRequestData(); // Reload with new view
}
// Load data based on current filters
async function loadRequestData() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Loading ${currentRequestType.replace('_', ' ')}...</span>
        </div>
    `;
    
    try {
        switch(currentRequestType) {
            case 'transport_claims':
                await loadTransportClaims();
                break;
            case 'school_holidays':
                await loadSchoolHolidays();
                break;
            case 'leave_requests':
                await loadLeaveRequests();
                break;
            case 'shifts':
                await loadShiftApprovals();
                break;
            case 'shift_adjustments':
                await loadShiftAdjustments();
                break;
            default:
                container.innerHTML = '<p>Please select a request type</p>';
        }
    } catch (error) {
        console.error('Error loading request data:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                Failed to load ${currentRequestType.replace('_', ' ')}: ${error.message}
            </div>
        `;
    }
}

// Filter change handlers
function changeRequestType(type) {
    currentRequestType = type;
    loadRequestData();
}

function changeRequestStatus(status) {
    currentRequestStatus = status;
    // Update active tab
    document.querySelectorAll('.status-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.trim().toLowerCase() === status) {
            tab.classList.add('active');
        }
    });
    loadRequestData();
}

async function loadTransportClaims() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        let query = supabaseClient
            .from('transport_claims')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                ),
                shift:shift_id(
                    date,
                    participant_id,
                    participants(first_name, last_name)
                )
            `)
            .order('date', { ascending: false });
        
        if (currentRequestStatus !== 'all') {
            query = query.eq('status', currentRequestStatus);
        }
        
        const { data: claims, error } = await query;
        if (error) throw error;
        
        const stats = {
            total: claims.length,
            pending: claims.filter(c => c.status === 'pending').length,
            approved: claims.filter(c => c.status === 'approved').length,
            rejected: claims.filter(c => c.status === 'rejected').length,
            totalAmount: claims.reduce((sum, c) => sum + (c.total_claim || 0), 0),
            totalKm: claims.reduce((sum, c) => sum + (c.kilometres || 0), 0)
        };
        
        let html = `
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Pending</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.pending}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Approved</div>
                    <div class="summary-value" style="color: #28a745;">${stats.approved}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Amount</div>
                    <div class="summary-value" style="color: #4CAF50;">$${stats.totalAmount.toFixed(2)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total KM</div>
                    <div class="summary-value">${stats.totalKm.toFixed(0)} km</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            // GROUP BY PARTICIPANT
            const groupedByParticipant = {};
            
            claims.forEach(claim => {
                const participantId = claim.shift?.participant_id || 'unassigned';
                if (!groupedByParticipant[participantId]) {
                    groupedByParticipant[participantId] = {
                        participant: claim.shift?.participants,
                        claims: []
                    };
                }
                groupedByParticipant[participantId].claims.push(claim);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByParticipant).forEach(([participantId, group]) => {
                const participant = group.participant;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                const groupTotal = group.claims.reduce((sum, c) => sum + (c.total_claim || 0), 0);
                const groupKm = group.claims.reduce((sum, c) => sum + (c.kilometres || 0), 0);
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user"></i> ${participantName}
                            </span>
                            <span style="font-size: 14px;">
                                ${group.claims.length} claims ‚Ä¢ $${groupTotal.toFixed(2)} ‚Ä¢ ${groupKm.toFixed(0)}km
                            </span>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Date</th>
                                    <th style="padding: 12px;">Staff</th>
                                    <th style="padding: 12px;">KM</th>
                                    <th style="padding: 12px;">Amount</th>
                                    <th style="padding: 12px;">Evidence</th>
                                    <th style="padding: 12px;">Status</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.claims.map(claim => {
                                    const staff = claim.staff;
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px;">${formatDateShort(claim.date)}</td>
                                            <td style="padding: 12px;">
                                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unknown'}
                                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                                            </td>
                                            <td style="padding: 12px;">${claim.kilometres || 0} km</td>
                                            <td style="padding: 12px; color: #4CAF50; font-weight: 600;">$${(claim.total_claim || 0).toFixed(2)}</td>
                                            <td style="padding: 12px;">
                                                ${claim.evidence_url ? 
                                                    `<a href="${claim.evidence_url}" target="_blank" class="btn-sm btn-primary">
                                                        <i class="fas fa-paperclip"></i> View
                                                    </a>` : 
                                                    '<span style="color: #999;">None</span>'}
                                            </td>
                                            <td style="padding: 12px;">
                                                <span class="badge badge-${claim.status}">${claim.status || 'submitted'}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    ${claim.status === 'pending' || !claim.status ? `
                                                        <button class="btn-sm btn-success" onclick="approveTransportClaim('${claim.id}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn-sm btn-danger" onclick="rejectTransportClaim('${claim.id}')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    ` : `
                                                        <span style="color: #999; font-size: 11px;">
                                                            ${claim.status === 'approved' ? 'Approved' : 'Rejected'}
                                                        </span>
                                                    `}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
            
        } else {
            // STAFF VIEW (Table)
            html += `
                <table class="request-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Staff</th>
                            <th>Participant</th>
                            <th>KM</th>
                            <th>Amount</th>
                            <th>Evidence</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (claims.length === 0) {
                html += `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            No ${currentRequestStatus === 'all' ? '' : currentRequestStatus} transport claims found
                        </td>
                    </tr>
                `;
            } else {
                claims.forEach(claim => {
                    const staff = claim.staff;
                    const participant = claim.shift?.participants;
                    
                    html += `
                        <tr>
                            <td>${formatDateShort(claim.date)}</td>
                            <td>
                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unknown'}
                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                            </td>
                            <td>${participant ? `${participant.first_name} ${participant.last_name}` : 'N/A'}</td>
                            <td>${claim.kilometres || 0} km</td>
                            <td style="color: #4CAF50; font-weight: 600;">$${(claim.total_claim || 0).toFixed(2)}</td>
                            <td>
                                ${claim.evidence_url ? 
                                    `<a href="${claim.evidence_url}" target="_blank" class="btn-sm btn-primary">
                                        <i class="fas fa-paperclip"></i> View
                                    </a>` : 
                                    '<span style="color: #999;">None</span>'}
                            </td>
                            <td>
                                <span class="badge badge-${claim.status || 'pending'}">${claim.status || 'submitted'}</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${claim.status === 'pending' || !claim.status ? `
                                        <button class="btn-sm btn-success" onclick="approveTransportClaim('${claim.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-sm btn-danger" onclick="rejectTransportClaim('${claim.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : `
                                        <span style="color: #999; font-size: 11px;">
                                            ${claim.status === 'approved' ? 'Approved' : 'Rejected'}
                                        </span>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading transport claims:', error);
        container.innerHTML = `<div class="alert alert-danger">Failed to load transport claims: ${error.message}</div>`;
    }
}
async function loadLeaveRequests() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        let query = supabaseClient
            .from('leave_requests')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                )
            `)
            .order('created_at', { ascending: false });
        
        if (currentRequestStatus !== 'all') {
            query = query.eq('status', currentRequestStatus);
        }
        
        const { data: leaves, error } = await query;
        if (error) throw error;
        
        const stats = {
            total: leaves.length,
            pending: leaves.filter(l => l.status === 'pending').length,
            approved: leaves.filter(l => l.status === 'approved').length,
            rejected: leaves.filter(l => l.status === 'rejected').length
        };
        
        let html = `
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Pending</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.pending}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Approved</div>
                    <div class="summary-value" style="color: #28a745;">${stats.approved}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Rejected</div>
                    <div class="summary-value" style="color: #dc3545;">${stats.rejected}</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            html += `
                <div style="padding: 40px; text-align: center; color: #666;">
                    <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p>Leave requests are staff-only. Switch to Staff view to see requests.</p>
                </div>
            `;
        } else {
            // GROUP BY STAFF
            const groupedByStaff = {};
            
            leaves.forEach(leave => {
                const staffId = leave.staff_id || 'unassigned';
                if (!groupedByStaff[staffId]) {
                    groupedByStaff[staffId] = {
                        staff: leave.staff,
                        leaves: []
                    };
                }
                groupedByStaff[staffId].leaves.push(leave);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByStaff).forEach(([staffId, group]) => {
                const staff = group.staff;
                const staffName = staff ? 
                    `${staff.first_name} ${staff.last_name}` : 
                    'Unknown';
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user-tie"></i> ${staffName}
                                ${staff?.staff_code ? `<span style="margin-left: 8px; opacity: 0.8; font-size: 13px;">${staff.staff_code}</span>` : ''}
                            </span>
                            <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${group.leaves.length} requests
                            </span>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Leave Type</th>
                                    <th style="padding: 12px;">Start Date</th>
                                    <th style="padding: 12px;">End Date</th>
                                    <th style="padding: 12px;">Reason</th>
                                    <th style="padding: 12px;">Status</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.leaves.map(leave => {
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px; font-weight: 600;">${leave.leave_type || 'Leave'}</td>
                                            <td style="padding: 12px;">${formatDateShort(leave.start_date)}</td>
                                            <td style="padding: 12px;">${formatDateShort(leave.end_date)}</td>
                                            <td style="padding: 12px;"><small>${leave.reason || '-'}</small></td>
                                            <td style="padding: 12px;">
                                                <span class="badge badge-${leave.status}">${leave.status}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    ${leave.status === 'pending' ? `
                                                        <button class="btn-sm btn-success" onclick="approveLeave('${leave.id}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn-sm btn-danger" onclick="rejectLeave('${leave.id}')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    ` : `
                                                        <span style="color: #999; font-size: 11px;">
                                                            ${leave.status === 'approved' ? 'Approved' : 'Rejected'}
                                                        </span>
                                                    `}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading leave requests:', error);
        container.innerHTML = `<div class="alert alert-danger">Failed to load leave requests: ${error.message}</div>`;
    }
}

async function loadShiftApprovals() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        let query = supabaseClient
            .from('shifts')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                ),
                participants(first_name, last_name),
                duty_types(name),
                locations(name)
            `)
            .eq('status', 'pending')
            .order('date', { ascending: true });
        
        const { data: shifts, error } = await query;
        if (error) throw error;
        
        const stats = {
            total: shifts.length,
            today: shifts.filter(s => {
                const shiftDate = new Date(s.date);
                const today = new Date();
                return shiftDate.toDateString() === today.toDateString();
            }).length,
            upcoming: shifts.filter(s => new Date(s.date) > new Date()).length
        };
        
        let html = `
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total Pending</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Today</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.today}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Upcoming</div>
                    <div class="summary-value" style="color: #2196F3;">${stats.upcoming}</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            // GROUP BY PARTICIPANT
            const groupedByParticipant = {};
            
            shifts.forEach(shift => {
                const participantId = shift.participant_id || 'unassigned';
                if (!groupedByParticipant[participantId]) {
                    groupedByParticipant[participantId] = {
                        participant: shift.participants,
                        shifts: []
                    };
                }
                groupedByParticipant[participantId].shifts.push(shift);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByParticipant).forEach(([participantId, group]) => {
                const participant = group.participant;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                const shiftIds = group.shifts.map(s => s.id);
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user"></i> ${participantName}
                            </span>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${group.shifts.length} shifts
                                </span>
                                <button class="btn-sm" 
                                        style="background: #4CAF50; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;"
                                        onclick="approveAllShifts(${JSON.stringify(shiftIds).replace(/"/g, '&quot;')}, '${participantName}')">
                                    <i class="fas fa-check-double"></i> Approve All
                                </button>
                            </div>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Date</th>
                                    <th style="padding: 12px;">Time</th>
                                    <th style="padding: 12px;">Staff</th>
                                    <th style="padding: 12px;">Type</th>
                                    <th style="padding: 12px;">Location</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.shifts.map(shift => {
                                    const staff = shift.staff;
                                    const dutyType = shift.duty_types?.name || 'Regular';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px; font-weight: 600;">${formatDateShort(shift.date)}</td>
                                            <td style="padding: 12px;">
                                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'}
                                                ${shift.end_time ? ` - ${formatTime12Hour(shift.end_time)}` : ''}
                                            </td>
                                            <td style="padding: 12px;">
                                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unassigned'}
                                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                                            </td>
                                            <td style="padding: 12px;"><small>${dutyType}</small></td>
                                            <td style="padding: 12px;"><small>${shift.locations?.name || 'Client Home'}</small></td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    <button class="btn-sm btn-success" onclick="approveShift('${shift.id}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn-sm btn-danger" onclick="rejectShift('${shift.id}')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
            
        } else {
            // GROUP BY STAFF
            const groupedByStaff = {};
            
            shifts.forEach(shift => {
                const staffId = shift.staff_id || 'unassigned';
                if (!groupedByStaff[staffId]) {
                    groupedByStaff[staffId] = {
                        staff: shift.staff,
                        shifts: []
                    };
                }
                groupedByStaff[staffId].shifts.push(shift);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByStaff).forEach(([staffId, group]) => {
                const staff = group.staff;
                const staffName = staff ? 
                    `${staff.first_name} ${staff.last_name}` : 
                    'Unassigned';
                
                const shiftIds = group.shifts.map(s => s.id);
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user-tie"></i> ${staffName}
                                ${staff?.staff_code ? `<span style="margin-left: 8px; opacity: 0.8; font-size: 13px;">${staff.staff_code}</span>` : ''}
                            </span>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${group.shifts.length} shifts
                                </span>
                                <button class="btn-sm" 
                                        style="background: #4CAF50; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;"
                                        onclick="approveAllShifts(${JSON.stringify(shiftIds).replace(/"/g, '&quot;')}, '${staffName}')">
                                    <i class="fas fa-check-double"></i> Approve All
                                </button>
                            </div>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Date</th>
                                    <th style="padding: 12px;">Time</th>
                                    <th style="padding: 12px;">Participant</th>
                                    <th style="padding: 12px;">Type</th>
                                    <th style="padding: 12px;">Location</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.shifts.map(shift => {
                                    const participant = shift.participants;
                                    const dutyType = shift.duty_types?.name || 'Regular';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px; font-weight: 600;">${formatDateShort(shift.date)}</td>
                                            <td style="padding: 12px;">
                                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'}
                                                ${shift.end_time ? ` - ${formatTime12Hour(shift.end_time)}` : ''}
                                            </td>
                                            <td style="padding: 12px;">
                                                ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                                            </td>
                                            <td style="padding: 12px;"><small>${dutyType}</small></td>
                                            <td style="padding: 12px;"><small>${shift.locations?.name || 'Client Home'}</small></td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    <button class="btn-sm btn-success" onclick="approveShift('${shift.id}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn-sm btn-danger" onclick="rejectShift('${shift.id}')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading shift approvals:', error);
        container.innerHTML = `<div class="alert alert-danger">Failed to load shift approvals: ${error.message}</div>`;
    }
}

// Function to approve all shifts for a staff member or participant
async function approveAllShifts(shiftIds, name) {
    if (!confirm(`Are you sure you want to approve all ${shiftIds.length} shifts for ${name}?`)) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
    
    try {
        const { error } = await supabaseClient
            .from('shifts')
            .update({ status: 'approved' })
            .in('id', shiftIds);
        
        if (error) throw error;
        
        showToast(`Successfully approved ${shiftIds.length} shifts for ${name}`, 'success');
        loadShiftApprovals(); // Reload the list
        
    } catch (error) {
        console.error('Error approving shifts:', error);
        showToast(`Failed to approve shifts: ${error.message}`, 'error');
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}


async function loadShiftAdjustments() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        // Build query with status filter
        let query = supabaseClient
            .from('shift_adjustment_requests')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                ),
                shift:shift_id(
                    id,
                    date,
                    start_time,
                    end_time,
                    participant_id,
                    participants(first_name, last_name),
                    duty_types(name)
                )
            `)
            .order('created_at', { ascending: false });
        
        // Apply status filter
        if (currentRequestStatus !== 'all') {
            query = query.eq('status', currentRequestStatus);
        }
        
        const { data: adjustments, error } = await query;
        
        if (error) throw error;
        
        // Calculate summary stats
        const stats = {
            total: adjustments.length,
            pending: adjustments.filter(a => a.status === 'pending').length,
            approved: adjustments.filter(a => a.status === 'approved').length,
            rejected: adjustments.filter(a => a.status === 'rejected').length
        };
        
        // Build HTML based on view mode
        let html = `
            <!-- Summary Stats -->
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Pending</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.pending}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Approved</div>
                    <div class="summary-value" style="color: #28a745;">${stats.approved}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Rejected</div>
                    <div class="summary-value" style="color: #dc3545;">${stats.rejected}</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            // GROUP BY PARTICIPANT
            const groupedByParticipant = {};
            
            adjustments.forEach(adj => {
                const participantId = adj.shift?.participant_id || 'unassigned';
                if (!groupedByParticipant[participantId]) {
                    groupedByParticipant[participantId] = {
                        participant: adj.shift?.participants,
                        adjustments: []
                    };
                }
                groupedByParticipant[participantId].adjustments.push(adj);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByParticipant).forEach(([participantId, group], index) => {
                const participant = group.participant;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user"></i> ${participantName}
                            </span>
                            <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${group.adjustments.length} requests
                            </span>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px; text-align: left;">Date</th>
                                    <th style="padding: 12px;">Staff</th>
                                    <th style="padding: 12px;">Original Times</th>
                                    <th style="padding: 12px;">Requested Times</th>
                                    <th style="padding: 12px;">Reason</th>
                                    <th style="padding: 12px;">Status</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.adjustments.map(adj => {
                                    const shift = adj.shift;
                                    const staff = adj.staff;
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px;">${shift ? formatDateShort(shift.date) : 'N/A'}</td>
                                            <td style="padding: 12px;">
                                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unknown'}
                                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                                            </td>
                                            <td style="padding: 12px; font-size: 13px;">
                                                ${shift?.start_time ? formatTime12Hour(shift.start_time) : 'N/A'}<br>
                                                to<br>
                                                ${shift?.end_time ? formatTime12Hour(shift.end_time) : 'N/A'}
                                            </td>
                                            <td style="padding: 12px; color: #2196F3; font-weight: 600; font-size: 13px;">
                                                ${adj.new_start_time ? formatTime12Hour(adj.new_start_time) : 'N/A'}<br>
                                                to<br>
                                                ${adj.new_end_time ? formatTime12Hour(adj.new_end_time) : 'N/A'}
                                            </td>
                                            <td style="padding: 12px;"><small>${adj.reason || '-'}</small></td>
                                            <td style="padding: 12px;">
                                                <span class="badge badge-${adj.status}">${adj.status}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    ${adj.status === 'pending' ? `
                                                        <button class="btn-sm btn-success" onclick="approveAdjustment('${adj.id}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn-sm btn-danger" onclick="denyAdjustment('${adj.id}')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    ` : `
                                                        <span style="color: #999; font-size: 11px;">
                                                            ${adj.status === 'approved' ? 'Approved' : 'Rejected'}
                                                        </span>
                                                    `}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
            
        } else {
            // GROUP BY STAFF (original table view)
            html += `
                <!-- Adjustments Table -->
                <table class="request-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Staff</th>
                            <th>Participant</th>
                            <th>Original Times</th>
                            <th>Requested Times</th>
                            <th>Type</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (adjustments.length === 0) {
                html += `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                            No ${currentRequestStatus === 'all' ? '' : currentRequestStatus} adjustment requests found
                        </td>
                    </tr>
                `;
            } else {
                adjustments.forEach(adjustment => {
                    const shift = adjustment.shift;
                    const staff = adjustment.staff;
                    const participant = shift?.participants;
                    
                    html += `
                        <tr>
                            <td>${shift ? formatDateShort(shift.date) : 'N/A'}</td>
                            <td>
                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unknown'}
                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                            </td>
                            <td>${participant ? `${participant.first_name} ${participant.last_name}` : 'N/A'}</td>
                            <td>
                                ${shift?.start_time ? formatTime12Hour(shift.start_time) : 'N/A'}<br>
                                to<br>
                                ${shift?.end_time ? formatTime12Hour(shift.end_time) : 'N/A'}
                            </td>
                            <td style="color: #2196F3; font-weight: 600;">
                                ${adjustment.new_start_time ? formatTime12Hour(adjustment.new_start_time) : 'N/A'}<br>
                                to<br>
                                ${adjustment.new_end_time ? formatTime12Hour(adjustment.new_end_time) : 'N/A'}
                            </td>
                            <td>
                                <small>${adjustment.adjustment_type || 'Time Change'}</small>
                            </td>
                            <td>
                                <small>${adjustment.reason || '-'}</small>
                            </td>
                            <td>
                                <span class="badge badge-${adjustment.status}">
                                    ${adjustment.status}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${adjustment.status === 'pending' ? `
                                        <button class="btn-sm btn-success" 
                                                onclick="approveAdjustment('${adjustment.id}')"
                                                title="Approve Adjustment">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-sm btn-danger" 
                                                onclick="denyAdjustment('${adjustment.id}')"
                                                title="Deny Adjustment">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : `
                                        <span style="color: #999; font-size: 11px;">
                                            ${adjustment.status === 'approved' ? 'Approved' : 'Rejected'}
                                        </span>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading shift adjustments:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                Failed to load shift adjustments: ${error.message}
            </div>
        `;
    }
}

// Toggle accordion function
function toggleRequestAccordion(index) {
    const content = document.getElementById(`request-accordion-${index}`);
    const arrow = document.getElementById(`request-arrow-${index}`);
    
    if (content) {
        content.classList.toggle('active');
        if (arrow) {
            arrow.classList.toggle('open');
        }
    }
}
function setButtonLoading(buttonId, isLoading) {
    const button = document.getElementById(buttonId);
    if (!button) return;
    
    if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
    } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
    }
}

// Helper function to add loading to all buttons in a container
function setActionButtonsLoading(claimId, isLoading) {
    const approveBtn = document.getElementById(`approve-${claimId}`);
    const denyBtn = document.getElementById(`deny-${claimId}`);
    
    [approveBtn, denyBtn].forEach(btn => {
        if (btn) {
            if (isLoading) {
                btn.classList.add('btn-loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
    });
}

function getEvidenceUrl(evidencePath) {
    if (!evidencePath) return null;
    
    // If it's already a full URL, return it
    if (evidencePath.startsWith('http')) {
        return evidencePath;
    }
    
    // Otherwise, construct the storage URL
    const { data } = supabaseClient.storage
        .from('transport-evidence')
        .getPublicUrl(evidencePath);
    
    return data.publicUrl;
}

// Add CSS animation keyframes if not present
if (!document.querySelector('#notification-animations')) {
    const style = document.createElement('style');
    style.id = 'notification-animations';
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

async function approveTransportClaim(claimId) {
    try {
        const { error } = await supabaseClient
            .from('transport_claims')
            .update({ 
                status: 'approved',
                approved_at: new Date().toISOString()
            })
            .eq('id', claimId);
        
        if (error) throw error;
        
        showNotification('Transport claim approved', 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving transport claim:', error);
        showNotification('Failed to approve transport claim', 'error');
    }
}

async function rejectTransportClaim(claimId) {
    try {
        const { error } = await supabaseClient
            .from('transport_claims')
            .update({ 
                status: 'rejected',
                approved_at: new Date().toISOString()
            })
            .eq('id', claimId);
        
        if (error) throw error;
        
        showNotification('Transport claim rejected', 'info');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error rejecting transport claim:', error);
        showNotification('Failed to reject transport claim', 'error');
    }
}
// Approve all claims for a staff member
async function approveAllClaims(staffId) {
    if (isLoadingRequest) return;
    
    if (!confirm('Are you sure you want to approve all pending claims for this staff member?')) {
        return;
    }
    
    isLoadingRequest = true;
    
    // Show loading state in the UI
    const container = document.getElementById('requestsTableContainer');
    const originalContent = container.innerHTML;
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Approving all claims...</span>
        </div>
    `;
    
    try {
        if (!currentManagerStaff) {
            const user = await supabaseClient.auth.getUser();
            if (user?.data?.user) {
                const { data: staffData } = await supabaseClient
                    .from('staff')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .single();
                currentManagerStaff = staffData;
            }
        }
        
        const { data: claims, error: fetchError } = await supabaseClient
            .from('transport_claims')
            .select('id')
            .eq('staff_id', staffId)
            .eq('status', 'pending');
        
        if (fetchError) throw fetchError;
        
        if (!claims || claims.length === 0) {
            showNotification('No pending claims to approve', 'warning');
            container.innerHTML = originalContent;
            return;
        }
        
        const { error: updateError } = await supabaseClient
            .from('transport_claims')
            .update({ 
                status: 'approved',
                approved_by: currentManagerStaff?.id,
                approved_at: new Date().toISOString()
            })
            .in('id', claims.map(c => c.id));
        
        if (updateError) throw updateError;
        
        showNotification(`Approved ${claims.length} transport claims`, 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving claims:', error);
        showNotification('Failed to approve claims', 'error');
        container.innerHTML = originalContent;
    } finally {
        isLoadingRequest = false;
    }
}

// ========================================
// SCHOOL HOLIDAY FUNCTIONS
// ========================================

async function loadSchoolHolidays() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        let query = supabaseClient
            .from('school_holidays')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                )
            `)
            .order('created_at', { ascending: false });
        
        if (currentRequestStatus !== 'all') {
            query = query.eq('status', currentRequestStatus);
        }
        
        const { data: holidays, error } = await query;
        if (error) throw error;
        
        const stats = {
            total: holidays.length,
            pending: holidays.filter(h => h.status === 'pending').length,
            approved: holidays.filter(h => h.status === 'approved').length,
            rejected: holidays.filter(h => h.status === 'rejected').length
        };
        
        let html = `
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Pending</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.pending}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Approved</div>
                    <div class="summary-value" style="color: #28a745;">${stats.approved}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Rejected</div>
                    <div class="summary-value" style="color: #dc3545;">${stats.rejected}</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            html += `
                <div style="padding: 40px; text-align: center; color: #666;">
                    <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p>School holidays are staff-only. Switch to Staff view to see requests.</p>
                </div>
            `;
        } else {
            // GROUP BY STAFF
            const groupedByStaff = {};
            
            holidays.forEach(holiday => {
                const staffId = holiday.staff_id || 'unassigned';
                if (!groupedByStaff[staffId]) {
                    groupedByStaff[staffId] = {
                        staff: holiday.staff,
                        holidays: []
                    };
                }
                groupedByStaff[staffId].holidays.push(holiday);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByStaff).forEach(([staffId, group]) => {
                const staff = group.staff;
                const staffName = staff ? 
                    `${staff.first_name} ${staff.last_name}` : 
                    'Unknown';
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user-tie"></i> ${staffName}
                                ${staff?.staff_code ? `<span style="margin-left: 8px; opacity: 0.8; font-size: 13px;">${staff.staff_code}</span>` : ''}
                            </span>
                            <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${group.holidays.length} requests
                            </span>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Start Date</th>
                                    <th style="padding: 12px;">End Date</th>
                                    <th style="padding: 12px;">Duration</th>
                                    <th style="padding: 12px;">Submitted</th>
                                    <th style="padding: 12px;">Status</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.holidays.map(holiday => {
                                    const startDate = new Date(holiday.start_date);
                                    const endDate = new Date(holiday.end_date);
                                    const durationDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px; font-weight: 600;">${formatDateShort(holiday.start_date)}</td>
                                            <td style="padding: 12px; font-weight: 600;">${formatDateShort(holiday.end_date)}</td>
                                            <td style="padding: 12px;">
                                                <span class="badge" style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                    ${durationDays} day${durationDays !== 1 ? 's' : ''}
                                                </span>
                                            </td>
                                            <td style="padding: 12px;"><small>${new Date(holiday.created_at).toLocaleDateString('en-AU')}</small></td>
                                            <td style="padding: 12px;">
                                                <span class="badge badge-${holiday.status}">${holiday.status}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    ${holiday.status === 'pending' ? `
                                                        <button class="btn-sm btn-success" onclick="approveSchoolHoliday('${holiday.id}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn-sm btn-danger" onclick="rejectSchoolHoliday('${holiday.id}')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    ` : `
                                                        <span style="color: #999; font-size: 11px;">
                                                            ${holiday.status === 'approved' ? 'Approved' : 'Rejected'}
                                                        </span>
                                                    `}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading school holidays:', error);
        container.innerHTML = `<div class="alert alert-danger">Failed to load school holidays: ${error.message}</div>`;
    }
}

async function approveSchoolHoliday(holidayId) {
    if (isLoadingRequest) return;
    isLoadingRequest = true;
    
    setActionButtonsLoading(holidayId, true);
    
    try {
        if (!currentManagerStaff) {
            const user = await supabaseClient.auth.getUser();
            if (user?.data?.user) {
                const { data: staffData } = await supabaseClient
                    .from('staff')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .single();
                currentManagerStaff = staffData;
            }
        }
        
        const { error } = await supabaseClient
            .from('school_holidays')
            .update({ 
                status: 'approved',
                approved_by: currentManagerStaff?.id,
                approved_at: new Date().toISOString()
            })
            .eq('id', holidayId);
        
        if (error) throw error;
        
        showNotification('School holiday approved', 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving holiday:', error);
        showNotification('Failed to approve holiday', 'error');
        setActionButtonsLoading(holidayId, false);
    } finally {
        isLoadingRequest = false;
    }
}

async function rejectSchoolHoliday(holidayId) {
    try {
        const { error } = await supabaseClient
            .from('school_holidays')
            .update({ 
                status: 'rejected',
                approved_at: new Date().toISOString()
            })
            .eq('id', holidayId);
        
        if (error) throw error;
        
        showNotification('School holiday rejected', 'info');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error rejecting school holiday:', error);
        showNotification('Failed to reject school holiday', 'error');
    }
}

async function approveAllHolidays(staffId) {
    if (isLoadingRequest) return;
    
    if (!confirm('Are you sure you want to approve all pending holidays for this staff member?')) {
        return;
    }
    
    isLoadingRequest = true;
    
    const container = document.getElementById('requestsTableContainer');
    const originalContent = container.innerHTML;
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Approving all holidays...</span>
        </div>
    `;
    
    try {
        if (!currentManagerStaff) {
            const user = await supabaseClient.auth.getUser();
            if (user?.data?.user) {
                const { data: staffData } = await supabaseClient
                    .from('staff')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .single();
                currentManagerStaff = staffData;
            }
        }
        
        const { data: holidays, error: fetchError } = await supabaseClient
            .from('school_holidays')
            .select('id')
            .eq('staff_id', staffId)
            .eq('status', 'pending');
        
        if (fetchError) throw fetchError;
        
        if (!holidays || holidays.length === 0) {
            showNotification('No pending holidays to approve', 'warning');
            container.innerHTML = originalContent;
            return;
        }
        
        const { error: updateError } = await supabaseClient
            .from('school_holidays')
            .update({ 
                status: 'approved',
                approved_by: currentManagerStaff?.id,
                approved_at: new Date().toISOString()
            })
            .in('id', holidays.map(h => h.id));
        
        if (updateError) throw updateError;
        
        showNotification(`Approved ${holidays.length} school holiday requests`, 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving holidays:', error);
        showNotification('Failed to approve holidays', 'error');
        container.innerHTML = originalContent;
    } finally {
        isLoadingRequest = false;
    }
}

// ========================================
// SHIFT FUNCTIONS
// ========================================

async function approveShift(shiftId) {
    try {
        const { error } = await supabaseClient
            .from('shifts')
            .update({ status: 'approved' })
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showToast('Shift approved successfully', 'success');
        loadShiftApprovals(); // Reload the list
        
    } catch (error) {
        console.error('Error approving shift:', error);
        showToast(`Failed to approve shift: ${error.message}`, 'error');
    }
}


async function rejectShift(shiftId) {
    if (!confirm('Are you sure you want to reject and delete this shift? This action cannot be undone.')) {
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('shifts')
            .delete()
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showToast('Shift rejected and deleted successfully', 'success');
        loadShiftApprovals(); // Reload the list
        
    } catch (error) {
        console.error('Error deleting shift:', error);
        showToast(`Failed to delete shift: ${error.message}`, 'error');
    }
}


async function approveAllParticipantShifts(participantId) {
    if (isLoadingRequest) return;
    
    if (!confirm('Are you sure you want to approve all pending shifts for this participant?')) {
        return;
    }
    
    isLoadingRequest = true;
    
    const container = document.getElementById('requestsTableContainer');
    const originalContent = container.innerHTML;
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Approving all shifts...</span>
        </div>
    `;
    
    try {
        const { data: shifts, error: fetchError } = await supabaseClient
            .from('shifts')
            .select('id')
            .eq('participant_id', participantId)
            .eq('status', 'pending');
        
        if (fetchError) throw fetchError;
        
        const { error: updateError } = await supabaseClient
            .from('shifts')
            .update({ 
                status: 'confirmed',
                updated_at: new Date().toISOString()
            })
            .in('id', shifts.map(s => s.id));
        
        if (updateError) throw updateError;
        
        showNotification(`Approved ${shifts.length} shifts`, 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving shifts:', error);
        showNotification('Failed to approve shifts', 'error');
        container.innerHTML = originalContent;
    } finally {
        isLoadingRequest = false;
    }
}


async function isStaffAvailable(staffId, date, startTime, endTime) {
    try {
        // Check staff_availability table
        const { data: availability } = await supabaseClient
  .from('staff_availability')
  .select('available, start_time, end_time')
  .eq('staff_id', staffId)
  .eq('date', date)
  .single();
        
        // If no availability record, assume unavailable
        if (!availability?.available) return false;

        // If marked as unavailable
        if (!availability.is_available) {
            return false;
        }
        
        // If times provided, check if within available hours
        if (startTime && endTime && availability.start_time && availability.end_time) {
            const shiftStart = new Date(`2000-01-01T${startTime}`);
            const shiftEnd = new Date(`2000-01-01T${endTime}`);
            const availStart = new Date(`2000-01-01T${availability.start_time}`);
            const availEnd = new Date(`2000-01-01T${availability.end_time}`);
            
            if (shiftStart < availStart || shiftEnd > availEnd) {
                return false;
            }
        }
        
        // Check for approved leave
        const { data: leaves } = await supabaseClient
            .from('leave_requests')
            .select('id')
            .eq('staff_id', staffId)
            .eq('status', 'approved')
            .lte('start_date', date)
            .gte('end_date', date);
        
        return !leaves || leaves.length === 0;
        
    } catch (error) {
        console.error('Error checking availability:', error);
        return false; // Assume unavailable on error
    }
}
async function loadShifts() {
    try {
        
        // First check what's in the database
        const { count: totalCount } = await supabaseClient
            .from('shifts')
            .select('*', { count: 'exact', head: true })
            .is('deleted_at', null);
        
        // Check July specifically
        const { count: julyDbCount } = await supabaseClient
            .from('shifts')
            .select('*', { count: 'exact', head: true })
            .is('deleted_at', null)
            .gte('date', '2025-07-01')
            .lte('date', '2025-07-31');
        
        // Load ALL shifts
        let query = supabaseClient
    .from('shifts')
    .select('*')
    .is('deleted_at', null)
    .order('date', { ascending: false })
    .order('start_time', { ascending: true })
    .limit(50000);  // Explicitly set high limit


        const { data: basicShifts, error } = await query;
        
        if (error) {
            console.error('Shifts query error:', error);
            throw error;
        }
        
        if (basicShifts?.length > 0) {
            const dates = basicShifts.map(s => s.date).sort();

            
            const julyCount = basicShifts.filter(s => s.date >= '2025-07-01' && s.date <= '2025-07-31').length;
            const earlyAugCount = basicShifts.filter(s => s.date >= '2025-08-01' && s.date <= '2025-08-24').length;
            
            // Sample a July shift if it exists
            const sampleJuly = basicShifts.find(s => s.date >= '2025-07-01' && s.date <= '2025-07-31');
            if (sampleJuly) {
                console.log('Sample July shift:', sampleJuly);
            }
        }
        
        if (!basicShifts || basicShifts.length === 0) {
            console.log('No shifts found in database');
            shifts = [];
            filteredShifts = [];
            renderCurrentView();
            return;
        }
        
        // Enrich with related data
        console.log('Starting enrichment...');
        shifts = await enrichShiftsData(basicShifts);
        console.log(`Enriched shifts: ${shifts.length}`);
        
        // DEBUG: Check after enrichment
        const julyCountEnriched = shifts.filter(s => s.date >= '2025-07-01' && s.date <= '2025-07-31').length;
        const earlyAugEnriched = shifts.filter(s => s.date >= '2025-08-01' && s.date <= '2025-08-24').length;
        console.log(`July shifts after enrichment: ${julyCountEnriched}`);
        console.log(`Early Aug shifts after enrichment: ${earlyAugEnriched}`);
        
        const enrichedDates = shifts.map(s => s.date).sort();
        console.log('Date range after enrichment:', {
            earliest: enrichedDates[0],
            latest: enrichedDates[enrichedDates.length - 1]
        });
        
        // Calculate overlap information
        console.log('Calculating overlap information...');
        
        for (const shift of shifts) {
            // Your existing overlap calculation code...
            if (shift.participant_id && shift.start_time && shift.end_time) {
                const sameParticipantShifts = shifts.filter(s => 
                    s.id !== shift.id &&
                    s.participant_id === shift.participant_id &&
                    s.date === shift.date &&
                    s.start_time && 
                    s.end_time
                );
                
                if (sameParticipantShifts.length > 0) {
                    const overlappingStaff = [];
                    const shiftStart = new Date(`2000-01-01T${shift.start_time}`);
                    let shiftEnd = new Date(`2000-01-01T${shift.end_time}`);
                    
                    if (shiftEnd <= shiftStart) {
                        shiftEnd.setDate(shiftEnd.getDate() + 1);
                    }
                    
                    sameParticipantShifts.forEach(otherShift => {
                        const otherStart = new Date(`2000-01-01T${otherShift.start_time}`);
                        let otherEnd = new Date(`2000-01-01T${otherShift.end_time}`);
                        
                        if (otherEnd <= otherStart) {
                            otherEnd.setDate(otherEnd.getDate() + 1);
                        }
                        
                        const hasOverlap = !(shiftEnd <= otherStart || shiftStart >= otherEnd);
                        
                        if (hasOverlap) {
                            const overlapStart = new Date(Math.max(shiftStart.getTime(), otherStart.getTime()));
                            const overlapEnd = new Date(Math.min(shiftEnd.getTime(), otherEnd.getTime()));
                            
                            overlappingStaff.push({
                                staff: otherShift.staff,
                                staff_id: otherShift.staff_id,
                                shift_id: otherShift.id,
                                time: `${formatTime12Hour(otherShift.start_time)}-${formatTime12Hour(otherShift.end_time)}`,
                                overlap_period: {
                                    start: overlapStart.toTimeString().slice(0, 5),
                                    end: overlapEnd.toTimeString().slice(0, 5),
                                    duration: ((overlapEnd - overlapStart) / (1000 * 60 * 60)).toFixed(1) + 'h'
                                }
                            });
                        }
                    });
                    
                    if (overlappingStaff.length > 0) {
                        shift.overlap_info = {
                            count: overlappingStaff.length + 1,
                            ratio: `${overlappingStaff.length + 1}:1`,
                            staff: overlappingStaff,
                            message: `${overlappingStaff.length + 1} staff providing care simultaneously`,
                            details: overlappingStaff.map(s => 
                                `${s.staff?.first_name} ${s.staff?.last_name} (${s.overlap_period.start}-${s.overlap_period.end})`
                            ).join(', ')
                        };
                    }
                }
            }
            
            // Staff conflict checking
            if (shift.staff_id && shift.start_time && shift.end_time) {
                const staffConflicts = shifts.filter(s =>
                    s.id !== shift.id &&
                    s.staff_id === shift.staff_id &&
                    s.date === shift.date &&
                    s.start_time &&
                    s.end_time
                );
                
                if (staffConflicts.length > 0) {
                    const conflicts = [];
                    const shiftStart = new Date(`2000-01-01T${shift.start_time}`);
                    let shiftEnd = new Date(`2000-01-01T${shift.end_time}`);
                    
                    if (shiftEnd <= shiftStart) {
                        shiftEnd.setDate(shiftEnd.getDate() + 1);
                    }
                    
                    staffConflicts.forEach(conflict => {
                        const conflictStart = new Date(`2000-01-01T${conflict.start_time}`);
                        let conflictEnd = new Date(`2000-01-01T${conflict.end_time}`);
                        
                        if (conflictEnd <= conflictStart) {
                            conflictEnd.setDate(conflictEnd.getDate() + 1);
                        }
                        
                        const hasOverlap = !(shiftEnd <= conflictStart || shiftStart >= conflictEnd);
                        
                        if (hasOverlap) {
                            conflicts.push({
                                shift_id: conflict.id,
                                participant: conflict.participant,
                                time: `${formatTime12Hour(conflict.start_time)}-${formatTime12Hour(conflict.end_time)}`,
                                participant_name: conflict.participant ? 
                                    `${conflict.participant.first_name} ${conflict.participant.last_name}` :
                                    'Unknown'
                            });
                        }
                    });
                    
                    if (conflicts.length > 0) {
                        shift.staff_conflict = {
                            has_conflict: true,
                            count: conflicts.length,
                            conflicts: conflicts,
                            message: `‚ö†Ô∏è Staff double-booked with ${conflicts.length} other shift(s)`
                        };
                    }
                }
            }
        }
        
        console.log('Overlap detection complete');
        
        // DEBUG: Final check before applyFilters
        const julyCountFinal = shifts.filter(s => s.date >= '2025-07-01' && s.date <= '2025-07-31').length;
        const earlyAugFinal = shifts.filter(s => s.date >= '2025-08-01' && s.date <= '2025-08-24').length;
        console.log(`July shifts before applyFilters: ${julyCountFinal}`);
        console.log(`Early Aug shifts before applyFilters: ${earlyAugFinal}`);
        
        const finalDates = shifts.map(s => s.date).sort();
        console.log('Final date range before applyFilters:', {
            earliest: finalDates[0],
            latest: finalDates[finalDates.length - 1],
            total: shifts.length
        });
        
        // Check conflicts
        const shiftsWithStaffConflicts = shifts.filter(s => s.staff_conflict?.has_conflict);
        const shiftsWithSleepoverViolations = shifts.filter(s => s.sleepover_violation?.has_violation);
        
        if (shiftsWithStaffConflicts.length > 0) {
            console.warn(`Found ${shiftsWithStaffConflicts.length} shifts with staff double-booking`);
        }
        
        // Apply filters
        console.log('About to call applyFilters()...');
        applyFilters();
        
        // Show warnings if needed
        if (shiftsWithStaffConflicts.length > 0 || shiftsWithSleepoverViolations.length > 0) {
            const warningMessage = [];
            if (shiftsWithStaffConflicts.length > 0) {
                warningMessage.push(`${shiftsWithStaffConflicts.length} staff double-bookings`);
            }
            if (shiftsWithSleepoverViolations.length > 0) {
                warningMessage.push(`${shiftsWithSleepoverViolations.length} sleepover violations`);
            }
            showNotification(`‚ö†Ô∏è Scheduling conflicts detected: ${warningMessage.join(', ')}`, 'warning');
        }

    } catch (error) {
        console.error('Error loading shifts:', error);
        showNotification('Failed to load shifts: ' + error.message, 'error');
        
        const tbody = document.getElementById('shiftsTableBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px; color: var(--danger-color);">
                        <strong>Error Loading Shifts</strong><br>
                        ${error.message}<br>
                        <button class="btn btn-primary btn-sm" onclick="loadShifts()" style="margin-top: 12px;">Retry</button>
                    </td>
                </tr>
            `;
        }
    }
}

        function detectCareHomes() {
    console.log('Detecting care homes...');
    console.log('Total participants:', participants.length);
    
    // Clear previous data
    careHomes.clear();
    
    // Group participants by address (normalized)
    const addressGroups = {};
    
    participants.forEach(p => {
        // Skip if no address
        if (!p.address || p.address.trim() === '') return;
        
        // Normalize address for comparison (lowercase, trim)
        const normalizedAddress = p.address.trim().toLowerCase();
        
        // Also check if this is a care home entity itself (like "Saunders Care Home" participant)
        const isCareHomeEntity = (p.first_name && p.last_name && 
            (p.last_name.toLowerCase().includes('care') || 
             p.last_name.toLowerCase().includes('home') ||
             p.first_name.toLowerCase().includes('saunders')));
        
        // If it's a care home entity, skip adding it as a resident
        if (isCareHomeEntity) {
            console.log('Found care home entity:', p.first_name, p.last_name, p.id);
            // Store care home entity info
            if (!addressGroups[normalizedAddress]) {
                addressGroups[normalizedAddress] = {
                    residents: [],
                    careHomeEntity: p
                };
            } else {
                addressGroups[normalizedAddress].careHomeEntity = p;
            }
        } else {
            // This is a resident
            if (!addressGroups[normalizedAddress]) {
                addressGroups[normalizedAddress] = {
                    residents: [],
                    careHomeEntity: null
                };
            }
            addressGroups[normalizedAddress].residents.push(p);
            console.log('Added resident:', p.first_name, p.last_name, 'at', normalizedAddress);
        }
    });
    
    // Process each address group
    Object.entries(addressGroups).forEach(([address, data]) => {
        // Check if this looks like a care home (multiple residents OR has a care home entity OR contains "saunders")
        if (data.residents.length > 1 || data.careHomeEntity || address.includes('saunders')) {
            let careHomeName = 'Care Home';
            let mainEntityId = null;
            
            // Determine care home name and main entity
            if (data.careHomeEntity) {
                careHomeName = `${data.careHomeEntity.first_name} ${data.careHomeEntity.last_name}`;
                mainEntityId = data.careHomeEntity.id;
            } else if (address.includes('saunders')) {
                careHomeName = 'Saunders Care Home';
                // Find the Saunders Care Home participant entity if it exists
                const saundersEntity = participants.find(p => 
                    p.first_name === 'Saunders' && p.last_name === 'Care Home'
                );
                if (saundersEntity) {
                    mainEntityId = saundersEntity.id;
                }
            }
            
            careHomes.set(address, {
                name: careHomeName,
                address: address,
                residents: data.residents,
                mainEntityId: mainEntityId
            });
            
            console.log(`Care home detected: ${careHomeName} at ${address} with ${data.residents.length} residents`);
        }
    });
    
    // Also check for Saunders Care Home entity specifically
    const saundersEntity = participants.find(p => 
        (p.first_name === 'Saunders' && p.last_name === 'Care Home') ||
        (p.first_name === 'Saunders' && p.last_name === 'Carehome')
    );
    
    if (saundersEntity) {
        console.log('Found Saunders Care Home entity:', saundersEntity);
        
        // Find all participants with Saunders address
        const saundersAddress = '1 saunders avenue, liverpool';
        const saundersResidents = participants.filter(p => 
            p.address && 
            p.address.toLowerCase().includes('saunders') &&
            p.id !== saundersEntity.id // Don't include the care home entity itself
        );
        
        // Update or create Saunders care home entry
        careHomes.set(saundersAddress, {
            name: 'Saunders Care Home',
            address: saundersAddress,
            residents: saundersResidents,
            mainEntityId: saundersEntity.id
        });
        
        console.log(`Saunders Care Home: ${saundersResidents.length} residents found`);
        console.log('Residents:', saundersResidents.map(r => `${r.first_name} ${r.last_name}`));
    }
    
    console.log(`Total care homes detected: ${careHomes.size}`);
    console.log('Care homes:', Array.from(careHomes.entries()));
}
// Helper function to detect care home name
function detectCareHomeName(address, residents) {
    // Check if address contains common care home keywords
    if (address.includes('saunders')) return 'Saunders Care Home';
    if (address.includes('care') || address.includes('home')) {
        // Extract the name from address
        return address.split(',')[0].replace(/\d+/g, '').trim();
    }
    // Default: use the address
    return `Care Home at ${address.split(',')[0]}`;
}

// Helper to find if there's a care home entity (not a person)
function findCareHomeEntity(residents, address) {
    const careHomeEntity = participants.find(p => 
        (p.first_name?.includes('Care') || p.last_name?.includes('Care') ||
         p.first_name?.includes('Home') || p.last_name?.includes('Home')) &&
        p.address?.toLowerCase() === address
    );
    return careHomeEntity?.id || null;
}

        async function enrichShiftsData(basicShifts) {
            if (!basicShifts || basicShifts.length === 0) return [];
            
            try {
                console.log('Enriching shifts with related data...');
                
                // Get unique IDs for batch loading
                const staffIds = [...new Set(basicShifts.map(s => s.staff_id).filter(Boolean))];
                const participantIds = [...new Set(basicShifts.map(s => s.participant_id).filter(Boolean))];
                const locationIds = [...new Set(basicShifts.map(s => s.location_id).filter(Boolean))];
                const dutyTypeIds = [...new Set(basicShifts.map(s => s.duty_type_id).filter(Boolean))];
                const payRateIds = [...new Set(basicShifts.map(s => s.pay_override_id).filter(Boolean))];

                console.log('Loading related data for IDs:', {
                    staffIds: staffIds.length,
                    participantIds: participantIds.length,
                    locationIds: locationIds.length,
                    dutyTypeIds: dutyTypeIds.length,
                    payRateIds: payRateIds.length
                });

                // Load related data in parallel
                const [
                    { data: staffData },
                    { data: participantData },
                    { data: locationData },
                    { data: dutyTypeData },
                    { data: payRateData }
                ] = await Promise.all([
                    staffIds.length ? supabaseClient.from('staff').select('*').in('id', staffIds) : { data: [] },
                    participantIds.length ? supabaseClient.from('participants').select('*').in('id', participantIds) : { data: [] },
                    locationIds.length ? supabaseClient.from('locations').select('*').in('id', locationIds) : { data: [] },
                    dutyTypeIds.length ? supabaseClient.from('duty_types').select('*').in('id', dutyTypeIds) : { data: [] },
                    payRateIds.length ? supabaseClient.from('pay_rates').select('*').in('id', payRateIds) : { data: [] }
                ]);

                console.log('Related data loaded:', {
                    staff: staffData?.length || 0,
                    participants: participantData?.length || 0,
                    locations: locationData?.length || 0,
                    dutyTypes: dutyTypeData?.length || 0,
                    payRates: payRateData?.length || 0
                });

                // Create lookup maps
                const staffMap = new Map((staffData || []).map(s => [s.id, s]));
                const participantMap = new Map((participantData || []).map(p => [p.id, p]));
                const locationMap = new Map((locationData || []).map(l => [l.id, l]));
                const dutyTypeMap = new Map((dutyTypeData || []).map(d => [d.id, d]));
                const payRateMap = new Map((payRateData || []).map(r => [r.id, r]));

                // Enrich shifts and calculate hours/pay
                const enrichedShifts = basicShifts.map(shift => {
                    const enrichedShift = {
                        ...shift,
                        staff: staffMap.get(shift.staff_id) || null,
                        participant: participantMap.get(shift.participant_id) || null,
                        location: locationMap.get(shift.location_id) || null,
                        duty_type: dutyTypeMap.get(shift.duty_type_id) || null,
                        pay_override: payRateMap.get(shift.pay_override_id) || null
                    };

                    // Calculate hours and pay - FIXED LOGIC
                    enrichedShift.calculated_hours = calculateShiftHours(enrichedShift);
                    enrichedShift.calculated_pay = calculateShiftPay(enrichedShift, enrichedShift.calculated_hours);

                    return enrichedShift;
                });

                return enrichedShifts;
                
            } catch (error) {
                console.error('Error enriching shifts:', error);
                return basicShifts;
            }
        }

        // Format hours with 1 decimal place
function formatHours(hours) {
    if (hours === undefined || hours === null) return '0.0';
    return parseFloat(hours).toFixed(1);
}

// Format date to "Mon 5 Aug 2025"
function formatDateFriendly(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString + 'T12:00:00'); // Use noon to avoid timezone issues
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

function formatTime(time) {
    if (!time) return '';
    
    // Handle if time is already in HH:MM format
    if (typeof time === 'string' && time.includes(':')) {
        const [hours, minutes] = time.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${minutes} ${ampm}`;
    }
    
    // Handle Date objects
    if (time instanceof Date) {
        const hours = time.getHours();
        const minutes = time.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHour = hours % 12 || 12;
        return `${displayHour}:${minutes.toString().padStart(2, '0')} ${ampm}`;
    }
    
    return time;
}


function formatTime12Hour(timeStr) {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

function formatDateShort(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' });
}

// Undo/Redo Manager
const UndoRedoManager = {
    // Save state before any modification
    saveState: function(action, data) {
        undoStack.push({
            action: action,
            data: JSON.parse(JSON.stringify(data)), // Deep clone
            timestamp: new Date().toISOString()
        });
        
        // Limit stack size
        if (undoStack.length > MAX_UNDO_STACK) {
            undoStack.shift();
        }
        
        // Clear redo stack when new action is performed
        redoStack = [];
        
        // Update UI buttons
        this.updateButtons();
    },
    
    undo: async function() {
        if (undoStack.length === 0) {
            showNotification('Nothing to undo', 'info');
            return;
        }
        
        const state = undoStack.pop();
        
        try {
            switch(state.action) {
                case 'create_shift':
                    // Undo creation by soft deleting
                    await supabaseClient
                        .from('shifts')
                        .update({ deleted_at: new Date().toISOString() })
                        .eq('id', state.data.id);
                    
                    redoStack.push(state);
                    showNotification('Shift creation undone', 'success');
                    break;
                    
                case 'update_shift':
                    // Restore previous values
                    await supabaseClient
                        .from('shifts')
                        .update(state.data.previous)
                        .eq('id', state.data.id);
                    
                    redoStack.push({
                        action: 'update_shift',
                        data: {
                            id: state.data.id,
                            previous: state.data.current,
                            current: state.data.previous
                        }
                    });
                    showNotification('Shift update undone', 'success');
                    break;
                    
                case 'delete_shift':
                    // Undo deletion by removing deleted_at
                    await supabaseClient
                        .from('shifts')
                        .update({ deleted_at: null })
                        .eq('id', state.data.id);
                    
                    redoStack.push(state);
                    showNotification('Shift deletion undone', 'success');
                    break;
            }
            
            await loadShifts();
            this.updateButtons();
            
        } catch (error) {
            console.error('Undo failed:', error);
            showNotification('Undo failed: ' + error.message, 'error');
            undoStack.push(state); // Restore to stack if failed
        }
    },
    
    redo: async function() {
        if (redoStack.length === 0) {
            showNotification('Nothing to redo', 'info');
            return;
        }
        
        const state = redoStack.pop();
        
        try {
            switch(state.action) {
                case 'create_shift':
                    // Redo creation by removing deleted_at
                    await supabaseClient
                        .from('shifts')
                        .update({ deleted_at: null })
                        .eq('id', state.data.id);
                    break;
                    
                case 'update_shift':
                    // Apply the update again
                    await supabaseClient
                        .from('shifts')
                        .update(state.data.current)
                        .eq('id', state.data.id);
                    break;
                    
                case 'delete_shift':
                    // Redo deletion
                    await supabaseClient
                        .from('shifts')
                        .update({ deleted_at: new Date().toISOString() })
                        .eq('id', state.data.id);
                    break;
            }
            
            undoStack.push(state);
            await loadShifts();
            this.updateButtons();
            showNotification('Action redone', 'success');
            
        } catch (error) {
            console.error('Redo failed:', error);
            showNotification('Redo failed: ' + error.message, 'error');
            redoStack.push(state); // Restore to stack if failed
        }
    },
    
    updateButtons: function() {
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        
        if (undoBtn) {
            undoBtn.disabled = undoStack.length === 0;
            undoBtn.title = undoStack.length > 0 ? 
                `Undo: ${undoStack[undoStack.length - 1].action.replace('_', ' ')}` : 
                'Nothing to undo (Ctrl+Z)';
        }
        
        if (redoBtn) {
            redoBtn.disabled = redoStack.length === 0;
            redoBtn.title = redoStack.length > 0 ? 
                `Redo: ${redoStack[redoStack.length - 1].action.replace('_', ' ')}` : 
                'Nothing to redo (Ctrl+Y)';
        }
    }
};

// Add keyboard shortcuts for undo/redo
document.addEventListener('keydown', function(e) {
    // Check if user is typing in an input field
    const activeElement = document.activeElement;
    const isInputField = activeElement && (
        activeElement.tagName === 'INPUT' || 
        activeElement.tagName === 'TEXTAREA' || 
        activeElement.tagName === 'SELECT'
    );
    
    // Don't trigger undo/redo if user is typing
    if (isInputField) return;
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        UndoRedoManager.undo();
    } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        UndoRedoManager.redo();
    }
});

document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        UndoRedoManager.undo();
    } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        UndoRedoManager.redo();
    }
});

function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };

    const dutyType = shift.duty_type;
    const isSleepover = dutyType && dutyType.name && 
        dutyType.name.toLowerCase().includes('sleepover');

    // Check if this shift falls on a public holiday
    const shiftDateKey = shift.date.split('T')[0]; // Ensure YYYY-MM-DD format
    const isPublicHoliday = publicHolidays.has(shiftDateKey);
    
    // Set the flag on the shift object for rendering
    shift.is_public_holiday = isPublicHoliday;
    if (isPublicHoliday) {
        const holiday = publicHolidays.get(shiftDateKey);
        shift.public_holiday_name = holiday.name;
    }

    // If it has times AND is a sleepover, calculate both
    if (isSleepover && shift.start_time && shift.end_time) {
        // This is BOTH active hours AND a sleepover
        
        // First calculate active hours
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const activeHours = (endTime - startTime) / (1000 * 60 * 60);
        
        // Apply penalty logic for active hours - PUBLIC HOLIDAY TAKES PRECEDENCE
        if (isPublicHoliday) {
            result.publicHoliday = activeHours;
        } else {
            const shiftDate = new Date(shift.date);
            const dayOfWeek = shiftDate.getDay();
            
            if (dayOfWeek === 6) {
                result.saturday = activeHours;
            } else if (dayOfWeek === 0) {
                result.sunday = activeHours;
            } else {
                const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
                Object.assign(result, weekdayBreakdown);
            }
        }
        
        // ADD the sleepover hours on top
        result.sleepover = 2; // Always 2 hours for sleepover
        result.total = activeHours + 2; // Total is active + sleepover
        
        console.log(`Combined shift on ${shift.date}: ${activeHours}h active + 2h sleepover = ${result.total}h total${isPublicHoliday ? ' (PUBLIC HOLIDAY: ' + shift.public_holiday_name + ')' : ''}`);
        
    } else if (isSleepover) {
        // Just a sleepover, no active hours
        result.sleepover = 2;
        result.total = 2;
        
    } else if (shift.start_time && shift.end_time) {
        // Just active hours, no sleepover
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const totalHours = (endTime - startTime) / (1000 * 60 * 60);
        result.total = totalHours;
        
        // Apply penalty logic - PUBLIC HOLIDAY TAKES PRECEDENCE
        if (isPublicHoliday) {
            result.publicHoliday = totalHours;
        } else {
            const shiftDate = new Date(shift.date);
            const dayOfWeek = shiftDate.getDay();
            
            if (dayOfWeek === 6) {
                result.saturday = totalHours;
            } else if (dayOfWeek === 0) {
                result.sunday = totalHours;
            } else {
                const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
                Object.assign(result, weekdayBreakdown);
            }
        }
    }
    
    return result;
}
        function splitWeekdayHours(startTime, endTime) {
            const result = {
                total: 0,
                weekdayDay: 0,      // 6am-8pm
                weekdayEvening: 0,  // 8pm-12am  
                weekdayNight: 0     // 12am-6am
            };

            const current = new Date(startTime);
            
            while (current < endTime) {
                // Calculate end of current period
                const nextPeriod = new Date(current);
                nextPeriod.setMinutes(current.getMinutes() + 30); // Calculate in 30-min increments for accuracy
                
                const periodEnd = nextPeriod > endTime ? endTime : nextPeriod;
                const periodHours = (periodEnd - current) / (1000 * 60 * 60);
                
                const hour = current.getHours();
                
                // Time period classification
                if (hour >= 6 && hour < 20) {
                    result.weekdayDay += periodHours;
                } else if (hour >= 20 && hour < 24) {
                    result.weekdayEvening += periodHours;
                } else {
                    result.weekdayNight += periodHours;
                }
                
                current.setTime(periodEnd.getTime());
            }

            result.total = result.weekdayDay + result.weekdayEvening + result.weekdayNight;
            return result;
        }

        // Update the calculateShiftPay function (around line 1050)
function calculateShiftPay(shift, hoursBreakdown) {
    // Get effective pay rate - FIXED LOGIC
    let payRate = null;
    
    // Check if there's a pay override
    if (shift.pay_override_id && shift.pay_override_id !== '00000000-0000-0000-0000-000000000002') {
        // Use the override rate
        payRate = shift.pay_override || payRates.find(pr => pr.id === shift.pay_override_id);
    } 
    
    // If no override OR if it's the standard rate placeholder, use staff's assigned rate
    if (!payRate || shift.pay_override_id === '00000000-0000-0000-0000-000000000002') {
        if (shift.staff && shift.staff.pay_rate_id) {
            payRate = payRates.find(pr => pr.id === shift.staff.pay_rate_id);
        }
    }
    
    // Final fallback
    if (!payRate) {
        console.warn(`No pay rate found for shift ${shift.id}, using zero rates`);
        payRate = {
            hourly_pay_rate: 0,
            afternoon: 0,
            night: 0,
            saturday: 0,
            sunday: 0,
            public_holiday: 0,
            sleepover: 0
        };
    }
    
    const baseRate = parseFloat(payRate.hourly_pay_rate) || 0;
    
    const totalPay = 
        (hoursBreakdown.weekdayDay * baseRate) +
        (hoursBreakdown.weekdayEvening * (parseFloat(payRate.afternoon) || baseRate)) +
        (hoursBreakdown.weekdayNight * (parseFloat(payRate.night) || baseRate)) +
        (hoursBreakdown.saturday * (parseFloat(payRate.saturday) || baseRate)) +
        (hoursBreakdown.sunday * (parseFloat(payRate.sunday) || baseRate)) +
        (hoursBreakdown.publicHoliday * (parseFloat(payRate.public_holiday) || baseRate)) +
        (hoursBreakdown.sleepover * (parseFloat(payRate.sleepover) / 2|| baseRate));

    return totalPay;
}

        
        // ========================================
        // FILTERING AND VIEW SWITCHING
        // ========================================
        function applyFilters() {
    console.log('=== APPLYING FILTERS ===');
    
    const startDate = document.getElementById('startDate')?.value;
    const endDate = document.getElementById('endDate')?.value;
    const statusFilter = document.getElementById('statusFilter')?.value;

    // Store filters globally for all views to access
    window.currentFilters = {
        startDate: startDate,
        endDate: endDate,
        staffId: staffFilterValue,
        participantId: participantFilterValue,
        status: statusFilter
    };

    console.log('Filter values:', window.currentFilters);

    // Apply filters to shifts
    filteredShifts = shifts.filter(shift => {
        if (startDate && shift.date < startDate) return false;
        if (endDate && shift.date > endDate) return false;
        if (staffFilterValue && shift.staff_id !== staffFilterValue) return false;
        if (participantFilterValue && shift.participant_id !== participantFilterValue) return false;
        if (statusFilter && shift.status !== statusFilter) return false;
        return true;
    });

    console.log('Filtered result:', filteredShifts.length, 'shifts');
    renderCurrentView();
}

function renderCurrentView() {
    switch(currentView) {
        case 'table':
            renderTable();
            break;
        case 'requests':
            renderRequests();
            break;
        case 'summary':
            renderSummary();
            break;
        case 'timesheet':
            renderTimesheet();
            break;
        case 'conflicts':
            renderConflicts();
            break;
        case 'notes':
            renderNotes(1);  // Start at page 1 with filters
            break;
        case 'availability':
            renderAvailability();
            break;
        case 'templates':
            if (typeof loadTemplates === 'function') {
                loadTemplates();
            }
            break;
        case 'staff':
            if (typeof renderStaffView === 'function') {
                renderStaffView();
            }
            break;
        case 'assignments':
            renderAssignments();
            break;
    }
}

function switchView(view) {
    currentView = view;
    
    // Update buttons
    document.querySelectorAll('.view-toggle button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Handle different button ID patterns
    const activeBtn = document.getElementById(`${view}ViewBtn`) || 
                     document.querySelector(`[data-view="${view}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }

    // Hide ALL view contents
    document.querySelectorAll('.view-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
    });
    
    // Show the selected view
    const activeView = document.getElementById(`${view}View`) || 
                      document.getElementById(`${view}sView`);  // Handle 'templates' -> 'templatesView'
    
    if (activeView) {
        activeView.classList.add('active');
        activeView.style.display = 'block';
    }

    // Render the appropriate view
    switch(view) {
        case 'table':
            renderTable();
            break;
        case 'requests':
            renderRequests();
            break;
        case 'summary':
            renderSummary();
            break;
        case 'timesheet':
            renderTimesheet();
            break;
        case 'conflicts':
            renderConflicts();
            break;
        case 'notes':
            renderNotes(1);  // Start at page 1
            break;
        case 'availability':
            renderAvailability();
            break;
        case 'templates':
            if (typeof loadTemplates === 'function') {
                loadTemplates();
            }
            break;
        case 'staff':
            if (typeof renderStaffView === 'function') {
                renderStaffView();
            }
            break;
        case 'assignments':
            if (typeof initAssignmentManager === 'function') {
                console.log('Calling initAssignmentManager...');
                initAssignmentManager();
            } else {
                console.error('initAssignmentManager function not found');
            }
            break;
        case 'participants':
            // Load participants table
            if (typeof loadParticipantsTable === 'function') {
                loadParticipantsTable();
            } else {
                console.error('loadParticipantsTable function not found');
            }
            // Load Google Maps if not already loaded
            if (typeof loadGoogleMapsScript === 'function') {
                loadGoogleMapsScript();
            }
            break;
        default:
            console.log('Unknown view:', view);
            break;
    }
}

//PARTICIPANTS SECTION
function attachParticipantButtonListeners() {
    // Remove any existing listeners to avoid duplicates
    document.querySelectorAll('.participant-edit-btn').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            console.log('Edit participant ID:', id);
            if (id && id !== 'undefined') {
                editParticipant(id);
            } else {
                console.error('Invalid participant ID for edit');
                alert('Error: Invalid participant ID');
            }
        };
    });
    
    document.querySelectorAll('.participant-location-btn').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            console.log('View location for participant ID:', id);
            if (id && id !== 'undefined') {
                viewParticipantLocation(id);
            } else {
                console.error('Invalid participant ID for location');
                alert('Error: Invalid participant ID');
            }
        };
    });
    
    document.querySelectorAll('.participant-docs-btn').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            console.log('View documents for participant ID:', id);
            if (id && id !== 'undefined') {
                viewParticipantDocuments(id);
            } else {
                console.error('Invalid participant ID for documents');
                alert('Error: Invalid participant ID');
            }
        };
    });
}

// Also update loadParticipantsTable to check the data structure
async function loadParticipantsTable() {
    try {
        const tbody = document.getElementById('participantsTableBody');
        tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div><span>Loading participants...</span></td></tr>';
        
        const { data, error } = await supabaseClient
            .from('participants')
            .select('*')
            .order('first_name');

        if (error) throw error;
        
        console.log('Loaded participants data:', data); // Debug log
        
        // Check if data has the expected structure
        if (data && data.length > 0) {
            console.log('First participant structure:', data[0]);
            console.log('First participant ID:', data[0].id);
        }
        
        participantsData = data || [];
        displayParticipantsTable(data);
    } catch (error) {
        console.error('Error loading participants:', error);
        document.getElementById('participantsTableBody').innerHTML = 
            '<tr><td colspan="7" style="text-align: center; color: red;">Failed to load participants: ' + error.message + '</td></tr>';
    }
}

// Filter participants
function filterParticipants() {
    const searchTerm = document.getElementById('participantSearch').value.toLowerCase();
    const statusFilter = document.getElementById('participantStatusFilter').value;
    const serviceFilter = document.getElementById('participantServiceFilter').value;

    const filtered = participantsData.filter(participant => {
        const matchesSearch = !searchTerm || 
            `${participant.first_name} ${participant.last_name}`.toLowerCase().includes(searchTerm) ||
            (participant.ndis_number && participant.ndis_number.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || participant.status === statusFilter;
        const matchesService = !serviceFilter || participant.service_type === serviceFilter;

        return matchesSearch && matchesStatus && matchesService;
    });

    displayParticipantsTable(filtered);
}

// Clear participant filters
function clearParticipantFilters() {
    document.getElementById('participantSearch').value = '';
    document.getElementById('participantStatusFilter').value = '';
    document.getElementById('participantServiceFilter').value = '';
    displayParticipantsTable(participantsData);
}

// Open participant modal

// Close modal using your existing function
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    if (modalId === 'participantModal') {
        currentParticipantId = null;
        participantMap = null;
        participantMarker = null;
        geofenceCircle = null;
    }
}

// Switch participant tabs
function switchParticipantTab(tabName, event) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
    });
    
    const tabContent = document.getElementById(`${tabName}Tab`);
    if (tabContent) {
        tabContent.style.display = 'block';
        tabContent.classList.add('active');
    }
    
    // Initialize map if switching to location tab
    if (tabName === 'location' && !participantMap) {
        setTimeout(() => initParticipantMap(), 100);
    }
}

async function saveParticipant(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const participantData = Object.fromEntries(formData);
    
    // FIX: Convert empty strings to null for date fields
    const dateFields = ['date_of_birth', 'plan_start_date', 'plan_end_date'];
    dateFields.forEach(field => {
        if (participantData[field] === '' || participantData[field] === undefined) {
            participantData[field] = null;
        }
    });
    
    // Also clean up any other empty string fields that might cause issues
    Object.keys(participantData).forEach(key => {
        if (participantData[key] === '') {
            // Check if this field name contains 'date' or ends with '_date'
            if (key.includes('date') || key.endsWith('_at')) {
                participantData[key] = null;
            }
        }
    });
    
    // Map form fields to database fields
    if (participantData.ndis_number) {
        participantData.ndis_participant_number = participantData.ndis_number;
        delete participantData.ndis_number;
    }
    
    // FIX: Map latitude/longitude form fields to location_lat/location_lng database fields
    if (participantData.latitude) {
        participantData.location_lat = parseFloat(participantData.latitude) || null;
        delete participantData.latitude;
    }
    if (participantData.longitude) {
        participantData.location_lng = parseFloat(participantData.longitude) || null;
        delete participantData.longitude;
    }
    
    // Add geofence radius
    const geofenceRadius = document.getElementById('geofenceRadius').value;
    if (geofenceRadius) {
        participantData.geofence_radius = parseInt(geofenceRadius) || null;
    }
    
    console.log('Saving participant with data:', participantData);
    
    try {
        let result;
        
        if (currentParticipantId) {
            result = await supabaseClient
                .from('participants')
                .update(participantData)
                .eq('id', currentParticipantId)
                .select()
                .single();
        } else {
            result = await supabaseClient
                .from('participants')
                .insert([participantData])
                .select()
                .single();
        }

        if (result.error) throw result.error;

        const participantId = currentParticipantId || result.data.id;
        await saveParticipantMedications(participantId);
        await saveEmergencyContacts(participantId);

        alert('Participant saved successfully!');
        closeModal('participantModal');
        loadParticipantsTable();

    } catch (error) {
        console.error('Error saving participant:', error);
        alert('Failed to save participant: ' + error.message);
    }
}

// Add helper functions
function editParticipant(id) {
    openParticipantModal(id);
}

function viewParticipantLocation(id) {
    // Open modal and switch to location tab
    openParticipantModal(id);
    setTimeout(() => {
        const locationBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.textContent === 'Location');
        if (locationBtn) {
            switchParticipantTab('location', { target: locationBtn });
        }
    }, 100);
}

function viewParticipantDocuments(id) {
    // Open modal and switch to documents tab
    openParticipantModal(id);
    setTimeout(() => {
        const docsBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.textContent === 'Documents');
        if (docsBtn) {
            switchParticipantTab('documents', { target: docsBtn });
        }
    }, 100);
}

function showParticipantMapOverview() {
    alert('Map overview feature coming soon!');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load Google Maps if on participants view
    if (document.getElementById('participantsView')?.style.display !== 'none') {
        loadGoogleMapsScript();
    }
});

// ADD THESE HELPER FUNCTIONS TO YOUR mc-manager.html

// ==================== DATA LOADING FUNCTIONS ====================

// ============ PART 1: FIX COORDINATE FIELD NAMES ============

// UPDATE your initParticipantAutocomplete to use correct field names
function initParticipantAutocomplete() {
    if (!window.google || !window.google.maps || !window.google.maps.places) {
        console.warn('Google Maps not loaded yet, skipping autocomplete initialization');
        return;
    }
    
    const input = document.getElementById('addressAutocomplete');
    if (!input) return;

    autocomplete = new google.maps.places.Autocomplete(input, {
        componentRestrictions: { country: 'au' },
        fields: ['address_components', 'geometry', 'formatted_address']
    });

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        // Parse address components
        let streetNumber = '';
        let streetName = '';
        let suburb = '';
        let state = '';
        let postcode = '';

        place.address_components.forEach(component => {
            const types = component.types;
            if (types.includes('street_number')) streetNumber = component.long_name;
            if (types.includes('route')) streetName = component.long_name;
            if (types.includes('locality')) suburb = component.long_name;
            if (types.includes('administrative_area_level_1')) state = component.short_name;
            if (types.includes('postal_code')) postcode = component.long_name;
        });

        // Populate address fields
        document.getElementById('streetNumber').value = streetNumber;
        document.getElementById('streetName').value = streetName;
        document.getElementById('suburb').value = suburb;
        document.getElementById('state').value = state;
        document.getElementById('postcode').value = postcode;
        
        // FIX: Use location_lat and location_lng (your actual field names)
        document.getElementById('latitude').value = place.geometry.location.lat();
        document.getElementById('longitude').value = place.geometry.location.lng();
        
        // Also update the map if visible
        if (document.getElementById('locationTab').classList.contains('active')) {
            updateParticipantMap();
        }
    });
}

async function loadParticipantData(participantId) {
    try {
        const { data, error } = await supabaseClient
            .from('participants')
            .select('*')
            .eq('id', participantId)
            .single();

        if (error) throw error;

        console.log('Loading participant data:', data);

        // SAFE FIELD SETTING - Only set if element exists
        const setFieldValue = (elementId, value) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value || '';
            } else {
                console.warn(`Field not found: ${elementId}`);
            }
        };

        // Basic Information
        setFieldValue('firstName', data.first_name);
        setFieldValue('lastName', data.last_name);
        setFieldValue('preferredName', data.preferred_name);
        setFieldValue('dateOfBirth', data.date_of_birth);
        setFieldValue('ndisNumber', data.ndis_participant_number);
        
        // Service Information
        setFieldValue('serviceType', data.service_type);
        setFieldValue('participantPhone', data.phone);
        setFieldValue('participantEmail', data.email);
        setFieldValue('participantStatus', data.status);
        
        // Plan Information
        setFieldValue('planStartDate', data.plan_start_date);
        setFieldValue('planEndDate', data.plan_end_date);
        setFieldValue('planManager', data.plan_manager);
        
        // Address Fields
        setFieldValue('unitNumber', data.unit_number);
        setFieldValue('streetNumber', data.street_number);
        setFieldValue('streetName', data.street_name);
        setFieldValue('suburb', data.suburb);
        setFieldValue('state', data.state);
        setFieldValue('postcode', data.postcode);
        setFieldValue('country', data.country || 'Australia');
        
        // Location coordinates (using your actual field names)
        setFieldValue('latitude', data.location_lat);
        setFieldValue('longitude', data.location_lng);
        setFieldValue('geofenceRadius', data.geofence_radius || 100);
        
        // Notes
        setFieldValue('participantNotes', data.notes);
        
        // Medical fields
        setFieldValue('medicareNumber', data.medicare_number);
        setFieldValue('privateHealth', data.private_health);
        setFieldValue('gpName', data.gp_name);
        setFieldValue('gpPhone', data.gp_phone);
        setFieldValue('medicalConditions', data.medical_conditions);
        setFieldValue('allergies', data.allergies);
        setFieldValue('dietaryRequirements', data.dietary_requirements);
        
        // Primary Contact
        setFieldValue('primaryContactName', data.primary_contact_name);
        setFieldValue('primaryContactRelationship', data.primary_contact_relationship);
        setFieldValue('primaryContactPhone', data.primary_contact_phone);
        setFieldValue('primaryContactEmail', data.primary_contact_email);

        // Log any database fields that don't have form fields
        Object.keys(data).forEach(key => {
            if (!['id', 'created_at', 'updated_at', 'user_id'].includes(key)) {
                const camelCase = key.replace(/_([a-z])/g, g => g[1].toUpperCase());
                const element = document.getElementById(camelCase);
                if (!element && key !== 'ndis_participant_number' && key !== 'location_lat' && key !== 'location_lng') {
                    console.log(`Database field '${key}' has no form field`);
                }
            }
        });

        // Load related data - with error handling
        try {
            await loadParticipantMedications(participantId);
        } catch (e) {
            console.error('Error loading medications:', e);
        }
        
        try {
            await loadEmergencyContacts(participantId);
        } catch (e) {
            console.error('Error loading emergency contacts:', e);
        }
        
        try {
            await loadParticipantDocuments(participantId);
        } catch (e) {
            console.error('Error loading documents:', e);
        }
        
        try {
            await loadAssignedStaff(participantId);
        } catch (e) {
            console.error('Error loading staff:', e);
        }

    } catch (error) {
        console.error('Error loading participant:', error);
        // Don't show alert - let modal still open
        // alert('Failed to load some participant data');
    }
}

// ==================== MEDICATION FUNCTIONS ====================

// Add medication row


// Remove medication row
function removeMedicationRow(rowId) {
    const row = document.getElementById(rowId);
    if (row) row.remove();
}

// Load medications
async function loadParticipantMedications(participantId) {
    try {
        const { data, error } = await supabaseClient
            .from('participant_medications')
            .select('*')
            .eq('participant_id', participantId)
            .eq('is_active', true);

        if (error) throw error;

        const tbody = document.getElementById('medicationsTableBody');
        tbody.innerHTML = '';
        
        data.forEach(med => {
            const rowId = `med_${med.id}`;
            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td><input type="text" class="med-name" value="${med.medication_name || ''}" style="width: 100%;"></td>
                <td><input type="text" class="med-dosage" value="${med.dosage || ''}" style="width: 100%;"></td>
                <td><input type="text" class="med-frequency" value="${med.frequency || ''}" style="width: 100%;"></td>
                <td><input type="text" class="med-prescriber" value="${med.prescriber || ''}" style="width: 100%;"></td>
                <td><input type="date" class="med-start-date" value="${med.start_date || ''}" style="width: 100%;"></td>
                <td>
                    <button type="button" class="btn-icon-only" onclick="removeMedicationRow('${rowId}')">‚ùå</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading medications:', error);
    }
}

// Save medications
async function saveParticipantMedications(participantId) {
    const rows = document.querySelectorAll('#medicationsTableBody tr');
    const medications = [];

    rows.forEach(row => {
        const name = row.querySelector('.med-name')?.value;
        if (name) {
            medications.push({
                participant_id: participantId,
                medication_name: name,
                dosage: row.querySelector('.med-dosage')?.value || null,
                frequency: row.querySelector('.med-frequency')?.value || null,
                prescriber: row.querySelector('.med-prescriber')?.value || null,
                start_date: row.querySelector('.med-start-date')?.value || null,
                is_active: true
            });
        }
    });

    if (medications.length > 0) {
        // Delete existing medications
        await supabaseClient
            .from('participant_medications')
            .delete()
            .eq('participant_id', participantId);

        // Insert new medications
        const { error } = await supabaseClient
            .from('participant_medications')
            .insert(medications);

        if (error) console.error('Error saving medications:', error);
    }
}

// ==================== EMERGENCY CONTACT FUNCTIONS ====================

// Add emergency contact

// Remove emergency contact
function removeEmergencyContact(contactId) {
    const element = document.getElementById(contactId);
    if (element) element.remove();
}

// Load emergency contacts
async function loadEmergencyContacts(participantId) {
    try {
        const { data, error } = await supabaseClient
            .from('participant_emergency_contacts')
            .select('*')
            .eq('participant_id', participantId);

        if (error) throw error;

        const container = document.getElementById('emergencyContactsList');
        container.innerHTML = '';
        
        data.forEach(contact => {
            const contactId = `contact_${contact.id}`;
            const contactDiv = document.createElement('div');
            contactDiv.className = 'emergency-contact-item';
            contactDiv.id = contactId;
            contactDiv.innerHTML = `
                <h4>
                    Emergency Contact
                    <button type="button" class="btn-icon-only" onclick="removeEmergencyContact('${contactId}')">‚ùå</button>
                </h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="ec-name" value="${contact.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Relationship</label>
                        <input type="text" class="ec-relationship" value="${contact.relationship || ''}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" class="ec-phone" value="${contact.phone || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="ec-email" value="${contact.email || ''}">
                    </div>
                </div>
            `;
            container.appendChild(contactDiv);
        });
    } catch (error) {
        console.error('Error loading emergency contacts:', error);
    }
}

// Save emergency contacts
async function saveEmergencyContacts(participantId) {
    const contactElements = document.querySelectorAll('.emergency-contact-item');
    const contacts = [];

    contactElements.forEach(element => {
        const name = element.querySelector('.ec-name')?.value;
        if (name) {
            contacts.push({
                participant_id: participantId,
                name: name,
                relationship: element.querySelector('.ec-relationship')?.value || null,
                phone: element.querySelector('.ec-phone')?.value || null,
                email: element.querySelector('.ec-email')?.value || null,
                is_primary: false
            });
        }
    });

    if (contacts.length > 0) {
        // Delete existing contacts
        await supabaseClient
            .from('participant_emergency_contacts')
            .delete()
            .eq('participant_id', participantId);

        // Insert new contacts
        const { error } = await supabaseClient
            .from('participant_emergency_contacts')
            .insert(contacts);

        if (error) console.error('Error saving emergency contacts:', error);
    }
}

// ==================== LOCATION FUNCTIONS ====================

// REPLACE YOUR EXISTING FUNCTIONS WITH THESE FIXED VERSIONS

// ==================== GOOGLE MAPS INITIALIZATION FIX ====================

// Load Google Maps Script (FIXED)
function loadGoogleMapsScript() {
    // Check if already loaded or loading
    if (window.google && window.google.maps) {
        console.log('Google Maps already loaded');
        return;
    }
    
    // Check if script is already being loaded
    if (document.querySelector('script[src*="maps.googleapis.com"]')) {
        console.log('Google Maps script already in DOM');
        return;
    }
    
    // Only load if API key is set
    if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY === 'YOUR_API_KEY_HERE') {
        console.warn('Google Maps API key not configured');
        return;
    }
    
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&callback=initGoogleMaps`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}

// Initialize Google Maps (FIXED)
window.initGoogleMaps = function() {
    console.log('Google Maps API loaded and ready');
    // Set a flag to indicate maps is ready
    window.googleMapsReady = true;
}

function initParticipantAutocomplete() {
    if (!window.google || !window.google.maps || !window.google.maps.places) {
        console.warn('Google Maps not loaded yet, skipping autocomplete initialization');
        return;
    }
    
    const input = document.getElementById('addressAutocomplete');
    if (!input) return;

    autocomplete = new google.maps.places.Autocomplete(input, {
        componentRestrictions: { country: 'au' },
        fields: ['address_components', 'geometry', 'formatted_address']
    });

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        // Parse address components
        let streetNumber = '';
        let streetName = '';
        let suburb = '';
        let state = '';
        let postcode = '';

        place.address_components.forEach(component => {
            const types = component.types;
            if (types.includes('street_number')) streetNumber = component.long_name;
            if (types.includes('route')) streetName = component.long_name;
            if (types.includes('locality')) suburb = component.long_name;
            if (types.includes('administrative_area_level_1')) state = component.short_name;
            if (types.includes('postal_code')) postcode = component.long_name;
        });

        // Populate address fields
        document.getElementById('streetNumber').value = streetNumber;
        document.getElementById('streetName').value = streetName;
        document.getElementById('suburb').value = suburb;
        document.getElementById('state').value = state;
        document.getElementById('postcode').value = postcode;
        
        // FIX: Use location_lat and location_lng (your actual field names)
        document.getElementById('latitude').value = place.geometry.location.lat();
        document.getElementById('longitude').value = place.geometry.location.lng();
        
        // Also update the map if visible
        if (document.getElementById('locationTab').classList.contains('active')) {
            updateParticipantMap();
        }
    });
}

// Initialize Participant Map (FIXED)
function initParticipantMap() {
    if (!window.google || !window.google.maps) {
        console.warn('Google Maps not loaded yet');
        return;
    }
    
    const mapContainer = document.getElementById('participantMap');
    if (!mapContainer) return;

    // Get coordinates from form (which are populated from location_lat/location_lng)
    const lat = parseFloat(document.getElementById('latitude').value) || -33.8688;
    const lng = parseFloat(document.getElementById('longitude').value) || 151.2093;
    
    participantMap = new google.maps.Map(mapContainer, {
        center: { lat, lng },
        zoom: 15,
        mapTypeControl: false,
        streetViewControl: false
    });

    participantMarker = new google.maps.Marker({
        position: { lat, lng },
        map: participantMap,
        draggable: true,
        title: 'Participant Location'
    });

    const radius = parseInt(document.getElementById('geofenceRadius').value) || 100;
    geofenceCircle = new google.maps.Circle({
        map: participantMap,
        center: { lat, lng },
        radius: radius,
        fillColor: '#4285F4',
        fillOpacity: 0.2,
        strokeColor: '#4285F4',
        strokeOpacity: 0.8,
        strokeWeight: 2
    });

    // Update form fields when marker is dragged
    participantMarker.addListener('dragend', () => {
        const position = participantMarker.getPosition();
        document.getElementById('latitude').value = position.lat();
        document.getElementById('longitude').value = position.lng();
        geofenceCircle.setCenter(position);
    });
}

// ==================== DISPLAY PARTICIPANTS TABLE FIX ====================

function displayParticipantsTable(participants) {
    const tbody = document.getElementById('participantsTableBody');
    
    if (!participants || participants.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No participants found</td></tr>';
        return;
    }

    tbody.innerHTML = participants.map((participant, index) => {
        // Store participant in global array for safe access
        participantsData[index] = participant;
        
        // Check if participant has an ID
        const participantId = participant.id || participant.participant_id || index;
        
        // Debug log
        console.log(`Participant ${index}:`, participant);
        
        const statusClass = `status-${participant.status || 'active'}`;
        const statusText = participant.status ? 
            participant.status.charAt(0).toUpperCase() + participant.status.slice(1) : 
            'Active';
        
        // Create safe display values
        const firstName = participant.first_name || '';
        const lastName = participant.last_name || '';
        const ndisNumber = participant.ndis_number || 'N/A';
        const serviceType = participant.service_type || 'N/A';
        const suburb = participant.suburb || 'N/A';
        const state = participant.state || '';
        const primaryContactName = participant.primary_contact_name || 'N/A';
        const primaryContactPhone = participant.primary_contact_phone || '';
        const dob = participant.date_of_birth ? new Date(participant.date_of_birth).toLocaleDateString() : 'N/A';
        
        return `
            <tr data-participant-id="${participantId}">
                <td>
                    <div style="font-weight: 500;">
                        ${firstName} ${lastName}
                    </div>
                    <div style="font-size: 0.85rem; color: #666;">
                        DOB: ${dob}
                    </div>
                </td>
                <td>${ndisNumber}</td>
                <td>${serviceType}</td>
                <td>
                    <div style="font-size: 0.9rem;">
                        ${suburb}${state ? ', ' + state : ''}
                    </div>
                </td>
                <td>
                    ${primaryContactName}
                    ${primaryContactPhone ? '<br><small>' + primaryContactPhone + '</small>' : ''}
                </td>
                <td>
                    <span class="participant-status-badge ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td>
                    <button class="btn btn-outline btn-sm participant-edit-btn" data-id="${participantId}" style="padding: 4px 8px; margin: 2px;">
                        Edit
                    </button>
                    <button class="btn btn-outline btn-sm participant-location-btn" data-id="${participantId}" style="padding: 4px 8px; margin: 2px;">
                        Location
                    </button>
                    <button class="btn btn-outline btn-sm participant-docs-btn" data-id="${participantId}" style="padding: 4px 8px; margin: 2px;">
                        Docs
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // Add event listeners after creating the HTML
    attachParticipantButtonListeners();
}


// ==================== OTHER BUTTON FIXES ====================

// Add medication row (FIXED - removed emoji)
function addMedicationRow() {
    const tbody = document.getElementById('medicationsTableBody');
    const rowId = `med_${Date.now()}`;
    
    const newRow = document.createElement('tr');
    newRow.id = rowId;
    newRow.innerHTML = `
        <td><input type="text" class="med-name" placeholder="Medication name" style="width: 100%;"></td>
        <td><input type="text" class="med-dosage" placeholder="e.g., 10mg" style="width: 100%;"></td>
        <td><input type="text" class="med-frequency" placeholder="e.g., Twice daily" style="width: 100%;"></td>
        <td><input type="text" class="med-prescriber" placeholder="Doctor name" style="width: 100%;"></td>
        <td><input type="date" class="med-start-date" style="width: 100%;"></td>
        <td>
            <button type="button" class="btn btn-outline btn-sm" onclick="removeMedicationRow('${rowId}')" style="padding: 4px 8px;">
                Remove
            </button>
        </td>
    `;
    tbody.appendChild(newRow);
}

// Add emergency contact (FIXED - removed emoji)
function addEmergencyContact() {
    const container = document.getElementById('emergencyContactsList');
    const contactId = `contact_${Date.now()}`;
    
    const contactDiv = document.createElement('div');
    contactDiv.className = 'emergency-contact-item';
    contactDiv.id = contactId;
    contactDiv.innerHTML = `
        <h4>
            Emergency Contact
            <button type="button" class="btn btn-outline btn-sm" onclick="removeEmergencyContact('${contactId}')" style="padding: 4px 8px;">
                Remove
            </button>
        </h4>
        <div class="form-row">
            <div class="form-group">
                <label>Name</label>
                <input type="text" class="ec-name" required>
            </div>
            <div class="form-group">
                <label>Relationship</label>
                <input type="text" class="ec-relationship">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" class="ec-phone" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" class="ec-email">
            </div>
        </div>
    `;
    container.appendChild(contactDiv);
}

// Load documents (FIXED - removed emoji)
async function loadParticipantDocuments(participantId) {
    try {
        const { data, error } = await supabaseClient
            .from('participant_documents')
            .select('*')
            .eq('participant_id', participantId)
            .order('uploaded_at', { ascending: false });

        if (error) throw error;

        const tbody = document.getElementById('documentsTableBody');
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No documents uploaded</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(doc => `
            <tr>
                <td>${doc.document_name}</td>
                <td>${formatDocumentType(doc.document_type)}</td>
                <td>${new Date(doc.uploaded_at).toLocaleDateString()}</td>
                <td>${doc.expiry_date ? new Date(doc.expiry_date).toLocaleDateString() : 'N/A'}</td>
                <td>
                    <button class="btn btn-outline btn-sm" onclick="viewDocument('${doc.file_url}')" title="View" style="padding: 4px 8px; margin: 2px;">
                        View
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="deleteDocument(${doc.id})" title="Delete" style="padding: 4px 8px; margin: 2px;">
                        Delete
                    </button>
                </td>
            </tr>
        `).join('');

    } catch (error) {
        console.error('Error loading documents:', error);
    }
}

// Open participant modal (FIXED)
async function openParticipantModal(participantId = null) {
    currentParticipantId = participantId;
    const modal = document.getElementById('participantModal');
    const form = document.getElementById('participantForm');
    
    // Reset form and tabs
    form.reset();
    document.getElementById('participantId').value = participantId || '';
    
    // Reset to first tab
    document.querySelectorAll('.tab-btn').forEach((btn, index) => {
        btn.classList.toggle('active', index === 0);
    });
    document.querySelectorAll('.tab-content').forEach((content, index) => {
        content.style.display = index === 0 ? 'block' : 'none';
        content.classList.toggle('active', index === 0);
    });
    
    // Clear dynamic content
    document.getElementById('medicationsTableBody').innerHTML = '';
    document.getElementById('emergencyContactsList').innerHTML = '';
    document.getElementById('documentsTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center;">No documents uploaded</td></tr>';
    
    // Update title
    document.getElementById('participantModalTitle').textContent = participantId ? 'Edit Participant' : 'Add Participant';
    
    if (participantId) {
        await loadParticipantData(participantId);
    }
    
    // Show modal
    modal.style.display = 'flex';
    
    // Initialize autocomplete after modal is visible (only if Google Maps is loaded)
    if (window.googleMapsReady) {
        setTimeout(() => {
            initParticipantAutocomplete();
        }, 100);
    }
}

function getCurrentLocation() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Update form fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // Update map if initialized
            if (participantMap) {
                const pos = { lat, lng };
                participantMap.setCenter(pos);
                participantMarker.setPosition(pos);
                geofenceCircle.setCenter(pos);
            } else {
                initParticipantMap();
            }
            
            // NO LONGER LOGGING TO location_logs table
            alert('Location updated successfully');
        },
        (error) => {
            console.error('Error getting location:', error);
            alert('Failed to get current location');
        },
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

// Update geofence
function updateGeofence() {
    if (!geofenceCircle) return;
    const radius = parseInt(document.getElementById('geofenceRadius').value) || 100;
    geofenceCircle.setRadius(radius);
}


// ==================== DOCUMENT FUNCTIONS ====================

// Upload document
async function uploadDocument() {
    const fileInput = document.getElementById('documentFile');
    const documentType = document.getElementById('documentType').value;
    const documentName = document.getElementById('documentName').value;
    const documentExpiry = document.getElementById('documentExpiry').value;
    
    if (!fileInput.files[0]) {
        alert('Please select a file to upload');
        return;
    }
    
    if (!documentType || !documentName) {
        alert('Please provide document type and name');
        return;
    }
    
    try {
        const file = fileInput.files[0];
        const fileName = `${currentParticipantId}/${Date.now()}_${file.name}`;
        
        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
            .from('participant-documents')
            .upload(fileName, file);
        
        if (error) throw error;
        
        // Save document record
        const { error: docError } = await supabaseClient
            .from('participant_documents')
            .insert([{
                participant_id: currentParticipantId,
                document_type: documentType,
                document_name: documentName,
                file_url: data.path,
                expiry_date: documentExpiry || null,
                uploaded_by: getCurrentUserId(),
                uploaded_at: new Date().toISOString()
            }]);
        
        if (docError) throw docError;
        
        alert('Document uploaded successfully');
        
        // Reload documents
        await loadParticipantDocuments(currentParticipantId);
        
        // Clear form
        fileInput.value = '';
        document.getElementById('documentType').value = '';
        document.getElementById('documentName').value = '';
        document.getElementById('documentExpiry').value = '';
        
    } catch (error) {
        console.error('Error uploading document:', error);
        alert('Failed to upload document');
    }
}

// Load documents

// View document
async function viewDocument(fileUrl) {
    try {
        const { data } = supabaseClient.storage
            .from('participant-documents')
            .getPublicUrl(fileUrl);
        
        window.open(data.publicUrl, '_blank');
    } catch (error) {
        console.error('Error viewing document:', error);
        alert('Failed to open document');
    }
}

// Delete document
async function deleteDocument(documentId) {
    if (!confirm('Are you sure you want to delete this document?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('participant_documents')
            .delete()
            .eq('id', documentId);
        
        if (error) throw error;
        
        alert('Document deleted successfully');
        await loadParticipantDocuments(currentParticipantId);
        
    } catch (error) {
        console.error('Error deleting document:', error);
        alert('Failed to delete document');
    }
}

// Filter documents
function filterDocuments(searchTerm) {
    const rows = document.querySelectorAll('#documentsTableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
    });
}

// ==================== STAFF ASSIGNMENT FUNCTIONS ====================

async function loadAssignedStaff(participantId) {
    try {
        // First, load all staff for the dropdown
        const { data: staffData } = await supabaseClient
            .from('staff')
            .select('id, first_name, last_name')
            .order('first_name');
        
        if (staffData) {
            const staffSelect = document.getElementById('staffToAdd');
            if (staffSelect) {
                staffSelect.innerHTML = '<option value="">Select Staff</option>' +
                    staffData.map(staff => `
                        <option value="${staff.id}">${staff.first_name} ${staff.last_name}</option>
                    `).join('');
            }
        }
        
        // Try the existing table name first: staff_participant_assignments
        let assignmentData;
        let assignmentError;
        
        // Try staff_participant_assignments first (existing table)
        const result1 = await supabaseClient
            .from('staff_participant_assignments')
            .select('*, staff:staff_id(first_name, last_name)')
            .eq('participant_id', participantId)
            .eq('is_active', true);
        
        if (!result1.error) {
            assignmentData = result1.data;
        } else {
            // If that fails, try participant_staff_assignments (new table)
            const result2 = await supabaseClient
                .from('participant_staff_assignments')
                .select('*, staff:staff_id(first_name, last_name)')
                .eq('participant_id', participantId)
                .eq('is_active', true);
            
            if (!result2.error) {
                assignmentData = result2.data;
            } else {
                assignmentError = result1.error; // Use the first error
            }
        }
        
        if (assignmentError) {
            console.error('Error loading staff assignments:', assignmentError);
            // Don't throw - just show empty state
        }
        
        const tbody = document.getElementById('assignedStaffTable');
        if (!tbody) return;
        
        if (!assignmentData || assignmentData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No staff assigned</td></tr>';
            return;
        }
        
        tbody.innerHTML = assignmentData.map(assignment => `
            <tr>
                <td>${assignment.staff ? `${assignment.staff.first_name} ${assignment.staff.last_name}` : 'Unknown'}</td>
                <td>${assignment.role || 'Support Worker'}</td>
                <td>${assignment.is_primary ? 'Yes' : 'No'}</td>
                <td>
                    <button class="btn btn-outline btn-sm" onclick="removeStaffAssignment(${assignment.id})" title="Remove" style="padding: 4px 8px;">
                        Remove
                    </button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading staff assignments:', error);
    }
}

// Update assignStaff to try both table names
async function assignStaff() {
    const staffId = document.getElementById('staffToAdd').value;
    if (!staffId || !currentParticipantId) {
        alert('Please select a staff member');
        return;
    }
    
    try {
        // Try staff_participant_assignments first (existing table)
        let result = await supabaseClient
            .from('staff_participant_assignments')
            .insert([{
                participant_id: currentParticipantId,
                staff_id: staffId,
                role: 'Support Worker',
                is_primary: false,
                is_active: true
            }]);
        
        // If that fails, try participant_staff_assignments (new table)
        if (result.error && result.error.code === 'PGRST205') {
            result = await supabaseClient
                .from('participant_staff_assignments')
                .insert([{
                    participant_id: currentParticipantId,
                    staff_id: staffId,
                    role: 'Support Worker',
                    is_primary: false,
                    is_active: true
                }]);
        }
        
        if (result.error) throw result.error;
        
        await loadAssignedStaff(currentParticipantId);
        document.getElementById('staffToAdd').value = '';
        
    } catch (error) {
        console.error('Error assigning staff:', error);
        alert('Failed to assign staff: ' + error.message);
    }
}

// Update removeStaffAssignment to try both table names
async function removeStaffAssignment(assignmentId) {
    if (!confirm('Remove this staff assignment?')) return;
    
    try {
        // Try staff_participant_assignments first
        let result = await supabaseClient
            .from('staff_participant_assignments')
            .update({ is_active: false })
            .eq('id', assignmentId);
        
        // If that fails, try participant_staff_assignments
        if (result.error && result.error.code === 'PGRST205') {
            result = await supabaseClient
                .from('participant_staff_assignments')
                .update({ is_active: false })
                .eq('id', assignmentId);
        }
        
        if (result.error) throw result.error;
        
        await loadAssignedStaff(currentParticipantId);
        
    } catch (error) {
        console.error('Error removing assignment:', error);
        alert('Failed to remove assignment');
    }
}

// ==================== UTILITY FUNCTIONS ====================

// Get current user ID (implement based on your auth system)
function getCurrentUserId() {
    // Replace this with your actual auth implementation
    // For example:
    // return sessionStorage.getItem('userId');
    // or
    // return supabaseClient.auth.user()?.id;
    return 1; // Placeholder
}

// Format document type
function formatDocumentType(type) {
    const types = {
        'schedule_of_supports': 'Schedule of Supports',
        'care_plan': 'Care Plan',
        'behavior_support': 'Behavior Support Plan',
        'medical_report': 'Medical Report',
        'assessment': 'Assessment',
        'other': 'Other'
    };
    return types[type] || type;
}

// Format log type
function formatLogType(type) {
    const types = {
        'clock_in': 'Clock In',
        'clock_out': 'Clock Out',
        'transport': 'Transport',
        'manual': 'Manual Update'
    };
    return types[type] || type;
}

//UPDATE SHIFT
async function updateShift() {
    try {
        const shiftId = parseInt(document.getElementById('editShiftId').value);
        const date = document.getElementById('editShiftDate').value;
        const startTime = document.getElementById('editShiftStartTime').value;
        const endTime = document.getElementById('editShiftEndTime').value;
        const staffId = document.getElementById('editShiftStaff').value;
        const participantId = document.getElementById('editShiftParticipant').value || null;
        const locationId = document.getElementById('editShiftLocation').value || null;
        const dutyTypeId = document.getElementById('editShiftDutyType').value;
        const payRateId = document.getElementById('editShiftPayRate').value;
        const status = document.getElementById('editShiftStatus').value;
        const notes = document.getElementById('editShiftNotes').value;

        if (!date || !staffId || !dutyTypeId) {
            showNotification('Please fill required fields', 'error');
            return;
        }

        const updateData = {
            date,
            start_time: startTime || null,
            end_time: endTime || null,
            staff_id: staffId,
            participant_id: participantId,
            location_id: locationId,
            duty_type_id: dutyTypeId,
            status: status,
            notes: notes || null,
            updated_at: new Date().toISOString()
        };

        // Handle pay override - explicitly set it based on the selection
        if (payRateId && payRateId !== '') {
            // User selected a specific pay rate override
            updateData.pay_override_id = payRateId;
        } else {
            // User selected "Use Staff Default" - get staff's default rate
            const selectedStaff = staff.find(s => s.id === staffId);
            updateData.pay_override_id = selectedStaff?.pay_rate_id || '00000000-0000-0000-0000-000000000002';
        }

        // Calculate new duration
        const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeId);
        if (selectedDutyType?.name.toLowerCase().includes('sleepover')) {
            updateData.duration_hours = 2;
        } else if (startTime && endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            let end = new Date(`2000-01-01T${endTime}`);
            if (end <= start) end.setDate(end.getDate() + 1);
            updateData.duration_hours = (end - start) / (1000 * 60 * 60);
        }

        console.log('Updating shift with data:', updateData);

        const { error } = await supabaseClient
            .from('shifts')
            .update(updateData)
            .eq('id', shiftId);

        if (error) throw error;

        showNotification('Shift updated successfully', 'success');
        closeModal('editShiftModal');
        await loadShifts();

    } catch (error) {
        console.error('Error updating shift:', error);
        showNotification('Failed to update shift: ' + error.message, 'error');
    }
}

async function approveLeave(requestId) {
    try {
        // Get leave request details
        const { data: leave, error: fetchError } = await supabaseClient
            .from('leave_requests')
            .select('*')
            .eq('id', requestId)
            .single();
            
        if (fetchError || !leave) {
            throw new Error('Leave request not found');
        }
        
        // Update leave request status
        const { error: updateError } = await supabaseClient
            .from('leave_requests')
            .update({
                status: 'approved',
                approved_at: new Date().toISOString()  // ‚úÖ Added approved_at
            })
            .eq('id', requestId);
            
        if (updateError) throw updateError;
        
        // Create staff_availability records for the leave period
        const startDate = new Date(leave.start_date);
        const endDate = new Date(leave.end_date);
        const availabilityRecords = [];
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            availabilityRecords.push({
                staff_id: leave.staff_id,
                date: d.toISOString().split('T')[0],
                is_available: false,
                // ‚úÖ REMOVED: start_time and end_time (columns don't exist)
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            });
        }
        
        // Upsert availability records
        if (availabilityRecords.length > 0) {
            const { error: availError } = await supabaseClient
                .from('staff_availability')
                .upsert(availabilityRecords, {
                    onConflict: 'staff_id,date',
                    ignoreDuplicates: false
                });
                
            if (availError) {
                console.error('Error creating availability records:', availError);
                // Don't fail the whole operation - just log it
            }
        }
        
        showNotification('Leave approved successfully', 'success');
        
        // Refresh views
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving leave:', error);
        showNotification('Failed to approve leave: ' + error.message, 'error');
    }
}


async function rejectLeave(leaveId) {
    try {
        const { error } = await supabaseClient
            .from('leave_requests')
            .update({ 
                status: 'rejected',
                approved_at: new Date().toISOString()
            })
            .eq('id', leaveId);
        
        if (error) throw error;
        
        showNotification('Leave request rejected', 'info');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error rejecting leave:', error);
        showNotification('Failed to reject leave request', 'error');
    }
}
function formatDateFriendly(dateStr) {
    if (!dateStr) return 'Unknown';
    const date = new Date(dateStr);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-AU', options);
}

async function denyLeave(requestId) {
    try {
        const { error } = await supabaseClient
            .from('leave_requests')
            .update({
                status: 'rejected',
                updated_at: new Date().toISOString()
            })
            .eq('id', requestId);
            
        if (error) throw error;
        
        showNotification('Leave request denied', 'info');
        
        if (typeof renderRequests === 'function') {
            await renderRequests();
        }
        
    } catch (error) {
        console.error('Error denying leave:', error);
        showNotification('Failed to deny leave: ' + error.message, 'error');
    }
}


async function approveTransfer(requestId) {
    try {
        // Get the transfer request details
        const { data: request, error: fetchError } = await supabaseClient
            .from('transfer_requests')
            .select('*')
            .eq('id', requestId)
            .single();
        
        if (fetchError || !request) {
            throw new Error('Transfer request not found');
        }
        
        // Update the shift with new staff member if specified
        if (request.to_staff_id) {
            const { error: shiftError } = await supabaseClient
                .from('shifts')
                .update({
                    staff_id: request.to_staff_id,
                    updated_at: new Date().toISOString()
                })
                .eq('id', request.shift_id);
                
            if (shiftError) throw shiftError;
        } else {
            // If no target staff specified, unassign the shift
            const { error: shiftError } = await supabaseClient
                .from('shifts')
                .update({
                    staff_id: null,
                    updated_at: new Date().toISOString()
                })
                .eq('id', request.shift_id);
                
            if (shiftError) throw shiftError;
        }
        
        // Update request status
        const { error: requestError } = await supabaseClient
            .from('transfer_requests')
            .update({ 
                status: 'approved',
                updated_at: new Date().toISOString()
            })
            .eq('id', requestId);
            
        if (requestError) throw requestError;
        
        showNotification('Transfer approved successfully', 'success');
        
        // Refresh the view
        await renderRequests();
        
        // Refresh shifts if loaded
        if (typeof loadShifts === 'function') {
            await loadShifts();
        }
        
    } catch (error) {
        console.error('Error approving transfer:', error);
        showNotification('Failed to approve transfer: ' + error.message, 'error');
    }
}


async function denyTransfer(requestId) {
    try {
        const { error } = await supabaseClient
            .from('transfer_requests')
            .update({ 
                status: 'rejected',
                updated_at: new Date().toISOString()
            })
            .eq('id', requestId);
        
        if (error) throw error;
        
        showNotification('Transfer denied', 'info');
        await renderRequests();
        
    } catch (error) {
        console.error('Error denying transfer:', error);
        showNotification('Failed to deny transfer: ' + error.message, 'error');
    }
}
async function approveAdjustment(requestId) {
    try {
        // Get the adjustment request details
        const { data: request, error: fetchError } = await supabaseClient
            .from('shift_adjustment_requests')
            .select('*')
            .eq('id', requestId)
            .single();
        
        if (fetchError || !request) {
            throw new Error('Adjustment request not found');
        }
        
        // Update the shift with new times
        const updateData = {};
        if (request.new_start_time) {
            updateData.start_time = request.new_start_time;
        }
        if (request.new_end_time) {
            updateData.end_time = request.new_end_time;
        }
        updateData.updated_at = new Date().toISOString();
        
        const { error: shiftError } = await supabaseClient
            .from('shifts')
            .update(updateData)
            .eq('id', request.shift_id);
            
        if (shiftError) throw shiftError;

        // Update request status to approved
        const { error: requestError } = await supabaseClient
            .from('shift_adjustment_requests')
            .update({ 
                status: 'approved',
                approved_at: new Date().toISOString()
            })
            .eq('id', requestId);
            
        if (requestError) throw requestError;
        
        showNotification('Adjustment approved successfully', 'success');
        
        // Refresh views
        await renderRequests();
        
        // Refresh shifts if loaded
        if (typeof loadShifts === 'function') {
            await loadShifts();
        }
        
    } catch (error) {
        console.error('Error approving adjustment:', error);
        showNotification('Failed to approve adjustment: ' + error.message, 'error');
    }
}

async function denyAdjustment(requestId) {
    try {
        // Get the adjustment request to find the shift
        const { data: request, error: fetchError } = await supabaseClient
            .from('shift_adjustment_requests')
            .select('shift_id')
            .eq('id', requestId)
            .single();
        
        if (fetchError) throw fetchError;
        
        // Update the adjustment request status to rejected
        const { error } = await supabaseClient
            .from('shift_adjustment_requests')
            .update({ 
                status: 'rejected',
                approved_at: new Date().toISOString()  // This is in shift_adjustment_requests table
            })
            .eq('id', requestId);
        
        if (error) throw error;
        
        // Clear the shift's adjustment_status (don't update adjustment_approved_at)
        if (request.shift_id) {
            await supabaseClient
                .from('shifts')
                .update({
                    adjustment_status: null  // ‚úÖ ONLY update adjustment_status
                    // ‚ùå REMOVED: adjustment_approved_at (column doesn't exist in shifts table)
                })
                .eq('id', request.shift_id);
        }
        
        showNotification('Adjustment denied', 'info');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error denying adjustment:', error);
        showNotification('Failed to deny adjustment: ' + error.message, 'error');
    }
}

        async function renderAvailability() {
    const availabilityContent = document.getElementById('availabilityContent');
    if (!availabilityContent) {
        const availabilityView = document.getElementById('availabilityView');
        if (availabilityView) {
            availabilityView.innerHTML = `
                <div class="table-container">
                    <header class="table-header">
                        <h2 class="table-title">Staff Availability Management</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="showAvailabilityModal()">Set Availability</button>
                            <button class="btn btn-outline btn-sm" onclick="renderAvailability()">Refresh</button>
                        </div>
                    </header>
                    <div class="card-content" id="availabilityContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Loading availability...</span>
                        </div>
                    </div>
                </div>
            `;
        }
        return;
    }
    
    try {
        // Load staff availability for the current week
        const weekStart = getFortnightStart(new Date());
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        const { data: availability } = await supabaseClient
            .from('staff_availability')
            .select(`
                *,
                staff:staff_id(first_name, last_name)
            `)
            .gte('date', weekStart.toISOString().split('T')[0])
            .lte('date', weekEnd.toISOString().split('T')[0])
            .order('date');
        
        let html = `
            <style>
                .availability-grid {
                    display: grid;
                    grid-template-columns: 150px repeat(7, 1fr);
                    gap: 1px;
                    background: #e9ecef;
                    border-radius: 8px;
                    overflow: hidden;
                    margin-bottom: 24px;
                }
                
                .availability-cell {
                    background: white;
                    padding: 12px;
                    min-height: 50px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                }
                
                .availability-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    font-weight: 600;
                    font-size: 12px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .availability-name {
                    background: #f8f9fa;
                    font-weight: 500;
                    justify-content: flex-start;
                    padding-left: 16px;
                }
                
                .available {
                    background: #d4edda;
                    color: #155724;
                }
                
                .unavailable {
                    background: #f8d7da;
                    color: #721c24;
                }
                
                .partial {
                    background: #fff3cd;
                    color: #856404;
                }
            </style>
            
            <div class="availability-grid">
                <div class="availability-cell availability-header">Staff</div>
        `;
        
        // Add day headers
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        days.forEach((day, index) => {
            const date = new Date(weekStart);
            date.setDate(date.getDate() + index);
            html += `
                <div class="availability-cell availability-header">
                    ${day}<br>${date.getDate()}
                </div>
            `;
        });
        
        // Group availability by staff
        const staffAvailability = {};
        availability?.forEach(av => {
            const staffId = av.staff_id;
            if (!staffAvailability[staffId]) {
                staffAvailability[staffId] = {
                    staff: av.staff,
                    days: {}
                };
            }
            const dayIndex = new Date(av.date).getDay();
            staffAvailability[staffId].days[dayIndex] = av.available;
        });
        
        // Render each staff member's availability
        Object.values(staffAvailability).forEach(sa => {
            html += `<div class="availability-cell availability-name">${sa.staff.first_name} ${sa.staff.last_name}</div>`;
            
            for (let i = 0; i < 7; i++) {
                const dayIndex = i === 6 ? 0 : i + 1; // Adjust for Monday start
                const isAvailable = sa.days[dayIndex];
                const className = isAvailable === true ? 'available' : 
                                 isAvailable === false ? 'unavailable' : '';
                const text = isAvailable === true ? '‚úì' : 
                           isAvailable === false ? '‚úó' : '-';
                
                html += `<div class="availability-cell ${className}">${text}</div>`;
            }
        });
        
        html += '</div>';
        
        availabilityContent.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading availability:', error);
        availabilityContent.innerHTML = '<div class="error">Failed to load availability</div>';
    }
}


function renderShiftRow(shift, date) {  // <-- Remove async, back to regular function
    const staff = shift.staff || {};
    const participant = shift.participant || {};
    const location = shift.location || {};
    const dutyType = shift.duty_type || {};
    
    // REMOVE THE PROBLEMATIC QUERY - just set leave indicator to empty
    let leaveIndicator = '';
    // Removed the try-catch block with the staff_availability query that was causing 406
    
    // Get participant color
    const participantColor = getParticipantColor(shift.participant_id);
    
    // Check if this is a care home resident
    const isCareHomeResident = participant.address && 
        Array.from(careHomes.keys()).some(address => 
            participant.address.toLowerCase().includes(address)
        );
    
    // Client display with colored badge
    const clientDisplay = participant.first_name ? 
        `<span class="participant-badge" style="background: ${participantColor};">
            ${participant.first_name} ${participant.last_name}
            ${isCareHomeResident ? ' üè†' : ''}
        </span>` : 
        (location.name ? `<span class="location-badge">${location.name}</span>` : 'TBA');
    
    // Time display
    const timeDisplay = shift.start_time && shift.end_time ? 
        `${formatTime12Hour(shift.start_time)} - ${formatTime12Hour(shift.end_time)}` : 
        (shift.duty_type?.name?.toLowerCase().includes('sleepover') ? 'Sleepover' : '-');
    
    // Hours and pay with proper styling
    const hours = shift.calculated_hours?.total || 0;
    const pay = shift.calculated_pay || 0;
    
    // Determine if shift can be edited (based on role and status)
    const canEdit = currentUserRole !== 'staff' && shift.status !== 'completed';
    
    // Status badge
    let statusClass = 'badge-secondary';
    if (shift.status === 'confirmed') statusClass = 'badge-success';
    else if (shift.status === 'pending') statusClass = 'badge-warning';
    else if (shift.status === 'completed') statusClass = 'badge-info';
    else if (shift.status === 'cancelled') statusClass = 'badge-danger';
    
    const shiftActions = renderShiftActions(shift);
    
    return `
        <tr class="shift-row" data-shift-id="${shift.id}">
            <td>${formatDate(shift.date)}</td>
            <td class="time-cell">${timeDisplay}</td>
            <td>
                ${staff.first_name || ''} ${staff.last_name || ''}
                ${leaveIndicator}
            </td>
            <td>${clientDisplay}</td>
            <td>${location.name || participant.address || '-'}</td>
            <td>${dutyType.name || '-'}</td>
            <td><span class="badge ${statusClass}">${shift.status || 'pending'}</span></td>
            <td class="actions-cell">${shiftActions}</td>
        </tr>
    `;
}

// Keep renderTable as it was originally (no async, no await needed)
function renderTable() {
    const tbody = document.getElementById('shiftsTableBody');
    
    if (!tbody) {
        console.error('shiftsTableBody element not found');
        return;
    }
    
    if (filteredShifts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="empty-state">
                    <h3>No shifts found</h3>
                    <p>Try adjusting your date range or filters</p>
                    <button class="btn btn-outline btn-sm" onclick="clearAllFilters()">Clear Filters</button>
                    <button class="btn btn-primary btn-sm" onclick="showAddShiftModal()" style="margin-left: 12px;">Add Shift</button>
                </td>
            </tr>
        `;
        return;
    }

    // Group shifts by date
    const groupedShifts = groupShiftsByDate(filteredShifts);
    
    let html = '';
    
    Object.keys(groupedShifts).sort().forEach(date => {
        const dayShifts = groupedShifts[date];
        const dayStats = calculateDayStats(dayShifts);
        
        // Day header
        html += `
            <tr class="day-header">
                <td colspan="8">
                    ${formatDateLong(date)} 
                    <span class="day-stats">
                        ${dayStats.shifts} shifts | ${formatHours(dayStats.totalHours)}h | $${dayStats.totalPay.toFixed(2)}
                    </span>
                </td>
            </tr>
        `;
        
        for (const shift of dayShifts) {
            html += renderShiftRow(shift, date);  // No await needed anymore
        }
    });

    tbody.innerHTML = html;
}


async function renderAvailability() {
    const availabilityContent = document.getElementById('availabilityContent');
    if (!availabilityContent) {
        const availabilityView = document.getElementById('availabilityView');
        if (availabilityView) {
            availabilityView.innerHTML = `
                <div class="table-container">
                    <header class="table-header">
                        <h2 class="table-title">Staff Availability & Leave</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="showAvailabilityModal()">Set Availability</button>
                            <button class="btn btn-outline btn-sm" onclick="renderAvailability()">Refresh</button>
                        </div>
                    </header>
                    <div class="card-content" id="availabilityContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Loading availability...</span>
                        </div>
                    </div>
                </div>
            `;
            availabilityContent = document.getElementById('availabilityContent');
        }
    }
    
    if (!availabilityContent) return;
    
    try {
        // Get current week dates
        const weekStart = new Date(currentWeekStart);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        // FIX #5: Load leave data for the week
        const { data: weekLeave } = await supabaseClient
            .from('staff_availability')
            .select('*, staff:staff_id(first_name, last_name)')
            .gte('date', weekStart.toISOString().split('T')[0])
            .lte('date', weekEnd.toISOString().split('T')[0])
            .eq('is_available', false)
            .order('date');
        
        // Load regular availability patterns
        const { data: availabilityPatterns } = await supabaseClient
            .from('staff_weekly_availability')
            .select('*, staff:staff_id(first_name, last_name)')
            .order('staff_id, day_of_week');
        
        // Build enhanced availability view
        let html = `
            <style>
                .availability-wrapper {
                    background: white;
                    border-radius: var(--radius-lg);
                    overflow: hidden;
                    margin-bottom: 20px;
                }
                .availability-tabs {
                    display: flex;
                    background: var(--bg-light);
                    border-bottom: 2px solid var(--border-color);
                }
                .availability-tab {
                    flex: 1;
                    padding: 15px;
                    text-align: center;
                    cursor: pointer;
                    background: transparent;
                    border: none;
                    font-weight: 500;
                    transition: all 0.3s;
                }
                .availability-tab.active {
                    background: white;
                    border-bottom: 3px solid var(--primary-color);
                    color: var(--primary-color);
                }
                .availability-content {
                    padding: 20px;
                }
                .week-grid {
                    display: grid;
                    grid-template-columns: repeat(7, 1fr);
                    gap: 10px;
                    margin-top: 20px;
                }
                .day-card {
                    background: white;
                    border: 1px solid var(--border-color);
                    border-radius: 8px;
                    min-height: 200px;
                    overflow: hidden;
                }
                .day-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px;
                    text-align: center;
                }
                .day-header.weekend {
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                }
                .day-date {
                    font-size: 11px;
                    opacity: 0.9;
                }
                .day-name {
                    font-weight: 600;
                    font-size: 14px;
                }
                .day-content {
                    padding: 12px;
                    max-height: 150px;
                    overflow-y: auto;
                }
                .leave-indicator {
                    margin-bottom: 8px;
                    padding: 8px;
                    border-radius: 6px;
                    font-size: 12px;
                    background: var(--bg-light);
                    border-left: 3px solid;
                }
                .leave-indicator.annual {
                    border-color: #17a2b8;
                    background: #d1ecf1;
                }
                .leave-indicator.sick {
                    border-color: #dc3545;
                    background: #f8d7da;
                }
                .leave-indicator.personal {
                    border-color: #ffc107;
                    background: #fff3cd;
                }
                .leave-indicator.other {
                    border-color: #6c757d;
                    background: #e2e3e5;
                }
                .staff-name {
                    font-weight: 600;
                    color: var(--text-primary);
                }
                .leave-type {
                    font-size: 10px;
                    text-transform: uppercase;
                    opacity: 0.8;
                }
                .availability-summary {
                    background: var(--bg-light);
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                }
                .summary-stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 15px;
                }
                .stat-item {
                    text-align: center;
                }
                .stat-value {
                    font-size: 24px;
                    font-weight: 700;
                    color: var(--primary-color);
                }
                .stat-label {
                    font-size: 12px;
                    color: var(--text-muted);
                    text-transform: uppercase;
                }
            </style>
            
            <div class="availability-wrapper">
                <div class="availability-tabs">
                    <button class="availability-tab active" onclick="switchAvailabilityView('week')">
                        Week View
                    </button>
                    <button class="availability-tab" onclick="switchAvailabilityView('staff')">
                        Staff Patterns
                    </button>
                    <button class="availability-tab" onclick="switchAvailabilityView('summary')">
                        Summary
                    </button>
                </div>
                
                <div class="availability-content">
                    <div id="weekView">
                        <h3>Week of ${formatDateShort(weekStart.toISOString())}</h3>
                        
                        <div class="availability-summary">
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <div class="stat-value">${staff.length}</div>
                                    <div class="stat-label">Total Staff</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${weekLeave ? weekLeave.length : 0}</div>
                                    <div class="stat-label">On Leave</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${staff.length - (weekLeave ? weekLeave.length : 0)}</div>
                                    <div class="stat-label">Available</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="week-grid">
        `;
        
        // Create day cards
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        for (let day = 0; day < 7; day++) {
            const currentDate = new Date(weekStart);
            currentDate.setDate(currentDate.getDate() + day);
            const dateStr = currentDate.toISOString().split('T')[0];
            const dayName = dayNames[currentDate.getDay()];
            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
            
            // Get leave for this day
            const dayLeave = weekLeave ? weekLeave.filter(l => l.date === dateStr) : [];
            
            html += `
                <div class="day-card" data-date="${dateStr}">
                    <div class="day-header ${isWeekend ? 'weekend' : ''}">
                        <div class="day-name">${dayName}</div>
                        <div class="day-date">${formatDateShort(dateStr)}</div>
                    </div>
                    <div class="day-content">
            `;
            
            if (dayLeave.length > 0) {
                dayLeave.forEach(leave => {
                    const leaveType = leave.reason || 'Leave';
                    let typeClass = 'other';
                    if (leaveType.toLowerCase().includes('annual')) typeClass = 'annual';
                    else if (leaveType.toLowerCase().includes('sick')) typeClass = 'sick';
                    else if (leaveType.toLowerCase().includes('personal')) typeClass = 'personal';
                    
                    html += `
                        <div class="leave-indicator ${typeClass}">
                            <div class="staff-name">
                                ${leave.staff.first_name} ${leave.staff.last_name}
                            </div>
                            <div class="leave-type">${leaveType}</div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="text-align: center; padding: 40px 10px; color: var(--text-muted);">
                        <div style="font-size: 24px; margin-bottom: 5px;">‚úÖ</div>
                        <div style="font-size: 12px;">All Available</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        
        html += `
                        </div>
                    </div>
                    
                    <div id="staffView" style="display: none;">
                        <h3>Staff Availability Patterns</h3>
                        <div style="margin-top: 20px;">
                            <!-- Staff patterns will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="summaryView" style="display: none;">
                        <h3>Availability Summary</h3>
                        <div style="margin-top: 20px;">
                            <!-- Summary statistics will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="availability-legend" style="margin-top: 20px; padding: 15px; background: var(--bg-light); border-radius: 8px;">
                <strong>Legend:</strong>
                <span class="badge badge-info" style="margin: 0 5px;">Annual Leave</span>
                <span class="badge badge-danger" style="margin: 0 5px;">Sick Leave</span>
                <span class="badge badge-warning" style="margin: 0 5px;">Personal Leave</span>
                <span class="badge badge-secondary" style="margin: 0 5px;">Other</span>
            </div>
        `;
        
        availabilityContent.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading availability:', error);
        availabilityContent.innerHTML = '<div class="error">Failed to load availability data</div>';
    }
}

// This goes in the modal HTML structure - add after participant select
function getAddShiftModalTemplateHTML() {
    return `
        <div class="form-group" id="templateGroup" style="display: none;">
            <label>Use Template (Optional)</label>
            <select id="shiftTemplate" class="form-control" onchange="applyShiftTemplate(this.value)">
                <option value="">-- Select Template --</option>
            </select>
            <small class="form-text text-muted">
                Templates provide pre-filled shift settings for this participant
            </small>
        </div>
    `;
}
// Helper function to switch availability views
function switchAvailabilityView(view) {
    // Update tab active states
    document.querySelectorAll('.availability-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show/hide views
    document.getElementById('weekView').style.display = view === 'week' ? 'block' : 'none';
    document.getElementById('staffView').style.display = view === 'staff' ? 'block' : 'none';
    document.getElementById('summaryView').style.display = view === 'summary' ? 'block' : 'none';
}


function showOverlapTooltip(event, shiftId) {
    // Implementation for hover tooltip showing overlap details
    const tooltip = document.createElement('div');
    tooltip.className = 'overlap-tooltip';
    tooltip.id = 'overlapTooltip';
    
    const shift = shifts.find(s => s.id === shiftId);
    if (shift?.overlap_info) {
        tooltip.innerHTML = `
            <strong>${shift.overlap_info.ratio} Care Ratio</strong><br>
            ${shift.overlap_info.staff.map(s => 
                `${s.staff.first_name} ${s.staff.last_name}: ${s.time}`
            ).join('<br>')}
        `;
        
        tooltip.style.position = 'absolute';
        tooltip.style.left = event.pageX + 10 + 'px';
        tooltip.style.top = event.pageY + 10 + 'px';
        
        document.body.appendChild(tooltip);
    }
}

function hideOverlapTooltip() {
    const tooltip = document.getElementById('overlapTooltip');
    if (tooltip) tooltip.remove();
}

function renderShiftActions(shift) {
    let actions = [];
    
    // Admin/Manager can edit any shift
    if (currentUserRole === 'admin' || currentUserRole === 'manager') {
        actions.push(`<button class="btn btn-outline btn-sm" onclick="editShift(${shift.id})">Edit</button>`);
        actions.push(`<button class="btn btn-danger btn-sm" onclick="deleteShiftConfirm(${shift.id})">Delete</button>`);
    }
    
    // All users can add notes - Updated to call showAddNoteModal directly
    actions.push(`<button class="btn btn-outline btn-sm" onclick="showAddNoteModal(${shift.id})">Note</button>`);
    
    return actions.join('');
}

        function groupShiftsByDate(shifts) {
            const groups = {};
            shifts.forEach(shift => {
                if (!groups[shift.date]) {
                    groups[shift.date] = [];
                }
                groups[shift.date].push(shift);
            });
            return groups;
        }

        function calculateDayStats(dayShifts) {
            return dayShifts.reduce((stats, shift) => {
                const hours = shift.calculated_hours || { total: 0 };
                stats.shifts++;
                stats.totalHours += hours.total;
                stats.totalPay += shift.calculated_pay || 0;
                return stats;
            }, { shifts: 0, totalHours: 0, totalPay: 0 });
        }

        function generateHourBreakdownTooltip(hours) {
            const parts = [];
            if (hours.weekdayDay > 0) parts.push(`Day: ${formatHours(hours.weekdayDay)}h`);
            if (hours.weekdayEvening > 0) parts.push(`Evening: ${formatHours(hours.weekdayEvening)}h`);
            if (hours.weekdayNight > 0) parts.push(`Night: ${formatHours(hours.weekdayNight)}h`);
            if (hours.saturday > 0) parts.push(`Saturday: ${formatHours(hours.saturday)}h`);
            if (hours.sunday > 0) parts.push(`Sunday: ${formatHours(hours.sunday)}h`);
            if (hours.publicHoliday > 0) parts.push(`Holiday: ${formatHours(hours.publicHoliday)}h`);
            if (hours.sleepover > 0) parts.push(`Sleepover: ${formatHours(hours.sleepover)}h`);
            
            return parts.join(' | ') || 'No breakdown available';
        }

        function generatePayBreakdownDisplay(hours) {
            const parts = [];
            if (hours.weekdayDay > 0) parts.push(`D:${formatHours(hours.weekdayDay)}`);
            if (hours.weekdayEvening > 0) parts.push(`E:${formatHours(hours.weekdayEvening)}`);
            if (hours.weekdayNight > 0) parts.push(`N:${formatHours(hours.weekdayNight)}`);
            if (hours.saturday > 0) parts.push(`Sa:${formatHours(hours.saturday)}`);
            if (hours.sunday > 0) parts.push(`Su:${formatHours(hours.sunday)}`);
            if (hours.publicHoliday > 0) parts.push(`PH:${formatHours(hours.publicHoliday)}`);
            if (hours.sleepover > 0) parts.push(`SL:${formatHours(hours.sleepover)}`);
            
            return parts.join(' ‚Ä¢ ') || '‚Äî';
        }


        function createSearchableDropdown(selectId, options = {}) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'searchable-dropdown-wrapper';
    wrapper.style.position = 'relative';
    
    // Create search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control searchable-input';
    searchInput.placeholder = options.placeholder || 'Type to search...';
    searchInput.style.cssText = `
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    `;
    
    // Create dropdown list
    const dropdownList = document.createElement('div');
    dropdownList.className = 'searchable-dropdown-list';
    dropdownList.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        display: none;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    
    // Store selected value
    let selectedValue = select.value;
    let selectedText = '';
    
    // Get options from original select
    const originalOptions = Array.from(select.options).map(opt => ({
        value: opt.value,
        text: opt.textContent,
        data: opt.dataset
    }));
    
    // Function to update dropdown list
    function updateDropdownList(searchTerm = '') {
        dropdownList.innerHTML = '';
        
        const filtered = originalOptions.filter(opt => 
            opt.text.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        if (filtered.length === 0) {
            dropdownList.innerHTML = '<div style="padding: 8px; color: #999;">No results found</div>';
            return;
        }
        
        filtered.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                transition: background 0.2s;
            `;
            item.textContent = opt.text;
            item.dataset.value = opt.value;
            
            // Copy any data attributes
            Object.keys(opt.data || {}).forEach(key => {
                item.dataset[key] = opt.data[key];
            });
            
            item.onmouseover = () => item.style.background = '#f0f0f0';
            item.onmouseout = () => item.style.background = 'white';
            
            item.onclick = () => {
                selectedValue = opt.value;
                selectedText = opt.text;
                searchInput.value = opt.text;
                select.value = opt.value;
                
                // Trigger change event on original select
                const event = new Event('change', { bubbles: true });
                select.dispatchEvent(event);
                
                dropdownList.style.display = 'none';
            };
            
            dropdownList.appendChild(item);
        });
    }
    
    // Event handlers
    searchInput.onfocus = () => {
        updateDropdownList('');
        dropdownList.style.display = 'block';
    };
    
    searchInput.oninput = (e) => {
        updateDropdownList(e.target.value);
        dropdownList.style.display = 'block';
    };
    
    // Click outside to close
    document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // Set initial value
    if (select.value) {
        const initial = originalOptions.find(opt => opt.value === select.value);
        if (initial) {
            searchInput.value = initial.text;
            selectedText = initial.text;
        }
    }
    
    // Replace select with wrapper
    select.style.display = 'none';
    wrapper.appendChild(searchInput);
    wrapper.appendChild(dropdownList);
    select.parentNode.insertBefore(wrapper, select.nextSibling);
    
    // Store reference for later updates
    select._searchableDropdown = {
        update: () => updateDropdownList(''),
        setValue: (value) => {
            const opt = originalOptions.find(o => o.value === value);
            if (opt) {
                selectedValue = opt.value;
                selectedText = opt.text;
                searchInput.value = opt.text;
                select.value = opt.value;
            }
        },
        getValue: () => selectedValue
    };
    
    return select._searchableDropdown;
}

async function populateEditModalDropdowns(shift = null) {
    try {
        // Ensure reference data is loaded
        if (!participants.length || !staff.length) {
            await loadReferenceData();
        }
        
        // Staff dropdown
        const staffSelect = document.getElementById('editStaff');
        if (staffSelect) {
            staffSelect.innerHTML = '<option value="">Select Staff</option>';
            staff.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.first_name} ${s.last_name}`;
                if (shift && shift.staff_id === s.id) {
                    option.selected = true;
                }
                staffSelect.appendChild(option);
            });
            
            // Make it searchable
            createSearchableDropdown('editStaff', {
                placeholder: 'Type to search staff...'
            });
        }
        
        // Participant dropdown
        const participantSelect = document.getElementById('editParticipant');
        if (participantSelect) {
            participantSelect.innerHTML = '<option value="">Select Client</option>';
            participants.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.first_name} ${p.last_name}`;
                if (shift && shift.participant_id === p.id) {
                    option.selected = true;
                }
                participantSelect.appendChild(option);
            });
            
            // Make it searchable
            createSearchableDropdown('editParticipant', {
                placeholder: 'Type to search client...'
            });
        }
        
        // Location dropdown
        const locationSelect = document.getElementById('editLocation');
        if (locationSelect) {
            locationSelect.innerHTML = '<option value="">Select Location</option>';
            
            // Add default Client Home option
            const clientHome = document.createElement('option');
            clientHome.value = '00000000-0000-0000-0000-000000000001';
            clientHome.textContent = 'Client Home';
            locationSelect.appendChild(clientHome);
            
            locations.forEach(l => {
                if (l.id !== '00000000-0000-0000-0000-000000000001') {
                    const option = document.createElement('option');
                    option.value = l.id;
                    option.textContent = l.name;
                    if (shift && shift.location_id === l.id) {
                        option.selected = true;
                    }
                    locationSelect.appendChild(option);
                }
            });
            
            // Make it searchable
            createSearchableDropdown('editLocation', {
                placeholder: 'Type to search location...'
            });
        }
        
        // Duty Type dropdown
        const dutyTypeSelect = document.getElementById('editDutyType');
        if (dutyTypeSelect) {
            dutyTypeSelect.innerHTML = '<option value="">Select Duty Type</option>';
            dutyTypes.forEach(dt => {
                const option = document.createElement('option');
                option.value = dt.id;
                option.textContent = dt.name;
                if (shift && shift.duty_type_id === dt.id) {
                    option.selected = true;
                }
                dutyTypeSelect.appendChild(option);
            });
            
            // Make it searchable
            createSearchableDropdown('editDutyType', {
                placeholder: 'Type to search duty type...'
            });
        }
        
    } catch (error) {
        console.error('Error populating modal dropdowns:', error);
        showToast('Failed to load dropdown options', 'error');
    }
}


// ==========================================
// COMPLETE TEMPLATE MANAGEMENT SYSTEM
// ==========================================
// DAY CONVERSION HELPERS
// ==========================================

function uiDayToDbDay(uiDay) {
    // UI: 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat, 7=Sun
    // DB: 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat
    if (uiDay === 7) return 0; // Sunday
    return uiDay; // Monday-Saturday map directly
}

function dbDayToUiDay(dbDay) {
    // DB: 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat  
    // UI: 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat, 7=Sun
    if (dbDay === 0) return 7; // Sunday
    return dbDay; // Monday-Saturday map directly
}

// ==========================================
// LOADING AND RENDERING TEMPLATES
// ==========================================

async function loadTemplates() {
    try {
        const { data: templates, error } = await supabaseClient
            .from('roster_templates')
            .select(`
                *,
                participant:participant_id(first_name, last_name),
                creator:created_by(first_name, last_name),
                roster_template_shifts(*)
            `)
            .eq('is_active', true)
            .order('created_at', { ascending: false });

        if (error) throw error;
        
        rosterTemplates = templates || [];
        renderTemplates();
    } catch (error) {
        console.error('Error loading templates:', error);
        showNotification('Failed to load templates', 'error');
    }
}

function renderTemplates() {
    const container = document.getElementById('templatesContent');
    if (!container) return;
    
    if (rosterTemplates.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-light);">
                <h3>No templates created yet</h3>
                <p>Create your first roster template to get started with auto-rostering</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = rosterTemplates.map(template => `
        <div class="template-item" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div>
                    <h3 style="margin: 0; color: var(--text-primary);">${template.name}</h3>
                    <p style="margin: 4px 0; color: var(--text-muted); font-size: 14px;">
                        ${template.participant ? `For: ${template.participant.first_name} ${template.participant.last_name}` : 'General Template'}
                    </p>
                    ${template.description ? `<p style="margin: 4px 0; color: var(--text-secondary); font-size: 14px;">${template.description}</p>` : ''}
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary btn-sm" onclick="showApplyTemplateModal('${template.id}')">
                        Apply Template
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="editTemplate('${template.id}')">
                        Edit
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="duplicateTemplate('${template.id}')">
                        Duplicate
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${template.id}')">
                        Delete
                    </button>
                </div>
            </div>
            <div style="margin-top: 12px;">
                ${renderTemplateWeekPreview(template)}
            </div>
        </div>
    `).join('');
}

function renderTemplateWeekPreview(template) {
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const shifts = template.roster_template_shifts || [];
    
    let preview = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 12px;">';
    
    days.forEach((day, index) => {
        const uiDay = index + 1; // 1-7 for Mon-Sun
        const dbDay = uiDayToDbDay(uiDay);
        const dayShifts = shifts.filter(s => s.day_of_week === dbDay);
        const isWeekend = index >= 5;
        
        preview += `
            <div style="background: ${isWeekend ? '#f8f9fa' : 'white'}; border: 1px solid var(--border-light); border-radius: 4px; padding: 8px;">
                <div style="font-weight: 600; font-size: 12px; margin-bottom: 4px; color: var(--text-muted);">${day}</div>
                ${dayShifts.length > 0 ? 
                    dayShifts.map(shift => `
                        <div style="background: var(--primary-color); color: white; padding: 2px 4px; border-radius: 2px; font-size: 11px; margin-bottom: 2px;">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'}-${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                    `).join('') : 
                    '<div style="color: var(--text-light); font-size: 11px;">No shifts</div>'
                }
            </div>
        `;
    });
    
    preview += '</div>';
    return preview;
}

// ==========================================
// MAIN TEMPLATE CRUD FUNCTIONS
// ==========================================

async function saveTemplate() {
    try {
        const name = document.getElementById('templateName').value;
        const participantId = document.getElementById('templateParticipant').value || null;
        const description = document.getElementById('templateDescription').value || null;
        
        if (!name) {
            showNotification('Please enter a template name', 'warning');
            return;
        }
        
        // Collect shifts from UI for validation
        const shiftsToValidate = [];
        for (let uiDay = 1; uiDay <= 7; uiDay++) {
            const dayContainer = document.getElementById(`day_${uiDay}_shifts`);
            if (!dayContainer) continue;
            
            const shiftElements = dayContainer.querySelectorAll('[id^="shift_"]');
            
            shiftElements.forEach(shiftEl => {
                const startTime = shiftEl.querySelector('[data-field="start_time"]')?.value;
                const endTime = shiftEl.querySelector('[data-field="end_time"]')?.value;
                const staffId = shiftEl.querySelector('[data-field="staff_id"]')?.value;
                const dutyTypeId = shiftEl.querySelector('[data-field="duty_type_id"]')?.value;
                const locationId = shiftEl.querySelector('[data-field="location_id"]')?.value;
                const notes = shiftEl.querySelector('[data-field="notes"]')?.value;
                
                if (startTime || endTime) {
                    shiftsToValidate.push({
                        day_of_week: uiDayToDbDay(uiDay),
                        start_time: startTime || null,
                        end_time: endTime || null,
                        staff_id: staffId && staffId !== '' ? staffId : null, // FIX HERE
                        duty_type_id: dutyTypeId || null,
                        location_id: locationId || null,
                        notes: notes || null,
                        ui_day: uiDay
                    });
                }
            });
        }

        // Check for conflicts within the template itself
        const templateConflicts = checkTemplateInternalConflicts(shiftsToValidate);
        
        if (templateConflicts.length > 0) {
            const shouldContinue = await showTemplateConflictDialog(templateConflicts, 'save');
            if (!shouldContinue) {
                return;
            }
        }
        
        // Create template
        const { data: template, error: templateError } = await supabaseClient
            .from('roster_templates')
            .insert({
                name: name,
                participant_id: participantId,
                description: description,
                is_active: true,
                created_by: currentStaffData?.id || currentUser?.id || null
            })
            .select()
            .single();
        
        if (templateError) throw templateError;
        
        // Prepare shifts for insertion
        const shiftsToInsert = shiftsToValidate.map(shift => ({
            template_id: template.id,
            day_of_week: shift.day_of_week,
            start_time: shift.start_time,
            end_time: shift.end_time,
            staff_id: shift.staff_id,
            duty_type_id: shift.duty_type_id,
            location_id: shift.location_id,
            notes: shift.notes
        }));
        
        if (shiftsToInsert.length > 0) {
            const { error: shiftsError } = await supabaseClient
                .from('roster_template_shifts')
                .insert(shiftsToInsert);
            
            if (shiftsError) throw shiftsError;
        }
        
        showNotification('Template created successfully', 'success');
        document.querySelector('.modal-overlay')?.remove();
        await loadTemplates();
        
    } catch (error) {
        console.error('Error saving template:', error);
        showNotification('Failed to save template', 'error');
    }
}

async function updateTemplate(templateId) {
    try {
        const name = document.getElementById('templateName').value;
        const participantId = document.getElementById('templateParticipant').value;
        const description = document.getElementById('templateDescription').value;
        
        if (!name) {
            showNotification('Please enter a template name', 'warning');
            return;
        }
        
        // Collect shifts from UI for validation
        const shiftsToValidate = [];
        for (let uiDay = 1; uiDay <= 7; uiDay++) {
            const dayContainer = document.getElementById(`day_${uiDay}_shifts`);
            if (!dayContainer) continue;
            
            const shiftElements = dayContainer.querySelectorAll('[id^="shift_"]');
            
            shiftElements.forEach(shiftEl => {
                const startTime = shiftEl.querySelector('[data-field="start_time"]')?.value;
                const endTime = shiftEl.querySelector('[data-field="end_time"]')?.value;
                const staffId = shiftEl.querySelector('[data-field="staff_id"]')?.value;
                const dutyTypeId = shiftEl.querySelector('[data-field="duty_type_id"]')?.value;
                const locationId = shiftEl.querySelector('[data-field="location_id"]')?.value;
                const notes = shiftEl.querySelector('[data-field="notes"]')?.value;
                
                if (startTime || endTime) {
                    shiftsToValidate.push({
                        day_of_week: uiDayToDbDay(uiDay),
                        start_time: startTime || null,
                        end_time: endTime || null,
                        staff_id: staffId || null,
                        duty_type_id: dutyTypeId || null,
                        location_id: locationId || null,
                        notes: notes || null,
                        ui_day: uiDay
                    });
                }
            });
        }
        
        // Check for conflicts within the template itself
        const templateConflicts = checkTemplateInternalConflicts(shiftsToValidate);
        
        if (templateConflicts.length > 0) {
            const shouldContinue = await showTemplateConflictDialog(templateConflicts, 'update');
            if (!shouldContinue) {
                return;
            }
        }
        
        // Update template
        const { error: updateError } = await supabaseClient
            .from('roster_templates')
            .update({
                name: name,
                participant_id: participantId || null,
                description: description || null,
                updated_at: new Date().toISOString()
            })
            .eq('id', templateId);
        
        if (updateError) throw updateError;
        
        // Delete existing shifts and recreate
        await supabaseClient
            .from('roster_template_shifts')
            .delete()
            .eq('template_id', templateId);
        
        // Prepare shifts for insertion
        const shiftsToInsert = shiftsToValidate.map(shift => ({
            template_id: templateId,
            day_of_week: shift.day_of_week,
            start_time: shift.start_time,
            end_time: shift.end_time,
            staff_id: shift.staff_id,
            duty_type_id: shift.duty_type_id,
            location_id: shift.location_id,
            notes: shift.notes
        }));
        
        if (shiftsToInsert.length > 0) {
            const { error: shiftsError } = await supabaseClient
                .from('roster_template_shifts')
                .insert(shiftsToInsert);
            
            if (shiftsError) throw shiftsError;
        }
        
        showNotification('Template updated successfully', 'success');
        document.querySelector('.modal-overlay')?.remove();
        loadTemplates();
        
    } catch (error) {
        console.error('Error updating template:', error);
        showNotification('Failed to update template', 'error');
    }
}

async function editTemplate(templateId) {
    const template = rosterTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    openCreateTemplateModal(() => {
  populateTemplateFields(template);
});    
    setTimeout(() => {
        document.getElementById('templateName').value = template.name;
        document.getElementById('templateParticipant').value = template.participant_id || '';
        document.getElementById('templateDescription').value = template.description || '';
        
        // Trigger participant change to update staff dropdowns
        onTemplateParticipantChange(template.participant_id);
        
        // Populate existing shifts
        template.roster_template_shifts.forEach(shift => {
            const uiDay = dbDayToUiDay(shift.day_of_week);
            addShiftToDay(uiDay);
            
            const dayContainer = document.getElementById(`day_${uiDay}_shifts`);
            const lastShift = dayContainer.lastElementChild;
            if (lastShift) {
                lastShift.querySelector('[data-field="start_time"]').value = shift.start_time || '';
                lastShift.querySelector('[data-field="end_time"]').value = shift.end_time || '';
                lastShift.querySelector('[data-field="staff_id"]').value = shift.staff_id || '';
                lastShift.querySelector('[data-field="duty_type_id"]').value = shift.duty_type_id || '';
                lastShift.querySelector('[data-field="location_id"]').value = shift.location_id || '';
                lastShift.querySelector('[data-field="notes"]').value = shift.notes || '';
            }
        });
        
        const saveBtn = document.querySelector('.modal-footer .btn-primary');
        saveBtn.textContent = 'Update Template';
        saveBtn.onclick = () => updateTemplate(templateId);
    }, 100);
}

async function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template? This cannot be undone.')) {
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('roster_templates')
            .delete()
            .eq('id', templateId);
        
        if (error) throw error;
        
        showNotification('Template deleted successfully', 'success');
        loadTemplates();
        
    } catch (error) {
        console.error('Error deleting template:', error);
        showNotification('Failed to delete template', 'error');
    }
}

async function duplicateTemplate(templateId) {
    try {
        const template = rosterTemplates.find(t => t.id === templateId);
        if (!template) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal" style="max-width: 500px;">
                <header class="modal-header">
                    <h3 class="modal-title">Duplicate Template</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </header>
                <div class="modal-content">
                    <div class="form-group">
                        <label>New Template Name *</label>
                        <input type="text" id="duplicateName" class="form-control" 
                               value="${template.name} (Copy)" 
                               placeholder="Enter name for the duplicated template">
                    </div>
                    
                    <div class="form-group">
                        <label>Assign to Different Participant?</label>
                        <select id="duplicateParticipant" class="form-control">
                            <option value="${template.participant_id || ''}">
                                ${template.participant_id ? 
                                    `Keep same (${template.participant?.first_name} ${template.participant?.last_name})` : 
                                    'Keep as general template'}
                            </option>
                            <option value="">General Template (No specific participant)</option>
                            ${participants.map(p => 
                                `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="duplicateModifyShifts">
                            Modify shifts after duplication
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                    <button class="btn btn-primary" onclick="executeDuplicateTemplate('${templateId}', this)">
                        Create Duplicate
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error in duplicateTemplate:', error);
        showNotification('Failed to duplicate template', 'error');
    }
}

async function executeDuplicateTemplate(templateId, button) {
    try {
        const modal = button.closest('.modal-overlay');
        const template = rosterTemplates.find(t => t.id === templateId);
        if (!template) throw new Error('Template not found');
        
        const newName = document.getElementById('duplicateName').value;
        const newParticipantId = document.getElementById('duplicateParticipant').value;
        const modifyAfter = document.getElementById('duplicateModifyShifts').checked;
        
        if (!newName) {
            showNotification('Please enter a name for the duplicated template', 'warning');
            return;
        }
        
        const { data: newTemplate, error: templateError } = await supabaseClient
            .from('roster_templates')
            .insert({
                name: newName,
                participant_id: newParticipantId || null,
                description: template.description,
                created_by: currentStaffData?.id || null,
                is_active: true
            })
            .select()
            .single();
        
        if (templateError) throw templateError;
        
        const shiftsToInsert = template.roster_template_shifts.map(shift => ({
            template_id: newTemplate.id,
            day_of_week: shift.day_of_week,
            start_time: shift.start_time,
            end_time: shift.end_time,
            staff_id: shift.staff_id,
            duty_type_id: shift.duty_type_id,
            location_id: shift.location_id,
            notes: shift.notes
        }));
        
        if (shiftsToInsert.length > 0) {
            const { error: shiftsError } = await supabaseClient
                .from('roster_template_shifts')
                .insert(shiftsToInsert);
            
            if (shiftsError) throw shiftsError;
        }
        
        showNotification('Template duplicated successfully', 'success');
        modal.remove();
        
        if (modifyAfter) {
            setTimeout(() => {
                editTemplate(newTemplate.id);
            }, 500);
        }
        
        loadTemplates();
        
    } catch (error) {
        console.error('Error duplicating template:', error);
        showNotification('Failed to duplicate template', 'error');
    }
}

// ==========================================
// TEMPLATE APPLICATION WITH CONFLICT CHECKING
// ==========================================

async function executeTemplateApplication(templateId) {
    try {
        const template = rosterTemplates.find(t => t.id === templateId);
        if (!template) throw new Error('Template not found');
        
        const startDate = new Date(document.getElementById('applyStartDate').value);
        const endDate = new Date(document.getElementById('applyEndDate').value);
        const participantId = document.getElementById('applyParticipant').value;
        const skipExisting = document.getElementById('skipExisting').checked;
        const clockInSetting = document.getElementById('clockInRequirement').value;
        
        if (!participantId) {
            showNotification('Please select a participant', 'warning');
            return;
        }
        
        if (!startDate || !endDate || startDate > endDate) {
            showNotification('Please select a valid date range', 'warning');
            return;
        }
        
        const participant = await getParticipantWithDefaults(participantId);
        if (!participant) {
            showNotification('Participant not found', 'error');
            return;
        }
        
        const staffAssignments = await loadStaffAssignments(participantId);
        const systemDefaults = await loadSystemDefaults();
        
        const processResult = await processTemplateShifts({
            template,
            startDate,
            endDate,
            participant,
            skipExisting,
            staffAssignments,
            systemDefaults,
            clockInSetting // Pass the clock-in setting
        });
        
        if (processResult.conflicts.length > 0) {
            const shouldContinue = await showApplicationConflictDialog(
                processResult.conflicts, 
                processResult.validShifts.length
            );
            if (!shouldContinue) {
                return;
            }
        }
        
        if (processResult.validShifts.length > 0) {
            // Log what we're about to insert for debugging
            console.log('Inserting shifts:', processResult.validShifts);
            
            const { data, error } = await supabaseClient
                .from('shifts')
                .insert(processResult.validShifts);
            
            if (error) {
                console.error('Database error:', error);
                throw error;
            }
            
            const message = processResult.conflicts.length > 0 
                ? `Created ${processResult.validShifts.length} shifts (${processResult.conflicts.length} skipped due to conflicts)`
                : `Created ${processResult.validShifts.length} shifts from template`;
            
            showNotification(message, 'success');
            
            document.querySelector('.modal-overlay')?.remove();
            if (typeof loadShifts === 'function') {
                await loadShifts();
            }
        } else {
            showNotification('No shifts to create (all conflicted or already exist)', 'info');
        }
        
    } catch (error) {
        console.error('Error applying template:', error);
        showNotification(`Failed to apply template: ${error.message}`, 'error');
    }
}


function showApplyTemplateModal(templateId) {
    const template = rosterTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <header class="modal-header">
                <h3 class="modal-title">Apply Template: ${template.name}</h3>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </header>
            <div class="modal-content">
                <div class="form-group">
                    <label>Start Date *</label>
                    <input type="date" id="applyStartDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                </div>
                
                <div class="form-group">
                    <label>End Date *</label>
                    <input type="date" id="applyEndDate" class="form-control" value="${new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0]}">
                </div>
                
                <div class="form-group">
                    <label>Apply To Participant</label>
                    <select id="applyParticipant" class="form-control">
                        ${template.participant_id ? 
                            `<option value="${template.participant_id}" selected>${template.participant?.first_name} ${template.participant?.last_name}</option>` :
                            `<option value="">Select Participant</option>`
                        }
                        ${participants.filter(p => p.id !== template.participant_id).map(p => 
                            `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="skipExisting" checked>
                        Skip dates that already have shifts
                    </label>
                </div>
                
                <div class="form-group">
                    <label>Clock-in Requirement</label>
                    <select id="clockInRequirement" class="form-control">
                        <option value="auto">Auto (based on date)</option>
                        <option value="always">Always require clock-in</option>
                        <option value="never">Never require clock-in</option>
                    </select>
                    <small class="text-muted">Auto: Past/today = no clock-in, Future = clock-in required</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="executeTemplateApplication('${templateId}')">Apply Template</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}



// ==========================================
// PARTICIPANT-SPECIFIC TEMPLATE FUNCTIONS
// ==========================================

async function loadParticipantTemplates(participantId) {
    const templateSelect = document.getElementById('shiftTemplate');
    if (!templateSelect) return;
    
    if (!participantId) {
        templateSelect.innerHTML = '<option value="">-- Select a participant first --</option>';
        templateSelect.disabled = true;
        return;
    }
    
    try {
        templateSelect.innerHTML = '<option value="">Loading templates...</option>';
        templateSelect.disabled = true;
        
        const { data: templates, error } = await supabaseClient
            .from('roster_templates')
            .select(`
                *,
                roster_template_shifts(*)
            `)
            .or(`participant_id.eq.${participantId},participant_id.is.null`)
            .eq('is_active', true)
            .order('name');
        
        if (error) throw error;
        
        templateSelect.innerHTML = '<option value="">-- No Template --</option>';
        templateSelect.disabled = false;
        
        if (templates && templates.length > 0) {
            const participantTemplates = templates.filter(t => t.participant_id === participantId);
            const generalTemplates = templates.filter(t => !t.participant_id);
            
            if (participantTemplates.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Participant Templates';
                participantTemplates.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.dataset.template = JSON.stringify(t);
                    option.textContent = `${t.name} (${t.roster_template_shifts?.length || 0} shifts)`;
                    optgroup.appendChild(option);
                });
                templateSelect.appendChild(optgroup);
            }
            
            if (generalTemplates.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'General Templates';
                generalTemplates.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.dataset.template = JSON.stringify(t);
                    option.textContent = `${t.name} (${t.roster_template_shifts?.length || 0} shifts)`;
                    optgroup.appendChild(option);
                });
                templateSelect.appendChild(optgroup);
            }
        }
        
    } catch (error) {
        console.error('Error loading templates:', error);
        templateSelect.innerHTML = '<option value="">Error loading templates</option>';
        showNotification('Failed to load templates', 'error');
    }
}

function applySelectedTemplate() {
    const templateSelect = document.getElementById('shiftTemplate');
    if (!templateSelect || !templateSelect.value) return;
    
    const selectedOption = templateSelect.selectedOptions[0];
    if (!selectedOption || !selectedOption.dataset.template) return;
    
    try {
        const template = JSON.parse(selectedOption.dataset.template);
        applyTemplateToForm(template);
    } catch (error) {
        console.error('Error applying template:', error);
        showNotification('Failed to apply template', 'error');
    }
}

function applyTemplateToForm(template) {
    if (!template) return;
    
    const shifts = template.roster_template_shifts || [];
    if (shifts.length === 0) {
        showNotification('Template has no shifts defined', 'warning');
        return;
    }
    
    const shift = shifts[0];
    
    const fieldMap = {
        'shiftStartTime': shift.start_time,
        'shiftEndTime': shift.end_time,
        'shiftDutyType': shift.duty_type_id,
        'shiftLocation': shift.location_id,
        'shiftStaff': shift.staff_id,
        'shiftNotes': shift.notes
    };
    
    const appliedFields = [];
    Object.entries(fieldMap).forEach(([fieldId, value]) => {
        if (value !== null && value !== undefined) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value;
                appliedFields.push(field);
                
                field.style.transition = 'background-color 0.3s';
                field.style.backgroundColor = '#e8f5e9';
                setTimeout(() => {
                    field.style.backgroundColor = '';
                }, 2000);
            }
        }
    });
    
    if (shift.day_of_week !== undefined && shift.day_of_week !== null) {
        suggestDateForDayOfWeek(shift.day_of_week);
    }
    
    showNotification(`Template "${template.name}" applied`, 'success');
    
    if (shifts.length > 1) {
        if (confirm(`This template has ${shifts.length} shifts. Would you like to create all of them?`)) {
            createMultipleShiftsFromTemplate(template);
        }
    }
}

async function saveAsTemplate() {
    const templateName = prompt('Enter a name for this template:');
    if (!templateName) return;
    
    const participantSelect = document.getElementById('shiftParticipant');
    const participantId = participantSelect?.value || null;
    
    const shiftConfig = {
        start_time: document.getElementById('shiftStartTime')?.value,
        end_time: document.getElementById('shiftEndTime')?.value,
        staff_id: document.getElementById('shiftStaff')?.value || null,
        duty_type_id: document.getElementById('shiftDutyType')?.value,
        location_id: document.getElementById('shiftLocation')?.value,
        notes: document.getElementById('shiftNotes')?.value,
        day_of_week: new Date(document.getElementById('shiftDate')?.value).getDay() || 7
    };
    
    try {
        const { data: template, error: templateError } = await supabaseClient
            .from('roster_templates')
            .insert({
                name: templateName,
                participant_id: participantId,
                description: `Template created from shift`,
                is_active: true,
                created_by: currentUser?.id
            })
            .select()
            .single();
        
        if (templateError) throw templateError;
        
        const { error: shiftError } = await supabaseClient
            .from('roster_template_shifts')
            .insert({
                template_id: template.id,
                ...shiftConfig
            });
        
        if (shiftError) throw shiftError;
        
        showNotification('Template saved successfully', 'success');
        
        if (participantId) {
            await loadParticipantTemplates(participantId);
        }
        
    } catch (error) {
        console.error('Error saving template:', error);
        showNotification('Failed to save template', 'error');
    }
}

// ==========================================
// TEMPLATE UI MODAL FUNCTIONS
// ==========================================

function openCreateTemplateModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    
    modal.innerHTML = `
        <div class="modal" style="max-width: 900px; width: 90%; max-height: 90vh;">
            <header class="modal-header">
                <h3 class="modal-title">Create Roster Template</h3>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </header>
            <div class="modal-content" style="overflow-y: auto;">
                <div class="form-group">
                    <label>Template Name *</label>
                    <input type="text" id="templateName" class="form-control" placeholder="e.g., Weekday Morning Support">
                </div>
                
                <div class="form-group">
                    <label>Assign to Participant (Optional)</label>
                    <select id="templateParticipant" class="form-control" onchange="onTemplateParticipantChange(this.value)">
                        <option value="">General Template (Any Participant)</option>
                        ${participants.filter(p => p.is_active && p.first_name !== 'My Carers')
                            .sort((a, b) => `${a.first_name} ${a.last_name}`.localeCompare(`${b.first_name} ${b.last_name}`))
                            .map(p => `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`)
                            .join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="templateDescription" class="form-control" rows="2" 
                              placeholder="Brief description of this template"></textarea>
                </div>
                
                <div id="participantLocationWarning" class="alert alert-warning" style="display: none; margin-top: 12px;">
                    <strong>‚ö†Ô∏è Location Not Set:</strong> <span id="locationWarningText"></span>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 16px;">Weekly Schedule</h4>
                
                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-light); border-radius: 8px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="font-weight: 600; margin-right: 8px;">Quick Actions:</span>
                        <button type="button" class="btn btn-outline btn-sm" onclick="copyWeekdaysToAll()">
                            Copy Monday to all weekdays
                        </button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="clearAllDays()">
                            Clear all days
                        </button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="loadSampleTemplate()">
                            Load sample schedule
                        </button>
                    </div>
                </div>
                
                <div id="templateWeekSchedule">
                    ${generateWeekScheduleBuilder()}
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    if (typeof dutyTypes === 'undefined' || !dutyTypes) {
        loadDutyTypes();
    }
}

function generateWeekScheduleBuilder() {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    let html = '<div style="display: grid; gap: 16px;">';
    
    days.forEach((day, index) => {
        html += `
            <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h5 style="margin: 0; color: var(--text-primary);">${day}</h5>
                    <button type="button" class="btn btn-outline btn-sm" onclick="duplicateDay(${index + 1})" title="Copy ${day}'s shifts to other days">
                        üìã Copy Day
                    </button>
                </div>
                <div id="day_${index + 1}_shifts"></div>
                <button type="button" class="btn btn-outline btn-sm" style="margin-top: 8px;" onclick="addShiftToDay(${index + 1})">
                    + Add Shift
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

async function addShiftToDay(dayNumber) {
    const container = document.getElementById(`day_${dayNumber}_shifts`);
    if (!container) return;
    
    const shiftId = `shift_${dayNumber}_${Date.now()}`;
    const participantId = document.getElementById('templateParticipant')?.value;
    
    const shiftHtml = `
        <div id="${shiftId}" class="shift-entry" style="
            padding: 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 12px;
        ">
            <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 2fr 2fr auto; gap: 12px; align-items: end;">
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Start Time</label>
                    <input type="time" data-field="start_time" class="form-control">
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">End Time</label>
                    <input type="time" data-field="end_time" class="form-control">
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Staff</label>
                    <select data-field="staff_id" class="form-control">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Duty Type</label>
                    <select data-field="duty_type_id" class="form-control">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Location</label>
                    <select data-field="location_id" class="form-control">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        style="height: 38px;"
                        onclick="document.getElementById('${shiftId}').remove()">
                    ‚úï
                </button>
            </div>
            
            <div style="margin-top: 12px;">
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Notes (Optional)</label>
                    <input type="text" data-field="notes" class="form-control" 
                           placeholder="Additional notes for this shift">
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', shiftHtml);
    
    const newShift = document.getElementById(shiftId);
    const staffDropdown = newShift.querySelector('[data-field="staff_id"]');
    const dutyDropdown = newShift.querySelector('[data-field="duty_type_id"]');
    const locationDropdown = newShift.querySelector('[data-field="location_id"]');
    
    await updateStaffDropdownForParticipant(staffDropdown, participantId);
    await populateDutyTypeDropdown(dutyDropdown);
    await populateLocationDropdown(locationDropdown, participantId);
}

async function onTemplateParticipantChange(participantId) {
    const allStaffDropdowns = document.querySelectorAll('[data-field="staff_id"]');
    allStaffDropdowns.forEach(dropdown => {
        updateStaffDropdownForParticipant(dropdown, participantId);
    });
    
    if (participantId) {
        const locationCheck = await validateParticipantLocation(participantId);
        const warningDiv = document.getElementById('participantLocationWarning');
        const warningText = document.getElementById('locationWarningText');
        
        if (locationCheck.warning) {
            warningDiv.style.display = 'block';
            warningText.textContent = locationCheck.message;
        } else {
            warningDiv.style.display = 'none';
        }
    } else {
        document.getElementById('participantLocationWarning').style.display = 'none';
    }
}

async function updateStaffDropdownForParticipant(dropdown, participantId) {
    const currentValue = dropdown.value;
    
    if (!participantId) {
        dropdown.innerHTML = `
            <option value="">Please select a participant first</option>
        `;
        dropdown.disabled = true;
    } else {
        dropdown.disabled = false;
        
        const { data: assignments, error } = await supabaseClient
            .from('staff_participant_assignments')
            .select('staff_id, pay_rate_id, staff:staff_id(id, first_name, last_name, is_active)')
            .eq('participant_id', participantId)
            .or('end_date.is.null,end_date.gte.' + new Date().toISOString().split('T')[0]);
        
        if (error) {
            console.error('Error fetching staff assignments:', error);
            dropdown.innerHTML = '<option value="">Error loading staff</option>';
            return;
        }
        
        const assignedStaff = assignments
            ?.filter(a => a.staff && a.staff.is_active)
            .map(a => ({
                ...a.staff,
                pay_rate_id: a.pay_rate_id
            }))
            .sort((a, b) => `${a.first_name} ${a.last_name}`.localeCompare(`${b.first_name} ${b.last_name}`));
        
        if (assignedStaff && assignedStaff.length > 0) {
            dropdown.innerHTML = `
                <option value="">Select Staff</option>
                ${assignedStaff.map(s => 
                    `<option value="${s.id}" data-pay-rate="${s.pay_rate_id || ''}">${s.first_name} ${s.last_name}</option>`
                ).join('')}
            `;
        } else {
            dropdown.innerHTML = `
                <option value="">No staff assigned to this participant</option>
            `;
        }
    }
    
    if (currentValue && dropdown.querySelector(`option[value="${currentValue}"]`)) {
        dropdown.value = currentValue;
    }
}

// ==========================================
// HELPER FUNCTIONS
// ==========================================

async function getParticipantWithDefaults(participantId) {
    const { data: participant, error } = await supabaseClient
        .from('participants')
        .select('*')
        .eq('id', participantId)
        .single();
    
    if (error || !participant) {
        console.error('Error loading participant:', error);
        return null;
    }
    
    if (!participant.location_id && participant.address) {
        const { data: matchingLocation } = await supabaseClient
            .from('locations')
            .select('id')
            .eq('is_active', true)
            .ilike('address', `%${participant.address}%`)
            .limit(1);
        
        if (matchingLocation && matchingLocation.length > 0) {
            participant.location_id = matchingLocation[0].id;
        }
    }
    
    if (!participant.location_id) {
        const { data: clientHome } = await supabaseClient
            .from('locations')
            .select('id')
            .eq('name', 'Client Home')
            .eq('is_active', true)
            .single();
        
        if (clientHome) {
            participant.location_id = clientHome.id;
            console.log(`Using Client Home location for ${participant.first_name} ${participant.last_name}`);
        }
    }
    
    return participant;
}

async function loadStaffAssignments(participantId) {
    const { data: assignments, error } = await supabaseClient
        .from('staff_participant_assignments')
        .select(`
            staff_id,
            pay_rate_id,
            staff:staff_id(
                id,
                first_name,
                last_name,
                pay_rate_id,
                is_active
            )
        `)
        .eq('participant_id', participantId)
        .or('end_date.is.null,end_date.gte.' + new Date().toISOString().split('T')[0]);
    
    if (error) {
        console.error('Error loading staff assignments:', error);
        return {};
    }
    
    const assignmentMap = {};
    assignments?.forEach(a => {
        assignmentMap[a.staff_id] = {
            pay_rate_id: a.pay_rate_id || a.staff?.pay_rate_id,
            staff: a.staff
        };
    });
    
    return assignmentMap;
}

async function loadSystemDefaults() {
    const defaults = {};
    
    const { data: dutyTypes } = await supabaseClient
        .from('duty_types')
        .select('id, name')
        .eq('is_active', true)
        .or('name.eq.Active Shift,name.eq.Active Support,name.ilike.%active%')
        .limit(1);
    
    if (dutyTypes && dutyTypes.length > 0) {
        defaults.duty_type_id = dutyTypes[0].id;
    } else {
        const { data: anyDuty } = await supabaseClient
            .from('duty_types')
            .select('id')
            .eq('is_active', true)
            .limit(1);
        defaults.duty_type_id = anyDuty?.[0]?.id;
    }
    
    defaults.pay_rate_id = '00000000-0000-0000-0000-000000000002';
    // DO NOT SET defaults.staff_id - let it be null for unassigned
    
    const { data: clientHome } = await supabaseClient
        .from('locations')
        .select('id')
        .eq('name', 'Client Home')
        .eq('is_active', true)
        .single();
    
    defaults.location_id = clientHome?.id;
    
    return defaults;
}

async function processTemplateShifts(config) {
    const {
        template,
        startDate,
        endDate,
        participant,
        skipExisting,
        staffAssignments,
        systemDefaults,
        clockInSetting // New parameter
    } = config;
    
    const validShifts = [];
    const conflicts = [];
    const currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        const dayOfWeek = currentDate.getDay();
        const dateStr = currentDate.toISOString().split('T')[0];
        
        if (skipExisting) {
            const { data: existing } = await supabaseClient
                .from('shifts')
                .select('id')
                .eq('participant_id', participant.id)
                .eq('date', dateStr)
                .limit(1);
            
            if (existing?.length > 0) {
                currentDate.setDate(currentDate.getDate() + 1);
                continue;
            }
        }
        
        const dayShifts = template.roster_template_shifts.filter(s => 
            s.day_of_week === dayOfWeek
        );
        
        for (const templateShift of dayShifts) {
            const shiftData = await buildShiftFromTemplate({
                templateShift,
                dateStr,
                participant,
                staffAssignments,
                systemDefaults,
                clockInSetting // Pass the setting
            });
            
            // Only check conflicts if staff is actually assigned
            if (templateShift.staff_id && templateShift.staff_id !== '' && 
                templateShift.start_time && templateShift.end_time) {
                const conflictCheck = await checkShiftConflicts(
                    templateShift.staff_id,
                    participant.id,
                    dateStr,
                    templateShift.start_time,
                    templateShift.end_time,
                    shiftData.duty_type_id
                );
                
                if (conflictCheck.overlaps.length > 0 || conflictCheck.violations.length > 0) {
                    conflicts.push({
                        date: dateStr,
                        staff_id: templateShift.staff_id,
                        conflicts: conflictCheck,
                        shift: templateShift
                    });
                    continue;
                }
            }
            
            validShifts.push(shiftData);
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return { validShifts, conflicts };
}

async function buildShiftFromTemplate(config) {
    const {
        templateShift,
        dateStr,
        participant,
        staffAssignments,
        systemDefaults,
        clockInSetting // New parameter
    } = config;
    
    const shiftDate = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Determine clock-in requirement based on setting
    let clockInRequired;
    if (clockInSetting === 'always') {
        clockInRequired = true;
    } else if (clockInSetting === 'never') {
        clockInRequired = false;
    } else { // 'auto'
        clockInRequired = shiftDate > today;
    }
    
    // Fix: Ensure staff_id is either a valid UUID or null, never the default UUID
    const staffId = templateShift.staff_id && templateShift.staff_id !== '' 
        ? templateShift.staff_id 
        : null;
    
    // Get pay rate based on the actual staff selected
    let payRateId = null;
    if (staffId && staffAssignments[staffId]) {
        payRateId = staffAssignments[staffId].pay_rate_id;
    }
    // Only use default pay rate if we have a staff member but no specific rate
    if (staffId && !payRateId) {
        payRateId = systemDefaults.pay_rate_id;
    }
    
    const locationId = templateShift.location_id || 
                      participant.location_id || 
                      systemDefaults.location_id;
    
    if (!locationId) {
        throw new Error('No location available. Please ensure Client Home location exists.');
    }
    
    const dutyTypeId = templateShift.duty_type_id || systemDefaults.duty_type_id;
    
    if (!dutyTypeId) {
        throw new Error('No duty type available. Please ensure duty types are configured.');
    }
    
    return {
        date: dateStr,
        participant_id: participant.id,
        staff_id: staffId, // This will be null for unassigned shifts
        start_time: templateShift.start_time,
        end_time: templateShift.end_time,
        duty_type_id: dutyTypeId,
        location_id: locationId,
        pay_override_id: payRateId, // This will be null for unassigned shifts
        status: 'confirmed',
        notes: templateShift.notes || null,
        clock_in_required: clockInRequired,
        clock_in_time: !clockInRequired && templateShift.start_time ? 
            `${dateStr}T${templateShift.start_time}` : null,
        clock_out_time: !clockInRequired && templateShift.end_time ? 
            `${dateStr}T${templateShift.end_time}` : null,
        created_at: new Date().toISOString(),
        created_by: currentStaffData?.id || currentUser?.id || null
    };
}



function checkTemplateInternalConflicts(shifts) {
    const conflicts = [];
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    const staffDayShifts = {};
    
    shifts.forEach((shift, index) => {
        if (!shift.staff_id) return;
        
        const key = `${shift.staff_id}_${shift.day_of_week}`;
        if (!staffDayShifts[key]) {
            staffDayShifts[key] = [];
        }
        staffDayShifts[key].push({ ...shift, index });
    });
    
    Object.entries(staffDayShifts).forEach(([key, dayShifts]) => {
        if (dayShifts.length < 2) return;
        
        for (let i = 0; i < dayShifts.length - 1; i++) {
            for (let j = i + 1; j < dayShifts.length; j++) {
                const shift1 = dayShifts[i];
                const shift2 = dayShifts[j];
                
                if (shift1.start_time && shift1.end_time && shift2.start_time && shift2.end_time) {
                    const start1 = new Date(`2000-01-01T${shift1.start_time}`);
                    const end1 = new Date(`2000-01-01T${shift1.end_time}`);
                    const start2 = new Date(`2000-01-01T${shift2.start_time}`);
                    const end2 = new Date(`2000-01-01T${shift2.end_time}`);
                    
                    if (end1 <= start1) end1.setDate(end1.getDate() + 1);
                    if (end2 <= start2) end2.setDate(end2.getDate() + 1);
                    
                    if (!(end1 <= start2 || end2 <= start1)) {
                        const staffMember = staff?.find(s => s.id === shift1.staff_id);
                        conflicts.push({
                            type: 'overlap',
                            day: dayNames[shift1.day_of_week],
                            staff: staffMember ? `${staffMember.first_name} ${staffMember.last_name}` : 'Unknown Staff',
                            shift1: `${formatTime(shift1.start_time)}-${formatTime(shift1.end_time)}`,
                            shift2: `${formatTime(shift2.start_time)}-${formatTime(shift2.end_time)}`,
                            message: `${staffMember?.first_name || 'Staff'} has overlapping shifts on ${dayNames[shift1.day_of_week]}`
                        });
                    }
                }
            }
        }
    });
    
    return conflicts;
}

// ==========================================
// DIALOG FUNCTIONS
// ==========================================

async function showTemplateConflictDialog(conflicts, action) {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal" style="max-width: 600px;">
                <header class="modal-header" style="background: #ffc107;">
                    <h3 class="modal-title">‚ö†Ô∏è Template Conflicts Detected</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </header>
                <div class="modal-content" style="max-height: 400px; overflow-y: auto;">
                    <div class="alert alert-warning">
                        <p><strong>The template has conflicts that may cause issues when applied:</strong></p>
                    </div>
                    <ul class="conflict-list" style="list-style: none; padding: 0;">
                        ${conflicts.map(c => `
                            <li style="padding: 12px; margin-bottom: 8px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                                <div style="font-weight: 600; color: #856404;">
                                    ${c.day} - ${c.staff}
                                </div>
                                <div style="margin-top: 4px; color: #664d03;">
                                    Overlapping shifts: ${c.shift1} and ${c.shift2}
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="alert alert-info" style="margin-top: 16px;">
                        <p>You can still ${action} the template, but these conflicts will prevent some shifts from being created when the template is applied.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove(); window.templateConflictResolve(false)">
                        Cancel
                    </button>
                    <button class="btn btn-warning" onclick="this.closest('.modal-overlay').remove(); window.templateConflictResolve(true)">
                        Continue Anyway
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.templateConflictResolve = (result) => {
            delete window.templateConflictResolve;
            resolve(result);
        };
    });
}

async function showApplicationConflictDialog(conflicts, totalShifts) {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        
        const onLeaveConflicts = [];
        const overlapConflicts = [];
        
        conflicts.forEach(c => {
            if (c.conflicts.violations.some(v => v.type === 'on_leave')) {
                onLeaveConflicts.push(c);
            }
            if (c.conflicts.overlaps.length > 0) {
                overlapConflicts.push(c);
            }
        });
        
        modal.innerHTML = `
            <div class="modal" style="max-width: 700px;">
                <header class="modal-header" style="background: #dc3545;">
                    <h3 class="modal-title" style="color: white;">‚ö†Ô∏è Shift Conflicts Found</h3>
                    <button class="modal-close" style="color: white;" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </header>
                <div class="modal-content" style="max-height: 500px; overflow-y: auto;">
                    <div class="alert alert-danger">
                        <p><strong>${conflicts.length} shifts have conflicts and will be skipped:</strong></p>
                    </div>
                    
                    ${onLeaveConflicts.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #dc3545; margin-bottom: 12px;">Staff on Leave</h4>
                            <ul style="list-style: none; padding: 0;">
                                ${onLeaveConflicts.slice(0, 5).map(c => {
                                    const staffMember = staff?.find(s => s.id === c.staff_id);
                                    return `
                                        <li style="padding: 8px; margin-bottom: 6px; background: #f8d7da; border-radius: 4px;">
                                            ${staffMember?.first_name} ${staffMember?.last_name} - ${formatDateFriendly(c.date)}
                                        </li>
                                    `;
                                }).join('')}
                                ${onLeaveConflicts.length > 5 ? `
                                    <li style="padding: 8px; color: #721c24;">
                                        ... and ${onLeaveConflicts.length - 5} more
                                    </li>
                                ` : ''}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${overlapConflicts.length > 0 ? `
                        <div>
                            <h4 style="color: #dc3545; margin-bottom: 12px;">Time Overlaps</h4>
                            <ul style="list-style: none; padding: 0;">
                                ${overlapConflicts.slice(0, 5).map(c => {
                                    const staffMember = staff?.find(s => s.id === c.staff_id);
                                    return `
                                        <li style="padding: 8px; margin-bottom: 6px; background: #f8d7da; border-radius: 4px;">
                                            ${staffMember?.first_name} ${staffMember?.last_name} - ${formatDateFriendly(c.date)}
                                            <div style="font-size: 0.9em; margin-top: 4px;">
                                                ${c.conflicts.overlaps[0].message}
                                            </div>
                                        </li>
                                    `;
                                }).join('')}
                                ${overlapConflicts.length > 5 ? `
                                    <li style="padding: 8px; color: #721c24;">
                                        ... and ${overlapConflicts.length - 5} more
                                    </li>
                                ` : ''}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="alert alert-info" style="margin-top: 20px;">
                        <p>${totalShifts} shifts will be created successfully.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove(); window.applicationConflictResolve(false)">
                        Cancel Application
                    </button>
                    <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove(); window.applicationConflictResolve(true)">
                        Create Non-Conflicting Shifts
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.applicationConflictResolve = (result) => {
            delete window.applicationConflictResolve;
            resolve(result);
        };
    });
}

// ==========================================
// QUICK ACTION FUNCTIONS
// ==========================================

function duplicateDay(sourceDayOfWeek) {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const sourceDay = days[sourceDayOfWeek - 1];
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.style.zIndex = '10000';
    modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
            <header class="modal-header">
                <h3 class="modal-title">Copy ${sourceDay}'s Shifts</h3>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </header>
            <div class="modal-content">
                <p style="margin-bottom: 16px;">Select which days to copy ${sourceDay}'s shifts to:</p>
                <div style="display: grid; gap: 8px;">
                    ${days.map((day, index) => {
                        const dayNum = index + 1;
                        if (dayNum === sourceDayOfWeek) return '';
                        return `
                            <label style="display: flex; align-items: center; padding: 8px; border: 1px solid var(--border-light); border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" value="${dayNum}" style="margin-right: 8px;">
                                ${day}
                            </label>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 16px;">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="clearExisting" style="margin-right: 8px;">
                        Clear existing shifts on target days
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="executeDayDuplication(${sourceDayOfWeek}, this)">Copy Shifts</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function executeDayDuplication(sourceDayOfWeek, button) {
    const modal = button.closest('.modal-overlay');
    const checkboxes = modal.querySelectorAll('input[type="checkbox"]:not(#clearExisting):checked');
    const clearExisting = modal.querySelector('#clearExisting').checked;
    
    if (checkboxes.length === 0) {
        showNotification('Please select at least one day to copy to', 'warning');
        return;
    }
    
    const sourceContainer = document.getElementById(`day_${sourceDayOfWeek}_shifts`);
    const sourceShifts = sourceContainer.querySelectorAll('[id^="shift_"]');
    
    if (sourceShifts.length === 0) {
        showNotification('No shifts to copy', 'warning');
        modal.remove();
        return;
    }
    
    checkboxes.forEach(checkbox => {
        const targetDay = parseInt(checkbox.value);
        const targetContainer = document.getElementById(`day_${targetDay}_shifts`);
        
        if (clearExisting) {
            targetContainer.innerHTML = '';
        }
        
        sourceShifts.forEach(sourceShift => {
            addShiftToDay(targetDay);
            
            const targetShifts = targetContainer.querySelectorAll('[id^="shift_"]');
            const newShift = targetShifts[targetShifts.length - 1];
            
            const fields = ['start_time', 'end_time', 'staff_id', 'duty_type_id', 'location_id', 'notes'];
            fields.forEach(field => {
                const sourceEl = sourceShift.querySelector(`[data-field="${field}"]`);
                const targetEl = newShift.querySelector(`[data-field="${field}"]`);
                if (sourceEl && targetEl) {
                    targetEl.value = sourceEl.value;
                }
            });
        });
    });
    
    showNotification('Shifts copied successfully', 'success');
    modal.remove();
}

function copyWeekdaysToAll() {
    const mondayContainer = document.getElementById('day_1_shifts');
    const mondayShifts = mondayContainer.querySelectorAll('[id^="shift_"]');
    
    if (mondayShifts.length === 0) {
        showNotification('No shifts on Monday to copy', 'warning');
        return;
    }
    
    for (let day = 2; day <= 5; day++) {
        const targetContainer = document.getElementById(`day_${day}_shifts`);
        targetContainer.innerHTML = '';
        
        mondayShifts.forEach(sourceShift => {
            addShiftToDay(day);
            const targetShifts = targetContainer.querySelectorAll('[id^="shift_"]');
            const newShift = targetShifts[targetShifts.length - 1];
            
            ['start_time', 'end_time', 'staff_id', 'duty_type_id', 'location_id', 'notes'].forEach(field => {
                const sourceEl = sourceShift.querySelector(`[data-field="${field}"]`);
                const targetEl = newShift.querySelector(`[data-field="${field}"]`);
                if (sourceEl && targetEl) {
                    targetEl.value = sourceEl.value;
                }
            });
        });
    }
    
    showNotification('Monday shifts copied to all weekdays', 'success');
}

function clearAllDays() {
    if (!confirm('Clear all shifts from all days?')) return;
    
    for (let day = 1; day <= 7; day++) {
        const container = document.getElementById(`day_${day}_shifts`);
        if (container) container.innerHTML = '';
    }
    showNotification('All days cleared', 'success');
}

function loadSampleTemplate() {
    const sampleShifts = [
        { days: [1,2,3,4,5], start: '07:00', end: '15:00' },
        { days: [1,2,3,4,5], start: '15:00', end: '23:00' },
        { days: [6,7], start: '09:00', end: '21:00' }
    ];
    
    for (let day = 1; day <= 7; day++) {
        const container = document.getElementById(`day_${day}_shifts`);
        if (container) container.innerHTML = '';
    }
    
    sampleShifts.forEach(shift => {
        shift.days.forEach(day => {
            addShiftToDay(day);
            const container = document.getElementById(`day_${day}_shifts`);
            const lastShift = container.lastElementChild;
            if (lastShift) {
                const startInput = lastShift.querySelector('[data-field="start_time"]');
                const endInput = lastShift.querySelector('[data-field="end_time"]');
                if (startInput) startInput.value = shift.start;
                if (endInput) endInput.value = shift.end;
            }
        });
    });
    
    showNotification('Sample schedule loaded', 'success');
}

// ==========================================
// DROPDOWN POPULATION FUNCTIONS
// ==========================================

async function populateDutyTypeDropdown(dropdown) {
    try {
        const { data: dutyTypes, error } = await supabaseClient
            .from('duty_types')
            .select('id, name, description')
            .eq('is_active', true)
            .order('name');
        
        if (error) throw error;
        
        if (!dutyTypes || dutyTypes.length === 0) {
            dropdown.innerHTML = '<option value="">No duty types available</option>';
            return;
        }
        
        const activeShiftType = dutyTypes.find(t => t.name === 'Active Shift');
        
        dropdown.innerHTML = `
            <option value="">Select Duty Type</option>
            ${dutyTypes.map(t => 
                `<option value="${t.id}">${t.name}</option>`
            ).join('')}
        `;
        
        if (activeShiftType && !dropdown.value) {
            dropdown.value = activeShiftType.id;
        }
        
    } catch (error) {
        console.error('Error loading duty types:', error);
        dropdown.innerHTML = '<option value="">Error loading duty types</option>';
    }
}

async function populateLocationDropdown(dropdown, participantId = null) {
    try {
        let defaultLocationId = null;
        if (participantId) {
            const participant = participants?.find(p => p.id === participantId);
            defaultLocationId = participant?.location_id;
        }
        
        const { data: locations, error } = await supabaseClient
            .from('locations')
            .select('id, name, address, is_care_home')
            .eq('is_active', true)
            .order('name');
        
        if (error) throw error;
        
        if (!locations || locations.length === 0) {
            dropdown.innerHTML = '<option value="">No locations available</option>';
            return;
        }
        
        dropdown.innerHTML = `
            <option value="">Select Location</option>
            ${locations.map(l => 
                `<option value="${l.id}">${l.name}${l.is_care_home ? ' (Care Home)' : ''}</option>`
            ).join('')}
        `;
        
        if (defaultLocationId && dropdown.querySelector(`option[value="${defaultLocationId}"]`)) {
            dropdown.value = defaultLocationId;
        }
        
    } catch (error) {
        console.error('Error loading locations:', error);
        dropdown.innerHTML = '<option value="">Error loading locations</option>';
    }
}

async function loadDutyTypes() {
    const { data, error } = await supabaseClient
        .from('duty_types')
        .select('*')
        .eq('is_active', true)
        .order('name');
    
    if (!error && data) {
        window.dutyTypes = data;
    }
}

// ==========================================
// UTILITY FUNCTIONS
// ==========================================

function formatTime(timeString) {
    if (!timeString) return '';
    const [hours, minutes] = timeString.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
    return `${displayHour}:${minutes} ${ampm}`;
}

function formatDateFriendly(dateStr) {
    const date = new Date(dateStr);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

function suggestDateForDayOfWeek(dayOfWeek) {
    const dateInput = document.getElementById('shiftDate');
    if (!dateInput || !dateInput.value) return;
    
    const currentDate = new Date(dateInput.value);
    const currentDay = currentDate.getDay();
    
    if (currentDay !== dayOfWeek) {
        let daysToAdd = dayOfWeek - currentDay;
        if (daysToAdd <= 0) daysToAdd += 7;
        
        const suggestedDate = new Date(currentDate);
        suggestedDate.setDate(currentDate.getDate() + daysToAdd);
        
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        if (confirm(`This template is for ${dayNames[dayOfWeek]}. Change date to ${suggestedDate.toLocaleDateString()}?`)) {
            dateInput.value = suggestedDate.toISOString().split('T')[0];
            dateInput.style.backgroundColor = '#e8f5e9';
            setTimeout(() => {
                dateInput.style.backgroundColor = '';
            }, 2000);
        }
    }
}

async function validateParticipantLocation(participantId) {
    if (!participantId) return { valid: true };
    
    const participant = participants?.find(p => p.id === participantId);
    if (!participant) {
        return { 
            valid: false, 
            message: 'Participant not found' 
        };
    }
    
    if (!participant.location_lat || !participant.location_lng) {
        return {
            valid: false,
            message: `${participant.first_name} ${participant.last_name} does not have location data set. Clock-in features may not work properly.`,
            warning: true
        };
    }
    
    return { 
        valid: true,
        location: {
            address: participant.address,
            lat: participant.location_lat,
            lng: participant.location_lng,
            radius: participant.location_radius_meters || 100
        }
    };
}

        // ========================================
        // SEARCHABLE DROPDOWNS - FIXED
        // ========================================

        function populateFilterDropdowns() {
            console.log('Populating filter dropdowns...');

            // Staff filter dropdown
            const staffList = document.getElementById('staffFilterList');
            if (staffList && staff.length > 0) {
                staffList.innerHTML = '';
                staff.forEach(s => {
                    const option = document.createElement('option');
                    option.value = `${s.first_name} ${s.last_name}`;
                    option.setAttribute('data-id', s.id);
                    staffList.appendChild(option);
                });
            }

            // Participant filter dropdown
            const participantList = document.getElementById('participantFilterList');
            if (participantList && participants.length > 0) {
                participantList.innerHTML = '';
                participants.forEach(p => {
                    const option = document.createElement('option');
                    option.value = `${p.first_name} ${p.last_name}`;
                    option.setAttribute('data-id', p.id);
                    participantList.appendChild(option);
                });
            }
        }

        function updateStaffFilter() {
            const input = document.getElementById('staffFilterInput');
            const selectedStaff = staff.find(s => `${s.first_name} ${s.last_name}` === input.value);
            staffFilterValue = selectedStaff ? selectedStaff.id : '';
            console.log('Staff filter updated:', staffFilterValue);
            applyFilters();
        }

        function updateParticipantFilter() {
    const input = document.getElementById('participantFilterInput');
    const selectedParticipant = participants.find(p => 
        `${p.first_name} ${p.last_name}` === input.value
    );
    participantFilterValue = selectedParticipant ? selectedParticipant.id : '';
    
    // Remove any existing care home filter
    const existingFilter = document.getElementById('careHomeResidentFilter');
    if (existingFilter) existingFilter.remove();
    
    // Check if selected participant is a care home
    if (selectedParticipant) {
        let foundCareHome = null;
        
        // Check if this participant ID is a main care home entity
        careHomes.forEach((ch, address) => {
            if (ch.mainEntityId === selectedParticipant.id) {
                foundCareHome = ch;
                activeCareHomeFilter = address;
            }
        });
        
        // If found, show the resident filter
        if (foundCareHome) {
            showCareHomeResidentFilter(foundCareHome);
        } else {
            activeCareHomeFilter = null;
        }
    } else {
        activeCareHomeFilter = null;
    }
    
    console.log('Participant filter updated:', participantFilterValue);
    applyFilters();
}

function showCareHomeResidentFilter(careHome) {
    const filterRow = document.querySelector('.filter-row');
    
    // Remove existing filter if present
    const existingFilter = document.getElementById('careHomeResidentFilter');
    if (existingFilter) existingFilter.remove();
    
    // Debug log
    console.log('Showing care home filter for:', careHome);
    console.log('Residents:', careHome.residents);
    
    // Create filter UI
    const careHomeFilter = document.createElement('div');
    careHomeFilter.className = 'filter-group';
    careHomeFilter.id = 'careHomeResidentFilter';
    
    const residentCount = careHome.residents.length;
    
    // Build the HTML
    let filterHTML = `
        <label>${careHome.name} Filter</label>
        <div style="
            background: var(--bg-light); 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-md);
            padding: 12px;
            max-height: 250px;
            overflow-y: auto;
        ">
    `;
    
    // Add general shifts checkbox if there's a main entity
    if (careHome.mainEntityId) {
        filterHTML += `
            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                    <input type="checkbox" id="includeGeneralShifts" 
                           checked
                           onchange="applyCareHomeFilter()">
                    <span style="margin-left: 8px;">Include General ${careHome.name} Shifts</span>
                </label>
            </div>
        `;
    }
    
    // Add residents section
    if (residentCount > 0) {
        filterHTML += `
            <div style="margin-bottom: 8px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                    <input type="checkbox" id="selectAllResidents" 
                           onchange="toggleAllResidents(this)" checked>
                    <span style="margin-left: 8px;">All Residents (${residentCount})</span>
                </label>
            </div>
        `;
        
        // Add each resident
        careHome.residents.forEach(resident => {
            filterHTML += `
                <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 4px; padding-left: 20px;">
                    <input type="checkbox" class="resident-checkbox" 
                           value="${resident.id}" 
                           data-name="${resident.first_name} ${resident.last_name}"
                           checked
                           onchange="applyCareHomeFilter()">
                    <span style="margin-left: 8px;">${resident.first_name} ${resident.last_name}</span>
                </label>
            `;
        });
    } else {
        // No residents but show shifts for the care home entity
        filterHTML += `
            <p style="color: var(--text-muted); text-align: center; margin: 20px 0;">
                No individual residents found.<br>
                ${careHome.mainEntityId ? 'Showing general care home shifts only.' : 'No shifts to display.'}
            </p>
        `;
    }
    
    filterHTML += `
        </div>
        <button class="btn btn-outline btn-sm" onclick="clearCareHomeFilter()" style="margin-top: 8px; width: 100%;">
            Clear ${careHome.name} Filter
        </button>
    `;
    
    careHomeFilter.innerHTML = filterHTML;
    
    // Insert after participant filter
    const participantFilterGroup = document.getElementById('participantFilterInput').closest('.filter-group');
    participantFilterGroup.after(careHomeFilter);
    
    showNotification(`Filtering by ${careHome.name} (${residentCount} residents)`, 'info');
    applyCareHomeFilter();
}

// Apply care home filter (generic for any care home)
window.applyCareHomeFilter = function() {
    if (!activeCareHomeFilter) {
        applyFilters();
        return;
    }
    
    const careHome = careHomes.get(activeCareHomeFilter);
    if (!careHome) {
        applyFilters();
        return;
    }
    
    const includeGeneral = document.getElementById('includeGeneralShifts')?.checked ?? false;
    const selectedResidents = Array.from(document.querySelectorAll('.resident-checkbox:checked'))
        .map(cb => cb.value);
    
    // Get other filter values
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    // Filter shifts
    filteredShifts = shifts.filter(shift => {
        // Apply standard filters
        if (startDate && shift.date < startDate) return false;
        if (endDate && shift.date > endDate) return false;
        if (statusFilter && shift.status !== statusFilter) return false;
        if (staffFilterValue && shift.staff_id !== staffFilterValue) return false;
        
        // Care home filter
        const isGeneralShift = careHome.mainEntityId && shift.participant_id === careHome.mainEntityId;
        const isResidentShift = selectedResidents.includes(shift.participant_id);
        
        if (includeGeneral && isGeneralShift) return true;
        if (isResidentShift) return true;
        
        return false;
    });
    
    // Update "All Residents" checkbox
    const allCheckbox = document.getElementById('selectAllResidents');
    const residentCheckboxes = document.querySelectorAll('.resident-checkbox');
    if (allCheckbox && residentCheckboxes.length > 0) {
        allCheckbox.checked = selectedResidents.length === residentCheckboxes.length;
    }
    
    console.log(`Filtered to ${filteredShifts.length} shifts for ${careHome.name}`);
    renderCurrentView();
}

// Clear care home filter
window.clearCareHomeFilter = function() {
    document.getElementById('participantFilterInput').value = '';
    participantFilterValue = '';
    activeCareHomeFilter = null;
    
    const careHomeFilter = document.getElementById('careHomeResidentFilter');
    if (careHomeFilter) careHomeFilter.remove();
    
    applyFilters();
}

// Toggle all residents
window.toggleAllResidents = function(checkbox) {
    const residentCheckboxes = document.querySelectorAll('.resident-checkbox');
    residentCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    applyCareHomeFilter();
}
// FIX FOR MC-MANAGER.HTML MODAL DROPDOWNS
// Replace the existing populateModalDropdowns function with this corrected version

function populateModalDropdowns() {
    console.log('Populating modal dropdowns with data:', {
        staff: staff.length,
        participants: participants.length,
        locations: locations.length,
        dutyTypes: dutyTypes.length
    });
    
    // ===== POPULATE DATALISTS FOR STAFF (autocomplete inputs) =====
    const staffDataLists = [
        'staffDataList',        // For create shift modal
        'editStaffList'         // For edit shift modal
    ];
    
    staffDataLists.forEach(datalistId => {
        const datalist = document.getElementById(datalistId);
        if (datalist) {
            datalist.innerHTML = '';
            staff.forEach(s => {
                const option = document.createElement('option');
                option.value = `${s.first_name} ${s.last_name}`;
                option.setAttribute('data-id', s.id);
                datalist.appendChild(option);
            });
            console.log(`Populated ${datalistId} with ${staff.length} staff members`);
        } else {
            console.warn(`Datalist ${datalistId} not found`);
        }
    });
    
    // ===== POPULATE DATALISTS FOR PARTICIPANTS (autocomplete inputs) =====
    const participantDataLists = [
        'participantDataList',   // For create shift modal
        'editParticipantList'    // For edit shift modal
    ];
    
    participantDataLists.forEach(datalistId => {
        const datalist = document.getElementById(datalistId);
        if (datalist) {
            datalist.innerHTML = '';
            
            // Group participants by care home
            const careHomeParticipants = [];
            const homeParticipants = [];
            
            participants.forEach(p => {
                // Check if participant is in a care home
                const isCareHome = p.address && (
                    p.address.toLowerCase().includes('saunders') ||
                    locations.some(l => l.is_care_home && l.address && 
                        p.address.toLowerCase().includes(l.address.toLowerCase().split(',')[0])
                    )
                );
                
                if (isCareHome) {
                    careHomeParticipants.push(p);
                } else {
                    homeParticipants.push(p);
                }
            });
            
            // Add all participants to datalist (care home indicator in the display)
            participants.forEach(p => {
                const option = document.createElement('option');
                const isCareHome = careHomeParticipants.includes(p);
                const label = isCareHome ? ' (Care Home)' : '';
                option.value = `${p.first_name} ${p.last_name}${label}`;
                option.setAttribute('data-id', p.id);
                datalist.appendChild(option);
            });
            
            console.log(`Populated ${datalistId} with ${participants.length} participants`);
        } else {
            console.warn(`Datalist ${datalistId} not found`);
        }
    });

    // ===== POPULATE LOCATION DROPDOWNS (regular selects) =====
    const locationSelects = [
        document.getElementById('shiftLocation'),
        document.getElementById('editShiftLocation')
    ];
    
    locationSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Location</option>';
            
            // Group locations
            const careHomes = locations.filter(l => l.is_care_home);
            const otherLocations = locations.filter(l => !l.is_care_home);
            
            // Add care homes first
            if (careHomes.length > 0) {
                select.innerHTML += '<optgroup label="Care Homes">';
                careHomes.forEach(l => {
                    select.innerHTML += `<option value="${l.id}">${l.name}</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
            
            // Add other locations
            if (otherLocations.length > 0) {
                select.innerHTML += '<optgroup label="Other Locations">';
                otherLocations.forEach(l => {
                    select.innerHTML += `<option value="${l.id}">${l.name}</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
            
            console.log(`Populated location select with ${locations.length} locations`);
        }
    });

    // ===== POPULATE DUTY TYPE DROPDOWNS (regular selects) =====
    const dutyTypeSelects = [
        document.getElementById('shiftDutyType'),
        document.getElementById('editShiftDutyType')
    ];
    
    dutyTypeSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Duty Type</option>';
            dutyTypes.forEach(dt => {
                select.innerHTML += `<option value="${dt.id}">${dt.name}</option>`;
            });
            console.log(`Populated duty type select with ${dutyTypes.length} duty types`);
        }
    });

    // ===== POPULATE PAY RATE DROPDOWNS (if they exist) =====
    const payRateSelects = [
        document.getElementById('shiftPayRate'),
        document.getElementById('editShiftPayRate')
    ];
    
    payRateSelects.forEach(select => {
        if (select && payRates) {
            select.innerHTML = '<option value="">Use Staff Default</option>';
            
            // Group pay rates by category for better organization
            const groupedRates = {};
            payRates.forEach(pr => {
                const category = pr.category || 'Other';
                if (!groupedRates[category]) {
                    groupedRates[category] = [];
                }
                groupedRates[category].push(pr);
            });
            
            // Add grouped options
            Object.keys(groupedRates).sort().forEach(category => {
                if (groupedRates[category].length > 0) {
                    select.innerHTML += `<optgroup label="${category}">`;
                    groupedRates[category].forEach(pr => {
                        const label = payRateLabels?.get(pr.id) || 
                                    `${category} - Level ${pr.level || '?'} - Point ${pr.pay_point || '?'}`;
                        const rate = pr.hourly_pay_rate || pr.base_rate || 0;
                        select.innerHTML += `<option value="${pr.id}">${label} ($${rate}/hr)</option>`;
                    });
                    select.innerHTML += `</optgroup>`;
                }
            });
        }
    });

    // ===== POPULATE STATUS DROPDOWN (only for edit modal) =====
    const statusSelect = document.getElementById('editShiftStatus');
    if (statusSelect) {
        statusSelect.innerHTML = `
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
        `;
    }

}

// ALSO ADD/UPDATE these helper functions if they don't exist:

function updateStaffSelection() {
    const input = document.getElementById('shiftStaffInput');
    const hiddenInput = document.getElementById('shiftStaff');
    
    // Remove any care home indicator for matching
    const inputValue = input.value.replace(' (Care Home)', '');
    const selectedStaff = staff.find(s => `${s.first_name} ${s.last_name}` === inputValue);
    
    if (selectedStaff) {
        hiddenInput.value = selectedStaff.id;
        if (typeof updateHourWarning === 'function') {
            updateHourWarning();
        }
    } else {
        hiddenInput.value = '';
    }
}

function updateParticipantSelection() {
    const input = document.getElementById('shiftParticipantInput');
    const hiddenInput = document.getElementById('shiftParticipant');
    const locationSelect = document.getElementById('shiftLocation');
    
    // Remove any care home indicator for matching
    const inputValue = input.value.replace(' (Care Home)', '');
    const selectedParticipant = participants.find(p => `${p.first_name} ${p.last_name}` === inputValue);
    
    if (selectedParticipant) {
        hiddenInput.value = selectedParticipant.id;
        
        // Auto-select location based on participant
        if (locationSelect && selectedParticipant.address) {
            const addressLower = selectedParticipant.address.toLowerCase();
            
            // Check for Saunders Care Home
            if (addressLower.includes('saunders')) {
                const saundersLocation = locations.find(l => 
                    l.name.toLowerCase().includes('saunders') || 
                    (l.address && l.address.toLowerCase().includes('saunders'))
                );
                if (saundersLocation) {
                    locationSelect.value = saundersLocation.id;
                }
            } 
            // Check for other care homes
            else {
                const careHomeLocation = locations.find(l => 
                    l.is_care_home && l.address && 
                    addressLower.includes(l.address.toLowerCase().split(',')[0])
                );
                if (careHomeLocation) {
                    locationSelect.value = careHomeLocation.id;
                }
            }
            
            // If no care home found, select Client Home
            if (!locationSelect.value) {
                const clientHome = locations.find(l => 
                    l.name.toLowerCase().includes('client home') ||
                    l.id === '00000000-0000-0000-0000-000000000001'
                );
                if (clientHome) {
                    locationSelect.value = clientHome.id;
                }
            }
        }
    } else {
        hiddenInput.value = '';
    }
}


function updateEditStaffSelection() {
    const input = document.getElementById('editShiftStaffInput');
    const hiddenInput = document.getElementById('editShiftStaff');
    
    // Remove any care home indicator for matching
    const inputValue = input.value.replace(' (Care Home)', '');
    const selectedStaff = staff.find(s => `${s.first_name} ${s.last_name}` === inputValue);
    
    hiddenInput.value = selectedStaff ? selectedStaff.id : '';
}

function updateEditParticipantSelection() {
    const input = document.getElementById('editShiftParticipantInput');
    const hiddenInput = document.getElementById('editShiftParticipant');
    const locationSelect = document.getElementById('editShiftLocation');
    
    // Remove any care home indicator for matching
    const inputValue = input.value.replace(' (Care Home)', '');
    const selectedParticipant = participants.find(p => `${p.first_name} ${p.last_name}` === inputValue);
    
    if (selectedParticipant) {
        hiddenInput.value = selectedParticipant.id;
        
        // Auto-select location for edit modal too
        if (locationSelect && selectedParticipant.address) {
            const addressLower = selectedParticipant.address.toLowerCase();
            
            // Same logic as create modal
            if (addressLower.includes('saunders')) {
                const saundersLocation = locations.find(l => 
                    l.name.toLowerCase().includes('saunders') || 
                    (l.address && l.address.toLowerCase().includes('saunders'))
                );
                if (saundersLocation) {
                    locationSelect.value = saundersLocation.id;
                }
            } else {
                const careHomeLocation = locations.find(l => 
                    l.is_care_home && l.address && 
                    addressLower.includes(l.address.toLowerCase().split(',')[0])
                );
                if (careHomeLocation) {
                    locationSelect.value = careHomeLocation.id;
                } else {
                    const clientHome = locations.find(l => 
                        l.name.toLowerCase().includes('client home') ||
                        l.id === '00000000-0000-0000-0000-000000000001'
                    );
                    if (clientHome) {
                        locationSelect.value = clientHome.id;
                    }
                }
            }
        }
    } else {
        hiddenInput.value = '';
    }
}

async function createShift() {
    try {
        const date = document.getElementById('shiftDate').value;
        const startTime = document.getElementById('shiftStartTime').value;
        const endTime = document.getElementById('shiftEndTime').value;
        const staffId = document.getElementById('shiftStaff').value;
        const participantId = document.getElementById('shiftParticipant').value || null;
        const locationId = document.getElementById('shiftLocation').value || null;
        const dutyTypeId = document.getElementById('shiftDutyType').value;
        const payRateId = document.getElementById('shiftPayRate').value;

        // Basic validation
        if (!date || !staffId || !dutyTypeId) {
            showNotification('Please fill required fields (Date, Staff, Duty Type)', 'error');
            return;
        }

        if (!participantId && !locationId) {
            showNotification('Please select either participant or location', 'error');
            return;
        }

        // Get the staff member's default pay rate if no override selected
        const selectedStaff = staff.find(s => s.id === staffId);
        const effectivePayRateId = payRateId || selectedStaff?.pay_rate_id;
if (!effectivePayRateId) {
  showNotification('Missing pay rate. Please select or assign a valid pay rate.', 'error');
  return;
}

        // Calculate duration
        let duration_hours = null;
        const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeId);
        if (selectedDutyType?.name.toLowerCase().includes('sleepover')) {
            duration_hours = 2;
        } else if (startTime && endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            let end = new Date(`2000-01-01T${endTime}`);
            if (end <= start) end.setDate(end.getDate() + 1);
            duration_hours = (end - start) / (1000 * 60 * 60);
        }

        const shiftData = {
            date: date,
            start_time: startTime || null,
            end_time: endTime || null,
            staff_id: staffId,
            participant_id: participantId,
            location_id: locationId,
            duty_type_id: dutyTypeId,
            pay_override_id: effectivePayRateId, // FIXED: Using correct pay rate
            created_by: currentStaffData?.id || currentUser.id,
            status: 'confirmed',
            duration_hours: duration_hours
        };

        const { data: newShift, error } = await supabaseClient
            .from('shifts')
            .insert([shiftData])
            .select()
            .single();

        if (error) throw error;

        showNotification('Shift created successfully', 'success');
        closeModal('addShiftModal');
        await loadShifts();

    } catch (error) {
        console.error('Error creating shift:', error);
        showNotification('Failed to create shift: ' + error.message, 'error');
    }
}

// For the shift modal error, add:
function showAddShiftModal() {
    // Get the modal with the correct ID
    const modal = document.getElementById('addShiftModal');
    if (!modal) {
        console.error('Modal not found');
        return;
    }
    
    // Show the modal
    modal.style.display = 'flex'; // Use 'flex' since it's a modal-overlay
    
    // Reset the form
    const form = document.getElementById('addShiftForm');
    if (form) form.reset();
    
    // Set today's date as default
    const dateInput = document.getElementById('shiftDate');
    if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Load dropdowns data
    loadStaffDataList();
    loadParticipantDataList();
    loadLocationOptions();
    loadDutyTypeOptions();
    loadPayRateOptions();
}

// Helper functions to populate the dropdowns (if they don't exist already)
function loadStaffDataList() {
    const datalist = document.getElementById('staffDataList');
    if (datalist && window.staff) {
        datalist.innerHTML = window.staff.map(s => 
            `<option value="${s.first_name} ${s.last_name}" data-id="${s.id}">`
        ).join('');
    }
}

function loadParticipantDataList() {
    const datalist = document.getElementById('participantDataList');
    if (datalist && window.participants) {
        datalist.innerHTML = window.participants.map(p => 
            `<option value="${p.first_name} ${p.last_name}" data-id="${p.id}">`
        ).join('');
    }
}

function loadLocationOptions() {
    const select = document.getElementById('shiftLocation');
    if (select && window.locations) {
        select.innerHTML = '<option value="">Select Location</option>' +
            window.locations.map(l => 
                `<option value="${l.id}">${l.name}</option>`
            ).join('');
    }
}

function loadDutyTypeOptions() {
    const select = document.getElementById('shiftDutyType');
    if (select && window.dutyTypes) {
        select.innerHTML = '<option value="">Select Duty Type</option>' +
            window.dutyTypes.map(dt => 
                `<option value="${dt.id}">${dt.name}</option>`
            ).join('');
    }
}

function loadPayRateOptions() {
    const select = document.getElementById('shiftPayRate');
    if (select && window.payRates) {
        select.innerHTML = '<option value="">Use Staff Default</option>' +
            window.payRates.map(pr => 
                `<option value="${pr.id}">${pr.category} ${pr.level} - $${pr.hourly_pay_rate}/hr</option>`
            ).join('');
    }
}
function getParticipantColor(participantId) {
    if (!participantId) return 'transparent';
    
    const colors = [
        '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
        '#1abc9c', '#e67e22', '#16a085', '#f1c40f', '#e84393',
        '#00b894', '#6c5ce7', '#fdcb6e', '#fd79a8', '#a29bfe'
    ];
    
    // Use participant ID to consistently pick same color
    const hash = participantId.split('').reduce((acc, char) => 
        acc + char.charCodeAt(0), 0);
    
    return colors[hash % colors.length];
}
// Helper function to view a specific staff member's week
function viewStaffWeek(staffId, weekStart) {
    // Set filters
    document.getElementById('staffFilterInput').value = 
        staff.find(s => s.id === staffId)?.first_name + ' ' + 
        staff.find(s => s.id === staffId)?.last_name;
    updateStaffFilter();
    
    // Set week
    currentWeekStart = new Date(weekStart);
    updateWeekDisplay();
    loadShifts();
    
    // Switch to roster view
    switchView('table');
}


function editShift(shiftId) {
    const shift = shifts.find(s => s.id === shiftId);
    if (!shift) {
        console.error('Shift not found:', shiftId);
        return;
    }


    // Populate edit form
    document.getElementById('editShiftId').value = shift.id;
    document.getElementById('editShiftDate').value = shift.date;
    document.getElementById('editShiftStartTime').value = shift.start_time || '';
    document.getElementById('editShiftEndTime').value = shift.end_time || '';
    
    // Set staff selection
    if (shift.staff) {
        const staffName = `${shift.staff.first_name} ${shift.staff.last_name}`;
        document.getElementById('editShiftStaffInput').value = staffName;
        document.getElementById('editShiftStaff').value = shift.staff_id;
    } else {
        document.getElementById('editShiftStaffInput').value = '';
        document.getElementById('editShiftStaff').value = '';
    }
    
    // Set participant selection
    if (shift.participant) {
        const participantName = `${shift.participant.first_name} ${shift.participant.last_name}`;
        document.getElementById('editShiftParticipantInput').value = participantName;
        document.getElementById('editShiftParticipant').value = shift.participant_id;
    } else {
        document.getElementById('editShiftParticipantInput').value = '';
        document.getElementById('editShiftParticipant').value = '';
    }
    
    document.getElementById('editShiftLocation').value = shift.location_id || '';
    document.getElementById('editShiftDutyType').value = shift.duty_type_id || '';
    
    // Handle pay rate override - ensure the select has the value as an option
    const payRateSelect = document.getElementById('editShiftPayRate');
    if (payRateSelect) {
        // First, ensure the option exists
        if (shift.pay_override_id) {
            // Check if the option already exists
            let optionExists = false;
            for (let i = 0; i < payRateSelect.options.length; i++) {
                if (payRateSelect.options[i].value === shift.pay_override_id) {
                    optionExists = true;
                    break;
                }
            }
            
            // If the option doesn't exist, add it
            if (!optionExists && shift.pay_override) {
                const option = document.createElement('option');
                option.value = shift.pay_override_id;
                option.text = `Custom Rate - $${shift.pay_override.hourly_pay_rate || shift.pay_override.base_rate || 0}/hr`;
                payRateSelect.appendChild(option);
            }
            
            // Now set the value
            payRateSelect.value = shift.pay_override_id;
        } else {
            // No override, use empty value (Staff Default)
            payRateSelect.value = '';
        }
    }
    
    document.getElementById('editShiftStatus').value = shift.status || 'scheduled';
    document.getElementById('editShiftNotes').value = shift.notes || '';

    document.getElementById('editShiftModal').style.display = 'flex';
}
        
        async function deleteShift(shiftId) {
    try {
        // Get the shift data before deletion for undo
        const shiftToDelete = shifts.find(s => s.id === shiftId);
        if (shiftToDelete) {
            // Save to undo stack
            UndoRedoManager.saveState('delete_shift', {
                id: parseInt(shiftId),
                shiftData: { ...shiftToDelete }
            });
        }
        
        // Soft delete - only use deleted_at (not deleted_by since it doesn't exist)
        const { error } = await supabaseClient
            .from('shifts')
            .update({ 
                deleted_at: new Date().toISOString()
            })
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showNotification('Shift deleted successfully', 'success');
        
        // Close modal if open
        const modal = document.getElementById('editShiftModal');
        if (modal && modal.style.display !== 'none') {
            closeModal('editShiftModal');
        }
        
        await loadShifts();
        
        // Refresh conflicts view if it's active
        if (currentView === 'conflicts') {
            await renderConflicts();
        } else {
            renderCurrentView();
        }
        
    } catch (error) {
        console.error('Error deleting shift:', error);
        showNotification('Failed to delete shift', 'error');
    }
}

function deleteShiftConfirm() {
    const shiftId = parseInt(document.getElementById('editShiftId').value);
    
    if (!shiftId) {
        showNotification('No shift selected for deletion', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this shift? This action cannot be undone.')) {
        return;
    }

    deleteShift(shiftId);
}

        function updateTimeFields() {
            const dutyTypeSelect = document.getElementById('shiftDutyType');
            const startTimeInput = document.getElementById('shiftStartTime');
            const endTimeInput = document.getElementById('shiftEndTime');
            
            if (!dutyTypeSelect || !startTimeInput || !endTimeInput) return;
            
            const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeSelect.value);
            
            if (selectedDutyType && selectedDutyType.name.toLowerCase().includes('sleepover')) {
                startTimeInput.required = false;
                endTimeInput.required = false;
                startTimeInput.placeholder = "Optional for sleepovers";
                endTimeInput.placeholder = "Optional for sleepovers";
            } else {
                startTimeInput.required = true;
                endTimeInput.required = true;
                startTimeInput.placeholder = "";
                endTimeInput.placeholder = "";
            }
        }

        function updateEditTimeFields() {
            const dutyTypeSelect = document.getElementById('editShiftDutyType');
            const startTimeInput = document.getElementById('editShiftStartTime');
            const endTimeInput = document.getElementById('editShiftEndTime');
            
            if (!dutyTypeSelect || !startTimeInput || !endTimeInput) return;
            
            const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeSelect.value);
            
            if (selectedDutyType && selectedDutyType.name.toLowerCase().includes('sleepover')) {
                startTimeInput.required = false;
                endTimeInput.required = false;
                startTimeInput.placeholder = "Optional for sleepovers";
                endTimeInput.placeholder = "Optional for sleepovers";
            } else {
                startTimeInput.required = true;
                endTimeInput.required = true;
                startTimeInput.placeholder = "";
                endTimeInput.placeholder = "";
            }
        }

        function updateHourWarning() {
            const staffId = document.getElementById('shiftStaff').value;
            const warningDiv = document.getElementById('hourWarningText');
            
            if (!staffId || !warningDiv) {
                if (warningDiv) warningDiv.style.display = 'none';
                return;
            }
            
            const selectedStaff = staff.find(s => s.id === staffId);
            if (!selectedStaff || selectedStaff.limits === undefined || selectedStaff.limits === null) {
                warningDiv.style.display = 'none';
                return;
            }

            // Calculate current week hours
            const weekStart = getFortnightStart(new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weekShifts = shifts.filter(shift => 
                shift.staff_id === selectedStaff.id &&
                shift.date >= weekStart.toISOString().split('T')[0] &&
                shift.date <= weekEnd.toISOString().split('T')[0]
            );
            
            const currentWeekHours = weekShifts.reduce((total, shift) => 
                total + (shift.calculated_hours?.total || 0), 0
            );
            
            const hourLimit = parseFloat(selectedStaff.limits);
            const remaining = hourLimit - currentWeekHours;
            
            if (remaining <= 10) {
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = `WARNING: ${selectedStaff.first_name} has ${remaining.toFixed(1)}h remaining this week (${currentWeekHours.toFixed(1)}h/${hourLimit}h)`;
            } else {
                warningDiv.style.display = 'none';
            }
        }

        function validateSleepoverRules(shifts, newShift) {
    const violations = [];
    
    // If new shift is a sleepover
    if (newShift.duty_type?.toLowerCase().includes('sleepover')) {
        shifts.forEach(existing => {
            if (existing.start_time) {
                const startHour = parseInt(existing.start_time.split(':')[0]);
                const endHour = parseInt(existing.end_time?.split(':')[0]) || 0;
                
                // Check for late night shifts (10pm onwards)
                if (startHour >= 22 || startHour < 6) {
                    violations.push({
                        type: 'sleepover_conflict',
                        message: `Cannot have sleepover with late night shift (${existing.start_time} - ${existing.end_time})`,
                        shift: existing
                    });
                }
                
                // Check for early morning shifts (12am-6am)
                if (endHour > 0 && endHour <= 6) {
                    violations.push({
                        type: 'sleepover_conflict', 
                        message: `Cannot have sleepover with early morning shift ending at ${existing.end_time}`,
                        shift: existing
                    });
                }
            }
        });
    }
    
    // If new shift is active and there's a sleepover
    const hasSleepover = shifts.some(s => s.duty_type?.name?.toLowerCase().includes('sleepover'));
    if (hasSleepover && newShift.start_time) {
        const startHour = parseInt(newShift.start_time.split(':')[0]);
        const endHour = parseInt(newShift.end_time?.split(':')[0]) || 0;
        
        if (startHour >= 22 || startHour < 6 || (endHour > 0 && endHour <= 6)) {
            violations.push({
                type: 'sleepover_conflict',
                message: 'Cannot roster 10pm-6am shifts when staff has sleepover',
                shift: null
            });
        }
    }
    
    return violations;
}

// Comprehensive overlap check
async function checkShiftConflicts(staffId, participantId, date, startTime, endTime, dutyType, excludeShiftId = null) {
    const conflicts = {
        overlaps: [],
        violations: [],
        warnings: [],
        participantOverlaps: []
    };
    
    try {
        // 1. Check staff availability/leave
        const { data: leaveData } = await supabaseClient
            .from('staff_availability')
            .select('*')
            .eq('staff_id', staffId)
            .eq('date', date)
            .eq('is_available', false)
            .single();
        
        if (leaveData) {
            conflicts.violations.push({
                type: 'on_leave',
                message: `Staff is on leave on ${formatDateFriendly(date)}`,
                blocking: true
            });
        }
        
        // 2. Get all shifts for this staff on this date
        let staffQuery = supabaseClient
            .from('shifts')
            .select('*, duty_type:duty_type_id(name)')
            .eq('staff_id', staffId)
            .eq('date', date)
            .is('deleted_at', null);
        
        if (excludeShiftId) {
            staffQuery = staffQuery.neq('id', excludeShiftId);
        }
        
        const { data: staffShifts } = await staffQuery;
        
        // 3. Check time overlaps for active shifts
        if (startTime && endTime && staffShifts) {
            const newStart = new Date(`2000-01-01T${startTime}`);
            const newEnd = new Date(`2000-01-01T${endTime}`);
            if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
            
            staffShifts.forEach(shift => {
                if (shift.start_time && shift.end_time) {
                    const existingStart = new Date(`2000-01-01T${shift.start_time}`);
                    const existingEnd = new Date(`2000-01-01T${shift.end_time}`);
                    if (existingEnd <= existingStart) existingEnd.setDate(existingEnd.getDate() + 1);
                    
                    // Check for overlap
                    if (!(newEnd <= existingStart || newStart >= existingEnd)) {
                        // Calculate overlap period
                        const overlapStart = new Date(Math.max(newStart, existingStart));
                        const overlapEnd = new Date(Math.min(newEnd, existingEnd));
                        
                        conflicts.overlaps.push({
                            type: 'time_overlap',
                            message: `Overlaps with shift ${formatTime12Hour(shift.start_time)}-${formatTime12Hour(shift.end_time)}`,
                            overlapPeriod: `${overlapStart.toTimeString().slice(0,5)}-${overlapEnd.toTimeString().slice(0,5)}`,
                            shift: shift,
                            blocking: true
                        });
                    }
                }
            });
        }
        
        // 4. Check sleepover business rules
        const sleepoverViolations = validateSleepoverRules(staffShifts || [], {
            start_time: startTime,
            end_time: endTime,
            duty_type: dutyType
        });
        
        conflicts.violations.push(...sleepoverViolations);
        
        // 5. Check participant overlaps (for information only)
        if (participantId && startTime && endTime) {
            const { data: participantShifts } = await supabaseClient
                .from('shifts')
                .select('*, staff:staff_id(first_name, last_name)')
                .eq('participant_id', participantId)
                .eq('date', date)
                .is('deleted_at', null)

            
            if (participantShifts) {
                const overlappingStaff = [];
                
                participantShifts.forEach(shift => {
                    if (shift.start_time && shift.end_time) {
                        const existingStart = new Date(`2000-01-01T${shift.start_time}`);
                        const existingEnd = new Date(`2000-01-01T${shift.end_time}`);
                        const newStart = new Date(`2000-01-01T${startTime}`);
                        const newEnd = new Date(`2000-01-01T${endTime}`);
                        
                        if (existingEnd <= existingStart) existingEnd.setDate(existingEnd.getDate() + 1);
                        if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
                        
                        if (!(newEnd <= existingStart || newStart >= existingEnd)) {
                            overlappingStaff.push({
                                staff: shift.staff,
                                time: `${formatTime12Hour(shift.start_time)}-${formatTime12Hour(shift.end_time)}`
                            });
                        }
                    }
                });
                
                if (overlappingStaff.length > 0) {
                    conflicts.participantOverlaps = {
                        count: overlappingStaff.length + 1, // +1 for the new shift
                        ratio: `${overlappingStaff.length + 1}:1`,
                        staff: overlappingStaff,
                        message: `Participant will have ${overlappingStaff.length + 1} staff during this time`
                    };
                }
            }
        }
        
    } catch (error) {
        console.error('Error checking conflicts:', error);
    }
    
    return conflicts;
}
        // ========================================
        // SUMMARY AND TIMESHEET RENDERING - FIXED
        // ========================================

        function renderSummary() {
    const summaryGrid = document.getElementById('summaryGrid');
    if (!summaryGrid || !shifts) {
        if (summaryGrid) {
            summaryGrid.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>No shift data available</span>
                </div>
            `;
        }
        return;
    }
    
    // Get current filters
    const filters = window.currentFilters || {};
    const startDate = filters.startDate;
    const endDate = filters.endDate;
    const staffFilter = filters.staffId;
    const participantFilter = filters.participantId;
    
    // Filter shifts based on date range and other criteria
    let relevantShifts = shifts.filter(shift => {
        // Must have clock-in capability - check the actual column value
        if (shift.clock_in_required === false || shift.clock_in_required === null) return false;
        
        // Apply date filters
        if (startDate && shift.date < startDate) return false;
        if (endDate && shift.date > endDate) return false;
        
        // Apply staff/participant filters
        if (staffFilter && shift.staff_id !== staffFilter) return false;
        if (participantFilter && shift.participant_id !== participantFilter) return false;
        
        return true;
    });
    
    // Calculate summary statistics
    const stats = calculateClockInStats(relevantShifts);
    
    // Build the HTML
    let html = `
        <style>
            .clockin-summary-wrapper {
                background: white;
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            .summary-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }
            
            .stat-card {
                background: rgba(255,255,255,0.15);
                padding: 16px;
                border-radius: 8px;
                backdrop-filter: blur(10px);
            }
            
            .stat-label {
                font-size: 12px;
                opacity: 0.9;
                margin-bottom: 4px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .stat-value {
                font-size: 24px;
                font-weight: bold;
            }
            
            .stat-subtext {
                font-size: 11px;
                opacity: 0.8;
                margin-top: 4px;
            }
            
            .clockin-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
            }
            
            .clockin-table thead {
                background: #f8f9fa;
            }
            
            .clockin-table th {
                padding: 12px;
                text-align: left;
                font-weight: 600;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: #495057;
                border-bottom: 2px solid #dee2e6;
            }
            
            .clockin-table td {
                padding: 14px 12px;
                border-bottom: 1px solid #e9ecef;
                font-size: 14px;
                vertical-align: middle;
            }
            
            .clockin-row {
                transition: all 0.2s ease;
                background: white;
            }
            
            .clockin-row:hover {
                background: #f8f9fa;
            }
            
            .clockin-row.on-time {
                background: #d4edda;
            }
            
            .clockin-row.late {
                background: #fff3cd;
            }
            
            .clockin-row.very-late {
                background: #f8d7da;
            }
            
            .clockin-row.no-show {
                background: #f8d7da;
                opacity: 0.8;
            }
            
            .status-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .status-on-time { background: #28a745; color: white; }
            .status-late { background: #ffc107; color: #333; }
            .status-very-late { background: #dc3545; color: white; }
            .status-no-show { background: #6c757d; color: white; }
            
            .location-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
            }
            
            .location-ok { background: #d4edda; color: #155724; }
            .location-warning { background: #fff3cd; color: #856404; }
            .location-error { background: #f8d7da; color: #721c24; }
            
            .time-diff {
                font-weight: 600;
                font-size: 13px;
            }
            
            .time-diff.late { color: #dc3545; }
            .time-diff.on-time { color: #28a745; }
            
            .clock-icon {
                width: 16px;
                height: 16px;
                display: inline-block;
                margin-right: 4px;
                vertical-align: middle;
            }
        </style>
        
        <div class="clockin-summary-wrapper">
            <!-- Summary Statistics -->
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Shifts</div>
                    <div class="stat-value">${stats.totalShifts}</div>
                    <div class="stat-subtext">In selected period</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">On-Time Rate</div>
                    <div class="stat-value">${stats.onTimePercentage}%</div>
                    <div class="stat-subtext">${stats.onTimeCount} of ${stats.totalWithClockIn} shifts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Tardiness</div>
                    <div class="stat-value">${stats.avgTardiness} min</div>
                    <div class="stat-subtext">For late clock-ins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Location Compliance</div>
                    <div class="stat-value">${stats.locationCompliance}%</div>
                    <div class="stat-subtext">Within 200m radius</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Missing Clock-Ins</div>
                    <div class="stat-value">${stats.missingClockIns}</div>
                    <div class="stat-subtext">Require attention</div>
                </div>
            </div>
            
            <!-- Table -->
            <table class="clockin-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">Staff Member</th>
                        <th style="width: 15%;">Participant</th>
                        <th style="width: 10%;">Date</th>
                        <th style="width: 12%;">Scheduled</th>
                        <th style="width: 12%;">Clock In</th>
                        <th style="width: 10%;">Difference</th>
                        <th style="width: 14%;">Location</th>
                        <th style="width: 8%;">Clock Out</th>
                        <th style="width: 4%;" title="Clock-in Required"><i class="fas fa-clock"></i></th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Sort shifts by date and time
    relevantShifts.sort((a, b) => {
        if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
        return a.start_time.localeCompare(b.start_time);
    });
    
    // Render each shift row
    relevantShifts.forEach(shift => {
        const punctuality = calculatePunctuality(shift);
        const locationCompliance = calculateLocationCompliance(shift);
        const rowClass = getRowClass(punctuality);
        
        // Create clock-in indicator
        const clockInIndicator = shift.clock_in_required ? 
            '<i class="fas fa-clock" style="color: #28a745;" title="Clock-in required"></i>' :
            '<i class="fas fa-clock-o" style="color: #6c757d;" title="No clock-in required"></i>';
        
        html += `
            <tr class="clockin-row ${rowClass}">
                <td>
                    <strong>${shift.staff?.first_name || ''} ${shift.staff?.last_name || ''}</strong>
                    <div style="font-size: 11px; color: #6c757d;">${shift.staff?.staff_code || ''}</div>
                </td>
                <td>
                    <strong>${shift.participant?.first_name || ''} ${shift.participant?.last_name || ''}</strong>
                    <div style="font-size: 11px; color: #6c757d;">${shift.participant?.ndis_participant_number || ''}</div>
                </td>
                <td>${formatDateShort(shift.date)}</td>
                <td>
                    <i class="fas fa-clock clock-icon" style="color: #6c757d;"></i>
                    ${formatTime12Hour(shift.start_time)}
                </td>
                <td>
                    ${shift.clock_in_time ? 
                        `<i class="fas fa-check-circle clock-icon" style="color: #28a745;"></i>
                         ${formatClockTime(shift.clock_in_time)}` :
                        `<i class="fas fa-times-circle clock-icon" style="color: #dc3545;"></i>
                         <span style="color: #dc3545;">Missing</span>`
                    }
                </td>
                <td>
                    ${punctuality.displayText}
                </td>
                <td>
                    ${locationCompliance.badge}
                    ${locationCompliance.address ? 
                        `<div style="font-size: 10px; color: #6c757d; margin-top: 2px;">${locationCompliance.address}</div>` : 
                        ''
                    }
                </td>
                <td>
                    ${shift.clock_out_time ? 
                        formatClockTime(shift.clock_out_time) :
                        '<span style="color: #6c757d;">‚Äî</span>'
                    }
                </td>
                <td style="text-align: center;">
                    ${clockInIndicator}
                </td>
            </tr>
        `;
    });
    
    if (relevantShifts.length === 0) {
        html += `
            <tr>
                <td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-clock" style="font-size: 32px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <div>No shifts found matching the selected filters</div>
                </td>
            </tr>
        `;
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    summaryGrid.innerHTML = html;
}

// Helper function to calculate punctuality in NSW timezone
function calculatePunctuality(shift) {
    if (!shift.clock_in_time) {
        return {
            minutesLate: null,
            displayText: '<span class="time-diff" style="color: #dc3545;">No Clock-In</span>',
            statusBadge: '<span class="status-badge status-no-show">NO SHOW</span>',
            category: 'no-show'
        };
    }
    
    // Create full datetime strings for comparison
    const scheduledDateTime = new Date(`${shift.date}T${shift.start_time}`);
    const clockInDateTime = new Date(shift.clock_in_time);
    
    // Calculate difference in milliseconds (both are in UTC, so comparison is valid)
    const diffMs = clockInDateTime - scheduledDateTime;
    const diffMinutes = Math.floor(diffMs / 60000);
    
    let displayText, statusBadge, category;
    
    if (diffMinutes <= 5 && diffMinutes >= -5) {
        // On time (within 5 minutes)
        displayText = '<span class="time-diff on-time">On Time</span>';
        statusBadge = '<span class="status-badge status-on-time">ON TIME</span>';
        category = 'on-time';
    } else if (diffMinutes > 5 && diffMinutes <= 15) {
        // Late (5-15 minutes)
        displayText = `<span class="time-diff late">+${diffMinutes} min</span>`;
        statusBadge = '<span class="status-badge status-late">LATE</span>';
        category = 'late';
    } else if (diffMinutes > 15) {
        // Very late (>15 minutes)
        displayText = `<span class="time-diff late" style="font-weight: bold;">+${diffMinutes} min</span>`;
        statusBadge = '<span class="status-badge status-very-late">VERY LATE</span>';
        category = 'very-late';
    } else {
        // Early
        displayText = `<span class="time-diff on-time">${diffMinutes} min</span>`;
        statusBadge = '<span class="status-badge status-on-time">EARLY</span>';
        category = 'on-time';
    }
    
    return {
        minutesLate: diffMinutes > 0 ? diffMinutes : 0,
        displayText,
        statusBadge,
        category
    };
}

// Helper function to calculate location compliance
function calculateLocationCompliance(shift) {
    if (!shift.clock_in_distance_meters) {
        return {
            compliant: null,
            distance: null,
            badge: '<span class="location-badge" style="background: #e9ecef; color: #6c757d;"><i class="fas fa-map-marker-alt"></i> Unknown</span>',
            address: shift.clock_in_address || null
        };
    }
    
    const distance = parseFloat(shift.clock_in_distance_meters);
    let badge, compliant;
    
    if (distance < 100) {
        badge = `<span class="location-badge location-ok"><i class="fas fa-check-circle"></i> ${distance.toFixed(0)}m</span>`;
        compliant = true;
    } else if (distance <= 200) {
        badge = `<span class="location-badge location-warning"><i class="fas fa-exclamation-triangle"></i> ${distance.toFixed(0)}m</span>`;
        compliant = true;
    } else {
        badge = `<span class="location-badge location-error"><i class="fas fa-times-circle"></i> ${distance.toFixed(0)}m</span>`;
        compliant = false;
    }
    
    return {
        compliant,
        distance,
        badge,
        address: shift.clock_in_address || null
    };
}

// Helper function to determine row class based on punctuality
function getRowClass(punctuality) {
    switch(punctuality.category) {
        case 'on-time': return 'on-time';
        case 'late': return 'late';
        case 'very-late': return 'very-late';
        case 'no-show': return 'no-show';
        default: return '';
    }
}

// Helper function to format clock-in/out times in NSW timezone
function formatClockTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    // Format in NSW timezone
    return date.toLocaleTimeString('en-AU', { 
        timeZone: 'Australia/Sydney',
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
    });
}

// Calculate summary statistics
function calculateClockInStats(shifts) {
    const totalShifts = shifts.length;
    const shiftsWithClockIn = shifts.filter(s => s.clock_in_time);
    const totalWithClockIn = shiftsWithClockIn.length;
    
    // Calculate on-time metrics
    let onTimeCount = 0;
    let totalTardinessMinutes = 0;
    let lateShiftsCount = 0;
    
    shiftsWithClockIn.forEach(shift => {
        const punctuality = calculatePunctuality(shift);
        if (punctuality.category === 'on-time') {
            onTimeCount++;
        } else if (punctuality.minutesLate > 0) {
            totalTardinessMinutes += punctuality.minutesLate;
            lateShiftsCount++;
        }
    });
    
    // Calculate location compliance
    const shiftsWithLocation = shifts.filter(s => s.clock_in_distance_meters !== null && s.clock_in_distance_meters !== undefined);
    const compliantLocations = shiftsWithLocation.filter(s => s.clock_in_distance_meters <= 200);
    
    return {
        totalShifts,
        totalWithClockIn,
        onTimeCount,
        onTimePercentage: totalWithClockIn > 0 ? Math.round((onTimeCount / totalWithClockIn) * 100) : 0,
        avgTardiness: lateShiftsCount > 0 ? Math.round(totalTardinessMinutes / lateShiftsCount) : 0,
        locationCompliance: shiftsWithLocation.length > 0 ? 
            Math.round((compliantLocations.length / shiftsWithLocation.length) * 100) : 100,
        missingClockIns: totalShifts - totalWithClockIn
    };
}

        
// 2. The EXACT calculateShiftHours function from mc-manager
function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };

    const dutyType = shift.duty_type || shift.duty_types;
    const isSleepover = dutyType && dutyType.name && 
        dutyType.name.toLowerCase().includes('sleepover');

    // If it has times AND is a sleepover, calculate both
    if (isSleepover && shift.start_time && shift.end_time) {
        // This is BOTH active hours AND a sleepover
        
        // First calculate active hours
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const activeHours = (endTime - startTime) / (1000 * 60 * 60);
        
        // Apply penalty logic for active hours
        const shiftDate = new Date(shift.date);
        const dayOfWeek = shiftDate.getDay();
        const isPublicHoliday = publicHolidays.has(shift.date);
        
        if (isPublicHoliday) {
            result.publicHoliday = activeHours;
        } else if (dayOfWeek === 6) {
            result.saturday = activeHours;
        } else if (dayOfWeek === 0) {
            result.sunday = activeHours;
        } else {
            const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
            Object.assign(result, weekdayBreakdown);
        }
        
        // ADD the sleepover hours on top
        result.sleepover = 2; // Always 2 hours for sleepover
        result.total = activeHours + 2; // Total is active + sleepover
        
    } else if (isSleepover) {
        // Just a sleepover, no active hours
        result.sleepover = 2;
        result.total = 2;
        
    } else if (shift.start_time && shift.end_time) {
        // Just active hours, no sleepover
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const totalHours = (endTime - startTime) / (1000 * 60 * 60);
        result.total = totalHours;
        
        // Apply penalty logic
        const shiftDate = new Date(shift.date);
        const dayOfWeek = shiftDate.getDay();
        const isPublicHoliday = publicHolidays.has(shift.date);
        
        if (isPublicHoliday) {
            result.publicHoliday = totalHours;
        } else if (dayOfWeek === 6) {
            result.saturday = totalHours;
        } else if (dayOfWeek === 0) {
            result.sunday = totalHours;
        } else {
            const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
            Object.assign(result, weekdayBreakdown);
        }
    }
    
    return result;
}

// 3. The EXACT splitWeekdayHours function
function splitWeekdayHours(startTime, endTime) {
    const result = {
        total: 0,
        weekdayDay: 0,      // 6am-8pm
        weekdayEvening: 0,  // 8pm-12am  
        weekdayNight: 0     // 12am-6am
    };

    const current = new Date(startTime);
    
    while (current < endTime) {
        // Calculate end of current period
        const nextPeriod = new Date(current);
        nextPeriod.setMinutes(current.getMinutes() + 30); // Calculate in 30-min increments
        
        const periodEnd = nextPeriod > endTime ? endTime : nextPeriod;
        const periodHours = (periodEnd - current) / (1000 * 60 * 60);
        
        const hour = current.getHours();
        
        // Time period classification
        if (hour >= 6 && hour < 20) {
            result.weekdayDay += periodHours;
        } else if (hour >= 20 && hour < 24) {
            result.weekdayEvening += periodHours;
        } else {
            result.weekdayNight += periodHours;
        }
        
        current.setTime(periodEnd.getTime());
    }

    result.total = result.weekdayDay + result.weekdayEvening + result.weekdayNight;
    return result;
}

// 4. The EXACT calculateTimesheetHours for the timesheet display
function calculateTimesheetHours(shifts) {
    const breakdown = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0,
        sleepoverCount: 0
    };
    
    shifts.forEach(shift => {
        const hours = calculateShiftHours(shift);
        
        breakdown.total += hours.total || 0;
        breakdown.weekdayDay += hours.weekdayDay || 0;
        breakdown.weekdayEvening += hours.weekdayEvening || 0;
        breakdown.weekdayNight += hours.weekdayNight || 0;
        breakdown.saturday += hours.saturday || 0;
        breakdown.sunday += hours.sunday || 0;
        breakdown.publicHoliday += hours.publicHoliday || 0;
        breakdown.sleepover += hours.sleepover || 0;
        
        // Count sleepovers (not hours)
        if (hours.sleepover > 0) {
            breakdown.sleepoverCount++;
        }
    });
    
    // Update the hours grid display
    const hoursGrid = document.getElementById('hoursGrid');
    if (hoursGrid) {
        hoursGrid.innerHTML = `
            <div class="hours-item">
                <span class="hours-label">Weekday Day</span>
                <span class="hours-value">${breakdown.weekdayDay.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Evening</span>
                <span class="hours-value">${breakdown.weekdayEvening.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Night</span>
                <span class="hours-value">${breakdown.weekdayNight.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Saturday</span>
                <span class="hours-value">${breakdown.saturday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sunday</span>
                <span class="hours-value">${breakdown.sunday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Public Holiday</span>
                <span class="hours-value">${breakdown.publicHoliday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sleepovers</span>
                <span class="hours-value">${breakdown.sleepoverCount}</span>
            </div>
        `;
    }
    
    // Update total
    const totalElement = document.getElementById('totalHours');
    if (totalElement) {
        totalElement.textContent = `${breakdown.total.toFixed(1)}h`;
    }
    
    return breakdown;
}



function renderTimesheet() {
    const timesheetContent = document.getElementById('timesheetContent');
    if (!timesheetContent) return;
    
    console.log('Rendering timesheet...');
    
    // Group by staff
    const staffGroups = {};
    filteredShifts.forEach(shift => {
        const staffId = shift.staff_id;
        if (!staffGroups[staffId]) {
            staffGroups[staffId] = {
                staff: shift.staff,
                shifts: [],
                totalHours: { 
                    total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                    saturday: 0, sunday: 0, publicHoliday: 0, sleepover: 0,
                    overtime: 0 // Added overtime tracking
                },
                totalPay: 0,
                sleepoverCount: 0,
                weeklyHours: 0 // Track weekly hours for overtime calculation
            };
        }
        staffGroups[staffId].shifts.push(shift);
    });

    // Calculate totals for each staff member
    Object.values(staffGroups).forEach(group => {
        // First pass: calculate base hours
        group.shifts.forEach(shift => {
            const hours = shift.calculated_hours || {};
            const pay = shift.calculated_pay || 0;
            
            // Sum all hour categories
            Object.keys(hours).forEach(category => {
                if (group.totalHours[category] !== undefined) {
                    group.totalHours[category] += hours[category] || 0;
                }
            });
            
            // Count sleepovers (not hours)
            if (hours.sleepover > 0) {
                group.sleepoverCount++;
            }
            
            // Track public holiday hours - check the shift's is_public_holiday field
            if (shift.is_public_holiday === true) {
                group.totalHours.publicHoliday += hours.total || 0;
            }
            
            group.totalPay += pay;
        });
        
        // Calculate overtime (hours over 38 per week for full-time/part-time)
        const staff = group.staff;
        const payCategory = staff?.pay_category || 'casual';
        
        if (payCategory.toLowerCase().includes('full') || payCategory.toLowerCase().includes('part')) {
            // Only calculate overtime for full-time and part-time staff
            const standardWeeklyHours = 38;
            if (group.totalHours.total > standardWeeklyHours) {
                group.totalHours.overtime = group.totalHours.total - standardWeeklyHours;
            }
        }
        
        // Apply hour limits
        if (staff && staff.limits !== undefined && staff.limits !== null) {
            const hourLimit = parseFloat(staff.limits);
            group.overLimit = group.totalHours.total > hourLimit;
            group.hourLimit = hourLimit;
            group.finalHours = Math.min(group.totalHours.total, hourLimit);
            group.deductedHours = Math.max(0, group.totalHours.total - hourLimit);
        } else {
            group.overLimit = false;
            group.hourLimit = 76; // Default
            group.finalHours = group.totalHours.total;
            group.deductedHours = 0;
        }
        
        // Get pay rate label
        if (staff && staff.pay_rate_id) {
            group.payRateLabel = payRateLabels.get(staff.pay_rate_id) || 'Standard Rate';
        } else {
            group.payRateLabel = 'Standard Rate';
        }
    });

    // Calculate grand totals for footer
    let grandTotalHours = 0;
    let grandTotalPay = 0;
    let grandTotalOvertime = 0;
    let grandTotalPublicHoliday = 0;
    
    Object.values(staffGroups).forEach(group => {
        grandTotalHours += group.totalHours.total;
        grandTotalPay += group.totalPay;
        grandTotalOvertime += group.totalHours.overtime || 0;
        grandTotalPublicHoliday += group.totalHours.publicHoliday || 0;
    });

    let html = `
        <style>
            .timesheet-wrapper {
                background: white;
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            .timesheet-table { 
                width: 100%; 
                border-collapse: separate;
                border-spacing: 0;
                background: white;
            }
            
            .timesheet-table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .timesheet-table th { 
                padding: 16px 12px; 
                text-align: left; 
                font-weight: 600; 
                font-size: 11px; 
                text-transform: uppercase;
                letter-spacing: 1px;
                color: white;
                border: none;
            }
            
            .timesheet-table tfoot {
                background: #f8f9fa;
                border-top: 2px solid #dee2e6;
            }
            
            .timesheet-table tfoot td {
                padding: 16px 12px;
                font-weight: 700;
                color: var(--text-primary);
                font-size: 14px;
            }
            
            .timesheet-row { 
                cursor: pointer; 
                transition: all 0.2s ease;
                background: white;
                position: relative;
            }
            
            .timesheet-row:hover { 
                background: #f8f9fa;
                transform: translateX(2px);
            }
            
            .timesheet-row td { 
                padding: 16px 12px; 
                border-bottom: 1px solid #e9ecef; 
                font-size: 14px;
                vertical-align: middle;
            }
            
            .timesheet-row:hover td:first-child {
                border-left: 3px solid var(--primary-color);
                padding-left: 9px;
            }
            
            .accordion-content { 
                display: none; 
                background: #f8f9fa;
            }
            
            .accordion-content.active { 
                display: table-row;
                animation: slideDown 0.3s ease;
            }
            
            .assignment-manager-accordion {
    padding: 20px;
}

.view-mode-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.search-filter-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex: 1;
}

.assignment-controls {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    align-items: center;
}

.rate-amount {
    margin-left: 8px;
    color: #6c757d;
}

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .accordion-arrow { 
                display: inline-block; 
                margin-right: 10px; 
                transition: transform 0.3s ease; 
                font-size: 12px;
                color: var(--primary-color);
                font-weight: bold;
            }
            
            .accordion-arrow.open { 
                transform: rotate(90deg); 
            }
            
            .staff-name {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 15px;
            }
            
            .pay-rate-badge {
                display: inline-block;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 500;
                letter-spacing: 0.5px;
            }
            
            .hours-display {
                font-weight: 500;
                font-size: 14px;
            }
            
            .hours-limit {
                color: var(--text-muted);
                font-weight: normal;
            }
            
            .hour-exceeded { 
                color: #e74c3c !important; 
                font-weight: 600; 
            }
            
            .exceeded-badge {
                display: inline-block;
                background: #e74c3c;
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 10px;
                margin-left: 8px;
                font-weight: 600;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            .sleepover-badge {
                display: inline-block;
                background: #f39c12;
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-weight: 600;
                font-size: 13px;
            }
            
            .overtime-badge {
                display: inline-block;
                background: #e67e22;
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-weight: 600;
                font-size: 13px;
                margin-left: 6px;
            }
            
            .hour-breakdown-cell {
                font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
                font-size: 12px;
                line-height: 1.8;
                color: var(--text-secondary);
                background: #f8f9fa;
                padding: 8px 12px !important;
                border-radius: 6px;
            }
            
            .hour-breakdown-item {
                display: inline-block;
                padding: 3px 8px;
                background: white;
                border-radius: 4px;
                margin-right: 8px;
                margin-bottom: 4px;
                border: 1px solid #e9ecef;
            }
            
            .hour-breakdown-item.overtime {
                background: #fff4e4;
                border-color: #ffd6a5;
                color: #e67e22;
                font-weight: 600;
            }
            
            .hour-breakdown-item.public-holiday {
                background: #e3f2fd;
                border-color: #90caf9;
                color: #1976d2;
                font-weight: 600;
            }
            
            .final-hours {
                font-weight: 600;
                font-size: 15px;
                color: var(--text-primary);
            }
            
            .deducted { 
                color: #e67e22; 
                font-size: 11px;
                font-weight: 500;
                display: block;
                margin-top: 4px;
            }
            
            .total-pay {
                font-weight: 700;
                font-size: 16px;
                color: #27ae60;
            }
            
            .shifts-detail-container {
                padding: 24px;
                background: white;
                margin: 16px;
                border-radius: 8px;
                box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            }
            
            .shifts-detail-header {
                margin-bottom: 16px;
                color: var(--text-secondary);
                font-size: 13px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .shifts-detail-table { 
                width: 100%;
                font-size: 13px;
                border-collapse: separate;
                border-spacing: 0;
                overflow: hidden;
                border-radius: 6px;
                border: 1px solid #e9ecef;
            }
            
            .shifts-detail-table th { 
                background: #f8f9fa;
                padding: 10px 12px; 
                text-align: left;
                font-weight: 600;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-secondary);
                border-bottom: 1px solid #e9ecef;
            }
            
            .shifts-detail-table td { 
                padding: 12px; 
                border-bottom: 1px solid #f1f3f4;
                background: white;
            }
            
            .shifts-detail-table tbody tr:hover {
                background: #f8f9fa;
            }
            
            .shifts-detail-table tbody tr:last-child td {
                border-bottom: none;
            }
            
            .status-badge {
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .status-confirmed {
                background: #d4edda;
                color: #155724;
            }
            
            .status-pending {
                background: #fff3cd;
                color: #856404;
            }
            
            .status-completed {
                background: #cce5ff;
                color: #004085;
            }
            
            .public-holiday-indicator {
                display: inline-block;
                background: #1976d2;
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 10px;
                margin-left: 6px;
                font-weight: 600;
                text-transform: uppercase;
            }
        </style>
        
        <div class="timesheet-wrapper">
            <table class="timesheet-table">
                <thead>
                    <tr>
                        <th style="width: 20%;">Staff Member</th>
                        <th style="width: 15%;">Pay Rate</th>
                        <th style="width: 12%;">Hours / Limit</th>
                        <th style="width: 8%; text-align: center;">Sleepovers</th>
                        <th style="width: 30%;">Hour Breakdown</th>
                        <th style="width: 10%;">Final Hours</th>
                        <th style="width: 10%; text-align: right;">Total Pay</th>
                    </tr>
                </thead>
                <tbody>
    `;

    // Add each staff member's row and accordion content
    let accordionIndex = 0;
    Object.values(staffGroups).forEach(group => {
        const staff = group.staff || { first_name: 'Unknown', last_name: 'Staff' };
        const staffName = `${staff.first_name} ${staff.last_name}`;
        
        // Build hour breakdown with styled items
        const hourBreakdown = [];
        if (group.totalHours.weekdayDay > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Day: ${formatHours(group.totalHours.weekdayDay)}h</span>`);
        if (group.totalHours.weekdayEvening > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Eve: ${formatHours(group.totalHours.weekdayEvening)}h</span>`);
        if (group.totalHours.weekdayNight > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Night: ${formatHours(group.totalHours.weekdayNight)}h</span>`);
        if (group.totalHours.saturday > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Sat: ${formatHours(group.totalHours.saturday)}h</span>`);
        if (group.totalHours.sunday > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Sun: ${formatHours(group.totalHours.sunday)}h</span>`);
        if (group.totalHours.publicHoliday > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item public-holiday">PH: ${formatHours(group.totalHours.publicHoliday)}h</span>`);
        if (group.totalHours.overtime > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item overtime">OT: ${formatHours(group.totalHours.overtime)}h</span>`);
        
        const hourBreakdownStr = hourBreakdown.join('') || '<span style="color: #aaa;">‚Äî</span>';
        
        // Main row
        html += `
            <tr class="timesheet-row" onclick="toggleTimesheetAccordion(${accordionIndex})">
                <td>
                    <span class="accordion-arrow" id="arrow-${accordionIndex}">‚ñ∂</span>
                    <span class="staff-name">${staffName}</span>
                </td>
                <td>
                    <span class="pay-rate-badge">${group.payRateLabel}</span>
                </td>
                <td>
                    <span class="hours-display ${group.overLimit ? 'hour-exceeded' : ''}">
                        ${formatHours(group.totalHours.total)}h 
                        <span class="hours-limit">/ ${group.hourLimit}h</span>
                        ${group.overLimit ? '<span class="exceeded-badge">EXCEEDED</span>' : ''}
                    </span>
                </td>
                <td style="text-align: center;">
                    ${group.sleepoverCount > 0 ? 
                        `<span class="sleepover-badge">${group.sleepoverCount}</span>` : 
                        '<span style="color: #ccc;">‚Äî</span>'}
                </td>
                <td class="hour-breakdown-cell">${hourBreakdownStr}</td>
                <td>
                    <span class="final-hours">${formatHours(group.finalHours)}h</span>
                    ${group.deductedHours > 0 ? 
                        `<span class="deducted">‚àí${formatHours(group.deductedHours)}h deducted</span>` : ''}
                    ${group.totalHours.overtime > 0 ? 
                        `<span class="overtime-badge" title="Overtime hours">+${formatHours(group.totalHours.overtime)}h OT</span>` : ''}
                </td>
                <td style="text-align: right;">
                    <span class="total-pay">$${group.totalPay.toFixed(2)}</span>
                </td>
            </tr>
            <tr class="accordion-content" id="accordion-${accordionIndex}">
                <td colspan="7" style="padding: 0; background: #f8f9fa;">
                    <div class="shifts-detail-container">
                        <h4 class="shifts-detail-header">Individual Shifts (${group.shifts.length})</h4>
                        <table class="shifts-detail-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Participant</th>
                                    <th>Hours</th>
                                    <th>Type</th>
                                    <th>Pay</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        // Sort shifts by date
        group.shifts.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Add individual shifts
        group.shifts.forEach(shift => {
            const participant = shift.participant || {};
            const participantName = participant.first_name ? 
                `${participant.first_name} ${participant.last_name}` : 
                (shift.location?.name || 'Unassigned');
            
            const timeDisplay = shift.start_time && shift.end_time ? 
                `${formatTime12Hour(shift.start_time)} - ${formatTime12Hour(shift.end_time)}` : 
                'Sleepover';
            
            const shiftHours = shift.calculated_hours?.total || 0;
            const shiftPay = shift.calculated_pay || 0;
            const dutyType = dutyTypes.find(d => d.id === shift.duty_type_id);
            
            html += `
                <tr>
                    <td>
                        <strong>${formatDateFriendly(shift.date)}</strong>
                        ${shift.is_public_holiday === true ? '<span class="public-holiday-indicator">PH</span>' : ''}
                    </td>
                    <td>${timeDisplay}</td>
                    <td>${participantName}</td>
                    <td>${formatHours(shiftHours)}h</td>
                    <td>${dutyType?.name || 'Active Shift'}</td>
                    <td style="font-weight: 600; color: #27ae60;">$${shiftPay.toFixed(2)}</td>
                    <td><span class="status-badge status-${shift.status || 'pending'}">${shift.status || 'pending'}</span></td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
        `;
        
        accordionIndex++;
    });

    // Add footer with totals
    html += `
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2"><strong>TOTALS</strong></td>
                        <td><strong>${formatHours(grandTotalHours)}h</strong></td>
                        <td style="text-align: center;">‚Äî</td>
                        <td>
                            ${grandTotalOvertime > 0 ? `<span class="hour-breakdown-item overtime">OT: ${formatHours(grandTotalOvertime)}h</span>` : ''}
                            ${grandTotalPublicHoliday > 0 ? `<span class="hour-breakdown-item public-holiday">PH: ${formatHours(grandTotalPublicHoliday)}h</span>` : ''}
                        </td>
                        <td>‚Äî</td>
                        <td style="text-align: right;"><strong style="color: #27ae60;">$${grandTotalPay.toFixed(2)}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;

    timesheetContent.innerHTML = html || '<div class="loading">No timesheet data available</div>';
}
window.toggleTimesheetAccordion = function(index) {
    const content = document.getElementById(`accordion-${index}`);
    const arrow = document.getElementById(`arrow-${index}`);
    
    if (content && arrow) {
        content.classList.toggle('active');
        arrow.classList.toggle('open');
    }
};

// ========================================
// NOTES MANAGEMENT
// ========================================
let currentNotesPage = 1;
const notesPerPage = 20;

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

window.editNote = async function(noteId) {
    try {
        // Fetch the complete note data from database
        const { data: noteData, error } = await supabaseClient
            .from('shift_notes')
            .select('*')
            .eq('id', noteId)
            .single();
        
        if (error) throw error;
        
        // Store the note ID for updating
        window.editingNoteId = noteId;
        
        // Open the modal with prepopulated data
        showEditShiftNoteModal(noteData);
        
    } catch (error) {
        console.error('Error fetching note:', error);
        showNotification('Failed to load note for editing', 'error');
    }
};

window.saveNote = async function(noteId) {
    try {
        const editDiv = document.getElementById(`note-edit-${noteId}`);
        if (!editDiv) return;
        
        const newContent = editDiv.innerHTML.trim();
        if (!newContent || newContent === '<br>') {
            showNotification('Note cannot be empty', 'error');
            return;
        }
        
        // Update in database with HTML content
        const { error } = await supabaseClient
            .from('shift_notes')
            .update({ 
                note: newContent,
                updated_at: new Date().toISOString()
            })
            .eq('id', noteId);
        
        if (error) throw error;
        
        showNotification('Note updated successfully', 'success');
        renderNotes(currentNotesPage);
        
    } catch (error) {
        console.error('Error updating note:', error);
        showNotification('Failed to update note', 'error');
    }
};

window.cancelEditNote = function(noteId) {
    const noteContent = document.getElementById(`note-content-${noteId}`);
    const noteItem = document.querySelector(`[data-note-id="${noteId}"]`);
    
    if (!noteContent || !noteItem) return;
    
    // Restore original HTML content (not text)
    const originalContent = noteContent.dataset.original || '';
    noteContent.innerHTML = originalContent; // Use innerHTML instead of textContent
    
    // Toggle buttons
    const editBtn = noteItem.querySelector('.edit-note-btn');
    const saveBtn = noteItem.querySelector('.save-note-btn');
    const cancelBtn = noteItem.querySelector('.cancel-note-btn');
    
    if (editBtn) editBtn.style.display = 'inline-block';
    if (saveBtn) saveBtn.style.display = 'none';
    if (cancelBtn) cancelBtn.style.display = 'none';
};
async function renderNotes(page = 1) {
    try {
        const notesContent = document.getElementById('notesContent');
        if (!notesContent) return;
        
        currentNotesPage = page;
        const filters = window.currentFilters || {};
        
        // Build query with filters
        let countQuery = supabaseClient
            .from('shift_notes')
            .select('*', { count: 'exact', head: true });
            
        let dataQuery = supabaseClient
            .from('shift_notes')
            .select('*')
            .order('created_at', { ascending: false });

        // Apply date range filter if set
        if (filters.startDate) {
            const startDateTime = filters.startDate + 'T00:00:00';
            countQuery = countQuery.gte('created_at', startDateTime);
            dataQuery = dataQuery.gte('created_at', startDateTime);
        }
        if (filters.endDate) {
            const endDateTime = filters.endDate + 'T23:59:59';
            countQuery = countQuery.lte('created_at', endDateTime);
            dataQuery = dataQuery.lte('created_at', endDateTime);
        }

        // Apply staff filter if set
        if (filters.staffId) {
            countQuery = countQuery.eq('staff_id', filters.staffId);
            dataQuery = dataQuery.eq('staff_id', filters.staffId);
        }

        // Get total count with filters
        const { count } = await countQuery;
        
        const totalPages = Math.ceil((count || 0) / notesPerPage);
        const offset = (page - 1) * notesPerPage;
        
        // Get data for current page with filters
        const { data: notesData, error } = await dataQuery
            .range(offset, offset + notesPerPage - 1);
        
        if (error) throw error;
        
        // Manually enrich with related data
        const enrichedNotes = [];
        if (notesData) {
            for (const note of notesData) {
                const shift = shifts.find(s => s.id === note.shift_id) || {};
                const noteStaff = staff.find(s => s.id === note.staff_id) || {};
                const participant = shift.participant_id ? 
                    participants.find(p => p.id === shift.participant_id) : null;
                
                // Skip if participant filter is set and doesn't match
                if (filters.participantId) {
                    // Check if note has participant_id directly or through shift
                    const noteParticipantId = note.participant_id || shift.participant_id;
                    if (noteParticipantId !== filters.participantId) {
                        continue;
                    }
                }
                
                enrichedNotes.push({
                    ...note,
                    shift: shift,
                    staff: noteStaff,
                    participant: participant
                });
            }
        }
        
        // Start building HTML - KEEP YOUR EXISTING STYLES
        let html = `
            <style>
                .notes-wrapper {
                    background: white;
                    border-radius: var(--radius-lg);
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                }
                .note-item {
                    padding: 20px;
                    border-bottom: 1px solid #e9ecef;
                    transition: all 0.2s;
                }
                .note-item:hover {
                    background: #f8f9fa;
                }
                .note-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: start;
                    margin-bottom: 12px;
                }
                .note-actions {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                }
                .edit-note-btn, .save-note-btn, .cancel-note-btn {
                    padding: 4px 8px;
                    border: 1px solid #dee2e6;
                    border-radius: 4px;
                    background: white;
                    cursor: pointer;
                    font-size: 12px;
                }
                .save-note-btn {
                    background: #28a745;
                    color: white;
                    border-color: #28a745;
                }
                .cancel-note-btn {
                    background: #dc3545;
                    color: white;
                    border-color: #dc3545;
                }
                .note-type-badge {
                    display: inline-block;
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-right: 8px;
                }
                .note-type-shift, .note-type-general { background: #cce5ff; color: #004085; }
                .note-type-handover { background: #fff3cd; color: #856404; }
                .note-type-incident { background: #f8d7da; color: #721c24; }
                .note-type-activity { background: #d4edda; color: #155724; }
                .note-type-behaviour { background: #f5c6cb; color: #721c24; }
                .note-type-medical { background: #d1ecf1; color: #0c5460; }
                .note-content {
                    background: #f8f9fa;
                    padding: 16px;
                    border-radius: 8px;
                    margin: 12px 0;
                    line-height: 1.6;
                    color: var(--text-secondary);
                    white-space: pre-wrap;
                }
                .note-content-edit {
                    width: 100%;
                    min-height: 100px;
                    padding: 12px;
                    border: 1px solid #ced4da;
                    border-radius: 4px;
                    font-family: inherit;
                    font-size: 14px;
                    resize: vertical;
                }
                .note-meta {
                    font-size: 12px;
                    color: var(--text-muted);
                    display: flex;
                    gap: 16px;
                }
                .pagination {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 8px;
                    padding: 20px;
                    border-top: 1px solid #e9ecef;
                    background: #f8f9fa;
                }
                .pagination button {
                    padding: 8px 12px;
                    border: 1px solid #dee2e6;
                    background: white;
                    border-radius: 4px;
                    cursor: pointer;
                }
                .pagination button:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
            </style>
            <div class="notes-wrapper">
        `;
        
        if (enrichedNotes && enrichedNotes.length > 0) {
    enrichedNotes.forEach(note => {
        const isManager = currentUserRole === 'admin' || currentUserRole === 'manager';
        const canEdit = isManager || note.staff_id === currentStaffData?.id;
        
        const staffName = escapeHtml(`${note.staff?.first_name || 'Unknown'} ${note.staff?.last_name || ''}`);
        const noteType = escapeHtml(note.note_type || 'general');
        
        // Get participant name from participant_id field
        let participantName = '';
        if (note.participant_id) {
            const directParticipant = participants.find(p => p.id === note.participant_id);
            if (directParticipant) {
                participantName = escapeHtml(`${directParticipant.first_name} ${directParticipant.last_name}`);
            }
        }
        
        // Store raw note in base64 to avoid any escaping issues
        const noteDataEncoded = btoa(encodeURIComponent(note.note || ''));
        
        html += `
            <div class="note-item" data-note-id="${note.id}" data-note-content="${noteDataEncoded}">
                <div class="note-header">
                    <div>
                        <span class="note-type-badge note-type-${noteType}">${noteType}</span>
                        <strong>${staffName}</strong>
                        ${participantName ? `<span style="margin-left: 12px; padding: 2px 8px; background: #e9ecef; border-radius: 12px; font-size: 12px; color: #495057;">${participantName}</span>` : ''}
                        ${note.created_at ? `<span style="margin-left: 12px; font-size: 12px; color: var(--text-muted);">${formatDateFriendly(note.created_at.split('T')[0])}</span>` : ''}
                    </div>
                    <div class="note-actions">
                        <span style="font-size: 12px; color: var(--text-muted); margin-right: 12px;">
                            ${formatDateTime(note.created_at)}
                        </span>
                        ${canEdit ? `
                            <button class="edit-note-btn" onclick="window.editNote('${note.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="save-note-btn" onclick="window.saveNote('${note.id}')" style="display: none;">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="cancel-note-btn" onclick="window.cancelEditNote('${note.id}')" style="display: none;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        ` : ''}
                    </div>
                </div>
                <div class="note-content" id="note-content-${note.id}">${note.note || ''}</div>
            </div>
        `;
    });
    
    // Pagination remains the same
    if (totalPages > 1) {
        html += `
            <div class="pagination">
                <button onclick="renderNotes(1)" ${page === 1 ? 'disabled' : ''}>
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button onclick="renderNotes(${page - 1})" ${page === 1 ? 'disabled' : ''}>
                    <i class="fas fa-angle-left"></i> Previous
                </button>
                <span style="padding: 0 16px; font-size: 14px; color: #6c757d;">
                    Page ${page} of ${totalPages} (${count} notes)
                </span>
                <button onclick="renderNotes(${page + 1})" ${page === totalPages ? 'disabled' : ''}>
                    Next <i class="fas fa-angle-right"></i>
                </button>
                <button onclick="renderNotes(${totalPages})" ${page === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
        `;
    }
} else {
    // Show appropriate empty message based on filters
    const hasFilters = filters.startDate || filters.endDate || filters.staffId || filters.participantId;
    html += `
        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
            <h3>${hasFilters ? 'No notes match filters' : 'No notes found'}</h3>
            <p>${hasFilters ? 'Try adjusting your filters to see more notes' : 'Shift notes and communications will appear here'}</p>
            <button class="btn btn-primary" onclick="addShiftNote()" style="margin-top: 16px;">
                Add Shift Note
            </button>
        </div>
    `;
}

html += '</div>';
notesContent.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('notesContent').innerHTML = 
            '<div class="error">Failed to load notes: ' + error.message + '</div>';
    }
}

//=======SHIFT HANDOVER NOTE//
// Save edited note
async function saveNote(noteId) {
    try {
        const textarea = document.getElementById(`note-edit-${noteId}`);
        if (!textarea) return;
        
        const newContent = textarea.value.trim();
        if (!newContent) {
            showNotification('Note cannot be empty', 'error');
            return;
        }
        
        // Update in database
        const { error } = await supabaseClient
            .from('shift_notes')
            .update({ 
                note: newContent,
                updated_at: new Date().toISOString()
            })
            .eq('id', noteId);
        
        if (error) throw error;
        
        showNotification('Note updated successfully', 'success');
        
        // Refresh the notes display
        renderNotes(currentNotesPage);
        
    } catch (error) {
        console.error('Error updating note:', error);
        showNotification('Failed to update note', 'error');
    }
}

// Cancel edit
function cancelEditNote(noteId) {
    const noteContent = document.getElementById(`note-content-${noteId}`);
    const noteItem = document.querySelector(`[data-note-id="${noteId}"]`);
    
    if (!noteContent || !noteItem) return;
    
    // Restore original content
    const originalContent = noteContent.dataset.original || '';
    noteContent.innerHTML = originalContent;
    
    // Toggle buttons
    noteItem.querySelector('.edit-note-btn').style.display = 'inline-block';
    noteItem.querySelector('.save-note-btn').style.display = 'none';
    noteItem.querySelector('.cancel-note-btn').style.display = 'none';
}

function showAddNoteModal(shiftId = null) {
    let modal = document.getElementById('addNoteModal');
    
    if (!modal) {
        const modalHtml = `
            <div id="addNoteModal" class="modal-overlay" style="display: none;">
                <div class="modal">
                    <header class="modal-header">
                        <h3 class="modal-title">Edit Shift Note</h3>
                        <button class="modal-close" onclick="closeModal('addNoteModal')">&times;</button>
                    </header>
                    <div class="modal-content">
                        <form id="addNoteForm">
                            <input type="hidden" id="noteShiftId" value="">
                            <div class="form-group" id="shiftSelectGroup">
                                <label class="form-label">Shift *</label>
                                <select class="form-control" id="noteShift" required>
                                    <option value="">Select Shift</option>
                                </select>
                            </div>
                            <div class="form-group" id="shiftInfoGroup" style="display: none;">
                                <label class="form-label">Shift</label>
                                <div class="form-control" style="background: #f5f5f5; cursor: default;" id="shiftInfo">
                                    <!-- Shift info will be populated here -->
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Note</label>
                                <textarea class="form-control" id="noteContent" required 
                                          placeholder="Enter your note..." rows="4"></textarea>
                            </div>
                        </form>
                    </div>
                    <footer class="modal-footer">
                        <div class="modal-actions">
                            <button class="btn btn-outline" onclick="closeModal('addNoteModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="createNote()">Save Note</button>
                        </div>
                    </footer>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    requestAnimationFrame(async () => {
        const noteShiftIdElement = document.getElementById('noteShiftId');
        if (noteShiftIdElement) {
            noteShiftIdElement.value = shiftId || '';
        }
        
        const shiftSelectGroup = document.getElementById('shiftSelectGroup');
        const shiftInfoGroup = document.getElementById('shiftInfoGroup');
        const shiftInfo = document.getElementById('shiftInfo');
        const noteShift = document.getElementById('noteShift');
        const noteContent = document.getElementById('noteContent');
        
        if (shiftId && shiftId !== 'null' && shiftId !== 'undefined') {
            if (shiftSelectGroup) shiftSelectGroup.style.display = 'none';
            if (shiftInfoGroup) shiftInfoGroup.style.display = 'block';
            
            // Find shift and display info
            const shift = shifts.find(s => s.id == shiftId);
            if (shift) {
                if (shiftInfo) {
                    const staff = shift.staff || {};
                    const participant = shift.participant || {};
                    const shiftInfoText = `${formatDateFriendly(shift.date)} - ${staff.first_name || ''} ${staff.last_name || ''} / ${participant.first_name || 'Unassigned'} ${participant.last_name || ''}`;
                    shiftInfo.textContent = shiftInfoText;
                }
                
                // Load existing note into the textarea
                if (noteContent) {
                    noteContent.value = shift.notes || '';
                }
            }
        } else {
            // Show dropdown for general add
            if (shiftSelectGroup) shiftSelectGroup.style.display = 'block';
            if (shiftInfoGroup) shiftInfoGroup.style.display = 'none';
            
            // Clear the textarea for new note
            if (noteContent) noteContent.value = '';
            
            // Populate dropdown
            if (noteShift) {
                noteShift.innerHTML = '<option value="">Select Shift</option>';
                const relevantShifts = shifts.filter(shift => {
                    const shiftDate = new Date(shift.date);
                    const today = new Date();
                    const daysDiff = Math.abs((shiftDate - today) / (1000 * 60 * 60 * 24));
                    return daysDiff <= 30;
                });
                
                relevantShifts.forEach(shift => {
                    const staff = shift.staff || {};
                    const participant = shift.participant || {};
                    const shiftLabel = `${formatDateFriendly(shift.date)} - ${staff.first_name || ''} ${staff.last_name || ''} / ${participant.first_name || 'Unassigned'} ${participant.last_name || ''}`;
                    noteShift.innerHTML += `<option value="${shift.id}">${shiftLabel}</option>`;
                });
            }
        }
        
        const modalElement = document.getElementById('addNoteModal');
        if (modalElement) {
            modalElement.style.display = 'flex';
        }
    });
}

async function createNote() {
    try {
        // Get shift ID from hidden field or dropdown
        let shiftId = document.getElementById('noteShiftId').value;
        if (!shiftId) {
            shiftId = document.getElementById('noteShift').value;
        }
        shiftId = parseInt(shiftId);
        
        const noteContent = document.getElementById('noteContent').value;

        if (!shiftId || !noteContent?.trim()) {
            showNotification('Please fill in all fields', 'error');
            return;
        }

        // Update the shift's notes column
        const { error } = await supabaseClient
            .from('shifts')
            .update({ notes: noteContent.trim() })
            .eq('id', shiftId);

        if (error) throw error;

        showNotification('Note added successfully', 'success');
        closeModal('addNoteModal');
        
        // Refresh the current view if needed
        if (typeof loadShifts === 'function') {
            await loadShifts();
        }

    } catch (error) {
        console.error('Error creating note:', error);
        showNotification('Failed to add note: ' + error.message, 'error');
    }
}
        // ========================================
        // PUBLIC HOLIDAYS MANAGEMENT
        // ========================================

        async function loadPublicHolidays() {
    try {
        const { data: holidays, error } = await supabaseClient
            .from('public_holidays')
            .select('*')
            .order('date');
        
        if (error) throw error;
        
        // Clear and repopulate the Map
        publicHolidays.clear();
        holidays.forEach(holiday => {
            // Store date in YYYY-MM-DD format as key
            const dateKey = holiday.date.split('T')[0];
            publicHolidays.set(dateKey, {
                id: holiday.id,
                name: holiday.name,
                date: holiday.date
            });
        });
        
        console.log(`Loaded ${publicHolidays.size} public holidays from database`);
        return publicHolidays;
        
    } catch (error) {
        console.error('Error loading public holidays:', error);
        showNotification('Failed to load public holidays', 'error');
        return publicHolidays;
    }
}

// Add holiday to Supabase - Fixed version
async function addHoliday() {
    const date = document.getElementById('holidayDate').value;
    const name = document.getElementById('holidayName').value;
    
    if (!date || !name) {
        showNotification('Please enter both date and name', 'error');
        return;
    }
    
    try {
        // Generate a UUID for the id field (Supabase expects this)
        const holidayId = crypto.randomUUID();
        
        // Insert into Supabase with explicit ID
        const { data, error } = await supabaseClient
            .from('public_holidays')
            .insert([{
                id: holidayId,  // Explicitly provide the UUID
                date: date,
                name: name
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        // Update local cache
        publicHolidays.set(date, {
            id: data.id,
            name: data.name,
            date: data.date
        });
        
        populateHolidayList();
        
        // Clear the form
        document.getElementById('holidayDate').value = '';
        document.getElementById('holidayName').value = '';
        
        // Close modal if you have a cancelAddHoliday function
        if (typeof cancelAddHoliday === 'function') {
            cancelAddHoliday();
        }
        
        showNotification('Holiday added successfully', 'success');
        
        // Recalculate all shifts to apply new holiday
        await recalculateAllShifts();
        
    } catch (error) {
        console.error('Error adding holiday:', error);
        showNotification('Failed to add holiday: ' + error.message, 'error');
    }
}

// Remove holiday from Supabase
async function removeHoliday(holidayId) {
    if (!confirm('Are you sure you want to remove this holiday?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('public_holidays')
            .delete()
            .eq('id', holidayId);
        
        if (error) throw error;
        
        // Remove from local cache
        for (const [date, holiday] of publicHolidays.entries()) {
            if (holiday.id === holidayId) {
                publicHolidays.delete(date);
                break;
            }
        }
        
        populateHolidayList();
        showNotification('Holiday removed successfully', 'success');
        
        // Recalculate all shifts
        await recalculateAllShifts();
        
    } catch (error) {
        console.error('Error removing holiday:', error);
        showNotification('Failed to remove holiday', 'error');
    }
}

// Display holidays in the UI
function populateHolidayList() {
    const holidayList = document.getElementById('holidayList');
    if (!holidayList) return;
    
    if (publicHolidays.size === 0) {
        holidayList.innerHTML = `
            <div class="empty-state">
                <p style="color: #6c757d; text-align: center; padding: 20px;">
                    No holidays configured. Add holidays to apply penalty rates.
                </p>
            </div>`;
        return;
    }
    
    // Convert to array and sort by date
    const sortedHolidays = Array.from(publicHolidays.entries())
        .sort((a, b) => a[0].localeCompare(b[0]));
    
    holidayList.innerHTML = sortedHolidays.map(([date, holiday]) => `
        <div class="holiday-item" style="padding: 12px; border-bottom: 1px solid #e9ecef;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${holiday.name}</strong>
                    <span style="margin-left: 12px; color: #6c757d;">
                        ${formatDateFriendly(date)}
                    </span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="removeHoliday('${holiday.id}')">
                    <i class="fa-solid fa-trash"></i> Remove
                </button>
            </div>
        </div>
    `).join('');
}

// Helper function to recalculate all loaded shifts
async function recalculateAllShifts() {
    if (!window.shifts || shifts.length === 0) return;
    
    console.log('Recalculating all shifts with updated public holidays...');
    
    shifts.forEach(shift => {
        shift.calculated_hours = calculateShiftHours(shift);
        shift.calculated_pay = calculateShiftPay(shift, shift.calculated_hours);
        
        // Mark if it's a public holiday
        const shiftDateKey = shift.date.split('T')[0];
        shift.is_public_holiday = publicHolidays.has(shiftDateKey);
    });
    
    // Also update filtered shifts
    if (window.filteredShifts) {
        filteredShifts.forEach(shift => {
            shift.calculated_hours = calculateShiftHours(shift);
            shift.calculated_pay = calculateShiftPay(shift, shift.calculated_hours);
            
            // Mark if it's a public holiday
            const shiftDateKey = shift.date.split('T')[0];
            shift.is_public_holiday = publicHolidays.has(shiftDateKey);
        });
    }
    
    // Re-render current view
    if (typeof renderCurrentView === 'function') {
        renderCurrentView();
    } else if (typeof renderTimesheet === 'function') {
        renderTimesheet();
    }
}

        function showPublicHolidayModal() {
            document.getElementById('publicHolidayModal').style.display = 'flex';
            populateHolidayList();
        }

        function showAddHolidayForm() {
            document.getElementById('addHolidayForm').style.display = 'block';
        }

        function cancelAddHoliday() {
            document.getElementById('addHolidayForm').style.display = 'none';
            document.getElementById('holidayDate').value = '';
            document.getElementById('holidayName').value = '';
        }


        // ========================================
        // EXPORT FUNCTIONS - FIXED
        // ========================================

        function exportShifts() {
    if (!filteredShifts || filteredShifts.length === 0) {
        showNotification('No shifts to export', 'error');
        return;
    }
    
    // FIX #6: Include complete data in export
    const exportData = filteredShifts.map(shift => {
        const staffMember = staff.find(s => s.id === shift.staff_id);
        const participant = participants.find(p => p.id === shift.participant_id);
        const location = locations.find(l => l.id === shift.location_id);
        const dutyType = dutyTypes.find(d => d.id === shift.duty_type_id);
        const hours = calculateShiftHours(shift);
        
        // Format date properly for Excel
        const shiftDate = new Date(shift.date + 'T12:00:00');
        const formattedDate = shiftDate.toLocaleDateString('en-AU');
        
        return {
            ID: shift.id,
            Date: formattedDate,
            DayOfWeek: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][shiftDate.getDay()],
            StaffCode: staffMember?.staff_code || '',
            StaffFirstName: staffMember?.first_name || '',
            StaffLastName: staffMember?.last_name || '',
            ParticipantFirstName: participant?.first_name || '',
            ParticipantLastName: participant?.last_name || '',
            ParticipantNDIS: participant?.ndis_number || '',
            Location: location?.name || participant ? 'Client Home' : 'Unassigned',
            LocationAddress: location?.address || '',
            StartTime: shift.start_time || '',
            EndTime: shift.end_time || '',
            DutyType: dutyType?.name || '',
            Status: shift.status || 'scheduled',
            
            // Hours breakdown
            TotalHours: hours.total.toFixed(2),
            WeekdayDayHours: (hours.weekdayDay || 0).toFixed(2),
            WeekdayEveningHours: (hours.weekdayEvening || 0).toFixed(2),
            WeekdayNightHours: (hours.weekdayNight || 0).toFixed(2),
            SaturdayHours: (hours.saturday || 0).toFixed(2),
            SundayHours: (hours.sunday || 0).toFixed(2),
            PublicHolidayHours: (hours.publicHoliday || 0).toFixed(2),
            SleepoverCount: hours.sleepover ? (hours.sleepover / 2) : 0,
            
            // Pay information
            BaseRate: staffMember?.base_pay_rate || 0,
            CalculatedPay: (shift.calculated_pay || 0).toFixed(2),
            PayOverride: shift.pay_override_id ? 'Yes' : 'No',
            
            // Additional info
            Notes: shift.notes || '',
            CreatedAt: formatDateTime(shift.created_at),
            UpdatedAt: shift.updated_at ? formatDateTime(shift.updated_at) : '',
            TransferStatus: shift.transfer_status || '',
            AdjustmentStatus: shift.adjustment_status || ''
        };
    });
    
    downloadCSV(exportData, `shifts-export-${formatDate(new Date().toISOString())}.csv`);
    showNotification('Shifts exported successfully', 'success');
}

async function checkBulkShiftConflicts(shiftsToImport) {
    const conflicts = [];
    const warnings = [];
    
    for (const shift of shiftsToImport) {
        // Check for existing shifts
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', shift.staff_id)
            .eq('date', shift.date)
            .is('deleted_at', null);
        
        if (existingShifts && existingShifts.length > 0) {
            for (const existing of existingShifts) {
                // Check for overlaps
                if (shift.start_time && shift.end_time && existing.start_time && existing.end_time) {
                    const newStart = new Date(`2000-01-01T${shift.start_time}`);
                    const newEnd = new Date(`2000-01-01T${shift.end_time}`);
                    const existStart = new Date(`2000-01-01T${existing.start_time}`);
                    const existEnd = new Date(`2000-01-01T${existing.end_time}`);
                    
                    if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
                    if (existEnd <= existStart) existEnd.setDate(existEnd.getDate() + 1);
                    
                    if (!(newEnd <= existStart || newStart >= existEnd)) {
                        conflicts.push({
                            importShift: shift,
                            existingShift: existing,
                            type: 'overlap',
                            message: `Staff ${shift.staff_name} has overlapping shifts on ${shift.date}`
                        });
                    }
                }
            }
        }
        
        // Check weekly hour limits
        const weekStart = getFortnightStart(new Date(shift.date));
        const weekEnd = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
        
        const { data: weekShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', shift.staff_id)
            .gte('date', weekStart.toISOString().split('T')[0])
            .lt('date', weekEnd.toISOString().split('T')[0])
            .is('deleted_at', null);
        
        let weekHours = 0;
        if (weekShifts) {
            weekShifts.forEach(s => {
                const hours = calculateShiftHours(s);
                weekHours += hours.total;
            });
        }
        
        const shiftHours = calculateShiftHours(shift);
        const staffMember = staff.find(s => s.id === shift.staff_id);
        const limit = staffMember?.weekly_hour_limit || 38;
        
        if (weekHours + shiftHours.total > limit) {
            warnings.push({
                shift: shift,
                type: 'hours',
                message: `Staff ${shift.staff_name} will exceed ${limit}h weekly limit (${weekHours + shiftHours.total}h total)`
            });
        }
    }
    
    return { conflicts, warnings };
}

async function createCareHomeBatchShifts() {
    const careHomeId = document.getElementById('batchCareHomeSelect')?.value;
    const date = document.getElementById('batchShiftDate')?.value;
    const startTime = document.getElementById('batchStartTime')?.value;
    const endTime = document.getElementById('batchEndTime')?.value;
    const selectedStaffId = document.getElementById('batchStaffSelect')?.value;
    const dutyTypeId = document.getElementById('batchDutyType')?.value;
    
    if (!careHomeId || !date || !selectedStaffId || !dutyTypeId) {
        showNotification('Please fill all required fields', 'error');
        return;
    }
    
    const careHome = careHomes.get(careHomeId);
    if (!careHome || !careHome.residents) {
        showNotification('No residents found for this care home', 'error');
        return;
    }
    
    try {
        // Check staff availability first
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', selectedStaffId)
            .eq('date', date)
            .is('deleted_at', null);
        
        if (existingShifts && existingShifts.length > 0) {
            const message = `‚ö†Ô∏è WARNING\n\n` +
                `Staff member already has ${existingShifts.length} shift(s) on ${date}.\n` +
                `Creating ${careHome.residents.length} additional shifts.\n\n` +
                `Continue?`;
            
            if (!confirm(message)) {
                return;
            }
        }
        
        // Calculate duration for each shift
        const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeId);
        let duration = 0;
        
        if (selectedDutyType?.name.toLowerCase().includes('sleepover')) {
            duration = 2;
        } else if (startTime && endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            let end = new Date(`2000-01-01T${endTime}`);
            if (end <= start) end.setDate(end.getDate() + 1);
            duration = (end - start) / (1000 * 60 * 60);
        }
        
        // Create shifts for each resident
        const shiftsToCreate = careHome.residents.map(resident => ({
            date,
            start_time: startTime || null,
            end_time: endTime || null,
            staff_id: selectedStaffId,
            participant_id: resident.id,
            location_id: careHomeId,
            duty_type_id: dutyTypeId,
            status: 'confirmed',
            duration_hours: duration || null,
            notes: `Batch created for ${careHome.name}`,
            created_at: new Date().toISOString(),
            created_by: currentUser?.id || currentStaffData?.id
        }));
        
        // Batch insert
        const { data: createdShifts, error } = await supabaseClient
            .from('shifts')
            .insert(shiftsToCreate)
            .select();
        
        if (error) throw error;
        
        showNotification(`Created ${createdShifts.length} shifts for ${careHome.name}`, 'success');
        
        // Close modal if exists
        const modal = document.getElementById('batchCreateModal');
        if (modal) closeModal('batchCreateModal');
        
        await loadShifts();
        
        if (currentView === 'conflicts') {
            await renderConflicts();
        } else {
            renderCurrentView();
        }
        
    } catch (error) {
        console.error('Error creating batch shifts:', error);
        showNotification('Failed to create batch shifts: ' + error.message, 'error');
    }
}

function addStaffSwitcher() {
    // Check if switcher already exists
    if (document.getElementById('staffSwitcher')) return;
    
    const headerContent = document.querySelector('.header-content');
    if (!headerContent) return;
    
    const switcherHTML = `
        <div id="staffSwitcher" style="display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 14px;">View as:</label>
            <select id="staffSwitcherSelect" style="padding: 5px; border-radius: 4px;">
                <option value="">Current User</option>
            </select>
        </div>
    `;
    
    headerContent.insertAdjacentHTML('beforeend', switcherHTML);
    
    // Populate with staff
    const select = document.getElementById('staffSwitcherSelect');
    if (select && staff && staff.length > 0) {
        staff.forEach(s => {
            const option = document.createElement('option');
            option.value = s.id;
            option.textContent = `${s.first_name} ${s.last_name}`;
            if (s.id === currentStaffData?.id) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Add change handler
        select.addEventListener('change', async (e) => {
            const staffId = e.target.value;
            if (staffId) {
                currentStaffData = staff.find(s => s.id === staffId);
                await loadShifts();
                renderCurrentView();
            }
        });
    }
}

async function createCareHomeShifts() {
    const careHomeId = document.getElementById('batchCareHomeSelect')?.value;
    const date = document.getElementById('batchShiftDate')?.value;
    const startTime = document.getElementById('batchStartTime')?.value;
    const endTime = document.getElementById('batchEndTime')?.value;
    const selectedStaffId = document.getElementById('batchStaffSelect')?.value;
    const dutyTypeId = document.getElementById('batchDutyType')?.value;
    
    if (!careHomeId || !date || !selectedStaffId || !dutyTypeId) {
        showNotification('Please fill all required fields', 'error');
        return;
    }
    
    const careHome = careHomes.get(careHomeId);
    if (!careHome) {
        showNotification('Care home not found', 'error');
        return;
    }
    
    try {
        // Check for conflicts first
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', selectedStaffId)
            .eq('date', date)
            .is('deleted_at', null);
        
        if (existingShifts && existingShifts.length > 0) {
            if (!confirm(`Staff member already has ${existingShifts.length} shift(s) on this date. Continue?`)) {
                return;
            }
        }
        
        const shiftsToCreate = careHome.residents.map(resident => ({
            date: shiftDate,
        staff_id: selectedStaffId,
        participant_id: resident.id,
        location_id: careHome.location_id,
        duty_type_id: template.duty_type_id,
        start_time: template.start_time,
        end_time: template.end_time,
        status: 'scheduled',
        // FIX: Add pay_override_id
        pay_override_id: staff.find(s => s.id === selectedStaffId)?.pay_rate_id || null,
        created_by: currentStaffData.id,
        created_at: new Date().toISOString()
    }));
    
        
        // Calculate duration for each shift
        shiftsToCreate.forEach(shift => {
            const dutyType = dutyTypes.find(d => d.id === dutyTypeId);
            if (dutyType?.name.toLowerCase().includes('sleepover')) {
                shift.duration_hours = 2;
            } else if (startTime && endTime) {
                const start = new Date(`2000-01-01T${startTime}`);
                let end = new Date(`2000-01-01T${endTime}`);
                if (end <= start) end.setDate(end.getDate() + 1);
                shift.duration_hours = (end - start) / (1000 * 60 * 60);
            }
        });
        
        // Batch insert
        const { error } = await supabaseClient
            .from('shifts')
            .insert(shiftsToCreate);
        
        if (error) throw error;
        
        showNotification(`Created ${shiftsToCreate.length} shifts for ${careHome.name}`, 'success');
        closeModal('batchCreateModal');
        await loadShifts();
        
        if (currentView === 'conflicts') {
            await renderConflicts();
        } else {
            renderCurrentView();
        }
        
    } catch (error) {
        console.error('Error creating batch shifts:', error);
        showNotification('Failed to create batch shifts: ' + error.message, 'error');
    }
}

function generatePayrollSummary() {
   const startDate = document.getElementById('startDate').value;
   const endDate = document.getElementById('endDate').value;
   
   if (!startDate || !endDate) {
       showNotification('Please set date range for payroll', 'error');
       return;
   }
   
   const staffPayroll = {};
   
   // Group by staff and track hours by pay rate
   filteredShifts.forEach(shift => {
       const staffId = shift.staff_id;
       if (!staffId) return;
       
       if (!staffPayroll[staffId]) {
           staffPayroll[staffId] = {
               staff: shift.staff,
               defaultRateHours: { 
                   total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                   saturday: 0, sunday: 0, publicHoliday: 0
               },
               defaultRateSleepoverCount: 0,
               override1Hours: null,
               override2Hours: null,
               override3Hours: null,
               allHours: {
                   total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                   saturday: 0, sunday: 0, publicHoliday: 0
               },
               totalPay: 0,
               shifts: [],
               totalSleepoverCount: 0,
               overrideRatesMap: new Map()
           };
       }
       
       const entry = staffPayroll[staffId];
       const hours = shift.calculated_hours || {};
       
       entry.shifts.push(shift);
       entry.totalPay += shift.calculated_pay || 0;
       
       // Add to total hours regardless of rate
       entry.allHours.total += hours.total || 0;
       entry.allHours.weekdayDay += hours.weekdayDay || 0;
       entry.allHours.weekdayEvening += hours.weekdayEvening || 0;
       entry.allHours.weekdayNight += hours.weekdayNight || 0;
       entry.allHours.saturday += hours.saturday || 0;
       entry.allHours.sunday += hours.sunday || 0;
       entry.allHours.publicHoliday += hours.publicHoliday || 0;
       
       if (hours.sleepover > 0) {
           entry.totalSleepoverCount++;
       }
       
       // Determine which rate bucket to add hours to
       const hasOverride = shift.pay_override_id && shift.pay_override_id !== '00000000-0000-0000-0000-000000000002';
       
       if (hasOverride) {
           let overrideIndex = entry.overrideRatesMap.get(shift.pay_override_id);
           
           if (overrideIndex === undefined) {
               const overrideRate = payRates.find(pr => pr.id === shift.pay_override_id) || {};
               const overrideLabel = payRateLabels.get(shift.pay_override_id) || `Override Rate`;
               
               if (!entry.override1Hours) {
                   overrideIndex = 1;
                   entry.override1Hours = {
                       rateId: shift.pay_override_id,
                       rate: overrideRate,
                       label: overrideLabel,
                       hours: { total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                               saturday: 0, sunday: 0, publicHoliday: 0 },
                       sleepoverCount: 0
                   };
               } else if (!entry.override2Hours) {
                   overrideIndex = 2;
                   entry.override2Hours = {
                       rateId: shift.pay_override_id,
                       rate: overrideRate,
                       label: overrideLabel,
                       hours: { total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                               saturday: 0, sunday: 0, publicHoliday: 0 },
                       sleepoverCount: 0
                   };
               } else if (!entry.override3Hours) {
                   overrideIndex = 3;
                   entry.override3Hours = {
                       rateId: shift.pay_override_id,
                       rate: overrideRate,
                       label: overrideLabel,
                       hours: { total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                               saturday: 0, sunday: 0, publicHoliday: 0 },
                       sleepoverCount: 0
                   };
               }
               entry.overrideRatesMap.set(shift.pay_override_id, overrideIndex);
           }
           
           const overrideBucket = overrideIndex === 1 ? entry.override1Hours : 
                                 overrideIndex === 2 ? entry.override2Hours : 
                                 entry.override3Hours;
           
           if (overrideBucket) {
               overrideBucket.hours.total += hours.total || 0;
               overrideBucket.hours.weekdayDay += hours.weekdayDay || 0;
               overrideBucket.hours.weekdayEvening += hours.weekdayEvening || 0;
               overrideBucket.hours.weekdayNight += hours.weekdayNight || 0;
               overrideBucket.hours.saturday += hours.saturday || 0;
               overrideBucket.hours.sunday += hours.sunday || 0;
               overrideBucket.hours.publicHoliday += hours.publicHoliday || 0;
               
               if (hours.sleepover > 0) {
                   overrideBucket.sleepoverCount++;
               }
           }
       } else {
           entry.defaultRateHours.total += hours.total || 0;
           entry.defaultRateHours.weekdayDay += hours.weekdayDay || 0;
           entry.defaultRateHours.weekdayEvening += hours.weekdayEvening || 0;
           entry.defaultRateHours.weekdayNight += hours.weekdayNight || 0;
           entry.defaultRateHours.saturday += hours.saturday || 0;
           entry.defaultRateHours.sunday += hours.sunday || 0;
           entry.defaultRateHours.publicHoliday += hours.publicHoliday || 0;
           
           if (hours.sleepover > 0) {
               entry.defaultRateSleepoverCount++;
           }
       }
   });
   
   // Generate export data
   const payrollData = Object.values(staffPayroll).map(entry => {
       const staff = entry.staff || { first_name: 'Unknown', middle_name: '', last_name: 'Staff', staff_code: '', limits: 76, payg_withholding: 0 };
       const hourLimit = parseFloat(staff.limits) || 76;
       
       // Calculate total for limit check
       const totalForLimit = entry.allHours.total;
       const overLimit = totalForLimit > hourLimit;
       const hoursToDeduct = overLimit ? totalForLimit - hourLimit : 0;
       
       // Get default pay rate
       let defaultPayRate = payRates.find(pr => pr.id === staff.pay_rate_id) || {};
       const defaultPayRateLabel = payRateLabels.get(staff.pay_rate_id) || 'Standard Rate';
       
       // Build name with middle name
       const fullName = staff.middle_name ? 
           `${staff.first_name} ${staff.middle_name} ${staff.last_name}` :
           `${staff.first_name} ${staff.last_name}`;
       
       // Start building the row
       const row = {
           // === STAFF INFO ===
           'Name': fullName,
           'PAYG': staff.payg_withholding ? 'YES' : 'NO',           
           'Code': staff.staff_code || '',
           'Limit': hourLimit.toFixed(0),
           'Total Hrs': formatHours(entry.allHours.total),
           'Sleepovers': entry.totalSleepoverCount,
           'For Limit': formatHours(totalForLimit),
           'Over': overLimit ? 'YES' : 'NO',
           'Deduct': formatHours(hoursToDeduct),
           
           // === DEFAULT PAY RATE INFO ===
           'Rate': defaultPayRateLabel,
           'Weekday $': `$${(defaultPayRate.hourly_pay_rate || 0).toFixed(2)}`,
           'Evening $': `$${(defaultPayRate.afternoon || 0).toFixed(2)}`,
           'Night $': `$${(defaultPayRate.night || 0).toFixed(2)}`,
           'Saturday $': `$${(defaultPayRate.saturday || 0).toFixed(2)}`,
           'Sunday $': `$${(defaultPayRate.sunday || 0).toFixed(2)}`,
           'Holiday $': `$${(defaultPayRate.public_holiday || 0).toFixed(2)}`,
           'Sleepover $': `$${(defaultPayRate.sleepover || 0).toFixed(2)}`,
           
           // === DEFAULT RATE HOURS ===
           'Weekday': formatHours(entry.defaultRateHours.weekdayDay),
           'Evening': formatHours(entry.defaultRateHours.weekdayEvening),
           'Night': formatHours(entry.defaultRateHours.weekdayNight),
           'Saturday': formatHours(entry.defaultRateHours.saturday),
           'Sunday': formatHours(entry.defaultRateHours.sunday),
           'Holiday': formatHours(entry.defaultRateHours.publicHoliday),
           'Sleepover #': entry.defaultRateSleepoverCount
       };
       
       // === OVERRIDE RATE 1 ===
       if (entry.override1Hours) {
           const o1 = entry.override1Hours;
           row['Alt1 Rate'] = o1.label;
           row['Alt1 Weekday $'] = `$${(o1.rate.hourly_pay_rate || 0).toFixed(2)}`;
           row['Alt1 Evening $'] = `$${(o1.rate.afternoon || 0).toFixed(2)}`;
           row['Alt1 Night $'] = `$${(o1.rate.night || 0).toFixed(2)}`;
           row['Alt1 Saturday $'] = `$${(o1.rate.saturday || 0).toFixed(2)}`;
           row['Alt1 Sunday $'] = `$${(o1.rate.sunday || 0).toFixed(2)}`;
           row['Alt1 Holiday $'] = `$${(o1.rate.public_holiday || 0).toFixed(2)}`;
           row['Alt1 Sleepover $'] = `$${(o1.rate.sleepover || 0).toFixed(2)}`;
           row['Alt1 Weekday'] = formatHours(o1.hours.weekdayDay);
           row['Alt1 Evening'] = formatHours(o1.hours.weekdayEvening);
           row['Alt1 Night'] = formatHours(o1.hours.weekdayNight);
           row['Alt1 Saturday'] = formatHours(o1.hours.saturday);
           row['Alt1 Sunday'] = formatHours(o1.hours.sunday);
           row['Alt1 Holiday'] = formatHours(o1.hours.publicHoliday);
           row['Alt1 Sleepover #'] = o1.sleepoverCount;
       } else {
           row['Alt1 Rate'] = '';
           row['Alt1 Weekday $'] = '';
           row['Alt1 Evening $'] = '';
           row['Alt1 Night $'] = '';
           row['Alt1 Saturday $'] = '';
           row['Alt1 Sunday $'] = '';
           row['Alt1 Holiday $'] = '';
           row['Alt1 Sleepover $'] = '';
           row['Alt1 Weekday'] = '';
           row['Alt1 Evening'] = '';
           row['Alt1 Night'] = '';
           row['Alt1 Saturday'] = '';
           row['Alt1 Sunday'] = '';
           row['Alt1 Holiday'] = '';
           row['Alt1 Sleepover #'] = '';
       }
       
       // === OVERRIDE RATE 2 ===
       if (entry.override2Hours) {
           const o2 = entry.override2Hours;
           row['Alt2 Rate'] = o2.label;
           row['Alt2 Weekday $'] = `$${(o2.rate.hourly_pay_rate || 0).toFixed(2)}`;
           row['Alt2 Evening $'] = `$${(o2.rate.afternoon || 0).toFixed(2)}`;
           row['Alt2 Night $'] = `$${(o2.rate.night || 0).toFixed(2)}`;
           row['Alt2 Saturday $'] = `$${(o2.rate.saturday || 0).toFixed(2)}`;
           row['Alt2 Sunday $'] = `$${(o2.rate.sunday || 0).toFixed(2)}`;
           row['Alt2 Holiday $'] = `$${(o2.rate.public_holiday || 0).toFixed(2)}`;
           row['Alt2 Sleepover $'] = `$${(o2.rate.sleepover || 0).toFixed(2)}`;
           row['Alt2 Weekday'] = formatHours(o2.hours.weekdayDay);
           row['Alt2 Evening'] = formatHours(o2.hours.weekdayEvening);
           row['Alt2 Night'] = formatHours(o2.hours.weekdayNight);
           row['Alt2 Saturday'] = formatHours(o2.hours.saturday);
           row['Alt2 Sunday'] = formatHours(o2.hours.sunday);
           row['Alt2 Holiday'] = formatHours(o2.hours.publicHoliday);
           row['Alt2 Sleepover #'] = o2.sleepoverCount;
       } else {
           row['Alt2 Rate'] = '';
           row['Alt2 Weekday $'] = '';
           row['Alt2 Evening $'] = '';
           row['Alt2 Night $'] = '';
           row['Alt2 Saturday $'] = '';
           row['Alt2 Sunday $'] = '';
           row['Alt2 Holiday $'] = '';
           row['Alt2 Sleepover $'] = '';
           row['Alt2 Weekday'] = '';
           row['Alt2 Evening'] = '';
           row['Alt2 Night'] = '';
           row['Alt2 Saturday'] = '';
           row['Alt2 Sunday'] = '';
           row['Alt2 Holiday'] = '';
           row['Alt2 Sleepover #'] = '';
       }
       
       // === OVERRIDE RATE 3 ===
       if (entry.override3Hours) {
           const o3 = entry.override3Hours;
           row['Alt3 Rate'] = o3.label;
           row['Alt3 Weekday $'] = `$${(o3.rate.hourly_pay_rate || 0).toFixed(2)}`;
           row['Alt3 Evening $'] = `$${(o3.rate.afternoon || 0).toFixed(2)}`;
           row['Alt3 Night $'] = `$${(o3.rate.night || 0).toFixed(2)}`;
           row['Alt3 Saturday $'] = `$${(o3.rate.saturday || 0).toFixed(2)}`;
           row['Alt3 Sunday $'] = `$${(o3.rate.sunday || 0).toFixed(2)}`;
           row['Alt3 Holiday $'] = `$${(o3.rate.public_holiday || 0).toFixed(2)}`;
           row['Alt3 Sleepover $'] = `$${(o3.rate.sleepover || 0).toFixed(2)}`;
           row['Alt3 Weekday'] = formatHours(o3.hours.weekdayDay);
           row['Alt3 Evening'] = formatHours(o3.hours.weekdayEvening);
           row['Alt3 Night'] = formatHours(o3.hours.weekdayNight);
           row['Alt3 Saturday'] = formatHours(o3.hours.saturday);
           row['Alt3 Sunday'] = formatHours(o3.hours.sunday);
           row['Alt3 Holiday'] = formatHours(o3.hours.publicHoliday);
           row['Alt3 Sleepover #'] = o3.sleepoverCount;
       } else {
           row['Alt3 Rate'] = '';
           row['Alt3 Weekday $'] = '';
           row['Alt3 Evening $'] = '';
           row['Alt3 Night $'] = '';
           row['Alt3 Saturday $'] = '';
           row['Alt3 Sunday $'] = '';
           row['Alt3 Holiday $'] = '';
           row['Alt3 Sleepover $'] = '';
           row['Alt3 Weekday'] = '';
           row['Alt3 Evening'] = '';
           row['Alt3 Night'] = '';
           row['Alt3 Saturday'] = '';
           row['Alt3 Sunday'] = '';
           row['Alt3 Holiday'] = '';
           row['Alt3 Sleepover #'] = '';
       }
       
       // === DEDUCTIONS AND ADJUSTED HOURS ===
       const deductions = {
           default: { weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, saturday: 0, sunday: 0, publicHoliday: 0 },
           override1: { weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, saturday: 0, sunday: 0, publicHoliday: 0 },
           override2: { weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, saturday: 0, sunday: 0, publicHoliday: 0 },
           override3: { weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, saturday: 0, sunday: 0, publicHoliday: 0 }
       };
       
       if (overLimit) {
           const deductionPriority = [];
           
           ['weekdayDay', 'weekdayEvening', 'weekdayNight', 'saturday', 'sunday', 'publicHoliday'].forEach(cat => {
               if (entry.defaultRateHours[cat] > 0) {
                   const rateField = cat === 'weekdayDay' ? 'hourly_pay_rate' :
                                    cat === 'weekdayEvening' ? 'afternoon' :
                                    cat === 'weekdayNight' ? 'night' :
                                    cat === 'publicHoliday' ? 'public_holiday' : cat;
                   deductionPriority.push({
                       source: 'default',
                       category: cat,
                       hours: entry.defaultRateHours[cat],
                       rate: parseFloat(defaultPayRate[rateField]) || 0
                   });
               }
           });
           
           [entry.override1Hours, entry.override2Hours, entry.override3Hours].forEach((override, idx) => {
               if (override) {
                   ['weekdayDay', 'weekdayEvening', 'weekdayNight', 'saturday', 'sunday', 'publicHoliday'].forEach(cat => {
                       if (override.hours[cat] > 0) {
                           const rateField = cat === 'weekdayDay' ? 'hourly_pay_rate' :
                                            cat === 'weekdayEvening' ? 'afternoon' :
                                            cat === 'weekdayNight' ? 'night' :
                                            cat === 'publicHoliday' ? 'public_holiday' : cat;
                           deductionPriority.push({
                               source: `override${idx + 1}`,
                               category: cat,
                               hours: override.hours[cat],
                               rate: parseFloat(override.rate[rateField]) || 0
                           });
                       }
                   });
               }
           });
           
           deductionPriority.sort((a, b) => a.rate - b.rate);
           
           let remainingToDeduct = hoursToDeduct;
           for (const item of deductionPriority) {
               if (remainingToDeduct <= 0) break;
               const toDeduct = Math.min(item.hours, remainingToDeduct);
               deductions[item.source][item.category] = toDeduct;
               remainingToDeduct -= toDeduct;
           }
       }
       
       // === ADJUSTED HOURS COLUMNS ===
       row['Adj Weekday'] = formatHours(entry.defaultRateHours.weekdayDay - deductions.default.weekdayDay);
       row['Adj Evening'] = formatHours(entry.defaultRateHours.weekdayEvening - deductions.default.weekdayEvening);
       row['Adj Night'] = formatHours(entry.defaultRateHours.weekdayNight - deductions.default.weekdayNight);
       row['Adj Saturday'] = formatHours(entry.defaultRateHours.saturday - deductions.default.saturday);
       row['Adj Sunday'] = formatHours(entry.defaultRateHours.sunday - deductions.default.sunday);
       row['Adj Holiday'] = formatHours(entry.defaultRateHours.publicHoliday - deductions.default.publicHoliday);
       
       if (entry.override1Hours) {
           row['Alt1 Adj Weekday'] = formatHours(entry.override1Hours.hours.weekdayDay - deductions.override1.weekdayDay);
           row['Alt1 Adj Evening'] = formatHours(entry.override1Hours.hours.weekdayEvening - deductions.override1.weekdayEvening);
           row['Alt1 Adj Night'] = formatHours(entry.override1Hours.hours.weekdayNight - deductions.override1.weekdayNight);
           row['Alt1 Adj Saturday'] = formatHours(entry.override1Hours.hours.saturday - deductions.override1.saturday);
           row['Alt1 Adj Sunday'] = formatHours(entry.override1Hours.hours.sunday - deductions.override1.sunday);
           row['Alt1 Adj Holiday'] = formatHours(entry.override1Hours.hours.publicHoliday - deductions.override1.publicHoliday);
       } else {
           row['Alt1 Adj Weekday'] = '';
           row['Alt1 Adj Evening'] = '';
           row['Alt1 Adj Night'] = '';
           row['Alt1 Adj Saturday'] = '';
           row['Alt1 Adj Sunday'] = '';
           row['Alt1 Adj Holiday'] = '';
       }
       
       if (entry.override2Hours) {
           row['Alt2 Adj Weekday'] = formatHours(entry.override2Hours.hours.weekdayDay - deductions.override2.weekdayDay);
           row['Alt2 Adj Evening'] = formatHours(entry.override2Hours.hours.weekdayEvening - deductions.override2.weekdayEvening);
           row['Alt2 Adj Night'] = formatHours(entry.override2Hours.hours.weekdayNight - deductions.override2.weekdayNight);
           row['Alt2 Adj Saturday'] = formatHours(entry.override2Hours.hours.saturday - deductions.override2.saturday);
           row['Alt2 Adj Sunday'] = formatHours(entry.override2Hours.hours.sunday - deductions.override2.sunday);
           row['Alt2 Adj Holiday'] = formatHours(entry.override2Hours.hours.publicHoliday - deductions.override2.publicHoliday);
       } else {
           row['Alt2 Adj Weekday'] = '';
           row['Alt2 Adj Evening'] = '';
           row['Alt2 Adj Night'] = '';
           row['Alt2 Adj Saturday'] = '';
           row['Alt2 Adj Sunday'] = '';
           row['Alt2 Adj Holiday'] = '';
       }
       
       if (entry.override3Hours) {
           row['Alt3 Adj Weekday'] = formatHours(entry.override3Hours.hours.weekdayDay - deductions.override3.weekdayDay);
           row['Alt3 Adj Evening'] = formatHours(entry.override3Hours.hours.weekdayEvening - deductions.override3.weekdayEvening);
           row['Alt3 Adj Night'] = formatHours(entry.override3Hours.hours.weekdayNight - deductions.override3.weekdayNight);
           row['Alt3 Adj Saturday'] = formatHours(entry.override3Hours.hours.saturday - deductions.override3.saturday);
           row['Alt3 Adj Sunday'] = formatHours(entry.override3Hours.hours.sunday - deductions.override3.sunday);
           row['Alt3 Adj Holiday'] = formatHours(entry.override3Hours.hours.publicHoliday - deductions.override3.publicHoliday);
       } else {
           row['Alt3 Adj Weekday'] = '';
           row['Alt3 Adj Evening'] = '';
           row['Alt3 Adj Night'] = '';
           row['Alt3 Adj Saturday'] = '';
           row['Alt3 Adj Sunday'] = '';
           row['Alt3 Adj Holiday'] = '';
       }
       
       // === TOTALS ===
       const adjustedTotal = entry.allHours.total - hoursToDeduct;
       
       row['Final Hours'] = formatHours(adjustedTotal);
       row['Gross Pay'] = `$${entry.totalPay.toFixed(2)}`;
       row['Shifts'] = entry.shifts.length;
       row['Period'] = `${startDate} to ${endDate}`;
       
       return row;
   });
   
   downloadCSV(payrollData, `payroll-summary-${startDate}-to-${endDate}.csv`);
}

        function exportData() {
            // Fixed export with proper staff name handling
            const exportData = filteredShifts.map(shift => {
                const staff = shift.staff || { first_name: 'Unknown', last_name: 'Staff' };
                const participant = shift.participant || {};
                const location = shift.location || {};
                const dutyType = shift.duty_type || {};
                const hours = shift.calculated_hours || { total: 0 };
                
                return {
                    Date: formatDate(shift.date),
                    Staff: `${staff.first_name} ${staff.last_name}`,
                    Client: participant.first_name ? `${participant.first_name} ${participant.last_name}` : location.name || 'Unassigned',
                    StartTime: shift.start_time || '',
                    EndTime: shift.end_time || '',
                    DutyType: dutyType.name || '',
                    TotalHours: hours.total.toFixed(2),
                    TotalPay: (shift.calculated_pay || 0).toFixed(2),
                    Status: shift.status || 'pending'
                };
            });

            downloadCSV(exportData, 'shifts-export.csv');
        }

        function exportTimesheet() {
            generatePayrollSummary(); // Use detailed payroll export
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
        }

        function formatDateLong(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            const date = new Date(dateTimeString);
            return date.toLocaleString('en-AU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function downloadCSV(data, filename) {
            if (!data || data.length === 0) {
                showNotification('No data to export', 'error');
                return;
            }

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => 
                    `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                ).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`${filename} downloaded successfully`, 'success');
        }

        function showNotification(message, type = 'info') {
    // If you have a toast/notification system, use it here
    if (typeof showToast === 'function') {
        showToast(message, type);
    } else {
        // Fallback to console or alert
        console.log(`[${type.toUpperCase()}] ${message}`);
        
        // Optional: Create a simple notification
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
            color: white;
            border-radius: 5px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
}


function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    
    // Hide the modal instead of removing it
    if (modal) {
        modal.style.display = 'none';
        
        // Reset form if it exists inside the modal
        const form = modal.querySelector('form');
        if (form) {
            form.reset();
        }
    }
    
    // Remove backdrops (these can be safely removed since they're created fresh each time)
    const backdrop1 = document.getElementById(modalId.replace('Modal', 'Backdrop'));
    const backdrop2 = document.getElementById('editAssignmentBackdrop');
    const backdrop3 = document.getElementById('addAssignmentBackdrop');
    
    if (backdrop1) backdrop1.remove();
    if (backdrop2) backdrop2.remove();
    if (backdrop3) backdrop3.remove();
    
    // Remove any dynamically created modal backdrops
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.remove();
    });
    
    // For modals that should be removed (like assignment modals that are created dynamically)
    const dynamicModals = ['editAssignmentModal', 'addAssignmentModal'];
    if (dynamicModals.includes(modalId)) {
        if (modal) modal.remove();
    }
}
        function clearAllFilters() {
            document.getElementById('staffFilterInput').value = '';
            document.getElementById('participantFilterInput').value = '';
            document.getElementById('statusFilter').value = '';
            
            staffFilterValue = '';
            participantFilterValue = '';
            
            // Reset to current week
            setCurrentWeek();
            
            showNotification('All filters cleared, showing current week', 'info');
            applyFilters();
        }

        async function loadInitialData() {
    try {
        console.log('=== LOADING REFERENCE DATA ===');
        
        // Load all reference data in parallel
        const [
            { data: staffData, error: staffError },
            { data: participantsData, error: participantsError },
            { data: locationsData, error: locationsError },
            { data: dutyTypesData, error: dutyTypesError },
            { data: payRatesData, error: payRatesError },
            { data: payRateLabelsData, error: payRateLabelsError }
        ] = await Promise.all([
            supabaseClient.from('staff').select('*').eq('is_active', true).is('deleted_at', null).order('first_name'),
            supabaseClient.from('participants').select('*').eq('is_active', true).is('deleted_at', null).order('first_name'),
            supabaseClient.from('locations').select('*').order('name'),
            supabaseClient.from('duty_types').select('*').order('name'),
            supabaseClient.from('pay_rates').select('*').order('category, level, pay_point'),
            supabaseClient.from('pay_rate_labels').select('*')
        ]);

        // Check for errors
        if (staffError) throw staffError;
        if (participantsError) throw participantsError;
        if (locationsError) throw locationsError;
        if (dutyTypesError) throw dutyTypesError;
        if (payRatesError) throw payRatesError;
        if (payRateLabelsError) console.warn('Pay rate labels error:', payRateLabelsError);
        
        // Assign to global variables
        staff = staffData || [];
        participants = participantsData || [];
        locations = locationsData || [];
        dutyTypes = dutyTypesData || [];
        payRates = payRatesData || [];
        
        // Create pay rate labels map
        payRateLabels = new Map();
        if (payRateLabelsData) {
            payRateLabelsData.forEach(label => {
                payRateLabels.set(label.id, label.label);
            });
        }
        
        // Detect all care homes based on shared addresses
        detectCareHomes();
        
        console.log('Reference data loaded:', {
            staff: staff.length,
            participants: participants.length,
            locations: locations.length,
            dutyTypes: dutyTypes.length,
            payRates: payRates.length,
            payRateLabels: payRateLabels.size,
            careHomes: careHomes.size
        });
        
        // Initialize undo/redo buttons if they exist
        if (typeof UndoRedoManager !== 'undefined') {
            UndoRedoManager.updateButtons();
        }
        
        populateFilterDropdowns();
        populateModalDropdowns();

    } catch (error) {
        console.error('Error loading initial data:', error);
        showNotification('Failed to load reference data: ' + error.message, 'error');
    }
}

        function refreshData() {
            showNotification('Refreshing data...', 'info');
            Promise.all([loadInitialData(), loadShifts()])
                .then(() => {
                    showNotification('Data refreshed successfully', 'success');
                })
                .catch(error => {
                    console.error('Refresh error:', error);
                    showNotification('Failed to refresh data: ' + error.message, 'error');
                });
        }

        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Logout failed', 'error');
            }
        }

        // ========================================
        // DEBUG FUNCTIONS
        // ========================================

        async function debugDataLoading() {
            console.log('=== COMPREHENSIVE DEBUG ANALYSIS ===');
            
            try {
                // Database connectivity tests
                const { count: shiftCount } = await supabaseClient
                    .from('shifts')
                    .select('*', { count: 'exact', head: true });
                    
                const { count: staffCount } = await supabaseClient
                    .from('staff')
                    .select('*', { count: 'exact', head: true });

                // Sample data with detailed info
                const { data: sampleShifts } = await supabaseClient
                    .from('shifts')
                    .select('id, date, start_time, end_time, staff_id, status, duration_hours, deleted_at')
                    .is('deleted_at', null)
                    .limit(5);
                    
                const { data: sampleStaff } = await supabaseClient
                    .from('staff')
                    .select('id, first_name, last_name, limits, is_active')
                    .eq('is_active', true)
                    .limit(3);
                
                console.log('Debug results:', {
                    database: { shiftCount, staffCount },
                    loaded: { 
                        shifts: shifts.length, 
                        filtered: filteredShifts.length,
                        staff: staff.length,
                        participants: participants.length 
                    },
                    samples: { sampleShifts, sampleStaff }
                });
                
                // Calculate sample hours for debugging
                let calculationTest = '';
                if (sampleShifts && sampleShifts.length > 0) {
                    const testShift = sampleShifts[0];
                    calculationTest = `
HOUR CALCULATION TEST:
Shift ID: ${testShift.id}
Date: ${testShift.date}
Start: ${testShift.start_time}
End: ${testShift.end_time}
Duration DB: ${testShift.duration_hours}`;
                }
                
                const filters = {
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    staffFilter: staffFilterValue,
                    participantFilter: participantFilterValue
                };
                
                alert(`DEBUG RESULTS:

DATABASE:
‚Ä¢ ${shiftCount || 0} total shifts
‚Ä¢ ${staffCount || 0} total staff

LOADED DATA:
‚Ä¢ ${shifts.length} shifts in memory
‚Ä¢ ${filteredShifts.length} after filters
‚Ä¢ ${staff.length} staff loaded
‚Ä¢ ${participants.length} participants loaded
‚Ä¢ ${publicHolidays.size} public holidays

CURRENT FILTERS:
‚Ä¢ Date: ${filters.startDate} to ${filters.endDate}
‚Ä¢ Staff: ${filters.staffFilter || 'all'}
‚Ä¢ Participant: ${filters.participantFilter || 'all'}

SAMPLE SHIFTS IN DB:
${sampleShifts?.map(s => `‚Ä¢ ${s.date} ${s.start_time}-${s.end_time} (${s.duration_hours}h)`).join('\n') || 'No shifts found'}

SAMPLE STAFF:
${sampleStaff?.map(s => `‚Ä¢ ${s.first_name} ${s.last_name} (limit: ${s.limits}h)`).join('\n') || 'No staff found'}

${calculationTest}

NEXT STEPS:
1. If no data: Create test shifts
2. If data exists but filtered out: Clear filters
3. Check browser console for detailed logs`);
                
            } catch (error) {
                console.error('Debug error:', error);
                alert('Debug failed: ' + error.message);
            }
        }

        

        // ============================================
// ENHANCED FEATURES - ADD THIS ENTIRE BLOCK
// ============================================

// 1. Initialize Enhanced Features
function initializeEnhancements() {
    initializeDarkMode();
    resetSessionTimer();
    addEnhancedUIElements();
}

// 2. Dark Mode Implementation
function initializeDarkMode() {
    const savedMode = localStorage.getItem('darkMode') || 'light';
    document.body.setAttribute('data-theme', savedMode);
    
    // Add dark mode styles
    if (!document.getElementById('darkModeStyles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'darkModeStyles';
        styleSheet.innerHTML = `
            [data-theme="dark"] {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --bg-light: #3a3a3a;
                --text-primary: #e0e0e0;
                --text-secondary: #b0b0b0;
                --text-muted: #808080;
                --border-color: #404040;
                --border-light: #333333;
            }
            
            [data-theme="dark"] .modal {
                background: var(--bg-secondary);
                color: var(--text-primary);
            }
            
            [data-theme="dark"] .roster-table {
                background: var(--bg-secondary);
            }
            
            [data-theme="dark"] input, 
            [data-theme="dark"] select, 
            [data-theme="dark"] textarea {
                background: var(--bg-light);
                color: var(--text-primary);
                border-color: var(--border-color);
            }
            
            [data-theme="dark"] .card {
                background: var(--bg-secondary);
                border-color: var(--border-color);
            }
        `;
        document.head.appendChild(styleSheet);
    }
}

function toggleDarkMode() {
    const currentMode = document.body.getAttribute('data-theme') || 'light';
    const newMode = currentMode === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newMode);
    localStorage.setItem('darkMode', newMode);
    
    // Update button icon
    const btn = document.getElementById('darkModeBtn');
    if (btn) btn.innerHTML = newMode === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}


async function copyShift(shiftId) {
    const shift = shifts.find(s => s.id === shiftId);
    if (!shift) return;
    
    const newDate = prompt('Enter date for copied shift (YYYY-MM-DD):', shift.date);
    if (!newDate) return;
    
    try {
        const shiftData = {
            date: newDate,
            start_time: shift.start_time,
            end_time: shift.end_time,
            staff_id: shift.staff_id,
            participant_id: shift.participant_id,
            location_id: shift.location_id,
            duty_type_id: shift.duty_type_id,
            pay_override_id: shift.pay_override_id || '00000000-0000-0000-0000-000000000002', // FIXED!
            status: 'pending',
            created_by: currentStaffData?.id || currentUser.id
        };
        
        const { error } = await supabaseClient
            .from('shifts')
            .insert([shiftData]);
        
        if (!error) {
            showNotification('Shift copied successfully', 'success');
            await loadShifts();
        } else {
            throw error;
        }
    } catch (error) {
        showNotification('Failed to copy shift: ' + error.message, 'error');
    }
}

async function duplicateWeek() {
    const confirmDupe = confirm('Duplicate all shifts from current week to next week?');
    if (!confirmDupe) return;
    
    try {
        const weekStart = getFortnightStart(currentWeekStart);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        const weekShifts = shifts.filter(s => 
            s.date >= weekStart.toISOString().split('T')[0] &&
            s.date <= weekEnd.toISOString().split('T')[0]
        );
        
        if (weekShifts.length === 0) {
            showNotification('No shifts to duplicate in current week', 'warning');
            return;
        }
        
        const newShifts = weekShifts.map(shift => {
            const newDate = new Date(shift.date);
            newDate.setDate(newDate.getDate() + 7);
            
            return {
                date: newDate.toISOString().split('T')[0],
                start_time: shift.start_time,
                end_time: shift.end_time,
                staff_id: shift.staff_id,
                participant_id: shift.participant_id,
                location_id: shift.location_id,
                duty_type_id: shift.duty_type_id,
                pay_override_id: shift.pay_override_id || '00000000-0000-0000-0000-000000000002', // FIXED!
                status: 'pending',
                created_by: currentStaffData?.id || currentUser.id
            };
        });
        
        const { error } = await supabaseClient
            .from('shifts')
            .insert(newShifts);
        
        if (!error) {
            showNotification(`${newShifts.length} shifts duplicated to next week`, 'success');
            nextWeek();
        } else {
            throw error;
        }
    } catch (error) {
        showNotification('Failed to duplicate week: ' + error.message, 'error');
    }
}

// 5. Auto-save Indicator
function showSaving() {
    let indicator = document.getElementById('saveIndicator');
    
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'saveIndicator';
        indicator.style.cssText = `
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 8px;
        `;
        document.body.appendChild(indicator);
    }
    
    indicator.innerHTML = '‚è≥ Saving...';
    indicator.style.display = 'flex';
    
    setTimeout(() => {
        indicator.innerHTML = '‚úì Saved';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 2000);
    }, 500);
}


function performGlobalSearch() {
    const query = document.getElementById('globalSearchInput').value.toLowerCase();
    const results = document.getElementById('searchResults');
    
    if (query.length < 2) {
        results.innerHTML = '<p style="color: var(--text-muted);">Type at least 2 characters...</p>';
        return;
    }
    
    let html = '';
    
    // Search staff
    const matchingStaff = staff.filter(s => 
        `${s.first_name} ${s.last_name}`.toLowerCase().includes(query)
    );
    
    if (matchingStaff.length > 0) {
        html += '<h4>Staff</h4>';
        matchingStaff.forEach(s => {
            html += `
                <div style="padding: 8px; cursor: pointer; border-radius: 4px;" 
                     onmouseover="this.style.background='var(--bg-light)'"
                     onmouseout="this.style.background='transparent'"
                     onclick="document.getElementById('staffFilterInput').value='${s.first_name} ${s.last_name}'; 
                              updateStaffFilter(); closeModal('searchModal');">
                    üë§ ${s.first_name} ${s.last_name}
                </div>`;
        });
    }
    
    // Search participants
    const matchingParticipants = participants.filter(p => 
        `${p.first_name} ${p.last_name}`.toLowerCase().includes(query)
    );
    
    if (matchingParticipants.length > 0) {
        html += '<h4 style="margin-top: 16px;">Participants</h4>';
        matchingParticipants.forEach(p => {
            html += `
                <div style="padding: 8px; cursor: pointer; border-radius: 4px;"
                     onmouseover="this.style.background='var(--bg-light)'"
                     onmouseout="this.style.background='transparent'"
                     onclick="document.getElementById('participantFilterInput').value='${p.first_name} ${p.last_name}'; 
                              updateParticipantFilter(); closeModal('searchModal');">
                    üë• ${p.first_name} ${p.last_name}
                </div>`;
        });
    }
    
    results.innerHTML = html || '<p style="text-align: center; color: var(--text-muted);">No results found</p>';
}

// 7. Print Function
function printRoster() {
    // Add print styles if not already added
    if (!document.getElementById('printStyles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'printStyles';
        styleSheet.innerHTML = `
            @media print {
                .header, .filters-section, .view-actions, .modal, .view-toggle, .btn { 
                    display: none !important; 
                }
                
                body { 
                    font-size: 10pt; 
                    color: black !important;
                    background: white !important;
                }
                
                .roster-table { 
                    width: 100%; 
                    border-collapse: collapse;
                    background: white !important;
                }
                
                .roster-table th, .roster-table td { 
                    border: 1px solid #000 !important; 
                    padding: 4px !important;
                    font-size: 9pt !important;
                    color: black !important;
                }
                
                @page { 
                    margin: 1cm;
                    size: landscape;
                }
            }
        `;
        document.head.appendChild(styleSheet);
    }
    
    window.print();
}

// 8. Quick Status Change
async function quickStatusChange(shiftId, newStatus) {
    if (!newStatus) return;
    
    try {
        const { error } = await supabaseClient
            .from('shifts')
            .update({ 
                status: newStatus,
                updated_at: new Date().toISOString()
            })
            .eq('id', shiftId);
        
        if (!error) {
            showSaving();
            showNotification(`Status updated to ${newStatus}`, 'success');
            await loadShifts();
        } else {
            throw error;
        }
    } catch (error) {
        showNotification('Failed to update status: ' + error.message, 'error');
    }
}

// 9. Session Management
let sessionTimer;
let warningTimer;
const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
const WARNING_TIME = 5 * 60 * 1000; // 5 minute warning

function resetSessionTimer() {
    clearTimeout(sessionTimer);
    clearTimeout(warningTimer);
    
    warningTimer = setTimeout(() => {
        if (confirm('Your session will expire in 5 minutes. Stay logged in?')) {
            resetSessionTimer();
        }
    }, SESSION_TIMEOUT - WARNING_TIME);
    
    sessionTimer = setTimeout(() => {
        alert('Session expired. Please log in again.');
        window.location.href = 'index.html';
    }, SESSION_TIMEOUT);
}

// Reset timer on activity
document.addEventListener('click', resetSessionTimer);
document.addEventListener('keypress', resetSessionTimer);

// 10. Export Functions
function exportJSON() {
    const dataStr = JSON.stringify(filteredShifts, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `roster_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

async function processCSVImport(csvData) {
    try {
        // Parse CSV data (assuming you have parsing logic)
        const shiftsToImport = parseCSVData(csvData);
        
        // FIX #2: Check conflicts before bulk import
        const conflictReport = {
            overlaps: [],
            sleepovers: [],
            weeklyLimits: [],
            skipped: 0,
            imported: 0
        };
        
        const validShifts = [];
        
        for (const importShift of shiftsToImport) {
            let hasConflict = false;
            
            // Check for existing shifts
            const { data: existingShifts } = await supabaseClient
                .from('shifts')
                .select('*')
                .eq('staff_id', importShift.staff_id)
                .eq('date', importShift.date)
                .is('deleted_at', null);
            
            // Check for sleepover conflicts
            const isImportSleepover = importShift.duty_type?.toLowerCase().includes('sleepover');
            const existingSleepover = (existingShifts || []).find(s => {
                const dt = dutyTypes.find(d => d.id === s.duty_type_id);
                return dt?.name?.toLowerCase().includes('sleepover');
            });
            
            if (isImportSleepover && existingSleepover) {
                conflictReport.sleepovers.push({
                    shift: importShift,
                    reason: 'Staff already has sleepover on this date'
                });
                hasConflict = true;
                continue;
            }
            
            // Check for time overlaps
            if (importShift.start_time && importShift.end_time && !isImportSleepover) {
                const newStart = new Date(`2000-01-01T${importShift.start_time}`);
                let newEnd = new Date(`2000-01-01T${importShift.end_time}`);
                if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
                
                for (const existing of (existingShifts || [])) {
                    if (existing.start_time && existing.end_time) {
                        const existingStart = new Date(`2000-01-01T${existing.start_time}`);
                        let existingEnd = new Date(`2000-01-01T${existing.end_time}`);
                        if (existingEnd <= existingStart) existingEnd.setDate(existingEnd.getDate() + 1);
                        
                        if (!(newEnd <= existingStart || newStart >= existingEnd)) {
                            conflictReport.overlaps.push({
                                importShift,
                                existingShift: existing,
                                overlapHours: ((Math.min(newEnd, existingEnd) - Math.max(newStart, existingStart)) / (1000 * 60 * 60)).toFixed(1)
                            });
                            hasConflict = true;
                            break;
                        }
                    }
                }
            }
            
            // Check weekly hours
            const weekStart = new Date(importShift.date);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const { data: weekShifts } = await supabaseClient
                .from('shifts')
                .select('*')
                .eq('staff_id', importShift.staff_id)
                .gte('date', weekStart.toISOString().split('T')[0])
                .lte('date', weekEnd.toISOString().split('T')[0])
                .is('deleted_at', null);
            
            let totalWeekHours = 0;
            (weekShifts || []).forEach(s => {
                totalWeekHours += s.duration_hours || 0;
            });
            
            const staffMember = staff.find(s => s.id === importShift.staff_id);
            const weeklyLimit = staffMember?.weekly_hour_limit || 38;
            const importHours = importShift.duration_hours || 0;
            
            if (totalWeekHours + importHours > weeklyLimit) {
                conflictReport.weeklyLimits.push({
                    shift: importShift,
                    currentHours: totalWeekHours,
                    newTotal: totalWeekHours + importHours,
                    limit: weeklyLimit
                });
            }
            
            if (!hasConflict) {
                validShifts.push(importShift);
            } else {
                conflictReport.skipped++;
            }
        }
        
        // Show conflict report if there are issues
        if (conflictReport.overlaps.length > 0 || 
            conflictReport.sleepovers.length > 0 || 
            conflictReport.weeklyLimits.length > 0) {
            
            let message = 'IMPORT CONFLICTS DETECTED\n\n';
            
            if (conflictReport.overlaps.length > 0) {
                message += `‚ö†Ô∏è ${conflictReport.overlaps.length} overlapping shifts\n`;
            }
            if (conflictReport.sleepovers.length > 0) {
                message += `üõèÔ∏è ${conflictReport.sleepovers.length} sleepover conflicts\n`;
            }
            if (conflictReport.weeklyLimits.length > 0) {
                message += `‚è∞ ${conflictReport.weeklyLimits.length} weekly hour limit warnings\n`;
            }
            
            message += `\n‚úì ${validShifts.length} shifts ready to import\n`;
            message += `‚úó ${conflictReport.skipped} shifts will be skipped\n\n`;
            message += 'Do you want to proceed with importing valid shifts only?';
            
            if (!confirm(message)) {
                showNotification('Import cancelled', 'info');
                return;
            }
        }
        
        // Import valid shifts
        if (validShifts.length > 0) {
            const { error } = await supabaseClient
                .from('shifts')
                .insert(validShifts);
            
            if (error) throw error;
            
            showNotification(`Successfully imported ${validShifts.length} shifts`, 'success');
            conflictReport.imported = validShifts.length;
        } else {
            showNotification('No valid shifts to import', 'warning');
        }
        
        // Generate detailed report
        generateImportReport(conflictReport);
        
        await loadShifts();
        if (currentView === 'conflicts') {
            await renderConflicts();
        } else {
            renderCurrentView();
        }
        
    } catch (error) {
        console.error('Error processing CSV import:', error);
        showNotification('Failed to import shifts: ' + error.message, 'error');
    }
}

function generateImportReport(report) {
    // Create a detailed CSV report of conflicts
    let csvContent = 'Type,Date,Staff,Details,Status\n';
    
    report.overlaps.forEach(item => {
        const staffName = staff.find(s => s.id === item.importShift.staff_id)?.first_name || 'Unknown';
        csvContent += `Overlap,${item.importShift.date},${staffName},"${item.overlapHours}h overlap",Skipped\n`;
    });
    
    report.sleepovers.forEach(item => {
        const staffName = staff.find(s => s.id === item.shift.staff_id)?.first_name || 'Unknown';
        csvContent += `Sleepover,${item.shift.date},${staffName},"${item.reason}",Skipped\n`;
    });
    
    report.weeklyLimits.forEach(item => {
        const staffName = staff.find(s => s.id === item.shift.staff_id)?.first_name || 'Unknown';
        csvContent += `Hours,Week of ${item.shift.date},${staffName},"${item.newTotal}h exceeds ${item.limit}h limit",Warning\n`;
    });
    
    // Download the report
    downloadCSV(csvContent, `import-report-${new Date().toISOString().split('T')[0]}.csv`);
}

function exportDetailedCSV() {
    let csv = 'Date,Day,Start Time,End Time,Staff Name,Participant,Location,Duty Type,Hours,Status,Pay Rate,Total Pay\n';
    
    filteredShifts.forEach(shift => {
        const row = [
            shift.date,
            new Date(shift.date).toLocaleDateString('en-AU', {weekday: 'short'}),
            shift.start_time || 'N/A',
            shift.end_time || 'N/A',
            `${shift.staff?.first_name || ''} ${shift.staff?.last_name || ''}`,
            shift.participant ? `${shift.participant.first_name} ${shift.participant.last_name}` : '',
            shift.location?.name || '',
            shift.duty_type?.name || '',
            shift.calculated_hours?.total?.toFixed(2) || '0',
            shift.status || 'pending',
            payRateLabels.get(shift.staff?.pay_rate_id) || 'Standard',
            shift.calculated_pay?.toFixed(2) || '0'
        ];
        csv += row.map(cell => `"${cell}"`).join(',') + '\n';
    });
    
    downloadCSV(csv, `roster_detailed_${new Date().toISOString().split('T')[0]}.csv`);
}

// 11. Add UI Enhancement Buttons
function addEnhancedUIElements() {
    // Add buttons to view-actions if they don't exist
    const viewActions = document.querySelector('.view-actions');
    if (viewActions && !document.getElementById('enhancedButtons')) {
        const enhancedButtons = document.createElement('div');
        enhancedButtons.id = 'enhancedButtons';
        enhancedButtons.style.display = 'inline-flex';
        enhancedButtons.style.gap = '8px';
        enhancedButtons.style.marginLeft = '8px';
        enhancedButtons.innerHTML = `
            <span style="border-left: 1px solid var(--border-color); margin: 0 8px; height: 24px;"></span>
            <button class="btn btn-outline btn-sm" id="darkModeBtn" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                ${document.body.getAttribute('data-theme') === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
            </button>
            <button class="btn btn-outline btn-sm" onclick="showGlobalSearch()" title="Search (Ctrl+K)">üîç</button>
            <button class="btn btn-outline btn-sm" onclick="duplicateWeek()" title="Duplicate Week">üìã</button>
            <button class="btn btn-outline btn-sm" onclick="printRoster()" title="Print (Ctrl+P)">üñ®Ô∏è</button>
            <button class="btn btn-outline btn-sm" onclick="exportDetailedCSV()" title="Export Detailed CSV">üìä</button>
            <button class="btn btn-outline btn-sm" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts">‚å®Ô∏è</button>
        `;
        viewActions.appendChild(enhancedButtons);
    }
}

// 12. Keyboard Shortcuts Help
function showKeyboardShortcuts() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <header class="modal-header">
                <h3 class="modal-title">Keyboard Shortcuts</h3>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </header>
            <div class="modal-content">
                <table style="width: 100%;">
                    <tr><td><kbd>N</kbd></td><td>New Shift</td></tr>
                    <tr><td><kbd>F</kbd></td><td>Focus Search</td></tr>
                    <tr><td><kbd>T</kbd></td><td>Go to Today</td></tr>
                    <tr><td><kbd>‚Üê</kbd> <kbd>‚Üí</kbd></td><td>Navigate Weeks</td></tr>
                    <tr><td><kbd>1-5</kbd></td><td>Switch Views</td></tr>
                    <tr><td><kbd>Ctrl+K</kbd></td><td>Global Search</td></tr>
                    <tr><td><kbd>Ctrl+Z</kbd></td><td>Undo</td></tr>
                    <tr><td><kbd>Ctrl+Y</kbd></td><td>Redo</td></tr>
                    <tr><td><kbd>Ctrl+P</kbd></td><td>Print</td></tr>
                </table>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function renderConflicts() {
    const conflictsContent = document.getElementById('conflictsContent');
    if (!conflictsContent) {
        // Create the view if it doesn't exist
        const conflictsView = document.getElementById('conflictsView');
        if (conflictsView) {
            // Use the standard structure that matches other tabs
            conflictsView.innerHTML = `
                <div id="conflictsContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Analyzing shifts for conflicts...</span>
                    </div>
                </div>
            `;
            
            // Now set up the header in the same way as other tabs
            // This assumes you have a standard header area for the conflicts tab
            const conflictsHeader = document.querySelector('#conflicts .menu-header') || 
                                   document.querySelector('[data-view="conflicts"] .menu-header');
            if (conflictsHeader && !conflictsHeader.querySelector('.table-actions')) {
                conflictsHeader.innerHTML = `
                    <h2>‚ö†Ô∏è Scheduling Conflicts & Issues</h2>
                    <div class="table-actions">
                        <button class="btn btn-outline btn-sm" onclick="renderConflicts()">
                            <span style="margin-right: 4px;"></span> Refresh
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="autoResolveConflicts()" style="margin-left: 8px;">
                            <span style="margin-right: 4px;">üîß</span> Auto-Resolve
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportConflictsReport()" style="margin-left: 8px;">
                            <span style="margin-right: 4px;">üìä</span> Export Report
                        </button>
                    </div>
                `;
            }
            
            // Get the content area again after creating it
            const newConflictsContent = document.getElementById('conflictsContent');
            if (newConflictsContent) {
                await renderConflicts();
            }
            return;
        }
        return;
    }
    
    console.log('Analyzing conflicts in', shifts.length, 'shifts...');
    
    // Analyze all shifts for conflicts
    const conflicts = {
        staffDoubleBooking: [],
        sleepoverViolations: [],
        excessiveHours: [],
        missingTimes: [],
        unconfirmedShifts: [],
        noPayRate: [],
        participantOverlaps: []
    };
    
    // 1. Check for staff double-booking
    const staffShiftsByDate = {};
    shifts.forEach(shift => {
        const key = `${shift.staff_id}_${shift.date}`;
        if (!staffShiftsByDate[key]) {
            staffShiftsByDate[key] = [];
        }
        staffShiftsByDate[key].push(shift);
    });
    
    Object.entries(staffShiftsByDate).forEach(([key, dayShifts]) => {
        if (dayShifts.length > 1) {
            // Check for time overlaps
            for (let i = 0; i < dayShifts.length - 1; i++) {
                for (let j = i + 1; j < dayShifts.length; j++) {
                    const shift1 = dayShifts[i];
                    const shift2 = dayShifts[j];
                    
                    if (shift1.start_time && shift1.end_time && 
                        shift2.start_time && shift2.end_time) {
                        
                        const start1 = new Date(`2000-01-01T${shift1.start_time}`);
                        let end1 = new Date(`2000-01-01T${shift1.end_time}`);
                        const start2 = new Date(`2000-01-01T${shift2.start_time}`);
                        let end2 = new Date(`2000-01-01T${shift2.end_time}`);
                        
                        if (end1 <= start1) end1.setDate(end1.getDate() + 1);
                        if (end2 <= start2) end2.setDate(end2.getDate() + 1);
                        
                        // Check for overlap
                        if (!(end1 <= start2 || start1 >= end2)) {
                            const overlapStart = new Date(Math.max(start1, start2));
                            const overlapEnd = new Date(Math.min(end1, end2));
                            
                            conflicts.staffDoubleBooking.push({
                                staff: shift1.staff,
                                date: shift1.date,
                                shift1: shift1,
                                shift2: shift2,
                                overlapPeriod: {
                                    start: overlapStart.toTimeString().slice(0, 5),
                                    end: overlapEnd.toTimeString().slice(0, 5),
                                    hours: ((overlapEnd - overlapStart) / (1000 * 60 * 60)).toFixed(1)
                                }
                            });
                        }
                    }
                }
            }
            
            // Check for sleepover violations
            const sleepover = dayShifts.find(s => 
                s.duty_type?.name?.toLowerCase().includes('sleepover')
            );
            
            if (sleepover) {
                dayShifts.forEach(shift => {
                    if (shift.id !== sleepover.id && shift.start_time) {
                        const startHour = parseInt(shift.start_time.split(':')[0]);
                        const endHour = shift.end_time ? 
                            parseInt(shift.end_time.split(':')[0]) : 0;
                        
                        if (startHour >= 22 || startHour < 6 || 
                            (endHour > 0 && endHour <= 6)) {
                            conflicts.sleepoverViolations.push({
                                staff: shift.staff,
                                date: shift.date,
                                sleepoverShift: sleepover,
                                conflictingShift: shift,
                                reason: startHour >= 22 ? 
                                    'Late night shift (after 10pm) with sleepover' : 
                                    'Early morning shift (before 6am) with sleepover'
                            });
                        }
                    }
                });
            }
        }
    });
    
    // 2. Check for excessive hours (over limit in week)
    const weekGroups = {};
    shifts.forEach(shift => {
        const weekStart = getFortnightStart(new Date(shift.date));
        const weekKey = `${shift.staff_id}_${weekStart.toISOString().split('T')[0]}`;
        
        if (!weekGroups[weekKey]) {
            weekGroups[weekKey] = {
                staff: shift.staff,
                weekStart: weekStart,
                shifts: [],
                totalHours: 0
            };
        }
        
        weekGroups[weekKey].shifts.push(shift);
        weekGroups[weekKey].totalHours += shift.calculated_hours?.total || 0;
    });
    
    Object.values(weekGroups).forEach(group => {
        const limit = group.staff?.limits || 76;
        if (group.totalHours > limit) {
            conflicts.excessiveHours.push({
                staff: group.staff,
                weekStart: group.weekStart,
                totalHours: group.totalHours,
                limit: limit,
                excess: group.totalHours - limit,
                shiftCount: group.shifts.length
            });
        }
    });
    
    // 3. Check for missing times
    shifts.forEach(shift => {
        const isSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover');
        
        if (!isSleepover && (!shift.start_time || !shift.end_time)) {
            conflicts.missingTimes.push({
                shift: shift,
                staff: shift.staff,
                participant: shift.participant,
                date: shift.date,
                missing: !shift.start_time && !shift.end_time ? 'both times' :
                        !shift.start_time ? 'start time' : 'end time'
            });
        }
    });
    
    // 4. Check for unconfirmed shifts
    shifts.forEach(shift => {
        if (shift.status === 'pending') {
            conflicts.unconfirmedShifts.push({
                shift: shift,
                staff: shift.staff,
                participant: shift.participant,
                date: shift.date,
                daysOld: Math.floor((new Date() - new Date(shift.created_at)) / (1000 * 60 * 60 * 24))
            });
        }
    });
    
    // 5. Check for missing pay rates
    shifts.forEach(shift => {
        if (!shift.pay_override_id && !shift.staff?.pay_rate_id) {
            conflicts.noPayRate.push({
                shift: shift,
                staff: shift.staff,
                date: shift.date,
                participant: shift.participant
            });
        }
    });
    
    // 6. Check participant overlaps (for info)
    const participantShiftsByDate = {};
    shifts.forEach(shift => {
        if (shift.participant_id) {
            const key = `${shift.participant_id}_${shift.date}`;
            if (!participantShiftsByDate[key]) {
                participantShiftsByDate[key] = [];
            }
            participantShiftsByDate[key].push(shift);
        }
    });
    
    Object.entries(participantShiftsByDate).forEach(([key, dayShifts]) => {
        if (dayShifts.length > 1) {
            // Check for overlapping times
            let maxConcurrent = 0;
            const overlaps = [];
            
            for (let i = 0; i < dayShifts.length; i++) {
                const shift = dayShifts[i];
                if (shift.start_time && shift.end_time) {
                    const concurrent = [];
                    
                    for (let j = 0; j < dayShifts.length; j++) {
                        if (i !== j && dayShifts[j].start_time && dayShifts[j].end_time) {
                            const start1 = new Date(`2000-01-01T${shift.start_time}`);
                            let end1 = new Date(`2000-01-01T${shift.end_time}`);
                            const start2 = new Date(`2000-01-01T${dayShifts[j].start_time}`);
                            let end2 = new Date(`2000-01-01T${dayShifts[j].end_time}`);
                            
                            if (end1 <= start1) end1.setDate(end1.getDate() + 1);
                            if (end2 <= start2) end2.setDate(end2.getDate() + 1);
                            
                            if (!(end1 <= start2 || start1 >= end2)) {
                                concurrent.push(dayShifts[j]);
                            }
                        }
                    }
                    
                    if (concurrent.length > 0 && concurrent.length + 1 > maxConcurrent) {
                        maxConcurrent = concurrent.length + 1;
                        overlaps.push({
                            participant: shift.participant,
                            date: shift.date,
                            ratio: `${concurrent.length + 1}:1`,
                            mainShift: shift,
                            overlappingShifts: concurrent
                        });
                    }
                }
            }
            
            if (maxConcurrent > 2) {
                // Only flag if more than 2:1 ratio
                conflicts.participantOverlaps.push(overlaps[0]);
            }
        }
    });
    
    // Build the HTML display
    let html = `
        <style>
            .conflicts-summary {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }
            
            .conflict-stat {
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 16px;
                text-align: center;
            }
            
            .conflict-stat.error {
                border-color: var(--danger-color);
                background: var(--danger-color)10;
            }
            
            .conflict-stat.warning {
                border-color: var(--warning-color);
                background: var(--warning-color)10;
            }
            
            .conflict-stat.info {
                border-color: var(--info-color);
                background: var(--info-color)10;
            }
            
            .conflict-stat h3 {
                margin: 0 0 8px 0;
                font-size: 24px;
                font-weight: bold;
            }
            
            .conflict-stat p {
                margin: 0;
                font-size: 14px;
                color: var(--text-secondary);
            }
            
            .conflict-section {
                margin-bottom: 32px;
            }
            
            .conflict-section h3 {
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .conflict-item {
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .conflict-details {
                flex: 1;
            }
            
            .conflict-actions {
                display: flex;
                gap: 8px;
            }
            
            .overlap-visual {
                display: inline-block;
                background: var(--danger-color)20;
                color: var(--danger-color);
                padding: 4px 8px;
                border-radius: 4px;
                font-family: monospace;
                font-size: 12px;
                margin-left: 8px;
            }
        </style>
        
        <div class="conflicts-summary">
            <div class="conflict-stat ${conflicts.staffDoubleBooking.length > 0 ? 'error' : ''}">
                <h3>${conflicts.staffDoubleBooking.length}</h3>
                <p>Staff Double-Bookings</p>
            </div>
            <div class="conflict-stat ${conflicts.sleepoverViolations.length > 0 ? 'error' : ''}">
                <h3>${conflicts.sleepoverViolations.length}</h3>
                <p>Sleepover Violations</p>
            </div>
            <div class="conflict-stat ${conflicts.excessiveHours.length > 0 ? 'warning' : ''}">
                <h3>${conflicts.excessiveHours.length}</h3>
                <p>Excessive Hours</p>
            </div>
            <div class="conflict-stat ${conflicts.missingTimes.length > 0 ? 'warning' : ''}">
                <h3>${conflicts.missingTimes.length}</h3>
                <p>Missing Times</p>
            </div>
            <div class="conflict-stat ${conflicts.unconfirmedShifts.length > 0 ? 'info' : ''}">
                <h3>${conflicts.unconfirmedShifts.length}</h3>
                <p>Unconfirmed Shifts</p>
            </div>
            <div class="conflict-stat ${conflicts.noPayRate.length > 0 ? 'warning' : ''}">
                <h3>${conflicts.noPayRate.length}</h3>
                <p>No Pay Rate</p>
            </div>
        </div>
    `;
    
    // Staff Double-Booking Section
    if (conflicts.staffDoubleBooking.length > 0) {
        html += `
            <div class="conflict-section">
                <h3>
                    <span style="color: var(--danger-color);">üö´</span> 
                    Staff Double-Bookings (${conflicts.staffDoubleBooking.length})
                </h3>
        `;
        
        conflicts.staffDoubleBooking.forEach(conflict => {
            const staff = conflict.staff || {};
            const part1 = conflict.shift1.participant || {};
            const part2 = conflict.shift2.participant || {};
            
            html += `
                <div class="conflict-item">
                    <div class="conflict-details">
                        <strong>${staff.first_name} ${staff.last_name}</strong> - 
                        ${formatDateFriendly(conflict.date)}
                        <br>
                        <span style="color: var(--text-secondary);">
                            Shift 1: ${formatTime12Hour(conflict.shift1.start_time)} - ${formatTime12Hour(conflict.shift1.end_time)} 
                            (${part1.first_name || 'Unknown'} ${part1.last_name || ''})
                        </span>
                        <br>
                        <span style="color: var(--text-secondary);">
                            Shift 2: ${formatTime12Hour(conflict.shift2.start_time)} - ${formatTime12Hour(conflict.shift2.end_time)} 
                            (${part2.first_name || 'Unknown'} ${part2.last_name || ''})
                        </span>
                        <span class="overlap-visual">
                            Overlap: ${conflict.overlapPeriod.start} - ${conflict.overlapPeriod.end} (${conflict.overlapPeriod.hours}h)
                        </span>
                    </div>
                    <div class="conflict-actions">
                        <button class="btn btn-sm btn-outline" onclick="editShift(${conflict.shift1.id})">
                            Edit Shift 1
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="editShift(${conflict.shift2.id})">
                            Edit Shift 2
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteShift(${conflict.shift2.id})">
                            Delete Shift 2
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // Sleepover Violations Section
    if (conflicts.sleepoverViolations.length > 0) {
        html += `
            <div class="conflict-section">
                <h3>
                    <span style="color: var(--danger-color);">‚ö†Ô∏è</span>
                    Sleepover Violations (${conflicts.sleepoverViolations.length})
                </h3>
        `;
        
        conflicts.sleepoverViolations.forEach(conflict => {
            const staff = conflict.staff || {};
            
            html += `
                <div class="conflict-item">
                    <div class="conflict-details">
                        <strong>${staff.first_name} ${staff.last_name}</strong> - 
                        ${formatDateFriendly(conflict.date)}
                        <br>
                        <span style="color: var(--danger-color);">${conflict.reason}</span>
                        <br>
                        <span style="color: var(--text-secondary);">
                            Sleepover + ${formatTime12Hour(conflict.conflictingShift.start_time)} - 
                            ${formatTime12Hour(conflict.conflictingShift.end_time)}
                        </span>
                    </div>
                    <div class="conflict-actions">
                        <button class="btn btn-sm btn-outline" onclick="editShift(${conflict.conflictingShift.id})">
                            Reschedule Shift
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteShift(${conflict.sleepoverShift.id})">
                            Remove Sleepover
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // Excessive Hours Section
    if (conflicts.excessiveHours.length > 0) {
        html += `
            <div class="conflict-section">
                <h3>
                    <span style="color: var(--warning-color);">‚è∞</span>
                    Excessive Hours (${conflicts.excessiveHours.length})
                </h3>
        `;
        
        conflicts.excessiveHours.forEach(conflict => {
            const staff = conflict.staff || {};
            
            html += `
                <div class="conflict-item">
                    <div class="conflict-details">
                        <strong>${staff.first_name} ${staff.last_name}</strong>
                        <br>
                        Week of ${formatDateFriendly(conflict.weekStart.toISOString().split('T')[0])}
                        <br>
                        <span style="color: var(--warning-color);">
                            ${conflict.totalHours.toFixed(1)}h / ${conflict.limit}h limit 
                            (${conflict.excess.toFixed(1)}h over)
                        </span>
                    </div>
                    <div class="conflict-actions">
                        <button class="btn btn-sm btn-outline" 
                                onclick="viewStaffWeek('${staff.id}', '${conflict.weekStart.toISOString().split('T')[0]}')">
                            View Week
                        </button>
                        <button class="btn btn-sm btn-warning" 
                                onclick="redistributeHours('${staff.id}', '${conflict.weekStart.toISOString().split('T')[0]}')">
                            Redistribute
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // Missing Times Section
    if (conflicts.missingTimes.length > 0) {
        html += `
            <div class="conflict-section">
                <h3>
                    <span style="color: var(--warning-color);">üïê</span>
                    Missing Times (${conflicts.missingTimes.length})
                </h3>
        `;
        
        conflicts.missingTimes.forEach(conflict => {
            const staff = conflict.staff || {};
            const participant = conflict.participant || {};
            
            html += `
                <div class="conflict-item">
                    <div class="conflict-details">
                        <strong>${formatDateFriendly(conflict.date)}</strong> - 
                        ${staff.first_name} ${staff.last_name}
                        <br>
                        <span style="color: var(--text-secondary);">
                            ${participant.first_name || 'Unknown'} ${participant.last_name || ''}
                        </span>
                        <br>
                        <span style="color: var(--warning-color);">Missing: ${conflict.missing}</span>
                    </div>
                    <div class="conflict-actions">
                        <button class="btn btn-sm btn-primary" onclick="editShift(${conflict.shift.id})">
                            Add Times
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    if (Object.values(conflicts).every(arr => arr.length === 0)) {
        html = `
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
                <h3>No Conflicts Found!</h3>
                <p style="color: var(--text-secondary);">All shifts are properly scheduled with no overlaps or violations.</p>
            </div>
        `;
    }
    
    conflictsContent.innerHTML = html;
}

// Export conflicts report
function exportConflictsReport() {
    // Similar to renderConflicts but generates CSV
    let csv = 'Type,Staff,Date,Details,Action Required\n';
    
    // Add all conflicts to CSV...
    // (implementation similar to above but formatted for CSV)
    
    downloadCSV(csv, `conflicts_report_${new Date().toISOString().split('T')[0]}.csv`);
    showNotification('Conflicts report exported', 'success');
}

// Call initialization when document is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEnhancements);
} else {
    initializeEnhancements();
}

async function switchStaffView(staffId) {
    try {
        // Get the selected staff member
        const { data: selectedStaff, error } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('id', staffId)
            .single();
        
        if (error) throw error;
        
        // Store the original if this is the first switch
        if (!window.originalStaffData) {
            window.originalStaffData = currentStaffData;
        }
        
        // Switch current staff context
        currentStaffData = selectedStaff;
        
        // Update the display
        document.getElementById('userName').textContent = 
            `${selectedStaff.first_name} ${selectedStaff.last_name}`;
        
        // Add indicator that we're in test mode
        if (!document.getElementById('testModeIndicator')) {
            const indicator = document.createElement('div');
            indicator.id = 'testModeIndicator';
            indicator.style.cssText = 'background: #ff9800; color: white; padding: 5px 10px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 10000; font-size: 12px;';
            indicator.innerHTML = `
                ‚ö†Ô∏è TEST MODE - Viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name} 
                <button onclick="resetToOriginalStaff()" style="margin-left: 10px; padding: 2px 8px; background: white; color: #333; border: none; border-radius: 3px; cursor: pointer;">Exit Test Mode</button>
            `;
            document.body.prepend(indicator);
        } else {
            document.getElementById('testModeIndicator').innerHTML = `
                ‚ö†Ô∏è TEST MODE - Viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name}
                <button onclick="resetToOriginalStaff()" style="margin-left: 10px; padding: 2px 8px; background: white; color: #333; border: none; border-radius: 3px; cursor: pointer;">Exit Test Mode</button>
            `;
        }
        
        // Reload all data for this staff member
        await loadShifts();  // This will load shifts for currentStaffData
        
        // Refresh the current view
        renderCurrentView();
        
        showNotification(`Now viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name}`, 'info');
        
    } catch (error) {
        console.error('Error switching staff view:', error);
        showNotification('Failed to switch staff view', 'error');
    }
}

// 2. Reset back to original staff
function resetToOriginalStaff() {
    if (window.originalStaffData) {
        currentStaffData = window.originalStaffData;
        delete window.originalStaffData;
        
        // Update display
        document.getElementById('userName').textContent = 
            `${currentStaffData.first_name} ${currentStaffData.last_name}`;
        
        // Remove test mode indicator
        const indicator = document.getElementById('testModeIndicator');
        if (indicator) indicator.remove();
        
        // Reload data
        loadShifts();
        renderCurrentView();
        
        showNotification('Returned to your normal view', 'success');
    }
}

// 3. Add a dropdown to the header for quick staff switching
function addStaffSwitcher() {
    // Only show for admin/manager roles
    if (currentUserRole !== 'admin' && currentUserRole !== 'manager') return;
    
    const switcherHTML = `
        <div id="staffSwitcher" style="display: inline-block; margin-left: 20px;">
            <select id="staffViewSelect" onchange="if(this.value) switchStaffView(this.value)" style="
                padding: 5px 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background: white;
                cursor: pointer;
            ">
                <option value="">üë§ View as Staff...</option>
                ${staff.map(s => `
                    <option value="${s.id}" ${currentStaffData?.id === s.id ? 'selected' : ''}>
                        ${s.first_name} ${s.last_name}
                    </option>
                `).join('')}
            </select>
        </div>
    `;
    
    // Add to header
    const userInfo = document.querySelector('.user-info');
    if (userInfo) {
        userInfo.insertAdjacentHTML('beforeend', switcherHTML);
    }
}

// 4. For team.html - similar but simpler
async function switchStaffViewTeam(staffId) {
    try {
        const { data: selectedStaff, error } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('id', staffId)
            .single();
        
        if (error) throw error;
        
        // Store original
        if (!window.originalStaff) {
            window.originalStaff = currentStaff;
        }
        
        // Switch context
        currentStaff = selectedStaff;
        
        // Update display
        document.getElementById('userName').textContent = 
            `${selectedStaff.first_name} ${selectedStaff.last_name}`;
        
        // Add test mode banner
        if (!document.getElementById('testModeBanner')) {
            const banner = document.createElement('div');
            banner.id = 'testModeBanner';
            banner.style.cssText = 'background: orange; color: white; padding: 8px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 9999;';
            banner.innerHTML = `
                Testing as: ${selectedStaff.first_name} ${selectedStaff.last_name}
                <button onclick="exitTestMode()" style="margin-left: 10px; padding: 2px 8px;">Exit</button>
            `;
            document.body.prepend(banner);
        }
        
        // Reload their data
        await loadDashboard();
        await loadSchedule();
        await loadTransfers();
        
        showToast(`Viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name}`, 'info');
        
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to switch view', 'error');
    }
}


function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
        color: white;
        border-radius: 4px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}



//SHIFTNOTES//

function createShiftNoteModal() {
    const modalHtml = `
        <div id="addShiftNoteModal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <header class="modal-header">
                    <h3 class="modal-title">Add Shift Note</h3>
                    <button class="modal-close" onclick="closeModal('addShiftNoteModal'); window.editingNoteId = null;">&times;</button>
                </header>
                <div class="modal-content">
                    <form id="addShiftNoteForm">
                        <div class="form-group">
                            <label class="form-label">Participant</label>
                            <select class="form-control" id="shiftNoteParticipant" required>
                                <option value="">Select Participant</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Note Type</label>
                            <select class="form-control" id="shiftNoteType" required>
                                <option value="shift_note">Shift Note</option>
                                <option value="behaviour">Behaviour</option>
                                <option value="health_medical">Health/Medical</option>
                            </select>
                        </div>
                        
                        <!-- Rich text toolbar -->
                        <div class="compose-toolbar" style="display: flex; gap: 4px; margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <button type="button" class="format-btn" data-command="bold" title="Bold (Ctrl+B)">
                                <strong>B</strong>
                            </button>
                            <button type="button" class="format-btn" data-command="italic" title="Italic (Ctrl+I)">
                                <em>I</em>
                            </button>
                            <button type="button" class="format-btn" data-command="underline" title="Underline (Ctrl+U)">
                                <u>U</u>
                            </button>
                            <div style="width: 1px; background: #dee2e6; margin: 0 4px;"></div>
                            <button type="button" class="format-btn" data-command="insertUnorderedList" title="Bullet List">
                                ‚Ä¢ ‚Äî
                            </button>
                            <button type="button" class="format-btn" data-command="insertOrderedList" title="Numbered List">
                                1. ‚Äî
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Note Content</label>
                            <div id="shiftNoteContent" 
                                 contenteditable="true"
                                 class="form-control note-editor"
                                 style="min-height: 150px; background: white; padding: 12px; border: 1px solid #ced4da; border-radius: 4px; outline: none;"
                                 placeholder="Type your note here..."></div>
                        </div>
                    </form>
                </div>
                <footer class="modal-footer">
                    <div class="modal-actions">
                        <button class="btn btn-outline" onclick="closeModal('addShiftNoteModal'); window.editingNoteId = null;">Cancel</button>
                        <button class="btn btn-primary" onclick="window.editingNoteId ? updateShiftNote(window.editingNoteId) : saveShiftNote()">Save Shift Note</button>
                    </div>
                </footer>
            </div>
        </div>
        
        <style>
            .format-btn {
                padding: 6px 10px;
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s;
                min-width: 32px;
                font-family: inherit;
            }
            
            .format-btn:hover {
                background: #e9ecef;
            }
            
            .format-btn.active {
                background: #007bff;
                color: white;
                border-color: #007bff;
            }
            
            .note-editor:empty:before {
                content: attr(placeholder);
                color: #6c757d;
                pointer-events: none;
                position: absolute;
            }
            
            .note-editor:focus {
                border-color: #80bdff;
                box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
            }
            
            .note-editor {
                position: relative;
            }
            
            /* Fix for lists padding */
            .note-editor ul, 
            .note-editor ol,
            .note-content ul,
            .note-content ol {
                padding-left: 30px;
                margin: 8px 0;
            }
            
            .note-editor li,
            .note-content li {
                margin: 4px 0;
            }
        </style>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    setTimeout(() => {
        populateParticipantDropdown();
        setupShiftNoteEditor();
    }, 100);
}

function showEditShiftNoteModal(noteData) {
    let modal = document.getElementById('addShiftNoteModal');
    
    if (!modal) {
        createShiftNoteModal();
        modal = document.getElementById('addShiftNoteModal');
    }
    
    setTimeout(() => {
        const modalTitle = modal.querySelector('.modal-title');
        if (modalTitle) {
            modalTitle.textContent = 'Edit Shift Note';
        }
        
        // Populate participant dropdown first
        populateParticipantDropdown();
        
        // Set participant and DISABLE it for editing
        const participantSelect = document.getElementById('shiftNoteParticipant');
        if (participantSelect && noteData.participant_id) {
            participantSelect.value = noteData.participant_id;
            participantSelect.disabled = true;  // Lock the participant selection
            
            // Add visual indication that it's locked
            participantSelect.style.background = '#e9ecef';
            participantSelect.style.cursor = 'not-allowed';
        }
        
        // Map database values to dropdown values
        const noteTypeSelect = document.getElementById('shiftNoteType');
        if (noteTypeSelect && noteData.note_type) {
            const typeMap = {
                'Shift Note': 'shift_note',
                'Behaviour': 'behaviour',
                'Health/Medical': 'health_medical',
                'shift note': 'shift_note',
                'behaviour': 'behaviour',
                'health/medical': 'health_medical'
            };
            const mappedType = typeMap[noteData.note_type] || 'shift_note';
            noteTypeSelect.value = mappedType;
        }
        
        const contentDiv = document.getElementById('shiftNoteContent');
        if (contentDiv && noteData.note) {
            contentDiv.innerHTML = noteData.note;
        }
        
        const saveBtn = modal.querySelector('.btn-primary');
        if (saveBtn) {
            saveBtn.onclick = function() {
                updateShiftNote(window.editingNoteId);
            };
            saveBtn.textContent = 'Update Shift Note';
        }
        
        setupShiftNoteEditor();
        modal.style.display = 'flex';
    }, 100);
}

function addShiftNote() {
    // Clear editing flag
    window.editingNoteId = null;
    
    let modal = document.getElementById('addShiftNoteModal');
    
    if (!modal) {
        createShiftNoteModal();
    } else {
        // Reset form for new note
        const modalTitle = modal.querySelector('.modal-title');
        if (modalTitle) {
            modalTitle.textContent = 'Add Shift Note';
        }
        
        // Reset save button text
        const saveBtn = modal.querySelector('.btn-primary');
        if (saveBtn) {
            saveBtn.textContent = 'Save Shift Note';
            saveBtn.onclick = function() {
                saveShiftNote();
            };
        }
        
        // Re-enable and clear participant dropdown
        const participantSelect = document.getElementById('shiftNoteParticipant');
        if (participantSelect) {
            participantSelect.value = '';
            participantSelect.disabled = false;  // Re-enable for new notes
            participantSelect.style.background = '';
            participantSelect.style.cursor = '';
        }
        
        document.getElementById('shiftNoteType').value = 'shift_note';
        document.getElementById('shiftNoteContent').innerHTML = '';
        
        populateParticipantDropdown();
        setupShiftNoteEditor();
    }
    
    document.getElementById('addShiftNoteModal').style.display = 'flex';
}

// Populate participant dropdown
function populateParticipantDropdown() {
    const select = document.getElementById('shiftNoteParticipant');
    if (!select || !participants) return;
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">Select Participant</option>';
    
    // Add participants
    const activeParticipants = participants.filter(p => 
        p.is_active && p.first_name !== 'My Carers'
    ).sort((a, b) => {
        const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
        const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    activeParticipants.forEach(participant => {
        const option = document.createElement('option');
        option.value = participant.id;
        option.textContent = `${participant.first_name} ${participant.last_name}`;
        select.appendChild(option);
    });
}


// Populate participant dropdown
function populateParticipantDropdown() {
    const select = document.getElementById('shiftNoteParticipant');
    if (!select || !participants) return;
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">Select Participant</option>';
    
    // Add participants
    const activeParticipants = participants.filter(p => 
        p.is_active && p.first_name !== 'My Carers'
    ).sort((a, b) => {
        const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
        const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    activeParticipants.forEach(participant => {
        const option = document.createElement('option');
        option.value = participant.id;
        option.textContent = `${participant.first_name} ${participant.last_name}`;
        select.appendChild(option);
    });
}


function setupShiftNoteEditor() {
    const editor = document.getElementById('shiftNoteContent');
    const toolbar = document.querySelector('#addShiftNoteModal .compose-toolbar');
    
    if (!editor || !toolbar) return;
    
    // Handle toolbar button clicks
    toolbar.querySelectorAll('.format-btn').forEach(btn => {
        btn.onclick = function(e) {
            e.preventDefault();
            const command = this.dataset.command;
            document.execCommand(command, false, null);
            editor.focus();
            updateToolbarState();
        };
    });
    
    // Update toolbar state on selection change
    editor.addEventListener('keyup', updateToolbarState);
    editor.addEventListener('mouseup', updateToolbarState);
    editor.addEventListener('focus', updateToolbarState);
    
    // Simple keyboard shortcuts only
    editor.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + B for bold
        if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
            e.preventDefault();
            document.execCommand('bold', false, null);
            updateToolbarState();
        }
        
        // Ctrl/Cmd + I for italic
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
            e.preventDefault();
            document.execCommand('italic', false, null);
            updateToolbarState();
        }
        
        // Ctrl/Cmd + U for underline
        if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
            e.preventDefault();
            document.execCommand('underline', false, null);
            updateToolbarState();
        }
        
        // Ctrl/Cmd + Enter to save
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            saveShiftNote();
        }
        
        // Escape to close modal
        if (e.key === 'Escape') {
            e.preventDefault();
            closeModal('addShiftNoteModal');
        }
    });
    
    // Prevent form submission on Enter
    const form = document.getElementById('addShiftNoteForm');
    if (form) {
        form.onsubmit = function(e) {
            e.preventDefault();
            return false;
        };
    }
    
    // Initial toolbar state
    updateToolbarState();
}

// Update toolbar button states based on current selection
function updateToolbarState() {
    const toolbar = document.querySelector('#addShiftNoteModal .compose-toolbar');
    if (!toolbar) return;
    
    const commands = {
        'bold': 'bold',
        'italic': 'italic',
        'underline': 'underline',
        'insertUnorderedList': 'insertUnorderedList',
        'insertOrderedList': 'insertOrderedList'
    };
    
    Object.entries(commands).forEach(([command, queryCommand]) => {
        const btn = toolbar.querySelector(`[data-command="${command}"]`);
        if (btn) {
            const isActive = document.queryCommandState(queryCommand);
            if (isActive) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }
    });
}

// Modified save function to handle HTML content
async function saveShiftNote() {
    try {
        const participantId = document.getElementById('shiftNoteParticipant').value;
        const noteTypeValue = document.getElementById('shiftNoteType').value;
        const noteContent = document.getElementById('shiftNoteContent');
        
        if (!participantId) {
            showNotification('Please select a participant', 'error');
            return;
        }
        
        if (!noteContent) return;
        
        const htmlContent = noteContent.innerHTML.trim();
        
        if (!htmlContent || htmlContent === '<br>') {
            showNotification('Please enter a note', 'error');
            return;
        }

        // Map dropdown values to database values
        const typeMap = {
            'shift_note': 'Shift Note',
            'behaviour': 'Behaviour', 
            'health_medical': 'Health/Medical'
        };
        
        const noteType = typeMap[noteTypeValue] || 'Shift Note';

        // Insert into shift_notes table with correct label
        const { error } = await supabaseClient
            .from('shift_notes')
            .insert({
                staff_id: currentManagerStaff?.id || currentStaffData?.id,
                participant_id: participantId,
                note_type: noteType,  // Now saves as "Shift Note" instead of "shift_note"
                note: htmlContent,
                shift_id: null,
                created_at: new Date().toISOString()
            });

        if (error) throw error;

        showNotification('Shift note added successfully', 'success');
        closeModal('addShiftNoteModal');
        
        if (currentView === 'notes') {
            await renderNotes(1);
        }

    } catch (error) {
        console.error('Error saving shift note:', error);
        showNotification('Failed to save shift note: ' + error.message, 'error');
    }
}

async function updateShiftNote(noteId) {
    try {
        const participantId = document.getElementById('shiftNoteParticipant').value;
        const noteTypeValue = document.getElementById('shiftNoteType').value;
        const noteContent = document.getElementById('shiftNoteContent');
        
        if (!participantId) {
            showNotification('Please select a participant', 'error');
            return;
        }
        
        const htmlContent = noteContent.innerHTML.trim();
        
        if (!htmlContent || htmlContent === '<br>') {
            showNotification('Please enter a note', 'error');
            return;
        }

        // Map dropdown values to database values
        const typeMap = {
            'shift_note': 'Shift Note',
            'behaviour': 'Behaviour',
            'health_medical': 'Health/Medical'
        };
        
        const noteType = typeMap[noteTypeValue] || 'Shift Note';

        // Update existing note
        const { error } = await supabaseClient
            .from('shift_notes')
            .update({
                participant_id: participantId,
                note_type: noteType,  // Now saves as "Shift Note" instead of "shift_note"
                note: htmlContent,
                updated_at: new Date().toISOString()
            })
            .eq('id', noteId);

        if (error) throw error;

        showNotification('Shift note updated successfully', 'success');
        closeModal('addShiftNoteModal');
        window.editingNoteId = null;
        
        if (currentView === 'notes') {
            await renderNotes(currentNotesPage);
        }

    } catch (error) {
        console.error('Error updating shift note:', error);
        showNotification('Failed to update shift note: ' + error.message, 'error');
    }
}

// ========================================
// INITIALIZATION
// ========================================

document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('=== MC MANAGER STARTING ===');
        
        // Check if templates view exists
        if (!document.getElementById('templatesView')) {
            const mainContent = document.querySelector('.main-content') || document.body;
            if (typeof rosterTemplatesHTML !== 'undefined') {
                mainContent.insertAdjacentHTML('beforeend', rosterTemplatesHTML);
            }
        }
        
        // Initialize the app
        await initializeApp();
        
        // Add staff switcher for admins/managers after initialization
        if (currentUserRole === 'admin' || currentUserRole === 'manager') {
            setTimeout(() => {
                if (typeof addStaffSwitcher === 'function') {
                    addStaffSwitcher();
                }
            }, 100);
        }
        
        console.log('=== MC MANAGER READY ===');
    } catch (error) {
        console.error('Initialization failed:', error);
        showNotification('Initialization failed. Please refresh the page.', 'error');
    }
});

// Auth state monitoring
supabaseClient.auth.onAuthStateChange((event, session) => {
    console.log('Auth state change:', event);
    if (event === 'SIGNED_OUT') {
        window.location.href = 'index.html';
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Alt+S to open staff switcher
    if (e.altKey && e.key === 's') {
        e.preventDefault();
        const select = document.getElementById('staffViewSelect');
        if (select) select.focus();
    }
    
    // Escape to exit test mode
    if (e.key === 'Escape' && window.originalStaffData) {
        if (typeof resetToOriginalStaff === 'function') {
            resetToOriginalStaff();
        }
    }
});

// Debug helper
window.mcDebug = {
    shifts: () => shifts,
    filtered: () => filteredShifts,
    staff: () => staff,
    calculateHours: (shiftId) => {
        const shift = shifts.find(s => s.id === shiftId);
        return shift ? calculateShiftHours(shift) : null;
    },
    testCalculation: () => {
        if (shifts.length > 0) {
            const testShift = shifts[0];
            console.log('Test calculation for first shift:', {
                shift: testShift,
                calculatedHours: calculateShiftHours(testShift),
                calculatedPay: calculateShiftPay(testShift, calculateShiftHours(testShift))
            });
        }
    }
};
    </script>
</body>
</html>

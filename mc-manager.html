<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MC Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
        <script>
        // Google Maps Configuration
        const GOOGLE_MAPS_API_KEY = 'AIzaSyDo5V32Ix0Xi40HdORZ5XGtxYxMBGbUJfw'; // Replace with your actual API key
        
        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadGoogleMapsScript();
        });
        </script>
    <title>My Carers</title>
  
    <!-- favicon links -->
    <link rel="icon" type="image/png" sizes="16x16" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/mc-favicon-32x32.png">

<style>
    /* ==========================================================================
       Root Variables & Design System
       ========================================================================== */
    :root {
        /* Primary Colors - Using lighter blue for primary actions */
        --primary-color: #4A90E2;          /* Lighter blue for primary buttons */
        --primary-hover: #357ABD;          /* Hover state for lighter blue */
        --primary-dark: #004990;           /* Original dark blue for accents */
        --primary-dark-hover: #003d75;     /* Dark blue hover */
        --primary-light: #e3f2fd;          /* Light blue background */
        --primary-lighter: #f0f8ff;        /* Extra light blue */
        
        /* Extended Color Palette */
        --success-color: #88a542;
        --success-hover: #7a9339;
        --success-light: #d4edda;
        --success-dark: #155724;
        
        --danger-color: #e74c3c;
        --danger-hover: #c0392b;
        --danger-light: #f8d7da;
        --danger-dark: #721c24;
        
        --warning-color: #f39c12;
        --warning-hover: #e67e22;
        --warning-light: #fff3cd;
        --warning-dark: #856404;
        
        --info-color: #359dca;
        --info-hover: #2e8bb5;
        --info-light: #cce5ff;
        --info-dark: #004085;
        
        /* Day Colors for Scheduling */
        --monday-color: #e91e63;
        --tuesday-color: #ff9800;
        --wednesday-color: #4caf50;
        --thursday-color: #2196f3;
        --friday-color: #9c27b0;
        --saturday-color: #673ab7;
        --sunday-color: #f44336;
        
        /* Text Colors */
        --text-primary: #2c3e50;
        --text-secondary: #34495e;
        --text-muted: #7f8c8d;
        --text-light: #95a5a6;
        --text-white: #ffffff;
        
        /* Background Colors */
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-light: #ecf0f1;
        --bg-dark: #e9ecef;
        
        /* Border Colors */
        --border-color: #e0e0e0;
        --border-light: #ecf0f1;
        --border-dark: #bdc3c7;
        --border-dashed: #ddd;
        
        /* Shadows */
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
        --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);
        --shadow-hover: 0 8px 16px rgba(0,0,0,0.1);
        
        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 8px;
        --radius-xl: 12px;
        --radius-2xl: 16px;
        --radius-pill: 20px;
        --radius-circle: 50%;
        
        /* Transitions */
        --transition: all 0.2s ease-in-out;
        --transition-fast: all 0.15s ease;
        --transition-slow: all 0.3s ease;
        
        /* Typography */
        --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        --font-size-xs: 0.75rem;    /* 12px */
        --font-size-sm: 0.875rem;   /* 14px */
        --font-size-base: 1rem;     /* 16px */
        --font-size-lg: 1.125rem;   /* 18px */
        --font-size-xl: 1.25rem;    /* 20px */
        --font-size-2xl: 1.5rem;    /* 24px */
        --font-size-3xl: 1.875rem;  /* 30px */
        --font-size-4xl: 2.25rem;   /* 36px */
        
        /* Font Weights */
        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;
        
        /* Line Heights */
        --line-height-tight: 1.2;
        --line-height-normal: 1.6;
        --line-height-relaxed: 1.8;
        
        /* Spacing */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 12px;
        --spacing-lg: 16px;
        --spacing-xl: 20px;
        --spacing-2xl: 24px;
        --spacing-3xl: 32px;
        --spacing-4xl: 40px;
        
        /* Z-Index Scale */
        --z-dropdown: 100;
        --z-sticky: 500;
        --z-overlay: 900;
        --z-modal: 1000;
        --z-tooltip: 1100;
        --z-notification: 10000;
    }
    
    /* ==========================================================================
       Base Styles & Resets
       ========================================================================== */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: var(--font-family);
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        line-height: var(--line-height-normal);
        font-size: var(--font-size-base);
    }
    
    /* ==========================================================================
       Header System
       ========================================================================== */
    .header {
        background: var(--bg-primary);
        box-shadow: var(--shadow-sm);
        position: sticky;
        top: 0;
        z-index: var(--z-sticky);
        border-bottom: 1px solid var(--border-light);
    }
    
    .header-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 var(--spacing-2xl);
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 64px;
    }
    
    .logo {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        color: var(--primary-dark);
        letter-spacing: -0.5px;
    }
    
    .user-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
    }
    
    .user-name {
        font-weight: var(--font-weight-medium);
        color: var(--text-secondary);
        font-size: var(--font-size-base);
    }
    
    .user-role {
        background: var(--primary-color);
        color: var(--text-white);
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-pill);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* ==========================================================================
       Container System
       ========================================================================== */
    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--spacing-2xl);
    }
    
    .management-section {
        padding: 0;
    }
    
    /* ==========================================================================
       Button System - Unified with Lighter Blue Primary
       ========================================================================== */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-lg);
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        line-height: 1.4;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        white-space: nowrap;
        position: relative;
        overflow: hidden;
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* Primary Button - Now lighter blue */
    .btn-primary {
        background: var(--primary-color);
        color: var(--text-white);
    }
    
    .btn-primary:hover:not(:disabled) {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .btn-primary:active:not(:disabled) {
        transform: translateY(0);
    }
    
    /* Success Button */
    .btn-success {
        background: var(--success-color);
        color: var(--text-white);
    }
    
    .btn-success:hover:not(:disabled) {
        background: var(--success-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    /* Warning Button */
    .btn-warning {
        background: var(--warning-color);
        color: var(--text-white);
    }
    
    .btn-warning:hover:not(:disabled) {
        background: var(--warning-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    /* Danger Button */
    .btn-danger {
        background: var(--danger-color);
        color: var(--text-white);
    }
    
    .btn-danger:hover:not(:disabled) {
        background: var(--danger-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    /* Info Button */
    .btn-info {
        background: var(--info-color);
        color: var(--text-white);
    }
    
    .btn-info:hover:not(:disabled) {
        background: var(--info-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    /* Outline Button */
    .btn-outline {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
    }
    
    .btn-outline:hover:not(:disabled) {
        background: var(--bg-light);
        border-color: var(--text-secondary);
    }
    
    /* Button Sizes */
    .btn-sm {
        padding: var(--spacing-xs) var(--spacing-md);
        font-size: var(--font-size-xs);
    }
    
    .btn-lg {
        padding: var(--spacing-md) var(--spacing-2xl);
        font-size: var(--font-size-base);
    }
    
    /* Icon Button */
    .btn-icon {
        padding: var(--spacing-sm);
        min-width: 36px;
        height: 36px;
    }
    
    /* ==========================================================================
       Navigation Systems
       ========================================================================== */
    
    /* View Toggle */
    .view-toggle {
        display: flex;
        background: var(--bg-light);
        border-radius: var(--radius-md);
        padding: 4px;
        gap: 2px;
    }
    
    .view-toggle button {
        padding: 10px 16px;
        border: none;
        background: transparent;
        border-radius: var(--radius-sm);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-muted);
        cursor: pointer;
        transition: var(--transition);
    }
    
    .view-toggle button.active {
        background: var(--bg-primary);
        color: var(--text-primary);
        box-shadow: var(--shadow-sm);
    }
    
    .view-toggle button:hover:not(.active) {
        color: var(--text-secondary);
    }
    
    /* Dropdown Navigation */
    .nav-dropdown {
        position: relative;
        display: inline-block;
    }
    
    .nav-dropdown-btn {
        background: var(--primary-color);  /* Changed to lighter blue */
        color: var(--text-white);
        padding: var(--spacing-md) var(--spacing-2xl);
        font-size: var(--font-size-base);
        border: none;
        cursor: pointer;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        transition: var(--transition);
    }
    
    .nav-dropdown-btn:hover {
        background: var(--primary-hover);
    }
    
    .nav-dropdown-btn i {
        font-size: 0.9em;
    }
    
    .nav-dropdown-content {
        display: none;
        position: absolute;
        background: var(--bg-primary);
        min-width: 250px;
        box-shadow: var(--shadow-lg);
        z-index: var(--z-dropdown);
        border-radius: var(--radius-lg);
        margin-top: 4px;
        overflow: hidden;
    }
    
    .nav-dropdown-content.show {
        display: block;
    }
    
    .nav-category {
        background: var(--bg-light);
        padding: var(--spacing-sm) var(--spacing-lg);
        font-weight: var(--font-weight-semibold);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-color);
    }
    
    .nav-dropdown-content button {
        background: none;
        color: var(--text-primary);
        padding: var(--spacing-md) var(--spacing-xl);
        border: none;
        text-align: left;
        cursor: pointer;
        width: 100%;
        transition: var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .nav-dropdown-content button:hover {
        background: var(--bg-secondary);
    }
    
    .nav-dropdown-content button.active {
        background: var(--primary-light);
        color: var(--primary-dark);
        font-weight: var(--font-weight-medium);
    }
    
    .nav-dropdown-content button.danger {
        color: var(--danger-color);
    }
    
    .nav-dropdown-content button i {
        width: 20px;
        opacity: 0.6;
    }
    

    /*===================================
    //modal===============================*/
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: var(--z-modal, 1000);
                display: flex;
                align-items: center;
                justify-content: center;
                padding: var(--spacing-lg, 16px);
                overflow-y: auto;
            }
            
            /* Default Modal - Now Wider */
            .modal {
                background-color: var(--bg-primary, #ffffff);
                border-radius: var(--radius-lg, 8px);
                box-shadow: var(--shadow-xl, 0 20px 25px rgba(0,0,0,0.15));
                width: 100%;
                max-width: 800px; /* Increased from 600px */
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                margin: auto;
            }
            
            /* Large Modal Variant */
            .modal.large {
                max-width: 1200px; /* Increased for better content display */
            }
            
            /* Extra Large Modal Variant */
            .modal.x-large {
                max-width: 1400px;
            }
            
            /* Modal with Sidebar Layout */
            .modal.with-sidebar {
                max-width: 1400px; /* Increased for sidebar layouts */
            }
            
            .modal.with-sidebar .modal-content {
                padding: 0;
            }
            
            .modal-body-wrapper {
                display: flex;
                gap: 0;
                flex: 1;
                min-height: 0;
                overflow: hidden;
            }
            
            .modal-main-content {
                flex: 1;
                min-width: 0;
                padding: var(--spacing-2xl, 24px);
                overflow-y: auto;
            }
            
            .modal-sidebar {
                width: 450px; /* Increased from 400px */
                background: var(--bg-secondary, #f8f9fa);
                padding: var(--spacing-2xl, 24px);
                overflow-y: auto;
                border-left: 1px solid var(--border-light, #ecf0f1);
                flex-shrink: 0;
            }
            
            /* Modal Header */
            .modal-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: var(--spacing-xl, 20px) var(--spacing-2xl, 24px);
                border-bottom: 1px solid var(--border-light, #ecf0f1);
                flex-shrink: 0;
            }
            
            .modal-title {
                margin: 0;
                font-size: var(--font-size-xl, 1.25rem);
                font-weight: var(--font-weight-semibold, 600);
                color: var(--text-primary, #2c3e50);
            }
            
            .modal-close {
                background: none;
                border: none;
                font-size: var(--font-size-2xl, 1.5rem);
                cursor: pointer;
                color: var(--text-muted, #7f8c8d);
                padding: var(--spacing-xs, 4px);
                border-radius: var(--radius-sm, 4px);
                transition: var(--transition, all 0.2s ease-in-out);
                line-height: 1;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .modal-close:hover {
                background: var(--bg-light, #ecf0f1);
                color: var(--text-primary, #2c3e50);
            }
            
            /* Modal Content */
            .modal-content {
                padding: var(--spacing-2xl, 24px);
                overflow-y: auto;
                flex: 1;
                position: relative;
            }
            
            /* Modal Footer */
            .modal-footer {
                padding: var(--spacing-xl, 20px) var(--spacing-2xl, 24px);
                border-top: 1px solid var(--border-light, #ecf0f1);
                background: var(--bg-secondary, #f8f9fa);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: var(--spacing-md, 12px);
                flex-shrink: 0;
            }
            
            .modal-footer .modal-actions {
                display: flex;
                gap: var(--spacing-md, 12px);
                margin-left: auto;
            }
            
            /* Responsive Modal Adjustments */
            @media (max-width: 1400px) {
                .modal.x-large,
                .modal.with-sidebar {
                    max-width: 95%;
                }
            }
            
            @media (max-width: 1200px) {
                .modal.large {
                    max-width: 95%;
                }
                
                .modal-sidebar {
                    width: 380px;
                }
            }
            
            @media (max-width: 992px) {
                .modal-body-wrapper {
                    flex-direction: column;
                }
                
                .modal-sidebar {
                    width: 100%;
                    border-left: none;
                    border-top: 1px solid var(--border-light, #ecf0f1);
                }
                
                .modal.with-sidebar {
                    max-height: 95vh;
                }
            }
            
            @media (max-width: 768px) {
                .modal-overlay {
                    padding: 0;
                    align-items: flex-end;
                }
                
                .modal {
                    max-width: 100%;
                    width: 100%;
                    height: 100vh;
                    max-height: 100vh;
                    border-radius: 0;
                    margin: 0;
                }
                
                .modal.large,
                .modal.x-large,
                .modal.with-sidebar {
                    max-width: 100%;
                }
                
                .modal-content,
                .modal-main-content,
                .modal-sidebar {
                    padding: var(--spacing-lg, 16px);
                }
                
                .modal-header,
                .modal-footer {
                    padding: var(--spacing-lg, 16px);
                }
                
                .modal-footer {
                    flex-direction: column;
                    gap: var(--spacing-md, 12px);
                }
                
                .modal-footer .modal-actions {
                    width: 100%;
                    flex-direction: column;
                }
                
                .modal-actions .btn {
                    width: 100%;
                }
            }
/* End MODAL*/
    /* ==========================================================================
       Tab Navigation System
       ========================================================================== */
    .doc-tabs,
    .modal-tabs {
        display: flex;
        gap: 0;
        margin: 0 0 var(--spacing-xl) 0;
        border-bottom: 2px solid var(--border-color);
        overflow-x: auto;
    }
    
    .doc-tab-btn,
    .tab-btn {
        padding: var(--spacing-md) var(--spacing-xl);
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: var(--font-weight-medium);
        color: var(--text-secondary);
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        white-space: nowrap;
    }
    
    .doc-tab-btn:hover,
    .tab-btn:hover {
        background: var(--bg-light);
        color: var(--primary-color);
    }
    
    .doc-tab-btn.active,
    .tab-btn.active {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .doc-tab-content,
    .tab-content {
        display: none;
    }
    
    .doc-tab-content.active,
    .tab-content.active {
        display: block;
    }
    
    /* ==========================================================================
       Card System
       ========================================================================== */
    .card {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-light);
        overflow: hidden;
        transition: var(--transition);
    }
    
    .card:hover {
        box-shadow: var(--shadow-md);
    }
    
    .card-header {
        padding: var(--spacing-xl) var(--spacing-2xl);
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-secondary);
    }
    
    .card-title {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
        margin: 0;
    }
    
    .card-content {
        padding: var(--spacing-2xl);
    }
    
    /* Summary Cards */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--spacing-2xl);
        margin-bottom: var(--spacing-2xl);
    }
    
    .summary-card {
        background: var(--bg-primary);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-light);
    }
    
    .summary-card h3 {
        margin-bottom: var(--spacing-xl);
        color: var(--text-primary);
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        border-bottom: 1px solid var(--border-light);
        padding-bottom: var(--spacing-md);
    }
    
    /* ==========================================================================
       View Controls & Week Navigation
       ========================================================================== */
    .view-controls {
        background: var(--bg-primary);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        margin-bottom: var(--spacing-2xl);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--spacing-lg);
    }
    
    .view-actions {
        display: flex;
        gap: var(--spacing-md);
        flex-wrap: wrap;
    }
    
    .week-nav {
        background: var(--bg-primary);
        padding: var(--spacing-xl) var(--spacing-2xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        margin-bottom: var(--spacing-2xl);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: var(--spacing-2xl);
    }
    
    .week-display {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
        min-width: 250px;
        text-align: center;
    }
    
    .current-view-label {
        display: inline-block;
        margin-left: var(--spacing-xl);
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
    }
    
    /* ==========================================================================
       Form System
       ========================================================================== */
    .form-group {
        margin-bottom: var(--spacing-xl);
    }
    
    .form-group label {
        display: block;
        margin-bottom: var(--spacing-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
    }
    
    .form-group label.required::after {
        content: " *";
        color: var(--danger-color);
    }
    
    .form-control,
    .searchable-input,
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="date"],
    input[type="number"],
    input[type="file"],
    select,
    textarea {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: var(--font-size-sm);
        line-height: 1.5;
        color: var(--text-primary);
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        transition: var(--transition);
    }
    
    .form-control:focus,
    .searchable-input:focus,
    input:focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }
    
    textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-xl);
    }
    
    /* Searchable Dropdown */
    .searchable-dropdown {
        position: relative;
    }
    
    .searchable-input {
        width: 250px;
    }
    
    /* Search Bar */
    .search-bar {
        position: relative;
        margin-bottom: var(--spacing-lg);
    }
    
    .search-input {
        width: 100%;
        padding: 10px 40px 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
    }
    
    .search-bar i {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
    }
    
    /* ==========================================================================
       Filter System
       ========================================================================== */
    .filters,
    .doc-filters {
        background: var(--bg-primary);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        margin-bottom: var(--spacing-2xl);
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-xl);
        align-items: end;
    }
    
    .doc-filters {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-xl);
        flex-wrap: wrap;
        align-items: flex-end;
        padding: 0;
        background: transparent;
        box-shadow: none;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-group label {
        font-weight: var(--font-weight-medium);
        margin-bottom: var(--spacing-sm);
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
    }
    
    .filter-group input,
    .filter-group select {
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        background: var(--bg-primary);
        transition: var(--transition);
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }
    
    .filter-note {
        width: 100%;
        margin: 0 0 var(--spacing-lg) 0;
        padding: var(--spacing-sm);
        background: var(--primary-lighter);
        border-radius: var(--radius-sm);
        color: var(--info-dark);
        font-size: var(--font-size-sm);
    }
    
    /* ==========================================================================
       Table System
       ========================================================================== */
    .table-container {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        margin-bottom: var(--spacing-2xl);
        border: 1px solid var(--border-light);
    }
    
    .table-header {
        padding: var(--spacing-2xl);
        border-bottom: 1px solid var(--border-light);
        background: var(--bg-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--spacing-lg);
    }
    
    .table-title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
        margin: 0;
    }
    
    .table-actions {
        display: flex;
        gap: var(--spacing-md);
    }
    
    .table-responsive {
        overflow-x: auto;
        margin-top: var(--spacing-lg);
    }
    
    /* Base Table Styles */
    .roster-table,
    .document-table,
    .data-table,
    .timesheet-table,
    .overview-matrix {
        width: 100%;
        border-collapse: collapse;
        font-size: var(--font-size-sm);
    }
    
    .roster-table th,
    .document-table th,
    .data-table th,
    .timesheet-table th,
    .overview-matrix th {
        background: var(--bg-light);
        padding: var(--spacing-lg) var(--spacing-md);
        text-align: left;
        font-weight: var(--font-weight-semibold);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        border-bottom: 2px solid var(--border-color);
    }
    
    .roster-table td,
    .document-table td,
    .data-table td,
    .timesheet-table td,
    .overview-matrix td {
        padding: var(--spacing-lg) var(--spacing-md);
        border-bottom: 1px solid var(--border-light);
        vertical-align: top;
        line-height: 1.4;
    }
    
    .roster-table tr:hover:not(.day-header),
    .document-table tr:hover,
    .data-table tr:hover {
        background: var(--bg-secondary);
    }
    
    /* Clickable Table Rows */
    .document-table tbody tr,
    .clickable-row {
        cursor: pointer;
    }
    
    .document-table tbody tr.selected {
        background: var(--primary-light);
    }
    
    /* No Data Row */
    .data-table tr.no-data td {
        text-align: center;
        color: var(--text-muted);
        padding: var(--spacing-2xl);
    }
    
    /* Overview Matrix Special Styles */
    .overview-matrix th,
    .overview-matrix td {
        text-align: center;
        border: 1px solid var(--border-color);
    }
    
    .rotate-header {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        height: 120px;
        white-space: nowrap;
    }
    
    .matrix-cell {
        font-weight: var(--font-weight-bold);
        cursor: pointer;
    }
    
    /* Day Headers for Schedule */
    .day-header {
        background: linear-gradient(135deg, var(--primary-color), var(--info-color)) !important;
    }
    
    .day-header td {
        color: var(--text-white) !important;
        font-weight: var(--font-weight-semibold);
        padding: var(--spacing-md) var(--spacing-lg);
    }
    
    .day-stats {
        float: right;
        background: rgba(255,255,255,0.2);
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-pill);
        font-size: var(--font-size-xs);
    }
    
    /* Day Color Coding */
    .monday-shift { border-left: 4px solid var(--monday-color); }
    .tuesday-shift { border-left: 4px solid var(--tuesday-color); }
    .wednesday-shift { border-left: 4px solid var(--wednesday-color); }
    .thursday-shift { border-left: 4px solid var(--thursday-color); }
    .friday-shift { border-left: 4px solid var(--friday-color); }
    .saturday-shift { border-left: 4px solid var(--saturday-color); }
    .sunday-shift { border-left: 4px solid var(--sunday-color); }
    
    /* ==========================================================================
       Status Badge System
       ========================================================================== */
    .status-badge,
    .badge,
    .participant-badge {
        display: inline-block;
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: var(--radius-sm);
    }
    
    .participant-badge {
        border-radius: var(--radius-pill);
        font-size: 11px;
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Status Colors */
    .status-valid,
    .status-confirmed,
    .badge-success {
        background: var(--success-light);
        color: var(--success-dark);
    }
    
    .status-expired,
    .badge-danger {
        background: var(--danger-light);
        color: var(--danger-dark);
    }
    
    .status-expiring,
    .status-pending,
    .badge-warning {
        background: var(--warning-light);
        color: var(--warning-dark);
    }
    
    .status-unverified,
    .status-completed,
    .badge-info {
        background: var(--info-light);
        color: var(--info-dark);
    }
    
    .status-missing {
        background: var(--bg-secondary);
        color: var(--text-secondary);
    }
    
    /* Special Badge Types */
    .badge-default {
        background: var(--bg-dark);
        color: var(--text-secondary);
    }
    
    .badge-assignment {
        background: var(--success-light);
        color: var(--success-dark);
    }
    
    .badge-override {
        background: var(--warning-light);
        color: var(--warning-dark);
    }
    
    .badge-holiday {
        background: var(--danger-light);
        color: var(--danger-dark);
    }
    
    .badge-sleepover {
        background: var(--info-light);
        color: var(--info-dark);
    }
    
    .location-badge {
        display: inline-block;
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-pill);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: var(--text-white);
        white-space: nowrap;
    }
    
    /* Matrix Cell Status Colors */
    .matrix-cell.valid { background: var(--success-light); color: var(--success-dark); }
    .matrix-cell.expired { background: var(--danger-light); color: var(--danger-dark); }
    .matrix-cell.expiring { background: var(--warning-light); color: var(--warning-dark); }
    .matrix-cell.unverified { background: var(--info-light); color: var(--info-dark); }
    .matrix-cell.missing { background: var(--bg-secondary); color: var(--text-secondary); }
    
    /* Legend Boxes */
    .overview-legend {
        margin-top: var(--spacing-xl);
        display: flex;
        gap: var(--spacing-xl);
        justify-content: center;
    }
    
    .legend-box {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 1px solid var(--border-color);
        vertical-align: middle;
        margin-right: var(--spacing-xs);
    }
    
    .legend-box.valid { background: var(--success-light); }
    .legend-box.expired { background: var(--danger-light); }
    .legend-box.expiring { background: var(--warning-light); }
    .legend-box.unverified { background: var(--info-light); }
    .legend-box.missing { background: var(--bg-secondary); }
    
    /* ==========================================================================
       Document Management Components
       ========================================================================== */
    
    /* Split View Layout */
    .split-view-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: var(--spacing-xl);
        height: calc(100vh - 300px);
    }
    
    .document-list-panel {
        overflow-y: auto;
    }
    
    .document-preview-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    
    /* Document Preview */
    #documentPreview {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .preview-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .preview-header h4 {
        margin: 0;
    }
    
    .preview-actions {
        display: flex;
        gap: var(--spacing-xs);
    }
    
    .preview-content {
        flex: 1;
        padding: var(--spacing-xl);
        overflow: auto;
        background: var(--bg-primary);
    }
    
    .preview-info {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
        font-size: var(--font-size-sm);
    }
    
    .preview-info p {
        margin: var(--spacing-xs) 0;
    }
    
    .preview-placeholder {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
    }
    
    .preview-placeholder i {
        font-size: 4em;
        margin-bottom: var(--spacing-sm);
    }
    
    .preview-unsupported {
        text-align: center;
        padding: var(--spacing-4xl);
    }
    
    .preview-unsupported i {
        font-size: 3em;
        color: var(--text-muted);
        margin-bottom: var(--spacing-xl);
    }
    
    /* Edit Mode */
    #editMode .form-group {
        margin-bottom: var(--spacing-lg);
    }
    
    #editMode .form-group label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: var(--font-weight-medium);
    }
    
    #editMode .form-control {
        width: 100%;
        padding: var(--spacing-sm);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
    }
    
    /* Overview Controls */
    .overview-controls {
        margin-bottom: var(--spacing-xl);
        padding: var(--spacing-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
    }
    
    .overview-controls label {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    /* Document Upload Section */
    .document-upload-section {
        background: var(--bg-secondary);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-2xl);
    }
    
    /* ==========================================================================
       Upload & File Management Components
       ========================================================================== */
    .upload-step {
        display: none;
    }
    
    .upload-step.active {
        display: block;
    }
    
    .upload-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-xl);
        padding: var(--spacing-xl);
    }
    
    .upload-option {
        border: 2px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--spacing-4xl) var(--spacing-xl);
        text-align: center;
        cursor: pointer;
        transition: var(--transition-slow);
    }
    
    .upload-option:hover {
        border-color: var(--primary-color);
        background: var(--bg-secondary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .upload-option i {
        font-size: 3em;
        color: var(--primary-color);
        margin-bottom: var(--spacing-xl);
    }
    
    .upload-option h4 {
        margin: 0 0 var(--spacing-sm) 0;
    }
    
    .upload-option p {
        margin: 0;
        color: var(--text-secondary);
    }
    
    /* File Drop Zone */
    .file-drop-zone {
        border: 2px dashed var(--border-dashed);
        border-radius: var(--radius-lg);
        padding: var(--spacing-4xl);
        text-align: center;
        cursor: pointer;
        transition: var(--transition-slow);
    }
    
    .file-drop-zone:hover,
    .file-drop-zone.drag-over {
        border-color: var(--primary-color);
        background: var(--primary-lighter);
    }
    
    .file-drop-zone i {
        font-size: 3em;
        color: var(--text-muted);
        margin-bottom: var(--spacing-sm);
    }
    
    .file-drop-zone input[type="file"] {
        display: none;
    }
    
    /* File Preview */
    #filePreview {
        text-align: center;
        padding: var(--spacing-xl);
    }
    
    #filePreview img {
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-sm);
    }
    
    /* Camera & Capture Controls */
    .camera-controls,
    .capture-controls,
    .perspective-controls {
        display: flex;
        gap: var(--spacing-sm);
        justify-content: center;
        margin-top: var(--spacing-xl);
    }
    
    /* Perspective Correction */
    .perspective-container {
        position: relative;
        display: inline-block;
        margin: 0 auto;
    }
    
    .perspective-handles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }
    
    .corner-handle {
        position: absolute;
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border: 2px solid var(--text-white);
        border-radius: var(--radius-circle);
        cursor: move;
        transform: translate(-50%, -50%);
        pointer-events: auto;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .corner-handle:hover {
        background: var(--primary-hover);
        transform: translate(-50%, -50%) scale(1.2);
    }
    
    #perspectiveCanvas {
        max-width: 100%;
        display: block;
    }
    
    /* ==========================================================================
       Modal System
       ========================================================================== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: var(--z-modal);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-2xl);
    }
    
    .modal {
        background-color: var(--bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-xl) var(--spacing-2xl);
        border-bottom: 1px solid var(--border-light);
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: var(--font-size-2xl);
        cursor: pointer;
        color: var(--text-muted);
        padding: var(--spacing-xs);
        border-radius: var(--radius-sm);
        transition: var(--transition);
    }
    
    .modal-close:hover {
        background: var(--bg-light);
        color: var(--text-primary);
    }
    
    .modal-content {
        padding: var(--spacing-2xl);
        overflow-y: auto;
        flex: 1;
        position: relative;
    }
    
    .modal-footer {
        padding: var(--spacing-xl) var(--spacing-2xl);
        border-top: 1px solid var(--border-light);
        background: var(--bg-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spacing-md);
    }
    
    .modal-footer .btn-danger {
        margin-right: auto;
    }
    
    .modal-footer .modal-actions {
        display: flex;
        gap: var(--spacing-md);
    }
    
    /* ==========================================================================
       Info Components
       ========================================================================== */
    .info-box {
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-lg);
        display: flex;
        gap: var(--spacing-sm);
        align-items: start;
    }
    
    .info-box.info {
        background: var(--primary-light);
        border-left: 4px solid var(--info-color);
    }
    
    .info-box i {
        margin-top: 2px;
        color: var(--info-color);
    }
    
    .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: var(--spacing-2xl) 0 var(--spacing-lg) 0;
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--border-color);
        color: var(--text-primary);
    }
    
    .section-header {
        margin-bottom: var(--spacing-xl);
    }
    
    /* ==========================================================================
       Loading & Empty States
       ========================================================================== */
    .loading,
    .loading-overlay {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-3xl);
        color: var(--text-muted);
        flex-direction: column;
        gap: var(--spacing-md);
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        z-index: var(--z-overlay);
        border-radius: var(--radius-lg);
    }
    
    .spinner {
        width: 24px;
        height: 24px;
        border: 2px solid var(--border-light);
        border-top: 2px solid var(--primary-color);
        border-radius: var(--radius-circle);
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: var(--spacing-3xl) var(--spacing-xl);
        color: var(--text-muted);
    }
    
    .empty-state h3 {
        color: var(--text-secondary);
        margin-bottom: var(--spacing-md);
    }
    
    .empty-state p {
        margin-bottom: var(--spacing-xl);
        line-height: var(--line-height-relaxed);
    }
    
    /* ==========================================================================
       Notification System
       ========================================================================== */
    .notification {
        position: fixed;
        top: var(--spacing-2xl);
        right: var(--spacing-2xl);
        padding: var(--spacing-lg) var(--spacing-xl);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        z-index: var(--z-notification);
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
        border: 1px solid transparent;
    }
    
    .notification.success {
        background: var(--success-color);
        color: var(--text-white);
        border-color: var(--success-hover);
    }
    
    .notification.error {
        background: var(--danger-color);
        color: var(--text-white);
        border-color: var(--danger-hover);
    }
    
    .notification.info {
        background: var(--info-color);
        color: var(--text-white);
        border-color: var(--info-hover);
    }
    
    .notification.warning {
        background: var(--warning-color);
        color: var(--text-white);
        border-color: var(--warning-hover);
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    /* ==========================================================================
       Special Components
       ========================================================================== */
    
    /* Holiday Management */
    .holiday-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-sm);
        border: 1px solid var(--border-light);
    }
    
    .holiday-form {
        padding: var(--spacing-xl);
        background: var(--bg-light);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-xl);
        border: 1px solid var(--border-light);
    }
    
    /* Staff Assignment Form */
    .staff-assignment-form {
        background: var(--bg-secondary);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-2xl);
    }
    
    /* Location Components */
    .location-controls {
        display: flex;
        gap: var(--spacing-lg);
        align-items: end;
        margin-bottom: var(--spacing-lg);
    }
    
    .map-container {
        height: 400px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-lg);
    }
    
    .location-info-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }
    
    .location-info-card h4 {
        margin: 0 0 var(--spacing-md) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
    }
    
    .location-display {
        margin-top: var(--spacing-xs);
        color: var(--text-secondary);
    }
    
    .location-tips {
        display: grid;
        gap: var(--spacing-xs);
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--border-light);
    }
    
    .location-tips div {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .location-tips i {
        color: var(--primary-color);
    }
    
    /* Shift Cards */
    .shift-card {
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        background: var(--bg-primary);
        transition: var(--transition);
    }
    
    .shift-card:hover {
        box-shadow: var(--shadow-hover);
    }
    
    .shift-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
    }
    
    .shift-badges {
        display: flex;
        gap: var(--spacing-xs);
    }
    
    /* Rate Summary */
    .rate-summary {
        margin-top: var(--spacing-3xl);
        padding: var(--spacing-xl);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
    }
    
    .rate-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        margin-top: var(--spacing-lg);
    }
    
    .rate-summary-item {
        background: var(--bg-primary);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-light);
    }
    
    /* Overlap Indicator */
    .overlap-indicator {
        display: inline-block;
        background: var(--warning-color);
        color: #000;
        padding: 2px 6px;
        border-radius: var(--radius-pill);
        font-size: 11px;
        font-weight: var(--font-weight-bold);
        margin-left: var(--spacing-sm);
        cursor: help;
    }
    
    .overlap-tooltip {
        background: rgba(0, 0, 0, 0.9);
        color: var(--text-white);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-xs);
        z-index: var(--z-tooltip);
        max-width: 300px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* Accordion */
    .accordion-content {
        display: none;
    }
    
    .accordion-content.active {
        display: table-row;
    }
    
    /* View Content */
    .view-content {
        display: none;
        padding: var(--spacing-xl);
    }
    
    .view-content.active {
        display: block;
    }
    
    /* Documents View Specific */
    #documentsView {
        padding: var(--spacing-xl);
    }
    
    #documentsView .management-section {
        padding: var(--spacing-xl);
    }
    
    #documentsView .roster-table {
        margin-top: var(--spacing-xl);
    }
    
    /* ==========================================================================
       Responsive Design
       ========================================================================== */
    @media (max-width: 1024px) {
        .split-view-container {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr 1fr;
        }
    }
    
    @media (max-width: 768px) {
        /* Typography adjustments */
        :root {
            --font-size-base: 0.875rem;
        }
        
        /* Container adjustments */
        .container {
            padding: var(--spacing-lg);
        }
        
        /* Header adjustments */
        .header-content {
            flex-direction: column;
            padding: var(--spacing-md);
            gap: var(--spacing-sm);
            height: auto;
        }
        
        /* Navigation adjustments */
        .doc-tabs,
        .modal-tabs {
            flex-direction: column;
        }
        
        .view-toggle {
            flex-direction: column;
            width: 100%;
        }
        
        .view-toggle button {
            width: 100%;
            padding: var(--spacing-md);
        }
        
        .view-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .view-actions {
            justify-content: center;
        }
        
        /* Filter adjustments */
        .doc-filters,
        .filter-row {
            flex-direction: column;
            grid-template-columns: 1fr;
        }
        
        .searchable-input {
            width: 100%;
        }
        
        /* Table adjustments */
        .roster-table,
        .timesheet-table {
            font-size: 11px;
        }
        
        .roster-table th,
        .roster-table td,
        .timesheet-table th,
        .timesheet-table td {
            padding: var(--spacing-sm) var(--spacing-xs);
        }
        
        /* Hide less important columns on mobile */
        .roster-table th:nth-child(5),
        .roster-table td:nth-child(5) {
            display: none; /* Hide location column */
        }
        
        /* Week navigation */
        .week-nav {
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .week-nav button {
            width: 100%;
        }
        
        /* Cards */
        .card {
            margin: var(--spacing-sm);
        }
        
        /* Modal adjustments */
        .modal {
            max-width: 95%;
            margin: 0 auto;
        }
        
        .modal-footer {
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .modal-footer .btn-danger {
            margin-right: 0;
            order: 2;
        }
        
        .modal-footer .modal-actions {
            order: 1;
            width: 100%;
            justify-content: stretch;
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        /* Hour breakdown */
        .hour-breakdown-item {
            display: block;
            margin-bottom: var(--spacing-xs);
        }
        
        /* Request items */
        .request-item {
            font-size: var(--font-size-sm);
        }
        
        .request-actions {
            flex-direction: column;
        }
        
        .request-actions .btn {
            width: 100%;
        }
        
        /* Summary grid */
        .summary-grid {
            grid-template-columns: 1fr;
        }
        
        /* Availability grid */
        .availability-grid {
            font-size: 10px;
            grid-template-columns: 80px repeat(7, 1fr);
        }
        
        .availability-cell {
            padding: var(--spacing-xs);
            min-height: 35px;
        }
    }
    
    @media (max-width: 480px) {
        /* Even smaller screens */
        .roster-table {
            font-size: 10px;
        }
        
        /* Show only essential columns */
        .roster-table th:nth-child(6),
        .roster-table td:nth-child(6) {
            display: none; /* Hide duty type */
        }
        
        /* Compact timesheet */
        .timesheet-wrapper {
            margin: 0;
            border-radius: 0;
        }
        
        /* Smaller buttons */
        .btn {
            padding: var(--spacing-xs) var(--spacing-md);
            font-size: var(--font-size-xs);
        }
        
        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 11px;
        }
        
        /* Grid adjustments */
        .summary-grid,
        .form-row {
            grid-template-columns: 1fr;
        }
        
        /* Table padding */
        .table th,
        .table td {
            padding: var(--spacing-xs);
        }
        
        /* Modal full screen */
        .modal {
            width: 100%;
            height: 100vh;
            border-radius: 0;
            max-height: 100vh;
        }
    }
    
    /* ==========================================================================
       Print Styles
       ========================================================================== */
    @media print {
        /* Hide non-printable elements */
        .no-print,
        .btn,
        .modal-overlay,
        .notification,
        .nav-dropdown,
        .view-toggle,
        .filter-row,
        .table-actions,
        .header {
            display: none !important;
        }
        
        /* Print optimizations */
        body {
            background: white;
            color: black;
            font-size: 12pt;
        }
        
        .table {
            border: 1px solid black;
            page-break-inside: avoid;
        }
        
        .card {
            box-shadow: none;
            border: 1px solid black;
            page-break-inside: avoid;
        }
    }
    
    /* ==========================================================================
       Utility Classes
       ========================================================================== */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-left { text-align: left; }
    
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-muted { color: var(--text-muted); }
    .text-success { color: var(--success-dark); }
    .text-danger { color: var(--danger-dark); }
    .text-warning { color: var(--warning-dark); }
    .text-info { color: var(--info-dark); }
    
    .d-none { display: none; }
    .d-block { display: block; }
    .d-flex { display: flex; }
    
    .justify-content-between { justify-content: space-between; }
    .align-items-center { align-items: center; }
    
    /* ==========================================================================
       Animation Classes
       ========================================================================== */
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .scale-in {
        animation: scaleIn 0.2s ease-out;
    }
    
    @keyframes scaleIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    
    .slide-up {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <img src="https://gqchhsayqxttewthcsah.supabase.co/storage/v1/object/public/Branding/LOGO%20No%20Background.png" 
            alt="My Carers Logo" 
            width="200">
                        <div class="user-info">
                <span class="user-name" id="userName">Loading...</span>
                <span class="user-role" id="userRole">Staff</span>
                <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- View Controls -->
        <section class="view-controls">
            <div class="view-toggle">
                <button onclick="switchView('table')" class="active" id="tableViewBtn">Roster</button>
                <button onclick="switchView('requests')" id="requestsViewBtn">Requests</button>
                <button onclick="switchView('assignments')" id="assignmentsViewBtn">Assignments</button> <!-- ADD THIS -->
                <button onclick="switchView('templates')" data-view="templates" id="templatesViewBtn">Templates</button>
                <button onclick="switchView('conflicts')" id="conflictsViewBtn" class="btn btn-danger btn-sm">Conflicts</button>
                <button onclick="switchView('summary')" id="summaryViewBtn">Logs</button>
                <button onclick="switchView('timesheet')" id="timesheetViewBtn">Timesheet</button>
                <button onclick="switchView('notes')" id="notesViewBtn">Notes</button>
                <button onclick="switchView('availability')" id="availabilityViewBtn">Availability</button>
                <button onclick="switchView('participants')" id="participantsViewBtn">Participants</button>
                <button onclick="switchView('documents')" id="documentsViewBtn">Documents</button>
            </div>
            <div class="view-actions">
                <button class="btn btn-outline btn-sm" id="undoBtn" onclick="UndoRedoManager.undo()" disabled title="Nothing to undo (Ctrl+Z)">↶ Undo</button>
                <button class="btn btn-outline btn-sm" id="redoBtn" onclick="UndoRedoManager.redo()" disabled title="Nothing to redo (Ctrl+Y)">↷ Redo</button>
                <span style="border-left: 1px solid var(--border-color); margin: 0 8px; height: 24px;"></span>
                <button class="btn btn-primary" onclick="showAddShiftModal()">Add Shift</button>
                <button class="btn btn-warning" onclick="showPublicHolidayModal()">Holidays</button>
                <button class="btn btn-success btn-sm" onclick="generatePayrollSummary()">Payroll</button>
                <button class="btn btn-success btn-sm" onclick="exportData()">Export</button>
                <button class="btn btn-outline btn-sm" onclick="openCSVUploadModal()" style="background: #28a745; color: white;">📄 Upload CSV</button>            </div>
        </section>

        <!-- Week Navigation -->
<section class="week-nav">
    <button class="btn btn-outline" onclick="previousFortnight()">Previous Fortnight</button>
    <div class="week-display" id="weekDisplay">Loading...</div>
    <button class="btn btn-outline" onclick="nextFortnight()">Next Fortnight</button>
    <button class="btn btn-primary btn-sm" onclick="goToCurrentWeek()">Current Period</button>
</section>

        <!-- Filters -->
        <section class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>End Date</label>
                    <input type="date" id="endDate" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Staff</label>
                    <input type="text" class="searchable-input" id="staffFilterInput" 
                           placeholder="Type to search staff..." 
                           list="staffFilterList" onchange="updateStaffFilter()">
                    <datalist id="staffFilterList"></datalist>
                </div>
                <div class="filter-group">
                    <label>Participant</label>
                    <input type="text" class="searchable-input" id="participantFilterInput" 
                           placeholder="Type to search participants..." 
                           list="participantFilterList" onchange="updateParticipantFilter()">
                    <datalist id="participantFilterList"></datalist>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="statusFilter" onchange="applyFilters()">
                        <option value="">All Status</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="completed">Completed</option>
                        <option value="no_show">No Show</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Actions</label>
                    <button class="btn btn-outline btn-sm" onclick="clearAllFilters()" style="width: 100%;">Clear Filters</button>
                </div>
            </div>
        </section>

        <!-- Table View -->
        <div id="tableView" class="view-content active">
            <div class="table-container">
                <header class="table-header">
                    <h2 class="table-title">Shift Roster</h2>
                    <div class="table-actions">
                        <button class="btn btn-outline btn-sm" onclick="refreshData()">Refresh</button>
                    </div>
                </header>
                <div style="overflow-x: auto;">
                  <table class="roster-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Staff</th>
                            <th>Client</th>
                            <th>Location</th>
                            <th>Duty Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="shiftsTableBody">
                        <tr>
                            <td colspan="8" class="loading">
                                <div class="spinner"></div>
                                <span>Loading shifts...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>                
                </div>
            </div>
        </div>
       <div id="requestsView" class="view-content">
    <div class="table-container">
        <header class="table-header">
            <h2 class="table-title">Requests Management</h2>
            <div class="table-actions">
                <button class="btn btn-outline btn-sm" onclick="renderRequests()">
                    <span style="margin-right: 4px;"></span> Refresh
                </button>
            </div>
        </header>
        <div class="card-content" id="requestsContent">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading requests...</span>
            </div>
        </div>
    </div>
</div>
        <!-- Summary View -->
        <div id="summaryView" class="view-content">
            <div class="summary-grid" id="summaryGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading summary...</span>
                </div>
            </div>
        </div>

        <div id="templatesView" class="view-content" style="display: none;">
            <div class="table-container">
                <header class="table-header">
                    <h2 class="table-title">Roster Templates</h2>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="openCreateTemplateModal()">
                            <span style="margin-right: 4px;"></span> New Template
                        </button>
                        <button class="btn btn-outline" onclick="loadTemplates()">
                            <span style="margin-right: 4px;"></span> Refresh
                        </button>
                    </div>
                </header>
                <div id="templatesContent" style="padding: 24px;">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Timesheet View -->
        <div id="timesheetView" class="view-content">
            <div class="table-container">
                <header class="table-header">
                    <h2 class="table-title">Detailed Timesheet</h2>
                    <div class="table-actions">
                        <button class="btn btn-success btn-sm" onclick="exportTimesheet()">Export Timesheet</button>
                    </div>
                </header>
                <div class="card-content" id="timesheetContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading timesheet...</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="conflictsView" class="view-content">
          <div id="conflictsContent"></div>
      </div>

      <!-- Assignments View -->
<div id="assignmentsView" class="view-content" style="display: none;">
    <div class="table-container">
        <header class="table-header">
            <h2 class="table-title">Staff-Participant Assignments</h2>
            <div class="table-actions">
                <button class="btn btn-primary" onclick="switchAssignmentView('participant')">
                    By Participant
                </button>
                <button class="btn btn-outline" onclick="switchAssignmentView('staff')">
                    By Staff
                </button>
            </div>
        </header>
        <div class="card-content" id="assignmentContent">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading assignments...</span>
            </div>
        </div>
    </div>
</div>

<div id="notesView" class="view-content">
    <div class="table-container">
        <header class="table-header">
            <h2 class="table-title">Shift Notes</h2>
            <div class="table-actions">
                <!-- Change this button to call addShiftNote() -->
                <button class="btn btn-primary btn-sm" onclick="addShiftNote()">Add Shift Note</button>
            </div>
        </header>
        <div class="card-content" id="notesContent">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading notes...</span>
            </div>
        </div>
    </div>
</div>

<!-- STEP 2: ADD THIS VIEW SECTION (after availabilityView or at the end of view sections) -->
<div id="participantsView" class="view-content">
    <div class="table-container">
        <header class="table-header">
            <h2 class="table-title">Participant Management</h2>
            <div class="table-actions">
                <button class="btn btn-outline btn-sm" onclick="showParticipantMapOverview()">
                    📍 Map Overview
                </button>
                <button class="btn btn-primary" onclick="openParticipantModal()">
                    Add Participant
                </button>
                <button class="btn btn-outline btn-sm" onclick="loadParticipantsTable()">Refresh</button>
            </div>
        </header>
        
        <!-- Search and Filter Bar -->
        <div class="filters" style="padding: 1rem;">
            <div class="filter-row">
                <div class="filter-group" style="flex: 2;">
                    <label>Search</label>
                    <input type="text" id="participantSearch" placeholder="Search participants..." onkeyup="filterParticipants()">
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="participantStatusFilter" onchange="filterParticipants()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Service Type</label>
                    <select id="participantServiceFilter" onchange="filterParticipants()">
                        <option value="">All Services</option>
                        <option value="SIL">SIL</option>
                        <option value="SDA">SDA</option>
                        <option value="respite">Respite</option>
                        <option value="community">Community Access</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Actions</label>
                    <button class="btn btn-outline btn-sm" onclick="clearParticipantFilters()" style="width: 100%;">Clear Filters</button>
                </div>
            </div>
        </div>

        <!-- Participants Table -->
        <div style="overflow-x: auto;">
            <table class="roster-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>NDIS Number</th>
                        <th>Service Type</th>
                        <th>Location</th>
                        <th>Primary Contact</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="participantsTableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            <span>Loading participants...</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

    </main>

    <!-- CSV Upload Modal -->
<div id="csvUploadModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
        <header class="modal-header">
            <h3 class="modal-title">Upload Shifts CSV</h3>
            <button class="modal-close" onclick="closeCSVUploadModal()">&times;</button>
        </header>
        <div class="modal-content">
            <div id="csvUploadContainer"></div>
        </div>
    </div>
</div>

<!-- Edit Shift Modal -->
<div id="editShiftModal" class="modal-overlay" style="display: none;">
    <div class="modal large">
        <header class="modal-header">
            <h3 class="modal-title">Edit Shift</h3>
            <button class="modal-close" onclick="closeModal('editShiftModal')">&times;</button>
        </header>
        <div class="modal-content">
            <form id="editShiftForm">
                <input type="hidden" id="editShiftId">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="editShiftDate" required onchange="updateEditClockInRequiredOptions()">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="time" id="editShiftStartTime">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="time" id="editShiftEndTime">
                    </div>
                </div>
                <div class="form-group">
                    <label>Staff *</label>
                    <input type="text" class="searchable-input" id="editShiftStaffInput" 
                           placeholder="Type to search staff..." 
                           list="editStaffList" required onchange="updateEditStaffSelection()">
                    <datalist id="editStaffList"></datalist>
                    <input type="hidden" id="editShiftStaff">
                </div>
                <div class="form-group">
                    <label>Participant *</label>
                    <input type="text" class="searchable-input" id="editShiftParticipantInput" 
                           placeholder="Type to search participants..." 
                           list="editParticipantList" required onchange="updateEditParticipantSelection()">
                    <datalist id="editParticipantList"></datalist>
                    <input type="hidden" id="editShiftParticipant">
                </div>
                <div class="form-group">
                    <label>Location (Auto)</label>
                    <input type="text" id="editShiftLocationDisplay" readonly 
                           style="background: #f5f5f5; cursor: not-allowed;" 
                           placeholder="Select participant to auto-populate">
                    <input type="hidden" id="editShiftLocation">
                </div>
                <div class="form-group">
                    <label>Duty Type *</label>
                    <select id="editShiftDutyType" required onchange="updateEditTimeFields()">
                        <option value="">Select Duty Type</option>
                    </select>
                </div>
                <select id="editShiftStatus">
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
                <div class="form-group">
                    <label>Pay Rate Override</label>
                    <select id="editShiftPayRate">
                        <option value="">Use Assignment Default</option>
                    </select>
                    <small class="form-help">Leave blank to use staff-participant assignment rate</small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="editClockInRequired" style="width: auto;">
                        Clock-In Required
                    </label>
                    <small class="form-help" id="editClockInHelp">Requires staff to clock in/out via mobile app</small>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editShiftStatus">
                        <option value="scheduled">Scheduled</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="completed">Completed</option>
                        <option value="no_show">No Show</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="editShiftNotes" placeholder="Shift notes..."></textarea>
                </div>
            </form>
        </div>
        <footer class="modal-footer">
            <button class="btn btn-danger" onclick="deleteShiftConfirm()">Delete Shift</button>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('editShiftModal')">Cancel</button>
                <button class="btn btn-primary" onclick="updateShift()">Save Changes</button>
            </div>
        </footer>
    </div>
</div>

<!-- Add Shift Modal -->
<div id="addShiftModal" class="modal-overlay" style="display: none;">
    <div class="modal large">
        <header class="modal-header">
            <h3 class="modal-title">Add New Shift</h3>
            <button class="modal-close" onclick="closeModal('addShiftModal')">&times;</button>
        </header>
        <div class="modal-content">
            <form id="addShiftForm">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="shiftDate" required onchange="updateClockInRequiredOptions()">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="time" id="shiftStartTime">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="time" id="shiftEndTime">
                    </div>
                </div>
                <div class="form-group">
                    <label>Staff *</label>
                    <input type="text" class="searchable-input" id="shiftStaffInput" 
                           placeholder="Type to search staff..." 
                           list="staffDataList" required onchange="updateStaffSelection()">
                    <datalist id="staffDataList"></datalist>
                    <input type="hidden" id="shiftStaff">
                </div>
                <div class="form-group">
                    <label>Participant *</label>
                    <input type="text" class="searchable-input" id="shiftParticipantInput" 
                           placeholder="Type to search participants..." 
                           list="participantDataList" required onchange="updateParticipantSelection()">
                    <datalist id="participantDataList"></datalist>
                    <input type="hidden" id="shiftParticipant">
                </div>
                <div class="form-group">
                    <label>Location (Auto)</label>
                    <input type="text" id="shiftLocationDisplay" readonly 
                           style="background: #f5f5f5; cursor: not-allowed;" 
                           placeholder="Select participant to auto-populate">
                    <input type="hidden" id="shiftLocation">
                </div>
                <div class="form-group">
                    <label>Duty Type *</label>
                    <select id="shiftDutyType" required onchange="updateTimeFields()">
                        <option value="">Active Shift</option>
                        <option value="active_shift_default" selected>Active Shift</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pay Rate Override</label>
                    <select id="shiftPayRate" disabled>
                        <option value="">Select staff first</option>
                    </select>
                    <small class="form-help">Select staff and participant to see available pay rates</small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="clockInRequired" style="width: auto;" checked>
                        Clock-In Required
                    </label>
                    <small class="form-help" id="clockInHelp">Requires staff to clock in/out via mobile app</small>
                </div>
                <div id="hourWarningText" style="display: none;" class="hour-warning"></div>
            </form>
        </div>
        <footer class="modal-footer">
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('addShiftModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createShift()">Create Shift</button>
            </div>
        </footer>
    </div>
</div>

<!-- Public Holiday Modal -->
<div id="publicHolidayModal" class="modal-overlay" style="display: none;">
    <div class="modal large">
        <header class="modal-header">
            <h3 class="modal-title">Public Holidays Management</h3>
            <button class="modal-close" onclick="closeModal('publicHolidayModal')">&times;</button>
        </header>
        <div class="modal-content">
            <div style="margin-bottom: 24px;">
                <button class="btn btn-primary btn-sm" onclick="showAddHolidayForm()">Add Holiday</button>
            </div>
            
            <div id="addHolidayForm" class="holiday-form" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Holiday Date</label>
                        <input type="date" id="holidayDate">
                    </div>
                    <div class="form-group">
                        <label>Holiday Name</label>
                        <input type="text" id="holidayName" placeholder="e.g., Christmas Day">
                    </div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-success btn-sm" onclick="addHoliday()">Add Holiday</button>
                    <button class="btn btn-outline btn-sm" onclick="cancelAddHoliday()">Cancel</button>
                </div>
            </div>

            <div>
                <h4 style="margin-bottom: 16px; color: var(--text-secondary);">Current Public Holidays</h4>
                <div id="holidayList" style="max-height: 300px; overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading holidays...</span>
                    </div>
                </div>
            </div>
        </div>
        <footer class="modal-footer">
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('publicHolidayModal')">Close</button>
            </div>
        </footer>
    </div>
</div>

<!--Participant Modal-->
<div id="participantModal" class="modal-overlay" style="display: none;">
    <div class="modal large">
        <header class="modal-header">
            <h3 class="modal-title" id="participantModalTitle">Add Participant</h3>
            <button class="modal-close" onclick="closeModal('participantModal')">&times;</button>
        </header>
        
        <div class="modal-content">
            <!-- Tab Navigation -->
            <div class="modal-tabs">
                <button type="button" class="tab-btn active" onclick="switchParticipantTab('details', event)">
                    <i class="fas fa-user"></i> Details
                </button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('medical', event)">
                    <i class="fas fa-heartbeat"></i> Medical
                </button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('contacts', event)">
                    <i class="fas fa-address-book"></i> Contacts
                </button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('location', event)">
                    <i class="fas fa-map-marker-alt"></i> Location
                </button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('documents', event)">
                    <i class="fas fa-file-alt"></i> Documents
                </button>
                <button type="button" class="tab-btn" onclick="switchParticipantTab('staff', event)">
                    <i class="fas fa-users"></i> Staff
                </button>
            </div>

            <form id="participantForm" onsubmit="saveParticipant(event)">
                <input type="hidden" id="participantId" value="">
                
                <!-- Details Tab -->
                <div id="detailsTab" class="tab-content active">
                    <h4 class="section-title">Personal Information</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">First Name</label>
                            <input type="text" id="firstName" name="first_name" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Last Name</label>
                            <input type="text" id="lastName" name="last_name" required>
                        </div>
                        <div class="form-group">
                            <label>Preferred Name</label>
                            <input type="text" id="preferredName" name="preferred_name">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="dateOfBirth" name="date_of_birth">
                        </div>
                        <div class="form-group">
                            <label>NDIS Number</label>
                            <input type="text" id="ndisNumber" name="ndis_number" pattern="[0-9]{9}" placeholder="9 digits">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="participantStatus" name="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>

                    <h4 class="section-title">Contact Information</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="participantPhone" name="phone" placeholder="(04) XXXX XXXX">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="participantEmail" name="email" placeholder="email@example.com">
                        </div>
                    </div>

                    <h4 class="section-title">Service Details</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Service Type</label>
                            <select id="serviceType" name="service_type">
                                <option value="">Select Service</option>
                                <option value="SIL">SIL (Supported Independent Living)</option>
                                <option value="SDA">SDA (Specialist Disability Accommodation)</option>
                                <option value="respite">Respite Care</option>
                                <option value="community">Community Access</option>
                                <option value="development">Development Life Skills</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Funding Type</label>
                            <select id="fundingType" name="funding_type">
                                <option value="">Select...</option>
                                <option value="self-managed">Self Managed</option>
                                <option value="plan-managed">Plan Managed</option>
                                <option value="agency-managed">Agency Managed (NDIA)</option>
                            </select>
                        </div>
                    </div>

                    <h4 class="section-title">Plan Information</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Plan Manager</label>
                            <input type="text" id="planManager" name="plan_manager" placeholder="Plan manager name">
                        </div>
                        <div class="form-group">
                            <label>Plan Manager Email</label>
                            <input type="email" id="planManagerEmail" name="participant_plan_manager_email" 
                                   placeholder="pm@example.com">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Plan Start Date</label>
                            <input type="date" id="planStartDate" name="plan_start_date">
                        </div>
                        <div class="form-group">
                            <label>Plan End Date</label>
                            <input type="date" id="planEndDate" name="plan_end_date">
                        </div>
                    </div>

                    <h4 class="section-title">Residential Address</h4>
                    <div class="form-group">
                        <label>Search Address</label>
                        <input type="text" id="addressAutocomplete" placeholder="Start typing address..." 
                               class="address-search">
                        <small class="form-help">
                            <i class="fas fa-info-circle"></i> Type to search and select from suggestions
                        </small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit/Apartment</label>
                            <input type="text" id="unitNumber" name="unit_number" placeholder="Unit 1">
                        </div>
                        <div class="form-group">
                            <label>Street Number</label>
                            <input type="text" id="streetNumber" name="street_number" placeholder="123">
                        </div>
                        <div class="form-group">
                            <label>Street Name</label>
                            <input type="text" id="streetName" name="street_name" placeholder="Main Street">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Suburb</label>
                            <input type="text" id="suburb" name="suburb" placeholder="Sydney">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <select id="state" name="state">
                                <option value="">Select State</option>
                                <option value="NSW">NSW</option>
                                <option value="VIC">VIC</option>
                                <option value="QLD">QLD</option>
                                <option value="SA">SA</option>
                                <option value="WA">WA</option>
                                <option value="TAS">TAS</option>
                                <option value="ACT">ACT</option>
                                <option value="NT">NT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Postcode</label>
                            <input type="text" id="postcode" name="postcode" pattern="[0-9]{4}" placeholder="2000">
                        </div>
                    </div>
                    
                    <!-- Hidden coordinate fields -->
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">

                    <h4 class="section-title">Support Needs</h4>
                    <div class="form-group">
                        <label>Support Needs</label>
                        <textarea id="supportNeeds" name="support_needs" rows="3" 
                                  placeholder="Describe support requirements..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Mobility Requirements</label>
                            <textarea id="mobilityRequirements" name="mobility_requirements" rows="2" 
                                      placeholder="e.g., Wheelchair access required"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Communication Needs</label>
                            <textarea id="communicationNeeds" name="communication_needs" rows="2" 
                                      placeholder="e.g., Uses AUSLAN, Picture cards"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea id="participantNotes" name="notes" rows="4" 
                                  placeholder="Any other important information..."></textarea>
                    </div>
                </div>

                <!-- Medical Tab -->
                <div id="medicalTab" class="tab-content" style="display: none;">
                    <h4 class="section-title">Health Insurance</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Medicare Number</label>
                            <input type="text" id="medicareNumber" name="medicare_number" 
                                   placeholder="XXXX XXXXX X/X">
                        </div>
                        <div class="form-group">
                            <label>Private Health Insurance</label>
                            <input type="text" id="privateHealth" name="private_health" 
                                   placeholder="Provider and number">
                        </div>
                    </div>

                    <h4 class="section-title">General Practitioner</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>GP Name</label>
                            <input type="text" id="gpName" name="gp_name" placeholder="Dr. Smith">
                        </div>
                        <div class="form-group">
                            <label>GP Phone</label>
                            <input type="tel" id="gpPhone" name="gp_phone" placeholder="(02) XXXX XXXX">
                        </div>
                    </div>

                    <h4 class="section-title">Medical Information</h4>
                    <div class="form-group">
                        <label>Medical Conditions</label>
                        <textarea id="medicalConditions" name="medical_conditions" rows="3" 
                                  placeholder="List known medical conditions..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Allergies</label>
                        <textarea id="allergies" name="allergies" rows="2" 
                                  placeholder="List any allergies (food, medication, etc.)..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Dietary Requirements</label>
                        <textarea id="dietaryRequirements" name="dietary_requirements" rows="2" 
                                  placeholder="Special dietary needs or restrictions..."></textarea>
                    </div>

                    <h4 class="section-title">
                        Medications
                        <button type="button" class="btn btn-sm btn-outline" onclick="addMedicationRow()" 
                                style="margin-left: auto;">
                            <i class="fas fa-plus"></i> Add Medication
                        </button>
                    </h4>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Medication Name</th>
                                    <th>Dosage</th>
                                    <th>Frequency</th>
                                    <th>Prescriber</th>
                                    <th>Start Date</th>
                                    <th width="80">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="medicationsTableBody">
                                <tr class="no-data">
                                    <td colspan="6" class="text-center">No medications added</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Contacts Tab -->
                <div id="contactsTab" class="tab-content" style="display: none;">
                    <h4 class="section-title">Primary Contact</h4>
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        This is the main contact person for the participant (family member, guardian, etc.)
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="primaryContactName" name="primary_contact_name" 
                                   placeholder="John Smith">
                        </div>
                        <div class="form-group">
                            <label>Relationship</label>
                            <input type="text" id="primaryContactRelationship" name="primary_contact_relationship" 
                                   placeholder="e.g., Parent, Guardian, Sibling">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="primaryContactPhone" name="primary_contact_phone" 
                                   placeholder="(04) XXXX XXXX">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="primaryContactEmail" name="primary_contact_email" 
                                   placeholder="contact@example.com">
                        </div>
                    </div>

                    <h4 class="section-title">
                        Emergency Contacts
                        <button type="button" class="btn btn-sm btn-outline" onclick="addEmergencyContact()" 
                                style="margin-left: auto;">
                            <i class="fas fa-plus"></i> Add Emergency Contact
                        </button>
                    </h4>
                    
                    <div class="info-box">
                        <i class="fas fa-exclamation-triangle"></i>
                        Add additional contacts to be notified in case of emergencies
                    </div>
                    
                    <div id="emergencyContactsList">
                        <!-- Emergency contacts will be added here -->
                    </div>
                </div>

                <!-- Location Tab -->
                <div id="locationTab" class="tab-content" style="display: none;">
                    <div class="location-controls">
                        <button type="button" class="btn btn-outline btn-sm" onclick="getCurrentLocation()">
                            <i class="fas fa-crosshairs"></i> Get Current Location
                        </button>
                        <div class="form-group" style="max-width: 250px;">
                            <label>Geofence Radius (meters)</label>
                            <input type="number" id="geofenceRadius" value="100" min="50" max="1000" step="50" 
                                   onchange="updateGeofence()">
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="participantMap" class="map-container"></div>
                    
                    <!-- Location Information Display -->
                    <div class="location-info-card">
                        <h4><i class="fas fa-map-marker-alt"></i> Location Information</h4>
                        <div class="info-grid">
                            <div>
                                <strong>Address:</strong>
                                <div id="locationAddressDisplay" class="location-display">
                                    Not set - Select address from the Details tab
                                </div>
                            </div>
                            <div>
                                <strong>Coordinates:</strong>
                                <div class="location-display">
                                    <div>Lat: <span id="latDisplay">-</span></div>
                                    <div>Lng: <span id="lngDisplay">-</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="location-tips">
                            <div><i class="fas fa-hand-pointer"></i> Drag marker to adjust location</div>
                            <div><i class="fas fa-search"></i> Use address search in Details tab</div>
                            <div><i class="fas fa-database"></i> Saves as location_lat and location_lng</div>
                        </div>
                    </div>
                    
                    <div class="info-box info">
                        <i class="fas fa-info-circle"></i>
                        <strong>About Location Tracking:</strong><br>
                        This location represents the participant's primary residence. Staff clock-in/out locations 
                        are tracked separately in the Shifts section.
                    </div>
                </div>

                <!-- Documents Tab -->
                <div id="documentsTab" class="tab-content" style="display: none;">
                    <div class="document-upload-section">
                        <h4 class="section-title">Upload New Document</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="required">Document Type</label>
                                <select id="documentType" required>
                                    <option value="">Select Type</option>
                                    <option value="schedule_of_supports">Schedule of Supports</option>
                                    <option value="care_plan">Care Plan</option>
                                    <option value="behavior_support">Behavior Support Plan</option>
                                    <option value="medical_report">Medical Report</option>
                                    <option value="assessment">Assessment</option>
                                    <option value="consent_form">Consent Form</option>
                                    <option value="service_agreement">Service Agreement</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">Document Name</label>
                                <input type="text" id="documentName" placeholder="e.g., Care Plan 2024" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Expiry Date</label>
                                <input type="date" id="documentExpiry">
                                <small class="form-help">Leave blank if document doesn't expire</small>
                            </div>
                            <div class="form-group">
                                <label class="required">Select File</label>
                                <input type="file" id="documentFile" 
                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                                <small class="form-help">PDF, DOC, DOCX, JPG, PNG (Max 10MB)</small>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="uploadParticipantDocument()">
                            <i class="fas fa-upload"></i> Upload Document
                        </button>
                    </div>

                    <h4 class="section-title">Existing Documents</h4>
                    <div class="search-bar">
                        <input type="text" placeholder="Search documents..." 
                               onkeyup="filterDocuments(this.value)" class="search-input">
                        <i class="fas fa-search"></i>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Document Name</th>
                                    <th>Type</th>
                                    <th>Uploaded</th>
                                    <th>Expiry</th>
                                    <th width="120">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTableBody">
                                <tr class="no-data">
                                    <td colspan="5" class="text-center">No documents uploaded</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Staff Tab -->
                <div id="staffTab" class="tab-content" style="display: none;">
                    <h4 class="section-title">Assign Staff</h4>
                    <div class="staff-assignment-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Select Staff Member</label>
                                <select id="staffToAdd">
                                    <option value="">Choose staff...</option>
                                    <!-- Staff options populated by JS -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="staffRole">
                                    <option value="support_worker">Support Worker</option>
                                    <option value="team_leader">Team Leader</option>
                                    <option value="coordinator">Coordinator</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="assignStaff()">
                            <i class="fas fa-user-plus"></i> Assign Staff
                        </button>
                    </div>

                    <h4 class="section-title">Assigned Staff Members</h4>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Staff Name</th>
                                    <th>Role</th>
                                    <th>Primary</th>
                                    <th>Assigned Since</th>
                                    <th width="100">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assignedStaffTable">
                                <tr class="no-data">
                                    <td colspan="5" class="text-center">No staff assigned yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </form>
        </div>
        
        <footer class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('participantModal')">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-primary" onclick="document.getElementById('participantForm').requestSubmit()">
                <i class="fas fa-save"></i> Save Participant
            </button>
        </footer>
    </div>
</div>

<div id="documentsView" class="view-content" style="display: none;">
    <!-- DocumentsModule will populate this automatically -->
</div>

    <script>
    
        // Initialize Supabase
        const supabaseUrl = 'https://gqchhsayqxttewthcsah.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxY2hoc2F5cXh0dGV3dGhjc2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTA0ODksImV4cCI6MjA3MjI2NjQ4OX0.iAGhrDZaHkpLwjJY07o-73l2OiePB2x1ZnnTEfUBd_M';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        
        
        let requestViewMode = 'staff';
        let publicHolidays = new Map();
        let rosterTemplates = [];
        let currentTemplate = null;
        let templateShifts = [];
        let payRateLabels = new Map();
        
        let currentUser = null;
        let currentUserRole = 'staff';
        let currentStaffData = null;
        let shifts = [];
        let shiftId= [];
        let staff = [];
        let participants = [];
        let locations = [];
        let dutyTypes = [];
        let payRates = [];
        let filteredShifts = [];
        let currentView = 'table';
        let currentWeekStart = new Date();
        let staffFilterValue = '';
        let participantFilterValue = '';
        let undoStack = [];
        let redoStack = [];
        let assignmentViewMode = 'participant';
        let currentRequestType = 'transport_claims';
        let currentRequestStatus = 'pending';
        let isLoadingRequest = false;
        let currentManagerStaff = null;
        let currentParticipantId = null;
        let participantMap = null;
        let participantMarker = null;
        let geofenceCircle = null;
        let autocomplete = null;
        let participantsData = [];


const MAX_UNDO_STACK = 20;
let careHomes = new Map(); 
let activeCareHomeFilter = null; 
const TIMEZONE = 'Australia/Sydney';
const LOCALE = 'en-AU';
const LOCATION_IDS = {
    SAUNDERS_CARE_HOME: "82be1e0c-7036-4063-b161-1ab91162c3e1",
    CLIENT_HOME: "00000000-0000-0000-0000-000000000001", 
    MY_CARERS_OFFICE: "e020835c-b8d8-46d2-81ac-4761cbe77f17"
};

const DB_ERRORS = {
    FOREIGN_KEY_VIOLATION: "23503", // Referenced record doesn't exist
    UNIQUE_VIOLATION: "23505",      // Duplicate entry
    NOT_NULL_VIOLATION: "23502"     // Required field missing
};

async function verifyDataConnections() {
    console.log('=== VERIFYING DATA CONNECTIONS ===');
    
    const tests = {
        // Test shifts table structure
        'Shifts ID type': async () => {
            const { data } = await supabaseClient.from('shifts').select('id').limit(1);
            return data?.[0]?.id ? `✅ Type: ${typeof data[0].id}` : '❌ No shifts';
        },
        
        // Test shift_adjustment_requests
        'Adjustment Request shift_id': async () => {
            const { error } = await supabaseClient
                .from('shift_adjustment_requests')
                .insert({ 
                    shift_id: 1, // Try integer
                    staff_id: staff[0]?.id,
                    reason: 'test'
                })
                .select();
            await supabaseClient.from('shift_adjustment_requests').delete().eq('reason', 'test');
            return error ? `❌ Error: ${error.message}` : '✅ Accepts integers';
        },
        
        // Test template day_of_week constraint
        'Template day_of_week range': async () => {
            const { data } = await supabaseClient
                .from('roster_template_shifts')
                .select('day_of_week')
                .order('day_of_week');
            const days = [...new Set(data?.map(d => d.day_of_week) || [])];
            return `Range: ${Math.min(...days)}-${Math.max(...days)} (Should be 0-6)`;
        },
        
        // Check loaded data
        'Staff loaded': staff?.length || 0,
        'Participants loaded': participants?.length || 0,
        'Locations loaded': locations?.length || 0,
        'Duty Types loaded': dutyTypes?.length || 0,
        'Current Staff': currentStaffData?.id ? '✅' : '❌'
    };
    
    for (const [test, check] of Object.entries(tests)) {
        const result = typeof check === 'function' ? await check() : check;
        console.log(`${test}: ${result}`);
    }
}


// ========================================
// FORTNIGHT NAVIGATION
// ========================================

function setCurrentWeek(skipDateRange = false) {
    const today = new Date();
    currentWeekStart = getFortnightStart(today);
    updateWeekDisplay(skipDateRange);
}

function previousFortnight() {
    const prevFortnight = new Date(currentWeekStart);
    prevFortnight.setDate(prevFortnight.getDate() - 14);
    // Recalculate to ensure we're on a Monday
    currentWeekStart = getFortnightStart(prevFortnight);
    updateWeekDisplay();
    applyFilters();
}

function nextFortnight() {
    const nextFortnight = new Date(currentWeekStart);
    nextFortnight.setDate(nextFortnight.getDate() + 14);
    // Recalculate to ensure we're on a Monday
    currentWeekStart = getFortnightStart(nextFortnight);
    updateWeekDisplay();
    applyFilters();
}
function goToCurrentWeek() {
    setCurrentWeek();
    applyFilters();
}

function updateWeekDisplay(skipDateRange = false) {
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 13);
    
    const startStr = currentWeekStart.toLocaleDateString('en-AU', { 
        day: 'numeric', month: 'short' 
    });
    const endStr = weekEnd.toLocaleDateString('en-AU', { 
        day: 'numeric', month: 'short', year: 'numeric' 
    });
    
    const display = document.getElementById('weekDisplay');
    if (display) {
        display.textContent = `${startStr} - ${endStr}`;
    }
    
    // Only set date range if not skipping
    if (!skipDateRange) {
        setFortnightDateRange();
    }
}


function getFortnightStart(date) {
    console.log('Input:', date.toDateString(), 'Day:', ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][date.getDay()]);
    
    const start = new Date(date);
    const day = start.getDay();
    
    let daysBack;
    if (day === 0) {
        daysBack = 6;
    } else {
        daysBack = day - 1;
    }
    
    start.setDate(start.getDate() - daysBack);
    start.setHours(0, 0, 0, 0);
    console.log('After Monday calc:', start.toDateString(), 'Day:', ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][start.getDay()]);
    
    // Fortnight alignment
    const referenceDate = new Date('2025-09-29');
    const daysDiff = Math.floor((start - referenceDate) / (1000 * 60 * 60 * 24));
    const weekNumber = Math.floor(daysDiff / 7);
    
    if (weekNumber % 2 === 1) {
        start.setDate(start.getDate() - 7);
        console.log('After fortnight align:', start.toDateString(), 'Day:', ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][start.getDay()]);
    }
    
    console.log('Final result:', start.toDateString(), 'Day:', ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][start.getDay()]);
    return start;
}

function setFortnightDateRange() {
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 13);
    
    // Create new dates to avoid timezone issues
    const startYear = currentWeekStart.getFullYear();
    const startMonth = String(currentWeekStart.getMonth() + 1).padStart(2, '0');
    const startDay = String(currentWeekStart.getDate()).padStart(2, '0');
    const startDateStr = `${startYear}-${startMonth}-${startDay}`;
    
    const endYear = weekEnd.getFullYear();
    const endMonth = String(weekEnd.getMonth() + 1).padStart(2, '0');
    const endDay = String(weekEnd.getDate()).padStart(2, '0');
    const endDateStr = `${endYear}-${endMonth}-${endDay}`;
    
    console.log('Setting dates:', {
        start: startDateStr,
        end: endDateStr,
        startDay: currentWeekStart.getDay(),
        endDay: weekEnd.getDay()
    });
    
    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    
    if (startInput) startInput.value = startDateStr;
    if (endInput) endInput.value = endDateStr;
}

// Backward compatibility for any code still calling old functions
const previousWeek = previousFortnight;
const nextWeek = nextFortnight;

async function initializeApp() {
    try {
        console.log('=== INITIALIZING MC MANAGER ===');
        
        // Check authentication
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error) throw error;
        
        if (!session) {
            window.location.href = 'index.html';
            return;
        }

        currentUser = session.user;
        
        // Check both possible locations for role
        currentUserRole = currentUser.user_metadata?.role || 
                         currentUser.raw_user_meta_data?.role || 
                         'staff';
        
        console.log('User authenticated:', currentUser.email);
        console.log('User role detected:', currentUserRole);
        
        // =======================================
        // ROLE-BASED ACCESS CONTROL
        // =======================================
        // Redirect staff members to team.html
        if (currentUserRole === 'staff') {
            console.log('Staff member detected - redirecting to team.html');
            window.location.href = 'team.html';
            return;
        }
        
        // Only managers, admins, and coordinators can access mc-manager.html
        const allowedRoles = ['manager', 'admin', 'coordinator'];
        if (!allowedRoles.includes(currentUserRole)) {
            console.log('Unauthorized role detected - redirecting to team.html');
            showNotification('Access denied. Redirecting to team portal...', 'error');
            setTimeout(() => {
                window.location.href = 'team.html';
            }, 2000);
            return;
        }
        
        // Get staff record if linked
        if (currentUser.id) {
            const { data: staffData, error: staffError } = await supabaseClient
                .from('staff')
                .select('*')
                .eq('user_id', currentUser.id)
                .maybeSingle();
            
            if (staffError) {
                console.error('Error loading staff data:', staffError);
            }
            
            currentStaffData = staffData;
            currentManagerStaff = staffData; // Set global for approval functions
            console.log('Current staff data loaded:', currentStaffData);
        }

        // Update UI
        let displayName = 'Unknown User';
        
        if (currentStaffData) {
            displayName = `${currentStaffData.first_name} ${currentStaffData.last_name}`;
        } else if (currentUser.user_metadata?.first_name) {
            displayName = `${currentUser.user_metadata.first_name} ${currentUser.user_metadata.last_name || ''}`;
        } else if (currentUser.email) {
            displayName = currentUser.email.split('@')[0];
        }
        
        
        // Update the UI elements
        document.getElementById('userName').textContent = displayName;
        document.getElementById('userRole').textContent = 
            currentUserRole.charAt(0).toUpperCase() + currentUserRole.slice(1);

        // Initialize week navigation
        setCurrentWeek(false);            
        
        // Load all data - make sure these functions exist
        await loadInitialData();
        
        // Load duty types for template dropdowns
        await loadDutyTypes();
        
        await loadPublicHolidays();
        
        await loadShifts();
        
        // =======================================
        // INITIALIZE ROSTER ENHANCEMENTS
        // =======================================
        createRosterSummaryContainer();
        addRosterStyles();
        updateTableHeaders();
        initializeShiftModalEnhancements();
        
        console.log('=== ROSTER ENHANCEMENTS INITIALIZED ===');
        console.log('=== INITIALIZATION COMPLETE ===');

    } catch (error) {
        console.error('CRITICAL: Initialization error:', error);
        document.getElementById('userName').textContent = 'Error Loading';
        document.getElementById('userRole').textContent = 'Error';
        showNotification('Failed to initialize: ' + error.message, 'error');
    }
}
// Vanilla JavaScript CSV Upload Component
function createCSVUploadInterface() {
    return `
        <div style="max-width: 100%; margin: 0 auto; padding: 24px; background: white;">
            <div style="margin-bottom: 32px;">
                <h1 style="font-size: 24px; font-weight: bold; color: #111827; margin-bottom: 8px;">Shifts CSV Upload</h1>
                <p style="color: #6b7280;">
                    Upload shifts with automatic pay override resolution based on staff-participant assignments
                </p>
                <!-- Invalid Rows Details -->
                <div id="invalidRowsDetails" style="display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-top: 16px;">
                    <h4 style="font-weight: 500; color: #991b1b; margin-bottom: 12px;">Invalid Rows Details</h4>
                    <div id="invalidRowsList" style="max-height: 300px; overflow-y: auto; font-size: 14px;">
                        <!-- Invalid rows will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Template Download -->
            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h3 style="font-size: 18px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">CSV Template</h3>
                        <p style="color: #1d4ed8;">Download the template to ensure proper formatting</p>
                    </div>
                    <button onclick="downloadCSVTemplate()" 
                            style="display: flex; align-items: center; gap: 8px; background: #2563eb; color: white; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; transition: background-color 0.2s;">
                        <span>📥</span>
                        Download Template
                    </button>
                </div>
            </div>

            <!-- Required Fields Info -->
            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 12px;">CSV Requirements</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                    <div>
                        <h4 style="font-weight: 500; color: #374151; margin-bottom: 8px;">Required Fields:</h4>
                        <ul style="font-size: 14px; color: #6b7280; margin: 0; padding-left: 0; list-style: none;">
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                                date
                            </li>
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                                duty_type_id
                            </li>
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                                participant_id
                            </li>
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                                location_id
                            </li>
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                                created_by
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="font-weight: 500; color: #374151; margin-bottom: 8px;">Optional Fields:</h4>
                        <ul style="font-size: 14px; color: #6b7280; margin: 0; padding-left: 0; list-style: none;">
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%;"></div>
                                staff_id
                            </li>
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%;"></div>
                                start_time
                            </li>
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%;"></div>
                                end_time
                            </li>
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%;"></div>
                                notes
                            </li>
                            <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%;"></div>
                                clock_in_required
                            </li>
                        </ul>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: #dcfce7; border: 1px solid #bbf7d0; border-radius: 6px;">
                    <p style="font-size: 14px; color: #166534; margin: 0;">
                        <strong>Note:</strong> The pay_override_id will be automatically determined based on the staff_participant_assignments table. 
                        Do not include this field in your CSV.
                    </p>
                </div>
                <div style="margin-top: 8px; padding: 12px; background: #dbeafe; border: 1px solid #bfdbfe; border-radius: 6px;">
                    <p style="font-size: 14px; color: #1e40af; margin: 0;">
                        <strong>clock_in_required format:</strong> Use true/false, 1/0, or yes/no values.
                    </p>
                </div>
                <div style="margin-top: 8px; padding: 12px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 6px;">
                    <p style="font-size: 14px; color: #92400e; margin: 0;">
                        <strong>Status:</strong> All uploaded shifts will automatically have status set to "confirmed".
                    </p>
                </div>
            </div>

            <!-- File Upload -->
            <div id="fileUploadArea" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 32px; margin-bottom: 24px; text-align: center; cursor: pointer;">
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                
                <div id="uploadPrompt">
                    <div style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;">📁</div>
                    <p style="font-size: 18px; font-weight: 500; color: #374151; margin-bottom: 8px;">Upload CSV File</p>
                    <p style="color: #6b7280; margin-bottom: 16px;">Select a CSV file containing shift data</p>
                    <button onclick="document.getElementById('csvFileInput').click()" 
                            style="background: #2563eb; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">
                        Choose File
                    </button>
                </div>
                
                <div id="fileSelected" style="display: none;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 16px;">
                        <div style="font-size: 32px; color: #2563eb;">📄</div>
                        <div style="text-align: left;">
                            <p id="fileName" style="font-weight: 500; color: #374151; margin: 0;"></p>
                            <p id="fileSize" style="font-size: 14px; color: #6b7280; margin: 0;"></p>
                        </div>
                        <button onclick="clearFile()" style="color: #dc2626; background: none; border: none; cursor: pointer; font-size: 20px;">✕</button>
                    </div>
                </div>
            </div>

            <!-- Errors -->
            <div id="errorContainer" style="display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="color: #dc2626; font-size: 20px;">⚠️</span>
                    <h3 style="font-weight: 500; color: #991b1b; margin: 0;">Errors</h3>
                </div>
                <ul id="errorList" style="font-size: 14px; color: #991b1b; margin: 0; padding-left: 20px;"></ul>
            </div>

            <!-- Process Button -->
            <div id="processButtonContainer" style="display: none;">
                <button id="processButton" onclick="processCSV()" 
                        style="width: 100%; background: #059669; color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500;">
                    Process and Upload Shifts
                </button>
            </div>

            <!-- Processing State -->
            <div id="processingContainer" style="display: none; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 24px; text-align: center;">
                <div style="font-size: 32px; color: #2563eb; margin-bottom: 16px;">⏳</div>
                <p style="color: #1e40af; font-weight: 500; margin-bottom: 4px;">Processing shifts and resolving pay overrides...</p>
                <p style="color: #2563eb; font-size: 14px; margin: 0;">This may take a few moments</p>
            </div>

            <!-- Results -->
            <div id="resultsContainer" style="display: none;">
                <!-- Validation Results -->
                <div id="validationResults" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 12px;">Validation Results</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div style="text-align: center;">
                            <div id="totalRows" style="font-size: 24px; font-weight: bold; color: #111827;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Total Rows</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="validRows" style="font-size: 24px; font-weight: bold; color: #059669;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Valid</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="invalidRows" style="font-size: 24px; font-weight: bold; color: #dc2626;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Invalid</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="payOverrides" style="font-size: 24px; font-weight: bold; color: #2563eb;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Pay Overrides Resolved</div>
                        </div>
                    </div>
                </div>

                <!-- Upload Results -->
                <div id="uploadResults" style="display: none; background: #ecfdf5; border: 1px solid #bbf7d0; border-radius: 8px; padding: 24px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <span style="color: #059669; font-size: 24px;">✅</span>
                        <h3 style="font-size: 18px; font-weight: 600; color: #065f46; margin: 0;">Upload Complete</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div style="text-align: center;">
                            <div id="totalProcessed" style="font-size: 24px; font-weight: bold; color: #111827;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Total Processed</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="successful" style="font-size: 24px; font-weight: bold; color: #059669;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Successful</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="failed" style="font-size: 24px; font-weight: bold; color: #dc2626;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Failed</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="payOverridesResolved" style="font-size: 24px; font-weight: bold; color: #2563eb;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Pay Overrides Auto-Resolved</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Global variables for CSV upload
let selectedFile = null;
let validationResults = null;

// Download CSV template
function downloadCSVTemplate() {
    const headers = [
        'date',
        'start_time',
        'end_time', 
        'duty_type_id',
        'staff_id',
        'participant_id',
        'location_id',
        'created_by',
        'notes',
        'clock_in_required'
    ];
    
    const sampleData = [
        '2024-03-15',
        '09:00:00',
        '17:00:00',
        'duty-type-uuid-here',
        'staff-uuid-here',
        'participant-uuid-here', 
        'location-uuid-here',
        'creator-uuid-here',
        'Regular shift',
        'false'
    ];

    const csvContent = [
        headers.join(','),
        sampleData.join(',')
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'shifts_upload_template.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Handle file selection
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file && file.type === 'text/csv') {
        selectedFile = file;
        showSelectedFile(file);
        hideErrors();
        hideResults();
        showProcessButton();
    } else {
        showError(['Please select a valid CSV file']);
        clearFile();
    }
}

// Show selected file info
function showSelectedFile(file) {
    document.getElementById('uploadPrompt').style.display = 'none';
    document.getElementById('fileSelected').style.display = 'block';
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
}

// Clear selected file
function clearFile() {
    selectedFile = null;
    document.getElementById('csvFileInput').value = '';
    document.getElementById('uploadPrompt').style.display = 'block';
    document.getElementById('fileSelected').style.display = 'none';
    hideProcessButton();
    hideErrors();
    hideResults();
}

// Show/hide UI elements
function showError(errors) {
    const errorContainer = document.getElementById('errorContainer');
    const errorList = document.getElementById('errorList');
    
    errorList.innerHTML = '';
    errors.forEach(error => {
        const li = document.createElement('li');
        li.textContent = `• ${error}`;
        errorList.appendChild(li);
    });
    
    errorContainer.style.display = 'block';
}

function hideErrors() {
    document.getElementById('errorContainer').style.display = 'none';
}

function showProcessButton() {
    document.getElementById('processButtonContainer').style.display = 'block';
}

function hideProcessButton() {
    document.getElementById('processButtonContainer').style.display = 'none';
}

function showProcessing() {
    document.getElementById('processingContainer').style.display = 'block';
    hideProcessButton();
}

function hideProcessing() {
    document.getElementById('processingContainer').style.display = 'none';
}

function hideResults() {
    document.getElementById('resultsContainer').style.display = 'none';
}

function showResults(results) {
    document.getElementById('totalRows').textContent = results.totalRows;
    document.getElementById('validRows').textContent = results.validRows;
    document.getElementById('invalidRows').textContent = results.invalidRows;
    document.getElementById('payOverrides').textContent = results.payOverrides;
    
    // Show invalid rows details if there are any
    if (results.invalidRowsData && results.invalidRowsData.length > 0) {
        const invalidRowsDetails = document.getElementById('invalidRowsDetails');
        const invalidRowsList = document.getElementById('invalidRowsList');
        
        let invalidHTML = '';
        results.invalidRowsData.forEach(row => {
            invalidHTML += `
                <div style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid #dc2626;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Row ${row.row}</div>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 8px;">
                        ${Object.entries(row.data).slice(0, 3).map(([key, value]) => `${key}: ${value}`).join(' | ')}
                    </div>
                    <ul style="margin: 0; padding-left: 16px; color: #991b1b;">
                        ${row.errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                </div>
            `;
        });
        
        invalidRowsList.innerHTML = invalidHTML;
        invalidRowsDetails.style.display = 'block';
    }
    
    document.getElementById('resultsContainer').style.display = 'block';
}

function showUploadResults(results) {
    document.getElementById('totalProcessed').textContent = results.totalProcessed;
    document.getElementById('successful').textContent = results.successful;
    document.getElementById('failed').textContent = results.failed;
    document.getElementById('payOverridesResolved').textContent = results.payOverridesResolved;
    
    // Add additional info about replacements vs inserts
    const uploadResults = document.getElementById('uploadResults');
    if (results.replaced || results.inserted) {
        const additionalInfo = uploadResults.querySelector('.additional-info') || document.createElement('div');
        additionalInfo.className = 'additional-info';
        additionalInfo.style.cssText = 'margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 6px; font-size: 14px; color: #374151;';
        additionalInfo.innerHTML = `
            <strong>Details:</strong><br>
            • ${results.inserted || 0} new shifts inserted<br>
            • ${results.replaced || 0} existing shifts replaced
        `;
        
        if (!uploadResults.querySelector('.additional-info')) {
            uploadResults.appendChild(additionalInfo);
        }
    }
    
    document.getElementById('uploadResults').style.display = 'block';
}

// Validation functions
function isValidDate(dateString) {
    const regex = /^\d{4}-\d{2}-\d{2}$/;
    if (!regex.test(dateString)) return false;
    const date = new Date(dateString);
    return date instanceof Date && !isNaN(date);
}

function isValidTime(timeString) {
    const regex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;
    return regex.test(timeString);
}

function isValidBoolean(value) {
    const normalizedValue = value.toString().toLowerCase().trim();
    return ['true', 'false', '1', '0', 'yes', 'no'].includes(normalizedValue);
}

// Process CSV file
// Add this fixed version to your mc-manager.html
async function processCSV() {
    if (!selectedFile) return;

    showProcessing();
    hideErrors();

    try {
        const text = await selectedFile.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
            showError(['CSV file must contain at least a header row and one data row']);
            hideProcessing();
            return;
        }

        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const csvData = lines.slice(1).map(line => {
            const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
            const row = {};
            headers.forEach((header, index) => {
                row[header] = values[index] || '';
            });
            return row;
        });

        const requiredColumns = [
            'date', 'duty_type_id', 'participant_id', 'location_id', 'created_by'
        ];

        const missingColumns = requiredColumns.filter(col => !headers.includes(col));
        if (missingColumns.length > 0) {
            showError([`Missing required columns: ${missingColumns.join(', ')}`]);
            hideProcessing();
            return;
        }

        const results = await validateCSV(csvData);
        
        hideProcessing();
        showResults({
            totalRows: results.totalRows,
            validRows: results.validRows.length,
            invalidRows: results.invalidRows.length,
            payOverrides: results.payOverrideResolutions.filter(r => r.success).length,
            invalidRowsData: results.invalidRows
        });

        // Actually upload the valid data
        if (results.validRows.length > 0) {
            setTimeout(async () => {
                let successful = 0;
                let failed = 0;

                for (const validRow of results.validRows) {
    const payOverride = results.payOverrideResolutions.find(p => 
        p.staffId === validRow.data.staff_id &&
        p.participantId === validRow.data.participant_id &&
        p.shiftDate === validRow.data.date
    );

    // REQUIRE valid pay override - this is the whole point
    if (!payOverride || !payOverride.success) {
        console.error('No valid pay override for row:', validRow.row, validRow.data);
        failed++;
        continue;
    }

    try {
        const insertData = {
            date: validRow.data.date,
            duty_type_id: validRow.data.duty_type_id,
            participant_id: validRow.data.participant_id,
            location_id: validRow.data.location_id,
            created_by: validRow.data.created_by,
            staff_id: validRow.data.staff_id,
            pay_override_id: payOverride.payRateId, // This is the key field
            status: 'confirmed',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        // Add optional fields
        if (validRow.data.start_time) insertData.start_time = validRow.data.start_time;
        if (validRow.data.end_time) insertData.end_time = validRow.data.end_time;
        if (validRow.data.notes) insertData.notes = validRow.data.notes;

        const { error } = await supabaseClient
            .from('shifts')
            .insert([insertData]);

        if (error) throw error;
        successful++;
    } catch (error) {
        console.error('Insert failed:', error);
        failed++;
    }
}

                showUploadResults({
                    totalProcessed: results.totalRows,
                    successful,
                    failed,
                    payOverridesResolved: results.payOverrideResolutions.filter(r => r.success).length
                });

                // Refresh data
                if (typeof loadShifts === 'function') {
                    await loadShifts();
                }
            }, 1000);
        }

    } catch (error) {
        hideProcessing();
        showError([`Error processing file: ${error.message}`]);
    }
}
// Validate CSV data
async function validateCSV(csvData) {
    const results = {
        totalRows: csvData.length,
        validRows: [],
        invalidRows: [],
        payOverrideResolutions: []
    };

    const requiredColumns = [
        'date', 'duty_type_id', 'participant_id', 'location_id', 'created_by'
    ];

    for (let i = 0; i < csvData.length; i++) {
        const row = csvData[i];
        const rowErrors = [];
        
        // Check required columns
        requiredColumns.forEach(col => {
            if (!row[col] || row[col].trim() === '') {
                rowErrors.push(`Missing required field: ${col}`);
            }
        });

        // Validate date format
        if (row.date && !isValidDate(row.date)) {
            rowErrors.push('Invalid date format (use YYYY-MM-DD)');
        }

        // Validate time format only if provided
        if (row.start_time && row.start_time.trim() !== '' && !isValidTime(row.start_time)) {
            rowErrors.push('Invalid start_time format (use HH:MM:SS)');
        }
        if (row.end_time && row.end_time.trim() !== '' && !isValidTime(row.end_time)) {
            rowErrors.push('Invalid end_time format (use HH:MM:SS)');
        }

        // Validate clock_in_required if provided
        if (row.clock_in_required && !isValidBoolean(row.clock_in_required)) {
            rowErrors.push('Invalid clock_in_required value (use true/false)');
        }

        // Check for existing shifts and handle duplicates (updated for optional times)
async function checkForDuplicates(csvData) {
    const duplicateResults = {
        duplicatesFound: [],
        newShifts: [],
        replacements: []
    };

    for (const row of csvData) {
        if (!row.date || !row.participant_id) {
            duplicateResults.newShifts.push(row);
            continue;
        }

        try {
            // Build query for duplicate check
            let query = supabaseClient
                .from('shifts')
                .select('id, date, start_time, end_time, staff_id, participant_id')
                .eq('date', row.date)
                .eq('participant_id', row.participant_id)
                .is('deleted_at', null);

            // Add staff condition only if staff_id is provided
            if (row.staff_id && row.staff_id.trim() !== '') {
                query = query.eq('staff_id', row.staff_id);
            } else {
                query = query.is('staff_id', null);
            }

            // Add time conditions only if times are provided
            if (row.start_time && row.start_time.trim() !== '') {
                query = query.eq('start_time', row.start_time);
            } else {
                query = query.is('start_time', null);
            }
            
            if (row.end_time && row.end_time.trim() !== '') {
                query = query.eq('end_time', row.end_time);
            } else {
                query = query.is('end_time', null);
            }

            const { data: existingShift, error } = await query.maybeSingle();

            if (error) throw error;

            if (existingShift) {
                duplicateResults.duplicatesFound.push({
                    existingId: existingShift.id,
                    newData: row
                });
            } else {
                duplicateResults.newShifts.push(row);
            }
        } catch (error) {
            console.error('Error checking for duplicate:', error);
            duplicateResults.newShifts.push(row); // Treat as new if check fails
        }
    }

    return duplicateResults;
}

// Replace existing shift with new data
async function replaceShift(shiftId, newData, payOverrideId) {
    try {
        const updateData = {
            duty_type_id: newData.duty_type_id,
            location_id: newData.location_id,
            created_by: newData.created_by,
            status: 'confirmed',
            updated_at: new Date().toISOString()
        };

        // Add staff_id only if provided
        if (newData.staff_id && newData.staff_id.trim() !== '') {
            updateData.staff_id = newData.staff_id;
        }

        // Add pay_override_id only if we have one
        if (payOverrideId) {
            updateData.pay_override_id = payOverrideId;
        }

        // Add optional fields if present
        if (newData.notes) updateData.notes = newData.notes;
        if (newData.clock_in_required) {
            const normalizedValue = newData.clock_in_required.toString().toLowerCase().trim();
            updateData.clock_in_required = ['true', '1', 'yes'].includes(normalizedValue);
        }

        const { error } = await supabaseClient
            .from('shifts')
            .update(updateData)
            .eq('id', shiftId);

        if (error) throw error;
        return { success: true };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

// Insert new shift (updated for optional times)
async function insertShift(shiftData, payOverrideId) {
    try {
        const insertData = {
            date: shiftData.date,
            duty_type_id: shiftData.duty_type_id,
            participant_id: shiftData.participant_id,
            location_id: shiftData.location_id,
            created_by: shiftData.created_by,
            status: 'confirmed',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        // Add staff_id only if provided
        if (shiftData.staff_id && shiftData.staff_id.trim() !== '') {
            insertData.staff_id = shiftData.staff_id;
        }

        // Add pay_override_id only if we have one
        if (payOverrideId) {
            insertData.pay_override_id = payOverrideId;
        }

        // Add times only if provided
        if (shiftData.start_time && shiftData.start_time.trim() !== '') {
            insertData.start_time = shiftData.start_time;
        }
        if (shiftData.end_time && shiftData.end_time.trim() !== '') {
            insertData.end_time = shiftData.end_time;
        }

        // Add optional fields if present
        if (shiftData.notes) insertData.notes = shiftData.notes;
        if (shiftData.clock_in_required) {
            const normalizedValue = shiftData.clock_in_required.toString().toLowerCase().trim();
            insertData.clock_in_required = ['true', '1', 'yes'].includes(normalizedValue);
        }

        const { error } = await supabaseClient
            .from('shifts')
            .insert([insertData]);

        if (error) throw error;
        return { success: true };
    } catch (error) {
        return { success: false, error: error.message };
    }
}
        if (row.staff_id && row.participant_id && row.date && rowErrors.length === 0) {
            const payOverrideResult = await resolvePayOverride(
                row.staff_id, 
                row.participant_id, 
                row.date
            );
            results.payOverrideResolutions.push({
                row: i + 1,
                ...payOverrideResult
            });
            
            if (!payOverrideResult.success) {
                rowErrors.push(payOverrideResult.error);
            }
        }

        if (rowErrors.length > 0) {
            results.invalidRows.push({
                row: i + 1,
                data: row,
                errors: rowErrors
            });
        } else {
            results.validRows.push({
                row: i + 1,
                data: row
            });
        }
    }

    return results;
}

// Resolve pay override from database
// Replace the resolvePayOverride function with this:
async function resolvePayOverride(staffId, participantId, shiftDate) {
    try {
        const { data, error } = await supabaseClient
            .from('staff_participant_assignments')
            .select('pay_rate_id, id')
            .eq('staff_id', staffId)
            .eq('participant_id', participantId)
            .lte('start_date', shiftDate)
            .or(`end_date.is.null,end_date.gte.${shiftDate}`)
            .eq('is_active', true)
            .not('pay_rate_id', 'is', null)
            .limit(1)
            .maybeSingle();

        if (error) throw error;

        if (!data) {
            return {
                staffId,
                participantId,
                shiftDate,
                success: false,
                error: 'No active assignment found for this staff-participant combination'
            };
        }

        return {
            staffId,
            participantId,
            shiftDate,
            success: true,
            payRateId: data.pay_rate_id,
            assignmentId: data.id,
            error: null
        };

    } catch (error) {
        return {
            staffId,
            participantId,
            shiftDate,
            success: false,
            error: `Database error: ${error.message}`
        };
    }
}
function openCSVUploadModal() {
    const modal = document.getElementById('csvUploadModal');
    const container = document.getElementById('csvUploadContainer');
    
    // Show the modal
    modal.style.display = 'flex';
    
    // Load the vanilla JavaScript CSV upload interface
    container.innerHTML = createCSVUploadInterface();
}

function closeCSVUploadModal() {
    const modal = document.getElementById('csvUploadModal');
    modal.style.display = 'none';
    
    // Clean up
    const container = document.getElementById('csvUploadContainer');
    if (container) {
        container.innerHTML = '';
    }
    
    // Reset global variables
    selectedFile = null;
    validationResults = null;
}

async function saveHoliday() {
    try {
        const name = document.getElementById('holidayName').value;
        const date = document.getElementById('holidayDate').value;
        const recurring = document.getElementById('holidayRecurring').checked;
        const state = document.getElementById('holidayState')?.value || 'National';
        
        if (!name || !date) {
            showNotification('Please enter holiday name and date', 'error');
            return;
        }
        
        const { data, error } = await supabaseClient
            .from('public_holidays')
            .insert({
                name: name,
                date: date,
                is_recurring: recurring,
                state: state,
                created_at: new Date().toISOString()
            })
            .select();
        
        if (error) throw error;
        
        showNotification('Holiday saved successfully', 'success');
        
        // Clear form
        document.getElementById('holidayName').value = '';
        document.getElementById('holidayDate').value = '';
        document.getElementById('holidayRecurring').checked = false;
        
        // Reload the holidays display
        await loadPublicHolidays();
        
    } catch (error) {
        console.error('Error saving holiday:', error);
        showNotification('Failed to save holiday: ' + error.message, 'error');
    }
}


function getPayRateAbbreviation(label) {
    if (!label) return 'STD';
    
    // Special cases
    if (label.toLowerCase().includes('sleepover')) return 'SLP';
    if (label.toLowerCase().includes('public holiday')) return 'PH';
    
    // Extract first letter/number after each space
    const words = label.trim().split(/\s+/);
    const abbrev = words.map(word => {
        const match = word.match(/[A-Z0-9]/i);
        return match ? match[0].toUpperCase() : '';
    }).join('');
    
    return abbrev || 'STD';
}

async function initAssignmentManager() {
    const container = document.getElementById('assignmentContent');
    if (!container) {
        console.error('Assignment content container not found');
        return;
    }
    
    // Show loading
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Loading assignments...</span>
        </div>
    `;
    
    await loadAssignmentData();
}

// Load assignment data
async function loadAssignmentData() {
    try {
        const [assignments, staff, participants, payRates] = await Promise.all([
            supabaseClient
                .from('staff_participant_assignments')
                .select('*'),
            
            supabaseClient
                .from('staff')
                .select('*')
                .eq('is_active', true)
                .order('first_name'),
            
            supabaseClient
                .from('participants')
                .select('*')
                .eq('is_active', true)
                .neq('first_name', 'My Carers')
                .order('first_name'),
            
            supabaseClient
                .from('pay_rates')
                .select('*')
                .order('category, level, pay_point')
        ]);
        
        // Create lookup maps
        const staffMap = new Map();
        staff.data?.forEach(s => staffMap.set(s.id, s));
        
        const participantMap = new Map();
        participants.data?.forEach(p => participantMap.set(p.id, p));
        
        const payRateMap = new Map();
        payRates.data?.forEach(pr => {
            const label = `${pr.category} ${pr.level}${pr.pay_point ? ' ' + pr.pay_point : ''}`;
            payRateMap.set(pr.id, {
                ...pr,
                label: label,
                abbreviation: getPayRateAbbreviation(label)
            });
        });
        
        // Store data globally
        window.assignmentData = {
            assignments: assignments.data || [],
            staffMap: staffMap,
            participantMap: participantMap,
            payRateMap: payRateMap,
            staff: staff.data || [],
            participants: participants.data || [],
            payRates: payRates.data || []
        };
        
        // Set default view mode if not set
        if (!window.assignmentViewMode) {
            window.assignmentViewMode = 'participant';
        }
        
        renderAssignments();
        
    } catch (error) {
        console.error('Error loading assignment data:', error);
        const container = document.getElementById('assignmentContent');
        container.innerHTML = `
            <div class="error-message" style="text-align: center; padding: 40px;">
                <p style="color: red;">Failed to load assignments: ${error.message}</p>
                <button class="btn btn-primary" onclick="initAssignmentManager()">Retry</button>
            </div>
        `;
    }
}

// Helper function to generate pay rate abbreviations
function getPayRateAbbreviation(label) {
    if (!label) return 'STD';
    
    // Common patterns
    if (label.includes('SCHADS')) return 'SCH';
    if (label.includes('Social')) return 'SOC';
    if (label.includes('Home Care')) return 'HC';
    if (label.includes('Disability')) return 'DSW';
    
    // Otherwise use first letter of each word
    return label.split(' ')
        .map(word => word[0])
        .join('')
        .substring(0, 3)
        .toUpperCase();
}

function renderAssignments() {
    const assignmentContent = document.getElementById('assignmentContent');
    if (!assignmentContent || !window.assignmentData) return;
    
    const { assignments, staffMap, participantMap, payRateMap, staff, participants } = window.assignmentData;
    
    // Use both dropdown filters AND global filters
    const dropdownStaffFilter = document.getElementById('staffSelect')?.value;
    const dropdownParticipantFilter = document.getElementById('participantSelect')?.value;
    
    // Get global filters from the top bar
    const globalFilters = window.currentFilters || {};
    
    // Prioritize dropdown filters, fall back to global filters
    const staffFilter = dropdownStaffFilter || globalFilters.staffId;
    const participantFilter = dropdownParticipantFilter || globalFilters.participantId;
    
    let filteredAssignments = assignments;
    if (staffFilter && staffFilter !== 'all' && staffFilter !== '') {
        filteredAssignments = filteredAssignments.filter(a => a.staff_id === staffFilter);
    }
    if (participantFilter && participantFilter !== 'all' && participantFilter !== '') {
        filteredAssignments = filteredAssignments.filter(a => a.participant_id === participantFilter);
    }
    
    let html = `
        <style>
            /* Assignment-specific accordion styles with unique selectors */
            .assignment-accordion-content { 
                display: none !important; 
                background: #f8f9fa;
            }
            
            .assignment-accordion-content.active { 
                display: table-row !important;
                animation: slideDown 0.3s ease;
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .assignment-accordion-arrow { 
                display: inline-block; 
                margin-right: 10px; 
                transition: transform 0.3s ease; 
                font-size: 12px;
                color: var(--primary-color);
                font-weight: bold;
                cursor: pointer;
            }
            
            .assignment-accordion-arrow.open { 
                transform: rotate(90deg); 
            }
            
            /* Rest of your existing styles... */
            .timesheet-wrapper {
                background: white;
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            .timesheet-table { 
                width: 100%; 
                border-collapse: separate;
                border-spacing: 0;
                background: white;
            }
            
            .timesheet-table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .timesheet-table th { 
                padding: 16px 12px; 
                text-align: left; 
                font-weight: 600; 
                font-size: 11px; 
                text-transform: uppercase;
                letter-spacing: 1px;
                color: white;
                border: none;
            }
            
            .timesheet-row { 
                cursor: pointer; 
                transition: all 0.2s ease;
                background: white;
                position: relative;
            }
            
            .timesheet-row:hover { 
                background: #f8f9fa;
                transform: translateX(2px);
            }
            
            .timesheet-row td { 
                padding: 16px 12px; 
                border-bottom: 1px solid #e9ecef; 
                font-size: 14px;
                vertical-align: middle;
            }
            
            .staff-name {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 15px;
            }
            
            .pay-rate-badge {
                display: inline-block;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 500;
                letter-spacing: 0.5px;
            }
            
            .shifts-detail-container {
                padding: 24px;
                background: white;
                margin: 16px;
                border-radius: 8px;
                box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            }
            
            .shifts-detail-header {
                margin-bottom: 16px;
                color: var(--text-secondary);
                font-size: 13px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .shifts-detail-table { 
                width: 100%;
                font-size: 13px;
                border-collapse: separate;
                border-spacing: 0;
                overflow: hidden;
                border-radius: 6px;
                border: 1px solid #e9ecef;
            }
            
            .shifts-detail-table th { 
                background: #f8f9fa;
                padding: 10px 12px; 
                text-align: left;
                font-weight: 600;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-secondary);
                border-bottom: 1px solid #e9ecef;
            }
            
            .shifts-detail-table td { 
                padding: 12px; 
                border-bottom: 1px solid #f1f3f4;
                background: white;
            }
            
            .assignment-modal {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                z-index: 9999 !important;
                background: white;
                border-radius: 8px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                max-width: 500px;
                width: 90%;
            }
            
            .modal-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9998;
            }
            
            .assignment-detail-row {
                background: white;
                border-bottom: 1px solid #e9ecef;
                transition: background 0.2s;
            }
            
            .assignment-detail-row:hover {
                background: #f8f9fa;
            }
            
            .assignment-detail-row td {
                padding: 12px 16px !important;
                vertical-align: middle;
            }
            
            .action-btn {
                padding: 6px 12px !important;
                font-size: 13px !important;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }
        </style>
        
        <div class="timesheet-wrapper">
            <table class="timesheet-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">${assignmentViewMode === 'participant' ? 'Participant' : 'Staff Member'}</th>
                        <th style="width: 20%;">Identifier</th>
                        <th style="width: 15%;">Assignments</th>
                        <th style="width: 20%;">Default Rate</th>
                        <th style="width: 15%; text-align: center;">Action</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    let accordionIndex = 0;
    
    if (assignmentViewMode === 'participant') {
        // Participant view
        let displayParticipants = participantFilter && participantFilter !== 'all' && participantFilter !== '' ? 
            participants.filter(p => p.id === participantFilter) : 
            participants;
            
        displayParticipants.forEach(participant => {
            const participantAssignments = filteredAssignments.filter(a => 
                a.participant_id === participant.id
            );
            
            if (staffFilter && staffFilter !== 'all' && staffFilter !== '' && participantAssignments.length === 0) {
                return;
            }
            
            html += `
                <tr class="timesheet-row" onclick="toggleAssignmentAccordion(${accordionIndex})">
                    <td>
                        <span class="assignment-accordion-arrow" id="assignment-arrow-${accordionIndex}">▶</span>
                        <span class="staff-name">${participant.first_name} ${participant.last_name}</span>
                    </td>
                    <td>
                        <span style="color: var(--text-muted);">${participant.ndis_participant_number || 'No NDIS'}</span>
                    </td>
                    <td>
                        <span class="pay-rate-badge">${participantAssignments.length} staff</span>
                    </td>
                    <td>—</td>
                    <td style="text-align: center;">
                        <button class="btn btn-primary btn-sm action-btn" 
                                onclick="event.stopPropagation(); showAddAssignmentModal('participant', '${participant.id}')">
                            <i class="fas fa-plus"></i> Add Staff
                        </button>
                    </td>
                </tr>
                <tr class="assignment-accordion-content" id="assignment-accordion-${accordionIndex}">
                    <td colspan="5" style="padding: 0;">
                        <div class="shifts-detail-container" style="background: #f8f9fa; padding: 20px;">
                            <h4 class="shifts-detail-header" style="margin-bottom: 16px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Assigned Staff Members (${participantAssignments.length})
                            </h4>
                            ${participantAssignments.length > 0 ? `
                                <table class="shifts-detail-table" style="width: 100%; background: white; border-radius: 6px; overflow: hidden;">
                                    <thead style="background: #667eea;">
                                        <tr>
                                            <th style="padding: 10px 16px; text-align: left;">Staff Member</th>
                                            <th style="padding: 10px 16px;">Staff Code</th>
                                            <th style="padding: 10px 16px;">Pay Rate</th>
                                            <th style="padding: 10px 16px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${participantAssignments.map(assignment => {
                                            const staff = staffMap.get(assignment.staff_id);
                                            const payRate = payRateMap.get(assignment.pay_rate_id);
                                            const staffDefaultRate = staff ? payRateMap.get(staff.pay_rate_id) : null;
                                            const isUsingDefault = staff && assignment.pay_rate_id === staff.pay_rate_id;
                                            
                                            return `
                                                <tr class="assignment-detail-row">
                                                    <td><strong>${staff?.first_name || 'Unknown'} ${staff?.last_name || ''}</strong></td>
                                                    <td><span class="text-muted">${staff?.staff_code || '—'}</span></td>
                                                    <td>
                                                        <span class="participant-badge">${payRate?.abbreviation || 'STD'}</span>
                                                        <span class="text-muted" style="margin-left: 8px; font-size: 12px;">
                                                            ${payRate?.label || 'Standard'}${isUsingDefault ? ' (Staff Default)' : ''}
                                                        </span>
                                                    </td>
                                                    <td style="text-align: center;">
                                                        <button class="btn btn-secondary btn-sm action-btn" 
                                                                onclick="event.stopPropagation(); showEditAssignmentModal('${assignment.staff_id}', '${assignment.participant_id}')">
                                                            <i class="fas fa-edit"></i> Edit Rate
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            ` : `
                                <div style="padding: 40px; text-align: center; background: white; border-radius: 6px; color: var(--text-muted);">
                                    <i class="fas fa-user-slash" style="font-size: 32px; margin-bottom: 16px; opacity: 0.3;"></i>
                                    <p>No staff members assigned to this participant</p>
                                    <button class="btn btn-primary" onclick="event.stopPropagation(); showAddAssignmentModal('participant', '${participant.id}')">
                                        <i class="fas fa-plus"></i> Assign First Staff Member
                                    </button>
                                </div>
                            `}
                        </div>
                    </td>
                </tr>
            `;
            accordionIndex++;
        });
        
    } else {
        // Staff view - same changes with unique IDs
        let displayStaff = staffFilter && staffFilter !== 'all' && staffFilter !== '' ? 
            staff.filter(s => s.id === staffFilter) : 
            staff;
            
        displayStaff.forEach(staffMember => {
            const staffAssignments = filteredAssignments.filter(a => 
                a.staff_id === staffMember.id
            );
            
            if (participantFilter && participantFilter !== 'all' && participantFilter !== '' && staffAssignments.length === 0) {
                return;
            }
            
            const defaultPayRate = payRateMap.get(staffMember.pay_rate_id);
            
            html += `
                <tr class="timesheet-row" onclick="toggleAssignmentAccordion(${accordionIndex})">
                    <td>
                        <span class="assignment-accordion-arrow" id="assignment-arrow-${accordionIndex}">▶</span>
                        <span class="staff-name">${staffMember.first_name} ${staffMember.last_name}</span>
                    </td>
                    <td>
                        <span style="color: var(--text-muted);">${staffMember.staff_code || 'No Code'}</span>
                    </td>
                    <td>
                        <span class="pay-rate-badge">${staffAssignments.length} participants</span>
                    </td>
                    <td>
                        ${staffMember.pay_rate_id && defaultPayRate ? `
                            <span class="participant-badge">${defaultPayRate.abbreviation}</span>
                            <span style="margin-left: 8px; color: var(--text-muted); font-size: 12px;">
                                ${defaultPayRate.label} (Default)
                            </span>
                        ` : '<span style="color: var(--text-muted);">No default rate set</span>'}
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-primary btn-sm action-btn" 
                                onclick="event.stopPropagation(); showAddAssignmentModal('staff', '${staffMember.id}')">
                            <i class="fas fa-plus"></i> Add Client
                        </button>
                    </td>
                </tr>
                <tr class="assignment-accordion-content" id="assignment-accordion-${accordionIndex}">
                    <td colspan="5" style="padding: 0;">
                        <div class="shifts-detail-container" style="background: #f8f9fa; padding: 20px;">
                            <h4 class="shifts-detail-header" style="margin-bottom: 16px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Assigned Participants (${staffAssignments.length})
                            </h4>
                            ${staffAssignments.length > 0 ? `
                                <table class="shifts-detail-table" style="width: 100%; background: white; border-radius: 6px; overflow: hidden;">
                                    <thead style="background: #667eea;">
                                        <tr>
                                            <th style="padding: 10px 16px; text-align: left;">Participant</th>
                                            <th style="padding: 10px 16px;">NDIS Number</th>
                                            <th style="padding: 10px 16px;">Pay Rate</th>
                                            <th style="padding: 10px 16px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${staffAssignments.map(assignment => {
                                            const participant = participantMap.get(assignment.participant_id);
                                            const payRate = payRateMap.get(assignment.pay_rate_id);
                                            const isUsingDefault = assignment.pay_rate_id === staffMember.pay_rate_id;
                                            
                                            return `
                                                <tr class="assignment-detail-row">
                                                    <td><strong>${participant?.first_name || 'Unknown'} ${participant?.last_name || ''}</strong></td>
                                                    <td><span class="text-muted">${participant?.ndis_participant_number || '—'}</span></td>
                                                    <td>
                                                        <span class="participant-badge">${payRate?.abbreviation || 'STD'}</span>
                                                        <span class="text-muted" style="margin-left: 8px; font-size: 12px;">
                                                            ${payRate?.label || 'Standard'}${isUsingDefault ? ' (Staff Default)' : ''}
                                                        </span>
                                                    </td>
                                                    <td style="text-align: center;">
                                                        <button class="btn btn-secondary btn-sm action-btn" 
                                                                onclick="event.stopPropagation(); showEditAssignmentModal('${assignment.staff_id}', '${assignment.participant_id}')">
                                                            <i class="fas fa-edit"></i> Edit Rate
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            ` : `
                                <div style="padding: 40px; text-align: center; background: white; border-radius: 6px; color: var(--text-muted);">
                                    <i class="fas fa-users-slash" style="font-size: 32px; margin-bottom: 16px; opacity: 0.3;"></i>
                                    <p>No participants assigned to this staff member</p>
                                    <button class="btn btn-primary" onclick="event.stopPropagation(); showAddAssignmentModal('staff', '${staffMember.id}')">
                                        <i class="fas fa-plus"></i> Assign First Participant
                                    </button>
                                </div>
                            `}
                        </div>
                    </td>
                </tr>
            `;
            accordionIndex++;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    assignmentContent.innerHTML = html;
}

window.toggleAssignmentAccordion = function(index) {
    const content = document.getElementById(`assignment-accordion-${index}`);
    const arrow = document.getElementById(`assignment-arrow-${index}`);
    
    if (content && arrow) {
        content.classList.toggle('active');
        arrow.classList.toggle('open');
    }
};

function switchAssignmentView(mode) {
    assignmentViewMode = mode;
    renderAssignments();
}

async function showEditAssignmentModal(staffId, participantId) {
    try {
        const assignment = window.assignmentData.assignments.find(a => 
            a.staff_id === staffId && a.participant_id === participantId
        );
        
        const staff = window.assignmentData.staffMap.get(staffId);
        const participant = window.assignmentData.participantMap.get(participantId);
        const currentPayRate = window.assignmentData.payRateMap.get(assignment.pay_rate_id);
        
        // Get the staff's default pay rate
        const staffDefaultPayRate = staff?.pay_rate_id ? 
            window.assignmentData.payRateMap.get(staff.pay_rate_id) : null;
        
        // Add backdrop and modal with proper positioning
        const modalHtml = `
            <div class="modal-backdrop" id="editAssignmentBackdrop" onclick="closeModal('editAssignmentModal')" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9998;
            "></div>
            <div class="modal" id="editAssignmentModal" style="
                display: block;
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                z-index: 9999 !important;
                max-width: 500px;
                width: 90%;
            ">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5>Edit Assignment</h5>
                            <button class="close" onclick="closeModal('editAssignmentModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="assignment-info" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <div><strong>Staff:</strong> ${staff?.first_name} ${staff?.last_name}</div>
                                <div><strong>Participant:</strong> ${participant?.first_name} ${participant?.last_name}</div>
                                <div>
                                    <strong>Current Rate:</strong> 
                                    <span class="participant-badge">${currentPayRate?.abbreviation}</span>
                                    ${currentPayRate?.label} - $${currentPayRate?.hourly_pay_rate?.toFixed(2)}/hr
                                </div>
                                <div style="margin-top: 8px; color: #6c757d; font-size: 13px;">
                                    <strong>Staff Default:</strong> 
                                    ${staffDefaultPayRate ? `
                                        <span class="participant-badge" style="font-size: 10px;">${staffDefaultPayRate.abbreviation}</span>
                                        ${staffDefaultPayRate.label} (Default)
                                    ` : 'No default rate set'}
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Change Pay Rate</label>
                                <select id="editPayRate" class="form-control">
                                    ${window.assignmentData.payRates.map(rate => {
                                        const label = `${rate.category} ${rate.level}${rate.pay_point ? ' ' + rate.pay_point : ''} - $${rate.hourly_pay_rate.toFixed(2)}/hr`;
                                        const selected = rate.id === assignment.pay_rate_id ? 'selected' : '';
                                        const isStaffDefault = staff?.pay_rate_id === rate.id;
                                        const displayLabel = isStaffDefault ? `${label} (Staff Default)` : label;
                                        return `<option value="${rate.id}" ${selected}>${displayLabel}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="removeAssignment('${staffId}', '${participantId}')">
                                <i class="fas fa-trash"></i> Remove Assignment
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal('editAssignmentModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="updateAssignment('${staffId}', '${participantId}')">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal and backdrop if present
        const existingModal = document.getElementById('editAssignmentModal');
        const existingBackdrop = document.getElementById('editAssignmentBackdrop');
        if (existingModal) existingModal.remove();
        if (existingBackdrop) existingBackdrop.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Error showing edit modal:', error);
        showNotification('Failed to open edit dialog', 'error');
    }
}
// Show add assignment modal
async function showAddAssignmentModal(type, id) {
    const isParticipantView = type === 'participant';
    const fixedPerson = isParticipantView ? 
        window.assignmentData.participantMap.get(id) : 
        window.assignmentData.staffMap.get(id);
    
    // Add backdrop and modal with proper positioning
    const modalHtml = `
        <div class="modal-backdrop" id="addAssignmentBackdrop" onclick="closeModal('addAssignmentModal')" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        "></div>
        <div class="modal" id="addAssignmentModal" style="
            display: block;
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 9999 !important;
            max-width: 500px;
            width: 90%;
        ">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5>Add Assignment</h5>
                        <button class="close" onclick="closeModal('addAssignmentModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <strong>${isParticipantView ? 'Participant' : 'Staff'}:</strong> 
                            ${fixedPerson.first_name} ${fixedPerson.last_name}
                        </div>
                        
                        <div class="form-group">
                            <label>${isParticipantView ? 'Select Staff Member' : 'Select Participant'} *</label>
                            <select id="addAssignmentPerson" class="form-control" required>
                                <option value="">Choose...</option>
                                ${isParticipantView ? 
                                    window.assignmentData.staff.map(s => 
                                        `<option value="${s.id}">${s.first_name} ${s.last_name} (${s.staff_code || 'N/A'})</option>`
                                    ).join('') :
                                    window.assignmentData.participants.map(p => 
                                    `<option value="${p.id}">${p.first_name} ${p.last_name} (${p.ndis_participant_number || 'N/A'})</option>`
                                    ).join('')
                                }
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Pay Rate *</label>
                            <select id="addAssignmentPayRate" class="form-control" required>
                                <option value="">Select Pay Rate...</option>
                                ${window.assignmentData.payRates.map(rate => {
                                    const label = `${rate.category} ${rate.level}${rate.pay_point ? ' ' + rate.pay_point : ''} - $${rate.hourly_pay_rate.toFixed(2)}/hr`;
                                    return `<option value="${rate.id}">${label}</option>`;
                                }).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal('addAssignmentModal')">Cancel</button>
                        <button class="btn btn-primary" onclick="saveNewAssignment('${type}', '${id}')">
                            Create Assignment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal and backdrop if present
    const existingModal = document.getElementById('addAssignmentModal');
    const existingBackdrop = document.getElementById('addAssignmentBackdrop');
    if (existingModal) existingModal.remove();
    if (existingBackdrop) existingBackdrop.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}
// Save new assignment
async function saveNewAssignment(type, fixedId) {
    try {
        const personId = document.getElementById('addAssignmentPerson').value;
        const payRateId = document.getElementById('addAssignmentPayRate').value;
        
        if (!personId || !payRateId) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }
        
        const assignmentData = {
            staff_id: type === 'participant' ? personId : fixedId,
            participant_id: type === 'participant' ? fixedId : personId,
            pay_rate_id: payRateId,
            created_at: new Date().toISOString()
        };
        
        const { error } = await supabaseClient
            .from('staff_participant_assignments')
            .insert(assignmentData);
        
        if (error) throw error;
        
        showNotification('Assignment created successfully', 'success');
        closeModal('addAssignmentModal');
        await initAssignmentManager();
        
    } catch (error) {
        console.error('Error creating assignment:', error);
        if (error.message?.includes('duplicate')) {
            showNotification('This assignment already exists', 'error');
        } else {
            showNotification('Failed to create assignment', 'error');
        }
    }
}

// Update assignment
async function updateAssignment(staffId, participantId) {
    try {
        const payRateId = document.getElementById('editPayRate').value;
        
        const { error } = await supabaseClient
            .from('staff_participant_assignments')
            .update({
                pay_rate_id: payRateId,
                updated_at: new Date().toISOString()
            })
            .eq('staff_id', staffId)
            .eq('participant_id', participantId);
        
        if (error) throw error;
        
        showNotification('Assignment updated successfully', 'success');
        closeModal('editAssignmentModal');
        await initAssignmentManager();
        
    } catch (error) {
        console.error('Error updating assignment:', error);
        showNotification('Failed to update assignment', 'error');
    }
}

// Remove assignment
async function removeAssignment(staffId, participantId) {
    if (!confirm('Are you sure you want to remove this assignment? This action cannot be undone.')) {
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('staff_participant_assignments')
            .delete()
            .eq('staff_id', staffId)
            .eq('participant_id', participantId);
        
        if (error) throw error;
        
        showNotification('Assignment removed successfully', 'success');
        closeModal('editAssignmentModal');
        await initAssignmentManager();
        
    } catch (error) {
        console.error('Error removing assignment:', error);
        showNotification('Failed to remove assignment', 'error');
    }
}

// Helper function to format dates
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-AU', { 
        day: '2-digit', 
        month: 'short', 
        year: 'numeric' 
    });
}

async function displayShiftsWithAssignments(weekStart, weekEnd) {
    try {
        // Load shifts with all related data including assignments
        const { data: shifts, error } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                staff:staff_id(
                    id, 
                    first_name, 
                    last_name, 
                    pay_rate_id
                ),
                participant:participant_id(
                    id, 
                    first_name, 
                    last_name
                ),
                location:location_id(name),
                duty_type:duty_type_id(name)
            `)
            .gte('date', weekStart)
            .lte('date', weekEnd)
            .eq('status', 'approved')
            .order('date, start_time');
        
        if (error) throw error;
        
        // Load all assignments for these staff/participant pairs
        const staffIds = [...new Set(shifts.map(s => s.staff_id).filter(Boolean))];
        const participantIds = [...new Set(shifts.map(s => s.participant_id).filter(Boolean))];
        
        const { data: assignments } = await supabaseClient
            .from('staff_participant_assignments')
            .select(`
                *,
                pay_rate:pay_rate_id(
                    id,
                    category,
                    level,
                    pay_point,
                    hourly_pay_rate,
                    saturday,
                    sunday,
                    public_holiday,
                    sleepover
                )
            `)
            .in('staff_id', staffIds)
            .in('participant_id', participantIds);
        
        // Load pay rates for staff defaults
        const { data: payRates } = await supabaseClient
            .from('pay_rates')
            .select('*');
        
        // Create lookup maps
        const assignmentMap = new Map();
        assignments?.forEach(a => {
            const key = `${a.staff_id}-${a.participant_id}`;
            assignmentMap.set(key, a);
        });
        
        const payRateMap = new Map();
        payRates?.forEach(pr => {
            const label = `${pr.category} ${pr.level}${pr.pay_point ? ' ' + pr.pay_point : ''}`;
            payRateMap.set(pr.id, {
                ...pr,
                label: label,
                abbreviation: getPayRateAbbreviation(label)
            });
        });
        
        // Build shift display with pay rate badges
        let html = '<div class="shifts-with-rates">';
        
        const shiftsByDate = {};
        shifts.forEach(shift => {
            if (!shiftsByDate[shift.date]) {
                shiftsByDate[shift.date] = [];
            }
            
            // Determine which pay rate applies
            const assignmentKey = `${shift.staff_id}-${shift.participant_id}`;
            const assignment = assignmentMap.get(assignmentKey);
            
            let payRate = null;
            let rateSource = 'default';
            let rateLabel = '';
            let rateAbbrev = '';
            
            if (shift.pay_override_id) {
                // Manual override takes precedence
                payRate = payRateMap.get(shift.pay_override_id);
                rateSource = 'override';
                rateLabel = payRate?.label || 'Override';
                rateAbbrev = payRate?.abbreviation || 'OVR';
            } else if (assignment?.pay_rate_id) {
                // Assignment rate
                payRate = payRateMap.get(assignment.pay_rate_id);
                rateSource = 'assignment';
                rateLabel = payRate?.label || 'Assigned';
                rateAbbrev = payRate?.abbreviation || 'ASG';
            } else if (shift.staff?.pay_rate_id) {
                // Staff default rate
                payRate = payRateMap.get(shift.staff.pay_rate_id);
                rateSource = 'default';
                rateLabel = payRate?.label || 'Default';
                rateAbbrev = payRate?.abbreviation || 'DFT';
            }
            
            // Check for special rates (public holiday, sleepover)
            const isPublicHoliday = false; // TODO: Check against public_holidays table
            const isSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover');
            
            if (isPublicHoliday) {
                rateAbbrev = 'PH';
                rateSource = 'public_holiday';
            } else if (isSleepover) {
                rateAbbrev = 'SLP';
                rateSource = 'sleepover';
            }
            
            shiftsByDate[shift.date].push({
                ...shift,
                payRate,
                rateSource,
                rateLabel,
                rateAbbrev
            });
        });
        
        // Display shifts grouped by date
        Object.keys(shiftsByDate).sort().forEach(date => {
            const dayShifts = shiftsByDate[date];
            const dateObj = new Date(date + 'T00:00:00');
            const dayName = dateObj.toLocaleDateString('en-AU', { weekday: 'long' });
            const dateStr = dateObj.toLocaleDateString('en-AU', { 
                day: 'numeric', 
                month: 'short' 
            });
            
            html += `
                <div class="shift-day">
                    <div class="shift-day-header">
                        <h4>${dayName}, ${dateStr}</h4>
                        <span class="shift-count">${dayShifts.length} shifts</span>
                    </div>
                    <div class="shift-day-content">
            `;
            
            dayShifts.forEach(shift => {
                const startTime = shift.start_time ? 
                    formatTime12Hour(shift.start_time) : 'Sleepover';
                const endTime = shift.end_time ? 
                    formatTime12Hour(shift.end_time) : '';
                
                // Determine badge color based on rate source
                let badgeClass = 'participant-badge';
                if (shift.rateSource === 'override') {
                    badgeClass += ' badge-override';
                } else if (shift.rateSource === 'assignment') {
                    badgeClass += ' badge-assignment';
                } else if (shift.rateSource === 'public_holiday') {
                    badgeClass += ' badge-holiday';
                } else if (shift.rateSource === 'sleepover') {
                    badgeClass += ' badge-sleepover';
                } else {
                    badgeClass += ' badge-default';
                }
                
                html += `
                    <div class="shift-card" data-shift-id="${shift.id}">
                        <div class="shift-header">
                            <div class="shift-time-block">
                                <span class="shift-time">${startTime}</span>
                                ${endTime ? `<span class="shift-time-separator">-</span>
                                <span class="shift-time">${endTime}</span>` : ''}
                            </div>
                            <div class="shift-badges">
                                <span class="${badgeClass}" 
                                      title="${shift.rateLabel} - $${shift.payRate?.hourly_pay_rate?.toFixed(2) || '0.00'}/hr">
                                    ${shift.rateAbbrev}
                                </span>
                                ${shift.adjustment_status === 'requested' ? 
                                    '<span class="badge badge-warning">ADJ</span>' : ''}
                                ${shift.transfer_status === 'requested' ? 
                                    '<span class="badge badge-info">TRF</span>' : ''}
                            </div>
                        </div>
                        <div class="shift-body">
                            <div class="shift-staff">
                                <i class="fas fa-user"></i>
                                ${shift.staff?.first_name || 'Unassigned'} ${shift.staff?.last_name || ''}
                            </div>
                            <div class="shift-participant">
                                <i class="fas fa-user-friends"></i>
                                ${shift.participant?.first_name || ''} ${shift.participant?.last_name || ''}
                            </div>
                            <div class="shift-location">
                                <i class="fas fa-location-dot"></i>
                                ${shift.location?.name || 'Client Home'}
                            </div>
                        </div>
                        <div class="shift-actions">
                            <button class="btn btn-sm btn-secondary" 
                                    onclick="editShiftRate(${shift.id})">
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" 
                                    onclick="viewShiftDetails(${shift.id})">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        // Add summary section
        html += generateRateSummary(shifts, assignmentMap, payRateMap);
        
        return html;
        
    } catch (error) {
        console.error('Error displaying shifts with assignments:', error);
        return '<div class="alert alert-danger">Failed to load shifts</div>';
    }
}


// Generate summary of rates being used
function generateRateSummary(shifts, assignmentMap, payRateMap) {
    const rateSummary = new Map();
    
    shifts.forEach(shift => {
        const assignmentKey = `${shift.staff_id}-${shift.participant_id}`;
        const assignment = assignmentMap.get(assignmentKey);
        
        let rateId = shift.pay_override_id || 
                    assignment?.pay_rate_id || 
                    shift.staff?.pay_rate_id;
        
        if (rateId) {
            const rate = payRateMap.get(rateId);
            if (rate) {
                if (!rateSummary.has(rateId)) {
                    rateSummary.set(rateId, {
                        rate: rate,
                        count: 0,
                        hours: 0
                    });
                }
                
                const summary = rateSummary.get(rateId);
                summary.count++;
                
                // Calculate hours
                if (shift.start_time && shift.end_time) {
                    const start = new Date(`2000-01-01T${shift.start_time}`);
                    const end = new Date(`2000-01-01T${shift.end_time}`);
                    let hours = (end - start) / (1000 * 60 * 60);
                    if (hours < 0) hours += 24; // Handle overnight shifts
                    summary.hours += hours;
                }
            }
        }
    });
    
    let html = `
        <div class="rate-summary">
            <h4>Pay Rate Summary</h4>
            <div class="rate-summary-grid">
    `;
    
    rateSummary.forEach((summary, rateId) => {
        html += `
            <div class="rate-summary-item">
                <div class="rate-summary-header">
                    <span class="participant-badge">${summary.rate.abbreviation}</span>
                    <span class="rate-label">${summary.rate.label}</span>
                </div>
                <div class="rate-summary-details">
                    <div>Shifts: ${summary.count}</div>
                    <div>Hours: ${summary.hours.toFixed(1)}</div>
                    <div>Rate: $${summary.rate.hourly_pay_rate.toFixed(2)}/hr</div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

async function editShiftRate(shiftId) {
    try {
        // Get shift details
        const { data: shift } = await supabaseClient
            .from('shifts')
            .select(`
                *,
                staff:staff_id(first_name, last_name, pay_rate_id),
                participant:participant_id(first_name, last_name)
            `)
            .eq('id', shiftId)
            .single();
        
        // Get assignment if exists
        const { data: assignment } = await supabaseClient
            .from('staff_participant_assignments')
            .select('*, pay_rate:pay_rate_id(*)')
            .eq('staff_id', shift.staff_id)
            .eq('participant_id', shift.participant_id)
            .single();
        
        // Get all pay rates
        const { data: payRates } = await supabaseClient
            .from('pay_rates')
            .select('*')
            .order('category, level, pay_point');
        
        const modal = `
            <div class="modal" id="editShiftRateModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5>Edit Shift Pay Rate</h5>
                            <button class="close" onclick="closeModal('editShiftRateModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <strong>Shift:</strong> ${formatDate(shift.date)}<br>
                                <strong>Staff:</strong> ${shift.staff.first_name} ${shift.staff.last_name}<br>
                                <strong>Participant:</strong> ${shift.participant.first_name} ${shift.participant.last_name}
                            </div>
                            
                            <div class="form-group">
                                <label>Pay Rate Selection</label>
                                <select id="shiftPayOverride" class="form-control">
                                    <option value="">Use Assignment Rate (${assignment ? 
                                        assignment.pay_rate.category + ' ' + assignment.pay_rate.level : 
                                        'Use Staff Default'})</option>
                                    ${payRates.map(rate => {
                                        const label = `${rate.category} ${rate.level}${rate.pay_point ? ' ' + rate.pay_point : ''} - $${rate.hourly_pay_rate.toFixed(2)}/hr`;
                                        const selected = shift.pay_override_id === rate.id ? 'selected' : '';
                                        return `<option value="${rate.id}" ${selected}>${label}</option>`;
                                    }).join('')}
                                </select>
                                <small class="form-text text-muted">
                                    Override only for this specific shift
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('editShiftRateModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="updateShiftRate(${shiftId})">Update Rate</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
        document.getElementById('editShiftRateModal').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading shift:', error);
        showNotification('Failed to load shift details', 'error');
    }
}

// Update shift rate
async function updateShiftRate(shiftId) {
    try {
        const payOverrideId = document.getElementById('shiftPayOverride').value;
        
        const { error } = await supabaseClient
            .from('shifts')
            .update({
                pay_override_id: payOverrideId || null,
                updated_at: new Date().toISOString()
            })
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showNotification('Shift rate updated successfully', 'success');
        closeModal('editShiftRateModal');
        
        // Refresh display
        await loadCurrentView();
        
    } catch (error) {
        console.error('Error updating shift rate:', error);
        showNotification('Failed to update shift rate', 'error');
    }
}

async function enrichRequestData(requests, type) {
    if (!requests || requests.length === 0) return [];
    
    return await Promise.all(requests.map(async req => {
        const shift = shifts.find(s => s.id === req.shift_id);
        const participant = shift ? participants.find(p => p.id === shift.participant_id) : null;
        const location = shift ? locations.find(l => l.id === shift.location_id) : null;
        
        const baseEnrichment = {
            ...req,
            shift: shift ? {
                ...shift,
                participant,
                location,
                participantName: participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    (location?.name || 'Unassigned')
            } : null
        };
        
        if (type === 'transfer') {
            return {
                ...baseEnrichment,
                fromStaff: staff.find(s => s.id === req.from_staff_id),
                toStaff: req.to_staff_id ? staff.find(s => s.id === req.to_staff_id) : null
            };
        } else if (type === 'adjustment') {
            return {
                ...baseEnrichment,
                staff: staff.find(s => s.id === req.staff_id)
            };
        }
        
        return baseEnrichment;
    }));
}

async function requestTransfer(shiftId) {
    const { data, error } = await supabaseClient
        .from('transfer_requests')
        .insert({
            shift_id: parseInt(shiftId), // CRITICAL: Convert to INTEGER
            from_staff_id: currentStaff.id,
            to_staff_id: null,
            status: 'pending',
            reason: 'Personal reason',
            created_at: new Date().toISOString() // Add required field
        });
    
    if (error) {
        console.error('Transfer request error:', error);
        if (error.code === DB_ERRORS.FOREIGN_KEY_VIOLATION) {
            showToast('Invalid shift reference', 'error');
        } else {
            showToast('Failed to request transfer', 'error');
        }
    } else {
        showToast('Transfer request submitted', 'success');
    }
}

async function refreshAfterChange() {
    await loadShifts(); // Reload base data
    
    // Refresh the current active view
    if (currentView === 'conflicts') {
        await renderConflicts();
    } else if (currentView === 'requests') {
        await renderRequests();
    } else if (currentView === 'timesheet') {
        await renderTimesheet();
    } else if (currentView === 'notes') {
        await renderNotes();
    } else if (currentView === 'summary') {
        await renderclockinlogs();
    } else if (currentView === 'table') {
        renderTable();
    } else {
        renderCurrentView();
    }
}

async function renderRequests() {
    const requestsContent = document.getElementById('requestsView');
if (!requestsContent) return;
    
    try {
        // Show loading state
        requestsContent.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading requests...</span>
            </div>
        `;
        
        const isManager = currentUserRole === 'admin' || currentUserRole === 'manager';
        
        // Build the filter UI and container
        let html = `
            <style>
                /* Filter Container Styles */
                .requests-filter-container {
                    display: flex;
                    gap: 20px;
                    align-items: center;
                    padding: 20px;
                    background: white;
                    border-radius: 10px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    margin-bottom: 20px;
                    flex-wrap: wrap;
                }
                
                .filter-group {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .filter-label {
                    font-weight: 600;
                    color: #333;
                    font-size: 14px;
                }
                
                .filter-select {
                    padding: 8px 12px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    background: white;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    min-width: 150px;
                }
                
                .filter-select:hover {
                    border-color: #667eea;
                }
                
                .filter-select:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                }
                
                .status-tabs {
                    display: flex;
                    gap: 5px;
                    background: #f5f5f5;
                    padding: 4px;
                    border-radius: 8px;
                }
                
                .status-tab {
                    padding: 8px 16px;
                    border: none;
                    background: transparent;
                    color: #666;
                    font-weight: 500;
                    cursor: pointer;
                    border-radius: 6px;
                    transition: all 0.3s ease;
                    font-size: 14px;
                }
                
                .status-tab:hover {
                    background: white;
                    color: #333;
                }
                
                .status-tab.active {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
                }
                
                /* Summary Stats */
                .requests-summary {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 15px;
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 10px;
                    margin-bottom: 20px;
                }
                
                .summary-item {
                    text-align: center;
                    padding: 15px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                
                .summary-label {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 5px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .summary-value {
                    font-size: 24px;
                    font-weight: bold;
                    color: #333;
                }
                
                /* Loading spinner for buttons */
                .btn-loading {
                    position: relative;
                    color: transparent !important;
                    pointer-events: none;
                }
                
                .btn-loading::after {
                    content: '';
                    position: absolute;
                    width: 16px;
                    height: 16px;
                    top: 50%;
                    left: 50%;
                    margin-left: -8px;
                    margin-top: -8px;
                    border: 2px solid #ffffff;
                    border-radius: 50%;
                    border-top-color: transparent;
                    animation: spinner 0.6s linear infinite;
                }
                
                @keyframes spinner {
                    to { transform: rotate(360deg); }
                }
                
                /* Table Styles */
                .request-table {
                    width: 100%;
                    background: white;
                    border-radius: 10px;
                    overflow: hidden;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                
                .request-table thead {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                }
                
                .request-table th {
                    padding: 15px;
                    text-align: left;
                    color: white;
                    font-weight: 600;
                    font-size: 12px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .request-table td {
                    padding: 15px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .request-table tbody tr:hover {
                    background: #f8f9fa;
                }
                
                .request-table tbody tr:last-child td {
                    border-bottom: none;
                }
                
                /* Badge Styles */
                .badge {
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 11px;
                    font-weight: 600;
                    text-transform: uppercase;
                }
                
                .badge-pending {
                    background: #fff3cd;
                    color: #856404;
                }
                
                .badge-approved {
                    background: #d4edda;
                    color: #155724;
                }
                
                .badge-rejected, .badge-denied {
                    background: #f8d7da;
                    color: #721c24;
                }
                
                /* Action Buttons */
                .action-buttons {
                    display: flex;
                    gap: 5px;
                    justify-content: center;
                }
                
                .btn-sm {
                    padding: 6px 10px;
                    font-size: 12px;
                    border-radius: 4px;
                    border: none;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 5px;
                }
                
                .btn-success {
                    background: #28a745;
                    color: white;
                }
                
                .btn-success:hover {
                    background: #218838;
                }
                
                .btn-danger {
                    background: #dc3545;
                    color: white;
                }
                
                .btn-danger:hover {
                    background: #c82333;
                }
                
            
            </style>
            
            <!-- Filter Controls -->
            <div class="requests-filter-container">
    <div class="filter-group">
        <span class="filter-label">Request Type:</span>
        <select class="filter-select" id="requestTypeFilter" onchange="changeRequestType(this.value)">
            <option value="transport_claims">Transport Claims</option>
            <option value="school_holidays">School Holidays</option>
            <option value="leave_requests">Leave Requests</option>
            <option value="shifts">Shift Approvals</option>
            <option value="shift_adjustments">Shift Adjustments</option>
        </select>
    </div>
    
    <div class="filter-group">
        <span class="filter-label">Status:</span>
        <div class="status-tabs">
            <button class="status-tab ${currentRequestStatus === 'pending' ? 'active' : ''}" 
                    onclick="changeRequestStatus('pending')">
                Pending
            </button>
            <button class="status-tab ${currentRequestStatus === 'approved' ? 'active' : ''}" 
                    onclick="changeRequestStatus('approved')">
                Approved
            </button>
            <button class="status-tab ${currentRequestStatus === 'all' ? 'active' : ''}" 
                    onclick="changeRequestStatus('all')">
                All
            </button>
        </div>
    </div>
    
    <div class="filter-group" style="margin-left: auto;">
        <span class="filter-label">View By:</span>
        <button class="btn-sm" 
                onclick="switchRequestView('staff')"
                style="margin-right: 8px; padding: 8px 16px; border-radius: 6px; background: ${requestViewMode === 'staff' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#6c757d'}; color: white; border: none; cursor: pointer;">
            <i class="fas fa-user-tie"></i> Staff
        </button>
        <button class="btn-sm" 
                onclick="switchRequestView('participant')"
                style="padding: 8px 16px; border-radius: 6px; background: ${requestViewMode === 'participant' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#6c757d'}; color: white; border: none; cursor: pointer;">
            <i class="fas fa-users"></i> Participant
        </button>
    </div>
</div>
            
            <!-- Dynamic Content Area -->
            <div id="requestsTableContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading data...</span>
                </div>
            </div>
        `;
        
        requestsContent.innerHTML = html;
        
        // Load the appropriate data based on current filters
        await loadRequestData();
        
    } catch (error) {
        console.error('Error rendering requests:', error);
        requestsContent.innerHTML = `
            <div class="alert alert-danger">
                Failed to load requests: ${error.message}
            </div>
        `;
    }
}

// Switch between staff and participant view
function switchRequestView(mode) {
    requestViewMode = mode;
    loadRequestData(); // Reload with new view
}
// Load data based on current filters
async function loadRequestData() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Loading ${currentRequestType.replace('_', ' ')}...</span>
        </div>
    `;
    
    try {
        switch(currentRequestType) {
            case 'transport_claims':
                await loadTransportClaims();
                break;
            case 'school_holidays':
                await loadSchoolHolidays();
                break;
            case 'leave_requests':
                await loadLeaveRequests();
                break;
            case 'shifts':
                await loadShiftApprovals();
                break;
            case 'shift_adjustments':
                await loadShiftAdjustments();
                break;
            default:
                container.innerHTML = '<p>Please select a request type</p>';
        }
    } catch (error) {
        console.error('Error loading request data:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                Failed to load ${currentRequestType.replace('_', ' ')}: ${error.message}
            </div>
        `;
    }
}

// Filter change handlers
function changeRequestType(type) {
    currentRequestType = type;
    loadRequestData();
}

function changeRequestStatus(status) {
    currentRequestStatus = status;
    // Update active tab
    document.querySelectorAll('.status-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.trim().toLowerCase() === status) {
            tab.classList.add('active');
        }
    });
    loadRequestData();
}

async function loadTransportClaims() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        let query = supabaseClient
            .from('transport_claims')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                ),
                shift:shift_id(
                    date,
                    participant_id,
                    participants(first_name, last_name)
                )
            `)
            .order('date', { ascending: false });
        
        if (currentRequestStatus !== 'all') {
            query = query.eq('status', currentRequestStatus);
        }
        
        const { data: claims, error } = await query;
        if (error) throw error;
        
        const stats = {
            total: claims.length,
            pending: claims.filter(c => c.status === 'pending').length,
            approved: claims.filter(c => c.status === 'approved').length,
            rejected: claims.filter(c => c.status === 'rejected').length,
            totalAmount: claims.reduce((sum, c) => sum + (c.total_claim || 0), 0),
            totalKm: claims.reduce((sum, c) => sum + (c.kilometres || 0), 0)
        };
        
        let html = `
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Pending</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.pending}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Approved</div>
                    <div class="summary-value" style="color: #28a745;">${stats.approved}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Amount</div>
                    <div class="summary-value" style="color: #4CAF50;">$${stats.totalAmount.toFixed(2)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total KM</div>
                    <div class="summary-value">${stats.totalKm.toFixed(0)} km</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            // GROUP BY PARTICIPANT
            const groupedByParticipant = {};
            
            claims.forEach(claim => {
                const participantId = claim.shift?.participant_id || 'unassigned';
                if (!groupedByParticipant[participantId]) {
                    groupedByParticipant[participantId] = {
                        participant: claim.shift?.participants,
                        claims: []
                    };
                }
                groupedByParticipant[participantId].claims.push(claim);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByParticipant).forEach(([participantId, group]) => {
                const participant = group.participant;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                const groupTotal = group.claims.reduce((sum, c) => sum + (c.total_claim || 0), 0);
                const groupKm = group.claims.reduce((sum, c) => sum + (c.kilometres || 0), 0);
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user"></i> ${participantName}
                            </span>
                            <span style="font-size: 14px;">
                                ${group.claims.length} claims • $${groupTotal.toFixed(2)} • ${groupKm.toFixed(0)}km
                            </span>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Date</th>
                                    <th style="padding: 12px;">Staff</th>
                                    <th style="padding: 12px;">Route</th>
                                    <th style="padding: 12px;">KM</th>
                                    <th style="padding: 12px;">Amount</th>
                                    <th style="padding: 12px;">Evidence</th>
                                    <th style="padding: 12px;">Status</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.claims.map(claim => {
                                    const staff = claim.staff;
                                    const routeDisplay = (claim.route_origin || claim.route_destination) 
                                        ? `<div style="font-size: 0.9em;">
                                            ${claim.route_origin ? `<div><i class="fas fa-map-marker-alt" style="color: #28a745;"></i> ${claim.route_origin}</div>` : ''}
                                            ${claim.route_destination ? `<div style="margin-top: 2px;"><i class="fas fa-flag-checkered" style="color: #dc3545;"></i> ${claim.route_destination}</div>` : ''}
                                           </div>`
                                        : '<span style="color: #999;">Not specified</span>';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px;">${formatDateShort(claim.date)}</td>
                                            <td style="padding: 12px;">
                                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unknown'}
                                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                                            </td>
                                            <td style="padding: 12px; max-width: 250px;">${routeDisplay}</td>
                                            <td style="padding: 12px;">${claim.kilometres || 0} km</td>
                                            <td style="padding: 12px; color: #4CAF50; font-weight: 600;">$${(claim.total_claim || 0).toFixed(2)}</td>
                                            <td style="padding: 12px;">
                                                ${claim.evidence_url ? 
                                                    `<a href="${claim.evidence_url}" target="_blank" class="btn-sm btn-primary">
                                                        <i class="fas fa-paperclip"></i> View
                                                    </a>` : 
                                                    '<span style="color: #999;">None</span>'}
                                            </td>
                                            <td style="padding: 12px;">
                                                <span class="badge badge-${claim.status}">${claim.status || 'submitted'}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    ${claim.status === 'pending' || !claim.status ? `
                                                        <button class="btn-sm btn-success" onclick="approveTransportClaim('${claim.id}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn-sm btn-danger" onclick="rejectTransportClaim('${claim.id}')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    ` : `
                                                        <span style="color: #999; font-size: 11px;">
                                                            ${claim.status === 'approved' ? 'Approved' : 'Rejected'}
                                                        </span>
                                                    `}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
            
        } else {
            // STAFF VIEW (Table)
            html += `
                <table class="request-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Staff</th>
                            <th>Participant</th>
                            <th>Route</th>
                            <th>KM</th>
                            <th>Amount</th>
                            <th>Evidence</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (claims.length === 0) {
                html += `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                            No ${currentRequestStatus === 'all' ? '' : currentRequestStatus} transport claims found
                        </td>
                    </tr>
                `;
            } else {
                claims.forEach(claim => {
                    const staff = claim.staff;
                    const participant = claim.shift?.participants;
                    const routeDisplay = (claim.route_origin || claim.route_destination) 
                        ? `<div style="font-size: 0.85em; line-height: 1.3;">
                            ${claim.route_origin ? `<div><i class="fas fa-map-marker-alt" style="color: #28a745;"></i> ${claim.route_origin}</div>` : ''}
                            ${claim.route_destination ? `<div style="margin-top: 3px;"><i class="fas fa-flag-checkered" style="color: #dc3545;"></i> ${claim.route_destination}</div>` : ''}
                           </div>`
                        : '<span style="color: #999;">Not specified</span>';
                    
                    html += `
                        <tr>
                            <td>${formatDateShort(claim.date)}</td>
                            <td>
                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unknown'}
                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                            </td>
                            <td>${participant ? `${participant.first_name} ${participant.last_name}` : 'N/A'}</td>
                            <td style="max-width: 200px;">${routeDisplay}</td>
                            <td>${claim.kilometres || 0} km</td>
                            <td style="color: #4CAF50; font-weight: 600;">$${(claim.total_claim || 0).toFixed(2)}</td>
                            <td>
                                ${claim.evidence_url ? 
                                    `<a href="${claim.evidence_url}" target="_blank" class="btn-sm btn-primary">
                                        <i class="fas fa-paperclip"></i> View
                                    </a>` : 
                                    '<span style="color: #999;">None</span>'}
                            </td>
                            <td>
                                <span class="badge badge-${claim.status || 'pending'}">${claim.status || 'submitted'}</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${claim.status === 'pending' || !claim.status ? `
                                        <button class="btn-sm btn-success" onclick="approveTransportClaim('${claim.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-sm btn-danger" onclick="rejectTransportClaim('${claim.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : `
                                        <span style="color: #999; font-size: 11px;">
                                            ${claim.status === 'approved' ? 'Approved' : 'Rejected'}
                                        </span>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading transport claims:', error);
        container.innerHTML = `<div class="alert alert-danger">Failed to load transport claims: ${error.message}</div>`;
    }
}

async function loadLeaveRequests() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        let query = supabaseClient
            .from('leave_requests')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                )
            `)
            .order('created_at', { ascending: false });
        
        if (currentRequestStatus !== 'all') {
            query = query.eq('status', currentRequestStatus);
        }
        
        const { data: leaves, error } = await query;
        if (error) throw error;
        
        const stats = {
            total: leaves.length,
            pending: leaves.filter(l => l.status === 'pending').length,
            approved: leaves.filter(l => l.status === 'approved').length,
            rejected: leaves.filter(l => l.status === 'rejected').length
        };
        
        let html = `
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Pending</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.pending}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Approved</div>
                    <div class="summary-value" style="color: #28a745;">${stats.approved}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Rejected</div>
                    <div class="summary-value" style="color: #dc3545;">${stats.rejected}</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            html += `
                <div style="padding: 40px; text-align: center; color: #666;">
                    <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p>Leave requests are staff-only. Switch to Staff view to see requests.</p>
                </div>
            `;
        } else {
            // GROUP BY STAFF
            const groupedByStaff = {};
            
            leaves.forEach(leave => {
                const staffId = leave.staff_id || 'unassigned';
                if (!groupedByStaff[staffId]) {
                    groupedByStaff[staffId] = {
                        staff: leave.staff,
                        leaves: []
                    };
                }
                groupedByStaff[staffId].leaves.push(leave);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByStaff).forEach(([staffId, group]) => {
                const staff = group.staff;
                const staffName = staff ? 
                    `${staff.first_name} ${staff.last_name}` : 
                    'Unknown';
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user-tie"></i> ${staffName}
                                ${staff?.staff_code ? `<span style="margin-left: 8px; opacity: 0.8; font-size: 13px;">${staff.staff_code}</span>` : ''}
                            </span>
                            <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${group.leaves.length} requests
                            </span>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Leave Type</th>
                                    <th style="padding: 12px;">Start Date</th>
                                    <th style="padding: 12px;">End Date</th>
                                    <th style="padding: 12px;">Reason</th>
                                    <th style="padding: 12px;">Status</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.leaves.map(leave => {
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px; font-weight: 600;">${leave.leave_type || 'Leave'}</td>
                                            <td style="padding: 12px;">${formatDateShort(leave.start_date)}</td>
                                            <td style="padding: 12px;">${formatDateShort(leave.end_date)}</td>
                                            <td style="padding: 12px;"><small>${leave.reason || '-'}</small></td>
                                            <td style="padding: 12px;">
                                                <span class="badge badge-${leave.status}">${leave.status}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    ${leave.status === 'pending' ? `
                                                        <button class="btn-sm btn-success" onclick="approveLeave('${leave.id}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn-sm btn-danger" onclick="rejectLeave('${leave.id}')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    ` : `
                                                        <span style="color: #999; font-size: 11px;">
                                                            ${leave.status === 'approved' ? 'Approved' : 'Rejected'}
                                                        </span>
                                                    `}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading leave requests:', error);
        container.innerHTML = `<div class="alert alert-danger">Failed to load leave requests: ${error.message}</div>`;
    }
}

async function loadShiftApprovals() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        let query = supabaseClient
            .from('shifts')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                ),
                participants(first_name, last_name),
                duty_types(name),
                locations(name)
            `)
            .eq('status', 'pending')
            .order('date', { ascending: true });
        
        const { data: shifts, error } = await query;
        if (error) throw error;
        
        const stats = {
            total: shifts.length,
            today: shifts.filter(s => {
                const shiftDate = new Date(s.date);
                const today = new Date();
                return shiftDate.toDateString() === today.toDateString();
            }).length,
            upcoming: shifts.filter(s => new Date(s.date) > new Date()).length
        };
        
        let html = `
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total Pending</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Today</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.today}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Upcoming</div>
                    <div class="summary-value" style="color: #2196F3;">${stats.upcoming}</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            // GROUP BY PARTICIPANT
            const groupedByParticipant = {};
            
            shifts.forEach(shift => {
                const participantId = shift.participant_id || 'unassigned';
                if (!groupedByParticipant[participantId]) {
                    groupedByParticipant[participantId] = {
                        participant: shift.participants,
                        shifts: []
                    };
                }
                groupedByParticipant[participantId].shifts.push(shift);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByParticipant).forEach(([participantId, group]) => {
                const participant = group.participant;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                const shiftIds = group.shifts.map(s => s.id);
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user"></i> ${participantName}
                            </span>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${group.shifts.length} shifts
                                </span>
                                <button class="btn-sm" 
                                        style="background: #4CAF50; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;"
                                        onclick="approveAllShifts(${JSON.stringify(shiftIds).replace(/"/g, '&quot;')}, '${participantName}')">
                                    <i class="fas fa-check-double"></i> Approve All
                                </button>
                            </div>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Date</th>
                                    <th style="padding: 12px;">Time</th>
                                    <th style="padding: 12px;">Staff</th>
                                    <th style="padding: 12px;">Type</th>
                                    <th style="padding: 12px;">Location</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.shifts.map(shift => {
                                    const staff = shift.staff;
                                    const dutyType = shift.duty_types?.name || 'Regular';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px; font-weight: 600;">${formatDateShort(shift.date)}</td>
                                            <td style="padding: 12px;">
                                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'}
                                                ${shift.end_time ? ` - ${formatTime12Hour(shift.end_time)}` : ''}
                                            </td>
                                            <td style="padding: 12px;">
                                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unassigned'}
                                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                                            </td>
                                            <td style="padding: 12px;"><small>${dutyType}</small></td>
                                            <td style="padding: 12px;"><small>${shift.locations?.name || 'Client Home'}</small></td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    <button class="btn-sm btn-success" onclick="approveShift('${shift.id}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn-sm btn-danger" onclick="rejectShift('${shift.id}')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
            
        } else {
            // GROUP BY STAFF
            const groupedByStaff = {};
            
            shifts.forEach(shift => {
                const staffId = shift.staff_id || 'unassigned';
                if (!groupedByStaff[staffId]) {
                    groupedByStaff[staffId] = {
                        staff: shift.staff,
                        shifts: []
                    };
                }
                groupedByStaff[staffId].shifts.push(shift);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByStaff).forEach(([staffId, group]) => {
                const staff = group.staff;
                const staffName = staff ? 
                    `${staff.first_name} ${staff.last_name}` : 
                    'Unassigned';
                
                const shiftIds = group.shifts.map(s => s.id);
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user-tie"></i> ${staffName}
                                ${staff?.staff_code ? `<span style="margin-left: 8px; opacity: 0.8; font-size: 13px;">${staff.staff_code}</span>` : ''}
                            </span>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${group.shifts.length} shifts
                                </span>
                                <button class="btn-sm" 
                                        style="background: #4CAF50; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;"
                                        onclick="approveAllShifts(${JSON.stringify(shiftIds).replace(/"/g, '&quot;')}, '${staffName}')">
                                    <i class="fas fa-check-double"></i> Approve All
                                </button>
                            </div>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Date</th>
                                    <th style="padding: 12px;">Time</th>
                                    <th style="padding: 12px;">Participant</th>
                                    <th style="padding: 12px;">Type</th>
                                    <th style="padding: 12px;">Location</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.shifts.map(shift => {
                                    const participant = shift.participants;
                                    const dutyType = shift.duty_types?.name || 'Regular';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px; font-weight: 600;">${formatDateShort(shift.date)}</td>
                                            <td style="padding: 12px;">
                                                ${shift.start_time ? formatTime12Hour(shift.start_time) : 'Sleepover'}
                                                ${shift.end_time ? ` - ${formatTime12Hour(shift.end_time)}` : ''}
                                            </td>
                                            <td style="padding: 12px;">
                                                ${participant ? `${participant.first_name} ${participant.last_name}` : 'Unassigned'}
                                            </td>
                                            <td style="padding: 12px;"><small>${dutyType}</small></td>
                                            <td style="padding: 12px;"><small>${shift.locations?.name || 'Client Home'}</small></td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    <button class="btn-sm btn-success" onclick="approveShift('${shift.id}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn-sm btn-danger" onclick="rejectShift('${shift.id}')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading shift approvals:', error);
        container.innerHTML = `<div class="alert alert-danger">Failed to load shift approvals: ${error.message}</div>`;
    }
}

// Function to approve all shifts for a staff member or participant
async function approveAllShifts(shiftIds, name) {
    if (!confirm(`Are you sure you want to approve all ${shiftIds.length} shifts for ${name}?`)) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
    
    try {
        const { error } = await supabaseClient
            .from('shifts')
            .update({ status: 'approved' })
            .in('id', shiftIds);
        
        if (error) throw error;
        
        showToast(`Successfully approved ${shiftIds.length} shifts for ${name}`, 'success');
        loadShiftApprovals(); // Reload the list
        
    } catch (error) {
        console.error('Error approving shifts:', error);
        showToast(`Failed to approve shifts: ${error.message}`, 'error');
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}


async function loadShiftAdjustments() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        // Build query with status filter
        let query = supabaseClient
            .from('shift_adjustment_requests')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                ),
                shift:shift_id(
                    id,
                    date,
                    start_time,
                    end_time,
                    participant_id,
                    participants(first_name, last_name),
                    duty_types(name)
                )
            `)
            .order('created_at', { ascending: false });
        
        // Apply status filter
        if (currentRequestStatus !== 'all') {
            query = query.eq('status', currentRequestStatus);
        }
        
        const { data: adjustments, error } = await query;
        
        if (error) throw error;
        
        // Calculate summary stats
        const stats = {
            total: adjustments.length,
            pending: adjustments.filter(a => a.status === 'pending').length,
            approved: adjustments.filter(a => a.status === 'approved').length,
            rejected: adjustments.filter(a => a.status === 'rejected').length
        };
        
        // Build HTML based on view mode
        let html = `
            <!-- Summary Stats -->
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Pending</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.pending}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Approved</div>
                    <div class="summary-value" style="color: #28a745;">${stats.approved}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Rejected</div>
                    <div class="summary-value" style="color: #dc3545;">${stats.rejected}</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            // GROUP BY PARTICIPANT
            const groupedByParticipant = {};
            
            adjustments.forEach(adj => {
                const participantId = adj.shift?.participant_id || 'unassigned';
                if (!groupedByParticipant[participantId]) {
                    groupedByParticipant[participantId] = {
                        participant: adj.shift?.participants,
                        adjustments: []
                    };
                }
                groupedByParticipant[participantId].adjustments.push(adj);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByParticipant).forEach(([participantId, group], index) => {
                const participant = group.participant;
                const participantName = participant ? 
                    `${participant.first_name} ${participant.last_name}` : 
                    'Unassigned';
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user"></i> ${participantName}
                            </span>
                            <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${group.adjustments.length} requests
                            </span>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px; text-align: left;">Date</th>
                                    <th style="padding: 12px;">Staff</th>
                                    <th style="padding: 12px;">Original Times</th>
                                    <th style="padding: 12px;">Requested Times</th>
                                    <th style="padding: 12px;">Reason</th>
                                    <th style="padding: 12px;">Status</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.adjustments.map(adj => {
                                    const shift = adj.shift;
                                    const staff = adj.staff;
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px;">${shift ? formatDateShort(shift.date) : 'N/A'}</td>
                                            <td style="padding: 12px;">
                                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unknown'}
                                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                                            </td>
                                            <td style="padding: 12px; font-size: 13px;">
                                                ${shift?.start_time ? formatTime12Hour(shift.start_time) : 'N/A'}<br>
                                                to<br>
                                                ${shift?.end_time ? formatTime12Hour(shift.end_time) : 'N/A'}
                                            </td>
                                            <td style="padding: 12px; color: #2196F3; font-weight: 600; font-size: 13px;">
                                                ${adj.new_start_time ? formatTime12Hour(adj.new_start_time) : 'N/A'}<br>
                                                to<br>
                                                ${adj.new_end_time ? formatTime12Hour(adj.new_end_time) : 'N/A'}
                                            </td>
                                            <td style="padding: 12px;"><small>${adj.reason || '-'}</small></td>
                                            <td style="padding: 12px;">
                                                <span class="badge badge-${adj.status}">${adj.status}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    ${adj.status === 'pending' ? `
                                                        <button class="btn-sm btn-success" onclick="approveAdjustment('${adj.id}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn-sm btn-danger" onclick="denyAdjustment('${adj.id}')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    ` : `
                                                        <span style="color: #999; font-size: 11px;">
                                                            ${adj.status === 'approved' ? 'Approved' : 'Rejected'}
                                                        </span>
                                                    `}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
            
        } else {
            // GROUP BY STAFF (original table view)
            html += `
                <!-- Adjustments Table -->
                <table class="request-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Staff</th>
                            <th>Participant</th>
                            <th>Original Times</th>
                            <th>Requested Times</th>
                            <th>Type</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (adjustments.length === 0) {
                html += `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                            No ${currentRequestStatus === 'all' ? '' : currentRequestStatus} adjustment requests found
                        </td>
                    </tr>
                `;
            } else {
                adjustments.forEach(adjustment => {
                    const shift = adjustment.shift;
                    const staff = adjustment.staff;
                    const participant = shift?.participants;
                    
                    html += `
                        <tr>
                            <td>${shift ? formatDateShort(shift.date) : 'N/A'}</td>
                            <td>
                                ${staff ? `${staff.first_name} ${staff.last_name}` : 'Unknown'}
                                ${staff?.staff_code ? `<br><small style="color: #666;">${staff.staff_code}</small>` : ''}
                            </td>
                            <td>${participant ? `${participant.first_name} ${participant.last_name}` : 'N/A'}</td>
                            <td>
                                ${shift?.start_time ? formatTime12Hour(shift.start_time) : 'N/A'}<br>
                                to<br>
                                ${shift?.end_time ? formatTime12Hour(shift.end_time) : 'N/A'}
                            </td>
                            <td style="color: #2196F3; font-weight: 600;">
                                ${adjustment.new_start_time ? formatTime12Hour(adjustment.new_start_time) : 'N/A'}<br>
                                to<br>
                                ${adjustment.new_end_time ? formatTime12Hour(adjustment.new_end_time) : 'N/A'}
                            </td>
                            <td>
                                <small>${adjustment.adjustment_type || 'Time Change'}</small>
                            </td>
                            <td>
                                <small>${adjustment.reason || '-'}</small>
                            </td>
                            <td>
                                <span class="badge badge-${adjustment.status}">
                                    ${adjustment.status}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${adjustment.status === 'pending' ? `
                                        <button class="btn-sm btn-success" 
                                                onclick="approveAdjustment('${adjustment.id}')"
                                                title="Approve Adjustment">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-sm btn-danger" 
                                                onclick="denyAdjustment('${adjustment.id}')"
                                                title="Deny Adjustment">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : `
                                        <span style="color: #999; font-size: 11px;">
                                            ${adjustment.status === 'approved' ? 'Approved' : 'Rejected'}
                                        </span>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading shift adjustments:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                Failed to load shift adjustments: ${error.message}
            </div>
        `;
    }
}

// Toggle accordion function
function toggleRequestAccordion(index) {
    const content = document.getElementById(`request-accordion-${index}`);
    const arrow = document.getElementById(`request-arrow-${index}`);
    
    if (content) {
        content.classList.toggle('active');
        if (arrow) {
            arrow.classList.toggle('open');
        }
    }
}
function setButtonLoading(buttonId, isLoading) {
    const button = document.getElementById(buttonId);
    if (!button) return;
    
    if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
    } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
    }
}

// Helper function to add loading to all buttons in a container
function setActionButtonsLoading(claimId, isLoading) {
    const approveBtn = document.getElementById(`approve-${claimId}`);
    const denyBtn = document.getElementById(`deny-${claimId}`);
    
    [approveBtn, denyBtn].forEach(btn => {
        if (btn) {
            if (isLoading) {
                btn.classList.add('btn-loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
    });
}

function getEvidenceUrl(evidencePath) {
    if (!evidencePath) return null;
    
    // If it's already a full URL, return it
    if (evidencePath.startsWith('http')) {
        return evidencePath;
    }
    
    // Otherwise, construct the storage URL
    const { data } = supabaseClient.storage
        .from('transport-evidence')
        .getPublicUrl(evidencePath);
    
    return data.publicUrl;
}

// Add CSS animation keyframes if not present
if (!document.querySelector('#notification-animations')) {
    const style = document.createElement('style');
    style.id = 'notification-animations';
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

async function approveTransportClaim(claimId) {
    try {
        const { error } = await supabaseClient
            .from('transport_claims')
            .update({ 
                status: 'approved',
                approved_at: new Date().toISOString()
            })
            .eq('id', claimId);
        
        if (error) throw error;
        
        showNotification('Transport claim approved', 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving transport claim:', error);
        showNotification('Failed to approve transport claim', 'error');
    }
}

async function rejectTransportClaim(claimId) {
    try {
        const { error } = await supabaseClient
            .from('transport_claims')
            .update({ 
                status: 'rejected',
                approved_at: new Date().toISOString()
            })
            .eq('id', claimId);
        
        if (error) throw error;
        
        showNotification('Transport claim rejected', 'info');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error rejecting transport claim:', error);
        showNotification('Failed to reject transport claim', 'error');
    }
}
// Approve all claims for a staff member
async function approveAllClaims(staffId) {
    if (isLoadingRequest) return;
    
    if (!confirm('Are you sure you want to approve all pending claims for this staff member?')) {
        return;
    }
    
    isLoadingRequest = true;
    
    // Show loading state in the UI
    const container = document.getElementById('requestsTableContainer');
    const originalContent = container.innerHTML;
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Approving all claims...</span>
        </div>
    `;
    
    try {
        if (!currentManagerStaff) {
            const user = await supabaseClient.auth.getUser();
            if (user?.data?.user) {
                const { data: staffData } = await supabaseClient
                    .from('staff')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .single();
                currentManagerStaff = staffData;
            }
        }
        
        const { data: claims, error: fetchError } = await supabaseClient
            .from('transport_claims')
            .select('id')
            .eq('staff_id', staffId)
            .eq('status', 'pending');
        
        if (fetchError) throw fetchError;
        
        if (!claims || claims.length === 0) {
            showNotification('No pending claims to approve', 'warning');
            container.innerHTML = originalContent;
            return;
        }
        
        const { error: updateError } = await supabaseClient
            .from('transport_claims')
            .update({ 
                status: 'approved',
                approved_by: currentManagerStaff?.id,
                approved_at: new Date().toISOString()
            })
            .in('id', claims.map(c => c.id));
        
        if (updateError) throw updateError;
        
        showNotification(`Approved ${claims.length} transport claims`, 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving claims:', error);
        showNotification('Failed to approve claims', 'error');
        container.innerHTML = originalContent;
    } finally {
        isLoadingRequest = false;
    }
}

// ========================================
// SCHOOL HOLIDAY FUNCTIONS
// ========================================

async function loadSchoolHolidays() {
    const container = document.getElementById('requestsTableContainer');
    if (!container) return;
    
    try {
        let query = supabaseClient
            .from('school_holidays')
            .select(`
                *,
                staff:staff_id(
                    id,
                    first_name,
                    last_name,
                    staff_code
                )
            `)
            .order('created_at', { ascending: false });
        
        if (currentRequestStatus !== 'all') {
            query = query.eq('status', currentRequestStatus);
        }
        
        const { data: holidays, error } = await query;
        if (error) throw error;
        
        const stats = {
            total: holidays.length,
            pending: holidays.filter(h => h.status === 'pending').length,
            approved: holidays.filter(h => h.status === 'approved').length,
            rejected: holidays.filter(h => h.status === 'rejected').length
        };
        
        let html = `
            <div class="requests-summary">
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">${stats.total}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Pending</div>
                    <div class="summary-value" style="color: #ff9800;">${stats.pending}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Approved</div>
                    <div class="summary-value" style="color: #28a745;">${stats.approved}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Rejected</div>
                    <div class="summary-value" style="color: #dc3545;">${stats.rejected}</div>
                </div>
            </div>
        `;
        
        if (requestViewMode === 'participant') {
            html += `
                <div style="padding: 40px; text-align: center; color: #666;">
                    <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p>School holidays are staff-only. Switch to Staff view to see requests.</p>
                </div>
            `;
        } else {
            // GROUP BY STAFF
            const groupedByStaff = {};
            
            holidays.forEach(holiday => {
                const staffId = holiday.staff_id || 'unassigned';
                if (!groupedByStaff[staffId]) {
                    groupedByStaff[staffId] = {
                        staff: holiday.staff,
                        holidays: []
                    };
                }
                groupedByStaff[staffId].holidays.push(holiday);
            });
            
            html += `<div class="timesheet-wrapper">`;
            
            Object.entries(groupedByStaff).forEach(([staffId, group]) => {
                const staff = group.staff;
                const staffName = staff ? 
                    `${staff.first_name} ${staff.last_name}` : 
                    'Unknown';
                
                html += `
                    <div class="shift-group" style="margin-bottom: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="shift-group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 16px;">
                                <i class="fas fa-user-tie"></i> ${staffName}
                                ${staff?.staff_code ? `<span style="margin-left: 8px; opacity: 0.8; font-size: 13px;">${staff.staff_code}</span>` : ''}
                            </span>
                            <span class="badge" style="background: white; color: #667eea; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${group.holidays.length} requests
                            </span>
                        </div>
                        
                        <table class="request-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea;">
                                <tr>
                                    <th style="padding: 12px;">Start Date</th>
                                    <th style="padding: 12px;">End Date</th>
                                    <th style="padding: 12px;">Duration</th>
                                    <th style="padding: 12px;">Submitted</th>
                                    <th style="padding: 12px;">Status</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.holidays.map(holiday => {
                                    const startDate = new Date(holiday.start_date);
                                    const endDate = new Date(holiday.end_date);
                                    const durationDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px; font-weight: 600;">${formatDateShort(holiday.start_date)}</td>
                                            <td style="padding: 12px; font-weight: 600;">${formatDateShort(holiday.end_date)}</td>
                                            <td style="padding: 12px;">
                                                <span class="badge" style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                    ${durationDays} day${durationDays !== 1 ? 's' : ''}
                                                </span>
                                            </td>
                                            <td style="padding: 12px;"><small>${new Date(holiday.created_at).toLocaleDateString('en-AU')}</small></td>
                                            <td style="padding: 12px;">
                                                <span class="badge badge-${holiday.status}">${holiday.status}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div class="action-buttons">
                                                    ${holiday.status === 'pending' ? `
                                                        <button class="btn-sm btn-success" onclick="approveSchoolHoliday('${holiday.id}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn-sm btn-danger" onclick="rejectSchoolHoliday('${holiday.id}')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    ` : `
                                                        <span style="color: #999; font-size: 11px;">
                                                            ${holiday.status === 'approved' ? 'Approved' : 'Rejected'}
                                                        </span>
                                                    `}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading school holidays:', error);
        container.innerHTML = `<div class="alert alert-danger">Failed to load school holidays: ${error.message}</div>`;
    }
}

async function approveSchoolHoliday(holidayId) {
    if (isLoadingRequest) return;
    isLoadingRequest = true;
    
    setActionButtonsLoading(holidayId, true);
    
    try {
        if (!currentManagerStaff) {
            const user = await supabaseClient.auth.getUser();
            if (user?.data?.user) {
                const { data: staffData } = await supabaseClient
                    .from('staff')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .single();
                currentManagerStaff = staffData;
            }
        }
        
        const { error } = await supabaseClient
            .from('school_holidays')
            .update({ 
                status: 'approved',
                approved_by: currentManagerStaff?.id,
                approved_at: new Date().toISOString()
            })
            .eq('id', holidayId);
        
        if (error) throw error;
        
        showNotification('School holiday approved', 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving holiday:', error);
        showNotification('Failed to approve holiday', 'error');
        setActionButtonsLoading(holidayId, false);
    } finally {
        isLoadingRequest = false;
    }
}

async function rejectSchoolHoliday(holidayId) {
    try {
        const { error } = await supabaseClient
            .from('school_holidays')
            .update({ 
                status: 'rejected',
                approved_at: new Date().toISOString()
            })
            .eq('id', holidayId);
        
        if (error) throw error;
        
        showNotification('School holiday rejected', 'info');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error rejecting school holiday:', error);
        showNotification('Failed to reject school holiday', 'error');
    }
}

async function approveAllHolidays(staffId) {
    if (isLoadingRequest) return;
    
    if (!confirm('Are you sure you want to approve all pending holidays for this staff member?')) {
        return;
    }
    
    isLoadingRequest = true;
    
    const container = document.getElementById('requestsTableContainer');
    const originalContent = container.innerHTML;
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Approving all holidays...</span>
        </div>
    `;
    
    try {
        if (!currentManagerStaff) {
            const user = await supabaseClient.auth.getUser();
            if (user?.data?.user) {
                const { data: staffData } = await supabaseClient
                    .from('staff')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .single();
                currentManagerStaff = staffData;
            }
        }
        
        const { data: holidays, error: fetchError } = await supabaseClient
            .from('school_holidays')
            .select('id')
            .eq('staff_id', staffId)
            .eq('status', 'pending');
        
        if (fetchError) throw fetchError;
        
        if (!holidays || holidays.length === 0) {
            showNotification('No pending holidays to approve', 'warning');
            container.innerHTML = originalContent;
            return;
        }
        
        const { error: updateError } = await supabaseClient
            .from('school_holidays')
            .update({ 
                status: 'approved',
                approved_by: currentManagerStaff?.id,
                approved_at: new Date().toISOString()
            })
            .in('id', holidays.map(h => h.id));
        
        if (updateError) throw updateError;
        
        showNotification(`Approved ${holidays.length} school holiday requests`, 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving holidays:', error);
        showNotification('Failed to approve holidays', 'error');
        container.innerHTML = originalContent;
    } finally {
        isLoadingRequest = false;
    }
}

// ========================================
// SHIFT FUNCTIONS
// ========================================

async function approveShift(shiftId) {
    try {
        const { error } = await supabaseClient
            .from('shifts')
            .update({ status: 'approved' })
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showToast('Shift approved successfully', 'success');
        loadShiftApprovals(); // Reload the list
        
    } catch (error) {
        console.error('Error approving shift:', error);
        showToast(`Failed to approve shift: ${error.message}`, 'error');
    }
}


async function rejectShift(shiftId) {
    if (!confirm('Are you sure you want to reject and delete this shift? This action cannot be undone.')) {
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('shifts')
            .delete()
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showToast('Shift rejected and deleted successfully', 'success');
        loadShiftApprovals(); // Reload the list
        
    } catch (error) {
        console.error('Error deleting shift:', error);
        showToast(`Failed to delete shift: ${error.message}`, 'error');
    }
}


async function approveAllParticipantShifts(participantId) {
    if (isLoadingRequest) return;
    
    if (!confirm('Are you sure you want to approve all pending shifts for this participant?')) {
        return;
    }
    
    isLoadingRequest = true;
    
    const container = document.getElementById('requestsTableContainer');
    const originalContent = container.innerHTML;
    container.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Approving all shifts...</span>
        </div>
    `;
    
    try {
        const { data: shifts, error: fetchError } = await supabaseClient
            .from('shifts')
            .select('id')
            .eq('participant_id', participantId)
            .eq('status', 'pending');
        
        if (fetchError) throw fetchError;
        
        const { error: updateError } = await supabaseClient
            .from('shifts')
            .update({ 
                status: 'confirmed',
                updated_at: new Date().toISOString()
            })
            .in('id', shifts.map(s => s.id));
        
        if (updateError) throw updateError;
        
        showNotification(`Approved ${shifts.length} shifts`, 'success');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving shifts:', error);
        showNotification('Failed to approve shifts', 'error');
        container.innerHTML = originalContent;
    } finally {
        isLoadingRequest = false;
    }
}


async function isStaffAvailable(staffId, date, startTime, endTime) {
    try {
        // Check staff_availability table
        const { data: availability } = await supabaseClient
  .from('staff_availability')
  .select('available, start_time, end_time')
  .eq('staff_id', staffId)
  .eq('date', date)
  .single();
        
        // If no availability record, assume unavailable
        if (!availability?.available) return false;

        // If marked as unavailable
        if (!availability.is_available) {
            return false;
        }
        
        // If times provided, check if within available hours
        if (startTime && endTime && availability.start_time && availability.end_time) {
            const shiftStart = new Date(`2000-01-01T${startTime}`);
            const shiftEnd = new Date(`2000-01-01T${endTime}`);
            const availStart = new Date(`2000-01-01T${availability.start_time}`);
            const availEnd = new Date(`2000-01-01T${availability.end_time}`);
            
            if (shiftStart < availStart || shiftEnd > availEnd) {
                return false;
            }
        }
        
        // Check for approved leave
        const { data: leaves } = await supabaseClient
            .from('leave_requests')
            .select('id')
            .eq('staff_id', staffId)
            .eq('status', 'approved')
            .lte('start_date', date)
            .gte('end_date', date);
        
        return !leaves || leaves.length === 0;
        
    } catch (error) {
        console.error('Error checking availability:', error);
        return false; // Assume unavailable on error
    }
}
async function loadShifts() {
    try {
        
        // First check what's in the database
        const { count: totalCount } = await supabaseClient
            .from('shifts')
            .select('*', { count: 'exact', head: true })
            .is('deleted_at', null);
        
        // Check July specifically
        const { count: julyDbCount } = await supabaseClient
            .from('shifts')
            .select('*', { count: 'exact', head: true })
            .is('deleted_at', null)
            .gte('date', '2025-07-01')
            .lte('date', '2025-07-31');
        
            let query = supabaseClient
    .from('shifts')
    .select(`
        *,
        staff:staff_id(*),
        participants:participant_id(*),
        locations:location_id(*),
        duty_types:duty_type_id(*),
        pay_rates:pay_override_id(*)
    `)
    .is('deleted_at', null)
    .order('date', { ascending: false })
    .order('start_time', { ascending: true })
    .limit(50000);

        const { data: basicShifts, error } = await query;
        
        if (error) {
            console.error('Shifts query error:', error);
            throw error;
        }
        
        if (basicShifts?.length > 0) {
            const dates = basicShifts.map(s => s.date).sort();

            
            const julyCount = basicShifts.filter(s => s.date >= '2025-07-01' && s.date <= '2025-07-31').length;
            const earlyAugCount = basicShifts.filter(s => s.date >= '2025-08-01' && s.date <= '2025-08-24').length;
            
            // Sample a July shift if it exists
            const sampleJuly = basicShifts.find(s => s.date >= '2025-07-01' && s.date <= '2025-07-31');
            if (sampleJuly) {
                console.log('Sample July shift:', sampleJuly);
            }
        }
        
        if (!basicShifts || basicShifts.length === 0) {
            console.log('No shifts found in database');
            shifts = [];
            filteredShifts = [];
            renderCurrentView();
            return;
        }
        
        // Enrich with related data
        console.log('Starting enrichment...');
        shifts = await enrichShiftsData(basicShifts);
        console.log(`Enriched shifts: ${shifts.length}`);
        
        // DEBUG: Check after enrichment
        const julyCountEnriched = shifts.filter(s => s.date >= '2025-07-01' && s.date <= '2025-07-31').length;
        const earlyAugEnriched = shifts.filter(s => s.date >= '2025-08-01' && s.date <= '2025-08-24').length;
        console.log(`July shifts after enrichment: ${julyCountEnriched}`);
        console.log(`Early Aug shifts after enrichment: ${earlyAugEnriched}`);
        
        const enrichedDates = shifts.map(s => s.date).sort();
        console.log('Date range after enrichment:', {
            earliest: enrichedDates[0],
            latest: enrichedDates[enrichedDates.length - 1]
        });
        
        // Calculate overlap information
        console.log('Calculating overlap information...');
        
        for (const shift of shifts) {
            // Your existing overlap calculation code...
            if (shift.participant_id && shift.start_time && shift.end_time) {
                const sameParticipantShifts = shifts.filter(s => 
                    s.id !== shift.id &&
                    s.participant_id === shift.participant_id &&
                    s.date === shift.date &&
                    s.start_time && 
                    s.end_time
                );
                
                if (sameParticipantShifts.length > 0) {
                    const overlappingStaff = [];
                    const shiftStart = new Date(`2000-01-01T${shift.start_time}`);
                    let shiftEnd = new Date(`2000-01-01T${shift.end_time}`);
                    
                    if (shiftEnd <= shiftStart) {
                        shiftEnd.setDate(shiftEnd.getDate() + 1);
                    }
                    
                    sameParticipantShifts.forEach(otherShift => {
                        const otherStart = new Date(`2000-01-01T${otherShift.start_time}`);
                        let otherEnd = new Date(`2000-01-01T${otherShift.end_time}`);
                        
                        if (otherEnd <= otherStart) {
                            otherEnd.setDate(otherEnd.getDate() + 1);
                        }
                        
                        const hasOverlap = !(shiftEnd <= otherStart || shiftStart >= otherEnd);
                        
                        if (hasOverlap) {
                            const overlapStart = new Date(Math.max(shiftStart.getTime(), otherStart.getTime()));
                            const overlapEnd = new Date(Math.min(shiftEnd.getTime(), otherEnd.getTime()));
                            
                            overlappingStaff.push({
                                staff: otherShift.staff,
                                staff_id: otherShift.staff_id,
                                shift_id: otherShift.id,
                                time: `${formatTime12Hour(otherShift.start_time)}-${formatTime12Hour(otherShift.end_time)}`,
                                overlap_period: {
                                    start: overlapStart.toTimeString().slice(0, 5),
                                    end: overlapEnd.toTimeString().slice(0, 5),
                                    duration: ((overlapEnd - overlapStart) / (1000 * 60 * 60)).toFixed(1) + 'h'
                                }
                            });
                        }
                    });
                    
                    if (overlappingStaff.length > 0) {
                        shift.overlap_info = {
                            count: overlappingStaff.length + 1,
                            ratio: `${overlappingStaff.length + 1}:1`,
                            staff: overlappingStaff,
                            message: `${overlappingStaff.length + 1} staff providing care simultaneously`,
                            details: overlappingStaff.map(s => 
                                `${s.staff?.first_name} ${s.staff?.last_name} (${s.overlap_period.start}-${s.overlap_period.end})`
                            ).join(', ')
                        };
                    }
                }
            }
            
            // Staff conflict checking
            if (shift.staff_id && shift.start_time && shift.end_time) {
                const staffConflicts = shifts.filter(s =>
                    s.id !== shift.id &&
                    s.staff_id === shift.staff_id &&
                    s.date === shift.date &&
                    s.start_time &&
                    s.end_time
                );
                
                if (staffConflicts.length > 0) {
                    const conflicts = [];
                    const shiftStart = new Date(`2000-01-01T${shift.start_time}`);
                    let shiftEnd = new Date(`2000-01-01T${shift.end_time}`);
                    
                    if (shiftEnd <= shiftStart) {
                        shiftEnd.setDate(shiftEnd.getDate() + 1);
                    }
                    
                    staffConflicts.forEach(conflict => {
                        const conflictStart = new Date(`2000-01-01T${conflict.start_time}`);
                        let conflictEnd = new Date(`2000-01-01T${conflict.end_time}`);
                        
                        if (conflictEnd <= conflictStart) {
                            conflictEnd.setDate(conflictEnd.getDate() + 1);
                        }
                        
                        const hasOverlap = !(shiftEnd <= conflictStart || shiftStart >= conflictEnd);
                        
                        if (hasOverlap) {
                            conflicts.push({
                                shift_id: conflict.id,
                                participant: conflict.participant,
                                time: `${formatTime12Hour(conflict.start_time)}-${formatTime12Hour(conflict.end_time)}`,
                                participant_name: conflict.participant ? 
                                    `${conflict.participant.first_name} ${conflict.participant.last_name}` :
                                    'Unknown'
                            });
                        }
                    });
                    
                    if (conflicts.length > 0) {
                        shift.staff_conflict = {
                            has_conflict: true,
                            count: conflicts.length,
                            conflicts: conflicts,
                            message: `⚠️ Staff double-booked with ${conflicts.length} other shift(s)`
                        };
                    }
                }
            }
        }
        
        console.log('Overlap detection complete');
        
        // DEBUG: Final check before applyFilters
        const julyCountFinal = shifts.filter(s => s.date >= '2025-07-01' && s.date <= '2025-07-31').length;
        const earlyAugFinal = shifts.filter(s => s.date >= '2025-08-01' && s.date <= '2025-08-24').length;
        console.log(`July shifts before applyFilters: ${julyCountFinal}`);
        console.log(`Early Aug shifts before applyFilters: ${earlyAugFinal}`);
        
        const finalDates = shifts.map(s => s.date).sort();
        console.log('Final date range before applyFilters:', {
            earliest: finalDates[0],
            latest: finalDates[finalDates.length - 1],
            total: shifts.length
        });
        
        // Check conflicts
        const shiftsWithStaffConflicts = shifts.filter(s => s.staff_conflict?.has_conflict);
        const shiftsWithSleepoverViolations = shifts.filter(s => s.sleepover_violation?.has_violation);
        
        if (shiftsWithStaffConflicts.length > 0) {
            console.warn(`Found ${shiftsWithStaffConflicts.length} shifts with staff double-booking`);
        }
        
        // Apply filters
        console.log('About to call applyFilters()...');
        applyFilters();
        
        // Show warnings if needed
        if (shiftsWithStaffConflicts.length > 0 || shiftsWithSleepoverViolations.length > 0) {
            const warningMessage = [];
            if (shiftsWithStaffConflicts.length > 0) {
                warningMessage.push(`${shiftsWithStaffConflicts.length} staff double-bookings`);
            }
            if (shiftsWithSleepoverViolations.length > 0) {
                warningMessage.push(`${shiftsWithSleepoverViolations.length} sleepover violations`);
            }
            showNotification(`⚠️ Scheduling conflicts detected: ${warningMessage.join(', ')}`, 'warning');
        }

    } catch (error) {
        console.error('Error loading shifts:', error);
        showNotification('Failed to load shifts: ' + error.message, 'error');
        
        const tbody = document.getElementById('shiftsTableBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px; color: var(--danger-color);">
                        <strong>Error Loading Shifts</strong><br>
                        ${error.message}<br>
                        <button class="btn btn-primary btn-sm" onclick="loadShifts()" style="margin-top: 12px;">Retry</button>
                    </td>
                </tr>
            `;
        }
    }
}

        function detectCareHomes() {
    console.log('Detecting care homes...');
    console.log('Total participants:', participants.length);
    
    // Clear previous data
    careHomes.clear();
    
    // Group participants by address (normalized)
    const addressGroups = {};
    
    participants.forEach(p => {
        // Skip if no address
        if (!p.address || p.address.trim() === '') return;
        
        // Normalize address for comparison (lowercase, trim)
        const normalizedAddress = p.address.trim().toLowerCase();
        
        // Also check if this is a care home entity itself (like "Saunders Care Home" participant)
        const isCareHomeEntity = (p.first_name && p.last_name && 
            (p.last_name.toLowerCase().includes('care') || 
             p.last_name.toLowerCase().includes('home') ||
             p.first_name.toLowerCase().includes('saunders')));
        
        // If it's a care home entity, skip adding it as a resident
        if (isCareHomeEntity) {
            console.log('Found care home entity:', p.first_name, p.last_name, p.id);
            // Store care home entity info
            if (!addressGroups[normalizedAddress]) {
                addressGroups[normalizedAddress] = {
                    residents: [],
                    careHomeEntity: p
                };
            } else {
                addressGroups[normalizedAddress].careHomeEntity = p;
            }
        } else {
            // This is a resident
            if (!addressGroups[normalizedAddress]) {
                addressGroups[normalizedAddress] = {
                    residents: [],
                    careHomeEntity: null
                };
            }
            addressGroups[normalizedAddress].residents.push(p);
            console.log('Added resident:', p.first_name, p.last_name, 'at', normalizedAddress);
        }
    });
    
    // Process each address group
    Object.entries(addressGroups).forEach(([address, data]) => {
        // Check if this looks like a care home (multiple residents OR has a care home entity OR contains "saunders")
        if (data.residents.length > 1 || data.careHomeEntity || address.includes('saunders')) {
            let careHomeName = 'Care Home';
            let mainEntityId = null;
            
            // Determine care home name and main entity
            if (data.careHomeEntity) {
                careHomeName = `${data.careHomeEntity.first_name} ${data.careHomeEntity.last_name}`;
                mainEntityId = data.careHomeEntity.id;
            } else if (address.includes('saunders')) {
                careHomeName = 'Saunders Care Home';
                // Find the Saunders Care Home participant entity if it exists
                const saundersEntity = participants.find(p => 
                    p.first_name === 'Saunders' && p.last_name === 'Care Home'
                );
                if (saundersEntity) {
                    mainEntityId = saundersEntity.id;
                }
            }
            
            careHomes.set(address, {
                name: careHomeName,
                address: address,
                residents: data.residents,
                mainEntityId: mainEntityId
            });
            
            console.log(`Care home detected: ${careHomeName} at ${address} with ${data.residents.length} residents`);
        }
    });
    
    // Also check for Saunders Care Home entity specifically
    const saundersEntity = participants.find(p => 
        (p.first_name === 'Saunders' && p.last_name === 'Care Home') ||
        (p.first_name === 'Saunders' && p.last_name === 'Carehome')
    );
    
    if (saundersEntity) {
        console.log('Found Saunders Care Home entity:', saundersEntity);
        
        // Find all participants with Saunders address
        const saundersAddress = '1 saunders avenue, liverpool';
        const saundersResidents = participants.filter(p => 
            p.address && 
            p.address.toLowerCase().includes('saunders') &&
            p.id !== saundersEntity.id // Don't include the care home entity itself
        );
        
        // Update or create Saunders care home entry
        careHomes.set(saundersAddress, {
            name: 'Saunders Care Home',
            address: saundersAddress,
            residents: saundersResidents,
            mainEntityId: saundersEntity.id
        });
        
        console.log(`Saunders Care Home: ${saundersResidents.length} residents found`);
        console.log('Residents:', saundersResidents.map(r => `${r.first_name} ${r.last_name}`));
    }
    
    console.log(`Total care homes detected: ${careHomes.size}`);
    console.log('Care homes:', Array.from(careHomes.entries()));
}
// Helper function to detect care home name
function detectCareHomeName(address, residents) {
    // Check if address contains common care home keywords
    if (address.includes('saunders')) return 'Saunders Care Home';
    if (address.includes('care') || address.includes('home')) {
        // Extract the name from address
        return address.split(',')[0].replace(/\d+/g, '').trim();
    }
    // Default: use the address
    return `Care Home at ${address.split(',')[0]}`;
}

// Helper to find if there's a care home entity (not a person)
function findCareHomeEntity(residents, address) {
    const careHomeEntity = participants.find(p => 
        (p.first_name?.includes('Care') || p.last_name?.includes('Care') ||
         p.first_name?.includes('Home') || p.last_name?.includes('Home')) &&
        p.address?.toLowerCase() === address
    );
    return careHomeEntity?.id || null;
}

        async function enrichShiftsData(basicShifts) {
            if (!basicShifts || basicShifts.length === 0) return [];
            
            try {
                console.log('Enriching shifts with related data...');
                
                // Get unique IDs for batch loading
                const staffIds = [...new Set(basicShifts.map(s => s.staff_id).filter(Boolean))];
                const participantIds = [...new Set(basicShifts.map(s => s.participant_id).filter(Boolean))];
                const locationIds = [...new Set(basicShifts.map(s => s.location_id).filter(Boolean))];
                const dutyTypeIds = [...new Set(basicShifts.map(s => s.duty_type_id).filter(Boolean))];
                const payRateIds = [...new Set(basicShifts.map(s => s.pay_override_id).filter(Boolean))];

                console.log('Loading related data for IDs:', {
                    staffIds: staffIds.length,
                    participantIds: participantIds.length,
                    locationIds: locationIds.length,
                    dutyTypeIds: dutyTypeIds.length,
                    payRateIds: payRateIds.length
                });

                // Load related data in parallel
                const [
                    { data: staffData },
                    { data: participantData },
                    { data: locationData },
                    { data: dutyTypeData },
                    { data: payRateData }
                ] = await Promise.all([
                    staffIds.length ? supabaseClient.from('staff').select('*').in('id', staffIds) : { data: [] },
                    participantIds.length ? supabaseClient.from('participants').select('*').in('id', participantIds) : { data: [] },
                    locationIds.length ? supabaseClient.from('locations').select('*').in('id', locationIds) : { data: [] },
                    dutyTypeIds.length ? supabaseClient.from('duty_types').select('*').in('id', dutyTypeIds) : { data: [] },
                    payRateIds.length ? supabaseClient.from('pay_rates').select('*').in('id', payRateIds) : { data: [] }
                ]);

                console.log('Related data loaded:', {
                    staff: staffData?.length || 0,
                    participants: participantData?.length || 0,
                    locations: locationData?.length || 0,
                    dutyTypes: dutyTypeData?.length || 0,
                    payRates: payRateData?.length || 0
                });

                // Create lookup maps
                const staffMap = new Map((staffData || []).map(s => [s.id, s]));
                const participantMap = new Map((participantData || []).map(p => [p.id, p]));
                const locationMap = new Map((locationData || []).map(l => [l.id, l]));
                const dutyTypeMap = new Map((dutyTypeData || []).map(d => [d.id, d]));
                const payRateMap = new Map((payRateData || []).map(r => [r.id, r]));

                // Enrich shifts and calculate hours/pay
                const enrichedShifts = basicShifts.map(shift => {
                    const enrichedShift = {
                        ...shift,
                        staff: staffMap.get(shift.staff_id) || null,
                        participant: participantMap.get(shift.participant_id) || null,
                        location: locationMap.get(shift.location_id) || null,
                        duty_type: dutyTypeMap.get(shift.duty_type_id) || null,
                        pay_override: payRateMap.get(shift.pay_override_id) || null
                    };

                    // Calculate hours and pay - FIXED LOGIC
                    enrichedShift.calculated_hours = calculateShiftHours(enrichedShift);
                    enrichedShift.calculated_pay = calculateShiftPay(enrichedShift, enrichedShift.calculated_hours);

                    return enrichedShift;
                });

                return enrichedShifts;
                
            } catch (error) {
                console.error('Error enriching shifts:', error);
                return basicShifts;
            }
        }

        // Format hours with 1 decimal place
function formatHours(hours) {
    if (hours === undefined || hours === null) return '0.0';
    return parseFloat(hours).toFixed(1);
}

// Format date to "Mon 5 Aug 2025"
function formatDateFriendly(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString + 'T12:00:00'); // Use noon to avoid timezone issues
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

function formatTime(time) {
    if (!time) return '';
    
    // Handle if time is already in HH:MM format
    if (typeof time === 'string' && time.includes(':')) {
        const [hours, minutes] = time.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${minutes} ${ampm}`;
    }
    
    // Handle Date objects
    if (time instanceof Date) {
        const hours = time.getHours();
        const minutes = time.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHour = hours % 12 || 12;
        return `${displayHour}:${minutes.toString().padStart(2, '0')} ${ampm}`;
    }
    
    return time;
}


function formatTime12Hour(timeStr) {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

function formatDateShort(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' });
}

// Undo/Redo Manager
const UndoRedoManager = {
    // Save state before any modification
    saveState: function(action, data) {
        undoStack.push({
            action: action,
            data: JSON.parse(JSON.stringify(data)), // Deep clone
            timestamp: new Date().toISOString()
        });
        
        // Limit stack size
        if (undoStack.length > MAX_UNDO_STACK) {
            undoStack.shift();
        }
        
        // Clear redo stack when new action is performed
        redoStack = [];
        
        // Update UI buttons
        this.updateButtons();
    },
    
    undo: async function() {
        if (undoStack.length === 0) {
            showNotification('Nothing to undo', 'info');
            return;
        }
        
        const state = undoStack.pop();
        
        try {
            switch(state.action) {
                case 'create_shift':
                    // Undo creation by soft deleting
                    await supabaseClient
                        .from('shifts')
                        .update({ deleted_at: new Date().toISOString() })
                        .eq('id', state.data.id);
                    
                    redoStack.push(state);
                    showNotification('Shift creation undone', 'success');
                    break;
                    
                case 'update_shift':
                    // Restore previous values
                    await supabaseClient
                        .from('shifts')
                        .update(state.data.previous)
                        .eq('id', state.data.id);
                    
                    redoStack.push({
                        action: 'update_shift',
                        data: {
                            id: state.data.id,
                            previous: state.data.current,
                            current: state.data.previous
                        }
                    });
                    showNotification('Shift update undone', 'success');
                    break;
                    
                case 'delete_shift':
                    // Undo deletion by removing deleted_at
                    await supabaseClient
                        .from('shifts')
                        .update({ deleted_at: null })
                        .eq('id', state.data.id);
                    
                    redoStack.push(state);
                    showNotification('Shift deletion undone', 'success');
                    break;
            }
            
            await loadShifts();
            this.updateButtons();
            
        } catch (error) {
            console.error('Undo failed:', error);
            showNotification('Undo failed: ' + error.message, 'error');
            undoStack.push(state); // Restore to stack if failed
        }
    },
    
    redo: async function() {
        if (redoStack.length === 0) {
            showNotification('Nothing to redo', 'info');
            return;
        }
        
        const state = redoStack.pop();
        
        try {
            switch(state.action) {
                case 'create_shift':
                    // Redo creation by removing deleted_at
                    await supabaseClient
                        .from('shifts')
                        .update({ deleted_at: null })
                        .eq('id', state.data.id);
                    break;
                    
                case 'update_shift':
                    // Apply the update again
                    await supabaseClient
                        .from('shifts')
                        .update(state.data.current)
                        .eq('id', state.data.id);
                    break;
                    
                case 'delete_shift':
                    // Redo deletion
                    await supabaseClient
                        .from('shifts')
                        .update({ deleted_at: new Date().toISOString() })
                        .eq('id', state.data.id);
                    break;
            }
            
            undoStack.push(state);
            await loadShifts();
            this.updateButtons();
            showNotification('Action redone', 'success');
            
        } catch (error) {
            console.error('Redo failed:', error);
            showNotification('Redo failed: ' + error.message, 'error');
            redoStack.push(state); // Restore to stack if failed
        }
    },
    
    updateButtons: function() {
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        
        if (undoBtn) {
            undoBtn.disabled = undoStack.length === 0;
            undoBtn.title = undoStack.length > 0 ? 
                `Undo: ${undoStack[undoStack.length - 1].action.replace('_', ' ')}` : 
                'Nothing to undo (Ctrl+Z)';
        }
        
        if (redoBtn) {
            redoBtn.disabled = redoStack.length === 0;
            redoBtn.title = redoStack.length > 0 ? 
                `Redo: ${redoStack[redoStack.length - 1].action.replace('_', ' ')}` : 
                'Nothing to redo (Ctrl+Y)';
        }
    }
};

// Add keyboard shortcuts for undo/redo
document.addEventListener('keydown', function(e) {
    // Check if user is typing in an input field
    const activeElement = document.activeElement;
    const isInputField = activeElement && (
        activeElement.tagName === 'INPUT' || 
        activeElement.tagName === 'TEXTAREA' || 
        activeElement.tagName === 'SELECT'
    );
    
    // Don't trigger undo/redo if user is typing
    if (isInputField) return;
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        UndoRedoManager.undo();
    } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        UndoRedoManager.redo();
    }
});

document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        UndoRedoManager.undo();
    } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        UndoRedoManager.redo();
    }
});

function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };

    const dutyType = shift.duty_type;
    const isSleepover = dutyType && dutyType.name && 
        dutyType.name.toLowerCase().includes('sleepover');

    // Check if this shift falls on a public holiday
    const shiftDateKey = shift.date.split('T')[0]; // Ensure YYYY-MM-DD format
    const isPublicHoliday = publicHolidays.has(shiftDateKey);
    
    // Set the flag on the shift object for rendering
    shift.is_public_holiday = isPublicHoliday;
    if (isPublicHoliday) {
        const holiday = publicHolidays.get(shiftDateKey);
        shift.public_holiday_name = holiday.name;
    }

    // If it has times AND is a sleepover, calculate both
    if (isSleepover && shift.start_time && shift.end_time) {
        // This is BOTH active hours AND a sleepover
        
        // First calculate active hours
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const activeHours = (endTime - startTime) / (1000 * 60 * 60);
        
        // Apply penalty logic for active hours - PUBLIC HOLIDAY TAKES PRECEDENCE
        if (isPublicHoliday) {
            result.publicHoliday = activeHours;
        } else {
            const shiftDate = new Date(shift.date);
            const dayOfWeek = shiftDate.getDay();
            
            if (dayOfWeek === 6) {
                result.saturday = activeHours;
            } else if (dayOfWeek === 0) {
                result.sunday = activeHours;
            } else {
                const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
                Object.assign(result, weekdayBreakdown);
            }
        }
        
        // ADD the sleepover hours on top
        result.sleepover = 2; // Always 2 hours for sleepover
        result.total = activeHours + 2; // Total is active + sleepover
        
        console.log(`Combined shift on ${shift.date}: ${activeHours}h active + 2h sleepover = ${result.total}h total${isPublicHoliday ? ' (PUBLIC HOLIDAY: ' + shift.public_holiday_name + ')' : ''}`);
        
    } else if (isSleepover) {
        // Just a sleepover, no active hours
        result.sleepover = 2;
        result.total = 2;
        
    } else if (shift.start_time && shift.end_time) {
        // Just active hours, no sleepover
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const totalHours = (endTime - startTime) / (1000 * 60 * 60);
        result.total = totalHours;
        
        // Apply penalty logic - PUBLIC HOLIDAY TAKES PRECEDENCE
        if (isPublicHoliday) {
            result.publicHoliday = totalHours;
        } else {
            const shiftDate = new Date(shift.date);
            const dayOfWeek = shiftDate.getDay();
            
            if (dayOfWeek === 6) {
                result.saturday = totalHours;
            } else if (dayOfWeek === 0) {
                result.sunday = totalHours;
            } else {
                const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
                Object.assign(result, weekdayBreakdown);
            }
        }
    }
    
    return result;
}
        function splitWeekdayHours(startTime, endTime) {
            const result = {
                total: 0,
                weekdayDay: 0,      // 6am-8pm
                weekdayEvening: 0,  // 8pm-12am  
                weekdayNight: 0     // 12am-6am
            };

            const current = new Date(startTime);
            
            while (current < endTime) {
                // Calculate end of current period
                const nextPeriod = new Date(current);
                nextPeriod.setMinutes(current.getMinutes() + 30); // Calculate in 30-min increments for accuracy
                
                const periodEnd = nextPeriod > endTime ? endTime : nextPeriod;
                const periodHours = (periodEnd - current) / (1000 * 60 * 60);
                
                const hour = current.getHours();
                
                // Time period classification
                if (hour >= 6 && hour < 20) {
                    result.weekdayDay += periodHours;
                } else if (hour >= 20 && hour < 24) {
                    result.weekdayEvening += periodHours;
                } else {
                    result.weekdayNight += periodHours;
                }
                
                current.setTime(periodEnd.getTime());
            }

            result.total = result.weekdayDay + result.weekdayEvening + result.weekdayNight;
            return result;
        }

        // Update the calculateShiftPay function (around line 1050)
function calculateShiftPay(shift, hoursBreakdown) {
    // Get effective pay rate - FIXED LOGIC
    let payRate = null;
    
    // Check if there's a pay override
    if (shift.pay_override_id && shift.pay_override_id !== '00000000-0000-0000-0000-000000000002') {
        // Use the override rate
        payRate = shift.pay_override || payRates.find(pr => pr.id === shift.pay_override_id);
    } 
    
    // If no override OR if it's the standard rate placeholder, use staff's assigned rate
    if (!payRate || shift.pay_override_id === '00000000-0000-0000-0000-000000000002') {
        if (shift.staff && shift.staff.pay_rate_id) {
            payRate = payRates.find(pr => pr.id === shift.staff.pay_rate_id);
        }
    }
    
    // Final fallback
    if (!payRate) {
        console.warn(`No pay rate found for shift ${shift.id}, using zero rates`);
        payRate = {
            hourly_pay_rate: 0,
            afternoon: 0,
            night: 0,
            saturday: 0,
            sunday: 0,
            public_holiday: 0,
            sleepover: 0
        };
    }
    
    const baseRate = parseFloat(payRate.hourly_pay_rate) || 0;
    
    const totalPay = 
        (hoursBreakdown.weekdayDay * baseRate) +
        (hoursBreakdown.weekdayEvening * (parseFloat(payRate.afternoon) || baseRate)) +
        (hoursBreakdown.weekdayNight * (parseFloat(payRate.night) || baseRate)) +
        (hoursBreakdown.saturday * (parseFloat(payRate.saturday) || baseRate)) +
        (hoursBreakdown.sunday * (parseFloat(payRate.sunday) || baseRate)) +
        (hoursBreakdown.publicHoliday * (parseFloat(payRate.public_holiday) || baseRate)) +
        (hoursBreakdown.sleepover * (parseFloat(payRate.sleepover) / 2|| baseRate));

    return totalPay;
}

        
        // ========================================
        // FILTERING AND VIEW SWITCHING
        // ========================================
        function applyFilters() {
    console.log('=== APPLYING FILTERS ===');
    
    const startDate = document.getElementById('startDate')?.value;
    const endDate = document.getElementById('endDate')?.value;
    const statusFilter = document.getElementById('statusFilter')?.value;

    // Store filters globally for all views to access
    window.currentFilters = {
        startDate: startDate,
        endDate: endDate,
        staffId: staffFilterValue,
        participantId: participantFilterValue,
        status: statusFilter
    };

    console.log('Filter values:', window.currentFilters);

    // Apply filters to shifts
    filteredShifts = shifts.filter(shift => {
        if (startDate && shift.date < startDate) return false;
        if (endDate && shift.date > endDate) return false;
        if (staffFilterValue && shift.staff_id !== staffFilterValue) return false;
        if (participantFilterValue && shift.participant_id !== participantFilterValue) return false;
        if (statusFilter && shift.status !== statusFilter) return false;
        return true;
    });

    console.log('Filtered result:', filteredShifts.length, 'shifts');
    renderCurrentView();
}

function renderCurrentView() {
    switch(currentView) {
        case 'table':
            renderTable();
            break;
        case 'requests':
            renderRequests();
            break;
        case 'summary':
            renderclockinlogs();
            break;
        case 'timesheet':
            renderTimesheet();
            break;
        case 'conflicts':
            renderConflicts();
            break;
        case 'notes':
            renderNotes(1);  // Start at page 1 with filters
            break;
        case 'availability':
            renderAvailability();
            break;
        case 'templates':
            if (typeof loadTemplates === 'function') {
                loadTemplates();
            }
            break;
        case 'staff':
            if (typeof renderStaffView === 'function') {
                renderStaffView();
            }
            break;
        case 'assignments':
            renderAssignments();
            break;
    }
}

function switchView(view) {
    currentView = view;
    
    // Update buttons
    document.querySelectorAll('.view-toggle button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Handle different button ID patterns
    const activeBtn = document.getElementById(`${view}ViewBtn`) || 
                     document.querySelector(`[data-view="${view}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }

    // Hide ALL view contents
    document.querySelectorAll('.view-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
    });
    
    // Show the selected view
    const activeView = document.getElementById(`${view}View`) || 
                      document.getElementById(`${view}sView`);  // Handle 'templates' -> 'templatesView'
    
    if (activeView) {
        activeView.classList.add('active');
        activeView.style.display = 'block';
    }

    // Render the appropriate view
    switch(view) {
        case 'table':
            renderTable();
            break;
        case 'requests':
            renderRequests();
            break;
        case 'summary':
            renderclockinlogs();
            break;
        case 'timesheet':
            renderTimesheet();
            break;
        case 'conflicts':
            renderConflicts();
            break;
        case 'notes':
            renderNotes(1);  // Start at page 1
            break;
        case 'availability':
            renderAvailability();
            break;
        case 'templates':
            if (typeof loadTemplates === 'function') {
                loadTemplates();
            }
            break;
        case 'staff':
            if (typeof renderStaffView === 'function') {
                renderStaffView();
            }
            break;
        case 'assignments':
            if (typeof initAssignmentManager === 'function') {
                console.log('Calling initAssignmentManager...');
                initAssignmentManager();
            } else {
                console.error('initAssignmentManager function not found');
            }
            break;
        case 'participants':
            // Load participants table
            if (typeof loadParticipantsTable === 'function') {
                loadParticipantsTable();
            } else {
                console.error('loadParticipantsTable function not found');
            }
            // Load Google Maps if not already loaded
            if (typeof loadGoogleMapsScript === 'function') {
                loadGoogleMapsScript();
            }
            case 'documents':
    if (typeof EnhancedDocumentManager !== 'undefined') {
        EnhancedDocumentManager.init();
    }
    break;

    default:
        console.log('Unknown view:', view);
        break;
}
}

//PARTICIPANTS SECTION
function attachParticipantButtonListeners() {
    // Remove any existing listeners to avoid duplicates
    document.querySelectorAll('.participant-edit-btn').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            console.log('Edit participant ID:', id);
            if (id && id !== 'undefined') {
                editParticipant(id);
            } else {
                console.error('Invalid participant ID for edit');
                alert('Error: Invalid participant ID');
            }
        };
    });
    
    document.querySelectorAll('.participant-location-btn').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            console.log('View location for participant ID:', id);
            if (id && id !== 'undefined') {
                viewParticipantLocation(id);
            } else {
                console.error('Invalid participant ID for location');
                alert('Error: Invalid participant ID');
            }
        };
    });
    
    document.querySelectorAll('.participant-docs-btn').forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute('data-id');
            console.log('View documents for participant ID:', id);
            if (id && id !== 'undefined') {
                viewParticipantDocuments(id);
            } else {
                console.error('Invalid participant ID for documents');
                alert('Error: Invalid participant ID');
            }
        };
    });
}

// Also update loadParticipantsTable to check the data structure
async function loadParticipantsTable() {
    try {
        const tbody = document.getElementById('participantsTableBody');
        tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div><span>Loading participants...</span></td></tr>';
        
        const { data, error } = await supabaseClient
            .from('participants')
            .select('*')
            .order('first_name');

        if (error) throw error;
        
        console.log('Loaded participants data:', data); // Debug log
        
        // Check if data has the expected structure
        if (data && data.length > 0) {
            console.log('First participant structure:', data[0]);
            console.log('First participant ID:', data[0].id);
        }
        
        participantsData = data || [];
        displayParticipantsTable(data);
    } catch (error) {
        console.error('Error loading participants:', error);
        document.getElementById('participantsTableBody').innerHTML = 
            '<tr><td colspan="7" style="text-align: center; color: red;">Failed to load participants: ' + error.message + '</td></tr>';
    }
}

// Filter participants
function filterParticipants() {
    const searchTerm = document.getElementById('participantSearch').value.toLowerCase();
    const statusFilter = document.getElementById('participantStatusFilter').value;
    const serviceFilter = document.getElementById('participantServiceFilter').value;

    const filtered = participantsData.filter(participant => {
        const matchesSearch = !searchTerm || 
            `${participant.first_name} ${participant.last_name}`.toLowerCase().includes(searchTerm) ||
            (participant.ndis_number && participant.ndis_number.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || participant.status === statusFilter;
        const matchesService = !serviceFilter || participant.service_type === serviceFilter;

        return matchesSearch && matchesStatus && matchesService;
    });

    displayParticipantsTable(filtered);
}

// Clear participant filters
function clearParticipantFilters() {
    document.getElementById('participantSearch').value = '';
    document.getElementById('participantStatusFilter').value = '';
    document.getElementById('participantServiceFilter').value = '';
    displayParticipantsTable(participantsData);
}

// Open participant modal

// Close modal using your existing function
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    if (modalId === 'participantModal') {
        currentParticipantId = null;
        participantMap = null;
        participantMarker = null;
        geofenceCircle = null;
    }
}

// Switch participant tabs
function switchParticipantTab(tabName, event) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
    });
    
    const tabContent = document.getElementById(`${tabName}Tab`);
    if (tabContent) {
        tabContent.style.display = 'block';
        tabContent.classList.add('active');
    }
    
    // Initialize map if switching to location tab
    if (tabName === 'location' && !participantMap) {
        setTimeout(() => initParticipantMap(), 100);
    }
}

async function saveParticipant(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const participantData = Object.fromEntries(formData);
    
    // FIX: Convert empty strings to null for date fields
    const dateFields = ['date_of_birth', 'plan_start_date', 'plan_end_date'];
    dateFields.forEach(field => {
        if (participantData[field] === '' || participantData[field] === undefined) {
            participantData[field] = null;
        }
    });
    
    // Also clean up any other empty string fields that might cause issues
    Object.keys(participantData).forEach(key => {
        if (participantData[key] === '') {
            // Check if this field name contains 'date' or ends with '_date'
            if (key.includes('date') || key.endsWith('_at')) {
                participantData[key] = null;
            }
        }
    });
    
    // Map form fields to database fields
    if (participantData.ndis_number) {
        participantData.ndis_participant_number = participantData.ndis_number;
        delete participantData.ndis_number;
    }
    
    // Map form field names to database column names
const fieldMapping = {
    'latitude': 'location_lat',
    'longitude': 'location_lng',
    'ndis_number': 'ndis_participant_number'
};

// Apply mapping
Object.keys(fieldMapping).forEach(formField => {
    if (participantData.hasOwnProperty(formField)) {
        const dbField = fieldMapping[formField];
        participantData[dbField] = participantData[formField];
        delete participantData[formField];
    }
});

// Parse numeric values
if (participantData.location_lat) {
    participantData.location_lat = parseFloat(participantData.location_lat) || null;
}
if (participantData.location_lng) {
    participantData.location_lng = parseFloat(participantData.location_lng) || null;
}
    
    // Add geofence radius
    const geofenceRadius = document.getElementById('geofenceRadius').value;
    if (geofenceRadius) {
        participantData.geofence_radius = parseInt(geofenceRadius) || null;
    }
    
    console.log('Saving participant with data:', participantData);
    
    try {
        let result;
        
        if (currentParticipantId) {
            result = await supabaseClient
                .from('participants')
                .update(participantData)
                .eq('id', currentParticipantId)
                .select()
                .single();
        } else {
            result = await supabaseClient
                .from('participants')
                .insert([participantData])
                .select()
                .single();
        }

        if (result.error) throw result.error;

        const participantId = currentParticipantId || result.data.id;
        await saveParticipantMedications(participantId);
        await saveEmergencyContacts(participantId);

        alert('Participant saved successfully!');
        closeModal('participantModal');
        loadParticipantsTable();

    } catch (error) {
        console.error('Error saving participant:', error);
        alert('Failed to save participant: ' + error.message);
    }
}

// Add helper functions
function editParticipant(id) {
    openParticipantModal(id);
}

function viewParticipantLocation(id) {
    // Open modal and switch to location tab
    openParticipantModal(id);
    setTimeout(() => {
        const locationBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.textContent === 'Location');
        if (locationBtn) {
            switchParticipantTab('location', { target: locationBtn });
        }
    }, 100);
}

function viewParticipantDocuments(id) {
    // Open modal and switch to documents tab
    openParticipantModal(id);
    setTimeout(() => {
        const docsBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.textContent === 'Documents');
        if (docsBtn) {
            switchParticipantTab('documents', { target: docsBtn });
        }
    }, 100);
}

function showParticipantMapOverview() {
    alert('Map overview feature coming soon!');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load Google Maps if on participants view
    if (document.getElementById('participantsView')?.style.display !== 'none') {
        loadGoogleMapsScript();
    }
});

// ADD THESE HELPER FUNCTIONS TO YOUR mc-manager.html

// ==================== DATA LOADING FUNCTIONS ====================

// ============ PART 1: FIX COORDINATE FIELD NAMES ============

// UPDATE your initParticipantAutocomplete to use correct field names
function initParticipantAutocomplete() {
    if (!window.google || !window.google.maps || !window.google.maps.places) {
        console.warn('Google Maps not loaded yet, skipping autocomplete initialization');
        return;
    }
    
    const input = document.getElementById('addressAutocomplete');
    if (!input) return;

    autocomplete = new google.maps.places.Autocomplete(input, {
        componentRestrictions: { country: 'au' },
        fields: ['address_components', 'geometry', 'formatted_address']
    });

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        // Parse address components
        let streetNumber = '';
        let streetName = '';
        let suburb = '';
        let state = '';
        let postcode = '';

        place.address_components.forEach(component => {
            const types = component.types;
            if (types.includes('street_number')) streetNumber = component.long_name;
            if (types.includes('route')) streetName = component.long_name;
            if (types.includes('locality')) suburb = component.long_name;
            if (types.includes('administrative_area_level_1')) state = component.short_name;
            if (types.includes('postal_code')) postcode = component.long_name;
        });

        // Populate address fields
        document.getElementById('streetNumber').value = streetNumber;
        document.getElementById('streetName').value = streetName;
        document.getElementById('suburb').value = suburb;
        document.getElementById('state').value = state;
        document.getElementById('postcode').value = postcode;
        
        // FIX: Use location_lat and location_lng (your actual field names)
        document.getElementById('latitude').value = place.geometry.location.lat();
        document.getElementById('longitude').value = place.geometry.location.lng();
        
        // Also update the map if visible
        if (document.getElementById('locationTab').classList.contains('active')) {
            updateParticipantMap();
        }
    });
}

async function loadParticipantData(participantId) {
    try {
        const { data, error } = await supabaseClient
            .from('participants')
            .select('*')
            .eq('id', participantId)
            .single();

        if (error) throw error;

        console.log('Loading participant data:', data);

        // SAFE FIELD SETTING - Only set if element exists
        const setFieldValue = (elementId, value) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value || '';
            } else {
                console.warn(`Field not found: ${elementId}`);
            }
        };

        // Basic Information
        setFieldValue('firstName', data.first_name);
        setFieldValue('lastName', data.last_name);
        setFieldValue('preferredName', data.preferred_name);
        setFieldValue('dateOfBirth', data.date_of_birth);
        setFieldValue('ndisNumber', data.ndis_participant_number);
        
        // Service Information
        setFieldValue('serviceType', data.service_type);
        setFieldValue('participantPhone', data.phone);
        setFieldValue('participantEmail', data.email);
        setFieldValue('participantStatus', data.status);
        
        // Plan Information
        setFieldValue('planStartDate', data.plan_start_date);
        setFieldValue('planEndDate', data.plan_end_date);
        setFieldValue('planManager', data.plan_manager);
        
        // Address Fields
        setFieldValue('unitNumber', data.unit_number);
        setFieldValue('streetNumber', data.street_number);
        setFieldValue('streetName', data.street_name);
        setFieldValue('suburb', data.suburb);
        setFieldValue('state', data.state);
        setFieldValue('postcode', data.postcode);
        setFieldValue('country', data.country || 'Australia');
        
        // Location coordinates (using your actual field names)
        setFieldValue('latitude', data.location_lat);
        setFieldValue('longitude', data.location_lng);
        setFieldValue('geofenceRadius', data.geofence_radius || 100);
        
        // Notes
        setFieldValue('participantNotes', data.notes);
        
        // Medical fields
        setFieldValue('medicareNumber', data.medicare_number);
        setFieldValue('privateHealth', data.private_health);
        setFieldValue('gpName', data.gp_name);
        setFieldValue('gpPhone', data.gp_phone);
        setFieldValue('medicalConditions', data.medical_conditions);
        setFieldValue('allergies', data.allergies);
        setFieldValue('dietaryRequirements', data.dietary_requirements);
        
        // Primary Contact
        setFieldValue('primaryContactName', data.primary_contact_name);
        setFieldValue('primaryContactRelationship', data.primary_contact_relationship);
        setFieldValue('primaryContactPhone', data.primary_contact_phone);
        setFieldValue('primaryContactEmail', data.primary_contact_email);

        // Log any database fields that don't have form fields
        Object.keys(data).forEach(key => {
            if (!['id', 'created_at', 'updated_at', 'user_id'].includes(key)) {
                const camelCase = key.replace(/_([a-z])/g, g => g[1].toUpperCase());
                const element = document.getElementById(camelCase);
                if (!element && key !== 'ndis_participant_number' && key !== 'location_lat' && key !== 'location_lng') {
                    console.log(`Database field '${key}' has no form field`);
                }
            }
        });

        // Load related data - with error handling
        try {
            await loadParticipantMedications(participantId);
        } catch (e) {
            console.error('Error loading medications:', e);
        }
        
        try {
            await loadEmergencyContacts(participantId);
        } catch (e) {
            console.error('Error loading emergency contacts:', e);
        }
        
        try {
            await loadParticipantDocuments(participantId);
        } catch (e) {
            console.error('Error loading documents:', e);
        }
        
        try {
            await loadAssignedStaff(participantId);
        } catch (e) {
            console.error('Error loading staff:', e);
        }

    } catch (error) {
        console.error('Error loading participant:', error);
        // Don't show alert - let modal still open
        // alert('Failed to load some participant data');
    }
}

// ==================== MEDICATION FUNCTIONS ====================

// Add medication row


// Remove medication row
function removeMedicationRow(rowId) {
    const row = document.getElementById(rowId);
    if (row) row.remove();
}

// Load medications
async function loadParticipantMedications(participantId) {
    try {
        const { data, error } = await supabaseClient
            .from('participant_medications')
            .select('*')
            .eq('participant_id', participantId)
            .eq('is_active', true);

        if (error) throw error;

        const tbody = document.getElementById('medicationsTableBody');
        tbody.innerHTML = '';
        
        data.forEach(med => {
            const rowId = `med_${med.id}`;
            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td><input type="text" class="med-name" value="${med.medication_name || ''}" style="width: 100%;"></td>
                <td><input type="text" class="med-dosage" value="${med.dosage || ''}" style="width: 100%;"></td>
                <td><input type="text" class="med-frequency" value="${med.frequency || ''}" style="width: 100%;"></td>
                <td><input type="text" class="med-prescriber" value="${med.prescriber || ''}" style="width: 100%;"></td>
                <td><input type="date" class="med-start-date" value="${med.start_date || ''}" style="width: 100%;"></td>
                <td>
                    <button type="button" class="btn-icon-only" onclick="removeMedicationRow('${rowId}')">❌</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading medications:', error);
    }
}

// Save medications
async function saveParticipantMedications(participantId) {
    const rows = document.querySelectorAll('#medicationsTableBody tr');
    const medications = [];

    rows.forEach(row => {
        const name = row.querySelector('.med-name')?.value;
        if (name) {
            medications.push({
                participant_id: participantId,
                medication_name: name,
                dosage: row.querySelector('.med-dosage')?.value || null,
                frequency: row.querySelector('.med-frequency')?.value || null,
                prescriber: row.querySelector('.med-prescriber')?.value || null,
                start_date: row.querySelector('.med-start-date')?.value || null,
                is_active: true
            });
        }
    });

    if (medications.length > 0) {
        // Delete existing medications
        await supabaseClient
            .from('participant_medications')
            .delete()
            .eq('participant_id', participantId);

        // Insert new medications
        const { error } = await supabaseClient
            .from('participant_medications')
            .insert(medications);

        if (error) console.error('Error saving medications:', error);
    }
}

// ==================== EMERGENCY CONTACT FUNCTIONS ====================

// Add emergency contact

// Remove emergency contact
function removeEmergencyContact(contactId) {
    const element = document.getElementById(contactId);
    if (element) element.remove();
}

// Load emergency contacts
async function loadEmergencyContacts(participantId) {
    try {
        const { data, error } = await supabaseClient
            .from('participant_emergency_contacts')
            .select('*')
            .eq('participant_id', participantId);

        if (error) throw error;

        const container = document.getElementById('emergencyContactsList');
        container.innerHTML = '';
        
        data.forEach(contact => {
            const contactId = `contact_${contact.id}`;
            const contactDiv = document.createElement('div');
            contactDiv.className = 'emergency-contact-item';
            contactDiv.id = contactId;
            contactDiv.innerHTML = `
                <h4>
                    Emergency Contact
                    <button type="button" class="btn-icon-only" onclick="removeEmergencyContact('${contactId}')">❌</button>
                </h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="ec-name" value="${contact.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Relationship</label>
                        <input type="text" class="ec-relationship" value="${contact.relationship || ''}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" class="ec-phone" value="${contact.phone || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="ec-email" value="${contact.email || ''}">
                    </div>
                </div>
            `;
            container.appendChild(contactDiv);
        });
    } catch (error) {
        console.error('Error loading emergency contacts:', error);
    }
}

// Save emergency contacts
async function saveEmergencyContacts(participantId) {
    const contactElements = document.querySelectorAll('.emergency-contact-item');
    const contacts = [];

    contactElements.forEach(element => {
        const name = element.querySelector('.ec-name')?.value;
        if (name) {
            contacts.push({
                participant_id: participantId,
                name: name,
                relationship: element.querySelector('.ec-relationship')?.value || null,
                phone: element.querySelector('.ec-phone')?.value || null,
                email: element.querySelector('.ec-email')?.value || null,
                is_primary: false
            });
        }
    });

    if (contacts.length > 0) {
        // Delete existing contacts
        await supabaseClient
            .from('participant_emergency_contacts')
            .delete()
            .eq('participant_id', participantId);

        // Insert new contacts
        const { error } = await supabaseClient
            .from('participant_emergency_contacts')
            .insert(contacts);

        if (error) console.error('Error saving emergency contacts:', error);
    }
}

// ==================== LOCATION FUNCTIONS ====================

// Load Google Maps Script (FIXED)
function loadGoogleMapsScript() {
    // Check if already loaded or loading
    if (window.google && window.google.maps) {
        console.log('Google Maps already loaded');
        return;
    }
    
    // Check if script is already being loaded
    if (document.querySelector('script[src*="maps.googleapis.com"]')) {
        console.log('Google Maps script already in DOM');
        return;
    }
    
    // Only load if API key is set
    if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY === 'YOUR_API_KEY_HERE') {
        console.warn('Google Maps API key not configured');
        return;
    }
    
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&callback=initGoogleMaps`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}

// Initialize Google Maps (FIXED)
window.initGoogleMaps = function() {
    console.log('Google Maps API loaded and ready');
    // Set a flag to indicate maps is ready
    window.googleMapsReady = true;
}

function initParticipantAutocomplete() {
    if (!window.google || !window.google.maps || !window.google.maps.places) {
        console.warn('Google Maps not loaded yet, skipping autocomplete initialization');
        return;
    }
    
    const input = document.getElementById('addressAutocomplete');
    if (!input) return;

    autocomplete = new google.maps.places.Autocomplete(input, {
        componentRestrictions: { country: 'au' },
        fields: ['address_components', 'geometry', 'formatted_address']
    });

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        // Parse address components
        let streetNumber = '';
        let streetName = '';
        let suburb = '';
        let state = '';
        let postcode = '';

        place.address_components.forEach(component => {
            const types = component.types;
            if (types.includes('street_number')) streetNumber = component.long_name;
            if (types.includes('route')) streetName = component.long_name;
            if (types.includes('locality')) suburb = component.long_name;
            if (types.includes('administrative_area_level_1')) state = component.short_name;
            if (types.includes('postal_code')) postcode = component.long_name;
        });

        // Populate address fields
        document.getElementById('streetNumber').value = streetNumber;
        document.getElementById('streetName').value = streetName;
        document.getElementById('suburb').value = suburb;
        document.getElementById('state').value = state;
        document.getElementById('postcode').value = postcode;
        
        // FIX: Use location_lat and location_lng (your actual field names)
        document.getElementById('latitude').value = place.geometry.location.lat();
        document.getElementById('longitude').value = place.geometry.location.lng();
        
        // Also update the map if visible
        if (document.getElementById('locationTab').classList.contains('active')) {
            updateParticipantMap();
        }
    });
}

// Initialize Participant Map (FIXED)
function initParticipantMap() {
    if (!window.google || !window.google.maps) {
        console.warn('Google Maps not loaded yet');
        return;
    }
    
    const mapContainer = document.getElementById('participantMap');
    if (!mapContainer) return;

    // Get coordinates from form (which are populated from location_lat/location_lng)
    const lat = parseFloat(document.getElementById('latitude').value) || -33.8688;
    const lng = parseFloat(document.getElementById('longitude').value) || 151.2093;
    
    participantMap = new google.maps.Map(mapContainer, {
        center: { lat, lng },
        zoom: 15,
        mapTypeControl: false,
        streetViewControl: false
    });

    participantMarker = new google.maps.Marker({
        position: { lat, lng },
        map: participantMap,
        draggable: true,
        title: 'Participant Location'
    });

    const radius = parseInt(document.getElementById('geofenceRadius').value) || 100;
    geofenceCircle = new google.maps.Circle({
        map: participantMap,
        center: { lat, lng },
        radius: radius,
        fillColor: '#4285F4',
        fillOpacity: 0.2,
        strokeColor: '#4285F4',
        strokeOpacity: 0.8,
        strokeWeight: 2
    });

    // Update form fields when marker is dragged
    participantMarker.addListener('dragend', () => {
        const position = participantMarker.getPosition();
        document.getElementById('latitude').value = position.lat();
        document.getElementById('longitude').value = position.lng();
        geofenceCircle.setCenter(position);
    });
}

// ==================== DISPLAY PARTICIPANTS TABLE FIX ====================

function displayParticipantsTable(participants) {
    const tbody = document.getElementById('participantsTableBody');
    
    if (!participants || participants.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No participants found</td></tr>';
        return;
    }

    tbody.innerHTML = participants.map((participant, index) => {
        // Store participant in global array for safe access
        participantsData[index] = participant;
        
        // Check if participant has an ID
        const participantId = participant.id || participant.participant_id || index;
        
        // Debug log
        console.log(`Participant ${index}:`, participant);
        
        const statusClass = `status-${participant.status || 'active'}`;
        const statusText = participant.status ? 
            participant.status.charAt(0).toUpperCase() + participant.status.slice(1) : 
            'Active';
        
        // Create safe display values
        const firstName = participant.first_name || '';
        const lastName = participant.last_name || '';
        const ndisNumber = participant.ndis_number || 'N/A';
        const serviceType = participant.service_type || 'N/A';
        const suburb = participant.suburb || 'N/A';
        const state = participant.state || '';
        const primaryContactName = participant.primary_contact_name || 'N/A';
        const primaryContactPhone = participant.primary_contact_phone || '';
        const dob = participant.date_of_birth ? new Date(participant.date_of_birth).toLocaleDateString() : 'N/A';
        
        return `
            <tr data-participant-id="${participantId}">
                <td>
                    <div style="font-weight: 500;">
                        ${firstName} ${lastName}
                    </div>
                    <div style="font-size: 0.85rem; color: #666;">
                        DOB: ${dob}
                    </div>
                </td>
                <td>${ndisNumber}</td>
                <td>${serviceType}</td>
                <td>
                    <div style="font-size: 0.9rem;">
                        ${suburb}${state ? ', ' + state : ''}
                    </div>
                </td>
                <td>
                    ${primaryContactName}
                    ${primaryContactPhone ? '<br><small>' + primaryContactPhone + '</small>' : ''}
                </td>
                <td>
                    <span class="participant-status-badge ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td>
                    <button class="btn btn-outline btn-sm participant-edit-btn" data-id="${participantId}" style="padding: 4px 8px; margin: 2px;">
                        Edit
                    </button>
                    <button class="btn btn-outline btn-sm participant-location-btn" data-id="${participantId}" style="padding: 4px 8px; margin: 2px;">
                        Location
                    </button>
                    <button class="btn btn-outline btn-sm participant-docs-btn" data-id="${participantId}" style="padding: 4px 8px; margin: 2px;">
                        Docs
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // Add event listeners after creating the HTML
    attachParticipantButtonListeners();
}


// ==================== OTHER BUTTON FIXES ====================

// Add medication row (FIXED - removed emoji)
function addMedicationRow() {
    const tbody = document.getElementById('medicationsTableBody');
    const rowId = `med_${Date.now()}`;
    
    const newRow = document.createElement('tr');
    newRow.id = rowId;
    newRow.innerHTML = `
        <td><input type="text" class="med-name" placeholder="Medication name" style="width: 100%;"></td>
        <td><input type="text" class="med-dosage" placeholder="e.g., 10mg" style="width: 100%;"></td>
        <td><input type="text" class="med-frequency" placeholder="e.g., Twice daily" style="width: 100%;"></td>
        <td><input type="text" class="med-prescriber" placeholder="Doctor name" style="width: 100%;"></td>
        <td><input type="date" class="med-start-date" style="width: 100%;"></td>
        <td>
            <button type="button" class="btn btn-outline btn-sm" onclick="removeMedicationRow('${rowId}')" style="padding: 4px 8px;">
                Remove
            </button>
        </td>
    `;
    tbody.appendChild(newRow);
}

// Add emergency contact (FIXED - removed emoji)
function addEmergencyContact() {
    const container = document.getElementById('emergencyContactsList');
    const contactId = `contact_${Date.now()}`;
    
    const contactDiv = document.createElement('div');
    contactDiv.className = 'emergency-contact-item';
    contactDiv.id = contactId;
    contactDiv.innerHTML = `
        <h4>
            Emergency Contact
            <button type="button" class="btn btn-outline btn-sm" onclick="removeEmergencyContact('${contactId}')" style="padding: 4px 8px;">
                Remove
            </button>
        </h4>
        <div class="form-row">
            <div class="form-group">
                <label>Name</label>
                <input type="text" class="ec-name" required>
            </div>
            <div class="form-group">
                <label>Relationship</label>
                <input type="text" class="ec-relationship">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" class="ec-phone" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" class="ec-email">
            </div>
        </div>
    `;
    container.appendChild(contactDiv);
}

// Load documents (FIXED - removed emoji)
async function loadParticipantDocuments(participantId) {
    try {
        const { data, error } = await supabaseClient
            .from('participant_documents')
            .select('*')
            .eq('participant_id', participantId)
            .order('uploaded_at', { ascending: false });

        if (error) throw error;

        const tbody = document.getElementById('documentsTableBody');
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No documents uploaded</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(doc => `
            <tr>
                <td>${doc.document_name}</td>
                <td>${formatDocumentType(doc.document_type)}</td>
                <td>${new Date(doc.uploaded_at).toLocaleDateString()}</td>
                <td>${doc.expiry_date ? new Date(doc.expiry_date).toLocaleDateString() : 'N/A'}</td>
                <td>
                    <button class="btn btn-outline btn-sm" onclick="viewDocument('${doc.file_url}')" title="View" style="padding: 4px 8px; margin: 2px;">
                        View
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="deleteDocument(${doc.id})" title="Delete" style="padding: 4px 8px; margin: 2px;">
                        Delete
                    </button>
                </td>
            </tr>
        `).join('');

    } catch (error) {
        console.error('Error loading documents:', error);
    }
}

async function openParticipantModal(participantId = null) {
    currentParticipantId = participantId;
    const modal = document.getElementById('participantModal');
    const form = document.getElementById('participantForm');
    
    // Show modal immediately with loading state
    modal.style.display = 'flex';
    
    // Show loading overlay
    const modalContent = modal.querySelector('.modal-content');
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'modalLoadingOverlay';
    loadingOverlay.className = 'loading-overlay';
    loadingOverlay.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <div>Loading participant data...</div>
        </div>
    `;
    modalContent.appendChild(loadingOverlay);
    
    try {
        // Reset form and tabs
        form.reset();
        document.getElementById('participantId').value = participantId || '';
        
        // Reset to first tab
        document.querySelectorAll('.tab-btn').forEach((btn, index) => {
            btn.classList.toggle('active', index === 0);
        });
        document.querySelectorAll('.tab-content').forEach((content, index) => {
            content.style.display = index === 0 ? 'block' : 'none';
            content.classList.toggle('active', index === 0);
        });
        
        // Clear dynamic content
        document.getElementById('medicationsTableBody').innerHTML = '';
        document.getElementById('emergencyContactsList').innerHTML = '';
        document.getElementById('documentsTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center;">No documents uploaded</td></tr>';
        
        // Update title
        document.getElementById('participantModalTitle').textContent = participantId ? 'Edit Participant' : 'Add Participant';
        
        if (participantId) {
            await loadParticipantData(participantId);
        }
        
        // Initialize autocomplete after modal is visible
        if (window.googleMapsReady) {
            setTimeout(() => {
                initParticipantAutocomplete();
            }, 100);
        }
        
    } catch (error) {
        console.error('Error opening participant modal:', error);
        alert('Failed to load participant data: ' + error.message);
    } finally {
        // Remove loading overlay
        const overlay = document.getElementById('modalLoadingOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
}
function getCurrentLocation() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Update form fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // Update map if initialized
            if (participantMap) {
                const pos = { lat, lng };
                participantMap.setCenter(pos);
                participantMarker.setPosition(pos);
                geofenceCircle.setCenter(pos);
            } else {
                initParticipantMap();
            }
            
            // NO LONGER LOGGING TO location_logs table
            alert('Location updated successfully');
        },
        (error) => {
            console.error('Error getting location:', error);
            alert('Failed to get current location');
        },
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

// Update geofence
function updateGeofence() {
    if (!geofenceCircle) return;
    const radius = parseInt(document.getElementById('geofenceRadius').value) || 100;
    geofenceCircle.setRadius(radius);
}


// ==================== DOCUMENT FUNCTIONS ====================

// Upload document
async function uploadDocument() {
    const fileInput = document.getElementById('documentFile');
    const documentType = document.getElementById('documentType').value;
    const documentName = document.getElementById('documentName').value;
    const documentExpiry = document.getElementById('documentExpiry').value;
    
    if (!fileInput.files[0]) {
        alert('Please select a file to upload');
        return;
    }
    
    if (!documentType || !documentName) {
        alert('Please provide document type and name');
        return;
    }
    
    try {
        const file = fileInput.files[0];
        const fileName = `${currentParticipantId}/${Date.now()}_${file.name}`;
        
        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
            .from('participant-documents')
            .upload(fileName, file);
        
        if (error) throw error;
        
        // Save document record
        const { error: docError } = await supabaseClient
            .from('participant_documents')
            .insert([{
                participant_id: currentParticipantId,
                document_type: documentType,
                document_name: documentName,
                file_url: data.path,
                expiry_date: documentExpiry || null,
                uploaded_by: getCurrentUserId(),
                uploaded_at: new Date().toISOString()
            }]);
        
        if (docError) throw docError;
        
        alert('Document uploaded successfully');
        
        // Reload documents
        await loadParticipantDocuments(currentParticipantId);
        
        // Clear form
        fileInput.value = '';
        document.getElementById('documentType').value = '';
        document.getElementById('documentName').value = '';
        document.getElementById('documentExpiry').value = '';
        
    } catch (error) {
        console.error('Error uploading document:', error);
        alert('Failed to upload document');
    }
}

// Load documents

// View document
async function viewDocument(fileUrl) {
    try {
        const { data } = supabaseClient.storage
            .from('participant-documents')
            .getPublicUrl(fileUrl);
        
        window.open(data.publicUrl, '_blank');
    } catch (error) {
        console.error('Error viewing document:', error);
        alert('Failed to open document');
    }
}

// Delete document
async function deleteDocument(documentId) {
    if (!confirm('Are you sure you want to delete this document?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('participant_documents')
            .delete()
            .eq('id', documentId);
        
        if (error) throw error;
        
        alert('Document deleted successfully');
        await loadParticipantDocuments(currentParticipantId);
        
    } catch (error) {
        console.error('Error deleting document:', error);
        alert('Failed to delete document');
    }
}

// Filter documents
function filterDocuments(searchTerm) {
    const rows = document.querySelectorAll('#documentsTableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
    });
}

// ==================== STAFF ASSIGNMENT FUNCTIONS ====================

async function loadAssignedStaff(participantId) {
    try {
        // First, load all staff for the dropdown
        const { data: staffData } = await supabaseClient
            .from('staff')
            .select('id, first_name, last_name')
            .order('first_name');
        
        if (staffData) {
            const staffSelect = document.getElementById('staffToAdd');
            if (staffSelect) {
                staffSelect.innerHTML = '<option value="">Select Staff</option>' +
                    staffData.map(staff => `
                        <option value="${staff.id}">${staff.first_name} ${staff.last_name}</option>
                    `).join('');
            }
        }
        
        // Try the existing table name first: staff_participant_assignments
        let assignmentData;
        let assignmentError;
        
        // Try staff_participant_assignments first (existing table)
        const result1 = await supabaseClient
            .from('staff_participant_assignments')
            .select('*, staff:staff_id(first_name, last_name)')
            .eq('participant_id', participantId)
            .eq('is_active', true);
        
        if (!result1.error) {
            assignmentData = result1.data;
        } else {
            // If that fails, try participant_staff_assignments (new table)
            const result2 = await supabaseClient
                .from('participant_staff_assignments')
                .select('*, staff:staff_id(first_name, last_name)')
                .eq('participant_id', participantId)
                .eq('is_active', true);
            
            if (!result2.error) {
                assignmentData = result2.data;
            } else {
                assignmentError = result1.error; // Use the first error
            }
        }
        
        if (assignmentError) {
            console.error('Error loading staff assignments:', assignmentError);
            // Don't throw - just show empty state
        }
        
        const tbody = document.getElementById('assignedStaffTable');
        if (!tbody) return;
        
        if (!assignmentData || assignmentData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No staff assigned</td></tr>';
            return;
        }
        
        tbody.innerHTML = assignmentData.map(assignment => `
            <tr>
                <td>${assignment.staff ? `${assignment.staff.first_name} ${assignment.staff.last_name}` : 'Unknown'}</td>
                <td>${assignment.role || 'Support Worker'}</td>
                <td>${assignment.is_primary ? 'Yes' : 'No'}</td>
                <td>
                    <button class="btn btn-outline btn-sm" onclick="removeStaffAssignment(${assignment.id})" title="Remove" style="padding: 4px 8px;">
                        Remove
                    </button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading staff assignments:', error);
    }
}

// Update assignStaff to try both table names
async function assignStaff() {
    const staffId = document.getElementById('staffToAdd').value;
    if (!staffId || !currentParticipantId) {
        alert('Please select a staff member');
        return;
    }
    
    try {
        // Try staff_participant_assignments first (existing table)
        let result = await supabaseClient
            .from('staff_participant_assignments')
            .insert([{
                participant_id: currentParticipantId,
                staff_id: staffId,
                role: 'Support Worker',
                is_primary: false,
                is_active: true
            }]);
        
        // If that fails, try participant_staff_assignments (new table)
        if (result.error && result.error.code === 'PGRST205') {
            result = await supabaseClient
                .from('participant_staff_assignments')
                .insert([{
                    participant_id: currentParticipantId,
                    staff_id: staffId,
                    role: 'Support Worker',
                    is_primary: false,
                    is_active: true
                }]);
        }
        
        if (result.error) throw result.error;
        
        await loadAssignedStaff(currentParticipantId);
        document.getElementById('staffToAdd').value = '';
        
    } catch (error) {
        console.error('Error assigning staff:', error);
        alert('Failed to assign staff: ' + error.message);
    }
}

// Update removeStaffAssignment to try both table names
async function removeStaffAssignment(assignmentId) {
    if (!confirm('Remove this staff assignment?')) return;
    
    try {
        // Try staff_participant_assignments first
        let result = await supabaseClient
            .from('staff_participant_assignments')
            .update({ is_active: false })
            .eq('id', assignmentId);
        
        // If that fails, try participant_staff_assignments
        if (result.error && result.error.code === 'PGRST205') {
            result = await supabaseClient
                .from('participant_staff_assignments')
                .update({ is_active: false })
                .eq('id', assignmentId);
        }
        
        if (result.error) throw result.error;
        
        await loadAssignedStaff(currentParticipantId);
        
    } catch (error) {
        console.error('Error removing assignment:', error);
        alert('Failed to remove assignment');
    }
}

// ==================== UTILITY FUNCTIONS ====================

// Get current user ID (implement based on your auth system)
function getCurrentUserId() {
    // Replace this with your actual auth implementation
    // For example:
    // return sessionStorage.getItem('userId');
    // or
    // return supabaseClient.auth.user()?.id;
    return 1; // Placeholder
}

// Format document type
function formatDocumentType(type) {
    const types = {
        'schedule_of_supports': 'Schedule of Supports',
        'care_plan': 'Care Plan',
        'behavior_support': 'Behavior Support Plan',
        'medical_report': 'Medical Report',
        'assessment': 'Assessment',
        'other': 'Other'
    };
    return types[type] || type;
}

// Format log type
function formatLogType(type) {
    const types = {
        'clock_in': 'Clock In',
        'clock_out': 'Clock Out',
        'transport': 'Transport',
        'manual': 'Manual Update'
    };
    return types[type] || type;
}

// ========================================
// ENHANCED SHIFT MODAL FUNCTIONS
// ========================================

// Add styles for the schedule cards
function addShiftModalStyles() {
    const styles = `
        <style>
            /* Fix modal scrolling */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                overflow-y: auto;
                padding: 20px;
            }
            
            .modal.large.with-sidebar {
                max-width: 1200px;
                width: 90%;
                max-height: 90vh;
                overflow: visible;
                display: flex;
                flex-direction: column;
            }
            
            .modal.large.with-sidebar .modal-content {
                overflow-y: auto;
                max-height: calc(90vh - 200px);
            }
            
            .modal-body-wrapper {
                display: flex;
                gap: 20px;
                flex: 1;
                min-height: 0;
            }
            
            .modal-main-content {
                flex: 1;
                min-width: 0;
            }
            
            .modal-sidebar {
                width: 400px;
                max-height: 100%;
                overflow-y: auto;
                background: #f8f9fa;
                border-radius: 8px;
                padding: 20px;
                flex-shrink: 0;
            }
            
            .schedule-card {
                background: white;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 16px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .schedule-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 2px solid #e9ecef;
            }
            
            .schedule-card-title {
                font-size: 16px;
                font-weight: 600;
                color: #333;
            }
            
            .hours-summary {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 12px;
                margin-bottom: 16px;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 6px;
            }
            
            .hours-stat {
                text-align: center;
            }
            
            .hours-stat-value {
                font-size: 20px;
                font-weight: 700;
                color: #1976d2;
            }
            
            .hours-stat-label {
                font-size: 11px;
                color: #666;
                text-transform: uppercase;
            }
            
            .shift-list {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .shift-item {
                padding: 12px;
                margin-bottom: 8px;
                border: 1px solid #e9ecef;
                border-radius: 6px;
                background: white;
                transition: all 0.2s;
            }
            
            .shift-item:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .shift-item.overlap {
                border-color: #dc3545;
                background: #fff5f5;
            }
            
            .shift-item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 4px;
            }
            
            .shift-time {
                font-weight: 600;
                color: #333;
            }
            
            .shift-hours {
                background: #e3f2fd;
                color: #1976d2;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
            }
            
            .shift-details {
                font-size: 13px;
                color: #666;
            }
            
            .overlap-warning {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 6px;
                padding: 12px;
                margin-bottom: 12px;
                font-size: 13px;
            }
            
            .overlap-warning-icon {
                color: #f39c12;
                margin-right: 8px;
            }
            
            .ratio-indicator {
                background: #d1ecf1;
                border: 1px solid #bee5eb;
                border-radius: 6px;
                padding: 8px 12px;
                margin-top: 12px;
                font-size: 13px;
                color: #0c5460;
            }
            
            .no-shifts-message {
                text-align: center;
                padding: 40px 20px;
                color: #999;
                font-size: 14px;
            }
        </style>
    `;
    
    if (!document.querySelector('#shiftModalStyles')) {
        const styleElement = document.createElement('div');
        styleElement.id = 'shiftModalStyles';
        styleElement.innerHTML = styles;
        document.body.appendChild(styleElement);
    }
}

// Initialize modal enhancements
function initializeShiftModalEnhancements() {
    addShiftModalStyles();
    
    // Wait for DOM to be ready
    setTimeout(() => {
        enhanceAddShiftModal();
        enhanceEditShiftModal();
    }, 100);
}

// Enhance Add Shift Modal
function enhanceAddShiftModal() {
    const modal = document.querySelector('#addShiftModal .modal');
    if (!modal) return;
    
    modal.classList.add('with-sidebar');
    
    // Get the modal header, content, and footer
    const modalHeader = modal.querySelector('.modal-header');
    const modalContent = modal.querySelector('.modal-content');
    const modalFooter = modal.querySelector('.modal-footer');
    
    // Create wrapper for body content
    const bodyWrapper = document.createElement('div');
    bodyWrapper.className = 'modal-body-wrapper';
    
    // Create main content wrapper
    const mainContent = document.createElement('div');
    mainContent.className = 'modal-main-content';
    
    // Move form to main content
    const form = modalContent.querySelector('#addShiftForm');
    if (form) {
        mainContent.appendChild(form);
    }
    
    // Create sidebar
    const sidebar = document.createElement('div');
    sidebar.className = 'modal-sidebar';
    sidebar.id = 'addShiftSidebar';
    sidebar.innerHTML = '<div class="no-shifts-message">Select staff and participant to view schedules</div>';
    
    // Clear modal content and rebuild structure
    modalContent.innerHTML = '';
    bodyWrapper.appendChild(mainContent);
    bodyWrapper.appendChild(sidebar);
    modalContent.appendChild(bodyWrapper);
}

// Enhance Edit Shift Modal
function enhanceEditShiftModal() {
    const modal = document.querySelector('#editShiftModal .modal');
    if (!modal) return;
    
    modal.classList.add('with-sidebar');
    
    // Get the modal header, content, and footer
    const modalHeader = modal.querySelector('.modal-header');
    const modalContent = modal.querySelector('.modal-content');
    const modalFooter = modal.querySelector('.modal-footer');
    
    // Create wrapper for body content
    const bodyWrapper = document.createElement('div');
    bodyWrapper.className = 'modal-body-wrapper';
    
    // Create main content wrapper
    const mainContent = document.createElement('div');
    mainContent.className = 'modal-main-content';
    
    // Move form to main content
    const form = modalContent.querySelector('#editShiftForm');
    if (form) {
        mainContent.appendChild(form);
    }
    
    // Create sidebar
    const sidebar = document.createElement('div');
    sidebar.className = 'modal-sidebar';
    sidebar.id = 'editShiftSidebar';
    sidebar.innerHTML = '<div class="no-shifts-message">Select staff and participant to view schedules</div>';
    
    // Clear modal content and rebuild structure
    modalContent.innerHTML = '';
    bodyWrapper.appendChild(mainContent);
    bodyWrapper.appendChild(sidebar);
    modalContent.appendChild(bodyWrapper);
}

// Update staff selection in Add modal
const originalUpdateStaffSelection = window.updateStaffSelection;
window.updateStaffSelection = async function() {
    if (originalUpdateStaffSelection) {
        await originalUpdateStaffSelection.apply(this, arguments);
    }
    updateModalScheduleCards('add');
};

// Update participant selection in Add modal
const originalUpdateParticipantSelection = window.updateParticipantSelection;
window.updateParticipantSelection = async function() {
    if (originalUpdateParticipantSelection) {
        await originalUpdateParticipantSelection.apply(this, arguments);
    }
    updateModalScheduleCards('add');
};

// Update staff selection in Edit modal
const originalUpdateEditStaffSelection = window.updateEditStaffSelection;
window.updateEditStaffSelection = async function() {
    if (originalUpdateEditStaffSelection) {
        await originalUpdateEditStaffSelection.apply(this, arguments);
    }
    updateModalScheduleCards('edit');
};

// Update participant selection in Edit modal
const originalUpdateEditParticipantSelection = window.updateEditParticipantSelection;
window.updateEditParticipantSelection = async function() {
    if (originalUpdateEditParticipantSelection) {
        await originalUpdateEditParticipantSelection.apply(this, arguments);
    }
    updateModalScheduleCards('edit');
};

async function updateModalScheduleCards(modalType) {
    const isEdit = modalType === 'edit';
    const staffId = document.getElementById(isEdit ? 'editShiftStaff' : 'shiftStaff').value;
    const participantId = document.getElementById(isEdit ? 'editShiftParticipant' : 'shiftParticipant').value;
    const shiftDate = document.getElementById(isEdit ? 'editShiftDate' : 'shiftDate').value;
    const sidebar = document.getElementById(isEdit ? 'editShiftSidebar' : 'addShiftSidebar');
    
    if (!sidebar) return;
    
    // Need both staff and participant selected
    if (!staffId || !participantId) {
        sidebar.innerHTML = '<div class="no-shifts-message">Select both staff and participant to view schedules</div>';
        return;
    }
    
    // Use the shift date to determine the pay period
    let startDate, endDate;
    if (shiftDate) {
        // Get the pay period for the selected shift date
        const selectedDate = new Date(shiftDate);
        const payPeriodStart = getPayPeriodStart(selectedDate);
        const payPeriodEnd = new Date(payPeriodStart);
        payPeriodEnd.setDate(payPeriodEnd.getDate() + 13);
        
        startDate = payPeriodStart.toISOString().split('T')[0];
        endDate = payPeriodEnd.toISOString().split('T')[0];
    } else {
        // Fallback to current pay period if no date selected
        const today = new Date();
        const payPeriodStart = getPayPeriodStart(today);
        const payPeriodEnd = new Date(payPeriodStart);
        payPeriodEnd.setDate(payPeriodEnd.getDate() + 13);
        
        startDate = payPeriodStart.toISOString().split('T')[0];
        endDate = payPeriodEnd.toISOString().split('T')[0];
    }
    
    try {
        // Load staff schedule
        const staffCard = await createStaffScheduleCard(staffId, startDate, endDate, shiftDate);
        
        // Load participant schedule
        const participantCard = await createParticipantScheduleCard(participantId, startDate, endDate, shiftDate);
        
        // Check for overlaps and conflicts
        const startTime = document.getElementById(isEdit ? 'editShiftStartTime' : 'shiftStartTime').value;
        const endTime = document.getElementById(isEdit ? 'editShiftEndTime' : 'shiftEndTime').value;
        const excludeShiftId = isEdit ? document.getElementById('editShiftId').value : null;
        
        let overlapWarning = '';
        if (shiftDate && startTime && endTime) {
            const conflicts = await checkShiftConflicts(staffId, participantId, shiftDate, startTime, endTime, null, excludeShiftId);
            
            if (conflicts.overlaps.length > 0) {
                overlapWarning = `
                    <div class="overlap-warning">
                        <i class="fa-solid fa-exclamation-triangle overlap-warning-icon"></i>
                        <strong>Staff Overlap Detected:</strong> ${conflicts.overlaps[0].message}
                    </div>
                `;
            }
            
            if (conflicts.participantOverlaps && conflicts.participantOverlaps.count > 0) {
                overlapWarning += `
                    <div class="ratio-indicator">
                        <i class="fa-solid fa-users"></i>
                        <strong>${conflicts.participantOverlaps.ratio} Ratio:</strong> 
                        ${conflicts.participantOverlaps.message}
                    </div>
                `;
            }
        }
        
        sidebar.innerHTML = overlapWarning + staffCard + participantCard;
        
        // Highlight overlapping shifts
        if (shiftDate && startTime && endTime) {
            highlightOverlappingShifts(shiftDate, startTime, endTime);
        }
        
    } catch (error) {
        console.error('Error loading schedule cards:', error);
        sidebar.innerHTML = '<div class="error">Failed to load schedules</div>';
    }
}

async function createStaffScheduleCard(staffId, startDate, endDate, selectedDate) {
    // Check if staff data is available
    if (!window.staff || !Array.isArray(window.staff)) {
        console.error('Staff data not available');
        return '<div class="error">Staff data not loaded</div>';
    }
    
    const staff = window.staff.find(s => s.id === staffId);
    if (!staff) return '';
    
    // Get staff shifts for period
    const { data: shifts, error } = await supabaseClient
        .from('shifts')
        .select(`
            *,
            participants:participant_id(first_name, last_name, ndis_participant_number),
            locations:location_id(name)
        `)
        .eq('staff_id', staffId)
        .gte('date', startDate)
        .lte('date', endDate)
        .is('deleted_at', null)
        .order('date', { ascending: true })
        .order('start_time', { ascending: true });
    
    if (error) throw error;
    
    // Calculate hours
    let totalHours = 0;
    shifts.forEach(shift => {
        const hours = calculateShiftHours(shift);
        totalHours += hours.total;
    });
    
    const hourLimit = staff.limits || 76;
    const remainingHours = Math.max(0, hourLimit - totalHours);
    
    // Group shifts by date
    const shiftsByDate = {};
    shifts.forEach(shift => {
        const date = shift.date.split('T')[0];
        if (!shiftsByDate[date]) shiftsByDate[date] = [];
        shiftsByDate[date].push(shift);
    });
    
    // Build shift list HTML
    let shiftsHtml = '';
    Object.keys(shiftsByDate).sort().forEach(date => {
        const dayShifts = shiftsByDate[date];
        const isSelectedDate = date === selectedDate;
        
        shiftsHtml += `
            <div class="shift-day ${isSelectedDate ? 'selected-date' : ''}">
                <div style="font-weight: 600; color: #666; font-size: 12px; margin-bottom: 8px;">
                    ${formatDateShort(date)}
                </div>
        `;
        
        dayShifts.forEach(shift => {
            const participant = shift.participants || {};
            const hours = calculateShiftHours(shift);
            
            shiftsHtml += `
                <div class="shift-item ${isSelectedDate ? 'same-day' : ''}" data-date="${date}" data-start="${shift.start_time}" data-end="${shift.end_time}">
                    <div class="shift-item-header">
                        <span class="shift-time">
                            ${shift.start_time && shift.end_time ? 
                                `${formatTime12Hour(shift.start_time)} - ${formatTime12Hour(shift.end_time)}` : 
                                '<i class="fa-solid fa-bed"></i> Sleepover'}
                        </span>
                        <span class="shift-hours">${hours.total.toFixed(1)}h</span>
                    </div>
                    <div class="shift-details">
                        <i class="fa-solid fa-user"></i> ${participant.first_name || ''} ${participant.last_name || ''}
                    </div>
                </div>
            `;
        });
        
        shiftsHtml += '</div>';
    });
    
    return `
        <div class="schedule-card">
            <div class="schedule-card-header">
                <span class="schedule-card-title">
                    <i class="fa-solid fa-user-nurse"></i> ${staff.first_name} ${staff.last_name}
                </span>
                <span style="font-size: 12px; color: #666;">
                    ${formatDateShort(startDate)} - ${formatDateShort(endDate)}
                </span>
            </div>
            
            <div class="hours-summary">
                <div class="hours-stat">
                    <div class="hours-stat-value">${totalHours.toFixed(1)}</div>
                    <div class="hours-stat-label">Hours Rostered</div>
                </div>
                <div class="hours-stat">
                    <div class="hours-stat-value">${hourLimit}</div>
                    <div class="hours-stat-label">Hour Limit</div>
                </div>
                <div class="hours-stat">
                    <div class="hours-stat-value" style="color: ${remainingHours < 10 ? '#dc3545' : '#28a745'};">
                        ${remainingHours.toFixed(1)}
                    </div>
                    <div class="hours-stat-label">Remaining</div>
                </div>
            </div>
            
            <div class="shift-list">
                ${shiftsHtml || '<div class="no-shifts-message">No shifts in this period</div>'}
            </div>
        </div>
    `;
}

// Create participant schedule card
async function createParticipantScheduleCard(participantId, startDate, endDate, selectedDate) {
    // Check if participants data is available
    if (!window.participants || !Array.isArray(window.participants)) {
        console.error('Participants data not available');
        return '<div class="error">Participants data not loaded</div>';
    }
    
    const participant = window.participants.find(p => p.id === participantId);
    if (!participant) return '';
    
    // Get participant shifts for period
    const { data: shifts, error } = await supabaseClient
        .from('shifts')
        .select(`
            *,
            staff:staff_id(first_name, last_name, staff_code),
            locations:location_id(name)
        `)
        .eq('participant_id', participantId)
        .gte('date', startDate)
        .lte('date', endDate)
        .is('deleted_at', null)
        .order('date', { ascending: true })
        .order('start_time', { ascending: true });
    
    if (error) throw error;
    
    // Calculate hours
    let totalHours = 0;
    let totalShifts = shifts.length;
    
    shifts.forEach(shift => {
        const hours = calculateShiftHours(shift);
        totalHours += hours.total;
    });
    
    // Group shifts by date
    const shiftsByDate = {};
    shifts.forEach(shift => {
        const date = shift.date.split('T')[0];
        if (!shiftsByDate[date]) shiftsByDate[date] = [];
        shiftsByDate[date].push(shift);
    });
    
    // Build shift list HTML
    let shiftsHtml = '';
    Object.keys(shiftsByDate).sort().forEach(date => {
        const dayShifts = shiftsByDate[date];
        const isSelectedDate = date === selectedDate;
        
        shiftsHtml += `
            <div class="shift-day ${isSelectedDate ? 'selected-date' : ''}">
                <div style="font-weight: 600; color: #666; font-size: 12px; margin-bottom: 8px;">
                    ${formatDateShort(date)} ${dayShifts.length > 1 ? `<span style="color: #17a2b8;">(${dayShifts.length} staff)</span>` : ''}
                </div>
        `;
        
        dayShifts.forEach(shift => {
            const staffMember = shift.staff || {};
            const hours = calculateShiftHours(shift);
            
            shiftsHtml += `
                <div class="shift-item ${isSelectedDate ? 'same-day' : ''}" data-date="${date}" data-start="${shift.start_time}" data-end="${shift.end_time}">
                    <div class="shift-item-header">
                        <span class="shift-time">
                            ${shift.start_time && shift.end_time ? 
                                `${formatTime12Hour(shift.start_time)} - ${formatTime12Hour(shift.end_time)}` : 
                                '<i class="fa-solid fa-bed"></i> Sleepover'}
                        </span>
                        <span class="shift-hours">${hours.total.toFixed(1)}h</span>
                    </div>
                    <div class="shift-details">
                        <i class="fa-solid fa-user"></i> ${staffMember.first_name || ''} ${staffMember.last_name || ''}
                        ${staffMember.staff_code ? `<span style="color: #999; font-size: 11px;">(${staffMember.staff_code})</span>` : ''}
                    </div>
                </div>
            `;
        });
        
        shiftsHtml += '</div>';
    });
    
    return `
        <div class="schedule-card">
            <div class="schedule-card-header">
                <span class="schedule-card-title">
                    <i class="fa-solid fa-user"></i> ${participant.first_name} ${participant.last_name}
                </span>
                <span style="font-size: 12px; color: #666;">
                    ${participant.ndis_participant_number || 'No NDIS #'}
                </span>
            </div>
            
            <div class="hours-summary">
                <div class="hours-stat">
                    <div class="hours-stat-value">${totalShifts}</div>
                    <div class="hours-stat-label">Total Shifts</div>
                </div>
                <div class="hours-stat">
                    <div class="hours-stat-value">${totalHours.toFixed(1)}</div>
                    <div class="hours-stat-label">Total Hours</div>
                </div>
                <div class="hours-stat">
                    <div class="hours-stat-value">${(totalHours / totalShifts || 0).toFixed(1)}</div>
                    <div class="hours-stat-label">Avg Hours/Shift</div>
                </div>
            </div>
            
            <div class="shift-list">
                ${shiftsHtml || '<div class="no-shifts-message">No shifts in this period</div>'}
            </div>
        </div>
    `;
}

// Highlight overlapping shifts
function highlightOverlappingShifts(date, startTime, endTime) {
    const shiftItems = document.querySelectorAll(`.shift-item[data-date="${date}"]`);
    
    if (!startTime || !endTime) return;
    
    const newStart = new Date(`2000-01-01T${startTime}`);
    const newEnd = new Date(`2000-01-01T${endTime}`);
    if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
    
    shiftItems.forEach(item => {
        const existingStart = item.dataset.start;
        const existingEnd = item.dataset.end;
        
        if (!existingStart || !existingEnd) return;
        
        const shiftStart = new Date(`2000-01-01T${existingStart}`);
        const shiftEnd = new Date(`2000-01-01T${existingEnd}`);
        if (shiftEnd <= shiftStart) shiftEnd.setDate(shiftEnd.getDate() + 1);
        
        // Check for overlap
        if (!(newEnd <= shiftStart || newStart >= shiftEnd)) {
            item.classList.add('overlap');
        } else {
            item.classList.remove('overlap');
        }
    });
}

// Get pay period start
function getPayPeriodStart(date) {
    const referenceDate = new Date('2024-01-01'); // A known Monday
    const daysSinceReference = Math.floor((date - referenceDate) / (1000 * 60 * 60 * 24));
    const payPeriodsSinceReference = Math.floor(daysSinceReference / 14);
    const currentPeriodStart = new Date(referenceDate);
    currentPeriodStart.setDate(currentPeriodStart.getDate() + (payPeriodsSinceReference * 14));
    return currentPeriodStart;
}


async function updateShift() {
    try {
        const shiftId = document.getElementById('editShiftId').value; // Remove parseInt
        const date = document.getElementById('editShiftDate').value;
        const startTime = document.getElementById('editShiftStartTime').value;
        const endTime = document.getElementById('editShiftEndTime').value;
        const staffId = document.getElementById('editShiftStaff').value;
        const participantId = document.getElementById('editShiftParticipant').value || null;
        const locationId = document.getElementById('editShiftLocation').value || null;
        const dutyTypeId = document.getElementById('editShiftDutyType').value;
        const payRateId = document.getElementById('editShiftPayRate').value;
        const clockInRequired = document.getElementById('editClockInRequired').checked; // Add this
        const status = document.getElementById('editShiftStatus').value;
        const notes = document.getElementById('editShiftNotes').value;

        if (!date || !staffId || !dutyTypeId) {
            showNotification('Please fill required fields', 'error');
            return;
        }

        // Calculate duration FIRST
        let duration_hours = null;
        const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeId);
        if (selectedDutyType?.name.toLowerCase().includes('sleepover')) {
            duration_hours = 2;
        } else if (startTime && endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            let end = new Date(`2000-01-01T${endTime}`);
            if (end <= start) end.setDate(end.getDate() + 1);
            duration_hours = (end - start) / (1000 * 60 * 60);
        }

        // Handle pay rate
        let effectivePayRateId = payRateId;
        if (!effectivePayRateId) {
            // Try to get assignment pay rate
            effectivePayRateId = await getAssignmentPayRate(staffId, participantId);
            
            if (!effectivePayRateId) {
                // Fall back to staff default
                const selectedStaff = staff.find(s => s.id === staffId);
                effectivePayRateId = selectedStaff?.pay_rate_id;
            }
        }

        if (!effectivePayRateId) {
            showNotification('Missing pay rate. Please select or assign a valid pay rate.', 'error');
            return;
        }

        // NOW create updateData with all values defined
        const updateData = {
            date: date,
            start_time: startTime || null,
            end_time: endTime || null,
            staff_id: staffId,
            participant_id: participantId,
            location_id: locationId,
            duty_type_id: dutyTypeId,
            pay_override_id: effectivePayRateId,
            clock_in_required: clockInRequired,
            status: status || 'pending',
            notes: notes || null,
            duration_hours: duration_hours,
            updated_at: new Date().toISOString()
        };

        console.log('Updating shift with data:', updateData);

        const { error } = await supabaseClient
            .from('shifts')
            .update(updateData)
            .eq('id', shiftId);

        if (error) throw error;

        showNotification('Shift updated successfully', 'success');
        closeModal('editShiftModal');
        await loadShifts();

    } catch (error) {
        console.error('Error updating shift:', error);
        showNotification('Failed to update shift: ' + error.message, 'error');
    }
}

async function approveLeave(requestId) {
    try {
        // Get leave request details
        const { data: leave, error: fetchError } = await supabaseClient
            .from('leave_requests')
            .select('*')
            .eq('id', requestId)
            .single();
            
        if (fetchError || !leave) {
            throw new Error('Leave request not found');
        }
        
        // Update leave request status
        const { error: updateError } = await supabaseClient
            .from('leave_requests')
            .update({
                status: 'approved',
                approved_at: new Date().toISOString()  // ✅ Added approved_at
            })
            .eq('id', requestId);
            
        if (updateError) throw updateError;
        
        // Create staff_availability records for the leave period
        const startDate = new Date(leave.start_date);
        const endDate = new Date(leave.end_date);
        const availabilityRecords = [];
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            availabilityRecords.push({
                staff_id: leave.staff_id,
                date: d.toISOString().split('T')[0],
                is_available: false,
                // ✅ REMOVED: start_time and end_time (columns don't exist)
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            });
        }
        
        // Upsert availability records
        if (availabilityRecords.length > 0) {
            const { error: availError } = await supabaseClient
                .from('staff_availability')
                .upsert(availabilityRecords, {
                    onConflict: 'staff_id,date',
                    ignoreDuplicates: false
                });
                
            if (availError) {
                console.error('Error creating availability records:', availError);
                // Don't fail the whole operation - just log it
            }
        }
        
        showNotification('Leave approved successfully', 'success');
        
        // Refresh views
        await loadRequestData();
        
    } catch (error) {
        console.error('Error approving leave:', error);
        showNotification('Failed to approve leave: ' + error.message, 'error');
    }
}


async function rejectLeave(leaveId) {
    try {
        const { error } = await supabaseClient
            .from('leave_requests')
            .update({ 
                status: 'rejected',
                approved_at: new Date().toISOString()
            })
            .eq('id', leaveId);
        
        if (error) throw error;
        
        showNotification('Leave request rejected', 'info');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error rejecting leave:', error);
        showNotification('Failed to reject leave request', 'error');
    }
}
function formatDateFriendly(dateStr) {
    if (!dateStr) return 'Unknown';
    const date = new Date(dateStr);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-AU', options);
}

async function denyLeave(requestId) {
    try {
        const { error } = await supabaseClient
            .from('leave_requests')
            .update({
                status: 'rejected',
                updated_at: new Date().toISOString()
            })
            .eq('id', requestId);
            
        if (error) throw error;
        
        showNotification('Leave request denied', 'info');
        
        if (typeof renderRequests === 'function') {
            await renderRequests();
        }
        
    } catch (error) {
        console.error('Error denying leave:', error);
        showNotification('Failed to deny leave: ' + error.message, 'error');
    }
}


async function approveTransfer(requestId) {
    try {
        // Get the transfer request details
        const { data: request, error: fetchError } = await supabaseClient
            .from('transfer_requests')
            .select('*')
            .eq('id', requestId)
            .single();
        
        if (fetchError || !request) {
            throw new Error('Transfer request not found');
        }
        
        // Update the shift with new staff member if specified
        if (request.to_staff_id) {
            const { error: shiftError } = await supabaseClient
                .from('shifts')
                .update({
                    staff_id: request.to_staff_id,
                    updated_at: new Date().toISOString()
                })
                .eq('id', request.shift_id);
                
            if (shiftError) throw shiftError;
        } else {
            // If no target staff specified, unassign the shift
            const { error: shiftError } = await supabaseClient
                .from('shifts')
                .update({
                    staff_id: null,
                    updated_at: new Date().toISOString()
                })
                .eq('id', request.shift_id);
                
            if (shiftError) throw shiftError;
        }
        
        // Update request status
        const { error: requestError } = await supabaseClient
            .from('transfer_requests')
            .update({ 
                status: 'approved',
                updated_at: new Date().toISOString()
            })
            .eq('id', requestId);
            
        if (requestError) throw requestError;
        
        showNotification('Transfer approved successfully', 'success');
        
        // Refresh the view
        await renderRequests();
        
        // Refresh shifts if loaded
        if (typeof loadShifts === 'function') {
            await loadShifts();
        }
        
    } catch (error) {
        console.error('Error approving transfer:', error);
        showNotification('Failed to approve transfer: ' + error.message, 'error');
    }
}


async function denyTransfer(requestId) {
    try {
        const { error } = await supabaseClient
            .from('transfer_requests')
            .update({ 
                status: 'rejected',
                updated_at: new Date().toISOString()
            })
            .eq('id', requestId);
        
        if (error) throw error;
        
        showNotification('Transfer denied', 'info');
        await renderRequests();
        
    } catch (error) {
        console.error('Error denying transfer:', error);
        showNotification('Failed to deny transfer: ' + error.message, 'error');
    }
}
async function approveAdjustment(requestId) {
    try {
        // Get the adjustment request details
        const { data: request, error: fetchError } = await supabaseClient
            .from('shift_adjustment_requests')
            .select('*')
            .eq('id', requestId)
            .single();
        
        if (fetchError || !request) {
            throw new Error('Adjustment request not found');
        }
        
        // Update the shift with new times
        const updateData = {};
        if (request.new_start_time) {
            updateData.start_time = request.new_start_time;
        }
        if (request.new_end_time) {
            updateData.end_time = request.new_end_time;
        }
        updateData.updated_at = new Date().toISOString();
        
        const { error: shiftError } = await supabaseClient
            .from('shifts')
            .update(updateData)
            .eq('id', request.shift_id);
            
        if (shiftError) throw shiftError;

        // Update request status to approved
        const { error: requestError } = await supabaseClient
            .from('shift_adjustment_requests')
            .update({ 
                status: 'approved',
                approved_at: new Date().toISOString()
            })
            .eq('id', requestId);
            
        if (requestError) throw requestError;
        
        showNotification('Adjustment approved successfully', 'success');
        
        // Refresh views
        await renderRequests();
        
        // Refresh shifts if loaded
        if (typeof loadShifts === 'function') {
            await loadShifts();
        }
        
    } catch (error) {
        console.error('Error approving adjustment:', error);
        showNotification('Failed to approve adjustment: ' + error.message, 'error');
    }
}

async function denyAdjustment(requestId) {
    try {
        // Get the adjustment request to find the shift
        const { data: request, error: fetchError } = await supabaseClient
            .from('shift_adjustment_requests')
            .select('shift_id')
            .eq('id', requestId)
            .single();
        
        if (fetchError) throw fetchError;
        
        // Update the adjustment request status to rejected
        const { error } = await supabaseClient
            .from('shift_adjustment_requests')
            .update({ 
                status: 'rejected',
                approved_at: new Date().toISOString()  // This is in shift_adjustment_requests table
            })
            .eq('id', requestId);
        
        if (error) throw error;
        
        // Clear the shift's adjustment_status (don't update adjustment_approved_at)
        if (request.shift_id) {
            await supabaseClient
                .from('shifts')
                .update({
                    adjustment_status: null  // ✅ ONLY update adjustment_status
                    // ❌ REMOVED: adjustment_approved_at (column doesn't exist in shifts table)
                })
                .eq('id', request.shift_id);
        }
        
        showNotification('Adjustment denied', 'info');
        await loadRequestData();
        
    } catch (error) {
        console.error('Error denying adjustment:', error);
        showNotification('Failed to deny adjustment: ' + error.message, 'error');
    }
}

        

// ============================================
// COMPLETE ROSTER REPLACEMENT CODE
// ============================================
// 1. Add this to your page initialization (DOMContentLoaded or similar)
// 2. Replace your existing renderTable() function
// 3. Replace your existing renderShiftRow() function
// 4. Add all the new functions below

// INITIALIZATION - Add to your DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    createRosterSummaryContainer();
    addRosterStyles();
});

// ADD ROSTER STYLES
function addRosterStyles() {
    const styles = `
        <style>
            .roster-summary-container {
                background: white;
                border-radius: 12px;
                padding: 24px;
                margin-bottom: 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .roster-summary-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .roster-summary-title {
                font-size: 20px;
                font-weight: 600;
                color: #333;
            }
            .roster-summary-period {
                font-size: 14px;
                color: #666;
            }
            .roster-stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 16px;
            }
            .roster-stat-card {
                background: #f8f9fa;
                padding: 16px;
                border-radius: 8px;
                text-align: center;
                border: 1px solid #e9ecef;
                transition: all 0.2s;
            }
            .roster-stat-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            .roster-stat-card.highlight-primary {
                background: #e3f2fd;
                border-color: #1976d2;
            }
            .roster-stat-value {
                font-size: 24px;
                font-weight: 700;
                color: #1976d2;
                margin-bottom: 4px;
            }
            .roster-stat-label {
                font-size: 12px;
                color: #666;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .roster-day-header {
                background: #f8f9fa;
                font-weight: 600;
            }
            .roster-day-header td {
                padding: 12px 16px !important;
                border-bottom: 2px solid #dee2e6;
            }
            .roster-day-stats {
                font-weight: 400;
                font-size: 14px;
                color: #666;
            }
            .shift-row:hover {
                background-color: #f8f9fa !important;
            }
            .shift-row td {
                vertical-align: middle;
                padding: 12px 8px;
            }
            .roster-participant-header {
                background: #e9ecef;
                font-weight: 600;
            }
            .roster-participant-header td {
                padding: 12px 16px !important;
                border-bottom: 2px solid #dee2e6;
            }
            .roster-participant-stats {
                float: right;
                font-weight: 400;
                font-size: 14px;
                color: #666;
            }
            .actions-cell {
                white-space: nowrap;
            }
            .time-cell {
                white-space: nowrap;
            }
            .participant-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                color: white;
                font-weight: 500;
            }
            .location-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                background: #e9ecef;
                color: #495057;
            }
        </style>
    `;
    
    if (!document.querySelector('#rosterEnhancementStyles')) {
        const styleElement = document.createElement('div');
        styleElement.id = 'rosterEnhancementStyles';
        styleElement.innerHTML = styles;
        document.body.appendChild(styleElement);
    }
}

// CREATE ROSTER SUMMARY CONTAINER
function createRosterSummaryContainer() {
    const summaryHtml = `
        <div class="roster-summary-container">
            <div class="roster-summary-header">
                <h3 class="roster-summary-title">Shift Summary</h3>
                <div class="roster-summary-period" id="summaryPeriod"></div>
            </div>
            <div id="shiftSummaryGrid" class="roster-stats-grid">
                <!-- Summary stats will be populated here -->
            </div>
        </div>
    `;
    
    const rosterView = document.getElementById('rosterView');
    if (rosterView) {
        const tableContainer = rosterView.querySelector('.table-container');
        if (tableContainer) {
            tableContainer.insertAdjacentHTML('beforebegin', summaryHtml);
        }
    }
}

// UPDATE ROSTER SUMMARY
function updateRosterSummary() {
    const summaryGrid = document.getElementById('shiftSummaryGrid');
    const summaryPeriod = document.getElementById('summaryPeriod');
    
    if (!summaryGrid || !filteredShifts) return;
    
    const filters = window.currentFilters || {};
    let periodText = 'All Shifts';
    if (filters.startDate && filters.endDate) {
        periodText = `${formatDateShort(filters.startDate)} - ${formatDateShort(filters.endDate)}`;
    } else if (filters.startDate) {
        periodText = `From ${formatDateShort(filters.startDate)}`;
    } else if (filters.endDate) {
        periodText = `Until ${formatDateShort(filters.endDate)}`;
    }
    
    if (filters.participantId && participantFilterValue) {
        const participant = participants.find(p => p.id === participantFilterValue);
        if (participant) {
            periodText += ` • ${participant.first_name} ${participant.last_name}`;
        }
    }
    
    if (summaryPeriod) {
        summaryPeriod.textContent = periodText;
    }
    
    const stats = calculateShiftSummaryStats(filteredShifts);
    
    summaryGrid.innerHTML = `
        <div class="roster-stat-card">
            <div class="roster-stat-value">${stats.totalShifts}</div>
            <div class="roster-stat-label">Total Shifts</div>
        </div>
        <div class="roster-stat-card">
            <div class="roster-stat-value">${stats.totalHours.toFixed(1)}h</div>
            <div class="roster-stat-label">Total Hours</div>
        </div>
        <div class="roster-stat-card">
            <div class="roster-stat-value">${stats.regularShifts}</div>
            <div class="roster-stat-label">Regular Shifts</div>
        </div>
        <div class="roster-stat-card">
            <div class="roster-stat-value">${stats.sleepoverShifts}</div>
            <div class="roster-stat-label">Sleepovers</div>
        </div>
        <div class="roster-stat-card ${stats.publicHolidayShifts > 0 ? 'highlight-primary' : ''}">
            <div class="roster-stat-value">${stats.publicHolidayShifts}</div>
            <div class="roster-stat-label">Public Holidays</div>
        </div>
        <div class="roster-stat-card">
            <div class="roster-stat-value">${stats.uniqueStaff}</div>
            <div class="roster-stat-label">Staff Members</div>
        </div>
        <div class="roster-stat-card">
            <div class="roster-stat-value">${stats.uniqueParticipants}</div>
            <div class="roster-stat-label">Participants</div>
        </div>
        <div class="roster-stat-card">
            <div class="roster-stat-value">$${stats.estimatedCost.toFixed(2)}</div>
            <div class="roster-stat-label">Estimated Cost</div>
        </div>
    `;
}

// CALCULATE SHIFT SUMMARY STATS
function calculateShiftSummaryStats(shifts) {
    const stats = {
        totalShifts: shifts.length,
        totalHours: 0,
        regularShifts: 0,
        sleepoverShifts: 0,
        publicHolidayShifts: 0,
        uniqueStaff: new Set(),
        uniqueParticipants: new Set(),
        estimatedCost: 0,
        byStatus: {
            scheduled: 0,
            confirmed: 0,
            completed: 0,
            no_show: 0,
            cancelled: 0
        }
    };
    
    const holidayDates = new Set();
    if (window.publicHolidays) {
        window.publicHolidays.forEach((holiday, date) => {
            holidayDates.add(date);
        });
    }
    
    shifts.forEach(shift => {
        const hours = calculateShiftHours(shift);
        stats.totalHours += hours.total || 0;
        
        if (!shift.start_time && !shift.end_time) {
            stats.sleepoverShifts++;
        } else {
            stats.regularShifts++;
        }
        
        const shiftDate = shift.date.split('T')[0];
        if (holidayDates.has(shiftDate) || shift.is_public_holiday) {
            stats.publicHolidayShifts++;
        }
        
        if (shift.staff_id) stats.uniqueStaff.add(shift.staff_id);
        if (shift.participant_id) stats.uniqueParticipants.add(shift.participant_id);
        
        if (shift.status && stats.byStatus[shift.status] !== undefined) {
            stats.byStatus[shift.status]++;
        }
        
        if (shift.pay_rates) {
            const baseRate = shift.pay_rates.hourly_pay_rate || 30;
            let rate = baseRate;
            
            if (holidayDates.has(shiftDate) || shift.is_public_holiday) {
                rate = shift.pay_rates.public_holiday || baseRate * 1.5;
            } else if (new Date(shift.date).getDay() === 0) {
                rate = shift.pay_rates.sunday || baseRate * 1.25;
            } else if (new Date(shift.date).getDay() === 6) {
                rate = shift.pay_rates.saturday || baseRate * 1.25;
            }
            
            stats.estimatedCost += hours.total * rate;
        }
    });
    
    stats.uniqueStaff = stats.uniqueStaff.size;
    stats.uniqueParticipants = stats.uniqueParticipants.size;
    
    return stats;
}

function renderTable() {
    const tbody = document.getElementById('shiftsTableBody');
    
    if (!tbody) {
        console.error('shiftsTableBody element not found');
        return;
    }
    
    updateRosterSummary();
    
    if (filteredShifts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="empty-state">
                    <h3>No shifts found</h3>
                    <p>Try adjusting your date range or filters</p>
                    <button class="btn btn-outline btn-sm" onclick="clearAllFilters()">Clear Filters</button>
                    <button class="btn btn-primary btn-sm" onclick="showAddShiftModal()" style="margin-left: 12px;">Add Shift</button>
                </td>
            </tr>
        `;
        return;
    }
    
    const viewMode = window.currentViewMode || 'date';
    
    if (viewMode === 'date') {
        renderRosterByDate(tbody);
    } else {
        renderRosterByParticipant(tbody);
    }
}

// RENDER ROSTER BY DATE
function renderRosterByDate(tbody) {
    const groupedShifts = groupShiftsByDate(filteredShifts);
    let html = '';
    
    const holidayDates = window.publicHolidays || new Map();
    
    Object.keys(groupedShifts).sort().forEach(date => {
        const dayShifts = groupedShifts[date];
        const dayStats = calculateDayStats(dayShifts);
        const dateKey = date.split('T')[0];
        const isHoliday = holidayDates.has(dateKey);
        const holiday = isHoliday ? holidayDates.get(dateKey) : null;
        
        html += `
            <tr class="roster-day-header" style="${isHoliday ? 'background: linear-gradient(135deg, #1976d2, #42a5f5); color: white;' : ''}">
                <td colspan="10">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            ${formatDateLong(date)}
                            ${isHoliday ? `<span style="background: rgba(255,255,255,0.9); color: #1976d2; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">${holiday.name}</span>` : ''}
                        </div>
                        <div class="roster-day-stats">
                            ${dayStats.shifts} shifts | ${formatHours(dayStats.totalHours)}h | $${dayStats.totalPay.toFixed(2)}
                        </div>
                    </div>
                </td>
            </tr>
        `;
        
        dayShifts.forEach(shift => {
            html += renderShiftRow(shift, date);
        });
    });
    
    tbody.innerHTML = html;
}

// RENDER ROSTER BY PARTICIPANT
function renderRosterByParticipant(tbody) {
    const grouped = {};
    
    filteredShifts.forEach(shift => {
        const key = shift.participant_id || 'unassigned';
        if (!grouped[key]) {
            grouped[key] = {
                participant: shift.participants,
                shifts: []
            };
        }
        grouped[key].shifts.push(shift);
    });
    
    let html = '';
    
    Object.values(grouped).forEach(group => {
        const totalHours = group.shifts.reduce((sum, s) => {
            const hours = calculateShiftHours(s);
            return sum + (hours.total || 0);
        }, 0);
        
        const name = group.participant ? 
            `${group.participant.first_name} ${group.participant.last_name}` : 
            'Unassigned';
        
        html += `
            <tr class="roster-participant-header">
                <td colspan="10">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${name}</strong>
                            ${group.participant?.ndis_participant_number ? 
                                `<span style="color: #666; margin-left: 8px;">${group.participant.ndis_participant_number}</span>` : ''}
                        </div>
                        <div class="roster-participant-stats">
                            ${group.shifts.length} shifts | ${totalHours.toFixed(1)}h
                        </div>
                    </div>
                </td>
            </tr>
        `;
        
        group.shifts.sort((a, b) => a.date.localeCompare(b.date)).forEach(shift => {
            html += renderShiftRow(shift);
        });
    });
    
    tbody.innerHTML = html;
}

function renderShiftRow(shift, date) {
    const staff = shift.staff || {};
    const participant = shift.participants || shift.participant || {};
    const location = shift.locations || shift.location || {};
    const dutyType = shift.duty_types || shift.duty_type || {};
    const payRate = shift.pay_rates || {};
    
    // Get participant color
    const participantColor = getParticipantColor(shift.participant_id);
    
    // Check if this is a care home resident
    const isCareHomeResident = participant.address && 
        Array.from(careHomes.keys()).some(address => 
            participant.address.toLowerCase().includes(address)
        );
    
    // Client display with proper name
    const clientDisplay = participant.first_name ? 
        `<span class="participant-badge" style="background: ${participantColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
            ${participant.first_name} ${participant.last_name}
            ${isCareHomeResident ? ' <i class="fa-solid fa-house"></i>' : ''}
        </span>` : 
        '<span style="color: #dc3545;"><i class="fa-solid fa-user-slash"></i> Unassigned</span>';
    
    // Time display with sleepover badge
    let timeDisplay = '';
    if (shift.start_time && shift.end_time) {
        timeDisplay = `${formatTime12Hour(shift.start_time)} - ${formatTime12Hour(shift.end_time)}`;
    } else if (!shift.start_time && !shift.end_time) {
        timeDisplay = '<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-bed"></i> Sleepover</span>';
    } else if (shift.start_time && !shift.end_time) {
        timeDisplay = `${formatTime12Hour(shift.start_time)} - End`;
    } else {
        timeDisplay = `Start - ${formatTime12Hour(shift.end_time)}`;
    }
    
    // Check if public holiday
    const isPublicHoliday = checkIfPublicHoliday(shift.date) || shift.is_public_holiday;
    if (isPublicHoliday) {
        timeDisplay += ' <span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px;"><i class="fa-solid fa-calendar-check"></i> PH</span>';
    }
    
    // Calculate hours
    const hours = calculateShiftHours(shift);
    const hoursDisplay = `<strong>${hours.total.toFixed(1)}h</strong>`;
    let hoursDetail = '';
    if (hours.publicHoliday > 0) {
        hoursDetail = '<br><span style="color: #17a2b8; font-size: 11px;"><i class="fa-solid fa-dollar-sign"></i> PH Rate</span>';
    } else if (hours.sleepover > 0) {
        hoursDetail = '<br><span style="color: #6c757d; font-size: 11px;"><i class="fa-solid fa-bed"></i> Sleepover</span>';
    }
    
    let payRateLabel = '';
if (payRate.category && payRate.level && payRate.pay_point) {
    const hourlyRate = payRate.hourly_pay_rate || payRate.base_rate || 0;
    payRateLabel = `<span style="color: #666; font-size: 11px;">
        ${payRate.category} L${payRate.level} P${payRate.pay_point} - <strong style="color: #28a745;">$${hourlyRate}/hr</strong>
    </span>`;
} else {
    // Get the default pay rate from staff
    const staffPayRate = staff.pay_rate_id ? window.payRates?.find(pr => pr.id === staff.pay_rate_id) : null;
    if (staffPayRate) {
        const hourlyRate = staffPayRate.hourly_pay_rate || staffPayRate.base_rate || 0;
        payRateLabel = `<span style="color: #666; font-size: 11px;">
            ${staffPayRate.category} L${staffPayRate.level} P${staffPayRate.pay_point} - <strong style="color: #28a745;">$${hourlyRate}/hr</strong>
        </span>`;
    } else {
        payRateLabel = '<span style="color: #999; font-size: 11px;">No Rate Assigned</span>';
    }
}
    
    // Status badge with icons
    const statusBadge = getStatusBadge(shift.status);
    
    // Clock status with icons
    let clockDisplay = '';
    if (shift.clock_in_required) {
        const clockStatus = getClockStatus(shift);
        const clockBadge = getClockStatusBadge(clockStatus);
        const locationBadge = getLocationDistanceBadge(shift);
        clockDisplay = `${clockBadge}${locationBadge ? '<br>' + locationBadge : ''}`;
    } else {
        clockDisplay = '<span style="color: #999; font-size: 11px;"><i class="fa-solid fa-ban"></i> Not Required</span>';
    }
    
    // Staff display
    const staffDisplay = staff.first_name ? 
        `${staff.first_name} ${staff.last_name}
        ${staff.staff_code ? `<br><span style="color: #666; font-size: 11px;"><i class="fa-solid fa-id-badge"></i> ${staff.staff_code}</span>` : ''}` :
        '<span style="color: #dc3545;"><i class="fa-solid fa-user-slash"></i> Unassigned</span>';
    
    // Location display
    const locationDisplay = `<i class="fa-solid fa-location-dot" style="color: #dc3545;"></i> ${location.name || participant.address || 'Client Home'}`;
    
    const shiftActions = renderShiftActions(shift);
    
    return `
        <tr class="shift-row" data-shift-id="${shift.id}">
            <td>${formatDate(shift.date)}</td>
            <td class="time-cell">${timeDisplay}</td>
            <td>${staffDisplay}</td>
            <td>
                ${clientDisplay}
                ${participant.ndis_participant_number ? 
                    `<br><span style="color: #666; font-size: 11px;"><i class="fa-solid fa-id-card"></i> ${participant.ndis_participant_number}</span>` : ''}
            </td>
            <td>${locationDisplay}</td>
            <td>${payRateLabel}</td>
            <td style="text-align: center;">
                ${hoursDisplay}${hoursDetail}
            </td>
            <td>${statusBadge}</td>
            <td>${clockDisplay}</td>
            <td class="actions-cell">${shiftActions}</td>
        </tr>
    `;
}

// GET CLOCK STATUS
function getClockStatus(shift) {
    if (!shift.clock_in_required) return 'not_required';
    
    const now = new Date();
    const shiftDate = new Date(shift.date);
    const shiftStart = new Date(`${shift.date.split('T')[0]}T${shift.start_time}`);
    const shiftEnd = shift.end_time ? new Date(`${shift.date.split('T')[0]}T${shift.end_time}`) : null;
    
    if (now < shiftStart) return 'upcoming';
    
    if (!shift.clock_in_time) {
        if (now > shiftStart) return 'missing_clock_in';
        return 'awaiting_clock_in';
    }
    
    const clockInTime = new Date(shift.clock_in_time);
    const clockInDiff = (clockInTime - shiftStart) / 60000;
    
    const isLateClockIn = clockInDiff > 5;
    const isEarlyClockIn = clockInDiff < -15;
    
    if (shiftEnd && now > shiftEnd) {
        if (!shift.clock_out_time) return 'missing_clock_out';
        
        const clockOutTime = new Date(shift.clock_out_time);
        const clockOutDiff = (clockOutTime - shiftEnd) / 60000;
        
        const isLateClockOut = clockOutDiff > 5;
        const isEarlyClockOut = clockOutDiff < -5;
        
        if (isLateClockIn || isEarlyClockIn || isLateClockOut || isEarlyClockOut) {
            return 'completed_with_issues';
        }
        
        return 'completed_on_time';
    }
    
    if (isLateClockIn) return 'in_progress_late';
    if (isEarlyClockIn) return 'in_progress_early';
    return 'in_progress';
}

// GET CLOCK STATUS BADGE
function getClockStatusBadge(status) {
    const badges = {
        'not_required': '<span style="color: #999;"><i class="fa-solid fa-ban"></i></span>',
        'upcoming': '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-hourglass-start"></i> Upcoming</span>',
        'awaiting_clock_in': '<span style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-clock"></i> Awaiting</span>',
        'missing_clock_in': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-exclamation-triangle"></i> No Clock In</span>',
        'in_progress': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-play"></i> Active</span>',
        'in_progress_late': '<span style="background: #fd7e14; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-exclamation"></i> Late Start</span>',
        'in_progress_early': '<span style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-forward"></i> Early Start</span>',
        'missing_clock_out': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-exclamation-triangle"></i> No Clock Out</span>',
        'completed_on_time': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-check-circle"></i> Complete</span>',
        'completed_with_issues': '<span style="background: #fd7e14; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-exclamation-circle"></i> Issues</span>'
    };
    
    return badges[status] || '<span style="color: #999;"><i class="fa-solid fa-question"></i></span>';
}

// GET STATUS BADGE
function getStatusBadge(status) {
    const badges = {
        'confirmed': '<span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-check"></i> Confirmed</span>',
        'approved': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-check-double"></i> Completed</span>',
        'pending': '<span style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-clock"></i> Pending</span>',
        'denied': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-user-xmark"></i> No Show</span>',
        'rejected': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-times-circle"></i> Rejected</span>'
    };
    
    return badges[status] || `<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><i class="fa-solid fa-question"></i> ${status || 'Unknown'}</span>`;
}

// GET LOCATION DISTANCE BADGE
function getLocationDistanceBadge(shift) {
    let html = '';
    
    if (shift.clock_in_distance_meters !== null) {
        const distance = Math.round(shift.clock_in_distance_meters);
        let badge = '';
        
        if (distance <= 100) {
            badge = `<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;" title="Clock in: ${distance}m">
                        <i class="fa-solid fa-location-check"></i> ${distance}m
                    </span>`;
        } else if (distance <= 500) {
            badge = `<span style="background: #ffc107; color: #212529; padding: 2px 6px; border-radius: 4px; font-size: 10px;" title="Clock in: ${distance}m">
                        <i class="fa-solid fa-location-dot"></i> ${distance}m
                    </span>`;
        } else {
            badge = `<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;" title="Clock in: ${distance}m">
                        <i class="fa-solid fa-location-crosshairs"></i> ${distance}m
                    </span>`;
        }
        
        html += badge;
    }
    
    if (shift.clock_out_distance_meters !== null) {
        const distance = Math.round(shift.clock_out_distance_meters);
        let badge = '';
        
        if (distance <= 100) {
            badge = `<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 4px;" title="Clock out: ${distance}m">
                        <i class="fa-solid fa-location-check"></i> ${distance}m
                    </span>`;
        } else if (distance <= 500) {
            badge = `<span style="background: #ffc107; color: #212529; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 4px;" title="Clock out: ${distance}m">
                        <i class="fa-solid fa-location-dot"></i> ${distance}m
                    </span>`;
        } else {
            badge = `<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 4px;" title="Clock out: ${distance}m">
                        <i class="fa-solid fa-location-crosshairs"></i> ${distance}m
                    </span>`;
        }
        
        html += badge;
    }
    
    return html;
}

// CHECK IF PUBLIC HOLIDAY
function checkIfPublicHoliday(date) {
    if (!window.publicHolidays) return false;
    const dateKey = date.split('T')[0];
    return window.publicHolidays.has(dateKey);
}

// CALCULATE SHIFT HOURS
function calculateShiftHours(shift) {
    const result = {
        regular: 0,
        publicHoliday: 0,
        sleepover: 0,
        total: 0
    };
    
    if (!shift.start_time && !shift.end_time) {
        result.sleepover = 8;
        result.total = 8;
    } else if (shift.start_time && shift.end_time) {
        const start = new Date(`2000-01-01T${shift.start_time}`);
        const end = new Date(`2000-01-01T${shift.end_time}`);
        let hours = (end - start) / (1000 * 60 * 60);
        
        if (hours < 0) hours += 24;
        
        if (checkIfPublicHoliday(shift.date) || shift.is_public_holiday) {
            result.publicHoliday = hours;
        } else {
            result.regular = hours;
        }
        
        result.total = hours;
    }
    
    return result;
}

// UPDATE TABLE HEADERS - Call this function to update your table headers
function updateTableHeaders() {
    const table = document.querySelector('#shiftsTableBody').closest('table');
    if (table) {
        const thead = table.querySelector('thead');
        if (thead) {
            thead.innerHTML = `
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Staff</th>
                    <th>Client</th>
                    <th>Location</th>
                    <th>Pay Rate</th>
                    <th style="text-align: center;">Hours</th>
                    <th>Status</th>
                    <th>Clock Status</th>
                    <th>Actions</th>
                </tr>
            `;
        }
    }
}

async function renderAvailability() {
    const availabilityContent = document.getElementById('availabilityContent');
    if (!availabilityContent) {
        const availabilityView = document.getElementById('availabilityView');
        if (availabilityView) {
            availabilityView.innerHTML = `
                <div class="table-container">
                    <header class="table-header">
                        <h2 class="table-title">Staff Availability & Leave</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="showAvailabilityModal()">Set Availability</button>
                            <button class="btn btn-outline btn-sm" onclick="renderAvailability()">Refresh</button>
                        </div>
                    </header>
                    <div class="card-content" id="availabilityContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Loading availability...</span>
                        </div>
                    </div>
                </div>
            `;
            availabilityContent = document.getElementById('availabilityContent');
        }
    }
    
    if (!availabilityContent) return;
    
    try {
        // Get current week dates
        const weekStart = new Date(currentWeekStart);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        // FIX #5: Load leave data for the week
        const { data: weekLeave } = await supabaseClient
            .from('staff_availability')
            .select('*, staff:staff_id(first_name, last_name)')
            .gte('date', weekStart.toISOString().split('T')[0])
            .lte('date', weekEnd.toISOString().split('T')[0])
            .eq('is_available', false)
            .order('date');
        
        // Load regular availability patterns
        const { data: availabilityPatterns } = await supabaseClient
            .from('staff_weekly_availability')
            .select('*, staff:staff_id(first_name, last_name)')
            .order('staff_id, day_of_week');
        
        // Build enhanced availability view
        let html = `
            <style>
                .availability-wrapper {
                    background: white;
                    border-radius: var(--radius-lg);
                    overflow: hidden;
                    margin-bottom: 20px;
                }
                .availability-tabs {
                    display: flex;
                    background: var(--bg-light);
                    border-bottom: 2px solid var(--border-color);
                }
                .availability-tab {
                    flex: 1;
                    padding: 15px;
                    text-align: center;
                    cursor: pointer;
                    background: transparent;
                    border: none;
                    font-weight: 500;
                    transition: all 0.3s;
                }
                .availability-tab.active {
                    background: white;
                    border-bottom: 3px solid var(--primary-color);
                    color: var(--primary-color);
                }
                .availability-content {
                    padding: 20px;
                }
                .week-grid {
                    display: grid;
                    grid-template-columns: repeat(7, 1fr);
                    gap: 10px;
                    margin-top: 20px;
                }
                .day-card {
                    background: white;
                    border: 1px solid var(--border-color);
                    border-radius: 8px;
                    min-height: 200px;
                    overflow: hidden;
                }
                .day-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px;
                    text-align: center;
                }
                .day-header.weekend {
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                }
                .day-date {
                    font-size: 11px;
                    opacity: 0.9;
                }
                .day-name {
                    font-weight: 600;
                    font-size: 14px;
                }
                .day-content {
                    padding: 12px;
                    max-height: 150px;
                    overflow-y: auto;
                }
                .leave-indicator {
                    margin-bottom: 8px;
                    padding: 8px;
                    border-radius: 6px;
                    font-size: 12px;
                    background: var(--bg-light);
                    border-left: 3px solid;
                }
                .leave-indicator.annual {
                    border-color: #17a2b8;
                    background: #d1ecf1;
                }
                .leave-indicator.sick {
                    border-color: #dc3545;
                    background: #f8d7da;
                }
                .leave-indicator.personal {
                    border-color: #ffc107;
                    background: #fff3cd;
                }
                .leave-indicator.other {
                    border-color: #6c757d;
                    background: #e2e3e5;
                }
                .staff-name {
                    font-weight: 600;
                    color: var(--text-primary);
                }
                .leave-type {
                    font-size: 10px;
                    text-transform: uppercase;
                    opacity: 0.8;
                }
                .availability-summary {
                    background: var(--bg-light);
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                }
                .summary-stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 15px;
                }
                .stat-item {
                    text-align: center;
                }
                .stat-value {
                    font-size: 24px;
                    font-weight: 700;
                    color: var(--primary-color);
                }
                .stat-label {
                    font-size: 12px;
                    color: var(--text-muted);
                    text-transform: uppercase;
                }
            </style>
            
            <div class="availability-wrapper">
                <div class="availability-tabs">
                    <button class="availability-tab active" onclick="switchAvailabilityView('week')">
                        Week View
                    </button>
                    <button class="availability-tab" onclick="switchAvailabilityView('staff')">
                        Staff Patterns
                    </button>
                    <button class="availability-tab" onclick="switchAvailabilityView('summary')">
                        Summary
                    </button>
                </div>
                
                <div class="availability-content">
                    <div id="weekView">
                        <h3>Week of ${formatDateShort(weekStart.toISOString())}</h3>
                        
                        <div class="availability-summary">
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <div class="stat-value">${staff.length}</div>
                                    <div class="stat-label">Total Staff</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${weekLeave ? weekLeave.length : 0}</div>
                                    <div class="stat-label">On Leave</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${staff.length - (weekLeave ? weekLeave.length : 0)}</div>
                                    <div class="stat-label">Available</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="week-grid">
        `;
        
        // Create day cards
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        for (let day = 0; day < 7; day++) {
            const currentDate = new Date(weekStart);
            currentDate.setDate(currentDate.getDate() + day);
            const dateStr = currentDate.toISOString().split('T')[0];
            const dayName = dayNames[currentDate.getDay()];
            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
            
            // Get leave for this day
            const dayLeave = weekLeave ? weekLeave.filter(l => l.date === dateStr) : [];
            
            html += `
                <div class="day-card" data-date="${dateStr}">
                    <div class="day-header ${isWeekend ? 'weekend' : ''}">
                        <div class="day-name">${dayName}</div>
                        <div class="day-date">${formatDateShort(dateStr)}</div>
                    </div>
                    <div class="day-content">
            `;
            
            if (dayLeave.length > 0) {
                dayLeave.forEach(leave => {
                    const leaveType = leave.reason || 'Leave';
                    let typeClass = 'other';
                    if (leaveType.toLowerCase().includes('annual')) typeClass = 'annual';
                    else if (leaveType.toLowerCase().includes('sick')) typeClass = 'sick';
                    else if (leaveType.toLowerCase().includes('personal')) typeClass = 'personal';
                    
                    html += `
                        <div class="leave-indicator ${typeClass}">
                            <div class="staff-name">
                                ${leave.staff.first_name} ${leave.staff.last_name}
                            </div>
                            <div class="leave-type">${leaveType}</div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="text-align: center; padding: 40px 10px; color: var(--text-muted);">
                        <div style="font-size: 24px; margin-bottom: 5px;">✅</div>
                        <div style="font-size: 12px;">All Available</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        
        html += `
                        </div>
                    </div>
                    
                    <div id="staffView" style="display: none;">
                        <h3>Staff Availability Patterns</h3>
                        <div style="margin-top: 20px;">
                            <!-- Staff patterns will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="summaryView" style="display: none;">
                        <h3>Availability Summary</h3>
                        <div style="margin-top: 20px;">
                            <!-- Summary statistics will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="availability-legend" style="margin-top: 20px; padding: 15px; background: var(--bg-light); border-radius: 8px;">
                <strong>Legend:</strong>
                <span class="badge badge-info" style="margin: 0 5px;">Annual Leave</span>
                <span class="badge badge-danger" style="margin: 0 5px;">Sick Leave</span>
                <span class="badge badge-warning" style="margin: 0 5px;">Personal Leave</span>
                <span class="badge badge-secondary" style="margin: 0 5px;">Other</span>
            </div>
        `;
        
        availabilityContent.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading availability:', error);
        availabilityContent.innerHTML = '<div class="error">Failed to load availability data</div>';
    }
}

// This goes in the modal HTML structure - add after participant select
function getAddShiftModalTemplateHTML() {
    return `
        <div class="form-group" id="templateGroup" style="display: none;">
            <label>Use Template (Optional)</label>
            <select id="shiftTemplate" class="form-control" onchange="applyShiftTemplate(this.value)">
                <option value="">-- Select Template --</option>
            </select>
            <small class="form-text text-muted">
                Templates provide pre-filled shift settings for this participant
            </small>
        </div>
    `;
}
// Helper function to switch availability views
function switchAvailabilityView(view) {
    // Update tab active states
    document.querySelectorAll('.availability-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show/hide views
    document.getElementById('weekView').style.display = view === 'week' ? 'block' : 'none';
    document.getElementById('staffView').style.display = view === 'staff' ? 'block' : 'none';
    document.getElementById('summaryView').style.display = view === 'summary' ? 'block' : 'none';
}


function showOverlapTooltip(event, shiftId) {
    // Implementation for hover tooltip showing overlap details
    const tooltip = document.createElement('div');
    tooltip.className = 'overlap-tooltip';
    tooltip.id = 'overlapTooltip';
    
    const shift = shifts.find(s => s.id === shiftId);
    if (shift?.overlap_info) {
        tooltip.innerHTML = `
            <strong>${shift.overlap_info.ratio} Care Ratio</strong><br>
            ${shift.overlap_info.staff.map(s => 
                `${s.staff.first_name} ${s.staff.last_name}: ${s.time}`
            ).join('<br>')}
        `;
        
        tooltip.style.position = 'absolute';
        tooltip.style.left = event.pageX + 10 + 'px';
        tooltip.style.top = event.pageY + 10 + 'px';
        
        document.body.appendChild(tooltip);
    }
}

function hideOverlapTooltip() {
    const tooltip = document.getElementById('overlapTooltip');
    if (tooltip) tooltip.remove();
}

function renderShiftActions(shift) {
    let actions = [];
    
    // Admin/Manager can edit any shift
    if (currentUserRole === 'admin' || currentUserRole === 'manager') {
        actions.push(`<button class="btn btn-outline btn-sm" onclick="editShift(${shift.id})">Edit</button>`);
    }
    
    // All users can add notes - Updated to call showAddNoteModal directly
    actions.push(`<button class="btn btn-outline btn-sm" onclick="showAddNoteModal(${shift.id})">Note</button>`);
    
    return actions.join('');
}

        function groupShiftsByDate(shifts) {
            const groups = {};
            shifts.forEach(shift => {
                if (!groups[shift.date]) {
                    groups[shift.date] = [];
                }
                groups[shift.date].push(shift);
            });
            return groups;
        }

        function calculateDayStats(dayShifts) {
            return dayShifts.reduce((stats, shift) => {
                const hours = shift.calculated_hours || { total: 0 };
                stats.shifts++;
                stats.totalHours += hours.total;
                stats.totalPay += shift.calculated_pay || 0;
                return stats;
            }, { shifts: 0, totalHours: 0, totalPay: 0 });
        }

        function generateHourBreakdownTooltip(hours) {
            const parts = [];
            if (hours.weekdayDay > 0) parts.push(`Day: ${formatHours(hours.weekdayDay)}h`);
            if (hours.weekdayEvening > 0) parts.push(`Evening: ${formatHours(hours.weekdayEvening)}h`);
            if (hours.weekdayNight > 0) parts.push(`Night: ${formatHours(hours.weekdayNight)}h`);
            if (hours.saturday > 0) parts.push(`Saturday: ${formatHours(hours.saturday)}h`);
            if (hours.sunday > 0) parts.push(`Sunday: ${formatHours(hours.sunday)}h`);
            if (hours.publicHoliday > 0) parts.push(`Holiday: ${formatHours(hours.publicHoliday)}h`);
            if (hours.sleepover > 0) parts.push(`Sleepover: ${formatHours(hours.sleepover)}h`);
            
            return parts.join(' | ') || 'No breakdown available';
        }

        function generatePayBreakdownDisplay(hours) {
            const parts = [];
            if (hours.weekdayDay > 0) parts.push(`D:${formatHours(hours.weekdayDay)}`);
            if (hours.weekdayEvening > 0) parts.push(`E:${formatHours(hours.weekdayEvening)}`);
            if (hours.weekdayNight > 0) parts.push(`N:${formatHours(hours.weekdayNight)}`);
            if (hours.saturday > 0) parts.push(`Sa:${formatHours(hours.saturday)}`);
            if (hours.sunday > 0) parts.push(`Su:${formatHours(hours.sunday)}`);
            if (hours.publicHoliday > 0) parts.push(`PH:${formatHours(hours.publicHoliday)}`);
            if (hours.sleepover > 0) parts.push(`SL:${formatHours(hours.sleepover)}`);
            
            return parts.join(' • ') || '—';
        }


        function createSearchableDropdown(selectId, options = {}) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'searchable-dropdown-wrapper';
    wrapper.style.position = 'relative';
    
    // Create search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control searchable-input';
    searchInput.placeholder = options.placeholder || 'Type to search...';
    searchInput.style.cssText = `
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    `;
    
    // Create dropdown list
    const dropdownList = document.createElement('div');
    dropdownList.className = 'searchable-dropdown-list';
    dropdownList.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        display: none;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    
    // Store selected value
    let selectedValue = select.value;
    let selectedText = '';
    
    // Get options from original select
    const originalOptions = Array.from(select.options).map(opt => ({
        value: opt.value,
        text: opt.textContent,
        data: opt.dataset
    }));
    
    // Function to update dropdown list
    function updateDropdownList(searchTerm = '') {
        dropdownList.innerHTML = '';
        
        const filtered = originalOptions.filter(opt => 
            opt.text.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        if (filtered.length === 0) {
            dropdownList.innerHTML = '<div style="padding: 8px; color: #999;">No results found</div>';
            return;
        }
        
        filtered.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                transition: background 0.2s;
            `;
            item.textContent = opt.text;
            item.dataset.value = opt.value;
            
            // Copy any data attributes
            Object.keys(opt.data || {}).forEach(key => {
                item.dataset[key] = opt.data[key];
            });
            
            item.onmouseover = () => item.style.background = '#f0f0f0';
            item.onmouseout = () => item.style.background = 'white';
            
            item.onclick = () => {
                selectedValue = opt.value;
                selectedText = opt.text;
                searchInput.value = opt.text;
                select.value = opt.value;
                
                // Trigger change event on original select
                const event = new Event('change', { bubbles: true });
                select.dispatchEvent(event);
                
                dropdownList.style.display = 'none';
            };
            
            dropdownList.appendChild(item);
        });
    }
    
    // Event handlers
    searchInput.onfocus = () => {
        updateDropdownList('');
        dropdownList.style.display = 'block';
    };
    
    searchInput.oninput = (e) => {
        updateDropdownList(e.target.value);
        dropdownList.style.display = 'block';
    };
    
    // Click outside to close
    document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // Set initial value
    if (select.value) {
        const initial = originalOptions.find(opt => opt.value === select.value);
        if (initial) {
            searchInput.value = initial.text;
            selectedText = initial.text;
        }
    }
    
    // Replace select with wrapper
    select.style.display = 'none';
    wrapper.appendChild(searchInput);
    wrapper.appendChild(dropdownList);
    select.parentNode.insertBefore(wrapper, select.nextSibling);
    
    // Store reference for later updates
    select._searchableDropdown = {
        update: () => updateDropdownList(''),
        setValue: (value) => {
            const opt = originalOptions.find(o => o.value === value);
            if (opt) {
                selectedValue = opt.value;
                selectedText = opt.text;
                searchInput.value = opt.text;
                select.value = opt.value;
            }
        },
        getValue: () => selectedValue
    };
    
    return select._searchableDropdown;
}




// ==========================================
// COMPLETE TEMPLATE MANAGEMENT SYSTEM
// ==========================================
// DAY CONVERSION HELPERS
// ==========================================

function uiDayToDbDay(uiDay) {
    // UI: 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat, 7=Sun
    // DB: 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat
    if (uiDay === 7) return 0; // Sunday
    return uiDay; // Monday-Saturday map directly
}

function dbDayToUiDay(dbDay) {
    // DB: 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat  
    // UI: 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat, 7=Sun
    if (dbDay === 0) return 7; // Sunday
    return dbDay; // Monday-Saturday map directly
}

// ==========================================
// LOADING AND RENDERING TEMPLATES
// ==========================================

async function loadTemplates() {
    try {
        const { data: templates, error } = await supabaseClient
            .from('roster_templates')
            .select(`
                *,
                participant:participant_id(first_name, last_name),
                creator:created_by(first_name, last_name),
                roster_template_shifts(*)
            `)
            .eq('is_active', true)
            .order('created_at', { ascending: false });

        if (error) throw error;
        
        rosterTemplates = templates || [];
        renderTemplates();
    } catch (error) {
        console.error('Error loading templates:', error);
        showNotification('Failed to load templates', 'error');
    }
}

function renderTemplates() {
    const container = document.getElementById('templatesContent');
    if (!container) return;
    
    if (rosterTemplates.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-light);">
                <h3>No templates created yet</h3>
                <p>Create your first roster template to get started with auto-rostering</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = rosterTemplates.map(template => `
        <div class="template-item" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div>
                    <h3 style="margin: 0; color: var(--text-primary);">${template.name}</h3>
                    <p style="margin: 4px 0; color: var(--text-muted); font-size: 14px;">
                        ${template.participant ? `For: ${template.participant.first_name} ${template.participant.last_name}` : 'General Template'}
                    </p>
                    ${template.description ? `<p style="margin: 4px 0; color: var(--text-secondary); font-size: 14px;">${template.description}</p>` : ''}
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary btn-sm" onclick="showApplyTemplateModal('${template.id}')">
                        Apply Template
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="editTemplate('${template.id}')">
                        Edit
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="duplicateTemplate('${template.id}')">
                        Duplicate
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${template.id}')">
                        Delete
                    </button>
                </div>
            </div>
            <div style="margin-top: 12px;">
                ${renderTemplateWeekPreview(template)}
            </div>
        </div>
    `).join('');
}

function renderTemplateWeekPreview(template) {
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const shifts = template.roster_template_shifts || [];
    
    let preview = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 12px;">';
    
    days.forEach((day, index) => {
        const uiDay = index + 1; // 1-7 for Mon-Sun
        const dbDay = uiDayToDbDay(uiDay);
        const dayShifts = shifts.filter(s => s.day_of_week === dbDay);
        const isWeekend = index >= 5;
        
        preview += `
            <div style="background: ${isWeekend ? '#f8f9fa' : 'white'}; border: 1px solid var(--border-light); border-radius: 4px; padding: 8px;">
                <div style="font-weight: 600; font-size: 12px; margin-bottom: 4px; color: var(--text-muted);">${day}</div>
                ${dayShifts.length > 0 ? 
                    dayShifts.map(shift => `
                        <div style="background: var(--primary-color); color: white; padding: 2px 4px; border-radius: 2px; font-size: 11px; margin-bottom: 2px;">
                            ${shift.start_time ? formatTime(shift.start_time) : 'Sleepover'}-${shift.end_time ? formatTime(shift.end_time) : ''}
                        </div>
                    `).join('') : 
                    '<div style="color: var(--text-light); font-size: 11px;">No shifts</div>'
                }
            </div>
        `;
    });
    
    preview += '</div>';
    return preview;
}

// ==========================================
// MAIN TEMPLATE CRUD FUNCTIONS
// ==========================================

async function saveTemplate() {
    try {
        const name = document.getElementById('templateName').value;
        const participantId = document.getElementById('templateParticipant').value || null;
        const description = document.getElementById('templateDescription').value || null;
        
        if (!name) {
            showNotification('Please enter a template name', 'warning');
            return;
        }
        
        // Collect shifts from UI for validation
        const shiftsToValidate = [];
        for (let uiDay = 1; uiDay <= 7; uiDay++) {
            const dayContainer = document.getElementById(`day_${uiDay}_shifts`);
            if (!dayContainer) continue;
            
            const shiftElements = dayContainer.querySelectorAll('[id^="shift_"]');
            
            shiftElements.forEach(shiftEl => {
                const startTime = shiftEl.querySelector('[data-field="start_time"]')?.value;
                const endTime = shiftEl.querySelector('[data-field="end_time"]')?.value;
                const staffId = shiftEl.querySelector('[data-field="staff_id"]')?.value;
                const dutyTypeId = shiftEl.querySelector('[data-field="duty_type_id"]')?.value;
                const locationId = shiftEl.querySelector('[data-field="location_id"]')?.value;
                const notes = shiftEl.querySelector('[data-field="notes"]')?.value;
                
                if (startTime || endTime) {
                    shiftsToValidate.push({
                        day_of_week: uiDayToDbDay(uiDay),
                        start_time: startTime || null,
                        end_time: endTime || null,
                        staff_id: staffId && staffId !== '' ? staffId : null, // FIX HERE
                        duty_type_id: dutyTypeId || null,
                        location_id: locationId || null,
                        notes: notes || null,
                        ui_day: uiDay
                    });
                }
            });
        }

        // Check for conflicts within the template itself
        const templateConflicts = checkTemplateInternalConflicts(shiftsToValidate);
        
        if (templateConflicts.length > 0) {
            const shouldContinue = await showTemplateConflictDialog(templateConflicts, 'save');
            if (!shouldContinue) {
                return;
            }
        }
        
        // Create template
        const { data: template, error: templateError } = await supabaseClient
            .from('roster_templates')
            .insert({
                name: name,
                participant_id: participantId,
                description: description,
                is_active: true,
                created_by: currentStaffData?.id || currentUser?.id || null
            })
            .select()
            .single();
        
        if (templateError) throw templateError;
        
        // Prepare shifts for insertion
        const shiftsToInsert = shiftsToValidate.map(shift => ({
            template_id: template.id,
            day_of_week: shift.day_of_week,
            start_time: shift.start_time,
            end_time: shift.end_time,
            staff_id: shift.staff_id,
            duty_type_id: shift.duty_type_id,
            location_id: shift.location_id,
            notes: shift.notes
        }));
        
        if (shiftsToInsert.length > 0) {
            const { error: shiftsError } = await supabaseClient
                .from('roster_template_shifts')
                .insert(shiftsToInsert);
            
            if (shiftsError) throw shiftsError;
        }
        
        showNotification('Template created successfully', 'success');
        document.querySelector('.modal-overlay')?.remove();
        await loadTemplates();
        
    } catch (error) {
        console.error('Error saving template:', error);
        showNotification('Failed to save template', 'error');
    }
}

async function updateTemplate(templateId) {
    try {
        const name = document.getElementById('templateName').value;
        const participantId = document.getElementById('templateParticipant').value;
        const description = document.getElementById('templateDescription').value;
        
        if (!name) {
            showNotification('Please enter a template name', 'warning');
            return;
        }
        
        // Collect shifts from UI for validation
        const shiftsToValidate = [];
        for (let uiDay = 1; uiDay <= 7; uiDay++) {
            const dayContainer = document.getElementById(`day_${uiDay}_shifts`);
            if (!dayContainer) continue;
            
            const shiftElements = dayContainer.querySelectorAll('[id^="shift_"]');
            
            shiftElements.forEach(shiftEl => {
                const startTime = shiftEl.querySelector('[data-field="start_time"]')?.value;
                const endTime = shiftEl.querySelector('[data-field="end_time"]')?.value;
                const staffId = shiftEl.querySelector('[data-field="staff_id"]')?.value;
                const dutyTypeId = shiftEl.querySelector('[data-field="duty_type_id"]')?.value;
                const locationId = shiftEl.querySelector('[data-field="location_id"]')?.value;
                const notes = shiftEl.querySelector('[data-field="notes"]')?.value;
                
                if (startTime || endTime) {
                    shiftsToValidate.push({
                        day_of_week: uiDayToDbDay(uiDay),
                        start_time: startTime || null,
                        end_time: endTime || null,
                        staff_id: staffId || null,
                        duty_type_id: dutyTypeId || null,
                        location_id: locationId || null,
                        notes: notes || null,
                        ui_day: uiDay
                    });
                }
            });
        }
        
        // Check for conflicts within the template itself
        const templateConflicts = checkTemplateInternalConflicts(shiftsToValidate);
        
        if (templateConflicts.length > 0) {
            const shouldContinue = await showTemplateConflictDialog(templateConflicts, 'update');
            if (!shouldContinue) {
                return;
            }
        }
        
        // Update template
        const { error: updateError } = await supabaseClient
            .from('roster_templates')
            .update({
                name: name,
                participant_id: participantId || null,
                description: description || null,
                updated_at: new Date().toISOString()
            })
            .eq('id', templateId);
        
        if (updateError) throw updateError;
        
        // Delete existing shifts and recreate
        await supabaseClient
            .from('roster_template_shifts')
            .delete()
            .eq('template_id', templateId);
        
        // Prepare shifts for insertion
        const shiftsToInsert = shiftsToValidate.map(shift => ({
            template_id: templateId,
            day_of_week: shift.day_of_week,
            start_time: shift.start_time,
            end_time: shift.end_time,
            staff_id: shift.staff_id,
            duty_type_id: shift.duty_type_id,
            location_id: shift.location_id,
            notes: shift.notes
        }));
        
        if (shiftsToInsert.length > 0) {
            const { error: shiftsError } = await supabaseClient
                .from('roster_template_shifts')
                .insert(shiftsToInsert);
            
            if (shiftsError) throw shiftsError;
        }
        
        showNotification('Template updated successfully', 'success');
        document.querySelector('.modal-overlay')?.remove();
        loadTemplates();
        
    } catch (error) {
        console.error('Error updating template:', error);
        showNotification('Failed to update template', 'error');
    }
}

// ==========================================
// FIXED EDIT TEMPLATE FUNCTION - Replace your existing editTemplate function
// ==========================================

async function editTemplate(templateId) {
    const template = rosterTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    console.log('Editing template:', template);
    
    openCreateTemplateModal();
    
    setTimeout(async () => {
        document.getElementById('templateName').value = template.name;
        document.getElementById('templateParticipant').value = template.participant_id || '';
        document.getElementById('templateDescription').value = template.description || '';
        
        for (let day = 1; day <= 7; day++) {
            const container = document.getElementById(`day_${day}_shifts`);
            if (container) container.innerHTML = '';
        }
        
        for (const shift of template.roster_template_shifts) {
            const uiDay = dbDayToUiDay(shift.day_of_week);
            
            await addShiftToDay(uiDay);
            
            // CRITICAL FIX: Wait for dropdowns to populate
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const dayContainer = document.getElementById(`day_${uiDay}_shifts`);
            const lastShift = dayContainer.lastElementChild;
            
            if (lastShift) {
                const startTimeInput = lastShift.querySelector('[data-field="start_time"]');
                const endTimeInput = lastShift.querySelector('[data-field="end_time"]');
                const staffSelect = lastShift.querySelector('[data-field="staff_id"]');
                const dutySelect = lastShift.querySelector('[data-field="duty_type_id"]');
                const locationSelect = lastShift.querySelector('[data-field="location_id"]');
                const notesInput = lastShift.querySelector('[data-field="notes"]');
                const clockInCheckbox = lastShift.querySelector('[data-field="clock_in_required"]');
                
                if (startTimeInput) startTimeInput.value = shift.start_time || '';
                if (endTimeInput) endTimeInput.value = shift.end_time || '';
                if (staffSelect) staffSelect.value = shift.staff_id || '';
                if (dutySelect) dutySelect.value = shift.duty_type_id || '';
                if (locationSelect) locationSelect.value = shift.location_id || '';
                if (notesInput) notesInput.value = shift.notes || '';  // FIX: Added notes
                if (clockInCheckbox) clockInCheckbox.checked = shift.clock_in_required || false;  // FIX: Added clock-in
            }
        }
        
        const saveBtn = document.querySelector('.modal-footer .btn-primary');
        if (saveBtn) {
            saveBtn.textContent = 'Update Template';
            saveBtn.onclick = () => updateTemplate(templateId);
        }
    }, 150);
}



async function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template? This cannot be undone.')) {
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('roster_templates')
            .delete()
            .eq('id', templateId);
        
        if (error) throw error;
        
        showNotification('Template deleted successfully', 'success');
        loadTemplates();
        
    } catch (error) {
        console.error('Error deleting template:', error);
        showNotification('Failed to delete template', 'error');
    }
}

async function duplicateTemplate(templateId) {
    try {
        const template = rosterTemplates.find(t => t.id === templateId);
        if (!template) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal" style="max-width: 500px;">
                <header class="modal-header">
                    <h3 class="modal-title">Duplicate Template</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </header>
                <div class="modal-content">
                    <div class="form-group">
                        <label>New Template Name *</label>
                        <input type="text" id="duplicateName" class="form-control" 
                               value="${template.name} (Copy)" 
                               placeholder="Enter name for the duplicated template">
                    </div>
                    
                    <div class="form-group">
                        <label>Assign to Different Participant?</label>
                        <select id="duplicateParticipant" class="form-control">
                            <option value="${template.participant_id || ''}">
                                ${template.participant_id ? 
                                    `Keep same (${template.participant?.first_name} ${template.participant?.last_name})` : 
                                    'Keep as general template'}
                            </option>
                            <option value="">General Template (No specific participant)</option>
                            ${participants.map(p => 
                                `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="duplicateModifyShifts">
                            Modify shifts after duplication
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                    <button class="btn btn-primary" onclick="executeDuplicateTemplate('${templateId}', this)">
                        Create Duplicate
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error in duplicateTemplate:', error);
        showNotification('Failed to duplicate template', 'error');
    }
}

async function executeDuplicateTemplate(templateId, button) {
    try {
        const modal = button.closest('.modal-overlay');
        const template = rosterTemplates.find(t => t.id === templateId);
        if (!template) throw new Error('Template not found');
        
        const newName = document.getElementById('duplicateName').value;
        const newParticipantId = document.getElementById('duplicateParticipant').value;
        const modifyAfter = document.getElementById('duplicateModifyShifts').checked;
        
        if (!newName) {
            showNotification('Please enter a name for the duplicated template', 'warning');
            return;
        }
        
        const { data: newTemplate, error: templateError } = await supabaseClient
            .from('roster_templates')
            .insert({
                name: newName,
                participant_id: newParticipantId || null,
                description: template.description,
                created_by: currentStaffData?.id || null,
                is_active: true
            })
            .select()
            .single();
        
        if (templateError) throw templateError;
        
        const shiftsToInsert = template.roster_template_shifts.map(shift => ({
            template_id: newTemplate.id,
            day_of_week: shift.day_of_week,
            start_time: shift.start_time,
            end_time: shift.end_time,
            staff_id: shift.staff_id,
            duty_type_id: shift.duty_type_id,
            location_id: shift.location_id,
            notes: shift.notes
        }));
        
        if (shiftsToInsert.length > 0) {
            const { error: shiftsError } = await supabaseClient
                .from('roster_template_shifts')
                .insert(shiftsToInsert);
            
            if (shiftsError) throw shiftsError;
        }
        
        showNotification('Template duplicated successfully', 'success');
        modal.remove();
        
        if (modifyAfter) {
            setTimeout(() => {
                editTemplate(newTemplate.id);
            }, 500);
        }
        
        loadTemplates();
        
    } catch (error) {
        console.error('Error duplicating template:', error);
        showNotification('Failed to duplicate template', 'error');
    }
}

// ==========================================
// TEMPLATE APPLICATION WITH CONFLICT CHECKING
// ==========================================

async function executeTemplateApplication(templateId) {
    try {
        const template = rosterTemplates.find(t => t.id === templateId);
        if (!template) throw new Error('Template not found');
        
        const startDate = new Date(document.getElementById('applyStartDate').value);
        const endDate = new Date(document.getElementById('applyEndDate').value);
        const participantId = document.getElementById('applyParticipant').value;
        const skipExisting = document.getElementById('skipExisting').checked;
        const clockInSetting = document.getElementById('clockInRequirement').value;
        
        if (!participantId) {
            showNotification('Please select a participant', 'warning');
            return;
        }
        
        if (!startDate || !endDate || startDate > endDate) {
            showNotification('Please select a valid date range', 'warning');
            return;
        }
        
        const participant = await getParticipantWithDefaults(participantId);
        if (!participant) {
            showNotification('Participant not found', 'error');
            return;
        }
        
        const staffAssignments = await loadStaffAssignments(participantId);
        const systemDefaults = await loadSystemDefaults();
        
        const processResult = await processTemplateShifts({
            template,
            startDate,
            endDate,
            participant,
            skipExisting,
            staffAssignments,
            systemDefaults,
            clockInSetting // Pass the clock-in setting
        });
        
        if (processResult.conflicts.length > 0) {
            const shouldContinue = await showApplicationConflictDialog(
                processResult.conflicts, 
                processResult.validShifts.length
            );
            if (!shouldContinue) {
                return;
            }
        }
        
        if (processResult.validShifts.length > 0) {
            // Log what we're about to insert for debugging
            console.log('Inserting shifts:', processResult.validShifts);
            
            const { data, error } = await supabaseClient
                .from('shifts')
                .insert(processResult.validShifts);
            
            if (error) {
                console.error('Database error:', error);
                throw error;
            }
            
            const message = processResult.conflicts.length > 0 
                ? `Created ${processResult.validShifts.length} shifts (${processResult.conflicts.length} skipped due to conflicts)`
                : `Created ${processResult.validShifts.length} shifts from template`;
            
            showNotification(message, 'success');
            
            document.querySelector('.modal-overlay')?.remove();
            if (typeof loadShifts === 'function') {
                await loadShifts();
            }
        } else {
            showNotification('No shifts to create (all conflicted or already exist)', 'info');
        }
        
    } catch (error) {
        console.error('Error applying template:', error);
        showNotification(`Failed to apply template: ${error.message}`, 'error');
    }
}


function showApplyTemplateModal(templateId) {
    const template = rosterTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <header class="modal-header">
                <h3 class="modal-title">Apply Template: ${template.name}</h3>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </header>
            <div class="modal-content">
                <div class="form-group">
                    <label>Start Date *</label>
                    <input type="date" id="applyStartDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                </div>
                
                <div class="form-group">
                    <label>End Date *</label>
                    <input type="date" id="applyEndDate" class="form-control" value="${new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0]}">
                </div>
                
                <div class="form-group">
                    <label>Apply To Participant</label>
                    <select id="applyParticipant" class="form-control">
                        ${template.participant_id ? 
                            `<option value="${template.participant_id}" selected>${template.participant?.first_name} ${template.participant?.last_name}</option>` :
                            `<option value="">Select Participant</option>`
                        }
                        ${participants.filter(p => p.id !== template.participant_id).map(p => 
                            `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="skipExisting" checked>
                        Skip dates that already have shifts
                    </label>
                </div>
                
                <div class="form-group">
                    <label>Clock-in Requirement</label>
                    <select id="clockInRequirement" class="form-control">
                        <option value="auto">Auto (based on date)</option>
                        <option value="always">Always require clock-in</option>
                        <option value="never">Never require clock-in</option>
                    </select>
                    <small class="text-muted">Auto: Past/today = no clock-in, Future = clock-in required</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="executeTemplateApplication('${templateId}')">Apply Template</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}



// ==========================================
// PARTICIPANT-SPECIFIC TEMPLATE FUNCTIONS
// ==========================================

async function loadParticipantTemplates(participantId) {
    const templateSelect = document.getElementById('shiftTemplate');
    if (!templateSelect) return;
    
    if (!participantId) {
        templateSelect.innerHTML = '<option value="">-- Select a participant first --</option>';
        templateSelect.disabled = true;
        return;
    }
    
    try {
        templateSelect.innerHTML = '<option value="">Loading templates...</option>';
        templateSelect.disabled = true;
        
        const { data: templates, error } = await supabaseClient
            .from('roster_templates')
            .select(`
                *,
                roster_template_shifts(*)
            `)
            .or(`participant_id.eq.${participantId},participant_id.is.null`)
            .eq('is_active', true)
            .order('name');
        
        if (error) throw error;
        
        templateSelect.innerHTML = '<option value="">-- No Template --</option>';
        templateSelect.disabled = false;
        
        if (templates && templates.length > 0) {
            const participantTemplates = templates.filter(t => t.participant_id === participantId);
            const generalTemplates = templates.filter(t => !t.participant_id);
            
            if (participantTemplates.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Participant Templates';
                participantTemplates.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.dataset.template = JSON.stringify(t);
                    option.textContent = `${t.name} (${t.roster_template_shifts?.length || 0} shifts)`;
                    optgroup.appendChild(option);
                });
                templateSelect.appendChild(optgroup);
            }
            
            if (generalTemplates.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'General Templates';
                generalTemplates.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.dataset.template = JSON.stringify(t);
                    option.textContent = `${t.name} (${t.roster_template_shifts?.length || 0} shifts)`;
                    optgroup.appendChild(option);
                });
                templateSelect.appendChild(optgroup);
            }
        }
        
    } catch (error) {
        console.error('Error loading templates:', error);
        templateSelect.innerHTML = '<option value="">Error loading templates</option>';
        showNotification('Failed to load templates', 'error');
    }
}

function applySelectedTemplate() {
    const templateSelect = document.getElementById('shiftTemplate');
    if (!templateSelect || !templateSelect.value) return;
    
    const selectedOption = templateSelect.selectedOptions[0];
    if (!selectedOption || !selectedOption.dataset.template) return;
    
    try {
        const template = JSON.parse(selectedOption.dataset.template);
        applyTemplateToForm(template);
    } catch (error) {
        console.error('Error applying template:', error);
        showNotification('Failed to apply template', 'error');
    }
}

function applyTemplateToForm(template) {
    if (!template) return;
    
    const shifts = template.roster_template_shifts || [];
    if (shifts.length === 0) {
        showNotification('Template has no shifts defined', 'warning');
        return;
    }
    
    const shift = shifts[0];
    
    const fieldMap = {
        'shiftStartTime': shift.start_time,
        'shiftEndTime': shift.end_time,
        'shiftDutyType': shift.duty_type_id,
        'shiftLocation': shift.location_id,
        'shiftStaff': shift.staff_id,
        'shiftNotes': shift.notes
    };
    
    const appliedFields = [];
    Object.entries(fieldMap).forEach(([fieldId, value]) => {
        if (value !== null && value !== undefined) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value;
                appliedFields.push(field);
                
                field.style.transition = 'background-color 0.3s';
                field.style.backgroundColor = '#e8f5e9';
                setTimeout(() => {
                    field.style.backgroundColor = '';
                }, 2000);
            }
        }
    });
    
    if (shift.day_of_week !== undefined && shift.day_of_week !== null) {
        suggestDateForDayOfWeek(shift.day_of_week);
    }
    
    showNotification(`Template "${template.name}" applied`, 'success');
    
    if (shifts.length > 1) {
        if (confirm(`This template has ${shifts.length} shifts. Would you like to create all of them?`)) {
            createMultipleShiftsFromTemplate(template);
        }
    }
}

async function saveAsTemplate() {
    const templateName = prompt('Enter a name for this template:');
    if (!templateName) return;
    
    const participantSelect = document.getElementById('shiftParticipant');
    const participantId = participantSelect?.value || null;
    
    const shiftConfig = {
        start_time: document.getElementById('shiftStartTime')?.value,
        end_time: document.getElementById('shiftEndTime')?.value,
        staff_id: document.getElementById('shiftStaff')?.value || null,
        duty_type_id: document.getElementById('shiftDutyType')?.value,
        location_id: document.getElementById('shiftLocation')?.value,
        notes: document.getElementById('shiftNotes')?.value,
        day_of_week: new Date(document.getElementById('shiftDate')?.value).getDay() || 7
    };
    
    try {
        const { data: template, error: templateError } = await supabaseClient
            .from('roster_templates')
            .insert({
                name: templateName,
                participant_id: participantId,
                description: `Template created from shift`,
                is_active: true,
                created_by: currentUser?.id
            })
            .select()
            .single();
        
        if (templateError) throw templateError;
        
        const { error: shiftError } = await supabaseClient
            .from('roster_template_shifts')
            .insert({
                template_id: template.id,
                ...shiftConfig
            });
        
        if (shiftError) throw shiftError;
        
        showNotification('Template saved successfully', 'success');
        
        if (participantId) {
            await loadParticipantTemplates(participantId);
        }
        
    } catch (error) {
        console.error('Error saving template:', error);
        showNotification('Failed to save template', 'error');
    }
}

// ==========================================
// TEMPLATE UI MODAL FUNCTIONS
// ==========================================

function openCreateTemplateModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    
    modal.innerHTML = `
        <div class="modal" style="max-width: 900px; width: 90%; max-height: 90vh;">
            <header class="modal-header">
                <h3 class="modal-title">Create Roster Template</h3>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </header>
            <div class="modal-content" style="overflow-y: auto;">
                <div class="form-group">
                    <label>Template Name *</label>
                    <input type="text" id="templateName" class="form-control" placeholder="e.g., Weekday Morning Support">
                </div>
                
                <div class="form-group">
                    <label>Assign to Participant (Optional)</label>
                    <select id="templateParticipant" class="form-control" onchange="onTemplateParticipantChange(this.value)">
                        <option value="">General Template (Any Participant)</option>
                        ${participants.filter(p => p.is_active && p.first_name !== 'My Carers')
                            .sort((a, b) => `${a.first_name} ${a.last_name}`.localeCompare(`${b.first_name} ${b.last_name}`))
                            .map(p => `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`)
                            .join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="templateDescription" class="form-control" rows="2" 
                              placeholder="Brief description of this template"></textarea>
                </div>
                
                <div id="participantLocationWarning" class="alert alert-warning" style="display: none; margin-top: 12px;">
                    <strong>⚠️ Location Not Set:</strong> <span id="locationWarningText"></span>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 16px;">Weekly Schedule</h4>
                
                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-light); border-radius: 8px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="font-weight: 600; margin-right: 8px;">Quick Actions:</span>
                        <button type="button" class="btn btn-outline btn-sm" onclick="copyWeekdaysToAll()">
                            Copy Monday to all weekdays
                        </button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="clearAllDays()">
                            Clear all days
                        </button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="loadSampleTemplate()">
                            Load sample schedule
                        </button>
                    </div>
                </div>
                
                <div id="templateWeekSchedule">
                    ${generateWeekScheduleBuilder()}
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    if (typeof dutyTypes === 'undefined' || !dutyTypes) {
        loadDutyTypes();
    }
}

function generateWeekScheduleBuilder() {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    let html = '<div style="display: grid; gap: 16px;">';
    
    days.forEach((day, index) => {
        html += `
            <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h5 style="margin: 0; color: var(--text-primary);">${day}</h5>
                    <button type="button" class="btn btn-outline btn-sm" onclick="duplicateDay(${index + 1})" title="Copy ${day}'s shifts to other days">
                        📋 Copy Day
                    </button>
                </div>
                <div id="day_${index + 1}_shifts"></div>
                <button type="button" class="btn btn-outline btn-sm" style="margin-top: 8px;" onclick="addShiftToDay(${index + 1})">
                    + Add Shift
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

async function addShiftToDay(dayNumber) {
    const container = document.getElementById(`day_${dayNumber}_shifts`);
    if (!container) return;
    
    const shiftId = `shift_${dayNumber}_${Date.now()}`;
    const participantId = document.getElementById('templateParticipant')?.value;
    
    const shiftHtml = `
        <div id="${shiftId}" class="shift-entry" style="
            padding: 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 12px;
        ">
            <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 2fr 2fr auto; gap: 12px; align-items: end;">
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Start Time</label>
                    <input type="time" data-field="start_time" class="form-control">
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">End Time</label>
                    <input type="time" data-field="end_time" class="form-control">
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Staff</label>
                    <select data-field="staff_id" class="form-control">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Duty Type</label>
                    <select data-field="duty_type_id" class="form-control">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Location</label>
                    <select data-field="location_id" class="form-control">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        style="height: 38px;"
                        onclick="document.getElementById('${shiftId}').remove()">
                    ✕
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-top: 12px;">
                <div class="form-group" style="margin: 0;">
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85em;">
                        <input type="checkbox" data-field="clock_in_required" style="width: 16px; height: 16px;">
                        Clock-in Required
                    </label>
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.85em; margin-bottom: 4px;">Notes (Optional)</label>
                    <input type="text" data-field="notes" class="form-control" 
                           placeholder="Additional notes for this shift">
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', shiftHtml);
    
    const newShift = document.getElementById(shiftId);
    const staffDropdown = newShift.querySelector('[data-field="staff_id"]');
    const dutyDropdown = newShift.querySelector('[data-field="duty_type_id"]');
    const locationDropdown = newShift.querySelector('[data-field="location_id"]');
    
    await updateStaffDropdownForParticipant(staffDropdown, participantId);
    await populateDutyTypeDropdown(dutyDropdown);
    await populateLocationDropdown(locationDropdown, participantId);
}



async function onTemplateParticipantChange(participantId) {
    const allStaffDropdowns = document.querySelectorAll('[data-field="staff_id"]');
    for (const dropdown of allStaffDropdowns) {
        await updateStaffDropdownForParticipant(dropdown, participantId);
    }
    
    const allLocationDropdowns = document.querySelectorAll('[data-field="location_id"]');
    for (const dropdown of allLocationDropdowns) {
        await populateLocationDropdown(dropdown, participantId);
    }
    
    if (participantId) {
        const locationCheck = await validateParticipantLocation(participantId);
        const warningDiv = document.getElementById('participantLocationWarning');
        const warningText = document.getElementById('locationWarningText');
        
        if (locationCheck.warning) {
            warningDiv.style.display = 'block';
            warningText.textContent = locationCheck.message;
        } else {
            warningDiv.style.display = 'none';
        }
    } else {
        document.getElementById('participantLocationWarning').style.display = 'none';
    }
}

async function updateStaffDropdownForParticipant(dropdown, participantId) {
    const currentValue = dropdown.value;
    
    if (!participantId) {
        dropdown.innerHTML = `
            <option value="">Please select a participant first</option>
        `;
        dropdown.disabled = true;
    } else {
        dropdown.disabled = false;
        
        const { data: assignments, error } = await supabaseClient
            .from('staff_participant_assignments')
            .select('staff_id, pay_rate_id, staff:staff_id(id, first_name, last_name, is_active)')
            .eq('participant_id', participantId)
            .or('end_date.is.null,end_date.gte.' + new Date().toISOString().split('T')[0]);
        
        if (error) {
            console.error('Error fetching staff assignments:', error);
            dropdown.innerHTML = '<option value="">Error loading staff</option>';
            return;
        }
        
        const assignedStaff = assignments
            ?.filter(a => a.staff && a.staff.is_active)
            .map(a => ({
                ...a.staff,
                pay_rate_id: a.pay_rate_id
            }))
            .sort((a, b) => `${a.first_name} ${a.last_name}`.localeCompare(`${b.first_name} ${b.last_name}`));
        
        if (assignedStaff && assignedStaff.length > 0) {
            dropdown.innerHTML = `
                <option value="">Select Staff</option>
                ${assignedStaff.map(s => 
                    `<option value="${s.id}" data-pay-rate="${s.pay_rate_id || ''}">${s.first_name} ${s.last_name}</option>`
                ).join('')}
            `;
        } else {
            dropdown.innerHTML = `
                <option value="">No staff assigned to this participant</option>
            `;
        }
    }
    
    if (currentValue && dropdown.querySelector(`option[value="${currentValue}"]`)) {
        dropdown.value = currentValue;
    }
}

// ==========================================
// HELPER FUNCTIONS
// ==========================================

async function getParticipantWithDefaults(participantId) {
    const { data: participant, error } = await supabaseClient
        .from('participants')
        .select('*')
        .eq('id', participantId)
        .single();
    
    if (error || !participant) {
        console.error('Error loading participant:', error);
        return null;
    }
    
    if (!participant.location_id && participant.address) {
        const { data: matchingLocation } = await supabaseClient
            .from('locations')
            .select('id')
            .eq('is_active', true)
            .ilike('address', `%${participant.address}%`)
            .limit(1);
        
        if (matchingLocation && matchingLocation.length > 0) {
            participant.location_id = matchingLocation[0].id;
        }
    }
    
    if (!participant.location_id) {
        const { data: clientHome } = await supabaseClient
            .from('locations')
            .select('id')
            .eq('name', 'Client Home')
            .eq('is_active', true)
            .single();
        
        if (clientHome) {
            participant.location_id = clientHome.id;
            console.log(`Using Client Home location for ${participant.first_name} ${participant.last_name}`);
        }
    }
    
    return participant;
}

async function loadStaffAssignments(participantId) {
    const { data: assignments, error } = await supabaseClient
        .from('staff_participant_assignments')
        .select(`
            staff_id,
            pay_rate_id,
            staff:staff_id(
                id,
                first_name,
                last_name,
                pay_rate_id,
                is_active
            )
        `)
        .eq('participant_id', participantId)
        .or('end_date.is.null,end_date.gte.' + new Date().toISOString().split('T')[0]);
    
    if (error) {
        console.error('Error loading staff assignments:', error);
        return {};
    }
    
    const assignmentMap = {};
    assignments?.forEach(a => {
        assignmentMap[a.staff_id] = {
            pay_rate_id: a.pay_rate_id || a.staff?.pay_rate_id,
            staff: a.staff
        };
    });
    
    return assignmentMap;
}

async function loadSystemDefaults() {
    const defaults = {};
    
    const { data: dutyTypes } = await supabaseClient
        .from('duty_types')
        .select('id, name')
        .eq('is_active', true)
        .or('name.eq.Active Shift,name.eq.Active Support,name.ilike.%active%')
        .limit(1);
    
    if (dutyTypes && dutyTypes.length > 0) {
        defaults.duty_type_id = dutyTypes[0].id;
    } else {
        const { data: anyDuty } = await supabaseClient
            .from('duty_types')
            .select('id')
            .eq('is_active', true)
            .limit(1);
        defaults.duty_type_id = anyDuty?.[0]?.id;
    }
    
    defaults.pay_rate_id = '00000000-0000-0000-0000-000000000002';
    // DO NOT SET defaults.staff_id - let it be null for unassigned
    
    const { data: clientHome } = await supabaseClient
        .from('locations')
        .select('id')
        .eq('name', 'Client Home')
        .eq('is_active', true)
        .single();
    
    defaults.location_id = clientHome?.id;
    
    return defaults;
}

async function processTemplateShifts(config) {
    const {
        template,
        startDate,
        endDate,
        participant,
        skipExisting,
        staffAssignments,
        systemDefaults,
        clockInSetting // New parameter
    } = config;
    
    const validShifts = [];
    const conflicts = [];
    const skippedUnassigned = []; // Track skipped unassigned shifts
    const currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        const dayOfWeek = currentDate.getDay();
        const dateStr = currentDate.toISOString().split('T')[0];
        
        if (skipExisting) {
            const { data: existing } = await supabaseClient
                .from('shifts')
                .select('id')
                .eq('participant_id', participant.id)
                .eq('date', dateStr)
                .limit(1);
            
            if (existing?.length > 0) {
                currentDate.setDate(currentDate.getDate() + 1);
                continue;
            }
        }
        
        const dayShifts = template.roster_template_shifts.filter(s => 
            s.day_of_week === dayOfWeek
        );
        
        for (const templateShift of dayShifts) {
            // CRITICAL FIX: Skip shifts without staff assigned
            if (!templateShift.staff_id || templateShift.staff_id === '') {
                console.log(`Skipping unassigned shift on ${dateStr}`);
                skippedUnassigned.push({
                    date: dateStr,
                    reason: 'No staff assigned',
                    shift: templateShift
                });
                continue; // Skip to next shift
            }
            
            const shiftData = await buildShiftFromTemplate({
                templateShift,
                dateStr,
                participant,
                staffAssignments,
                systemDefaults,
                clockInSetting // Pass the setting
            });
            
            // Check conflicts for assigned shifts with times
            if (templateShift.start_time && templateShift.end_time) {
                const conflictCheck = await checkShiftConflicts(
                    templateShift.staff_id,
                    participant.id,
                    dateStr,
                    templateShift.start_time,
                    templateShift.end_time,
                    shiftData.duty_type_id
                );
                
                if (conflictCheck.overlaps.length > 0 || conflictCheck.violations.length > 0) {
                    conflicts.push({
                        date: dateStr,
                        staff_id: templateShift.staff_id,
                        conflicts: conflictCheck,
                        shift: templateShift
                    });
                    continue;
                }
            }
            
            validShifts.push(shiftData);
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    // Log summary if any unassigned shifts were skipped
    if (skippedUnassigned.length > 0) {
        console.log(`Skipped ${skippedUnassigned.length} unassigned shifts`);
    }
    
    return { validShifts, conflicts, skippedUnassigned };
}

async function buildShiftFromTemplate(config) {
    const {
        templateShift,
        dateStr,
        participant,
        staffAssignments,
        systemDefaults,
        clockInSetting // New parameter
    } = config;
    
    const shiftDate = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Determine clock-in requirement based on setting
    let clockInRequired;
    if (clockInSetting === 'always') {
        clockInRequired = true;
    } else if (clockInSetting === 'never') {
        clockInRequired = false;
    } else { // 'auto'
        clockInRequired = shiftDate > today;
    }
    
    // Fix: Ensure staff_id is either a valid UUID or null, never the default UUID
const staffId = templateShift.staff_id && templateShift.staff_id !== '' 
    ? templateShift.staff_id 
    : null;

// Get pay rate - ALWAYS required, never null
let payRateId = systemDefaults.pay_rate_id; // Default first

if (staffId && staffAssignments[staffId]) {
    // Use assignment-specific pay rate if available
    payRateId = staffAssignments[staffId].pay_rate_id || systemDefaults.pay_rate_id;
}
    const locationId = templateShift.location_id || 
                      participant.location_id || 
                      systemDefaults.location_id;
    
    if (!locationId) {
        throw new Error('No location available. Please ensure Client Home location exists.');
    }
    
    const dutyTypeId = templateShift.duty_type_id || systemDefaults.duty_type_id;
    
    if (!dutyTypeId) {
        throw new Error('No duty type available. Please ensure duty types are configured.');
    }
    
    return {
        date: dateStr,
        participant_id: participant.id,
        staff_id: staffId, // This will be null for unassigned shifts
        start_time: templateShift.start_time,
        end_time: templateShift.end_time,
        duty_type_id: dutyTypeId,
        location_id: locationId,
        pay_override_id: payRateId, // This will be null for unassigned shifts
        status: 'confirmed',
        notes: templateShift.notes || null,
        clock_in_required: clockInRequired,
        clock_in_time: !clockInRequired && templateShift.start_time ? 
            `${dateStr}T${templateShift.start_time}` : null,
        clock_out_time: !clockInRequired && templateShift.end_time ? 
            `${dateStr}T${templateShift.end_time}` : null,
        created_at: new Date().toISOString(),
        created_by: currentStaffData?.id || currentUser?.id || null
    };
}



function checkTemplateInternalConflicts(shifts) {
    const conflicts = [];
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    const staffDayShifts = {};
    
    shifts.forEach((shift, index) => {
        if (!shift.staff_id) return;
        
        const key = `${shift.staff_id}_${shift.day_of_week}`;
        if (!staffDayShifts[key]) {
            staffDayShifts[key] = [];
        }
        staffDayShifts[key].push({ ...shift, index });
    });
    
    Object.entries(staffDayShifts).forEach(([key, dayShifts]) => {
        if (dayShifts.length < 2) return;
        
        for (let i = 0; i < dayShifts.length - 1; i++) {
            for (let j = i + 1; j < dayShifts.length; j++) {
                const shift1 = dayShifts[i];
                const shift2 = dayShifts[j];
                
                if (shift1.start_time && shift1.end_time && shift2.start_time && shift2.end_time) {
                    const start1 = new Date(`2000-01-01T${shift1.start_time}`);
                    const end1 = new Date(`2000-01-01T${shift1.end_time}`);
                    const start2 = new Date(`2000-01-01T${shift2.start_time}`);
                    const end2 = new Date(`2000-01-01T${shift2.end_time}`);
                    
                    if (end1 <= start1) end1.setDate(end1.getDate() + 1);
                    if (end2 <= start2) end2.setDate(end2.getDate() + 1);
                    
                    if (!(end1 <= start2 || end2 <= start1)) {
                        const staffMember = staff?.find(s => s.id === shift1.staff_id);
                        conflicts.push({
                            type: 'overlap',
                            day: dayNames[shift1.day_of_week],
                            staff: staffMember ? `${staffMember.first_name} ${staffMember.last_name}` : 'Unknown Staff',
                            shift1: `${formatTime(shift1.start_time)}-${formatTime(shift1.end_time)}`,
                            shift2: `${formatTime(shift2.start_time)}-${formatTime(shift2.end_time)}`,
                            message: `${staffMember?.first_name || 'Staff'} has overlapping shifts on ${dayNames[shift1.day_of_week]}`
                        });
                    }
                }
            }
        }
    });
    
    return conflicts;
}

// ==========================================
// DIALOG FUNCTIONS
// ==========================================

async function showTemplateConflictDialog(conflicts, action) {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal" style="max-width: 600px;">
                <header class="modal-header" style="background: #ffc107;">
                    <h3 class="modal-title">⚠️ Template Conflicts Detected</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </header>
                <div class="modal-content" style="max-height: 400px; overflow-y: auto;">
                    <div class="alert alert-warning">
                        <p><strong>The template has conflicts that may cause issues when applied:</strong></p>
                    </div>
                    <ul class="conflict-list" style="list-style: none; padding: 0;">
                        ${conflicts.map(c => `
                            <li style="padding: 12px; margin-bottom: 8px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                                <div style="font-weight: 600; color: #856404;">
                                    ${c.day} - ${c.staff}
                                </div>
                                <div style="margin-top: 4px; color: #664d03;">
                                    Overlapping shifts: ${c.shift1} and ${c.shift2}
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="alert alert-info" style="margin-top: 16px;">
                        <p>You can still ${action} the template, but these conflicts will prevent some shifts from being created when the template is applied.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove(); window.templateConflictResolve(false)">
                        Cancel
                    </button>
                    <button class="btn btn-warning" onclick="this.closest('.modal-overlay').remove(); window.templateConflictResolve(true)">
                        Continue Anyway
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.templateConflictResolve = (result) => {
            delete window.templateConflictResolve;
            resolve(result);
        };
    });
}

async function showApplicationConflictDialog(conflicts, totalShifts) {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        
        const onLeaveConflicts = [];
        const overlapConflicts = [];
        
        conflicts.forEach(c => {
            if (c.conflicts.violations.some(v => v.type === 'on_leave')) {
                onLeaveConflicts.push(c);
            }
            if (c.conflicts.overlaps.length > 0) {
                overlapConflicts.push(c);
            }
        });
        
        modal.innerHTML = `
            <div class="modal" style="max-width: 700px;">
                <header class="modal-header" style="background: #dc3545;">
                    <h3 class="modal-title" style="color: white;">⚠️ Shift Conflicts Found</h3>
                    <button class="modal-close" style="color: white;" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </header>
                <div class="modal-content" style="max-height: 500px; overflow-y: auto;">
                    <div class="alert alert-danger">
                        <p><strong>${conflicts.length} shifts have conflicts and will be skipped:</strong></p>
                    </div>
                    
                    ${onLeaveConflicts.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #dc3545; margin-bottom: 12px;">Staff on Leave</h4>
                            <ul style="list-style: none; padding: 0;">
                                ${onLeaveConflicts.slice(0, 5).map(c => {
                                    const staffMember = staff?.find(s => s.id === c.staff_id);
                                    return `
                                        <li style="padding: 8px; margin-bottom: 6px; background: #f8d7da; border-radius: 4px;">
                                            ${staffMember?.first_name} ${staffMember?.last_name} - ${formatDateFriendly(c.date)}
                                        </li>
                                    `;
                                }).join('')}
                                ${onLeaveConflicts.length > 5 ? `
                                    <li style="padding: 8px; color: #721c24;">
                                        ... and ${onLeaveConflicts.length - 5} more
                                    </li>
                                ` : ''}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${overlapConflicts.length > 0 ? `
                        <div>
                            <h4 style="color: #dc3545; margin-bottom: 12px;">Time Overlaps</h4>
                            <ul style="list-style: none; padding: 0;">
                                ${overlapConflicts.slice(0, 5).map(c => {
                                    const staffMember = staff?.find(s => s.id === c.staff_id);
                                    return `
                                        <li style="padding: 8px; margin-bottom: 6px; background: #f8d7da; border-radius: 4px;">
                                            ${staffMember?.first_name} ${staffMember?.last_name} - ${formatDateFriendly(c.date)}
                                            <div style="font-size: 0.9em; margin-top: 4px;">
                                                ${c.conflicts.overlaps[0].message}
                                            </div>
                                        </li>
                                    `;
                                }).join('')}
                                ${overlapConflicts.length > 5 ? `
                                    <li style="padding: 8px; color: #721c24;">
                                        ... and ${overlapConflicts.length - 5} more
                                    </li>
                                ` : ''}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="alert alert-info" style="margin-top: 20px;">
                        <p>${totalShifts} shifts will be created successfully.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove(); window.applicationConflictResolve(false)">
                        Cancel Application
                    </button>
                    <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove(); window.applicationConflictResolve(true)">
                        Create Non-Conflicting Shifts
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.applicationConflictResolve = (result) => {
            delete window.applicationConflictResolve;
            resolve(result);
        };
    });
}

// ==========================================
// QUICK ACTION FUNCTIONS
// ==========================================

function duplicateDay(sourceDayOfWeek) {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const sourceDay = days[sourceDayOfWeek - 1];
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.style.zIndex = '10000';
    modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
            <header class="modal-header">
                <h3 class="modal-title">Copy ${sourceDay}'s Shifts</h3>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </header>
            <div class="modal-content">
                <p style="margin-bottom: 16px;">Select which days to copy ${sourceDay}'s shifts to:</p>
                <div style="display: grid; gap: 8px;">
                    ${days.map((day, index) => {
                        const dayNum = index + 1;
                        if (dayNum === sourceDayOfWeek) return '';
                        return `
                            <label style="display: flex; align-items: center; padding: 8px; border: 1px solid var(--border-light); border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" value="${dayNum}" style="margin-right: 8px;">
                                ${day}
                            </label>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 16px;">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="clearExisting" style="margin-right: 8px;">
                        Clear existing shifts on target days
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="executeDayDuplication(${sourceDayOfWeek}, this)">Copy Shifts</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function executeDayDuplication(sourceDayOfWeek, button) {
    const modal = button.closest('.modal-overlay');
    const checkboxes = modal.querySelectorAll('input[type="checkbox"]:not(#clearExisting):checked');
    const clearExisting = modal.querySelector('#clearExisting').checked;
    
    if (checkboxes.length === 0) {
        showNotification('Please select at least one day to copy to', 'warning');
        return;
    }
    
    const sourceContainer = document.getElementById(`day_${sourceDayOfWeek}_shifts`);
    const sourceShifts = sourceContainer.querySelectorAll('[id^="shift_"]');
    
    if (sourceShifts.length === 0) {
        showNotification('No shifts to copy', 'warning');
        modal.remove();
        return;
    }
    
    checkboxes.forEach(checkbox => {
        const targetDay = parseInt(checkbox.value);
        const targetContainer = document.getElementById(`day_${targetDay}_shifts`);
        
        if (clearExisting) {
            targetContainer.innerHTML = '';
        }
        
        sourceShifts.forEach(sourceShift => {
            addShiftToDay(targetDay);
            
            const targetShifts = targetContainer.querySelectorAll('[id^="shift_"]');
            const newShift = targetShifts[targetShifts.length - 1];
            
            const fields = ['start_time', 'end_time', 'staff_id', 'duty_type_id', 'location_id', 'notes'];
            fields.forEach(field => {
                const sourceEl = sourceShift.querySelector(`[data-field="${field}"]`);
                const targetEl = newShift.querySelector(`[data-field="${field}"]`);
                if (sourceEl && targetEl) {
                    targetEl.value = sourceEl.value;
                }
            });
        });
    });
    
    showNotification('Shifts copied successfully', 'success');
    modal.remove();
}

function copyWeekdaysToAll() {
    const mondayContainer = document.getElementById('day_1_shifts');
    const mondayShifts = mondayContainer.querySelectorAll('[id^="shift_"]');
    
    if (mondayShifts.length === 0) {
        showNotification('No shifts on Monday to copy', 'warning');
        return;
    }
    
    for (let day = 2; day <= 5; day++) {
        const targetContainer = document.getElementById(`day_${day}_shifts`);
        targetContainer.innerHTML = '';
        
        mondayShifts.forEach(sourceShift => {
            addShiftToDay(day);
            const targetShifts = targetContainer.querySelectorAll('[id^="shift_"]');
            const newShift = targetShifts[targetShifts.length - 1];
            
            ['start_time', 'end_time', 'staff_id', 'duty_type_id', 'location_id', 'notes'].forEach(field => {
                const sourceEl = sourceShift.querySelector(`[data-field="${field}"]`);
                const targetEl = newShift.querySelector(`[data-field="${field}"]`);
                if (sourceEl && targetEl) {
                    targetEl.value = sourceEl.value;
                }
            });
        });
    }
    
    showNotification('Monday shifts copied to all weekdays', 'success');
}

function clearAllDays() {
    if (!confirm('Clear all shifts from all days?')) return;
    
    for (let day = 1; day <= 7; day++) {
        const container = document.getElementById(`day_${day}_shifts`);
        if (container) container.innerHTML = '';
    }
    showNotification('All days cleared', 'success');
}

function loadSampleTemplate() {
    const sampleShifts = [
        { days: [1,2,3,4,5], start: '07:00', end: '15:00' },
        { days: [1,2,3,4,5], start: '15:00', end: '23:00' },
        { days: [6,7], start: '09:00', end: '21:00' }
    ];
    
    for (let day = 1; day <= 7; day++) {
        const container = document.getElementById(`day_${day}_shifts`);
        if (container) container.innerHTML = '';
    }
    
    sampleShifts.forEach(shift => {
        shift.days.forEach(day => {
            addShiftToDay(day);
            const container = document.getElementById(`day_${day}_shifts`);
            const lastShift = container.lastElementChild;
            if (lastShift) {
                const startInput = lastShift.querySelector('[data-field="start_time"]');
                const endInput = lastShift.querySelector('[data-field="end_time"]');
                if (startInput) startInput.value = shift.start;
                if (endInput) endInput.value = shift.end;
            }
        });
    });
    
    showNotification('Sample schedule loaded', 'success');
}

// ==========================================
// DROPDOWN POPULATION FUNCTIONS
// ==========================================

async function populateDutyTypeDropdown(dropdown) {
    try {
        const { data: dutyTypes, error } = await supabaseClient
            .from('duty_types')
            .select('id, name, description')
            .eq('is_active', true)
            .order('name');
        
        if (error) throw error;
        
        if (!dutyTypes || dutyTypes.length === 0) {
            dropdown.innerHTML = '<option value="">No duty types available</option>';
            return;
        }
        
        const activeShiftType = dutyTypes.find(t => t.name === 'Active Shift');
        
        dropdown.innerHTML = `
            <option value="">Select Duty Type</option>
            ${dutyTypes.map(t => 
                `<option value="${t.id}">${t.name}</option>`
            ).join('')}
        `;
        
        if (activeShiftType && !dropdown.value) {
            dropdown.value = activeShiftType.id;
        }
        
    } catch (error) {
        console.error('Error loading duty types:', error);
        dropdown.innerHTML = '<option value="">Error loading duty types</option>';
    }
}

async function populateLocationDropdown(dropdown, participantId = null) {
    try {
        let defaultLocationId = null;
        if (participantId) {
            const participant = participants?.find(p => p.id === participantId);
            defaultLocationId = participant?.location_id;
        }
        
        const { data: locations, error } = await supabaseClient
            .from('locations')
            .select('id, name, address, is_care_home')
            .eq('is_active', true)
            .order('name');
        
        if (error) throw error;
        
        if (!locations || locations.length === 0) {
            dropdown.innerHTML = '<option value="">No locations available</option>';
            return;
        }
        
        dropdown.innerHTML = `
            <option value="">Select Location</option>
            ${locations.map(l => 
                `<option value="${l.id}">${l.name}${l.is_care_home ? ' (Care Home)' : ''}</option>`
            ).join('')}
        `;
        
        if (defaultLocationId && dropdown.querySelector(`option[value="${defaultLocationId}"]`)) {
            dropdown.value = defaultLocationId;
        }
        
    } catch (error) {
        console.error('Error loading locations:', error);
        dropdown.innerHTML = '<option value="">Error loading locations</option>';
    }
}

async function loadDutyTypes() {
    const { data, error } = await supabaseClient
        .from('duty_types')
        .select('*')
        .eq('is_active', true)
        .order('name');
    
    if (!error && data) {
        window.dutyTypes = data;
    }
}

// ==========================================
// UTILITY FUNCTIONS
// ==========================================

function formatTime(timeString) {
    if (!timeString) return '';
    const [hours, minutes] = timeString.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
    return `${displayHour}:${minutes} ${ampm}`;
}

function formatDateFriendly(dateStr) {
    const date = new Date(dateStr);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

function suggestDateForDayOfWeek(dayOfWeek) {
    const dateInput = document.getElementById('shiftDate');
    if (!dateInput || !dateInput.value) return;
    
    const currentDate = new Date(dateInput.value);
    const currentDay = currentDate.getDay();
    
    if (currentDay !== dayOfWeek) {
        let daysToAdd = dayOfWeek - currentDay;
        if (daysToAdd <= 0) daysToAdd += 7;
        
        const suggestedDate = new Date(currentDate);
        suggestedDate.setDate(currentDate.getDate() + daysToAdd);
        
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        if (confirm(`This template is for ${dayNames[dayOfWeek]}. Change date to ${suggestedDate.toLocaleDateString()}?`)) {
            dateInput.value = suggestedDate.toISOString().split('T')[0];
            dateInput.style.backgroundColor = '#e8f5e9';
            setTimeout(() => {
                dateInput.style.backgroundColor = '';
            }, 2000);
        }
    }
}

async function validateParticipantLocation(participantId) {
    if (!participantId) return { valid: true };
    
    const participant = participants?.find(p => p.id === participantId);
    if (!participant) {
        return { 
            valid: false, 
            message: 'Participant not found' 
        };
    }
    
    if (!participant.location_lat || !participant.location_lng) {
        return {
            valid: false,
            message: `${participant.first_name} ${participant.last_name} does not have location data set. Clock-in features may not work properly.`,
            warning: true
        };
    }
    
    return { 
        valid: true,
        location: {
            address: participant.address,
            lat: participant.location_lat,
            lng: participant.location_lng,
            radius: participant.location_radius_meters || 100
        }
    };
}

        // ========================================
        // SEARCHABLE DROPDOWNS
        // ========================================

        function populateFilterDropdowns() {
            console.log('Populating filter dropdowns...');

            // Staff filter dropdown
            const staffList = document.getElementById('staffFilterList');
            if (staffList && staff.length > 0) {
                staffList.innerHTML = '';
                staff.forEach(s => {
                    const option = document.createElement('option');
                    option.value = `${s.first_name} ${s.last_name}`;
                    option.setAttribute('data-id', s.id);
                    staffList.appendChild(option);
                });
            }

            // Participant filter dropdown
            const participantList = document.getElementById('participantFilterList');
            if (participantList && participants.length > 0) {
                participantList.innerHTML = '';
                participants.forEach(p => {
                    const option = document.createElement('option');
                    option.value = `${p.first_name} ${p.last_name}`;
                    option.setAttribute('data-id', p.id);
                    participantList.appendChild(option);
                });
            }
        }

        function updateStaffFilter() {
            const input = document.getElementById('staffFilterInput');
            const selectedStaff = staff.find(s => `${s.first_name} ${s.last_name}` === input.value);
            staffFilterValue = selectedStaff ? selectedStaff.id : '';
            console.log('Staff filter updated:', staffFilterValue);
            applyFilters();
        }

        function updateParticipantFilter() {
    const input = document.getElementById('participantFilterInput');
    const selectedParticipant = participants.find(p => 
        `${p.first_name} ${p.last_name}` === input.value
    );
    participantFilterValue = selectedParticipant ? selectedParticipant.id : '';
    
    // Remove any existing care home filter
    const existingFilter = document.getElementById('careHomeResidentFilter');
    if (existingFilter) existingFilter.remove();
    
    // Check if selected participant is a care home
    if (selectedParticipant) {
        let foundCareHome = null;
        
        // Check if this participant ID is a main care home entity
        careHomes.forEach((ch, address) => {
            if (ch.mainEntityId === selectedParticipant.id) {
                foundCareHome = ch;
                activeCareHomeFilter = address;
            }
        });
        
        // If found, show the resident filter
        if (foundCareHome) {
            showCareHomeResidentFilter(foundCareHome);
        } else {
            activeCareHomeFilter = null;
        }
    } else {
        activeCareHomeFilter = null;
    }
    
    console.log('Participant filter updated:', participantFilterValue);
    applyFilters();
}

function showCareHomeResidentFilter(careHome) {
    const filterRow = document.querySelector('.filter-row');
    
    // Remove existing filter if present
    const existingFilter = document.getElementById('careHomeResidentFilter');
    if (existingFilter) existingFilter.remove();
    
    // Debug log
    console.log('Showing care home filter for:', careHome);
    console.log('Residents:', careHome.residents);
    
    // Create filter UI
    const careHomeFilter = document.createElement('div');
    careHomeFilter.className = 'filter-group';
    careHomeFilter.id = 'careHomeResidentFilter';
    
    const residentCount = careHome.residents.length;
    
    // Build the HTML
    let filterHTML = `
        <label>${careHome.name} Filter</label>
        <div style="
            background: var(--bg-light); 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-md);
            padding: 12px;
            max-height: 250px;
            overflow-y: auto;
        ">
    `;
    
    // Add general shifts checkbox if there's a main entity
    if (careHome.mainEntityId) {
        filterHTML += `
            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                    <input type="checkbox" id="includeGeneralShifts" 
                           checked
                           onchange="applyCareHomeFilter()">
                    <span style="margin-left: 8px;">Include General ${careHome.name} Shifts</span>
                </label>
            </div>
        `;
    }
    
    // Add residents section
    if (residentCount > 0) {
        filterHTML += `
            <div style="margin-bottom: 8px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                    <input type="checkbox" id="selectAllResidents" 
                           onchange="toggleAllResidents(this)" checked>
                    <span style="margin-left: 8px;">All Residents (${residentCount})</span>
                </label>
            </div>
        `;
        
        // Add each resident
        careHome.residents.forEach(resident => {
            filterHTML += `
                <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 4px; padding-left: 20px;">
                    <input type="checkbox" class="resident-checkbox" 
                           value="${resident.id}" 
                           data-name="${resident.first_name} ${resident.last_name}"
                           checked
                           onchange="applyCareHomeFilter()">
                    <span style="margin-left: 8px;">${resident.first_name} ${resident.last_name}</span>
                </label>
            `;
        });
    } else {
        // No residents but show shifts for the care home entity
        filterHTML += `
            <p style="color: var(--text-muted); text-align: center; margin: 20px 0;">
                No individual residents found.<br>
                ${careHome.mainEntityId ? 'Showing general care home shifts only.' : 'No shifts to display.'}
            </p>
        `;
    }
    
    filterHTML += `
        </div>
        <button class="btn btn-outline btn-sm" onclick="clearCareHomeFilter()" style="margin-top: 8px; width: 100%;">
            Clear ${careHome.name} Filter
        </button>
    `;
    
    careHomeFilter.innerHTML = filterHTML;
    
    // Insert after participant filter
    const participantFilterGroup = document.getElementById('participantFilterInput').closest('.filter-group');
    participantFilterGroup.after(careHomeFilter);
    
    showNotification(`Filtering by ${careHome.name} (${residentCount} residents)`, 'info');
    applyCareHomeFilter();
}

// Apply care home filter (generic for any care home)
window.applyCareHomeFilter = function() {
    if (!activeCareHomeFilter) {
        applyFilters();
        return;
    }
    
    const careHome = careHomes.get(activeCareHomeFilter);
    if (!careHome) {
        applyFilters();
        return;
    }
    
    const includeGeneral = document.getElementById('includeGeneralShifts')?.checked ?? false;
    const selectedResidents = Array.from(document.querySelectorAll('.resident-checkbox:checked'))
        .map(cb => cb.value);
    
    // Get other filter values
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    // Filter shifts
    filteredShifts = shifts.filter(shift => {
        // Apply standard filters
        if (startDate && shift.date < startDate) return false;
        if (endDate && shift.date > endDate) return false;
        if (statusFilter && shift.status !== statusFilter) return false;
        if (staffFilterValue && shift.staff_id !== staffFilterValue) return false;
        
        // Care home filter
        const isGeneralShift = careHome.mainEntityId && shift.participant_id === careHome.mainEntityId;
        const isResidentShift = selectedResidents.includes(shift.participant_id);
        
        if (includeGeneral && isGeneralShift) return true;
        if (isResidentShift) return true;
        
        return false;
    });
    
    // Update "All Residents" checkbox
    const allCheckbox = document.getElementById('selectAllResidents');
    const residentCheckboxes = document.querySelectorAll('.resident-checkbox');
    if (allCheckbox && residentCheckboxes.length > 0) {
        allCheckbox.checked = selectedResidents.length === residentCheckboxes.length;
    }
    
    console.log(`Filtered to ${filteredShifts.length} shifts for ${careHome.name}`);
    renderCurrentView();
}

// Clear care home filter
window.clearCareHomeFilter = function() {
    document.getElementById('participantFilterInput').value = '';
    participantFilterValue = '';
    activeCareHomeFilter = null;
    
    const careHomeFilter = document.getElementById('careHomeResidentFilter');
    if (careHomeFilter) careHomeFilter.remove();
    
    applyFilters();
}

// Toggle all residents
window.toggleAllResidents = function(checkbox) {
    const residentCheckboxes = document.querySelectorAll('.resident-checkbox');
    residentCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    applyCareHomeFilter();
}

function populateModalDropdowns() {
    console.log('Populating modal dropdowns with data:', {
        staff: staff.length,
        participants: participants.length,
        locations: locations.length,
        dutyTypes: dutyTypes.length
    });
    
    // ===== POPULATE DATALISTS FOR STAFF (autocomplete inputs) =====
    const staffDataLists = [
        'staffDataList',        // For create shift modal
        'editStaffList'         // For edit shift modal
    ];
    
    staffDataLists.forEach(datalistId => {
        const datalist = document.getElementById(datalistId);
        if (datalist) {
            datalist.innerHTML = '';
            staff.forEach(s => {
                const option = document.createElement('option');
                option.value = `${s.first_name} ${s.last_name}`;
                option.setAttribute('data-id', s.id);
                datalist.appendChild(option);
            });
            console.log(`Populated ${datalistId} with ${staff.length} staff members`);
        } else {
            console.warn(`Datalist ${datalistId} not found`);
        }
    });
    
    // ===== POPULATE DATALISTS FOR PARTICIPANTS (autocomplete inputs) =====
    const participantDataLists = [
        'participantDataList',   // For create shift modal
        'editParticipantList'    // For edit shift modal
    ];
    
    participantDataLists.forEach(datalistId => {
        const datalist = document.getElementById(datalistId);
        if (datalist) {
            datalist.innerHTML = '';
            
            // Group participants by care home
            const careHomeParticipants = [];
            const homeParticipants = [];
            
            participants.forEach(p => {
                // Check if participant is in a care home
                const isCareHome = p.address && (
                    p.address.toLowerCase().includes('saunders') ||
                    locations.some(l => l.is_care_home && l.address && 
                        p.address.toLowerCase().includes(l.address.toLowerCase().split(',')[0])
                    )
                );
                
                if (isCareHome) {
                    careHomeParticipants.push(p);
                } else {
                    homeParticipants.push(p);
                }
            });
            
            // Add all participants to datalist (NO care home indicator in the value)
            participants.forEach(p => {
                const option = document.createElement('option');
                // Don't add (Care Home) to the value - it breaks the name matching
                option.value = `${p.first_name} ${p.last_name}`;
                option.setAttribute('data-id', p.id);
                option.setAttribute('data-is-care-home', careHomeParticipants.includes(p) ? 'true' : 'false');
                datalist.appendChild(option);
            });
            
            console.log(`Populated ${datalistId} with ${participants.length} participants`);
        } else {
            console.warn(`Datalist ${datalistId} not found`);
        }
    });

    // ===== POPULATE LOCATION DROPDOWNS (regular selects) =====
    // Note: These are not used in the current modal setup since location is auto-populated
    // But keeping for backwards compatibility
    const locationSelects = [
        document.getElementById('shiftLocation'),
        document.getElementById('editShiftLocation')
    ];
    
    locationSelects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">Select Location</option>';
            
            // Group locations
            const careHomes = locations.filter(l => l.is_care_home);
            const otherLocations = locations.filter(l => !l.is_care_home);
            
            // Add care homes first
            if (careHomes.length > 0) {
                select.innerHTML += '<optgroup label="Care Homes">';
                careHomes.forEach(l => {
                    select.innerHTML += `<option value="${l.id}">${l.name}</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
            
            // Add other locations
            if (otherLocations.length > 0) {
                select.innerHTML += '<optgroup label="Other Locations">';
                otherLocations.forEach(l => {
                    select.innerHTML += `<option value="${l.id}">${l.name}</option>`;
                });
                select.innerHTML += '</optgroup>';
            }
            
            console.log(`Populated location select with ${locations.length} locations`);
        }
    });

    const dutyTypeSelects = [
    document.getElementById('shiftDutyType'),
    document.getElementById('editShiftDutyType')
];

dutyTypeSelects.forEach(select => {
    if (select) {
        select.innerHTML = '<option value="">Select Duty Type</option>';
        
        // Add all duty types from database
        dutyTypes.forEach(dt => {
            select.innerHTML += `<option value="${dt.id}">${dt.name}</option>`;
        });
        
        // For the add modal, set Active Shift as default
        if (select.id === 'shiftDutyType') {
            // Find the Active Shift duty type and select it
            const activeShiftType = dutyTypes.find(dt => 
                dt.name.toLowerCase().includes('active') || 
                dt.name === 'Active Shift'
            );
            
            if (activeShiftType) {
                select.value = activeShiftType.id;
            } else if (dutyTypes.length > 0) {
                // If no "Active Shift" found, select the first duty type
                select.value = dutyTypes[0].id;
            }
        }
        
        console.log(`Populated duty type select with ${dutyTypes.length} duty types`);
    }
});


    // ===== POPULATE PAY RATE DROPDOWNS =====
    // Don't populate these here - they should be populated dynamically
    // based on the selected staff member in the updateStaffSelection functions
    
    // ===== POPULATE STATUS DROPDOWN (only for edit modal) =====
    const statusSelect = document.getElementById('editShiftStatus');
if (statusSelect) {
    statusSelect.innerHTML = `
        <option value="pending">Pending</option>
        <option value="confirmed">Confirmed</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
    `;
    }
}
function updateStaffSelection() {
    const input = document.getElementById('shiftStaffInput');
    const hiddenInput = document.getElementById('shiftStaff');
    
    // Remove any care home indicator for matching
    const inputValue = input.value.replace(' (Care Home)', '');
    const selectedStaff = staff.find(s => `${s.first_name} ${s.last_name}` === inputValue);
    
    if (selectedStaff) {
        hiddenInput.value = selectedStaff.id;
        if (typeof updateHourWarning === 'function') {
            updateHourWarning();
        }
    } else {
        hiddenInput.value = '';
    }
}

// Helper function to get participant's location
async function getParticipantLocation(participantId) {
    if (!participantId) return null;
    
    const participant = participants.find(p => p.id === participantId);
    if (!participant) return null;
    
    // Try to find matching location based on participant's address
    if (participant.location_lat && participant.location_lng) {
        // Find or create location based on participant's coordinates
        const location = locations.find(l => 
            l.latitude === participant.location_lat && 
            l.longitude === participant.location_lng
        );
        
        if (location) return location.id;
    }
    
    // Fallback: Check for care home match
    if (participant.address) {
        const addressLower = participant.address.toLowerCase();
        
        if (addressLower.includes('saunders')) {
            const saundersLocation = locations.find(l => 
                l.name.toLowerCase().includes('saunders') || 
                (l.address && l.address.toLowerCase().includes('saunders'))
            );
            if (saundersLocation) return saundersLocation.id;
        }
        
        const careHomeLocation = locations.find(l => 
            l.is_care_home && l.address && 
            addressLower.includes(l.address.toLowerCase().split(',')[0])
        );
        if (careHomeLocation) return careHomeLocation.id;
    }
    
    // Final fallback: Client Home
    const clientHome = locations.find(l => 
        l.name.toLowerCase().includes('client home') ||
        l.id === '00000000-0000-0000-0000-000000000001'
    );
    
    return clientHome ? clientHome.id : null;
}

// Helper function to get pay rate from staff_participant_assignment
async function getAssignmentPayRate(staffId, participantId) {
    if (!staffId || !participantId) return null;
    
    try {
        const { data, error } = await supabaseClient
            .from('staff_participant_assignments')
            .select('pay_rate_id')
            .eq('staff_id', staffId)
            .eq('participant_id', participantId)
            .eq('is_active', true)
            .is('end_date', null)
            .maybeSingle();
        
        if (error) throw error;
        
        // Return assignment pay rate if exists, otherwise return staff default
        if (data && data.pay_rate_id) {
            return data.pay_rate_id;
        }
        
        // Fallback to staff's default pay rate
        const selectedStaff = staff.find(s => s.id === staffId);
        return selectedStaff?.pay_rate_id || null;
        
    } catch (error) {
        console.error('Error fetching assignment pay rate:', error);
        // Fallback to staff's default pay rate
        const selectedStaff = staff.find(s => s.id === staffId);
        return selectedStaff?.pay_rate_id || null;
    }
}

// Update clock-in required options based on date
function updateClockInRequiredOptions() {
    const dateInput = document.getElementById('shiftDate');
    const clockInCheckbox = document.getElementById('clockInRequired');
    const helpText = document.getElementById('clockInHelp');
    
    if (!dateInput.value) return;
    
    const selectedDate = new Date(dateInput.value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
        // Past date: must be false
        clockInCheckbox.checked = false;
        clockInCheckbox.disabled = true;
        helpText.textContent = 'Clock-in cannot be required for past shifts';
        helpText.style.color = '#666';
    } else {
        // Today or future: can be true or false
        clockInCheckbox.disabled = false;
        clockInCheckbox.checked = true; // Default to true for future shifts
        helpText.textContent = 'Requires staff to clock in/out via mobile app';
        helpText.style.color = '#666';
    }
}

// Update edit modal clock-in options
function updateEditClockInRequiredOptions() {
    const dateInput = document.getElementById('editShiftDate');
    const clockInCheckbox = document.getElementById('editClockInRequired');
    const helpText = document.getElementById('editClockInHelp');
    
    if (!dateInput.value) return;
    
    const selectedDate = new Date(dateInput.value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
        // Past date: must be false
        clockInCheckbox.checked = false;
        clockInCheckbox.disabled = true;
        helpText.textContent = 'Clock-in cannot be required for past shifts';
        helpText.style.color = '#666';
    } else {
        // Today or future: can be true or false
        clockInCheckbox.disabled = false;
        helpText.textContent = 'Requires staff to clock in/out via mobile app';
        helpText.style.color = '#666';
    }
}

// Updated updateStaffSelection function
function updateStaffSelection() {
    const input = document.getElementById('shiftStaffInput');
    const hiddenInput = document.getElementById('shiftStaff');
    
    const inputValue = input.value.replace(' (Care Home)', '');
    const selectedStaff = staff.find(s => `${s.first_name} ${s.last_name}` === inputValue);
    
    if (selectedStaff) {
        hiddenInput.value = selectedStaff.id;
        if (typeof updateHourWarning === 'function') {
            updateHourWarning();
        }
        // Update pay rate when both staff and participant are selected
        updatePayRateForAssignment();
    } else {
        hiddenInput.value = '';
    }
}

// Updated updateParticipantSelection function
async function updateParticipantSelection() {
    const input = document.getElementById('shiftParticipantInput');
    const hiddenInput = document.getElementById('shiftParticipant');
    const locationHidden = document.getElementById('shiftLocation');
    const locationDisplay = document.getElementById('shiftLocationDisplay');
    
    const inputValue = input.value.replace(' (Care Home)', '');
    const selectedParticipant = participants.find(p => `${p.first_name} ${p.last_name}` === inputValue);
    
    if (selectedParticipant) {
        hiddenInput.value = selectedParticipant.id;
        
        // Auto-populate location
        const locationId = await getParticipantLocation(selectedParticipant.id);
        if (locationId) {
            locationHidden.value = locationId;
            const location = locations.find(l => l.id === locationId);
            locationDisplay.value = location ? location.name : 'Location Set';
        } else {
            locationDisplay.value = 'No location found';
        }
        
        // Update pay rate when both staff and participant are selected
        await updatePayRateForAssignment();
    } else {
        hiddenInput.value = '';
        locationHidden.value = '';
        locationDisplay.value = '';
    }
}

// Updated updateEditStaffSelection function
function updateEditStaffSelection() {
    const input = document.getElementById('editShiftStaffInput');
    const hiddenInput = document.getElementById('editShiftStaff');
    
    const inputValue = input.value.replace(' (Care Home)', '');
    const selectedStaff = staff.find(s => `${s.first_name} ${s.last_name}` === inputValue);
    
    hiddenInput.value = selectedStaff ? selectedStaff.id : '';
    
    // Update pay rate when both staff and participant are selected
    updateEditPayRateForAssignment();
}

async function updateEditParticipantSelection() {
    const input = document.getElementById('editShiftParticipantInput');
    const hiddenInput = document.getElementById('editShiftParticipant');
    const locationHidden = document.getElementById('editShiftLocation');
    const locationDisplay = document.getElementById('editShiftLocationDisplay');
    
    const inputValue = input.value.trim();
    const selectedParticipant = participants.find(p => `${p.first_name} ${p.last_name}` === inputValue);
    
    if (selectedParticipant) {
        hiddenInput.value = selectedParticipant.id;
        
        // Auto-populate location
        const locationId = await getParticipantLocation(selectedParticipant.id);
        if (locationId) {
            locationHidden.value = locationId;
            const location = locations.find(l => l.id === locationId);
            locationDisplay.value = location ? location.name : 'Location Set';
        } else {
            locationDisplay.value = 'No location found';
        }
        
        // Update pay rate when both staff and participant are selected
        await updateEditPayRateForAssignment();
        
        // Update schedule cards
        updateModalScheduleCards('edit');
    } else {
        hiddenInput.value = '';
        locationHidden.value = '';
        locationDisplay.value = '';
        
        // Still update schedule cards to clear them if needed
        updateModalScheduleCards('edit');
    }
}

async function updateEditStaffSelection() {
    const input = document.getElementById('editShiftStaffInput');
    const hiddenInput = document.getElementById('editShiftStaff');
    
    const inputValue = input.value.trim();
    const selectedStaff = staff.find(s => `${s.first_name} ${s.last_name}` === inputValue);
    
    if (selectedStaff) {
        hiddenInput.value = selectedStaff.id;
        
        // Update pay rate options for this staff member
        const payRateSelect = document.getElementById('editShiftPayRate');
        if (payRateSelect) {
            payRateSelect.innerHTML = '<option value="">Use Assignment Default</option>';
            
            if (window.payRates) {
                window.payRates.forEach(rate => {
                    const option = document.createElement('option');
                    option.value = rate.id;
                    option.text = `${rate.category} - ${rate.level} (P${rate.pay_point}) - $${rate.hourly_pay_rate}/hr`;
                    payRateSelect.appendChild(option);
                });
            }
        }
        
        // Update pay rate when both staff and participant are selected
        await updateEditPayRateForAssignment();
        
        // Update schedule cards
        updateModalScheduleCards('edit');
    } else {
        hiddenInput.value = '';
        
        // Clear pay rate options
        const payRateSelect = document.getElementById('editShiftPayRate');
        if (payRateSelect) {
            payRateSelect.innerHTML = '<option value="">Select staff first</option>';
            payRateSelect.disabled = true;
        }
        
        // Still update schedule cards to clear them if needed
        updateModalScheduleCards('edit');
    }
}

// Helper to update pay rate dropdown for add modal
async function updatePayRateForAssignment() {
    const staffId = document.getElementById('shiftStaff').value;
    const participantId = document.getElementById('shiftParticipant').value;
    const payRateSelect = document.getElementById('shiftPayRate');
    
    if (!staffId || !participantId) return;
    
    const assignmentPayRateId = await getAssignmentPayRate(staffId, participantId);
    
    if (assignmentPayRateId) {
        // Set the hidden default but allow override
        payRateSelect.dataset.defaultPayRate = assignmentPayRateId;
        
        // Update the placeholder text
        const payRate = payRates.find(pr => pr.id === assignmentPayRateId);
        if (payRate) {
            payRateSelect.options[0].text = `Use Assignment Default ($${payRate.base_rate}/hr)`;
        }
    }
}

// Helper to update pay rate dropdown for edit modal
async function updateEditPayRateForAssignment() {
    const staffId = document.getElementById('editShiftStaff').value;
    const participantId = document.getElementById('editShiftParticipant').value;
    const payRateSelect = document.getElementById('editShiftPayRate');
    
    if (!staffId || !participantId) return;
    
    const assignmentPayRateId = await getAssignmentPayRate(staffId, participantId);
    
    if (assignmentPayRateId) {
        payRateSelect.dataset.defaultPayRate = assignmentPayRateId;
        
        const payRate = payRates.find(pr => pr.id === assignmentPayRateId);
        if (payRate) {
            payRateSelect.options[0].text = `Use Assignment Default ($${payRate.base_rate}/hr)`;
        }
    }
}

// Updated createShift function
async function createShift() {
    try {
        const date = document.getElementById('shiftDate').value;
        const startTime = document.getElementById('shiftStartTime').value;
        const endTime = document.getElementById('shiftEndTime').value;
        const staffId = document.getElementById('shiftStaff').value;
        const participantId = document.getElementById('shiftParticipant').value;
        const locationId = document.getElementById('shiftLocation').value;
        const dutyTypeId = document.getElementById('shiftDutyType').value;
        const payRateOverride = document.getElementById('shiftPayRate').value;
        const clockInRequired = document.getElementById('clockInRequired').checked;

        // Basic validation
        if (!date || !staffId || !participantId || !dutyTypeId) {
            showNotification('Please fill required fields (Date, Staff, Participant, Duty Type)', 'error');
            return;
        }

        if (!locationId) {
            showNotification('Location could not be determined from participant', 'error');
            return;
        }

        // Get the effective pay rate
        let effectivePayRateId = payRateOverride;
        
        if (!effectivePayRateId) {
            // Use assignment pay rate or staff default
            effectivePayRateId = await getAssignmentPayRate(staffId, participantId);
        }

        if (!effectivePayRateId) {
            showNotification('Missing pay rate. Please select or assign a valid pay rate.', 'error');
            return;
        }

        // Calculate duration
        let duration_hours = null;
        const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeId);
        if (selectedDutyType?.name.toLowerCase().includes('sleepover')) {
            duration_hours = 2;
        } else if (startTime && endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            let end = new Date(`2000-01-01T${endTime}`);
            if (end <= start) end.setDate(end.getDate() + 1);
            duration_hours = (end - start) / (1000 * 60 * 60);
        }

        const shiftData = {
            date: date,
            start_time: startTime || null,
            end_time: endTime || null,
            staff_id: staffId,
            participant_id: participantId,
            location_id: locationId,
            duty_type_id: dutyTypeId,
            pay_override_id: effectivePayRateId,
            clock_in_required: clockInRequired,
            created_by: currentStaffData?.id || currentUser.id,
            status: 'confirmed',
            duration_hours: duration_hours
        };

        const { data: newShift, error } = await supabaseClient
            .from('shifts')
            .insert([shiftData])
            .select()
            .single();

        if (error) throw error;

        showNotification('Shift created successfully', 'success');
        closeModal('addShiftModal');
        await loadShifts();

    } catch (error) {
        console.error('Error creating shift:', error);
        showNotification('Failed to create shift: ' + error.message, 'error');
    }
}


// Helper function to set "Active Shift" as default when opening add modal
function openAddShiftModal() {
    // Reset form
    document.getElementById('addShiftForm').reset();
    
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('shiftDate').value = today;
    
    // Set "Active Shift" as default if it exists
    const activeShiftDuty = dutyTypes.find(dt => dt.name === 'Active Shift');
    if (activeShiftDuty) {
        document.getElementById('shiftDutyType').value = activeShiftDuty.id;
    }
    
    // Set clock-in required to true by default for today/future
    document.getElementById('clockInRequired').checked = true;
    updateClockInRequiredOptions();
    
    // Open modal
    document.getElementById('addShiftModal').style.display = 'flex';
}

// For the shift modal error, add:
function showAddShiftModal() {
    // Get the modal with the correct ID
    const modal = document.getElementById('addShiftModal');
    if (!modal) {
        console.error('Modal not found');
        return;
    }
    
    // Show the modal
    modal.style.display = 'flex'; // Use 'flex' since it's a modal-overlay
    
    // Reset the form
    const form = document.getElementById('addShiftForm');
    if (form) form.reset();
    
    // Set today's date as default
    const dateInput = document.getElementById('shiftDate');
    if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Load dropdowns data
    loadStaffDataList();
    loadParticipantDataList();
    loadLocationOptions();
    populateModalDropdowns();
    loadPayRateOptions();
}

// Helper functions to populate the dropdowns (if they don't exist already)
function loadStaffDataList() {
    const datalist = document.getElementById('staffDataList');
    if (datalist && window.staff) {
        datalist.innerHTML = window.staff.map(s => 
            `<option value="${s.first_name} ${s.last_name}" data-id="${s.id}">`
        ).join('');
    }
}

function setFieldValue(fieldId, value) {
    const field = document.getElementById(fieldId);
    if (field) {
        field.value = value || '';
    }
}


function loadParticipantDataList() {
    const datalist = document.getElementById('participantDataList');
    if (datalist && window.participants) {
        datalist.innerHTML = window.participants.map(p => 
            `<option value="${p.first_name} ${p.last_name}" data-id="${p.id}">`
        ).join('');
    }
}

function loadLocationOptions() {
    const select = document.getElementById('shiftLocation');
    if (select && window.locations) {
        select.innerHTML = '<option value="">Select Location</option>' +
            window.locations.map(l => 
                `<option value="${l.id}">${l.name}</option>`
            ).join('');
    }
}

//function populateModalDropdowns() {
  //  const select = document.getElementById('shiftDutyType');
    //if (select && window.dutyTypes) {
      //  select.innerHTML = '<option value="">Select Duty Type</option>' +
        //    window.dutyTypes.map(dt => 
          //      `<option value="${dt.id}">${dt.name}</option>`
            //).join('');
    //}
//}

function populateModalDropdowns() {
    console.log('Populating modal dropdowns with data:', {
        staff: staff.length,
        participants: participants.length,
        locations: locations.length,
        dutyTypes: dutyTypes.length
    });
    
    // ===== POPULATE DATALISTS FOR STAFF (autocomplete inputs) =====
    const staffDataLists = [
        'staffDataList',        // For create shift modal
        'editStaffList'         // For edit shift modal
    ];
    
    staffDataLists.forEach(datalistId => {
        const datalist = document.getElementById(datalistId);
        if (datalist) {
            datalist.innerHTML = '';
            staff.forEach(s => {
                const option = document.createElement('option');
                option.value = `${s.first_name} ${s.last_name}`;
                option.setAttribute('data-id', s.id);
                datalist.appendChild(option);
            });
            console.log(`Populated ${datalistId} with ${staff.length} staff members`);
        } else {
            console.warn(`Datalist ${datalistId} not found`);
        }
    });
    
    // ===== POPULATE DATALISTS FOR PARTICIPANTS (autocomplete inputs) =====
    const participantDataLists = [
        'participantDataList',   // For create shift modal
        'editParticipantList'    // For edit shift modal
    ];
    
    participantDataLists.forEach(datalistId => {
        const datalist = document.getElementById(datalistId);
        if (datalist) {
            datalist.innerHTML = '';
            
            participants.forEach(p => {
                const option = document.createElement('option');
                option.value = `${p.first_name} ${p.last_name}`;
                option.setAttribute('data-id', p.id);
                datalist.appendChild(option);
            });
            
            console.log(`Populated ${datalistId} with ${participants.length} participants`);
        } else {
            console.warn(`Datalist ${datalistId} not found`);
        }
    });

    // ===== POPULATE DUTY TYPE DROPDOWNS (regular selects) =====
    const dutyTypeSelects = [
        document.getElementById('shiftDutyType'),
        document.getElementById('editShiftDutyType')
    ];
    
    dutyTypeSelects.forEach(select => {
        if (select) {
            // For add modal, check if we want to preserve Active Shift
            const isAddModal = select.id === 'shiftDutyType';
            
            select.innerHTML = '<option value="">Select Duty Type</option>';
            
            // Add all duty types from database
            dutyTypes.forEach(dt => {
                const option = document.createElement('option');
                option.value = dt.id;
                option.textContent = dt.name;
                select.appendChild(option);
            });
            
            // For the add modal, set Active Shift as default if it exists
            if (isAddModal) {
                const activeShiftType = dutyTypes.find(dt => 
                    dt.name === 'Active Shift' || 
                    dt.name.toLowerCase() === 'active shift' ||
                    dt.name.toLowerCase().includes('active')
                );
                
                if (activeShiftType) {
                    select.value = activeShiftType.id;
                } else if (dutyTypes.length > 0) {
                    // If no Active Shift found, select the first duty type
                    select.value = dutyTypes[0].id;
                }
            }
            
            console.log(`Populated duty type select with ${dutyTypes.length} duty types`);
        }
    });

    // ===== POPULATE STATUS DROPDOWN (only for edit modal) =====
    const statusSelect = document.getElementById('editShiftStatus');
    if (statusSelect) {
        statusSelect.innerHTML = `
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
        `;
    }
}

function loadPayRateOptions() {
    const select = document.getElementById('shiftPayRate');
    if (select && window.payRates) {
        select.innerHTML = '<option value="">Use Staff Default</option>' +
            window.payRates.map(pr => 
                `<option value="${pr.id}">${pr.category} ${pr.level} - $${pr.hourly_pay_rate}/hr</option>`
            ).join('');
    }
}
function getParticipantColor(participantId) {
    if (!participantId) return 'transparent';
    
    const colors = [
        '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
        '#1abc9c', '#e67e22', '#16a085', '#f1c40f', '#e84393',
        '#00b894', '#6c5ce7', '#fdcb6e', '#fd79a8', '#a29bfe'
    ];
    
    // Use participant ID to consistently pick same color
    const hash = participantId.split('').reduce((acc, char) => 
        acc + char.charCodeAt(0), 0);
    
    return colors[hash % colors.length];
}
// Helper function to view a specific staff member's week
function viewStaffWeek(staffId, weekStart) {
    // Set filters
    document.getElementById('staffFilterInput').value = 
        staff.find(s => s.id === staffId)?.first_name + ' ' + 
        staff.find(s => s.id === staffId)?.last_name;
    updateStaffFilter();
    
    // Set week
    currentWeekStart = new Date(weekStart);
    updateWeekDisplay();
    loadShifts();
    
    // Switch to roster view
    switchView('table');
}


function editShift(shiftId) {
    const shift = shifts.find(s => s.id === shiftId);
    if (!shift) {
        console.error('Shift not found:', shiftId);
        return;
    }

    // Populate edit form
    document.getElementById('editShiftId').value = shift.id;
    document.getElementById('editShiftDate').value = shift.date;
    document.getElementById('editShiftStartTime').value = shift.start_time || '';
    document.getElementById('editShiftEndTime').value = shift.end_time || '';
    
    // Set staff selection - handle both shift.staff and shift.staff_member
    const staffData = shift.staff || shift.staff_member || {};
    if (shift.staff_id && staffData.first_name) {
        const staffName = `${staffData.first_name} ${staffData.last_name}`;
        document.getElementById('editShiftStaffInput').value = staffName;
        document.getElementById('editShiftStaff').value = shift.staff_id;
    } else {
        document.getElementById('editShiftStaffInput').value = '';
        document.getElementById('editShiftStaff').value = '';
    }
    
    // Set participant selection - handle both shift.participant and shift.participants
    const participantData = shift.participant || shift.participants || {};
    if (shift.participant_id && participantData.first_name) {
        const participantName = `${participantData.first_name} ${participantData.last_name}`;
        document.getElementById('editShiftParticipantInput').value = participantName;
        document.getElementById('editShiftParticipant').value = shift.participant_id;
        
        // Auto-populate location based on participant
        if (participantData.location_id) {
            document.getElementById('editShiftLocation').value = participantData.location_id;
            const location = locations.find(l => l.id === participantData.location_id);
            if (location) {
                document.getElementById('editShiftLocationDisplay').value = location.name;
            }
        }
    } else {
        document.getElementById('editShiftParticipantInput').value = '';
        document.getElementById('editShiftParticipant').value = '';
        document.getElementById('editShiftLocationDisplay').value = '';
    }
    
    // Set location if not already set by participant
    if (shift.location_id && !document.getElementById('editShiftLocation').value) {
        document.getElementById('editShiftLocation').value = shift.location_id;
        const location = shift.location || shift.locations || locations.find(l => l.id === shift.location_id);
        if (location) {
            document.getElementById('editShiftLocationDisplay').value = location.name || '';
        }
    }
    
    document.getElementById('editShiftDutyType').value = shift.duty_type_id || '';
    
    // Set clock-in required checkbox
    const clockInCheckbox = document.getElementById('editClockInRequired');
    if (clockInCheckbox) {
        clockInCheckbox.checked = shift.clock_in_required || false;
    }
    
    // Handle pay rate override
    const payRateSelect = document.getElementById('editShiftPayRate');
    if (payRateSelect) {
        // Clear existing options first
        payRateSelect.innerHTML = '<option value="">Use Assignment Default</option>';
        
        // Load pay rates for the selected staff if available
        if (shift.staff_id) {
            const staffMember = window.staff.find(s => s.id === shift.staff_id);
            if (staffMember && window.payRates) {
                window.payRates.forEach(rate => {
                    const option = document.createElement('option');
                    option.value = rate.id;
                    option.text = `${rate.category} - ${rate.level} (P${rate.pay_point}) - $${rate.hourly_pay_rate}/hr`;
                    payRateSelect.appendChild(option);
                });
            }
        }
        
        // Set the selected value
        if (shift.pay_override_id) {
            payRateSelect.value = shift.pay_override_id;
        }
    }
    
    document.getElementById('editShiftStatus').value = shift.status || 'pending'; // Default to pending instead of scheduled
    document.getElementById('editShiftNotes').value = shift.notes || '';

    // Show the modal
    document.getElementById('editShiftModal').style.display = 'flex';
    
    // Update the schedule cards after populating the form
    setTimeout(() => {
        updateModalScheduleCards('edit');
    }, 100);
}

        async function deleteShift(shiftId) {
    try {
        // Get the shift data before deletion for undo
        const shiftToDelete = shifts.find(s => s.id === shiftId);
        if (shiftToDelete) {
            // Save to undo stack
            UndoRedoManager.saveState('delete_shift', {
                id: parseInt(shiftId),
                shiftData: { ...shiftToDelete }
            });
        }
        
        // Soft delete - only use deleted_at (not deleted_by since it doesn't exist)
        const { error } = await supabaseClient
            .from('shifts')
            .update({ 
                deleted_at: new Date().toISOString()
            })
            .eq('id', shiftId);
        
        if (error) throw error;
        
        showNotification('Shift deleted successfully', 'success');
        
        // Close modal if open
        const modal = document.getElementById('editShiftModal');
        if (modal && modal.style.display !== 'none') {
            closeModal('editShiftModal');
        }
        
        await loadShifts();
        
        // Refresh conflicts view if it's active
        if (currentView === 'conflicts') {
            await renderConflicts();
        } else {
            renderCurrentView();
        }
        
    } catch (error) {
        console.error('Error deleting shift:', error);
        showNotification('Failed to delete shift', 'error');
    }
}

function deleteShiftConfirm() {
    const shiftId = parseInt(document.getElementById('editShiftId').value);
    
    if (!shiftId) {
        showNotification('No shift selected for deletion', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this shift? This action cannot be undone.')) {
        return;
    }

    deleteShift(shiftId);
}

        function updateTimeFields() {
            const dutyTypeSelect = document.getElementById('shiftDutyType');
            const startTimeInput = document.getElementById('shiftStartTime');
            const endTimeInput = document.getElementById('shiftEndTime');
            
            if (!dutyTypeSelect || !startTimeInput || !endTimeInput) return;
            
            const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeSelect.value);
            
            if (selectedDutyType && selectedDutyType.name.toLowerCase().includes('sleepover')) {
                startTimeInput.required = false;
                endTimeInput.required = false;
                startTimeInput.placeholder = "Optional for sleepovers";
                endTimeInput.placeholder = "Optional for sleepovers";
            } else {
                startTimeInput.required = true;
                endTimeInput.required = true;
                startTimeInput.placeholder = "";
                endTimeInput.placeholder = "";
            }
        }

        function updateEditTimeFields() {
            const dutyTypeSelect = document.getElementById('editShiftDutyType');
            const startTimeInput = document.getElementById('editShiftStartTime');
            const endTimeInput = document.getElementById('editShiftEndTime');
            
            if (!dutyTypeSelect || !startTimeInput || !endTimeInput) return;
            
            const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeSelect.value);
            
            if (selectedDutyType && selectedDutyType.name.toLowerCase().includes('sleepover')) {
                startTimeInput.required = false;
                endTimeInput.required = false;
                startTimeInput.placeholder = "Optional for sleepovers";
                endTimeInput.placeholder = "Optional for sleepovers";
            } else {
                startTimeInput.required = true;
                endTimeInput.required = true;
                startTimeInput.placeholder = "";
                endTimeInput.placeholder = "";
            }
        }

        function updateHourWarning() {
            const staffId = document.getElementById('shiftStaff').value;
            const warningDiv = document.getElementById('hourWarningText');
            
            if (!staffId || !warningDiv) {
                if (warningDiv) warningDiv.style.display = 'none';
                return;
            }
            
            const selectedStaff = staff.find(s => s.id === staffId);
            if (!selectedStaff || selectedStaff.limits === undefined || selectedStaff.limits === null) {
                warningDiv.style.display = 'none';
                return;
            }

            // Calculate current week hours
            const weekStart = getFortnightStart(new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weekShifts = shifts.filter(shift => 
                shift.staff_id === selectedStaff.id &&
                shift.date >= weekStart.toISOString().split('T')[0] &&
                shift.date <= weekEnd.toISOString().split('T')[0]
            );
            
            const currentWeekHours = weekShifts.reduce((total, shift) => 
                total + (shift.calculated_hours?.total || 0), 0
            );
            
            const hourLimit = parseFloat(selectedStaff.limits);
            const remaining = hourLimit - currentWeekHours;
            
            if (remaining <= 10) {
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = `WARNING: ${selectedStaff.first_name} has ${remaining.toFixed(1)}h remaining this week (${currentWeekHours.toFixed(1)}h/${hourLimit}h)`;
            } else {
                warningDiv.style.display = 'none';
            }
        }

        function validateSleepoverRules(shifts, newShift) {
    const violations = [];
    
    // If new shift is a sleepover
    if (newShift.duty_type?.toLowerCase().includes('sleepover')) {
        shifts.forEach(existing => {
            if (existing.start_time) {
                const startHour = parseInt(existing.start_time.split(':')[0]);
                const endHour = parseInt(existing.end_time?.split(':')[0]) || 0;
                
                // Check for late night shifts (10pm onwards)
                if (startHour >= 22 || startHour < 6) {
                    violations.push({
                        type: 'sleepover_conflict',
                        message: `Cannot have sleepover with late night shift (${existing.start_time} - ${existing.end_time})`,
                        shift: existing
                    });
                }
                
                // Check for early morning shifts (12am-6am)
                if (endHour > 0 && endHour <= 6) {
                    violations.push({
                        type: 'sleepover_conflict', 
                        message: `Cannot have sleepover with early morning shift ending at ${existing.end_time}`,
                        shift: existing
                    });
                }
            }
        });
    }
    
    // If new shift is active and there's a sleepover
    const hasSleepover = shifts.some(s => s.duty_type?.name?.toLowerCase().includes('sleepover'));
    if (hasSleepover && newShift.start_time) {
        const startHour = parseInt(newShift.start_time.split(':')[0]);
        const endHour = parseInt(newShift.end_time?.split(':')[0]) || 0;
        
        if (startHour >= 22 || startHour < 6 || (endHour > 0 && endHour <= 6)) {
            violations.push({
                type: 'sleepover_conflict',
                message: 'Cannot roster 10pm-6am shifts when staff has sleepover',
                shift: null
            });
        }
    }
    
    return violations;
}

// Comprehensive overlap check
async function checkShiftConflicts(staffId, participantId, date, startTime, endTime, dutyType, excludeShiftId = null) {
    const conflicts = {
        overlaps: [],
        violations: [],
        warnings: [],
        participantOverlaps: []
    };
    
    try {
        // Get all shifts for this staff on this date
        
        // 2. Get all shifts for this staff on this date
        let staffQuery = supabaseClient
            .from('shifts')
            .select('*, duty_type:duty_type_id(name)')
            .eq('staff_id', staffId)
            .eq('date', date)
            .is('deleted_at', null);
        
        if (excludeShiftId) {
            staffQuery = staffQuery.neq('id', excludeShiftId);
        }
        
        const { data: staffShifts } = await staffQuery;
        
        // 3. Check time overlaps for active shifts
        if (startTime && endTime && staffShifts) {
            const newStart = new Date(`2000-01-01T${startTime}`);
            const newEnd = new Date(`2000-01-01T${endTime}`);
            if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
            
            staffShifts.forEach(shift => {
                if (shift.start_time && shift.end_time) {
                    const existingStart = new Date(`2000-01-01T${shift.start_time}`);
                    const existingEnd = new Date(`2000-01-01T${shift.end_time}`);
                    if (existingEnd <= existingStart) existingEnd.setDate(existingEnd.getDate() + 1);
                    
                    // Check for overlap
                    if (!(newEnd <= existingStart || newStart >= existingEnd)) {
                        // Calculate overlap period
                        const overlapStart = new Date(Math.max(newStart, existingStart));
                        const overlapEnd = new Date(Math.min(newEnd, existingEnd));
                        
                        conflicts.overlaps.push({
                            type: 'time_overlap',
                            message: `Overlaps with shift ${formatTime12Hour(shift.start_time)}-${formatTime12Hour(shift.end_time)}`,
                            overlapPeriod: `${overlapStart.toTimeString().slice(0,5)}-${overlapEnd.toTimeString().slice(0,5)}`,
                            shift: shift,
                            blocking: true
                        });
                    }
                }
            });
        }
        
        // 4. Check sleepover business rules
        const sleepoverViolations = validateSleepoverRules(staffShifts || [], {
            start_time: startTime,
            end_time: endTime,
            duty_type: dutyType
        });
        
        conflicts.violations.push(...sleepoverViolations);
        
        // 5. Check participant overlaps (for information only)
        if (participantId && startTime && endTime) {
            const { data: participantShifts } = await supabaseClient
                .from('shifts')
                .select('*, staff:staff_id(first_name, last_name)')
                .eq('participant_id', participantId)
                .eq('date', date)
                .is('deleted_at', null)

            
            if (participantShifts) {
                const overlappingStaff = [];
                
                participantShifts.forEach(shift => {
                    if (shift.start_time && shift.end_time) {
                        const existingStart = new Date(`2000-01-01T${shift.start_time}`);
                        const existingEnd = new Date(`2000-01-01T${shift.end_time}`);
                        const newStart = new Date(`2000-01-01T${startTime}`);
                        const newEnd = new Date(`2000-01-01T${endTime}`);
                        
                        if (existingEnd <= existingStart) existingEnd.setDate(existingEnd.getDate() + 1);
                        if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
                        
                        if (!(newEnd <= existingStart || newStart >= existingEnd)) {
                            overlappingStaff.push({
                                staff: shift.staff,
                                time: `${formatTime12Hour(shift.start_time)}-${formatTime12Hour(shift.end_time)}`
                            });
                        }
                    }
                });
                
                if (overlappingStaff.length > 0) {
                    conflicts.participantOverlaps = {
                        count: overlappingStaff.length + 1, // +1 for the new shift
                        ratio: `${overlappingStaff.length + 1}:1`,
                        staff: overlappingStaff,
                        message: `Participant will have ${overlappingStaff.length + 1} staff during this time`
                    };
                }
            }
        }
        
    } catch (error) {
        console.error('Error checking conflicts:', error);
    }
    
    return conflicts;
}
        // ========================================
        // SUMMARY AND TIMESHEET RENDERING - FIXED
        // ========================================

        function renderclockinlogs() {
    const summaryGrid = document.getElementById('summaryGrid');
    if (!summaryGrid || !shifts) {
        if (summaryGrid) {
            summaryGrid.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>No shift data available</span>
                </div>
            `;
        }
        return;
    }
    
    // Get current filters
    const filters = window.currentFilters || {};
    const startDate = filters.startDate;
    const endDate = filters.endDate;
    const staffFilter = filters.staffId;
    const participantFilter = filters.participantId;
    
    // Filter shifts based on date range and other criteria
    let relevantShifts = shifts.filter(shift => {
        // Must have clock-in capability - check the actual column value
        if (shift.clock_in_required === false || shift.clock_in_required === null) return false;
        
        // Apply date filters
        if (startDate && shift.date < startDate) return false;
        if (endDate && shift.date > endDate) return false;
        
        // Apply staff/participant filters
        if (staffFilter && shift.staff_id !== staffFilter) return false;
        if (participantFilter && shift.participant_id !== participantFilter) return false;
        
        return true;
    });
    
    // Calculate summary statistics
    const stats = calculateClockInStats(relevantShifts);
    
    // Build the HTML
    let html = `
        <style>
            .clockin-summary-wrapper {
                background: white;
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            .summary-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }
            
            .stat-card {
                background: rgba(255,255,255,0.15);
                padding: 16px;
                border-radius: 8px;
                backdrop-filter: blur(10px);
            }
            
            .stat-label {
                font-size: 12px;
                opacity: 0.9;
                margin-bottom: 4px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .stat-value {
                font-size: 24px;
                font-weight: bold;
            }
            
            .stat-subtext {
                font-size: 11px;
                opacity: 0.8;
                margin-top: 4px;
            }
            
            .clockin-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
            }
            
            .clockin-table thead {
                background: #f8f9fa;
            }
            
            .clockin-table th {
                padding: 12px;
                text-align: left;
                font-weight: 600;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: #495057;
                border-bottom: 2px solid #dee2e6;
            }
            
            .clockin-table td {
                padding: 14px 12px;
                border-bottom: 1px solid #e9ecef;
                font-size: 14px;
                vertical-align: middle;
            }
            
            .clockin-row {
                transition: all 0.2s ease;
                background: white;
            }
            
            .clockin-row:hover {
                background: #f8f9fa;
            }
            
            .clockin-row.on-time {
                background: #d4edda;
            }
            
            .clockin-row.late {
                background: #fff3cd;
            }
            
            .clockin-row.very-late {
                background: #f8d7da;
            }
            
            .clockin-row.no-show {
                background: #f8d7da;
                opacity: 0.8;
            }
            
            .status-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .status-on-time { background: #28a745; color: white; }
            .status-late { background: #ffc107; color: #333; }
            .status-very-late { background: #dc3545; color: white; }
            .status-no-show { background: #6c757d; color: white; }
            
            .location-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
            }
            
            .location-ok { background: #d4edda; color: #155724; }
            .location-warning { background: #fff3cd; color: #856404; }
            .location-error { background: #f8d7da; color: #721c24; }
            
            .time-diff {
                font-weight: 600;
                font-size: 13px;
            }
            
            .time-diff.late { color: #dc3545; }
            .time-diff.on-time { color: #28a745; }
            
            .clock-icon {
                width: 16px;
                height: 16px;
                display: inline-block;
                margin-right: 4px;
                vertical-align: middle;
            }
        </style>
        
        <div class="clockin-summary-wrapper">
            <!-- Summary Statistics -->
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Shifts</div>
                    <div class="stat-value">${stats.totalShifts}</div>
                    <div class="stat-subtext">In selected period</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">On-Time Rate</div>
                    <div class="stat-value">${stats.onTimePercentage}%</div>
                    <div class="stat-subtext">${stats.onTimeCount} of ${stats.totalWithClockIn} shifts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Tardiness</div>
                    <div class="stat-value">${stats.avgTardiness} min</div>
                    <div class="stat-subtext">For late clock-ins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Location Compliance</div>
                    <div class="stat-value">${stats.locationCompliance}%</div>
                    <div class="stat-subtext">Within 200m radius</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Missing Clock-Ins</div>
                    <div class="stat-value">${stats.missingClockIns}</div>
                    <div class="stat-subtext">Require attention</div>
                </div>
            </div>
            
            <!-- Table -->
            <table class="clockin-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">Staff Member</th>
                        <th style="width: 15%;">Participant</th>
                        <th style="width: 10%;">Date</th>
                        <th style="width: 12%;">Scheduled</th>
                        <th style="width: 12%;">Clock In</th>
                        <th style="width: 10%;">Difference</th>
                        <th style="width: 14%;">Location</th>
                        <th style="width: 8%;">Clock Out</th>
                        <th style="width: 4%;" title="Clock-in Required"><i class="fas fa-clock"></i></th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Sort shifts by date and time - FIXED: Handle null start_time values
    relevantShifts.sort((a, b) => {
        // First sort by date
        if (a.date !== b.date) {
            return new Date(b.date) - new Date(a.date);
        }
        
        // Then sort by start_time, handling null values
        if (!a.start_time && !b.start_time) return 0;
        if (!a.start_time) return 1;  // Put null values at the end
        if (!b.start_time) return -1; // Put null values at the end
        
        return a.start_time.localeCompare(b.start_time);
    });
    
    // Render each shift row
    relevantShifts.forEach(shift => {
        const punctuality = calculatePunctuality(shift);
        const locationCompliance = calculateLocationCompliance(shift);
        const rowClass = getRowClass(punctuality);
        
        // Create clock-in indicator
        const clockInIndicator = shift.clock_in_required ? 
            '<i class="fas fa-clock" style="color: #28a745;" title="Clock-in required"></i>' :
            '<i class="fas fa-clock-o" style="color: #6c757d;" title="No clock-in required"></i>';
        
        html += `
            <tr class="clockin-row ${rowClass}">
                <td>
                    <strong>${shift.staff?.first_name || ''} ${shift.staff?.last_name || ''}</strong>
                    <div style="font-size: 11px; color: #6c757d;">${shift.staff?.staff_code || ''}</div>
                </td>
                <td>
                    <strong>${shift.participant?.first_name || ''} ${shift.participant?.last_name || ''}</strong>
                    <div style="font-size: 11px; color: #6c757d;">${shift.participant?.ndis_participant_number || ''}</div>
                </td>
                <td>${formatDateShort(shift.date)}</td>
                <td>
                    <i class="fas fa-clock clock-icon" style="color: #6c757d;"></i>
                    ${shift.start_time ? formatTime12Hour(shift.start_time) : 'N/A'}
                </td>
                <td>
                    ${shift.clock_in_time ? 
                        `<i class="fas fa-check-circle clock-icon" style="color: #28a745;"></i>
                         ${formatClockTime(shift.clock_in_time)}` :
                        `<i class="fas fa-times-circle clock-icon" style="color: #dc3545;"></i>
                         <span style="color: #dc3545;">Missing</span>`
                    }
                </td>
                <td>
                    ${punctuality.displayText}
                </td>
                <td>
                    ${locationCompliance.badge}
                    ${locationCompliance.address ? 
                        `<div style="font-size: 10px; color: #6c757d; margin-top: 2px;">${locationCompliance.address}</div>` : 
                        ''
                    }
                </td>
                <td>
                    ${shift.clock_out_time ? 
                        formatClockTime(shift.clock_out_time) :
                        '<span style="color: #6c757d;">—</span>'
                    }
                </td>
                <td style="text-align: center;">
                    ${clockInIndicator}
                </td>
            </tr>
        `;
    });
    
    if (relevantShifts.length === 0) {
        html += `
            <tr>
                <td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-clock" style="font-size: 32px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <div>No shifts found matching the selected filters</div>
                </td>
            </tr>
        `;
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    summaryGrid.innerHTML = html;
}


// Helper function to calculate punctuality in NSW timezone
function calculatePunctuality(shift) {
    if (!shift.clock_in_time) {
        return {
            minutesLate: null,
            displayText: '<span class="time-diff" style="color: #dc3545;">No Clock-In</span>',
            statusBadge: '<span class="status-badge status-no-show">NO SHOW</span>',
            category: 'no-show'
        };
    }
    
    // Create full datetime strings for comparison
    const scheduledDateTime = new Date(`${shift.date}T${shift.start_time}`);
    const clockInDateTime = new Date(shift.clock_in_time);
    
    // Calculate difference in milliseconds (both are in UTC, so comparison is valid)
    const diffMs = clockInDateTime - scheduledDateTime;
    const diffMinutes = Math.floor(diffMs / 60000);
    
    let displayText, statusBadge, category;
    
    if (diffMinutes <= 5 && diffMinutes >= -5) {
        // On time (within 5 minutes)
        displayText = '<span class="time-diff on-time">On Time</span>';
        statusBadge = '<span class="status-badge status-on-time">ON TIME</span>';
        category = 'on-time';
    } else if (diffMinutes > 5 && diffMinutes <= 15) {
        // Late (5-15 minutes)
        displayText = `<span class="time-diff late">+${diffMinutes} min</span>`;
        statusBadge = '<span class="status-badge status-late">LATE</span>';
        category = 'late';
    } else if (diffMinutes > 15) {
        // Very late (>15 minutes)
        displayText = `<span class="time-diff late" style="font-weight: bold;">+${diffMinutes} min</span>`;
        statusBadge = '<span class="status-badge status-very-late">VERY LATE</span>';
        category = 'very-late';
    } else {
        // Early
        displayText = `<span class="time-diff on-time">${diffMinutes} min</span>`;
        statusBadge = '<span class="status-badge status-on-time">EARLY</span>';
        category = 'on-time';
    }
    
    return {
        minutesLate: diffMinutes > 0 ? diffMinutes : 0,
        displayText,
        statusBadge,
        category
    };
}

// Helper function to calculate location compliance
function calculateLocationCompliance(shift) {
    if (!shift.clock_in_distance_meters) {
        return {
            compliant: null,
            distance: null,
            badge: '<span class="location-badge" style="background: #e9ecef; color: #6c757d;"><i class="fas fa-map-marker-alt"></i> Unknown</span>',
            address: shift.clock_in_address || null
        };
    }
    
    const distance = parseFloat(shift.clock_in_distance_meters);
    let badge, compliant;
    
    if (distance < 100) {
        badge = `<span class="location-badge location-ok"><i class="fas fa-check-circle"></i> ${distance.toFixed(0)}m</span>`;
        compliant = true;
    } else if (distance <= 200) {
        badge = `<span class="location-badge location-warning"><i class="fas fa-exclamation-triangle"></i> ${distance.toFixed(0)}m</span>`;
        compliant = true;
    } else {
        badge = `<span class="location-badge location-error"><i class="fas fa-times-circle"></i> ${distance.toFixed(0)}m</span>`;
        compliant = false;
    }
    
    return {
        compliant,
        distance,
        badge,
        address: shift.clock_in_address || null
    };
}

// Helper function to determine row class based on punctuality
function getRowClass(punctuality) {
    switch(punctuality.category) {
        case 'on-time': return 'on-time';
        case 'late': return 'late';
        case 'very-late': return 'very-late';
        case 'no-show': return 'no-show';
        default: return '';
    }
}

// Helper function to format clock-in/out times in NSW timezone
function formatClockTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    // Format in NSW timezone
    return date.toLocaleTimeString('en-AU', { 
        timeZone: 'Australia/Sydney',
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
    });
}

// Calculate summary statistics
function calculateClockInStats(shifts) {
    const totalShifts = shifts.length;
    const shiftsWithClockIn = shifts.filter(s => s.clock_in_time);
    const totalWithClockIn = shiftsWithClockIn.length;
    
    // Calculate on-time metrics
    let onTimeCount = 0;
    let totalTardinessMinutes = 0;
    let lateShiftsCount = 0;
    
    shiftsWithClockIn.forEach(shift => {
        const punctuality = calculatePunctuality(shift);
        if (punctuality.category === 'on-time') {
            onTimeCount++;
        } else if (punctuality.minutesLate > 0) {
            totalTardinessMinutes += punctuality.minutesLate;
            lateShiftsCount++;
        }
    });
    
    // Calculate location compliance
    const shiftsWithLocation = shifts.filter(s => s.clock_in_distance_meters !== null && s.clock_in_distance_meters !== undefined);
    const compliantLocations = shiftsWithLocation.filter(s => s.clock_in_distance_meters <= 200);
    
    return {
        totalShifts,
        totalWithClockIn,
        onTimeCount,
        onTimePercentage: totalWithClockIn > 0 ? Math.round((onTimeCount / totalWithClockIn) * 100) : 0,
        avgTardiness: lateShiftsCount > 0 ? Math.round(totalTardinessMinutes / lateShiftsCount) : 0,
        locationCompliance: shiftsWithLocation.length > 0 ? 
            Math.round((compliantLocations.length / shiftsWithLocation.length) * 100) : 100,
        missingClockIns: totalShifts - totalWithClockIn
    };
}

        
// 2. The EXACT calculateShiftHours function from mc-manager
function calculateShiftHours(shift) {
    const result = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0
    };

    const dutyType = shift.duty_type || shift.duty_types;
    const isSleepover = dutyType && dutyType.name && 
        dutyType.name.toLowerCase().includes('sleepover');

    // If it has times AND is a sleepover, calculate both
    if (isSleepover && shift.start_time && shift.end_time) {
        // This is BOTH active hours AND a sleepover
        
        // First calculate active hours
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const activeHours = (endTime - startTime) / (1000 * 60 * 60);
        
        // Apply penalty logic for active hours
        const shiftDate = new Date(shift.date);
        const dayOfWeek = shiftDate.getDay();
        const isPublicHoliday = publicHolidays.has(shift.date);
        
        if (isPublicHoliday) {
            result.publicHoliday = activeHours;
        } else if (dayOfWeek === 6) {
            result.saturday = activeHours;
        } else if (dayOfWeek === 0) {
            result.sunday = activeHours;
        } else {
            const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
            Object.assign(result, weekdayBreakdown);
        }
        
        // ADD the sleepover hours on top
        result.sleepover = 2; // Always 2 hours for sleepover
        result.total = activeHours + 2; // Total is active + sleepover
        
    } else if (isSleepover) {
        // Just a sleepover, no active hours
        result.sleepover = 2;
        result.total = 2;
        
    } else if (shift.start_time && shift.end_time) {
        // Just active hours, no sleepover
        const startTime = new Date(`${shift.date}T${shift.start_time}`);
        let endTime = new Date(`${shift.date}T${shift.end_time}`);
        
        if (endTime <= startTime) {
            endTime.setDate(endTime.getDate() + 1);
        }
        
        const totalHours = (endTime - startTime) / (1000 * 60 * 60);
        result.total = totalHours;
        
        // Apply penalty logic
        const shiftDate = new Date(shift.date);
        const dayOfWeek = shiftDate.getDay();
        const isPublicHoliday = publicHolidays.has(shift.date);
        
        if (isPublicHoliday) {
            result.publicHoliday = totalHours;
        } else if (dayOfWeek === 6) {
            result.saturday = totalHours;
        } else if (dayOfWeek === 0) {
            result.sunday = totalHours;
        } else {
            const weekdayBreakdown = splitWeekdayHours(startTime, endTime);
            Object.assign(result, weekdayBreakdown);
        }
    }
    
    return result;
}

// 3. The EXACT splitWeekdayHours function
function splitWeekdayHours(startTime, endTime) {
    const result = {
        total: 0,
        weekdayDay: 0,      // 6am-8pm
        weekdayEvening: 0,  // 8pm-12am  
        weekdayNight: 0     // 12am-6am
    };

    const current = new Date(startTime);
    
    while (current < endTime) {
        // Calculate end of current period
        const nextPeriod = new Date(current);
        nextPeriod.setMinutes(current.getMinutes() + 30); // Calculate in 30-min increments
        
        const periodEnd = nextPeriod > endTime ? endTime : nextPeriod;
        const periodHours = (periodEnd - current) / (1000 * 60 * 60);
        
        const hour = current.getHours();
        
        // Time period classification
        if (hour >= 6 && hour < 20) {
            result.weekdayDay += periodHours;
        } else if (hour >= 20 && hour < 24) {
            result.weekdayEvening += periodHours;
        } else {
            result.weekdayNight += periodHours;
        }
        
        current.setTime(periodEnd.getTime());
    }

    result.total = result.weekdayDay + result.weekdayEvening + result.weekdayNight;
    return result;
}

// 4. The EXACT calculateTimesheetHours for the timesheet display
function calculateTimesheetHours(shifts) {
    const breakdown = {
        total: 0,
        weekdayDay: 0,
        weekdayEvening: 0,
        weekdayNight: 0,
        saturday: 0,
        sunday: 0,
        publicHoliday: 0,
        sleepover: 0,
        sleepoverCount: 0
    };
    
    shifts.forEach(shift => {
        const hours = calculateShiftHours(shift);
        
        breakdown.total += hours.total || 0;
        breakdown.weekdayDay += hours.weekdayDay || 0;
        breakdown.weekdayEvening += hours.weekdayEvening || 0;
        breakdown.weekdayNight += hours.weekdayNight || 0;
        breakdown.saturday += hours.saturday || 0;
        breakdown.sunday += hours.sunday || 0;
        breakdown.publicHoliday += hours.publicHoliday || 0;
        breakdown.sleepover += hours.sleepover || 0;
        
        // Count sleepovers (not hours)
        if (hours.sleepover > 0) {
            breakdown.sleepoverCount++;
        }
    });
    
    // Update the hours grid display
    const hoursGrid = document.getElementById('hoursGrid');
    if (hoursGrid) {
        hoursGrid.innerHTML = `
            <div class="hours-item">
                <span class="hours-label">Weekday Day</span>
                <span class="hours-value">${breakdown.weekdayDay.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Evening</span>
                <span class="hours-value">${breakdown.weekdayEvening.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Night</span>
                <span class="hours-value">${breakdown.weekdayNight.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Saturday</span>
                <span class="hours-value">${breakdown.saturday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sunday</span>
                <span class="hours-value">${breakdown.sunday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Public Holiday</span>
                <span class="hours-value">${breakdown.publicHoliday.toFixed(1)}h</span>
            </div>
            <div class="hours-item">
                <span class="hours-label">Sleepovers</span>
                <span class="hours-value">${breakdown.sleepoverCount}</span>
            </div>
        `;
    }
    
    // Update total
    const totalElement = document.getElementById('totalHours');
    if (totalElement) {
        totalElement.textContent = `${breakdown.total.toFixed(1)}h`;
    }
    
    return breakdown;
}



function renderTimesheet() {
    const timesheetContent = document.getElementById('timesheetContent');
    if (!timesheetContent) return;
    
    console.log('Rendering timesheet...');
    
    // Group by staff
    const staffGroups = {};
    filteredShifts.forEach(shift => {
        const staffId = shift.staff_id;
        if (!staffGroups[staffId]) {
            staffGroups[staffId] = {
                staff: shift.staff,
                shifts: [],
                totalHours: { 
                    total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                    saturday: 0, sunday: 0, publicHoliday: 0, sleepover: 0,
                    overtime: 0 // Added overtime tracking
                },
                totalPay: 0,
                sleepoverCount: 0,
                weeklyHours: 0 // Track weekly hours for overtime calculation
            };
        }
        staffGroups[staffId].shifts.push(shift);
    });

    // Calculate totals for each staff member
    Object.values(staffGroups).forEach(group => {
        // First pass: calculate base hours
        group.shifts.forEach(shift => {
            const hours = shift.calculated_hours || {};
            const pay = shift.calculated_pay || 0;
            
            // Sum all hour categories
            Object.keys(hours).forEach(category => {
                if (group.totalHours[category] !== undefined) {
                    group.totalHours[category] += hours[category] || 0;
                }
            });
            
            // Count sleepovers (not hours)
            if (hours.sleepover > 0) {
                group.sleepoverCount++;
            }
            
            // Track public holiday hours - check the shift's is_public_holiday field
            if (shift.is_public_holiday === true) {
                group.totalHours.publicHoliday += hours.total || 0;
            }
            
            group.totalPay += pay;
        });
        
        // Calculate overtime (hours over 38 per week for full-time/part-time)
        const staff = group.staff;
        const payCategory = staff?.pay_category || 'casual';
        
        if (payCategory.toLowerCase().includes('full') || payCategory.toLowerCase().includes('part')) {
            // Only calculate overtime for full-time and part-time staff
            const standardWeeklyHours = 38;
            if (group.totalHours.total > standardWeeklyHours) {
                group.totalHours.overtime = group.totalHours.total - standardWeeklyHours;
            }
        }
        
        // Apply hour limits
        if (staff && staff.limits !== undefined && staff.limits !== null) {
            const hourLimit = parseFloat(staff.limits);
            group.overLimit = group.totalHours.total > hourLimit;
            group.hourLimit = hourLimit;
            group.finalHours = Math.min(group.totalHours.total, hourLimit);
            group.deductedHours = Math.max(0, group.totalHours.total - hourLimit);
        } else {
            group.overLimit = false;
            group.hourLimit = 76; // Default
            group.finalHours = group.totalHours.total;
            group.deductedHours = 0;
        }
        
        // Get pay rate label
        if (staff && staff.pay_rate_id) {
            group.payRateLabel = payRateLabels.get(staff.pay_rate_id) || 'Standard Rate';
        } else {
            group.payRateLabel = 'Standard Rate';
        }
    });

    // Calculate grand totals for footer
    let grandTotalHours = 0;
    let grandTotalPay = 0;
    let grandTotalOvertime = 0;
    let grandTotalPublicHoliday = 0;
    
    Object.values(staffGroups).forEach(group => {
        grandTotalHours += group.totalHours.total;
        grandTotalPay += group.totalPay;
        grandTotalOvertime += group.totalHours.overtime || 0;
        grandTotalPublicHoliday += group.totalHours.publicHoliday || 0;
    });

    let html = `
        <style>
            .timesheet-wrapper {
                background: white;
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            .timesheet-table { 
                width: 100%; 
                border-collapse: separate;
                border-spacing: 0;
                background: white;
            }
            
            .timesheet-table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .timesheet-table th { 
                padding: 16px 12px; 
                text-align: left; 
                font-weight: 600; 
                font-size: 11px; 
                text-transform: uppercase;
                letter-spacing: 1px;
                color: white;
                border: none;
            }
            
            .timesheet-table tfoot {
                background: #f8f9fa;
                border-top: 2px solid #dee2e6;
            }
            
            .timesheet-table tfoot td {
                padding: 16px 12px;
                font-weight: 700;
                color: var(--text-primary);
                font-size: 14px;
            }
            
            .timesheet-row { 
                cursor: pointer; 
                transition: all 0.2s ease;
                background: white;
                position: relative;
            }
            
            .timesheet-row:hover { 
                background: #f8f9fa;
                transform: translateX(2px);
            }
            
            .timesheet-row td { 
                padding: 16px 12px; 
                border-bottom: 1px solid #e9ecef; 
                font-size: 14px;
                vertical-align: middle;
            }
            
            .timesheet-row:hover td:first-child {
                border-left: 3px solid var(--primary-color);
                padding-left: 9px;
            }
            
            .accordion-content { 
                display: none; 
                background: #f8f9fa;
            }
            
            .accordion-content.active { 
                display: table-row;
                animation: slideDown 0.3s ease;
            }
            
            .assignment-manager-accordion {
    padding: 20px;
}

.view-mode-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.search-filter-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex: 1;
}

.assignment-controls {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    align-items: center;
}

.rate-amount {
    margin-left: 8px;
    color: #6c757d;
}

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .accordion-arrow { 
                display: inline-block; 
                margin-right: 10px; 
                transition: transform 0.3s ease; 
                font-size: 12px;
                color: var(--primary-color);
                font-weight: bold;
            }
            
            .accordion-arrow.open { 
                transform: rotate(90deg); 
            }
            
            .staff-name {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 15px;
            }
            
            .pay-rate-badge {
                display: inline-block;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 500;
                letter-spacing: 0.5px;
            }
            
            .hours-display {
                font-weight: 500;
                font-size: 14px;
            }
            
            .hours-limit {
                color: var(--text-muted);
                font-weight: normal;
            }
            
            .hour-exceeded { 
                color: #e74c3c !important; 
                font-weight: 600; 
            }
            
            .exceeded-badge {
                display: inline-block;
                background: #e74c3c;
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 10px;
                margin-left: 8px;
                font-weight: 600;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            .sleepover-badge {
                display: inline-block;
                background: #f39c12;
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-weight: 600;
                font-size: 13px;
            }
            
            .overtime-badge {
                display: inline-block;
                background: #e67e22;
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-weight: 600;
                font-size: 13px;
                margin-left: 6px;
            }
            
            .hour-breakdown-cell {
                font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
                font-size: 12px;
                line-height: 1.8;
                color: var(--text-secondary);
                background: #f8f9fa;
                padding: 8px 12px !important;
                border-radius: 6px;
            }
            
            .hour-breakdown-item {
                display: inline-block;
                padding: 3px 8px;
                background: white;
                border-radius: 4px;
                margin-right: 8px;
                margin-bottom: 4px;
                border: 1px solid #e9ecef;
            }
            
            .hour-breakdown-item.overtime {
                background: #fff4e4;
                border-color: #ffd6a5;
                color: #e67e22;
                font-weight: 600;
            }
            
            .hour-breakdown-item.public-holiday {
                background: #e3f2fd;
                border-color: #90caf9;
                color: #1976d2;
                font-weight: 600;
            }
            
            .final-hours {
                font-weight: 600;
                font-size: 15px;
                color: var(--text-primary);
            }
            
            .deducted { 
                color: #e67e22; 
                font-size: 11px;
                font-weight: 500;
                display: block;
                margin-top: 4px;
            }
            
            .total-pay {
                font-weight: 700;
                font-size: 16px;
                color: #27ae60;
            }
            
            .shifts-detail-container {
                padding: 24px;
                background: white;
                margin: 16px;
                border-radius: 8px;
                box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            }
            
            .shifts-detail-header {
                margin-bottom: 16px;
                color: var(--text-secondary);
                font-size: 13px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .shifts-detail-table { 
                width: 100%;
                font-size: 13px;
                border-collapse: separate;
                border-spacing: 0;
                overflow: hidden;
                border-radius: 6px;
                border: 1px solid #e9ecef;
            }
            
            .shifts-detail-table th { 
                background: #f8f9fa;
                padding: 10px 12px; 
                text-align: left;
                font-weight: 600;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-secondary);
                border-bottom: 1px solid #e9ecef;
            }
            
            .shifts-detail-table td { 
                padding: 12px; 
                border-bottom: 1px solid #f1f3f4;
                background: white;
            }
            
            .shifts-detail-table tbody tr:hover {
                background: #f8f9fa;
            }
            
            .shifts-detail-table tbody tr:last-child td {
                border-bottom: none;
            }
            
            .status-badge {
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .status-confirmed {
                background: #d4edda;
                color: #155724;
            }
            
            .status-pending {
                background: #fff3cd;
                color: #856404;
            }
            
            .status-completed {
                background: #cce5ff;
                color: #004085;
            }
            
            .public-holiday-indicator {
                display: inline-block;
                background: #1976d2;
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 10px;
                margin-left: 6px;
                font-weight: 600;
                text-transform: uppercase;
            }
        </style>
        
        <div class="timesheet-wrapper">
            <table class="timesheet-table">
                <thead>
                    <tr>
                        <th style="width: 20%;">Staff Member</th>
                        <th style="width: 15%;">Pay Rate</th>
                        <th style="width: 12%;">Hours / Limit</th>
                        <th style="width: 8%; text-align: center;">Sleepovers</th>
                        <th style="width: 30%;">Hour Breakdown</th>
                        <th style="width: 10%;">Final Hours</th>
                        <th style="width: 10%; text-align: right;">Total Pay</th>
                    </tr>
                </thead>
                <tbody>
    `;

    // Add each staff member's row and accordion content
    let accordionIndex = 0;
    Object.values(staffGroups).forEach(group => {
        const staff = group.staff || { first_name: 'Unknown', last_name: 'Staff' };
        const staffName = `${staff.first_name} ${staff.last_name}`;
        
        // Build hour breakdown with styled items
        const hourBreakdown = [];
        if (group.totalHours.weekdayDay > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Day: ${formatHours(group.totalHours.weekdayDay)}h</span>`);
        if (group.totalHours.weekdayEvening > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Eve: ${formatHours(group.totalHours.weekdayEvening)}h</span>`);
        if (group.totalHours.weekdayNight > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Night: ${formatHours(group.totalHours.weekdayNight)}h</span>`);
        if (group.totalHours.saturday > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Sat: ${formatHours(group.totalHours.saturday)}h</span>`);
        if (group.totalHours.sunday > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item">Sun: ${formatHours(group.totalHours.sunday)}h</span>`);
        if (group.totalHours.publicHoliday > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item public-holiday">PH: ${formatHours(group.totalHours.publicHoliday)}h</span>`);
        if (group.totalHours.overtime > 0) 
            hourBreakdown.push(`<span class="hour-breakdown-item overtime">OT: ${formatHours(group.totalHours.overtime)}h</span>`);
        
        const hourBreakdownStr = hourBreakdown.join('') || '<span style="color: #aaa;">—</span>';
        
        // Main row
        html += `
            <tr class="timesheet-row" onclick="toggleTimesheetAccordion(${accordionIndex})">
                <td>
                    <span class="accordion-arrow" id="arrow-${accordionIndex}">▶</span>
                    <span class="staff-name">${staffName}</span>
                </td>
                <td>
                    <span class="pay-rate-badge">${group.payRateLabel}</span>
                </td>
                <td>
                    <span class="hours-display ${group.overLimit ? 'hour-exceeded' : ''}">
                        ${formatHours(group.totalHours.total)}h 
                        <span class="hours-limit">/ ${group.hourLimit}h</span>
                        ${group.overLimit ? '<span class="exceeded-badge">EXCEEDED</span>' : ''}
                    </span>
                </td>
                <td style="text-align: center;">
                    ${group.sleepoverCount > 0 ? 
                        `<span class="sleepover-badge">${group.sleepoverCount}</span>` : 
                        '<span style="color: #ccc;">—</span>'}
                </td>
                <td class="hour-breakdown-cell">${hourBreakdownStr}</td>
                <td>
                    <span class="final-hours">${formatHours(group.finalHours)}h</span>
                    ${group.deductedHours > 0 ? 
                        `<span class="deducted">−${formatHours(group.deductedHours)}h deducted</span>` : ''}
                    ${group.totalHours.overtime > 0 ? 
                        `<span class="overtime-badge" title="Overtime hours">+${formatHours(group.totalHours.overtime)}h OT</span>` : ''}
                </td>
                <td style="text-align: right;">
                    <span class="total-pay">$${group.totalPay.toFixed(2)}</span>
                </td>
            </tr>
            <tr class="accordion-content" id="accordion-${accordionIndex}">
                <td colspan="7" style="padding: 0; background: #f8f9fa;">
                    <div class="shifts-detail-container">
                        <h4 class="shifts-detail-header">Individual Shifts (${group.shifts.length})</h4>
                        <table class="shifts-detail-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Participant</th>
                                    <th>Hours</th>
                                    <th>Type</th>
                                    <th>Pay</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        // Sort shifts by date
        group.shifts.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Add individual shifts
        group.shifts.forEach(shift => {
            const participant = shift.participant || {};
            const participantName = participant.first_name ? 
                `${participant.first_name} ${participant.last_name}` : 
                (shift.location?.name || 'Unassigned');
            
            const timeDisplay = shift.start_time && shift.end_time ? 
                `${formatTime12Hour(shift.start_time)} - ${formatTime12Hour(shift.end_time)}` : 
                'Sleepover';
            
            const shiftHours = shift.calculated_hours?.total || 0;
            const shiftPay = shift.calculated_pay || 0;
            const dutyType = dutyTypes.find(d => d.id === shift.duty_type_id);
            
            html += `
                <tr>
                    <td>
                        <strong>${formatDateFriendly(shift.date)}</strong>
                        ${shift.is_public_holiday === true ? '<span class="public-holiday-indicator">PH</span>' : ''}
                    </td>
                    <td>${timeDisplay}</td>
                    <td>${participantName}</td>
                    <td>${formatHours(shiftHours)}h</td>
                    <td>${dutyType?.name || 'Active Shift'}</td>
                    <td style="font-weight: 600; color: #27ae60;">$${shiftPay.toFixed(2)}</td>
                    <td><span class="status-badge status-${shift.status || 'pending'}">${shift.status || 'pending'}</span></td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
        `;
        
        accordionIndex++;
    });

    // Add footer with totals
    html += `
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2"><strong>TOTALS</strong></td>
                        <td><strong>${formatHours(grandTotalHours)}h</strong></td>
                        <td style="text-align: center;">—</td>
                        <td>
                            ${grandTotalOvertime > 0 ? `<span class="hour-breakdown-item overtime">OT: ${formatHours(grandTotalOvertime)}h</span>` : ''}
                            ${grandTotalPublicHoliday > 0 ? `<span class="hour-breakdown-item public-holiday">PH: ${formatHours(grandTotalPublicHoliday)}h</span>` : ''}
                        </td>
                        <td>—</td>
                        <td style="text-align: right;"><strong style="color: #27ae60;">$${grandTotalPay.toFixed(2)}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;

    timesheetContent.innerHTML = html || '<div class="loading">No timesheet data available</div>';
}
window.toggleTimesheetAccordion = function(index) {
    const content = document.getElementById(`accordion-${index}`);
    const arrow = document.getElementById(`arrow-${index}`);
    
    if (content && arrow) {
        content.classList.toggle('active');
        arrow.classList.toggle('open');
    }
};

// ========================================
// NOTES MANAGEMENT
// ========================================
let currentNotesPage = 1;
const notesPerPage = 20;

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

window.editNote = async function(noteId) {
    try {
        // Fetch the complete note data from database
        const { data: noteData, error } = await supabaseClient
            .from('shift_notes')
            .select('*')
            .eq('id', noteId)
            .single();
        
        if (error) throw error;
        
        // Store the note ID for updating
        window.editingNoteId = noteId;
        
        // Open the modal with prepopulated data
        showEditShiftNoteModal(noteData);
        
    } catch (error) {
        console.error('Error fetching note:', error);
        showNotification('Failed to load note for editing', 'error');
    }
};

window.saveNote = async function(noteId) {
    try {
        const editDiv = document.getElementById(`note-edit-${noteId}`);
        if (!editDiv) return;
        
        const newContent = editDiv.innerHTML.trim();
        if (!newContent || newContent === '<br>') {
            showNotification('Note cannot be empty', 'error');
            return;
        }
        
        // Update in database with HTML content
        const { error } = await supabaseClient
            .from('shift_notes')
            .update({ 
                note: newContent,
                updated_at: new Date().toISOString()
            })
            .eq('id', noteId);
        
        if (error) throw error;
        
        showNotification('Note updated successfully', 'success');
        renderNotes(currentNotesPage);
        
    } catch (error) {
        console.error('Error updating note:', error);
        showNotification('Failed to update note', 'error');
    }
};

window.cancelEditNote = function(noteId) {
    const noteContent = document.getElementById(`note-content-${noteId}`);
    const noteItem = document.querySelector(`[data-note-id="${noteId}"]`);
    
    if (!noteContent || !noteItem) return;
    
    // Restore original HTML content (not text)
    const originalContent = noteContent.dataset.original || '';
    noteContent.innerHTML = originalContent; // Use innerHTML instead of textContent
    
    // Toggle buttons
    const editBtn = noteItem.querySelector('.edit-note-btn');
    const saveBtn = noteItem.querySelector('.save-note-btn');
    const cancelBtn = noteItem.querySelector('.cancel-note-btn');
    
    if (editBtn) editBtn.style.display = 'inline-block';
    if (saveBtn) saveBtn.style.display = 'none';
    if (cancelBtn) cancelBtn.style.display = 'none';
};

async function renderNotes(page = 1) {
    try {
        const notesContent = document.getElementById('notesContent');
        if (!notesContent) return;
        
        currentNotesPage = page;
        const filters = window.currentFilters || {};
        
        // Build query with filters
        let countQuery = supabaseClient
            .from('shift_notes')
            .select('*', { count: 'exact', head: true });
            
        let dataQuery = supabaseClient
            .from('shift_notes')
            .select('*')
            .order('created_at', { ascending: false });

        // Apply date range filter if set
        if (filters.startDate) {
            const startDateTime = filters.startDate + 'T00:00:00';
            countQuery = countQuery.gte('created_at', startDateTime);
            dataQuery = dataQuery.gte('created_at', startDateTime);
        }
        if (filters.endDate) {
            const endDateTime = filters.endDate + 'T23:59:59';
            countQuery = countQuery.lte('created_at', endDateTime);
            dataQuery = dataQuery.lte('created_at', endDateTime);
        }

        // Apply staff filter if set
        if (filters.staffId) {
            countQuery = countQuery.eq('staff_id', filters.staffId);
            dataQuery = dataQuery.eq('staff_id', filters.staffId);
        }

        // Get total count with filters
        const { count } = await countQuery;
        
        const totalPages = Math.ceil((count || 0) / notesPerPage);
        const offset = (page - 1) * notesPerPage;
        
        // Get data for current page with filters
        const { data: notesData, error } = await dataQuery
            .range(offset, offset + notesPerPage - 1);
        
        if (error) throw error;
        
        // Manually enrich with related data
        const enrichedNotes = [];
        if (notesData) {
            for (const note of notesData) {
                const shift = shifts.find(s => s.id === note.shift_id) || {};
                const noteStaff = staff.find(s => s.id === note.staff_id) || {};
                const participant = shift.participant_id ? 
                    participants.find(p => p.id === shift.participant_id) : null;
                
                // Skip if participant filter is set and doesn't match
                if (filters.participantId) {
                    // Check if note has participant_id directly or through shift
                    const noteParticipantId = note.participant_id || shift.participant_id;
                    if (noteParticipantId !== filters.participantId) {
                        continue;
                    }
                }
                
                enrichedNotes.push({
                    ...note,
                    shift: shift,
                    staff: noteStaff,
                    participant: participant
                });
            }
        }
        
        // Start building HTML - KEEP YOUR EXISTING STYLES
        let html = `
            <style>
                .notes-wrapper {
                    background: white;
                    border-radius: var(--radius-lg);
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                }
                .note-item {
                    padding: 20px;
                    border-bottom: 1px solid #e9ecef;
                    transition: all 0.2s;
                }
                .note-item:hover {
                    background: #f8f9fa;
                }
                .note-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: start;
                    margin-bottom: 12px;
                }
                .note-actions {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                }
                .edit-note-btn, .save-note-btn, .cancel-note-btn {
                    padding: 4px 8px;
                    border: 1px solid #dee2e6;
                    border-radius: 4px;
                    background: white;
                    cursor: pointer;
                    font-size: 12px;
                }
                .save-note-btn {
                    background: #28a745;
                    color: white;
                    border-color: #28a745;
                }
                .cancel-note-btn {
                    background: #dc3545;
                    color: white;
                    border-color: #dc3545;
                }
                .note-type-badge {
                    display: inline-block;
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-right: 8px;
                }
                .note-type-shift, .note-type-general { background: #cce5ff; color: #004085; }
                .note-type-handover { background: #fff3cd; color: #856404; }
                .note-type-incident { background: #f8d7da; color: #721c24; }
                .note-type-activity { background: #d4edda; color: #155724; }
                .note-type-behaviour { background: #f5c6cb; color: #721c24; }
                .note-type-medical { background: #d1ecf1; color: #0c5460; }
                .note-content {
                    background: #f8f9fa;
                    padding: 16px;
                    border-radius: 8px;
                    margin: 12px 0;
                    line-height: 1.6;
                    color: var(--text-secondary);
                    white-space: pre-wrap;
                }
                .note-content-edit {
                    width: 100%;
                    min-height: 100px;
                    padding: 12px;
                    border: 1px solid #ced4da;
                    border-radius: 4px;
                    font-family: inherit;
                    font-size: 14px;
                    resize: vertical;
                }
                .note-meta {
                    font-size: 12px;
                    color: var(--text-muted);
                    display: flex;
                    gap: 16px;
                }
                .pagination {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 8px;
                    padding: 20px;
                    border-top: 1px solid #e9ecef;
                    background: #f8f9fa;
                }
                .pagination button {
                    padding: 8px 12px;
                    border: 1px solid #dee2e6;
                    background: white;
                    border-radius: 4px;
                    cursor: pointer;
                }
                .pagination button:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
            </style>
            <div class="notes-wrapper">
        `;
        
        if (enrichedNotes && enrichedNotes.length > 0) {
    enrichedNotes.forEach(note => {
        const isManager = currentUserRole === 'admin' || currentUserRole === 'manager';
        const canEdit = isManager || note.staff_id === currentStaffData?.id;
        
        const staffName = escapeHtml(`${note.staff?.first_name || 'Unknown'} ${note.staff?.last_name || ''}`);
        const noteType = escapeHtml(note.note_type || 'general');
        
        // Get participant name from participant_id field
        let participantName = '';
        if (note.participant_id) {
            const directParticipant = participants.find(p => p.id === note.participant_id);
            if (directParticipant) {
                participantName = escapeHtml(`${directParticipant.first_name} ${directParticipant.last_name}`);
            }
        }
        
        // Store raw note in base64 to avoid any escaping issues
        const noteDataEncoded = btoa(encodeURIComponent(note.note || ''));
        
        html += `
            <div class="note-item" data-note-id="${note.id}" data-note-content="${noteDataEncoded}">
                <div class="note-header">
                    <div>
                        <span class="note-type-badge note-type-${noteType}">${noteType}</span>
                        <strong>${staffName}</strong>
                        ${participantName ? `<span style="margin-left: 12px; padding: 2px 8px; background: #e9ecef; border-radius: 12px; font-size: 12px; color: #495057;">${participantName}</span>` : ''}
                        ${note.created_at ? `<span style="margin-left: 12px; font-size: 12px; color: var(--text-muted);">${formatDateFriendly(note.created_at.split('T')[0])}</span>` : ''}
                    </div>
                    <div class="note-actions">
                        <span style="font-size: 12px; color: var(--text-muted); margin-right: 12px;">
                            ${formatDateTime(note.created_at)}
                        </span>
                        ${canEdit ? `
                            <button class="edit-note-btn" onclick="window.editNote('${note.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="save-note-btn" onclick="window.saveNote('${note.id}')" style="display: none;">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="cancel-note-btn" onclick="window.cancelEditNote('${note.id}')" style="display: none;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        ` : ''}
                    </div>
                </div>
                <div class="note-content" id="note-content-${note.id}">${note.note || ''}</div>
            </div>
        `;
    });
    
    // Pagination remains the same
    if (totalPages > 1) {
        html += `
            <div class="pagination">
                <button onclick="renderNotes(1)" ${page === 1 ? 'disabled' : ''}>
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button onclick="renderNotes(${page - 1})" ${page === 1 ? 'disabled' : ''}>
                    <i class="fas fa-angle-left"></i> Previous
                </button>
                <span style="padding: 0 16px; font-size: 14px; color: #6c757d;">
                    Page ${page} of ${totalPages} (${count} notes)
                </span>
                <button onclick="renderNotes(${page + 1})" ${page === totalPages ? 'disabled' : ''}>
                    Next <i class="fas fa-angle-right"></i>
                </button>
                <button onclick="renderNotes(${totalPages})" ${page === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
        `;
    }
} else {
    // Show appropriate empty message based on filters
    const hasFilters = filters.startDate || filters.endDate || filters.staffId || filters.participantId;
    html += `
        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
            <h3>${hasFilters ? 'No notes match filters' : 'No notes found'}</h3>
            <p>${hasFilters ? 'Try adjusting your filters to see more notes' : 'Shift notes and communications will appear here'}</p>
            <button class="btn btn-primary" onclick="addShiftNote()" style="margin-top: 16px;">
                Add Shift Note
            </button>
        </div>
    `;
}

html += '</div>';
notesContent.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('notesContent').innerHTML = 
            '<div class="error">Failed to load notes: ' + error.message + '</div>';
    }
}

//=======SHIFT HANDOVER NOTE//
// Save edited note
async function saveNote(noteId) {
    try {
        const textarea = document.getElementById(`note-edit-${noteId}`);
        if (!textarea) return;
        
        const newContent = textarea.value.trim();
        if (!newContent) {
            showNotification('Note cannot be empty', 'error');
            return;
        }
        
        // Update in database
        const { error } = await supabaseClient
            .from('shift_notes')
            .update({ 
                note: newContent,
                updated_at: new Date().toISOString()
            })
            .eq('id', noteId);
        
        if (error) throw error;
        
        showNotification('Note updated successfully', 'success');
        
        // Refresh the notes display
        renderNotes(currentNotesPage);
        
    } catch (error) {
        console.error('Error updating note:', error);
        showNotification('Failed to update note', 'error');
    }
}

// Cancel edit
function cancelEditNote(noteId) {
    const noteContent = document.getElementById(`note-content-${noteId}`);
    const noteItem = document.querySelector(`[data-note-id="${noteId}"]`);
    
    if (!noteContent || !noteItem) return;
    
    // Restore original content
    const originalContent = noteContent.dataset.original || '';
    noteContent.innerHTML = originalContent;
    
    // Toggle buttons
    noteItem.querySelector('.edit-note-btn').style.display = 'inline-block';
    noteItem.querySelector('.save-note-btn').style.display = 'none';
    noteItem.querySelector('.cancel-note-btn').style.display = 'none';
}

function showAddNoteModal(shiftId = null) {
    let modal = document.getElementById('addNoteModal');
    
    if (!modal) {
        const modalHtml = `
            <div id="addNoteModal" class="modal-overlay" style="display: none;">
                <div class="modal">
                    <header class="modal-header">
                        <h3 class="modal-title">Edit Shift Note</h3>
                        <button class="modal-close" onclick="closeModal('addNoteModal')">&times;</button>
                    </header>
                    <div class="modal-content">
                        <form id="addNoteForm">
                            <input type="hidden" id="noteShiftId" value="">
                            <div class="form-group" id="shiftSelectGroup">
                                <label class="form-label">Shift *</label>
                                <select class="form-control" id="noteShift" required>
                                    <option value="">Select Shift</option>
                                </select>
                            </div>
                            <div class="form-group" id="shiftInfoGroup" style="display: none;">
                                <label class="form-label">Shift</label>
                                <div class="form-control" style="background: #f5f5f5; cursor: default;" id="shiftInfo">
                                    <!-- Shift info will be populated here -->
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Note</label>
                                <textarea class="form-control" id="noteContent" required 
                                          placeholder="Enter your note..." rows="4"></textarea>
                            </div>
                        </form>
                    </div>
                    <footer class="modal-footer">
                        <div class="modal-actions">
                            <button class="btn btn-outline" onclick="closeModal('addNoteModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="createNote()">Save Note</button>
                        </div>
                    </footer>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    requestAnimationFrame(async () => {
        const noteShiftIdElement = document.getElementById('noteShiftId');
        if (noteShiftIdElement) {
            noteShiftIdElement.value = shiftId || '';
        }
        
        const shiftSelectGroup = document.getElementById('shiftSelectGroup');
        const shiftInfoGroup = document.getElementById('shiftInfoGroup');
        const shiftInfo = document.getElementById('shiftInfo');
        const noteShift = document.getElementById('noteShift');
        const noteContent = document.getElementById('noteContent');
        
        if (shiftId && shiftId !== 'null' && shiftId !== 'undefined') {
            if (shiftSelectGroup) shiftSelectGroup.style.display = 'none';
            if (shiftInfoGroup) shiftInfoGroup.style.display = 'block';
            
            // Find shift and display info
            const shift = shifts.find(s => s.id == shiftId);
            if (shift) {
                if (shiftInfo) {
                    const staff = shift.staff || {};
                    const participant = shift.participant || {};
                    const shiftInfoText = `${formatDateFriendly(shift.date)} - ${staff.first_name || ''} ${staff.last_name || ''} / ${participant.first_name || 'Unassigned'} ${participant.last_name || ''}`;
                    shiftInfo.textContent = shiftInfoText;
                }
                
                // Load existing note into the textarea
                if (noteContent) {
                    noteContent.value = shift.notes || '';
                }
            }
        } else {
            // Show dropdown for general add
            if (shiftSelectGroup) shiftSelectGroup.style.display = 'block';
            if (shiftInfoGroup) shiftInfoGroup.style.display = 'none';
            
            // Clear the textarea for new note
            if (noteContent) noteContent.value = '';
            
            // Populate dropdown
            if (noteShift) {
                noteShift.innerHTML = '<option value="">Select Shift</option>';
                const relevantShifts = shifts.filter(shift => {
                    const shiftDate = new Date(shift.date);
                    const today = new Date();
                    const daysDiff = Math.abs((shiftDate - today) / (1000 * 60 * 60 * 24));
                    return daysDiff <= 30;
                });
                
                relevantShifts.forEach(shift => {
                    const staff = shift.staff || {};
                    const participant = shift.participant || {};
                    const shiftLabel = `${formatDateFriendly(shift.date)} - ${staff.first_name || ''} ${staff.last_name || ''} / ${participant.first_name || 'Unassigned'} ${participant.last_name || ''}`;
                    noteShift.innerHTML += `<option value="${shift.id}">${shiftLabel}</option>`;
                });
            }
        }
        
        const modalElement = document.getElementById('addNoteModal');
        if (modalElement) {
            modalElement.style.display = 'flex';
        }
    });
}

async function createNote() {
    try {
        // Get shift ID from hidden field or dropdown
        let shiftId = document.getElementById('noteShiftId').value;
        if (!shiftId) {
            shiftId = document.getElementById('noteShift').value;
        }
        shiftId = parseInt(shiftId);
        
        const noteContent = document.getElementById('noteContent').value;

        if (!shiftId || !noteContent?.trim()) {
            showNotification('Please fill in all fields', 'error');
            return;
        }

        // Update the shift's notes column
        const { error } = await supabaseClient
            .from('shifts')
            .update({ notes: noteContent.trim() })
            .eq('id', shiftId);

        if (error) throw error;

        showNotification('Note added successfully', 'success');
        closeModal('addNoteModal');
        
        // Refresh the current view if needed
        if (typeof loadShifts === 'function') {
            await loadShifts();
        }

    } catch (error) {
        console.error('Error creating note:', error);
        showNotification('Failed to add note: ' + error.message, 'error');
    }
}
        // ========================================
        // PUBLIC HOLIDAYS MANAGEMENT
        // ========================================

        async function loadPublicHolidays() {
    try {
        const { data: holidays, error } = await supabaseClient
            .from('public_holidays')
            .select('*')
            .order('date');
        
        if (error) throw error;
        
        // Clear and repopulate the Map
        publicHolidays.clear();
        holidays.forEach(holiday => {
            // Store date in YYYY-MM-DD format as key
            const dateKey = holiday.date.split('T')[0];
            publicHolidays.set(dateKey, {
                id: holiday.id,
                name: holiday.name,
                date: holiday.date
            });
        });
        
        console.log(`Loaded ${publicHolidays.size} public holidays from database`);
        return publicHolidays;
        
    } catch (error) {
        console.error('Error loading public holidays:', error);
        showNotification('Failed to load public holidays', 'error');
        return publicHolidays;
    }
}

// Add holiday to Supabase - Fixed version
async function addHoliday() {
    const date = document.getElementById('holidayDate').value;
    const name = document.getElementById('holidayName').value;
    
    if (!date || !name) {
        showNotification('Please enter both date and name', 'error');
        return;
    }
    
    try {
        // Generate a UUID for the id field (Supabase expects this)
        const holidayId = crypto.randomUUID();
        
        // Insert into Supabase with explicit ID
        const { data, error } = await supabaseClient
            .from('public_holidays')
            .insert([{
                id: holidayId,  // Explicitly provide the UUID
                date: date,
                name: name
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        // Update local cache
        publicHolidays.set(date, {
            id: data.id,
            name: data.name,
            date: data.date
        });
        
        populateHolidayList();
        
        // Clear the form
        document.getElementById('holidayDate').value = '';
        document.getElementById('holidayName').value = '';
        
        // Close modal if you have a cancelAddHoliday function
        if (typeof cancelAddHoliday === 'function') {
            cancelAddHoliday();
        }
        
        showNotification('Holiday added successfully', 'success');
        
        // Recalculate all shifts to apply new holiday
        await recalculateAllShifts();
        
    } catch (error) {
        console.error('Error adding holiday:', error);
        showNotification('Failed to add holiday: ' + error.message, 'error');
    }
}

// Remove holiday from Supabase
async function removeHoliday(holidayId) {
    if (!confirm('Are you sure you want to remove this holiday?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('public_holidays')
            .delete()
            .eq('id', holidayId);
        
        if (error) throw error;
        
        // Remove from local cache
        for (const [date, holiday] of publicHolidays.entries()) {
            if (holiday.id === holidayId) {
                publicHolidays.delete(date);
                break;
            }
        }
        
        populateHolidayList();
        showNotification('Holiday removed successfully', 'success');
        
        // Recalculate all shifts
        await recalculateAllShifts();
        
    } catch (error) {
        console.error('Error removing holiday:', error);
        showNotification('Failed to remove holiday', 'error');
    }
}

// Display holidays in the UI
function populateHolidayList() {
    const holidayList = document.getElementById('holidayList');
    if (!holidayList) return;
    
    if (publicHolidays.size === 0) {
        holidayList.innerHTML = `
            <div class="empty-state">
                <p style="color: #6c757d; text-align: center; padding: 20px;">
                    No holidays configured. Add holidays to apply penalty rates.
                </p>
            </div>`;
        return;
    }
    
    // Convert to array and sort by date
    const sortedHolidays = Array.from(publicHolidays.entries())
        .sort((a, b) => a[0].localeCompare(b[0]));
    
    holidayList.innerHTML = sortedHolidays.map(([date, holiday]) => `
        <div class="holiday-item" style="padding: 12px; border-bottom: 1px solid #e9ecef;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${holiday.name}</strong>
                    <span style="margin-left: 12px; color: #6c757d;">
                        ${formatDateFriendly(date)}
                    </span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="removeHoliday('${holiday.id}')">
                    <i class="fa-solid fa-trash"></i> Remove
                </button>
            </div>
        </div>
    `).join('');
}

// Helper function to recalculate all loaded shifts
async function recalculateAllShifts() {
    if (!window.shifts || shifts.length === 0) return;
    
    console.log('Recalculating all shifts with updated public holidays...');
    
    shifts.forEach(shift => {
        shift.calculated_hours = calculateShiftHours(shift);
        shift.calculated_pay = calculateShiftPay(shift, shift.calculated_hours);
        
        // Mark if it's a public holiday
        const shiftDateKey = shift.date.split('T')[0];
        shift.is_public_holiday = publicHolidays.has(shiftDateKey);
    });
    
    // Also update filtered shifts
    if (window.filteredShifts) {
        filteredShifts.forEach(shift => {
            shift.calculated_hours = calculateShiftHours(shift);
            shift.calculated_pay = calculateShiftPay(shift, shift.calculated_hours);
            
            // Mark if it's a public holiday
            const shiftDateKey = shift.date.split('T')[0];
            shift.is_public_holiday = publicHolidays.has(shiftDateKey);
        });
    }
    
    // Re-render current view
    if (typeof renderCurrentView === 'function') {
        renderCurrentView();
    } else if (typeof renderTimesheet === 'function') {
        renderTimesheet();
    }
}

        function showPublicHolidayModal() {
            document.getElementById('publicHolidayModal').style.display = 'flex';
            populateHolidayList();
        }

        function showAddHolidayForm() {
            document.getElementById('addHolidayForm').style.display = 'block';
        }

        function cancelAddHoliday() {
            document.getElementById('addHolidayForm').style.display = 'none';
            document.getElementById('holidayDate').value = '';
            document.getElementById('holidayName').value = '';
        }


        // ========================================
        // EXPORT FUNCTIONS - FIXED
        // ========================================

        function exportShifts() {
    if (!filteredShifts || filteredShifts.length === 0) {
        showNotification('No shifts to export', 'error');
        return;
    }
    
    // FIX #6: Include complete data in export
    const exportData = filteredShifts.map(shift => {
        const staffMember = staff.find(s => s.id === shift.staff_id);
        const participant = participants.find(p => p.id === shift.participant_id);
        const location = locations.find(l => l.id === shift.location_id);
        const dutyType = dutyTypes.find(d => d.id === shift.duty_type_id);
        const hours = calculateShiftHours(shift);
        
        // Format date properly for Excel
        const shiftDate = new Date(shift.date + 'T12:00:00');
        const formattedDate = shiftDate.toLocaleDateString('en-AU');
        
        return {
            ID: shift.id,
            Date: formattedDate,
            DayOfWeek: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][shiftDate.getDay()],
            StaffCode: staffMember?.staff_code || '',
            StaffFirstName: staffMember?.first_name || '',
            StaffLastName: staffMember?.last_name || '',
            ParticipantFirstName: participant?.first_name || '',
            ParticipantLastName: participant?.last_name || '',
            ParticipantNDIS: participant?.ndis_number || '',
            Location: location?.name || participant ? 'Client Home' : 'Unassigned',
            LocationAddress: location?.address || '',
            StartTime: shift.start_time || '',
            EndTime: shift.end_time || '',
            DutyType: dutyType?.name || '',
            Status: shift.status || 'scheduled',
            
            // Hours breakdown
            TotalHours: hours.total.toFixed(2),
            WeekdayDayHours: (hours.weekdayDay || 0).toFixed(2),
            WeekdayEveningHours: (hours.weekdayEvening || 0).toFixed(2),
            WeekdayNightHours: (hours.weekdayNight || 0).toFixed(2),
            SaturdayHours: (hours.saturday || 0).toFixed(2),
            SundayHours: (hours.sunday || 0).toFixed(2),
            PublicHolidayHours: (hours.publicHoliday || 0).toFixed(2),
            SleepoverCount: hours.sleepover ? (hours.sleepover / 2) : 0,
            
            // Pay information
            BaseRate: staffMember?.base_pay_rate || 0,
            CalculatedPay: (shift.calculated_pay || 0).toFixed(2),
            PayOverride: shift.pay_override_id ? 'Yes' : 'No',
            
            // Additional info
            Notes: shift.notes || '',
            CreatedAt: formatDateTime(shift.created_at),
            UpdatedAt: shift.updated_at ? formatDateTime(shift.updated_at) : '',
            TransferStatus: shift.transfer_status || '',
            AdjustmentStatus: shift.adjustment_status || ''
        };
    });
    
    downloadCSV(exportData, `shifts-export-${formatDate(new Date().toISOString())}.csv`);
    showNotification('Shifts exported successfully', 'success');
}

async function checkBulkShiftConflicts(shiftsToImport) {
    const conflicts = [];
    const warnings = [];
    
    for (const shift of shiftsToImport) {
        // Check for existing shifts
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', shift.staff_id)
            .eq('date', shift.date)
            .is('deleted_at', null);
        
        if (existingShifts && existingShifts.length > 0) {
            for (const existing of existingShifts) {
                // Check for overlaps
                if (shift.start_time && shift.end_time && existing.start_time && existing.end_time) {
                    const newStart = new Date(`2000-01-01T${shift.start_time}`);
                    const newEnd = new Date(`2000-01-01T${shift.end_time}`);
                    const existStart = new Date(`2000-01-01T${existing.start_time}`);
                    const existEnd = new Date(`2000-01-01T${existing.end_time}`);
                    
                    if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
                    if (existEnd <= existStart) existEnd.setDate(existEnd.getDate() + 1);
                    
                    if (!(newEnd <= existStart || newStart >= existEnd)) {
                        conflicts.push({
                            importShift: shift,
                            existingShift: existing,
                            type: 'overlap',
                            message: `Staff ${shift.staff_name} has overlapping shifts on ${shift.date}`
                        });
                    }
                }
            }
        }
        
        // Check weekly hour limits
        const weekStart = getFortnightStart(new Date(shift.date));
        const weekEnd = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
        
        const { data: weekShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', shift.staff_id)
            .gte('date', weekStart.toISOString().split('T')[0])
            .lt('date', weekEnd.toISOString().split('T')[0])
            .is('deleted_at', null);
        
        let weekHours = 0;
        if (weekShifts) {
            weekShifts.forEach(s => {
                const hours = calculateShiftHours(s);
                weekHours += hours.total;
            });
        }
        
        const shiftHours = calculateShiftHours(shift);
        const staffMember = staff.find(s => s.id === shift.staff_id);
        const limit = staffMember?.weekly_hour_limit || 38;
        
        if (weekHours + shiftHours.total > limit) {
            warnings.push({
                shift: shift,
                type: 'hours',
                message: `Staff ${shift.staff_name} will exceed ${limit}h weekly limit (${weekHours + shiftHours.total}h total)`
            });
        }
    }
    
    return { conflicts, warnings };
}

async function createCareHomeBatchShifts() {
    const careHomeId = document.getElementById('batchCareHomeSelect')?.value;
    const date = document.getElementById('batchShiftDate')?.value;
    const startTime = document.getElementById('batchStartTime')?.value;
    const endTime = document.getElementById('batchEndTime')?.value;
    const selectedStaffId = document.getElementById('batchStaffSelect')?.value;
    const dutyTypeId = document.getElementById('batchDutyType')?.value;
    
    if (!careHomeId || !date || !selectedStaffId || !dutyTypeId) {
        showNotification('Please fill all required fields', 'error');
        return;
    }
    
    const careHome = careHomes.get(careHomeId);
    if (!careHome || !careHome.residents) {
        showNotification('No residents found for this care home', 'error');
        return;
    }
    
    try {
        // Check staff availability first
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', selectedStaffId)
            .eq('date', date)
            .is('deleted_at', null);
        
        if (existingShifts && existingShifts.length > 0) {
            const message = `⚠️ WARNING\n\n` +
                `Staff member already has ${existingShifts.length} shift(s) on ${date}.\n` +
                `Creating ${careHome.residents.length} additional shifts.\n\n` +
                `Continue?`;
            
            if (!confirm(message)) {
                return;
            }
        }
        
        // Calculate duration for each shift
        const selectedDutyType = dutyTypes.find(d => d.id === dutyTypeId);
        let duration = 0;
        
        if (selectedDutyType?.name.toLowerCase().includes('sleepover')) {
            duration = 2;
        } else if (startTime && endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            let end = new Date(`2000-01-01T${endTime}`);
            if (end <= start) end.setDate(end.getDate() + 1);
            duration = (end - start) / (1000 * 60 * 60);
        }
        
        // Create shifts for each resident
        const shiftsToCreate = careHome.residents.map(resident => ({
            date,
            start_time: startTime || null,
            end_time: endTime || null,
            staff_id: selectedStaffId,
            participant_id: resident.id,
            location_id: careHomeId,
            duty_type_id: dutyTypeId,
            status: 'confirmed',
            duration_hours: duration || null,
            notes: `Batch created for ${careHome.name}`,
            created_at: new Date().toISOString(),
            created_by: currentUser?.id || currentStaffData?.id
        }));
        
        // Batch insert
        const { data: createdShifts, error } = await supabaseClient
            .from('shifts')
            .insert(shiftsToCreate)
            .select();
        
        if (error) throw error;
        
        showNotification(`Created ${createdShifts.length} shifts for ${careHome.name}`, 'success');
        
        // Close modal if exists
        const modal = document.getElementById('batchCreateModal');
        if (modal) closeModal('batchCreateModal');
        
        await loadShifts();
        
        if (currentView === 'conflicts') {
            await renderConflicts();
        } else {
            renderCurrentView();
        }
        
    } catch (error) {
        console.error('Error creating batch shifts:', error);
        showNotification('Failed to create batch shifts: ' + error.message, 'error');
    }
}

function addStaffSwitcher() {
    // Check if switcher already exists
    if (document.getElementById('staffSwitcher')) return;
    
    const headerContent = document.querySelector('.header-content');
    if (!headerContent) return;
    
    const switcherHTML = `
        <div id="staffSwitcher" style="display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 14px;">View as:</label>
            <select id="staffSwitcherSelect" style="padding: 5px; border-radius: 4px;">
                <option value="">Current User</option>
            </select>
        </div>
    `;
    
    headerContent.insertAdjacentHTML('beforeend', switcherHTML);
    
    // Populate with staff
    const select = document.getElementById('staffSwitcherSelect');
    if (select && staff && staff.length > 0) {
        staff.forEach(s => {
            const option = document.createElement('option');
            option.value = s.id;
            option.textContent = `${s.first_name} ${s.last_name}`;
            if (s.id === currentStaffData?.id) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Add change handler
        select.addEventListener('change', async (e) => {
            const staffId = e.target.value;
            if (staffId) {
                currentStaffData = staff.find(s => s.id === staffId);
                await loadShifts();
                renderCurrentView();
            }
        });
    }
}

async function createCareHomeShifts() {
    const careHomeId = document.getElementById('batchCareHomeSelect')?.value;
    const date = document.getElementById('batchShiftDate')?.value;
    const startTime = document.getElementById('batchStartTime')?.value;
    const endTime = document.getElementById('batchEndTime')?.value;
    const selectedStaffId = document.getElementById('batchStaffSelect')?.value;
    const dutyTypeId = document.getElementById('batchDutyType')?.value;
    
    if (!careHomeId || !date || !selectedStaffId || !dutyTypeId) {
        showNotification('Please fill all required fields', 'error');
        return;
    }
    
    const careHome = careHomes.get(careHomeId);
    if (!careHome) {
        showNotification('Care home not found', 'error');
        return;
    }
    
    try {
        // Check for conflicts first
        const { data: existingShifts } = await supabaseClient
            .from('shifts')
            .select('*')
            .eq('staff_id', selectedStaffId)
            .eq('date', date)
            .is('deleted_at', null);
        
        if (existingShifts && existingShifts.length > 0) {
            if (!confirm(`Staff member already has ${existingShifts.length} shift(s) on this date. Continue?`)) {
                return;
            }
        }
        
        const shiftsToCreate = careHome.residents.map(resident => ({
            date: shiftDate,
        staff_id: selectedStaffId,
        participant_id: resident.id,
        location_id: careHome.location_id,
        duty_type_id: template.duty_type_id,
        start_time: template.start_time,
        end_time: template.end_time,
        status: 'confirmed',
        // FIX: Add pay_override_id
        pay_override_id: staff.find(s => s.id === selectedStaffId)?.pay_rate_id || null,
        created_by: currentStaffData.id,
        created_at: new Date().toISOString()
    }));
    
        
        // Calculate duration for each shift
        shiftsToCreate.forEach(shift => {
            const dutyType = dutyTypes.find(d => d.id === dutyTypeId);
            if (dutyType?.name.toLowerCase().includes('sleepover')) {
                shift.duration_hours = 2;
            } else if (startTime && endTime) {
                const start = new Date(`2000-01-01T${startTime}`);
                let end = new Date(`2000-01-01T${endTime}`);
                if (end <= start) end.setDate(end.getDate() + 1);
                shift.duration_hours = (end - start) / (1000 * 60 * 60);
            }
        });
        
        // Batch insert
        const { error } = await supabaseClient
            .from('shifts')
            .insert(shiftsToCreate);
        
        if (error) throw error;
        
        showNotification(`Created ${shiftsToCreate.length} shifts for ${careHome.name}`, 'success');
        closeModal('batchCreateModal');
        await loadShifts();
        
        if (currentView === 'conflicts') {
            await renderConflicts();
        } else {
            renderCurrentView();
        }
        
    } catch (error) {
        console.error('Error creating batch shifts:', error);
        showNotification('Failed to create batch shifts: ' + error.message, 'error');
    }
}

function generatePayrollSummary() {
   const startDate = document.getElementById('startDate').value;
   const endDate = document.getElementById('endDate').value;
   
   if (!startDate || !endDate) {
       showNotification('Please set date range for payroll', 'error');
       return;
   }
   
   const staffPayroll = {};
   
   // Group by staff and track hours by pay rate
   filteredShifts.forEach(shift => {
       const staffId = shift.staff_id;
       if (!staffId) return;
       
       if (!staffPayroll[staffId]) {
           staffPayroll[staffId] = {
               staff: shift.staff,
               defaultRateHours: { 
                   total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                   saturday: 0, sunday: 0, publicHoliday: 0
               },
               defaultRateSleepoverCount: 0,
               override1Hours: null,
               override2Hours: null,
               override3Hours: null,
               allHours: {
                   total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                   saturday: 0, sunday: 0, publicHoliday: 0
               },
               totalPay: 0,
               shifts: [],
               totalSleepoverCount: 0,
               overrideRatesMap: new Map()
           };
       }
       
       const entry = staffPayroll[staffId];
       const hours = shift.calculated_hours || {};
       
       entry.shifts.push(shift);
       entry.totalPay += shift.calculated_pay || 0;
       
       // Add to total hours regardless of rate
       entry.allHours.total += hours.total || 0;
       entry.allHours.weekdayDay += hours.weekdayDay || 0;
       entry.allHours.weekdayEvening += hours.weekdayEvening || 0;
       entry.allHours.weekdayNight += hours.weekdayNight || 0;
       entry.allHours.saturday += hours.saturday || 0;
       entry.allHours.sunday += hours.sunday || 0;
       entry.allHours.publicHoliday += hours.publicHoliday || 0;
       
       if (hours.sleepover > 0) {
           entry.totalSleepoverCount++;
       }
       
       // Determine which rate bucket to add hours to
       const hasOverride = shift.pay_override_id && shift.pay_override_id !== '00000000-0000-0000-0000-000000000002';
       
       if (hasOverride) {
           let overrideIndex = entry.overrideRatesMap.get(shift.pay_override_id);
           
           if (overrideIndex === undefined) {
               const overrideRate = payRates.find(pr => pr.id === shift.pay_override_id) || {};
               const overrideLabel = payRateLabels.get(shift.pay_override_id) || `Override Rate`;
               
               if (!entry.override1Hours) {
                   overrideIndex = 1;
                   entry.override1Hours = {
                       rateId: shift.pay_override_id,
                       rate: overrideRate,
                       label: overrideLabel,
                       hours: { total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                               saturday: 0, sunday: 0, publicHoliday: 0 },
                       sleepoverCount: 0
                   };
               } else if (!entry.override2Hours) {
                   overrideIndex = 2;
                   entry.override2Hours = {
                       rateId: shift.pay_override_id,
                       rate: overrideRate,
                       label: overrideLabel,
                       hours: { total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                               saturday: 0, sunday: 0, publicHoliday: 0 },
                       sleepoverCount: 0
                   };
               } else if (!entry.override3Hours) {
                   overrideIndex = 3;
                   entry.override3Hours = {
                       rateId: shift.pay_override_id,
                       rate: overrideRate,
                       label: overrideLabel,
                       hours: { total: 0, weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, 
                               saturday: 0, sunday: 0, publicHoliday: 0 },
                       sleepoverCount: 0
                   };
               }
               entry.overrideRatesMap.set(shift.pay_override_id, overrideIndex);
           }
           
           const overrideBucket = overrideIndex === 1 ? entry.override1Hours : 
                                 overrideIndex === 2 ? entry.override2Hours : 
                                 entry.override3Hours;
           
           if (overrideBucket) {
               overrideBucket.hours.total += hours.total || 0;
               overrideBucket.hours.weekdayDay += hours.weekdayDay || 0;
               overrideBucket.hours.weekdayEvening += hours.weekdayEvening || 0;
               overrideBucket.hours.weekdayNight += hours.weekdayNight || 0;
               overrideBucket.hours.saturday += hours.saturday || 0;
               overrideBucket.hours.sunday += hours.sunday || 0;
               overrideBucket.hours.publicHoliday += hours.publicHoliday || 0;
               
               if (hours.sleepover > 0) {
                   overrideBucket.sleepoverCount++;
               }
           }
       } else {
           entry.defaultRateHours.total += hours.total || 0;
           entry.defaultRateHours.weekdayDay += hours.weekdayDay || 0;
           entry.defaultRateHours.weekdayEvening += hours.weekdayEvening || 0;
           entry.defaultRateHours.weekdayNight += hours.weekdayNight || 0;
           entry.defaultRateHours.saturday += hours.saturday || 0;
           entry.defaultRateHours.sunday += hours.sunday || 0;
           entry.defaultRateHours.publicHoliday += hours.publicHoliday || 0;
           
           if (hours.sleepover > 0) {
               entry.defaultRateSleepoverCount++;
           }
       }
   });
   
   // Generate export data
   const payrollData = Object.values(staffPayroll).map(entry => {
       const staff = entry.staff || { first_name: 'Unknown', middle_name: '', last_name: 'Staff', staff_code: '', limits: 76, payg_withholding: 0 };
       const hourLimit = parseFloat(staff.limits) || 76;
       
       // Calculate total for limit check
       const totalForLimit = entry.allHours.total;
       const overLimit = totalForLimit > hourLimit;
       const hoursToDeduct = overLimit ? totalForLimit - hourLimit : 0;
       
       // Get default pay rate
       let defaultPayRate = payRates.find(pr => pr.id === staff.pay_rate_id) || {};
       const defaultPayRateLabel = payRateLabels.get(staff.pay_rate_id) || 'Standard Rate';
       
       // Build name with middle name
       const fullName = staff.middle_name ? 
           `${staff.first_name} ${staff.middle_name} ${staff.last_name}` :
           `${staff.first_name} ${staff.last_name}`;
       
       // Start building the row
       const row = {
           // === STAFF INFO ===
           'Name': fullName,
           'PAYG': staff.payg_withholding ? 'YES' : 'NO',           
           'Code': staff.staff_code || '',
           'Limit': hourLimit.toFixed(0),
           'Total Hrs': formatHours(entry.allHours.total),
           'Sleepovers': entry.totalSleepoverCount,
           'For Limit': formatHours(totalForLimit),
           'Over': overLimit ? 'YES' : 'NO',
           'Deduct': formatHours(hoursToDeduct),
           
           // === DEFAULT PAY RATE INFO ===
           'Rate': defaultPayRateLabel,
           'Weekday $': `$${(defaultPayRate.hourly_pay_rate || 0).toFixed(2)}`,
           'Evening $': `$${(defaultPayRate.afternoon || 0).toFixed(2)}`,
           'Night $': `$${(defaultPayRate.night || 0).toFixed(2)}`,
           'Saturday $': `$${(defaultPayRate.saturday || 0).toFixed(2)}`,
           'Sunday $': `$${(defaultPayRate.sunday || 0).toFixed(2)}`,
           'Holiday $': `$${(defaultPayRate.public_holiday || 0).toFixed(2)}`,
           'Sleepover $': `$${(defaultPayRate.sleepover || 0).toFixed(2)}`,
           
           // === DEFAULT RATE HOURS ===
           'Weekday': formatHours(entry.defaultRateHours.weekdayDay),
           'Evening': formatHours(entry.defaultRateHours.weekdayEvening),
           'Night': formatHours(entry.defaultRateHours.weekdayNight),
           'Saturday': formatHours(entry.defaultRateHours.saturday),
           'Sunday': formatHours(entry.defaultRateHours.sunday),
           'Holiday': formatHours(entry.defaultRateHours.publicHoliday),
           'Sleepover #': entry.defaultRateSleepoverCount
       };
       
       // === OVERRIDE RATE 1 ===
       if (entry.override1Hours) {
           const o1 = entry.override1Hours;
           row['Alt1 Rate'] = o1.label;
           row['Alt1 Weekday $'] = `$${(o1.rate.hourly_pay_rate || 0).toFixed(2)}`;
           row['Alt1 Evening $'] = `$${(o1.rate.afternoon || 0).toFixed(2)}`;
           row['Alt1 Night $'] = `$${(o1.rate.night || 0).toFixed(2)}`;
           row['Alt1 Saturday $'] = `$${(o1.rate.saturday || 0).toFixed(2)}`;
           row['Alt1 Sunday $'] = `$${(o1.rate.sunday || 0).toFixed(2)}`;
           row['Alt1 Holiday $'] = `$${(o1.rate.public_holiday || 0).toFixed(2)}`;
           row['Alt1 Sleepover $'] = `$${(o1.rate.sleepover || 0).toFixed(2)}`;
           row['Alt1 Weekday'] = formatHours(o1.hours.weekdayDay);
           row['Alt1 Evening'] = formatHours(o1.hours.weekdayEvening);
           row['Alt1 Night'] = formatHours(o1.hours.weekdayNight);
           row['Alt1 Saturday'] = formatHours(o1.hours.saturday);
           row['Alt1 Sunday'] = formatHours(o1.hours.sunday);
           row['Alt1 Holiday'] = formatHours(o1.hours.publicHoliday);
           row['Alt1 Sleepover #'] = o1.sleepoverCount;
       } else {
           row['Alt1 Rate'] = '';
           row['Alt1 Weekday $'] = '';
           row['Alt1 Evening $'] = '';
           row['Alt1 Night $'] = '';
           row['Alt1 Saturday $'] = '';
           row['Alt1 Sunday $'] = '';
           row['Alt1 Holiday $'] = '';
           row['Alt1 Sleepover $'] = '';
           row['Alt1 Weekday'] = '';
           row['Alt1 Evening'] = '';
           row['Alt1 Night'] = '';
           row['Alt1 Saturday'] = '';
           row['Alt1 Sunday'] = '';
           row['Alt1 Holiday'] = '';
           row['Alt1 Sleepover #'] = '';
       }
       
       // === OVERRIDE RATE 2 ===
       if (entry.override2Hours) {
           const o2 = entry.override2Hours;
           row['Alt2 Rate'] = o2.label;
           row['Alt2 Weekday $'] = `$${(o2.rate.hourly_pay_rate || 0).toFixed(2)}`;
           row['Alt2 Evening $'] = `$${(o2.rate.afternoon || 0).toFixed(2)}`;
           row['Alt2 Night $'] = `$${(o2.rate.night || 0).toFixed(2)}`;
           row['Alt2 Saturday $'] = `$${(o2.rate.saturday || 0).toFixed(2)}`;
           row['Alt2 Sunday $'] = `$${(o2.rate.sunday || 0).toFixed(2)}`;
           row['Alt2 Holiday $'] = `$${(o2.rate.public_holiday || 0).toFixed(2)}`;
           row['Alt2 Sleepover $'] = `$${(o2.rate.sleepover || 0).toFixed(2)}`;
           row['Alt2 Weekday'] = formatHours(o2.hours.weekdayDay);
           row['Alt2 Evening'] = formatHours(o2.hours.weekdayEvening);
           row['Alt2 Night'] = formatHours(o2.hours.weekdayNight);
           row['Alt2 Saturday'] = formatHours(o2.hours.saturday);
           row['Alt2 Sunday'] = formatHours(o2.hours.sunday);
           row['Alt2 Holiday'] = formatHours(o2.hours.publicHoliday);
           row['Alt2 Sleepover #'] = o2.sleepoverCount;
       } else {
           row['Alt2 Rate'] = '';
           row['Alt2 Weekday $'] = '';
           row['Alt2 Evening $'] = '';
           row['Alt2 Night $'] = '';
           row['Alt2 Saturday $'] = '';
           row['Alt2 Sunday $'] = '';
           row['Alt2 Holiday $'] = '';
           row['Alt2 Sleepover $'] = '';
           row['Alt2 Weekday'] = '';
           row['Alt2 Evening'] = '';
           row['Alt2 Night'] = '';
           row['Alt2 Saturday'] = '';
           row['Alt2 Sunday'] = '';
           row['Alt2 Holiday'] = '';
           row['Alt2 Sleepover #'] = '';
       }
       
       // === OVERRIDE RATE 3 ===
       if (entry.override3Hours) {
           const o3 = entry.override3Hours;
           row['Alt3 Rate'] = o3.label;
           row['Alt3 Weekday $'] = `$${(o3.rate.hourly_pay_rate || 0).toFixed(2)}`;
           row['Alt3 Evening $'] = `$${(o3.rate.afternoon || 0).toFixed(2)}`;
           row['Alt3 Night $'] = `$${(o3.rate.night || 0).toFixed(2)}`;
           row['Alt3 Saturday $'] = `$${(o3.rate.saturday || 0).toFixed(2)}`;
           row['Alt3 Sunday $'] = `$${(o3.rate.sunday || 0).toFixed(2)}`;
           row['Alt3 Holiday $'] = `$${(o3.rate.public_holiday || 0).toFixed(2)}`;
           row['Alt3 Sleepover $'] = `$${(o3.rate.sleepover || 0).toFixed(2)}`;
           row['Alt3 Weekday'] = formatHours(o3.hours.weekdayDay);
           row['Alt3 Evening'] = formatHours(o3.hours.weekdayEvening);
           row['Alt3 Night'] = formatHours(o3.hours.weekdayNight);
           row['Alt3 Saturday'] = formatHours(o3.hours.saturday);
           row['Alt3 Sunday'] = formatHours(o3.hours.sunday);
           row['Alt3 Holiday'] = formatHours(o3.hours.publicHoliday);
           row['Alt3 Sleepover #'] = o3.sleepoverCount;
       } else {
           row['Alt3 Rate'] = '';
           row['Alt3 Weekday $'] = '';
           row['Alt3 Evening $'] = '';
           row['Alt3 Night $'] = '';
           row['Alt3 Saturday $'] = '';
           row['Alt3 Sunday $'] = '';
           row['Alt3 Holiday $'] = '';
           row['Alt3 Sleepover $'] = '';
           row['Alt3 Weekday'] = '';
           row['Alt3 Evening'] = '';
           row['Alt3 Night'] = '';
           row['Alt3 Saturday'] = '';
           row['Alt3 Sunday'] = '';
           row['Alt3 Holiday'] = '';
           row['Alt3 Sleepover #'] = '';
       }
       
       // === DEDUCTIONS AND ADJUSTED HOURS ===
       const deductions = {
           default: { weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, saturday: 0, sunday: 0, publicHoliday: 0 },
           override1: { weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, saturday: 0, sunday: 0, publicHoliday: 0 },
           override2: { weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, saturday: 0, sunday: 0, publicHoliday: 0 },
           override3: { weekdayDay: 0, weekdayEvening: 0, weekdayNight: 0, saturday: 0, sunday: 0, publicHoliday: 0 }
       };
       
       if (overLimit) {
           const deductionPriority = [];
           
           ['weekdayDay', 'weekdayEvening', 'weekdayNight', 'saturday', 'sunday', 'publicHoliday'].forEach(cat => {
               if (entry.defaultRateHours[cat] > 0) {
                   const rateField = cat === 'weekdayDay' ? 'hourly_pay_rate' :
                                    cat === 'weekdayEvening' ? 'afternoon' :
                                    cat === 'weekdayNight' ? 'night' :
                                    cat === 'publicHoliday' ? 'public_holiday' : cat;
                   deductionPriority.push({
                       source: 'default',
                       category: cat,
                       hours: entry.defaultRateHours[cat],
                       rate: parseFloat(defaultPayRate[rateField]) || 0
                   });
               }
           });
           
           [entry.override1Hours, entry.override2Hours, entry.override3Hours].forEach((override, idx) => {
               if (override) {
                   ['weekdayDay', 'weekdayEvening', 'weekdayNight', 'saturday', 'sunday', 'publicHoliday'].forEach(cat => {
                       if (override.hours[cat] > 0) {
                           const rateField = cat === 'weekdayDay' ? 'hourly_pay_rate' :
                                            cat === 'weekdayEvening' ? 'afternoon' :
                                            cat === 'weekdayNight' ? 'night' :
                                            cat === 'publicHoliday' ? 'public_holiday' : cat;
                           deductionPriority.push({
                               source: `override${idx + 1}`,
                               category: cat,
                               hours: override.hours[cat],
                               rate: parseFloat(override.rate[rateField]) || 0
                           });
                       }
                   });
               }
           });
           
           deductionPriority.sort((a, b) => a.rate - b.rate);
           
           let remainingToDeduct = hoursToDeduct;
           for (const item of deductionPriority) {
               if (remainingToDeduct <= 0) break;
               const toDeduct = Math.min(item.hours, remainingToDeduct);
               deductions[item.source][item.category] = toDeduct;
               remainingToDeduct -= toDeduct;
           }
       }
       
       // === ADJUSTED HOURS COLUMNS ===
       row['Adj Weekday'] = formatHours(entry.defaultRateHours.weekdayDay - deductions.default.weekdayDay);
       row['Adj Evening'] = formatHours(entry.defaultRateHours.weekdayEvening - deductions.default.weekdayEvening);
       row['Adj Night'] = formatHours(entry.defaultRateHours.weekdayNight - deductions.default.weekdayNight);
       row['Adj Saturday'] = formatHours(entry.defaultRateHours.saturday - deductions.default.saturday);
       row['Adj Sunday'] = formatHours(entry.defaultRateHours.sunday - deductions.default.sunday);
       row['Adj Holiday'] = formatHours(entry.defaultRateHours.publicHoliday - deductions.default.publicHoliday);
       
       if (entry.override1Hours) {
           row['Alt1 Adj Weekday'] = formatHours(entry.override1Hours.hours.weekdayDay - deductions.override1.weekdayDay);
           row['Alt1 Adj Evening'] = formatHours(entry.override1Hours.hours.weekdayEvening - deductions.override1.weekdayEvening);
           row['Alt1 Adj Night'] = formatHours(entry.override1Hours.hours.weekdayNight - deductions.override1.weekdayNight);
           row['Alt1 Adj Saturday'] = formatHours(entry.override1Hours.hours.saturday - deductions.override1.saturday);
           row['Alt1 Adj Sunday'] = formatHours(entry.override1Hours.hours.sunday - deductions.override1.sunday);
           row['Alt1 Adj Holiday'] = formatHours(entry.override1Hours.hours.publicHoliday - deductions.override1.publicHoliday);
       } else {
           row['Alt1 Adj Weekday'] = '';
           row['Alt1 Adj Evening'] = '';
           row['Alt1 Adj Night'] = '';
           row['Alt1 Adj Saturday'] = '';
           row['Alt1 Adj Sunday'] = '';
           row['Alt1 Adj Holiday'] = '';
       }
       
       if (entry.override2Hours) {
           row['Alt2 Adj Weekday'] = formatHours(entry.override2Hours.hours.weekdayDay - deductions.override2.weekdayDay);
           row['Alt2 Adj Evening'] = formatHours(entry.override2Hours.hours.weekdayEvening - deductions.override2.weekdayEvening);
           row['Alt2 Adj Night'] = formatHours(entry.override2Hours.hours.weekdayNight - deductions.override2.weekdayNight);
           row['Alt2 Adj Saturday'] = formatHours(entry.override2Hours.hours.saturday - deductions.override2.saturday);
           row['Alt2 Adj Sunday'] = formatHours(entry.override2Hours.hours.sunday - deductions.override2.sunday);
           row['Alt2 Adj Holiday'] = formatHours(entry.override2Hours.hours.publicHoliday - deductions.override2.publicHoliday);
       } else {
           row['Alt2 Adj Weekday'] = '';
           row['Alt2 Adj Evening'] = '';
           row['Alt2 Adj Night'] = '';
           row['Alt2 Adj Saturday'] = '';
           row['Alt2 Adj Sunday'] = '';
           row['Alt2 Adj Holiday'] = '';
       }
       
       if (entry.override3Hours) {
           row['Alt3 Adj Weekday'] = formatHours(entry.override3Hours.hours.weekdayDay - deductions.override3.weekdayDay);
           row['Alt3 Adj Evening'] = formatHours(entry.override3Hours.hours.weekdayEvening - deductions.override3.weekdayEvening);
           row['Alt3 Adj Night'] = formatHours(entry.override3Hours.hours.weekdayNight - deductions.override3.weekdayNight);
           row['Alt3 Adj Saturday'] = formatHours(entry.override3Hours.hours.saturday - deductions.override3.saturday);
           row['Alt3 Adj Sunday'] = formatHours(entry.override3Hours.hours.sunday - deductions.override3.sunday);
           row['Alt3 Adj Holiday'] = formatHours(entry.override3Hours.hours.publicHoliday - deductions.override3.publicHoliday);
       } else {
           row['Alt3 Adj Weekday'] = '';
           row['Alt3 Adj Evening'] = '';
           row['Alt3 Adj Night'] = '';
           row['Alt3 Adj Saturday'] = '';
           row['Alt3 Adj Sunday'] = '';
           row['Alt3 Adj Holiday'] = '';
       }
       
       // === TOTALS ===
       const adjustedTotal = entry.allHours.total - hoursToDeduct;
       
       row['Final Hours'] = formatHours(adjustedTotal);
       row['Gross Pay'] = `$${entry.totalPay.toFixed(2)}`;
       row['Shifts'] = entry.shifts.length;
       row['Period'] = `${startDate} to ${endDate}`;
       
       return row;
   });
   
   downloadCSV(payrollData, `payroll-summary-${startDate}-to-${endDate}.csv`);
}

        function exportData() {
            // Fixed export with proper staff name handling
            const exportData = filteredShifts.map(shift => {
                const staff = shift.staff || { first_name: 'Unknown', last_name: 'Staff' };
                const participant = shift.participant || {};
                const location = shift.location || {};
                const dutyType = shift.duty_type || {};
                const hours = shift.calculated_hours || { total: 0 };
                
                return {
                    Date: formatDate(shift.date),
                    Staff: `${staff.first_name} ${staff.last_name}`,
                    Client: participant.first_name ? `${participant.first_name} ${participant.last_name}` : location.name || 'Unassigned',
                    StartTime: shift.start_time || '',
                    EndTime: shift.end_time || '',
                    DutyType: dutyType.name || '',
                    TotalHours: hours.total.toFixed(2),
                    TotalPay: (shift.calculated_pay || 0).toFixed(2),
                    Status: shift.status || 'pending'
                };
            });

            downloadCSV(exportData, 'shifts-export.csv');
        }

        function exportTimesheet() {
            generatePayrollSummary(); // Use detailed payroll export
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
        }

        function formatDateLong(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            const date = new Date(dateTimeString);
            return date.toLocaleString('en-AU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function downloadCSV(data, filename) {
            if (!data || data.length === 0) {
                showNotification('No data to export', 'error');
                return;
            }

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => 
                    `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                ).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`${filename} downloaded successfully`, 'success');
        }

        function showNotification(message, type = 'info') {
    // If you have a toast/notification system, use it here
    if (typeof showToast === 'function') {
        showToast(message, type);
    } else {
        // Fallback to console or alert
        console.log(`[${type.toUpperCase()}] ${message}`);
        
        // Optional: Create a simple notification
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
            color: white;
            border-radius: 5px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
}


function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    
    // Hide the modal instead of removing it
    if (modal) {
        modal.style.display = 'none';
        
        // Reset form if it exists inside the modal
        const form = modal.querySelector('form');
        if (form) {
            form.reset();
        }
    }
    
    // Remove backdrops (these can be safely removed since they're created fresh each time)
    const backdrop1 = document.getElementById(modalId.replace('Modal', 'Backdrop'));
    const backdrop2 = document.getElementById('editAssignmentBackdrop');
    const backdrop3 = document.getElementById('addAssignmentBackdrop');
    
    if (backdrop1) backdrop1.remove();
    if (backdrop2) backdrop2.remove();
    if (backdrop3) backdrop3.remove();
    
    // Remove any dynamically created modal backdrops
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.remove();
    });
    
    // For modals that should be removed (like assignment modals that are created dynamically)
    const dynamicModals = ['editAssignmentModal', 'addAssignmentModal'];
    if (dynamicModals.includes(modalId)) {
        if (modal) modal.remove();
    }
}
        function clearAllFilters() {
            document.getElementById('staffFilterInput').value = '';
            document.getElementById('participantFilterInput').value = '';
            document.getElementById('statusFilter').value = '';
            
            staffFilterValue = '';
            participantFilterValue = '';
            
            // Reset to current week
            setCurrentWeek();
            
            showNotification('All filters cleared, showing current week', 'info');
            applyFilters();
        }

        async function loadInitialData() {
    try {
        console.log('=== LOADING REFERENCE DATA ===');
        
        // Load all reference data in parallel
        const [
            { data: staffData, error: staffError },
            { data: participantsData, error: participantsError },
            { data: locationsData, error: locationsError },
            { data: dutyTypesData, error: dutyTypesError },
            { data: payRatesData, error: payRatesError },
            { data: payRateLabelsData, error: payRateLabelsError }
        ] = await Promise.all([
            supabaseClient.from('staff').select('*').eq('is_active', true).is('deleted_at', null).order('first_name'),
            supabaseClient.from('participants').select('*').eq('is_active', true).is('deleted_at', null).order('first_name'),
            supabaseClient.from('locations').select('*').order('name'),
            supabaseClient.from('duty_types').select('*').order('name'),
            supabaseClient.from('pay_rates').select('*').order('category, level, pay_point'),
            supabaseClient.from('pay_rate_labels').select('*')
        ]);

        // Check for errors
        if (staffError) throw staffError;
        if (participantsError) throw participantsError;
        if (locationsError) throw locationsError;
        if (dutyTypesError) throw dutyTypesError;
        if (payRatesError) throw payRatesError;
        if (payRateLabelsError) console.warn('Pay rate labels error:', payRateLabelsError);
        
        // Assign to global variables
        staff = staffData || [];
        participants = participantsData || [];
        locations = locationsData || [];
        dutyTypes = dutyTypesData || [];
        payRates = payRatesData || [];
        
        // ALSO SET ON WINDOW OBJECT FOR MODAL ENHANCEMENTS
        window.staff = staff;
        window.participants = participants;
        window.locations = locations;
        window.dutyTypes = dutyTypes;
        window.payRates = payRates;
        
        // Create pay rate labels map
        payRateLabels = new Map();
        if (payRateLabelsData) {
            payRateLabelsData.forEach(label => {
                payRateLabels.set(label.id, label.label);
            });
        }
        
        // Detect all care homes based on shared addresses
        detectCareHomes();
        
        console.log('Reference data loaded:', {
            staff: staff.length,
            participants: participants.length,
            locations: locations.length,
            dutyTypes: dutyTypes.length,
            payRates: payRates.length,
            payRateLabels: payRateLabels.size,
            careHomes: careHomes.size
        });
        
        // Initialize undo/redo buttons if they exist
        if (typeof UndoRedoManager !== 'undefined') {
            UndoRedoManager.updateButtons();
        }
        
        populateFilterDropdowns();
        populateModalDropdowns();

    } catch (error) {
        console.error('Error loading initial data:', error);
        showNotification('Failed to load reference data: ' + error.message, 'error');
    }
}
        function refreshData() {
            showNotification('Refreshing data...', 'info');
            Promise.all([loadInitialData(), loadShifts()])
                .then(() => {
                    showNotification('Data refreshed successfully', 'success');
                })
                .catch(error => {
                    console.error('Refresh error:', error);
                    showNotification('Failed to refresh data: ' + error.message, 'error');
                });
        }

        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Logout failed', 'error');
            }
        }

        // ========================================
        // DEBUG FUNCTIONS
        // ========================================

        async function debugDataLoading() {
            console.log('=== COMPREHENSIVE DEBUG ANALYSIS ===');
            
            try {
                // Database connectivity tests
                const { count: shiftCount } = await supabaseClient
                    .from('shifts')
                    .select('*', { count: 'exact', head: true });
                    
                const { count: staffCount } = await supabaseClient
                    .from('staff')
                    .select('*', { count: 'exact', head: true });

                // Sample data with detailed info
                const { data: sampleShifts } = await supabaseClient
                    .from('shifts')
                    .select('id, date, start_time, end_time, staff_id, status, duration_hours, deleted_at')
                    .is('deleted_at', null)
                    .limit(5);
                    
                const { data: sampleStaff } = await supabaseClient
                    .from('staff')
                    .select('id, first_name, last_name, limits, is_active')
                    .eq('is_active', true)
                    .limit(3);
                
                console.log('Debug results:', {
                    database: { shiftCount, staffCount },
                    loaded: { 
                        shifts: shifts.length, 
                        filtered: filteredShifts.length,
                        staff: staff.length,
                        participants: participants.length 
                    },
                    samples: { sampleShifts, sampleStaff }
                });
                
                // Calculate sample hours for debugging
                let calculationTest = '';
                if (sampleShifts && sampleShifts.length > 0) {
                    const testShift = sampleShifts[0];
                    calculationTest = `
HOUR CALCULATION TEST:
Shift ID: ${testShift.id}
Date: ${testShift.date}
Start: ${testShift.start_time}
End: ${testShift.end_time}
Duration DB: ${testShift.duration_hours}`;
                }
                
                const filters = {
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    staffFilter: staffFilterValue,
                    participantFilter: participantFilterValue
                };
                
                alert(`DEBUG RESULTS:

DATABASE:
• ${shiftCount || 0} total shifts
• ${staffCount || 0} total staff

LOADED DATA:
• ${shifts.length} shifts in memory
• ${filteredShifts.length} after filters
• ${staff.length} staff loaded
• ${participants.length} participants loaded
• ${publicHolidays.size} public holidays

CURRENT FILTERS:
• Date: ${filters.startDate} to ${filters.endDate}
• Staff: ${filters.staffFilter || 'all'}
• Participant: ${filters.participantFilter || 'all'}

SAMPLE SHIFTS IN DB:
${sampleShifts?.map(s => `• ${s.date} ${s.start_time}-${s.end_time} (${s.duration_hours}h)`).join('\n') || 'No shifts found'}

SAMPLE STAFF:
${sampleStaff?.map(s => `• ${s.first_name} ${s.last_name} (limit: ${s.limits}h)`).join('\n') || 'No staff found'}

${calculationTest}

NEXT STEPS:
1. If no data: Create test shifts
2. If data exists but filtered out: Clear filters
3. Check browser console for detailed logs`);
                
            } catch (error) {
                console.error('Debug error:', error);
                alert('Debug failed: ' + error.message);
            }
        }

        

        // ============================================
// ENHANCED FEATURES - ADD THIS ENTIRE BLOCK
// ============================================

// 1. Initialize Enhanced Features
function initializeEnhancements() {
    initializeDarkMode();
    resetSessionTimer();
    addEnhancedUIElements();
}

// 2. Dark Mode Implementation
function initializeDarkMode() {
    const savedMode = localStorage.getItem('darkMode') || 'light';
    document.body.setAttribute('data-theme', savedMode);
    
    // Add dark mode styles
    if (!document.getElementById('darkModeStyles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'darkModeStyles';
        styleSheet.innerHTML = `
            [data-theme="dark"] {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --bg-light: #3a3a3a;
                --text-primary: #e0e0e0;
                --text-secondary: #b0b0b0;
                --text-muted: #808080;
                --border-color: #404040;
                --border-light: #333333;
            }
            
            [data-theme="dark"] .modal {
                background: var(--bg-secondary);
                color: var(--text-primary);
            }
            
            [data-theme="dark"] .roster-table {
                background: var(--bg-secondary);
            }
            
            [data-theme="dark"] input, 
            [data-theme="dark"] select, 
            [data-theme="dark"] textarea {
                background: var(--bg-light);
                color: var(--text-primary);
                border-color: var(--border-color);
            }
            
            [data-theme="dark"] .card {
                background: var(--bg-secondary);
                border-color: var(--border-color);
            }
        `;
        document.head.appendChild(styleSheet);
    }
}

function toggleDarkMode() {
    const currentMode = document.body.getAttribute('data-theme') || 'light';
    const newMode = currentMode === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newMode);
    localStorage.setItem('darkMode', newMode);
    
    // Update button icon
    const btn = document.getElementById('darkModeBtn');
    if (btn) btn.innerHTML = newMode === 'dark' ? '☀️' : '🌙';
}


async function copyShift(shiftId) {
    const shift = shifts.find(s => s.id === shiftId);
    if (!shift) return;
    
    const newDate = prompt('Enter date for copied shift (YYYY-MM-DD):', shift.date);
    if (!newDate) return;
    
    try {
        const shiftData = {
            date: newDate,
            start_time: shift.start_time,
            end_time: shift.end_time,
            staff_id: shift.staff_id,
            participant_id: shift.participant_id,
            location_id: shift.location_id,
            duty_type_id: shift.duty_type_id,
            pay_override_id: shift.pay_override_id || '00000000-0000-0000-0000-000000000002', // FIXED!
            status: 'pending',
            created_by: currentStaffData?.id || currentUser.id
        };
        
        const { error } = await supabaseClient
            .from('shifts')
            .insert([shiftData]);
        
        if (!error) {
            showNotification('Shift copied successfully', 'success');
            await loadShifts();
        } else {
            throw error;
        }
    } catch (error) {
        showNotification('Failed to copy shift: ' + error.message, 'error');
    }
}

async function duplicateWeek() {
    const confirmDupe = confirm('Duplicate all shifts from current week to next week?');
    if (!confirmDupe) return;
    
    try {
        const weekStart = getFortnightStart(currentWeekStart);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        const weekShifts = shifts.filter(s => 
            s.date >= weekStart.toISOString().split('T')[0] &&
            s.date <= weekEnd.toISOString().split('T')[0]
        );
        
        if (weekShifts.length === 0) {
            showNotification('No shifts to duplicate in current week', 'warning');
            return;
        }
        
        const newShifts = weekShifts.map(shift => {
            const newDate = new Date(shift.date);
            newDate.setDate(newDate.getDate() + 7);
            
            return {
                date: newDate.toISOString().split('T')[0],
                start_time: shift.start_time,
                end_time: shift.end_time,
                staff_id: shift.staff_id,
                participant_id: shift.participant_id,
                location_id: shift.location_id,
                duty_type_id: shift.duty_type_id,
                pay_override_id: shift.pay_override_id || '00000000-0000-0000-0000-000000000002', // FIXED!
                status: 'pending',
                created_by: currentStaffData?.id || currentUser.id
            };
        });
        
        const { error } = await supabaseClient
            .from('shifts')
            .insert(newShifts);
        
        if (!error) {
            showNotification(`${newShifts.length} shifts duplicated to next week`, 'success');
            nextWeek();
        } else {
            throw error;
        }
    } catch (error) {
        showNotification('Failed to duplicate week: ' + error.message, 'error');
    }
}

// 5. Auto-save Indicator
function showSaving() {
    let indicator = document.getElementById('saveIndicator');
    
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'saveIndicator';
        indicator.style.cssText = `
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 8px;
        `;
        document.body.appendChild(indicator);
    }
    
    indicator.innerHTML = '⏳ Saving...';
    indicator.style.display = 'flex';
    
    setTimeout(() => {
        indicator.innerHTML = '✓ Saved';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 2000);
    }, 500);
}


function performGlobalSearch() {
    const query = document.getElementById('globalSearchInput').value.toLowerCase();
    const results = document.getElementById('searchResults');
    
    if (query.length < 2) {
        results.innerHTML = '<p style="color: var(--text-muted);">Type at least 2 characters...</p>';
        return;
    }
    
    let html = '';
    
    // Search staff
    const matchingStaff = staff.filter(s => 
        `${s.first_name} ${s.last_name}`.toLowerCase().includes(query)
    );
    
    if (matchingStaff.length > 0) {
        html += '<h4>Staff</h4>';
        matchingStaff.forEach(s => {
            html += `
                <div style="padding: 8px; cursor: pointer; border-radius: 4px;" 
                     onmouseover="this.style.background='var(--bg-light)'"
                     onmouseout="this.style.background='transparent'"
                     onclick="document.getElementById('staffFilterInput').value='${s.first_name} ${s.last_name}'; 
                              updateStaffFilter(); closeModal('searchModal');">
                    👤 ${s.first_name} ${s.last_name}
                </div>`;
        });
    }
    
    // Search participants
    const matchingParticipants = participants.filter(p => 
        `${p.first_name} ${p.last_name}`.toLowerCase().includes(query)
    );
    
    if (matchingParticipants.length > 0) {
        html += '<h4 style="margin-top: 16px;">Participants</h4>';
        matchingParticipants.forEach(p => {
            html += `
                <div style="padding: 8px; cursor: pointer; border-radius: 4px;"
                     onmouseover="this.style.background='var(--bg-light)'"
                     onmouseout="this.style.background='transparent'"
                     onclick="document.getElementById('participantFilterInput').value='${p.first_name} ${p.last_name}'; 
                              updateParticipantFilter(); closeModal('searchModal');">
                    👥 ${p.first_name} ${p.last_name}
                </div>`;
        });
    }
    
    results.innerHTML = html || '<p style="text-align: center; color: var(--text-muted);">No results found</p>';
}

// 7. Print Function
function printRoster() {
    // Add print styles if not already added
    if (!document.getElementById('printStyles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'printStyles';
        styleSheet.innerHTML = `
            @media print {
                .header, .filters-section, .view-actions, .modal, .view-toggle, .btn { 
                    display: none !important; 
                }
                
                body { 
                    font-size: 10pt; 
                    color: black !important;
                    background: white !important;
                }
                
                .roster-table { 
                    width: 100%; 
                    border-collapse: collapse;
                    background: white !important;
                }
                
                .roster-table th, .roster-table td { 
                    border: 1px solid #000 !important; 
                    padding: 4px !important;
                    font-size: 9pt !important;
                    color: black !important;
                }
                
                @page { 
                    margin: 1cm;
                    size: landscape;
                }
            }
        `;
        document.head.appendChild(styleSheet);
    }
    
    window.print();
}

// 8. Quick Status Change
async function quickStatusChange(shiftId, newStatus) {
    if (!newStatus) return;
    
    try {
        const { error } = await supabaseClient
            .from('shifts')
            .update({ 
                status: newStatus,
                updated_at: new Date().toISOString()
            })
            .eq('id', shiftId);
        
        if (!error) {
            showSaving();
            showNotification(`Status updated to ${newStatus}`, 'success');
            await loadShifts();
        } else {
            throw error;
        }
    } catch (error) {
        showNotification('Failed to update status: ' + error.message, 'error');
    }
}

// 9. Session Management
let sessionTimer;
let warningTimer;
const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
const WARNING_TIME = 5 * 60 * 1000; // 5 minute warning

function resetSessionTimer() {
    clearTimeout(sessionTimer);
    clearTimeout(warningTimer);
    
    warningTimer = setTimeout(() => {
        if (confirm('Your session will expire in 5 minutes. Stay logged in?')) {
            resetSessionTimer();
        }
    }, SESSION_TIMEOUT - WARNING_TIME);
    
    sessionTimer = setTimeout(() => {
        alert('Session expired. Please log in again.');
        window.location.href = 'index.html';
    }, SESSION_TIMEOUT);
}

// Reset timer on activity
document.addEventListener('click', resetSessionTimer);
document.addEventListener('keypress', resetSessionTimer);

// 10. Export Functions
function exportJSON() {
    const dataStr = JSON.stringify(filteredShifts, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `roster_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

async function processCSVImport(csvData) {
    try {
        // Parse CSV data (assuming you have parsing logic)
        const shiftsToImport = parseCSVData(csvData);
        
        // FIX #2: Check conflicts before bulk import
        const conflictReport = {
            overlaps: [],
            sleepovers: [],
            weeklyLimits: [],
            skipped: 0,
            imported: 0
        };
        
        const validShifts = [];
        
        for (const importShift of shiftsToImport) {
            let hasConflict = false;
            
            // Check for existing shifts
            const { data: existingShifts } = await supabaseClient
                .from('shifts')
                .select('*')
                .eq('staff_id', importShift.staff_id)
                .eq('date', importShift.date)
                .is('deleted_at', null);
            
            // Check for sleepover conflicts
            const isImportSleepover = importShift.duty_type?.toLowerCase().includes('sleepover');
            const existingSleepover = (existingShifts || []).find(s => {
                const dt = dutyTypes.find(d => d.id === s.duty_type_id);
                return dt?.name?.toLowerCase().includes('sleepover');
            });
            
            if (isImportSleepover && existingSleepover) {
                conflictReport.sleepovers.push({
                    shift: importShift,
                    reason: 'Staff already has sleepover on this date'
                });
                hasConflict = true;
                continue;
            }
            
            // Check for time overlaps
            if (importShift.start_time && importShift.end_time && !isImportSleepover) {
                const newStart = new Date(`2000-01-01T${importShift.start_time}`);
                let newEnd = new Date(`2000-01-01T${importShift.end_time}`);
                if (newEnd <= newStart) newEnd.setDate(newEnd.getDate() + 1);
                
                for (const existing of (existingShifts || [])) {
                    if (existing.start_time && existing.end_time) {
                        const existingStart = new Date(`2000-01-01T${existing.start_time}`);
                        let existingEnd = new Date(`2000-01-01T${existing.end_time}`);
                        if (existingEnd <= existingStart) existingEnd.setDate(existingEnd.getDate() + 1);
                        
                        if (!(newEnd <= existingStart || newStart >= existingEnd)) {
                            conflictReport.overlaps.push({
                                importShift,
                                existingShift: existing,
                                overlapHours: ((Math.min(newEnd, existingEnd) - Math.max(newStart, existingStart)) / (1000 * 60 * 60)).toFixed(1)
                            });
                            hasConflict = true;
                            break;
                        }
                    }
                }
            }
            
            // Check weekly hours
            const weekStart = new Date(importShift.date);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const { data: weekShifts } = await supabaseClient
                .from('shifts')
                .select('*')
                .eq('staff_id', importShift.staff_id)
                .gte('date', weekStart.toISOString().split('T')[0])
                .lte('date', weekEnd.toISOString().split('T')[0])
                .is('deleted_at', null);
            
            let totalWeekHours = 0;
            (weekShifts || []).forEach(s => {
                totalWeekHours += s.duration_hours || 0;
            });
            
            const staffMember = staff.find(s => s.id === importShift.staff_id);
            const weeklyLimit = staffMember?.weekly_hour_limit || 38;
            const importHours = importShift.duration_hours || 0;
            
            if (totalWeekHours + importHours > weeklyLimit) {
                conflictReport.weeklyLimits.push({
                    shift: importShift,
                    currentHours: totalWeekHours,
                    newTotal: totalWeekHours + importHours,
                    limit: weeklyLimit
                });
            }
            
            if (!hasConflict) {
                validShifts.push(importShift);
            } else {
                conflictReport.skipped++;
            }
        }
        
        // Show conflict report if there are issues
        if (conflictReport.overlaps.length > 0 || 
            conflictReport.sleepovers.length > 0 || 
            conflictReport.weeklyLimits.length > 0) {
            
            let message = 'IMPORT CONFLICTS DETECTED\n\n';
            
            if (conflictReport.overlaps.length > 0) {
                message += `⚠️ ${conflictReport.overlaps.length} overlapping shifts\n`;
            }
            if (conflictReport.sleepovers.length > 0) {
                message += `🛏️ ${conflictReport.sleepovers.length} sleepover conflicts\n`;
            }
            if (conflictReport.weeklyLimits.length > 0) {
                message += `⏰ ${conflictReport.weeklyLimits.length} weekly hour limit warnings\n`;
            }
            
            message += `\n✓ ${validShifts.length} shifts ready to import\n`;
            message += `✗ ${conflictReport.skipped} shifts will be skipped\n\n`;
            message += 'Do you want to proceed with importing valid shifts only?';
            
            if (!confirm(message)) {
                showNotification('Import cancelled', 'info');
                return;
            }
        }
        
        // Import valid shifts
        if (validShifts.length > 0) {
            const { error } = await supabaseClient
                .from('shifts')
                .insert(validShifts);
            
            if (error) throw error;
            
            showNotification(`Successfully imported ${validShifts.length} shifts`, 'success');
            conflictReport.imported = validShifts.length;
        } else {
            showNotification('No valid shifts to import', 'warning');
        }
        
        // Generate detailed report
        generateImportReport(conflictReport);
        
        await loadShifts();
        if (currentView === 'conflicts') {
            await renderConflicts();
        } else {
            renderCurrentView();
        }
        
    } catch (error) {
        console.error('Error processing CSV import:', error);
        showNotification('Failed to import shifts: ' + error.message, 'error');
    }
}

function generateImportReport(report) {
    // Create a detailed CSV report of conflicts
    let csvContent = 'Type,Date,Staff,Details,Status\n';
    
    report.overlaps.forEach(item => {
        const staffName = staff.find(s => s.id === item.importShift.staff_id)?.first_name || 'Unknown';
        csvContent += `Overlap,${item.importShift.date},${staffName},"${item.overlapHours}h overlap",Skipped\n`;
    });
    
    report.sleepovers.forEach(item => {
        const staffName = staff.find(s => s.id === item.shift.staff_id)?.first_name || 'Unknown';
        csvContent += `Sleepover,${item.shift.date},${staffName},"${item.reason}",Skipped\n`;
    });
    
    report.weeklyLimits.forEach(item => {
        const staffName = staff.find(s => s.id === item.shift.staff_id)?.first_name || 'Unknown';
        csvContent += `Hours,Week of ${item.shift.date},${staffName},"${item.newTotal}h exceeds ${item.limit}h limit",Warning\n`;
    });
    
    // Download the report
    downloadCSV(csvContent, `import-report-${new Date().toISOString().split('T')[0]}.csv`);
}

function exportDetailedCSV() {
    let csv = 'Date,Day,Start Time,End Time,Staff Name,Participant,Location,Duty Type,Hours,Status,Pay Rate,Total Pay\n';
    
    filteredShifts.forEach(shift => {
        const row = [
            shift.date,
            new Date(shift.date).toLocaleDateString('en-AU', {weekday: 'short'}),
            shift.start_time || 'N/A',
            shift.end_time || 'N/A',
            `${shift.staff?.first_name || ''} ${shift.staff?.last_name || ''}`,
            shift.participant ? `${shift.participant.first_name} ${shift.participant.last_name}` : '',
            shift.location?.name || '',
            shift.duty_type?.name || '',
            shift.calculated_hours?.total?.toFixed(2) || '0',
            shift.status || 'pending',
            payRateLabels.get(shift.staff?.pay_rate_id) || 'Standard',
            shift.calculated_pay?.toFixed(2) || '0'
        ];
        csv += row.map(cell => `"${cell}"`).join(',') + '\n';
    });
    
    downloadCSV(csv, `roster_detailed_${new Date().toISOString().split('T')[0]}.csv`);
}

// 11. Add UI Enhancement Buttons
function addEnhancedUIElements() {
    // Add buttons to view-actions if they don't exist
    const viewActions = document.querySelector('.view-actions');
    if (viewActions && !document.getElementById('enhancedButtons')) {
        const enhancedButtons = document.createElement('div');
        enhancedButtons.id = 'enhancedButtons';
        enhancedButtons.style.display = 'inline-flex';
        enhancedButtons.style.gap = '8px';
        enhancedButtons.style.marginLeft = '8px';
        enhancedButtons.innerHTML = `
            <span style="border-left: 1px solid var(--border-color); margin: 0 8px; height: 24px;"></span>
            <button class="btn btn-outline btn-sm" id="darkModeBtn" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                ${document.body.getAttribute('data-theme') === 'dark' ? '☀️' : '🌙'}
            </button>
            <button class="btn btn-outline btn-sm" onclick="showGlobalSearch()" title="Search (Ctrl+K)">🔍</button>
            <button class="btn btn-outline btn-sm" onclick="duplicateWeek()" title="Duplicate Week">📋</button>
            <button class="btn btn-outline btn-sm" onclick="printRoster()" title="Print (Ctrl+P)">🖨️</button>
            <button class="btn btn-outline btn-sm" onclick="exportDetailedCSV()" title="Export Detailed CSV">📊</button>
            <button class="btn btn-outline btn-sm" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts">⌨️</button>
        `;
        viewActions.appendChild(enhancedButtons);
    }
}

// 12. Keyboard Shortcuts Help
function showKeyboardShortcuts() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <header class="modal-header">
                <h3 class="modal-title">Keyboard Shortcuts</h3>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </header>
            <div class="modal-content">
                <table style="width: 100%;">
                    <tr><td><kbd>N</kbd></td><td>New Shift</td></tr>
                    <tr><td><kbd>F</kbd></td><td>Focus Search</td></tr>
                    <tr><td><kbd>T</kbd></td><td>Go to Today</td></tr>
                    <tr><td><kbd>←</kbd> <kbd>→</kbd></td><td>Navigate Weeks</td></tr>
                    <tr><td><kbd>1-5</kbd></td><td>Switch Views</td></tr>
                    <tr><td><kbd>Ctrl+K</kbd></td><td>Global Search</td></tr>
                    <tr><td><kbd>Ctrl+Z</kbd></td><td>Undo</td></tr>
                    <tr><td><kbd>Ctrl+Y</kbd></td><td>Redo</td></tr>
                    <tr><td><kbd>Ctrl+P</kbd></td><td>Print</td></tr>
                </table>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function renderConflicts() {
    const conflictsContent = document.getElementById('conflictsContent');
    if (!conflictsContent) {
        // Create the view if it doesn't exist
        const conflictsView = document.getElementById('conflictsView');
        if (conflictsView) {
            // Use the standard structure that matches other tabs
            conflictsView.innerHTML = `
                <div id="conflictsContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Analyzing shifts for conflicts...</span>
                    </div>
                </div>
            `;
            
            // Now set up the header in the same way as other tabs
            // This assumes you have a standard header area for the conflicts tab
            const conflictsHeader = document.querySelector('#conflicts .menu-header') || 
                                   document.querySelector('[data-view="conflicts"] .menu-header');
            if (conflictsHeader && !conflictsHeader.querySelector('.table-actions')) {
                conflictsHeader.innerHTML = `
                    <h2>⚠️ Scheduling Conflicts & Issues</h2>
                    <div class="table-actions">
                        <button class="btn btn-outline btn-sm" onclick="renderConflicts()">
                            <span style="margin-right: 4px;"></span> Refresh
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="autoResolveConflicts()" style="margin-left: 8px;">
                            <span style="margin-right: 4px;">🔧</span> Auto-Resolve
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportConflictsReport()" style="margin-left: 8px;">
                            <span style="margin-right: 4px;">📊</span> Export Report
                        </button>
                    </div>
                `;
            }
            
            // Get the content area again after creating it
            const newConflictsContent = document.getElementById('conflictsContent');
            if (newConflictsContent) {
                await renderConflicts();
            }
            return;
        }
        return;
    }
    
    console.log('Analyzing conflicts in', shifts.length, 'shifts...');
    
    // Analyze all shifts for conflicts
    const conflicts = {
        staffDoubleBooking: [],
        sleepoverViolations: [],
        excessiveHours: [],
        missingTimes: [],
        unconfirmedShifts: [],
        noPayRate: [],
        participantOverlaps: []
    };
    
    // 1. Check for staff double-booking
    const staffShiftsByDate = {};
    shifts.forEach(shift => {
        const key = `${shift.staff_id}_${shift.date}`;
        if (!staffShiftsByDate[key]) {
            staffShiftsByDate[key] = [];
        }
        staffShiftsByDate[key].push(shift);
    });
    
    Object.entries(staffShiftsByDate).forEach(([key, dayShifts]) => {
        if (dayShifts.length > 1) {
            // Check for time overlaps
            for (let i = 0; i < dayShifts.length - 1; i++) {
                for (let j = i + 1; j < dayShifts.length; j++) {
                    const shift1 = dayShifts[i];
                    const shift2 = dayShifts[j];
                    
                    if (shift1.start_time && shift1.end_time && 
                        shift2.start_time && shift2.end_time) {
                        
                        const start1 = new Date(`2000-01-01T${shift1.start_time}`);
                        let end1 = new Date(`2000-01-01T${shift1.end_time}`);
                        const start2 = new Date(`2000-01-01T${shift2.start_time}`);
                        let end2 = new Date(`2000-01-01T${shift2.end_time}`);
                        
                        if (end1 <= start1) end1.setDate(end1.getDate() + 1);
                        if (end2 <= start2) end2.setDate(end2.getDate() + 1);
                        
                        // Check for overlap
                        if (!(end1 <= start2 || start1 >= end2)) {
                            const overlapStart = new Date(Math.max(start1, start2));
                            const overlapEnd = new Date(Math.min(end1, end2));
                            
                            conflicts.staffDoubleBooking.push({
                                staff: shift1.staff,
                                date: shift1.date,
                                shift1: shift1,
                                shift2: shift2,
                                overlapPeriod: {
                                    start: overlapStart.toTimeString().slice(0, 5),
                                    end: overlapEnd.toTimeString().slice(0, 5),
                                    hours: ((overlapEnd - overlapStart) / (1000 * 60 * 60)).toFixed(1)
                                }
                            });
                        }
                    }
                }
            }
            
            // Check for sleepover violations
            const sleepover = dayShifts.find(s => 
                s.duty_type?.name?.toLowerCase().includes('sleepover')
            );
            
            if (sleepover) {
                dayShifts.forEach(shift => {
                    if (shift.id !== sleepover.id && shift.start_time) {
                        const startHour = parseInt(shift.start_time.split(':')[0]);
                        const endHour = shift.end_time ? 
                            parseInt(shift.end_time.split(':')[0]) : 0;
                        
                        if (startHour >= 22 || startHour < 6 || 
                            (endHour > 0 && endHour <= 6)) {
                            conflicts.sleepoverViolations.push({
                                staff: shift.staff,
                                date: shift.date,
                                sleepoverShift: sleepover,
                                conflictingShift: shift,
                                reason: startHour >= 22 ? 
                                    'Late night shift (after 10pm) with sleepover' : 
                                    'Early morning shift (before 6am) with sleepover'
                            });
                        }
                    }
                });
            }
        }
    });
    
    // 2. Check for excessive hours (over limit in week)
    const weekGroups = {};
    shifts.forEach(shift => {
        const weekStart = getFortnightStart(new Date(shift.date));
        const weekKey = `${shift.staff_id}_${weekStart.toISOString().split('T')[0]}`;
        
        if (!weekGroups[weekKey]) {
            weekGroups[weekKey] = {
                staff: shift.staff,
                weekStart: weekStart,
                shifts: [],
                totalHours: 0
            };
        }
        
        weekGroups[weekKey].shifts.push(shift);
        weekGroups[weekKey].totalHours += shift.calculated_hours?.total || 0;
    });
    
    Object.values(weekGroups).forEach(group => {
        const limit = group.staff?.limits || 76;
        if (group.totalHours > limit) {
            conflicts.excessiveHours.push({
                staff: group.staff,
                weekStart: group.weekStart,
                totalHours: group.totalHours,
                limit: limit,
                excess: group.totalHours - limit,
                shiftCount: group.shifts.length
            });
        }
    });
    
    // 3. Check for missing times
    shifts.forEach(shift => {
        const isSleepover = shift.duty_type?.name?.toLowerCase().includes('sleepover');
        
        if (!isSleepover && (!shift.start_time || !shift.end_time)) {
            conflicts.missingTimes.push({
                shift: shift,
                staff: shift.staff,
                participant: shift.participant,
                date: shift.date,
                missing: !shift.start_time && !shift.end_time ? 'both times' :
                        !shift.start_time ? 'start time' : 'end time'
            });
        }
    });
    
    // 4. Check for unconfirmed shifts
    shifts.forEach(shift => {
        if (shift.status === 'pending') {
            conflicts.unconfirmedShifts.push({
                shift: shift,
                staff: shift.staff,
                participant: shift.participant,
                date: shift.date,
                daysOld: Math.floor((new Date() - new Date(shift.created_at)) / (1000 * 60 * 60 * 24))
            });
        }
    });
    
    // 5. Check for missing pay rates
    shifts.forEach(shift => {
        if (!shift.pay_override_id && !shift.staff?.pay_rate_id) {
            conflicts.noPayRate.push({
                shift: shift,
                staff: shift.staff,
                date: shift.date,
                participant: shift.participant
            });
        }
    });
    
    // 6. Check participant overlaps (for info)
    const participantShiftsByDate = {};
    shifts.forEach(shift => {
        if (shift.participant_id) {
            const key = `${shift.participant_id}_${shift.date}`;
            if (!participantShiftsByDate[key]) {
                participantShiftsByDate[key] = [];
            }
            participantShiftsByDate[key].push(shift);
        }
    });
    
    Object.entries(participantShiftsByDate).forEach(([key, dayShifts]) => {
        if (dayShifts.length > 1) {
            // Check for overlapping times
            let maxConcurrent = 0;
            const overlaps = [];
            
            for (let i = 0; i < dayShifts.length; i++) {
                const shift = dayShifts[i];
                if (shift.start_time && shift.end_time) {
                    const concurrent = [];
                    
                    for (let j = 0; j < dayShifts.length; j++) {
                        if (i !== j && dayShifts[j].start_time && dayShifts[j].end_time) {
                            const start1 = new Date(`2000-01-01T${shift.start_time}`);
                            let end1 = new Date(`2000-01-01T${shift.end_time}`);
                            const start2 = new Date(`2000-01-01T${dayShifts[j].start_time}`);
                            let end2 = new Date(`2000-01-01T${dayShifts[j].end_time}`);
                            
                            if (end1 <= start1) end1.setDate(end1.getDate() + 1);
                            if (end2 <= start2) end2.setDate(end2.getDate() + 1);
                            
                            if (!(end1 <= start2 || start1 >= end2)) {
                                concurrent.push(dayShifts[j]);
                            }
                        }
                    }
                    
                    if (concurrent.length > 0 && concurrent.length + 1 > maxConcurrent) {
                        maxConcurrent = concurrent.length + 1;
                        overlaps.push({
                            participant: shift.participant,
                            date: shift.date,
                            ratio: `${concurrent.length + 1}:1`,
                            mainShift: shift,
                            overlappingShifts: concurrent
                        });
                    }
                }
            }
            
            if (maxConcurrent > 2) {
                // Only flag if more than 2:1 ratio
                conflicts.participantOverlaps.push(overlaps[0]);
            }
        }
    });
    
    // Build the HTML display
    let html = `
        <style>
            .conflicts-summary {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }
            
            .conflict-stat {
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 16px;
                text-align: center;
            }
            
            .conflict-stat.error {
                border-color: var(--danger-color);
                background: var(--danger-color)10;
            }
            
            .conflict-stat.warning {
                border-color: var(--warning-color);
                background: var(--warning-color)10;
            }
            
            .conflict-stat.info {
                border-color: var(--info-color);
                background: var(--info-color)10;
            }
            
            .conflict-stat h3 {
                margin: 0 0 8px 0;
                font-size: 24px;
                font-weight: bold;
            }
            
            .conflict-stat p {
                margin: 0;
                font-size: 14px;
                color: var(--text-secondary);
            }
            
            .conflict-section {
                margin-bottom: 32px;
            }
            
            .conflict-section h3 {
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .conflict-item {
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .conflict-details {
                flex: 1;
            }
            
            .conflict-actions {
                display: flex;
                gap: 8px;
            }
            
            .overlap-visual {
                display: inline-block;
                background: var(--danger-color)20;
                color: var(--danger-color);
                padding: 4px 8px;
                border-radius: 4px;
                font-family: monospace;
                font-size: 12px;
                margin-left: 8px;
            }
        </style>
        
        <div class="conflicts-summary">
            <div class="conflict-stat ${conflicts.staffDoubleBooking.length > 0 ? 'error' : ''}">
                <h3>${conflicts.staffDoubleBooking.length}</h3>
                <p>Staff Double-Bookings</p>
            </div>
            <div class="conflict-stat ${conflicts.sleepoverViolations.length > 0 ? 'error' : ''}">
                <h3>${conflicts.sleepoverViolations.length}</h3>
                <p>Sleepover Violations</p>
            </div>
            <div class="conflict-stat ${conflicts.excessiveHours.length > 0 ? 'warning' : ''}">
                <h3>${conflicts.excessiveHours.length}</h3>
                <p>Excessive Hours</p>
            </div>
            <div class="conflict-stat ${conflicts.missingTimes.length > 0 ? 'warning' : ''}">
                <h3>${conflicts.missingTimes.length}</h3>
                <p>Missing Times</p>
            </div>
            <div class="conflict-stat ${conflicts.unconfirmedShifts.length > 0 ? 'info' : ''}">
                <h3>${conflicts.unconfirmedShifts.length}</h3>
                <p>Unconfirmed Shifts</p>
            </div>
            <div class="conflict-stat ${conflicts.noPayRate.length > 0 ? 'warning' : ''}">
                <h3>${conflicts.noPayRate.length}</h3>
                <p>No Pay Rate</p>
            </div>
        </div>
    `;
    
    // Staff Double-Booking Section
    if (conflicts.staffDoubleBooking.length > 0) {
        html += `
            <div class="conflict-section">
                <h3>
                    <span style="color: var(--danger-color);">🚫</span> 
                    Staff Double-Bookings (${conflicts.staffDoubleBooking.length})
                </h3>
        `;
        
        conflicts.staffDoubleBooking.forEach(conflict => {
            const staff = conflict.staff || {};
            const part1 = conflict.shift1.participant || {};
            const part2 = conflict.shift2.participant || {};
            
            html += `
                <div class="conflict-item">
                    <div class="conflict-details">
                        <strong>${staff.first_name} ${staff.last_name}</strong> - 
                        ${formatDateFriendly(conflict.date)}
                        <br>
                        <span style="color: var(--text-secondary);">
                            Shift 1: ${formatTime12Hour(conflict.shift1.start_time)} - ${formatTime12Hour(conflict.shift1.end_time)} 
                            (${part1.first_name || 'Unknown'} ${part1.last_name || ''})
                        </span>
                        <br>
                        <span style="color: var(--text-secondary);">
                            Shift 2: ${formatTime12Hour(conflict.shift2.start_time)} - ${formatTime12Hour(conflict.shift2.end_time)} 
                            (${part2.first_name || 'Unknown'} ${part2.last_name || ''})
                        </span>
                        <span class="overlap-visual">
                            Overlap: ${conflict.overlapPeriod.start} - ${conflict.overlapPeriod.end} (${conflict.overlapPeriod.hours}h)
                        </span>
                    </div>
                    <div class="conflict-actions">
                        <button class="btn btn-sm btn-outline" onclick="editShift(${conflict.shift1.id})">
                            Edit Shift 1
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="editShift(${conflict.shift2.id})">
                            Edit Shift 2
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteShift(${conflict.shift2.id})">
                            Delete Shift 2
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // Sleepover Violations Section
    if (conflicts.sleepoverViolations.length > 0) {
        html += `
            <div class="conflict-section">
                <h3>
                    <span style="color: var(--danger-color);">⚠️</span>
                    Sleepover Violations (${conflicts.sleepoverViolations.length})
                </h3>
        `;
        
        conflicts.sleepoverViolations.forEach(conflict => {
            const staff = conflict.staff || {};
            
            html += `
                <div class="conflict-item">
                    <div class="conflict-details">
                        <strong>${staff.first_name} ${staff.last_name}</strong> - 
                        ${formatDateFriendly(conflict.date)}
                        <br>
                        <span style="color: var(--danger-color);">${conflict.reason}</span>
                        <br>
                        <span style="color: var(--text-secondary);">
                            Sleepover + ${formatTime12Hour(conflict.conflictingShift.start_time)} - 
                            ${formatTime12Hour(conflict.conflictingShift.end_time)}
                        </span>
                    </div>
                    <div class="conflict-actions">
                        <button class="btn btn-sm btn-outline" onclick="editShift(${conflict.conflictingShift.id})">
                            Reschedule Shift
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteShift(${conflict.sleepoverShift.id})">
                            Remove Sleepover
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // Excessive Hours Section
    if (conflicts.excessiveHours.length > 0) {
        html += `
            <div class="conflict-section">
                <h3>
                    <span style="color: var(--warning-color);">⏰</span>
                    Excessive Hours (${conflicts.excessiveHours.length})
                </h3>
        `;
        
        conflicts.excessiveHours.forEach(conflict => {
            const staff = conflict.staff || {};
            
            html += `
                <div class="conflict-item">
                    <div class="conflict-details">
                        <strong>${staff.first_name} ${staff.last_name}</strong>
                        <br>
                        Week of ${formatDateFriendly(conflict.weekStart.toISOString().split('T')[0])}
                        <br>
                        <span style="color: var(--warning-color);">
                            ${conflict.totalHours.toFixed(1)}h / ${conflict.limit}h limit 
                            (${conflict.excess.toFixed(1)}h over)
                        </span>
                    </div>
                    <div class="conflict-actions">
                        <button class="btn btn-sm btn-outline" 
                                onclick="viewStaffWeek('${staff.id}', '${conflict.weekStart.toISOString().split('T')[0]}')">
                            View Week
                        </button>
                        <button class="btn btn-sm btn-warning" 
                                onclick="redistributeHours('${staff.id}', '${conflict.weekStart.toISOString().split('T')[0]}')">
                            Redistribute
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // Missing Times Section
    if (conflicts.missingTimes.length > 0) {
        html += `
            <div class="conflict-section">
                <h3>
                    <span style="color: var(--warning-color);">🕐</span>
                    Missing Times (${conflicts.missingTimes.length})
                </h3>
        `;
        
        conflicts.missingTimes.forEach(conflict => {
            const staff = conflict.staff || {};
            const participant = conflict.participant || {};
            
            html += `
                <div class="conflict-item">
                    <div class="conflict-details">
                        <strong>${formatDateFriendly(conflict.date)}</strong> - 
                        ${staff.first_name} ${staff.last_name}
                        <br>
                        <span style="color: var(--text-secondary);">
                            ${participant.first_name || 'Unknown'} ${participant.last_name || ''}
                        </span>
                        <br>
                        <span style="color: var(--warning-color);">Missing: ${conflict.missing}</span>
                    </div>
                    <div class="conflict-actions">
                        <button class="btn btn-sm btn-primary" onclick="editShift(${conflict.shift.id})">
                            Add Times
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    if (Object.values(conflicts).every(arr => arr.length === 0)) {
        html = `
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 16px;">✅</div>
                <h3>No Conflicts Found!</h3>
                <p style="color: var(--text-secondary);">All shifts are properly scheduled with no overlaps or violations.</p>
            </div>
        `;
    }
    
    conflictsContent.innerHTML = html;
}

// Export conflicts report
function exportConflictsReport() {
    // Similar to renderConflicts but generates CSV
    let csv = 'Type,Staff,Date,Details,Action Required\n';
    
    // Add all conflicts to CSV...
    // (implementation similar to above but formatted for CSV)
    
    downloadCSV(csv, `conflicts_report_${new Date().toISOString().split('T')[0]}.csv`);
    showNotification('Conflicts report exported', 'success');
}

// Call initialization when document is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEnhancements);
} else {
    initializeEnhancements();
}

async function switchStaffView(staffId) {
    try {
        // Get the selected staff member
        const { data: selectedStaff, error } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('id', staffId)
            .single();
        
        if (error) throw error;
        
        // Store the original if this is the first switch
        if (!window.originalStaffData) {
            window.originalStaffData = currentStaffData;
        }
        
        // Switch current staff context
        currentStaffData = selectedStaff;
        
        // Update the display
        document.getElementById('userName').textContent = 
            `${selectedStaff.first_name} ${selectedStaff.last_name}`;
        
        // Add indicator that we're in test mode
        if (!document.getElementById('testModeIndicator')) {
            const indicator = document.createElement('div');
            indicator.id = 'testModeIndicator';
            indicator.style.cssText = 'background: #ff9800; color: white; padding: 5px 10px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 10000; font-size: 12px;';
            indicator.innerHTML = `
                ⚠️ TEST MODE - Viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name} 
                <button onclick="resetToOriginalStaff()" style="margin-left: 10px; padding: 2px 8px; background: white; color: #333; border: none; border-radius: 3px; cursor: pointer;">Exit Test Mode</button>
            `;
            document.body.prepend(indicator);
        } else {
            document.getElementById('testModeIndicator').innerHTML = `
                ⚠️ TEST MODE - Viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name}
                <button onclick="resetToOriginalStaff()" style="margin-left: 10px; padding: 2px 8px; background: white; color: #333; border: none; border-radius: 3px; cursor: pointer;">Exit Test Mode</button>
            `;
        }
        
        // Reload all data for this staff member
        await loadShifts();  // This will load shifts for currentStaffData
        
        // Refresh the current view
        renderCurrentView();
        
        showNotification(`Now viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name}`, 'info');
        
    } catch (error) {
        console.error('Error switching staff view:', error);
        showNotification('Failed to switch staff view', 'error');
    }
}

// 2. Reset back to original staff
function resetToOriginalStaff() {
    if (window.originalStaffData) {
        currentStaffData = window.originalStaffData;
        delete window.originalStaffData;
        
        // Update display
        document.getElementById('userName').textContent = 
            `${currentStaffData.first_name} ${currentStaffData.last_name}`;
        
        // Remove test mode indicator
        const indicator = document.getElementById('testModeIndicator');
        if (indicator) indicator.remove();
        
        // Reload data
        loadShifts();
        renderCurrentView();
        
        showNotification('Returned to your normal view', 'success');
    }
}

// 3. Add a dropdown to the header for quick staff switching
function addStaffSwitcher() {
    // Only show for admin/manager roles
    if (currentUserRole !== 'admin' && currentUserRole !== 'manager') return;
    
    const switcherHTML = `
        <div id="staffSwitcher" style="display: inline-block; margin-left: 20px;">
            <select id="staffViewSelect" onchange="if(this.value) switchStaffView(this.value)" style="
                padding: 5px 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background: white;
                cursor: pointer;
            ">
                <option value="">👤 View as Staff...</option>
                ${staff.map(s => `
                    <option value="${s.id}" ${currentStaffData?.id === s.id ? 'selected' : ''}>
                        ${s.first_name} ${s.last_name}
                    </option>
                `).join('')}
            </select>
        </div>
    `;
    
    // Add to header
    const userInfo = document.querySelector('.user-info');
    if (userInfo) {
        userInfo.insertAdjacentHTML('beforeend', switcherHTML);
    }
}

// 4. For team.html - similar but simpler
async function switchStaffViewTeam(staffId) {
    try {
        const { data: selectedStaff, error } = await supabaseClient
            .from('staff')
            .select('*')
            .eq('id', staffId)
            .single();
        
        if (error) throw error;
        
        // Store original
        if (!window.originalStaff) {
            window.originalStaff = currentStaff;
        }
        
        // Switch context
        currentStaff = selectedStaff;
        
        // Update display
        document.getElementById('userName').textContent = 
            `${selectedStaff.first_name} ${selectedStaff.last_name}`;
        
        // Add test mode banner
        if (!document.getElementById('testModeBanner')) {
            const banner = document.createElement('div');
            banner.id = 'testModeBanner';
            banner.style.cssText = 'background: orange; color: white; padding: 8px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 9999;';
            banner.innerHTML = `
                Testing as: ${selectedStaff.first_name} ${selectedStaff.last_name}
                <button onclick="exitTestMode()" style="margin-left: 10px; padding: 2px 8px;">Exit</button>
            `;
            document.body.prepend(banner);
        }
        
        // Reload their data
        await loadDashboard();
        await loadSchedule();
        await loadTransfers();
        
        showToast(`Viewing as: ${selectedStaff.first_name} ${selectedStaff.last_name}`, 'info');
        
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to switch view', 'error');
    }
}


function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
        color: white;
        border-radius: 4px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}



//SHIFTNOTES//

function createShiftNoteModal() {
    const modalHtml = `
        <div id="addShiftNoteModal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <header class="modal-header">
                    <h3 class="modal-title">Add Shift Note</h3>
                    <button class="modal-close" onclick="closeModal('addShiftNoteModal'); window.editingNoteId = null;">&times;</button>
                </header>
                <div class="modal-content">
                    <form id="addShiftNoteForm">
                        <div class="form-group">
                            <label class="form-label">Participant</label>
                            <select class="form-control" id="shiftNoteParticipant" required>
                                <option value="">Select Participant</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Note Type</label>
                            <select class="form-control" id="shiftNoteType" required>
                                <option value="shift_note">Shift Note</option>
                                <option value="behaviour">Behaviour</option>
                                <option value="health_medical">Health/Medical</option>
                            </select>
                        </div>
                        
                        <!-- Rich text toolbar -->
                        <div class="compose-toolbar" style="display: flex; gap: 4px; margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <button type="button" class="format-btn" data-command="bold" title="Bold (Ctrl+B)">
                                <strong>B</strong>
                            </button>
                            <button type="button" class="format-btn" data-command="italic" title="Italic (Ctrl+I)">
                                <em>I</em>
                            </button>
                            <button type="button" class="format-btn" data-command="underline" title="Underline (Ctrl+U)">
                                <u>U</u>
                            </button>
                            <div style="width: 1px; background: #dee2e6; margin: 0 4px;"></div>
                            <button type="button" class="format-btn" data-command="insertUnorderedList" title="Bullet List">
                                • —
                            </button>
                            <button type="button" class="format-btn" data-command="insertOrderedList" title="Numbered List">
                                1. —
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Note Content</label>
                            <div id="shiftNoteContent" 
                                 contenteditable="true"
                                 class="form-control note-editor"
                                 style="min-height: 150px; background: white; padding: 12px; border: 1px solid #ced4da; border-radius: 4px; outline: none;"
                                 placeholder="Type your note here..."></div>
                        </div>
                    </form>
                </div>
                <footer class="modal-footer">
                    <div class="modal-actions">
                        <button class="btn btn-outline" onclick="closeModal('addShiftNoteModal'); window.editingNoteId = null;">Cancel</button>
                        <button class="btn btn-primary" onclick="window.editingNoteId ? updateShiftNote(window.editingNoteId) : saveShiftNote()">Save Shift Note</button>
                    </div>
                </footer>
            </div>
        </div>
        
        <style>
            .format-btn {
                padding: 6px 10px;
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s;
                min-width: 32px;
                font-family: inherit;
            }
            
            .format-btn:hover {
                background: #e9ecef;
            }
            
            .format-btn.active {
                background: #007bff;
                color: white;
                border-color: #007bff;
            }
            
            .note-editor:empty:before {
                content: attr(placeholder);
                color: #6c757d;
                pointer-events: none;
                position: absolute;
            }
            
            .note-editor:focus {
                border-color: #80bdff;
                box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
            }
            
            .note-editor {
                position: relative;
            }
            
            /* Fix for lists padding */
            .note-editor ul, 
            .note-editor ol,
            .note-content ul,
            .note-content ol {
                padding-left: 30px;
                margin: 8px 0;
            }
            
            .note-editor li,
            .note-content li {
                margin: 4px 0;
            }
        </style>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    setTimeout(() => {
        populateParticipantDropdown();
        setupShiftNoteEditor();
    }, 100);
}

function showEditShiftNoteModal(noteData) {
    let modal = document.getElementById('addShiftNoteModal');
    
    if (!modal) {
        createShiftNoteModal();
        modal = document.getElementById('addShiftNoteModal');
    }
    
    setTimeout(() => {
        const modalTitle = modal.querySelector('.modal-title');
        if (modalTitle) {
            modalTitle.textContent = 'Edit Shift Note';
        }
        
        // Populate participant dropdown first
        populateParticipantDropdown();
        
        // Set participant and DISABLE it for editing
        const participantSelect = document.getElementById('shiftNoteParticipant');
        if (participantSelect && noteData.participant_id) {
            participantSelect.value = noteData.participant_id;
            participantSelect.disabled = true;  // Lock the participant selection
            
            // Add visual indication that it's locked
            participantSelect.style.background = '#e9ecef';
            participantSelect.style.cursor = 'not-allowed';
        }
        
        // Map database values to dropdown values
        const noteTypeSelect = document.getElementById('shiftNoteType');
        if (noteTypeSelect && noteData.note_type) {
            const typeMap = {
                'Shift Note': 'shift_note',
                'Behaviour': 'behaviour',
                'Health/Medical': 'health_medical',
                'shift note': 'shift_note',
                'behaviour': 'behaviour',
                'health/medical': 'health_medical'
            };
            const mappedType = typeMap[noteData.note_type] || 'shift_note';
            noteTypeSelect.value = mappedType;
        }
        
        const contentDiv = document.getElementById('shiftNoteContent');
        if (contentDiv && noteData.note) {
            contentDiv.innerHTML = noteData.note;
        }
        
        const saveBtn = modal.querySelector('.btn-primary');
        if (saveBtn) {
            saveBtn.onclick = function() {
                updateShiftNote(window.editingNoteId);
            };
            saveBtn.textContent = 'Update Shift Note';
        }
        
        setupShiftNoteEditor();
        modal.style.display = 'flex';
    }, 100);
}

//DOCUMENT MANAGER
// Enhanced Document Management Module for mc-manager.html
const EnhancedDocumentManager = {
    currentTab: 'types',
    currentPreviewDoc: null,
    staffList: [],
    documentTypes: [],
    allDocuments: [],
    filters: {
        staff: '',
        documentType: '',
        status: 'all',
        expiryDays: 30,
        startDate: '',
        endDate: ''
    },

    async init() {
        await this.loadStaffList();
        await this.loadDocumentTypes();
        this.renderInterface();
        this.attachEventListeners();
        this.syncWithGlobalFilters();
    },

    // Sync with existing global filters
    syncWithGlobalFilters() {
        // Use the existing staffFilterValue from global scope
        if (typeof staffFilterValue !== 'undefined' && staffFilterValue) {
            this.filters.staff = staffFilterValue;
        }
        
        // Listen for changes to global filters
        const originalApplyFilters = window.applyFilters;
        window.applyFilters = function() {
            originalApplyFilters();
            if (EnhancedDocumentManager.currentTab === 'staff') {
                EnhancedDocumentManager.loadStaffDocuments();
            }
        };
    },

    renderInterface() {
        const container = document.getElementById('documentsView');
        container.innerHTML = `
            <div class="document-management-container">
                <!-- Header -->
                <div class="section-header">
                    <h2>Document Management</h2>
                    <button class="btn btn-primary" onclick="EnhancedDocumentManager.showAddDocumentModal()">
                        <i class="fas fa-plus"></i> Add Document
                    </button>
                </div>
                
                <!-- Tabs -->
                <div class="doc-tabs">
                    <button class="doc-tab-btn ${this.currentTab === 'types' ? 'active' : ''}" 
                            onclick="EnhancedDocumentManager.switchTab('types')">
                        <i class="fas fa-cog"></i> Document Types
                    </button>
                    <button class="doc-tab-btn ${this.currentTab === 'staff' ? 'active' : ''}" 
                            onclick="EnhancedDocumentManager.switchTab('staff')">
                        <i class="fas fa-user"></i> Staff Documents
                    </button>
                    <button class="doc-tab-btn ${this.currentTab === 'overview' ? 'active' : ''}" 
                            onclick="EnhancedDocumentManager.switchTab('overview')">
                        <i class="fas fa-th"></i> All Staff Overview
                    </button>
                </div>
                
                <!-- Tab Contents -->
                <div id="docTypesTab" class="doc-tab-content ${this.currentTab === 'types' ? 'active' : ''}">
                    <!-- Document Types Management -->
                </div>
                
                <div id="docStaffTab" class="doc-tab-content ${this.currentTab === 'staff' ? 'active' : ''}">
                    <!-- Split view: table + preview -->
                    <div class="split-view-container">
                        <div class="document-list-panel">
                            <div id="documentFilters"></div>
                            <div id="documentsTable"></div>
                        </div>
                        <div class="document-preview-panel">
                            <div id="documentPreview">
                                <div class="preview-placeholder">
                                    <i class="fas fa-file-alt"></i>
                                    <p>Select a document to preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="docOverviewTab" class="doc-tab-content ${this.currentTab === 'overview' ? 'active' : ''}">
                    <!-- All Staff Matrix View -->
                    <div class="overview-controls">
                        <label>Expiry Warning Days: 
                            <input type="number" id="expiryDaysInput" min="0" max="365" value="30" 
                                   style="width: 80px;" class="form-control"
                                   onchange="EnhancedDocumentManager.updateExpiryThreshold(this.value)">
                            days
                        </label>
                    </div>
                    <div id="staffOverviewTable"></div>
                </div>
            </div>
        `;
        
        // Load initial tab content
        this.loadTabContent(this.currentTab);
    },

    switchTab(tab) {
        this.currentTab = tab;
        
        // Update tab buttons
        document.querySelectorAll('.doc-tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.doc-tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`doc${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).classList.add('active');
        
        this.loadTabContent(tab);
    },

    async loadTabContent(tab) {
        switch(tab) {
            case 'types':
                await this.loadDocumentTypes();
                this.renderDocumentTypes();
                break;
            case 'staff':
                await this.loadStaffDocuments();
                break;
            case 'overview':
                await this.loadAllStaffOverview();
                break;
        }
    },

    // Document Types Management with proper modal
    renderDocumentTypes() {
        const container = document.getElementById('docTypesTab');
        container.innerHTML = `
            <table class="roster-table">
                <thead>
                    <tr>
                        <th style="width: 60px;">Order</th>
                        <th>Name</th>
                        <th>Requires Expiry</th>
                        <th>Requires Issue Date</th>
                        <th>Staff Can Delete</th>
                        <th>Visible to Staff</th>
                        <th>Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${this.documentTypes.map(type => `
                        <tr>
                            <td>
                                <input type="number" value="${type.display_order || 0}" 
                                       style="width: 50px;" class="form-control"
                                       onchange="EnhancedDocumentManager.updateDocType('${type.id}', 'display_order', this.value)">
                            </td>
                            <td>${type.name}</td>
                            <td>
                                <input type="checkbox" ${type.requires_expiry ? 'checked' : ''}
                                       onchange="EnhancedDocumentManager.updateDocType('${type.id}', 'requires_expiry', this.checked)">
                            </td>
                            <td>
                                <input type="checkbox" ${type.requires_issue_date ? 'checked' : ''}
                                       onchange="EnhancedDocumentManager.updateDocType('${type.id}', 'requires_issue_date', this.checked)">
                            </td>
                            <td>
                                <input type="checkbox" ${type.staff_can_delete !== false ? 'checked' : ''}
                                       onchange="EnhancedDocumentManager.updateDocType('${type.id}', 'staff_can_delete', this.checked)">
                            </td>
                            <td>
                                <input type="checkbox" ${type.is_visible_to_staff !== false ? 'checked' : ''}
                                       onchange="EnhancedDocumentManager.updateDocType('${type.id}', 'is_visible_to_staff', this.checked)">
                            </td>
                            <td>
                                <input type="checkbox" ${type.is_active !== false ? 'checked' : ''}
                                       onchange="EnhancedDocumentManager.updateDocType('${type.id}', 'is_active', this.checked)">
                            </td>
                            <td>
                                <button class="btn btn-sm" onclick="EnhancedDocumentManager.editDocType('${type.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="EnhancedDocumentManager.showAddDocTypeModal()">
                    <i class="fas fa-plus"></i> Add Document Type
                </button>
            </div>
        `;
    },

    // Staff Documents with split view
    async loadStaffDocuments() {
        try {
            // Build filters section with searchable dropdowns
            const filtersHtml = `
                <div class="doc-filters">
                    <p class="filter-note">Use the main Staff filter above to filter by staff member</p>
                    
                    <div class="filter-group">
                        <label>Document Type</label>
                        <input type="text" class="searchable-input" id="docTypeFilterInput" 
                               placeholder="Type to search document types..." 
                               list="docTypeFilterList">
                        <datalist id="docTypeFilterList">
                            ${this.documentTypes.filter(t => t.is_active).map(t => `
                                <option value="${t.name}" data-id="${t.id}"></option>
                            `).join('')}
                        </datalist>
                    </div>
                    
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="docStatusFilter" class="form-control">
                            <option value="all">All Status</option>
                            <option value="expired">Expired</option>
                            <option value="expiring">Expiring Soon</option>
                            <option value="unverified">Unverified</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-outline btn-sm" onclick="EnhancedDocumentManager.clearDocFilters()">
                        Clear Filters
                    </button>
                </div>
            `;
            
            document.getElementById('documentFilters').innerHTML = filtersHtml;
            
            // Attach searchable dropdown listeners
            document.getElementById('docTypeFilterInput').addEventListener('change', () => {
                this.applyDocumentFilters();
            });
            
            document.getElementById('docStatusFilter').addEventListener('change', () => {
                this.applyDocumentFilters();
            });
            
            // Load documents
            let query = supabaseClient
                .from('documents')
                .select(`
                    *,
                    document_types!inner(name, requires_expiry)
                `)
                .eq('entity_type', 'staff')
                .is('deleted_at', null);
                
            // Use global staff filter if set
            if (typeof staffFilterValue !== 'undefined' && staffFilterValue) {
                query = query.eq('entity_id', staffFilterValue);
            }
            
            const { data: documents, error } = await query.order('created_at', { ascending: false });
            if (error) throw error;
            
            this.allDocuments = documents || [];
            this.renderDocumentsTable();
            
        } catch (error) {
            console.error('Error loading documents:', error);
            showToast('Failed to load documents', 'error');
        }
    },

    clearDocFilters() {
        document.getElementById('docTypeFilterInput').value = '';
        document.getElementById('docStatusFilter').value = 'all';
        this.applyDocumentFilters();
    },

    applyDocumentFilters() {
        // Get selected document type
        const typeInput = document.getElementById('docTypeFilterInput');
        const selectedType = this.documentTypes.find(t => t.name === typeInput.value);
        this.filters.documentType = selectedType ? selectedType.id : '';
        
        // Get status filter
        this.filters.status = document.getElementById('docStatusFilter').value;
        
        this.renderDocumentsTable();
    },

    renderDocumentsTable() {
        const filtered = this.filterDocuments();
        const container = document.getElementById('documentsTable');
        
        container.innerHTML = `
            <table class="roster-table document-table">
                <thead>
                    <tr>
                        <th>Staff</th>
                        <th>Document Type</th>
                        <th>Title</th>
                        <th>Expiry</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${filtered.map(doc => {
                        const staff = this.staffList.find(s => s.id === doc.entity_id) || {};
                        const staffName = `${staff.first_name || ''} ${staff.last_name || ''}`.trim() || 'Unknown';
                        const status = this.getDocumentStatus(doc);
                        
                        return `
                            <tr class="document-row ${status.class}" 
                                onclick="EnhancedDocumentManager.previewDocument('${doc.id}')"
                                data-doc-id="${doc.id}">
                                <td>${staffName}</td>
                                <td>${doc.document_types?.name || 'Unknown'}</td>
                                <td>${doc.title}</td>
                                <td>${doc.expiry_date ? formatDate(doc.expiry_date) : '-'}</td>
                                <td><span class="status-badge ${status.class}">${status.text}</span></td>
                                <td onclick="event.stopPropagation()">
                                    ${doc.is_verified ? 
                                        `<button class="btn btn-sm btn-warning" onclick="EnhancedDocumentManager.toggleVerify('${doc.id}', false)">
                                            <i class="fas fa-times"></i>
                                        </button>` :
                                        `<button class="btn btn-sm btn-success" onclick="EnhancedDocumentManager.toggleVerify('${doc.id}', true)">
                                            <i class="fas fa-check"></i>
                                        </button>`
                                    }
                                    <button class="btn btn-sm btn-danger" onclick="EnhancedDocumentManager.deleteDoc('${doc.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    },

    previewDocument(docId) {
        const doc = this.allDocuments.find(d => d.id === docId);
        if (!doc) return;
        
        this.currentPreviewDoc = doc;
        const previewContainer = document.getElementById('documentPreview');
        
        // Highlight selected row
        document.querySelectorAll('.document-row').forEach(row => row.classList.remove('selected'));
        document.querySelector(`[data-doc-id="${docId}"]`)?.classList.add('selected');
        
        // Check if it's an image or PDF
        const isImage = /\.(jpg|jpeg|png|gif)$/i.test(doc.file_url);
        const isPDF = /\.pdf$/i.test(doc.file_url);
        
        // Get document type info for field requirements
        const docType = this.documentTypes.find(t => t.id === doc.document_type_id);
        
        previewContainer.innerHTML = `
            <div class="preview-header">
                <h4>${doc.title}</h4>
                <div class="preview-actions">
                    <button class="btn btn-sm" onclick="window.open('${doc.file_url}', '_blank')">
                        <i class="fas fa-external-link-alt"></i> Open
                    </button>
                    ${isImage ? `
                        <button class="btn btn-sm" onclick="EnhancedDocumentManager.editImage('${doc.id}')">
                            <i class="fas fa-crop"></i> Edit Image
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-primary" onclick="EnhancedDocumentManager.toggleEditMode('${doc.id}')">
                        <i class="fas fa-edit"></i> Edit Info
                    </button>
                </div>
            </div>
            <div class="preview-content">
                ${isImage ? 
                    `<img src="${doc.file_url}" alt="${doc.title}" style="max-width: 100%; height: auto;">` :
                    isPDF ?
                    `<embed src="${doc.file_url}" type="application/pdf" width="100%" height="600px">` :
                    `<div class="preview-unsupported">
                        <i class="fas fa-file"></i>
                        <p>Preview not available for this file type</p>
                        <a href="${doc.file_url}" target="_blank" class="btn btn-primary">Download File</a>
                    </div>`
                }
            </div>
            <div class="preview-info" id="previewInfo">
                <div id="viewMode">
                    <p><strong>Type:</strong> ${doc.document_types?.name || 'Unknown'}</p>
                    <p><strong>Title:</strong> ${doc.title}</p>
                    ${doc.issue_date ? `<p><strong>Issue Date:</strong> ${formatDate(doc.issue_date)}</p>` : ''}
                    ${doc.expiry_date ? `<p><strong>Expiry Date:</strong> ${formatDate(doc.expiry_date)}</p>` : ''}
                    ${doc.notes ? `<p><strong>Notes:</strong> ${doc.notes}</p>` : ''}
                    <p><strong>Uploaded:</strong> ${formatDate(doc.created_at)}</p>
                    ${doc.is_verified ? 
                        `<p class="text-success"><i class="fas fa-check-circle"></i> Verified on ${formatDate(doc.verified_at)}</p>` :
                        `<p class="text-warning"><i class="fas fa-exclamation-circle"></i> Not Verified</p>`
                    }
                </div>
                <div id="editMode" style="display: none;">
                    <form id="editDocForm">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="form-control" id="editDocTitle" value="${doc.title}">
                        </div>
                        ${docType?.requires_issue_date || doc.issue_date ? `
                        <div class="form-group">
                            <label>Issue Date ${docType?.requires_issue_date ? '*' : ''}</label>
                            <input type="date" class="form-control" id="editIssueDate" 
                                   value="${doc.issue_date || ''}" ${docType?.requires_issue_date ? 'required' : ''}>
                        </div>
                        ` : ''}
                        ${docType?.requires_expiry || doc.expiry_date ? `
                        <div class="form-group">
                            <label>Expiry Date ${docType?.requires_expiry ? '*' : ''}</label>
                            <input type="date" class="form-control" id="editExpiryDate" 
                                   value="${doc.expiry_date || ''}" ${docType?.requires_expiry ? 'required' : ''}>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea class="form-control" id="editDocNotes" rows="3">${doc.notes || ''}</textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-primary" onclick="EnhancedDocumentManager.saveDocumentEdit('${doc.id}')">
                                Save Changes
                            </button>
                            <button type="button" class="btn btn-outline" onclick="EnhancedDocumentManager.cancelEdit()">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    },

    toggleEditMode(docId) {
        document.getElementById('viewMode').style.display = 'none';
        document.getElementById('editMode').style.display = 'block';
    },

    cancelEdit() {
        document.getElementById('viewMode').style.display = 'block';
        document.getElementById('editMode').style.display = 'none';
    },

    async saveDocumentEdit(docId) {
        try {
            const updates = {
                title: document.getElementById('editDocTitle').value,
                notes: document.getElementById('editDocNotes').value || null
            };
            
            const issueDateInput = document.getElementById('editIssueDate');
            if (issueDateInput) {
                updates.issue_date = issueDateInput.value || null;
            }
            
            const expiryDateInput = document.getElementById('editExpiryDate');
            if (expiryDateInput) {
                updates.expiry_date = expiryDateInput.value || null;
            }
            
            const { error } = await supabaseClient
                .from('documents')
                .update(updates)
                .eq('id', docId);
                
            if (error) throw error;
            
            showToast('Document updated successfully', 'success');
            
            // Reload documents and refresh preview
            await this.loadStaffDocuments();
            this.previewDocument(docId);
            
        } catch (error) {
            console.error('Error updating document:', error);
            showToast('Failed to update document', 'error');
        }
    },

    // All Staff Overview with color coding
    async loadAllStaffOverview() {
        try {
            const { data: documents } = await supabaseClient
                .from('documents')
                .select('entity_id, document_type_id, expiry_date, is_verified')
                .eq('entity_type', 'staff')
                .is('deleted_at', null);
                
            // Create document map
            const docMap = {};
            documents?.forEach(doc => {
                const key = `${doc.entity_id}_${doc.document_type_id}`;
                docMap[key] = doc;
            });
            
            const container = document.getElementById('staffOverviewTable');
            const activeTypes = this.documentTypes.filter(t => t.is_active);
            
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table class="overview-matrix">
                        <thead>
                            <tr>
                                <th style="position: sticky; left: 0; background: #f8f9fa;">Staff</th>
                                ${activeTypes.map(t => `
                                    <th class="rotate-header">${t.name}</th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${this.staffList.map(staff => {
                                const staffName = `${staff.first_name} ${staff.last_name}`;
                                return `
                                    <tr>
                                        <td style="position: sticky; left: 0; background: white; font-weight: 500;">
                                            <a href="#" onclick="EnhancedDocumentManager.viewStaffDocuments('${staff.id}'); return false;">
                                                ${staffName}
                                            </a>
                                        </td>
                                        ${activeTypes.map(type => {
                                            const key = `${staff.id}_${type.id}`;
                                            const doc = docMap[key];
                                            const cellClass = this.getCellClass(doc);
                                            const cellContent = this.getCellContent(doc);
                                            
                                            return `<td class="matrix-cell ${cellClass}">${cellContent}</td>`;
                                        }).join('')}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="overview-legend">
                    <span><span class="legend-box valid"></span> Valid</span>
                    <span><span class="legend-box expiring"></span> Expiring Soon</span>
                    <span><span class="legend-box expired"></span> Expired</span>
                    <span><span class="legend-box unverified"></span> Unverified</span>
                    <span><span class="legend-box missing"></span> Missing</span>
                </div>
            `;
        } catch (error) {
            console.error('Error loading overview:', error);
        }
    },

    getCellClass(doc) {
        if (!doc) return 'missing';
        if (!doc.is_verified) return 'unverified';
        if (doc.expiry_date) {
            const days = this.daysUntilExpiry(doc.expiry_date);
            if (days < 0) return 'expired';
            if (days <= this.filters.expiryDays) return 'expiring';
        }
        return 'valid';
    },

    getCellContent(doc) {
        if (!doc) return '-';
        if (!doc.is_verified) return '⚠';
        if (doc.expiry_date) {
            const days = this.daysUntilExpiry(doc.expiry_date);
            if (days < 0) return '✗';
            if (days <= this.filters.expiryDays) return days + 'd';
        }
        return '✓';
    },

    daysUntilExpiry(expiryDate) {
        const expiry = new Date(expiryDate);
        const now = new Date();
        return Math.floor((expiry - now) / (1000 * 60 * 60 * 24));
    },

    updateExpiryThreshold(days) {
        this.filters.expiryDays = parseInt(days);
        this.loadAllStaffOverview();
    },

    // Helper methods
    getDocumentStatus(doc) {
        if (!doc.is_verified) return { text: 'Unverified', class: 'status-unverified' };
        if (doc.expiry_date) {
            const days = this.daysUntilExpiry(doc.expiry_date);
            if (days < 0) return { text: 'Expired', class: 'status-expired' };
            if (days <= 30) return { text: `Expires in ${days}d`, class: 'status-expiring' };
        }
        return { text: 'Valid', class: 'status-valid' };
    },

    filterDocuments() {
        return this.allDocuments.filter(doc => {
            // Document type filter
            if (this.filters.documentType && doc.document_type_id !== this.filters.documentType) {
                return false;
            }
            
            // Status filter
            if (this.filters.status !== 'all') {
                const status = this.getDocumentStatus(doc);
                if (this.filters.status === 'expired' && !status.text.includes('Expired')) return false;
                if (this.filters.status === 'expiring' && !status.text.includes('Expires')) return false;
                if (this.filters.status === 'unverified' && status.text !== 'Unverified') return false;
            }
            
            return true;
        });
    },

    applyDocumentFilters() {
        this.filters.staff = document.getElementById('docStaffFilter')?.value || '';
        this.loadStaffDocuments();
    },

    // CRUD operations
    async updateDocType(id, field, value) {
        try {
            const { error } = await supabaseClient
                .from('document_types')
                .update({ [field]: value })
                .eq('id', id);
                
            if (error) throw error;
            showToast('Updated successfully', 'success');
        } catch (error) {
            console.error('Error updating:', error);
            showToast('Failed to update', 'error');
        }
    },

    async toggleVerify(docId, verify) {
        try {
            const updates = verify ? {
                is_verified: true,
                verified_by: currentUser.id,
                verified_at: new Date().toISOString()
            } : {
                is_verified: false,
                verified_by: null,
                verified_at: null
            };
            
            const { error } = await supabaseClient
                .from('documents')
                .update(updates)
                .eq('id', docId);
                
            if (error) throw error;
            
            showToast(verify ? 'Document verified' : 'Verification removed', 'success');
            await this.loadStaffDocuments();
        } catch (error) {
            console.error('Error toggling verification:', error);
            showToast('Failed to update verification', 'error');
        }
    },

    async deleteDoc(docId) {
        if (!confirm('Delete this document permanently?')) return;
        
        try {
            const doc = this.allDocuments.find(d => d.id === docId);
            
            // Delete from storage
            if (doc?.bucket && doc?.object_path) {
                await supabaseClient.storage
                    .from(doc.bucket)
                    .remove([doc.object_path]);
            }
            
            // Delete from database
            const { error } = await supabaseClient
                .from('documents')
                .delete()
                .eq('id', docId);
                
            if (error) throw error;
            
            showToast('Document deleted', 'success');
            await this.loadStaffDocuments();
            
            // Clear preview if it was the deleted document
            if (this.currentPreviewDoc?.id === docId) {
                document.getElementById('documentPreview').innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas fa-file-alt"></i>
                        <p>Select a document to preview</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error deleting:', error);
            showToast('Failed to delete document', 'error');
        }
    },

    // Load initial data
    async loadStaffList() {
        try {
            const { data, error } = await supabaseClient
                .from('staff')
                .select('id, first_name, last_name, email')
                .eq('is_active', true)
                .order('first_name');
                
            if (error) throw error;
            this.staffList = data || [];
        } catch (error) {
            console.error('Error loading staff:', error);
        }
    },

    async loadDocumentTypes() {
        try {
            const { data, error } = await supabaseClient
                .from('document_types')
                .select('*')
                .order('display_order')
                .order('name');
                
            if (error) throw error;
            this.documentTypes = data || [];
        } catch (error) {
            console.error('Error loading document types:', error);
        }
    },

    viewStaffDocuments(staffId) {
    // Update the global staff filter
    const staffMember = this.staffList.find(s => s.id === staffId);
    if (staffMember) {
        // Update the main staff filter input
        const staffFilterInput = document.getElementById('staffFilterInput');
        if (staffFilterInput) {
            staffFilterInput.value = `${staffMember.first_name} ${staffMember.last_name}`;
            // Update the global variable
            window.staffFilterValue = staffId;
        }
    }
    
    // Switch to staff tab
    this.switchTab('staff');
    
    // Apply the global filters which will trigger document loading
    if (typeof window.applyFilters === 'function') {
        window.applyFilters();
    } else {
        // Fallback if applyFilters doesn't exist
        this.loadStaffDocuments();
    }
},

    // Modal functions
    showAddDocumentModal() {
    DocumentUploadModal.show();
},

    showAddDocTypeModal() {
        // Will implement proper modal
        const name = prompt('Document Type Name:');
        if (!name) return;
        
        this.addDocumentType(name);
    },

    async addDocumentType(name) {
        try {
            const { error } = await supabaseClient
                .from('document_types')
                .insert({
                    name,
                    slug: name.toLowerCase().replace(/[^a-z0-9]+/g, '_'),
                    display_order: 999,
                    is_active: true,
                    is_visible_to_staff: true,
                    staff_can_delete: true
                });
                
            if (error) throw error;
            
            showToast('Document type added', 'success');
            await this.loadDocumentTypes();
            this.renderDocumentTypes();
        } catch (error) {
            console.error('Error adding document type:', error);
            showToast('Failed to add document type', 'error');
        }
    },

    // Edit image with perspective correction
    editImage(docId) {
        // Will implement in next part
        showToast('Image editor coming next', 'info');
    },

    // Event listeners
    attachEventListeners() {
        // Add any additional event listeners here
    }
};


// Export for use
window.EnhancedDocumentManager = EnhancedDocumentManager;

//Document Manager End
// COMPLETE DOCUMENT UPLOAD AND PERSPECTIVE CORRECTION - JUST PASTE THIS!
const DocumentUploadModal = {
    currentStaffId: null,
    capturedImage: null,

    show(staffId = null) {
        this.currentStaffId = staffId;
        this.createModal();
        document.getElementById('documentUploadModal').style.display = 'block';
    },

    createModal() {
        if (document.getElementById('documentUploadModal')) return;

        const modalHtml = `
            <div id="documentUploadModal" class="modal-overlay" style="display: none;">
                <div class="modal large">
                    <header class="modal-header">
                        <h3 class="modal-title">Upload Document</h3>
                        <button class="modal-close" onclick="DocumentUploadModal.close()">&times;</button>
                    </header>
                    <div class="modal-content">
                        <div id="uploadStep1" class="upload-step active">
                            <div class="upload-options">
                                <div class="upload-option" onclick="DocumentUploadModal.showFileUpload()">
                                    <i class="fas fa-file-upload"></i>
                                    <h4>Upload File</h4>
                                    <p>Select a file from your device</p>
                                </div>
                                <div class="upload-option" onclick="DocumentUploadModal.showCamera()">
                                    <i class="fas fa-camera"></i>
                                    <h4>Take Photo</h4>
                                    <p>Capture document with camera</p>
                                </div>
                            </div>
                        </div>

                        <div id="uploadStep2File" class="upload-step">
                            <form id="documentUploadForm">
                                <div class="form-group">
                                    <label>Document Type *</label>
                                    <select id="uploadDocType" required onchange="DocumentUploadModal.onTypeChange()">
                                        <option value="">Select type...</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Title *</label>
                                    <input type="text" id="uploadDocTitle" class="form-control" required
                                           placeholder="e.g., Driver's License #123456">
                                </div>

                                ${this.currentStaffId ? '' : `
                                <div class="form-group">
                                    <label>Staff Member *</label>
                                    <select id="uploadStaffId" required>
                                        <option value="">Select staff...</option>
                                    </select>
                                </div>
                                `}

                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group" id="issueDateGroup" style="display: none;">
                                        <label>Issue Date</label>
                                        <input type="date" id="uploadIssueDate" class="form-control">
                                    </div>
                                    
                                    <div class="form-group" id="expiryDateGroup" style="display: none;">
                                        <label>Expiry Date</label>
                                        <input type="date" id="uploadExpiryDate" class="form-control">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>File *</label>
                                    <div class="file-drop-zone" id="fileDropZone">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Drag & drop file here or click to browse</p>
                                        <input type="file" id="uploadFile" accept=".pdf,.jpg,.jpeg,.png" 
                                               onchange="DocumentUploadModal.handleFileSelect(this)">
                                    </div>
                                    <div id="filePreview" style="display: none;">
                                        <img id="filePreviewImg" style="max-width: 200px; max-height: 200px;">
                                        <p id="filePreviewName"></p>
                                        <button type="button" class="btn btn-sm" onclick="DocumentUploadModal.clearFile()">
                                            Remove
                                        </button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea id="uploadNotes" class="form-control" rows="3" 
                                              placeholder="Additional information..."></textarea>
                                </div>
                            </form>
                        </div>

                        <div id="uploadStep2Camera" class="upload-step">
                            <div id="cameraView" style="display: none;">
                                <video id="cameraStream" autoplay style="width: 100%; max-height: 400px;"></video>
                                <canvas id="cameraCanvas" style="display: none;"></canvas>
                                <div class="camera-controls">
                                    <button class="btn btn-primary" onclick="DocumentUploadModal.capturePhoto()">
                                        <i class="fas fa-camera"></i> Capture
                                    </button>
                                    <button class="btn btn-outline" onclick="DocumentUploadModal.switchCamera()">
                                        <i class="fas fa-sync-alt"></i> Switch Camera
                                    </button>
                                </div>
                            </div>

                            <div id="capturedView" style="display: none;">
                                <div style="width: 100%; overflow: auto; text-align: center; background: #f0f0f0; padding: 10px;">
                                    <img id="capturedImage" style="max-width: 100%; max-height: 400px; height: auto; object-fit: contain; display: block; margin: 0 auto;">
                                </div>
                                <div class="capture-controls">
                                    <button class="btn btn-outline" onclick="DocumentUploadModal.retakePhoto()">
                                        <i class="fas fa-redo"></i> Retake
                                    </button>
                                    <button class="btn btn-primary" onclick="PerspectiveCorrector.init(DocumentUploadModal.capturedImage)">
                                        <i class="fas fa-crop"></i> Adjust Perspective
                                    </button>
                                    <button class="btn btn-success" onclick="DocumentUploadModal.acceptPhoto()">
                                        <i class="fas fa-check"></i> Use This Photo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <footer class="modal-footer">
                        <div class="modal-actions">
                            <button class="btn btn-outline" onclick="DocumentUploadModal.close()">Cancel</button>
                            <button class="btn btn-primary" id="uploadSubmitBtn" onclick="DocumentUploadModal.upload()" 
                                    style="display: none;">Upload Document</button>
                        </div>
                    </footer>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        this.attachDragDrop();
        this.loadDocumentTypes();
        if (!this.currentStaffId) {
            this.loadStaffDropdown();
        }
    },

    async loadDocumentTypes() {
        try {
            const { data: types } = await supabaseClient
                .from('document_types')
                .select('*')
                .eq('is_active', true)
                .eq('is_visible_to_staff', true)
                .order('display_order');

            const select = document.getElementById('uploadDocType');
            select.innerHTML = '<option value="">Select type...</option>';
            types?.forEach(type => {
                select.innerHTML += `
                    <option value="${type.id}" 
                            data-requires-expiry="${type.requires_expiry}"
                            data-requires-issue="${type.requires_issue_date}"
                            data-slug="${type.slug}">
                        ${type.name}
                    </option>
                `;
            });
        } catch (error) {
            console.error('Error loading document types:', error);
        }
    },

    async loadStaffDropdown() {
        try {
            const { data: staff } = await supabaseClient
                .from('staff')
                .select('id, first_name, last_name')
                .eq('is_active', true)
                .order('first_name');

            const select = document.getElementById('uploadStaffId');
            if (select) {
                select.innerHTML = '<option value="">Select staff...</option>';
                staff?.forEach(s => {
                    select.innerHTML += `
                        <option value="${s.id}">${s.first_name} ${s.last_name}</option>
                    `;
                });
            }
        } catch (error) {
            console.error('Error loading staff:', error);
        }
    },

    onTypeChange() {
        const select = document.getElementById('uploadDocType');
        const option = select.selectedOptions[0];
        
        if (!option) return;

        const requiresExpiry = option.dataset.requiresExpiry === 'true';
        const requiresIssue = option.dataset.requiresIssue === 'true';

        document.getElementById('issueDateGroup').style.display = requiresIssue ? 'block' : 'none';
        document.getElementById('expiryDateGroup').style.display = requiresExpiry ? 'block' : 'none';
        
        document.getElementById('uploadIssueDate').required = requiresIssue;
        document.getElementById('uploadExpiryDate').required = requiresExpiry;
    },

    showFileUpload() {
        document.getElementById('uploadStep1').classList.remove('active');
        document.getElementById('uploadStep2File').classList.add('active');
        document.getElementById('uploadSubmitBtn').style.display = 'block';
    },

    showCamera() {
        document.getElementById('uploadStep1').classList.remove('active');
        document.getElementById('uploadStep2Camera').classList.add('active');
        this.startCamera();
    },

    async startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            });
            
            const video = document.getElementById('cameraStream');
            video.srcObject = stream;
            document.getElementById('cameraView').style.display = 'block';
        } catch (error) {
            console.error('Error accessing camera:', error);
            showToast('Failed to access camera', 'error');
        }
    },

    capturePhoto() {
        const video = document.getElementById('cameraStream');
        const canvas = document.getElementById('cameraCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        this.capturedImage = canvas.toDataURL('image/jpeg', 0.9);
        
        document.getElementById('capturedImage').src = this.capturedImage;
        document.getElementById('cameraView').style.display = 'none';
        document.getElementById('capturedView').style.display = 'block';
        
        // Stop camera
        const stream = video.srcObject;
        stream.getTracks().forEach(track => track.stop());
    },

    retakePhoto() {
        document.getElementById('capturedView').style.display = 'none';
        document.getElementById('cameraView').style.display = 'block';
        this.startCamera();
    },

    acceptPhoto() {
        document.getElementById('uploadStep2Camera').classList.remove('active');
        document.getElementById('uploadStep2File').classList.add('active');
        document.getElementById('uploadSubmitBtn').style.display = 'block';
        this.setCapturedImageAsFile();
    },

    setCapturedImageAsFile() {
        fetch(this.capturedImage)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], `capture_${Date.now()}.jpg`, { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('uploadFile').files = dataTransfer.files;
                
                document.getElementById('filePreviewImg').src = this.capturedImage;
                document.getElementById('filePreviewName').textContent = file.name;
                document.getElementById('fileDropZone').style.display = 'none';
                document.getElementById('filePreview').style.display = 'block';
            });
    },

    attachDragDrop() {
        const dropZone = document.getElementById('fileDropZone');
        if (!dropZone) return;
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('uploadFile').files = files;
                this.handleFileSelect(document.getElementById('uploadFile'));
            }
        });
        
        dropZone.addEventListener('click', () => {
            document.getElementById('uploadFile').click();
        });
    },

    handleFileSelect(input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 10 * 1024 * 1024) {
            showToast('File size must be less than 10MB', 'error');
            input.value = '';
            return;
        }
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('filePreviewImg').src = e.target.result;
                document.getElementById('filePreviewName').textContent = file.name;
                document.getElementById('fileDropZone').style.display = 'none';
                document.getElementById('filePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('filePreviewImg').style.display = 'none';
            document.getElementById('filePreviewName').textContent = file.name;
            document.getElementById('fileDropZone').style.display = 'none';
            document.getElementById('filePreview').style.display = 'block';
        }
    },

    clearFile() {
        document.getElementById('uploadFile').value = '';
        document.getElementById('fileDropZone').style.display = 'block';
        document.getElementById('filePreview').style.display = 'none';
    },

    async upload() {
        const form = document.getElementById('documentUploadForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const btn = document.getElementById('uploadSubmitBtn');
        btn.disabled = true;
        btn.textContent = 'Uploading...';
        
        try {
            const docTypeId = document.getElementById('uploadDocType').value;
            const typeOption = document.getElementById('uploadDocType').selectedOptions[0];
            const title = document.getElementById('uploadDocTitle').value;
            const staffId = this.currentStaffId || document.getElementById('uploadStaffId').value;
            const issueDate = document.getElementById('uploadIssueDate').value;
            const expiryDate = document.getElementById('uploadExpiryDate').value;
            const notes = document.getElementById('uploadNotes').value;
            const file = document.getElementById('uploadFile').files[0];
            
            if (!file) {
                showToast('Please select a file', 'error');
                return;
            }
            
            const typeSlug = typeOption.dataset.slug;
            const uuid = crypto.randomUUID();
            const ext = file.name.split('.').pop();
            const objectPath = `${staffId}/${typeSlug}/${uuid}.${ext}`;
            
            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('documents')
                .upload(objectPath, file);
                
            if (uploadError) throw uploadError;
            
            const { data: urlData } = supabaseClient.storage
                .from('documents')
                .getPublicUrl(objectPath);
                
            const { error: dbError } = await supabaseClient
                .from('documents')
                .insert({
                    entity_type: 'staff',
                    entity_id: staffId,
                    document_type_id: docTypeId,
                    title,
                    file_url: urlData.publicUrl,
                    bucket: 'documents',
                    object_path: objectPath,
                    issue_date: issueDate || null,
                    expiry_date: expiryDate || null,
                    notes: notes || null
                });
                
            if (dbError) throw dbError;
            
            showToast('Document uploaded successfully', 'success');
            this.close();
            
            if (window.EnhancedDocumentManager) {
                window.EnhancedDocumentManager.loadStaffDocuments();
            }
            
        } catch (error) {
            console.error('Error uploading:', error);
            showToast('Failed to upload document', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Upload Document';
        }
    },

    close() {
        const modal = document.getElementById('documentUploadModal');
        if (modal) {
            const video = document.getElementById('cameraStream');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            modal.remove();
        }
    },

    switchCamera() {
        showToast('Camera switching not implemented yet', 'info');
    }
};

// SIMPLE PERSPECTIVE CORRECTOR - NO EXTERNAL DEPENDENCIES
const PerspectiveCorrector = {
    canvas: null,
    ctx: null,
    image: null,
    corners: {},
    isDragging: false,
    selectedCorner: null,
    
    init(imageSource) {
        this.createModal();
        this.image = new Image();
        this.image.onload = () => this.setupCanvas();
        this.image.src = imageSource;
    },
    
    createModal() {
        const modalHtml = `
            <div id="perspectiveModal" class="modal-overlay" style="display: block; z-index: 10000;">
                <div class="modal large">
                    <header class="modal-header">
                        <h3 class="modal-title">Adjust Document Perspective</h3>
                        <button class="modal-close" onclick="PerspectiveCorrector.close()">&times;</button>
                    </header>
                    <div class="modal-content">
                        <p style="text-align: center; color: #666;">Drag corners to match document edges</p>
                        <div style="text-align: center; background: #f0f0f0; padding: 20px;">
                            <canvas id="perspectiveCanvas" style="border: 2px solid #333; max-width: 100%;"></canvas>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-sm" onclick="PerspectiveCorrector.reset()">Reset</button>
                        </div>
                    </div>
                    <footer class="modal-footer">
                        <button class="btn btn-outline" onclick="PerspectiveCorrector.close()">Cancel</button>
                        <button class="btn btn-success" onclick="PerspectiveCorrector.apply()">Apply</button>
                    </footer>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    },
    
    setupCanvas() {
        this.canvas = document.getElementById('perspectiveCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        // Scale to fit
        const maxWidth = window.innerWidth * 0.8;
        const maxHeight = window.innerHeight * 0.6;
        const scale = Math.min(maxWidth / this.image.width, maxHeight / this.image.height, 1);
        
        this.canvas.width = this.image.width * scale;
        this.canvas.height = this.image.height * scale;
        this.scale = scale;
        
        // Set corners
        const margin = 40;
        this.corners = {
            tl: {x: margin, y: margin},
            tr: {x: this.canvas.width - margin, y: margin},
            br: {x: this.canvas.width - margin, y: this.canvas.height - margin},
            bl: {x: margin, y: this.canvas.height - margin}
        };
        
        this.draw();
        this.attachHandlers();
    },
    
    draw() {
        // Clear and draw image
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.drawImage(this.image, 0, 0, this.canvas.width, this.canvas.height);
        
        // Draw overlay
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Clear selected area
        this.ctx.save();
        this.ctx.globalCompositeOperation = 'destination-out';
        this.ctx.beginPath();
        this.ctx.moveTo(this.corners.tl.x, this.corners.tl.y);
        this.ctx.lineTo(this.corners.tr.x, this.corners.tr.y);
        this.ctx.lineTo(this.corners.br.x, this.corners.br.y);
        this.ctx.lineTo(this.corners.bl.x, this.corners.bl.y);
        this.ctx.closePath();
        this.ctx.fill();
        this.ctx.restore();
        
        // Redraw image in selected area
        this.ctx.save();
        this.ctx.beginPath();
        this.ctx.moveTo(this.corners.tl.x, this.corners.tl.y);
        this.ctx.lineTo(this.corners.tr.x, this.corners.tr.y);
        this.ctx.lineTo(this.corners.br.x, this.corners.br.y);
        this.ctx.lineTo(this.corners.bl.x, this.corners.bl.y);
        this.ctx.closePath();
        this.ctx.clip();
        this.ctx.drawImage(this.image, 0, 0, this.canvas.width, this.canvas.height);
        this.ctx.restore();
        
        // Draw border and corners
        this.ctx.strokeStyle = '#00ff00';
        this.ctx.lineWidth = 2;
        this.ctx.beginPath();
        this.ctx.moveTo(this.corners.tl.x, this.corners.tl.y);
        this.ctx.lineTo(this.corners.tr.x, this.corners.tr.y);
        this.ctx.lineTo(this.corners.br.x, this.corners.br.y);
        this.ctx.lineTo(this.corners.bl.x, this.corners.bl.y);
        this.ctx.closePath();
        this.ctx.stroke();
        
        // Draw corner handles
        Object.values(this.corners).forEach(corner => {
            this.ctx.fillStyle = '#004990';
            this.ctx.beginPath();
            this.ctx.arc(corner.x, corner.y, 10, 0, Math.PI * 2);
            this.ctx.fill();
            this.ctx.strokeStyle = 'white';
            this.ctx.lineWidth = 2;
            this.ctx.stroke();
        });
    },
    
    attachHandlers() {
        this.canvas.addEventListener('mousedown', (e) => this.startDrag(e));
        this.canvas.addEventListener('mousemove', (e) => this.drag(e));
        this.canvas.addEventListener('mouseup', () => this.endDrag());
        this.canvas.addEventListener('touchstart', (e) => this.startDrag(e));
        this.canvas.addEventListener('touchmove', (e) => this.drag(e));
        this.canvas.addEventListener('touchend', () => this.endDrag());
    },
    
    startDrag(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        
        // Find nearest corner
        let minDist = Infinity;
        Object.entries(this.corners).forEach(([key, corner]) => {
            const dist = Math.hypot(corner.x - x, corner.y - y);
            if (dist < 30 && dist < minDist) {
                minDist = dist;
                this.selectedCorner = key;
                this.isDragging = true;
            }
        });
    },
    
    drag(e) {
        if (!this.isDragging) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        
        this.corners[this.selectedCorner] = {
            x: Math.max(0, Math.min(this.canvas.width, x)),
            y: Math.max(0, Math.min(this.canvas.height, y))
        };
        
        this.draw();
    },
    
    endDrag() {
        this.isDragging = false;
        this.selectedCorner = null;
    },
    
    reset() {
        const margin = 40;
        this.corners = {
            tl: {x: margin, y: margin},
            tr: {x: this.canvas.width - margin, y: margin},
            br: {x: this.canvas.width - margin, y: this.canvas.height - margin},
            bl: {x: margin, y: this.canvas.height - margin}
        };
        this.draw();
    },
    
    apply() {
    // Get corners in original coordinates
    const srcCorners = [
        this.corners.tl.x / this.scale, this.corners.tl.y / this.scale,
        this.corners.tr.x / this.scale, this.corners.tr.y / this.scale,
        this.corners.br.x / this.scale, this.corners.br.y / this.scale,
        this.corners.bl.x / this.scale, this.corners.bl.y / this.scale
    ];
    
    // Calculate output dimensions
    const width = Math.round(Math.max(
        Math.hypot(srcCorners[2] - srcCorners[0], srcCorners[3] - srcCorners[1]),
        Math.hypot(srcCorners[6] - srcCorners[4], srcCorners[7] - srcCorners[5])
    ));
    const height = Math.round(Math.max(
        Math.hypot(srcCorners[6] - srcCorners[0], srcCorners[7] - srcCorners[1]),
        Math.hypot(srcCorners[4] - srcCorners[2], srcCorners[5] - srcCorners[3])
    ));
    
    // Create output canvas
    const output = document.createElement('canvas');
    output.width = width;
    output.height = height;
    const ctx = output.getContext('2d');
    
    // Create temp canvas with source image
    const source = document.createElement('canvas');
    source.width = this.image.width;
    source.height = this.image.height;
    const srcCtx = source.getContext('2d');
    srcCtx.drawImage(this.image, 0, 0);
    const srcData = srcCtx.getImageData(0, 0, source.width, source.height);
    
    // Create output image data
    const outData = ctx.createImageData(width, height);
    
    // For each output pixel, find corresponding input pixel
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            // Calculate position in source quadrilateral using bilinear interpolation
            const u = x / (width - 1);
            const v = y / (height - 1);
            
            // Bilinear interpolation of the four corners
            const top_x = srcCorners[0] * (1 - u) + srcCorners[2] * u;
            const top_y = srcCorners[1] * (1 - u) + srcCorners[3] * u;
            const bottom_x = srcCorners[6] * (1 - u) + srcCorners[4] * u;
            const bottom_y = srcCorners[7] * (1 - u) + srcCorners[5] * u;
            
            const src_x = top_x * (1 - v) + bottom_x * v;
            const src_y = top_y * (1 - v) + bottom_y * v;
            
            // Get pixel value with bilinear interpolation
            const x0 = Math.floor(src_x);
            const y0 = Math.floor(src_y);
            const x1 = x0 + 1;
            const y1 = y0 + 1;
            
            if (x0 >= 0 && x1 < source.width && y0 >= 0 && y1 < source.height) {
                const fx = src_x - x0;
                const fy = src_y - y0;
                
                const dstIdx = (y * width + x) * 4;
                
                // Sample the four surrounding pixels
                const idx00 = (y0 * source.width + x0) * 4;
                const idx10 = (y0 * source.width + x1) * 4;
                const idx01 = (y1 * source.width + x0) * 4;
                const idx11 = (y1 * source.width + x1) * 4;
                
                // Bilinear interpolation for each channel
                for (let c = 0; c < 4; c++) {
                    const v00 = srcData.data[idx00 + c];
                    const v10 = srcData.data[idx10 + c];
                    const v01 = srcData.data[idx01 + c];
                    const v11 = srcData.data[idx11 + c];
                    
                    const v0 = v00 * (1 - fx) + v10 * fx;
                    const v1 = v01 * (1 - fx) + v11 * fx;
                    const value = v0 * (1 - fy) + v1 * fy;
                    
                    outData.data[dstIdx + c] = Math.round(value);
                }
            }
        }
    }
    
    // Put the warped image data
    ctx.putImageData(outData, 0, 0);
    
    // Convert to data URL
    DocumentUploadModal.capturedImage = output.toDataURL('image/jpeg', 0.95);
    document.getElementById('capturedImage').src = DocumentUploadModal.capturedImage;
    
    this.close();
    showToast('Perspective correction applied', 'success');
},

getBounds(pts) {
    const minX = Math.min(pts[0].x, pts[1].x, pts[2].x, pts[3].x);
    const minY = Math.min(pts[0].y, pts[1].y, pts[2].y, pts[3].y);
    const maxX = Math.max(pts[0].x, pts[1].x, pts[2].x, pts[3].x);
    const maxY = Math.max(pts[0].y, pts[1].y, pts[2].y, pts[3].y);
    return {minX, minY, width: maxX - minX, height: maxY - minY};
},

getHomographyMatrix(src, dst) {
    // Build the system of equations for homography
    const A = [];
    const b = [];
    
    for (let i = 0; i < 4; i++) {
        const j = i * 2;
        A.push([src[j], src[j+1], 1, 0, 0, 0, -dst[j]*src[j], -dst[j]*src[j+1]]);
        A.push([0, 0, 0, src[j], src[j+1], 1, -dst[j+1]*src[j], -dst[j+1]*src[j+1]]);
        b.push(dst[j]);
        b.push(dst[j+1]);
    }
    
    // Solve using Gaussian elimination
    const h = this.solve(A, b);
    return [...h, 1]; // Add h[8] = 1
},

solve(A, b) {
    const n = A.length;
    const aug = A.map((row, i) => [...row, b[i]]);
    
    // Forward elimination
    for (let i = 0; i < n; i++) {
        // Partial pivoting
        let max = i;
        for (let j = i + 1; j < n; j++) {
            if (Math.abs(aug[j][i]) > Math.abs(aug[max][i])) max = j;
        }
        [aug[i], aug[max]] = [aug[max], aug[i]];
        
        // Eliminate
        for (let j = i + 1; j < n; j++) {
            const ratio = aug[j][i] / aug[i][i];
            for (let k = i; k <= n; k++) {
                aug[j][k] -= ratio * aug[i][k];
            }
        }
    }
    
    // Back substitution
    const x = new Array(n);
    for (let i = n - 1; i >= 0; i--) {
        x[i] = aug[i][n];
        for (let j = i + 1; j < n; j++) {
            x[i] -= aug[i][j] * x[j];
        }
        x[i] /= aug[i][i];
    }
    
    return x;
},
    close() {
        document.getElementById('perspectiveModal')?.remove();
    }
};

// Make them available globally
window.DocumentUploadModal = DocumentUploadModal;
window.PerspectiveCorrector = PerspectiveCorrector;
//end document camera upload

//Document Type Management Modals
const DocumentTypeModals = {
    showAddModal() {
        const modalHtml = `
            <div id="addDocTypeModal" class="modal-overlay" style="display: block;">
                <div class="modal">
                    <header class="modal-header">
                        <h3 class="modal-title">Add Document Type</h3>
                        <button class="modal-close" onclick="DocumentTypeModals.close('addDocTypeModal')">&times;</button>
                    </header>
                    <div class="modal-content">
                        <form id="addDocTypeForm">
                            <div class="form-group">
                                <label>Name *</label>
                                <input type="text" id="newTypeName" class="form-control" required
                                       placeholder="e.g., Driver's License">
                            </div>
                            
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="newTypeDescription" class="form-control" rows="2"
                                          placeholder="Brief description of this document type"></textarea>
                            </div>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="newTypeRequiresExpiry" style="width: auto;">
                                        Requires Expiry Date
                                    </label>
                                    <small class="form-help">Document must have an expiry date</small>
                                </div>
                                
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="newTypeRequiresIssue" style="width: auto;">
                                        Requires Issue Date
                                    </label>
                                    <small class="form-help">Document must have an issue date</small>
                                </div>
                            </div>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="newTypeStaffCanDelete" checked style="width: auto;">
                                        Staff Can Delete
                                    </label>
                                    <small class="form-help">Allow staff to delete their own</small>
                                </div>
                                
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="newTypeVisibleToStaff" checked style="width: auto;">
                                        Visible to Staff
                                    </label>
                                    <small class="form-help">Show in staff upload options</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Display Order</label>
                                <input type="number" id="newTypeOrder" class="form-control" value="999"
                                       min="0" placeholder="Sort order in lists">
                            </div>
                        </form>
                    </div>
                    <footer class="modal-footer">
                        <div class="modal-actions">
                            <button class="btn btn-outline" onclick="DocumentTypeModals.close('addDocTypeModal')">
                                Cancel
                            </button>
                            <button class="btn btn-primary" onclick="DocumentTypeModals.saveNewType()">
                                Add Document Type
                            </button>
                        </div>
                    </footer>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    },

    async saveNewType() {
        const form = document.getElementById('addDocTypeForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        try {
            const name = document.getElementById('newTypeName').value;
            const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
            
            const { error } = await supabaseClient
                .from('document_types')
                .insert({
                    name,
                    slug,
                    description: document.getElementById('newTypeDescription').value || null,
                    requires_expiry: document.getElementById('newTypeRequiresExpiry').checked,
                    requires_issue_date: document.getElementById('newTypeRequiresIssue').checked,
                    staff_can_delete: document.getElementById('newTypeStaffCanDelete').checked,
                    is_visible_to_staff: document.getElementById('newTypeVisibleToStaff').checked,
                    display_order: parseInt(document.getElementById('newTypeOrder').value) || 999,
                    is_active: true
                });
                
            if (error) throw error;
            
            showToast('Document type added successfully', 'success');
            this.close('addDocTypeModal');
            
            // Refresh the list
            if (window.EnhancedDocumentManager) {
                await window.EnhancedDocumentManager.loadDocumentTypes();
                window.EnhancedDocumentManager.renderDocumentTypes();
            }
            
        } catch (error) {
            console.error('Error adding document type:', error);
            if (error.message.includes('duplicate')) {
                showToast('A document type with this name already exists', 'error');
            } else {
                showToast('Failed to add document type', 'error');
            }
        }
    },

    async showEditModal(typeId) {
        const type = window.EnhancedDocumentManager.documentTypes.find(t => t.id === typeId);
        if (!type) return;
        
        const modalHtml = `
            <div id="editDocTypeModal" class="modal-overlay" style="display: block;">
                <div class="modal">
                    <header class="modal-header">
                        <h3 class="modal-title">Edit Document Type</h3>
                        <button class="modal-close" onclick="DocumentTypeModals.close('editDocTypeModal')">&times;</button>
                    </header>
                    <div class="modal-content">
                        <form id="editDocTypeForm">
                            <div class="form-group">
                                <label>Name *</label>
                                <input type="text" id="editTypeName" class="form-control" required
                                       value="${type.name}">
                            </div>
                            
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="editTypeDescription" class="form-control" rows="2">${type.description || ''}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Advanced Settings</label>
                                <div style="margin-top: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="editHasCommencement" ${type.has_commencement ? 'checked' : ''} 
                                               style="width: auto;" onchange="DocumentTypeModals.toggleDurationField()">
                                        Has Commencement Date
                                    </label>
                                    <small class="form-help">For certifications with start dates</small>
                                </div>
                                
                                <div id="durationField" style="margin-top: 10px; ${type.has_commencement ? '' : 'display: none;'}">
                                    <label>Default Duration (months)</label>
                                    <input type="number" id="editDefaultDuration" class="form-control" 
                                           value="${type.default_duration_months || ''}" min="1"
                                           placeholder="Auto-calculate expiry from commencement">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="editAllowMultiple" ${type.allow_multiple_active ? 'checked' : ''}
                                           style="width: auto;">
                                    Allow Multiple Active Documents
                                </label>
                                <small class="form-help">Staff can have multiple valid documents of this type</small>
                            </div>
                        </form>
                    </div>
                    <footer class="modal-footer">
                        <div class="modal-actions">
                            <button class="btn btn-outline" onclick="DocumentTypeModals.close('editDocTypeModal')">
                                Cancel
                            </button>
                            <button class="btn btn-primary" onclick="DocumentTypeModals.saveEditType('${typeId}')">
                                Save Changes
                            </button>
                        </div>
                    </footer>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    },

    toggleDurationField() {
        const checkbox = document.getElementById('editHasCommencement');
        const field = document.getElementById('durationField');
        field.style.display = checkbox.checked ? 'block' : 'none';
    },

    async saveEditType(typeId) {
        try {
            const name = document.getElementById('editTypeName').value;
            const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
            const hasCommencement = document.getElementById('editHasCommencement').checked;
            const duration = document.getElementById('editDefaultDuration').value;
            
            const { error } = await supabaseClient
                .from('document_types')
                .update({
                    name,
                    slug,
                    description: document.getElementById('editTypeDescription').value || null,
                    has_commencement: hasCommencement,
                    default_duration_months: hasCommencement && duration ? parseInt(duration) : null,
                    allow_multiple_active: document.getElementById('editAllowMultiple').checked
                })
                .eq('id', typeId);
                
            if (error) throw error;
            
            showToast('Document type updated successfully', 'success');
            this.close('editDocTypeModal');
            
            // Refresh the list
            if (window.EnhancedDocumentManager) {
                await window.EnhancedDocumentManager.loadDocumentTypes();
                window.EnhancedDocumentManager.renderDocumentTypes();
            }
            
        } catch (error) {
            console.error('Error updating document type:', error);
            showToast('Failed to update document type', 'error');
        }
    },

    close(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.remove();
        }
    }
};

// Update EnhancedDocumentManager to use these modals
EnhancedDocumentManager.showAddDocTypeModal = function() {
    DocumentTypeModals.showAddModal();
};

EnhancedDocumentManager.editDocType = function(typeId) {
    DocumentTypeModals.showEditModal(typeId);
};

// Export
window.DocumentTypeModals = DocumentTypeModals;
window.PerspectiveCorrector = PerspectiveCorrector;

//END Document Type Management Modals



function addShiftNote() {
    // Clear editing flag
    window.editingNoteId = null;
    
    let modal = document.getElementById('addShiftNoteModal');
    
    if (!modal) {
        createShiftNoteModal();
    } else {
        // Reset form for new note
        const modalTitle = modal.querySelector('.modal-title');
        if (modalTitle) {
            modalTitle.textContent = 'Add Shift Note';
        }
        
        // Reset save button text
        const saveBtn = modal.querySelector('.btn-primary');
        if (saveBtn) {
            saveBtn.textContent = 'Save Shift Note';
            saveBtn.onclick = function() {
                saveShiftNote();
            };
        }
        
        // Re-enable and clear participant dropdown
        const participantSelect = document.getElementById('shiftNoteParticipant');
        if (participantSelect) {
            participantSelect.value = '';
            participantSelect.disabled = false;  // Re-enable for new notes
            participantSelect.style.background = '';
            participantSelect.style.cursor = '';
        }
        
        document.getElementById('shiftNoteType').value = 'shift_note';
        document.getElementById('shiftNoteContent').innerHTML = '';
        
        populateParticipantDropdown();
        setupShiftNoteEditor();
    }
    
    document.getElementById('addShiftNoteModal').style.display = 'flex';
}

// Populate participant dropdown
function populateParticipantDropdown() {
    const select = document.getElementById('shiftNoteParticipant');
    if (!select || !participants) return;
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">Select Participant</option>';
    
    // Add participants
    const activeParticipants = participants.filter(p => 
        p.is_active && p.first_name !== 'My Carers'
    ).sort((a, b) => {
        const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
        const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    activeParticipants.forEach(participant => {
        const option = document.createElement('option');
        option.value = participant.id;
        option.textContent = `${participant.first_name} ${participant.last_name}`;
        select.appendChild(option);
    });
}


// Populate participant dropdown
function populateParticipantDropdown() {
    const select = document.getElementById('shiftNoteParticipant');
    if (!select || !participants) return;
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">Select Participant</option>';
    
    // Add participants
    const activeParticipants = participants.filter(p => 
        p.is_active && p.first_name !== 'My Carers'
    ).sort((a, b) => {
        const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
        const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    activeParticipants.forEach(participant => {
        const option = document.createElement('option');
        option.value = participant.id;
        option.textContent = `${participant.first_name} ${participant.last_name}`;
        select.appendChild(option);
    });
}


function setupShiftNoteEditor() {
    const editor = document.getElementById('shiftNoteContent');
    const toolbar = document.querySelector('#addShiftNoteModal .compose-toolbar');
    
    if (!editor || !toolbar) return;
    
    // Handle toolbar button clicks
    toolbar.querySelectorAll('.format-btn').forEach(btn => {
        btn.onclick = function(e) {
            e.preventDefault();
            const command = this.dataset.command;
            document.execCommand(command, false, null);
            editor.focus();
            updateToolbarState();
        };
    });
    
    // Update toolbar state on selection change
    editor.addEventListener('keyup', updateToolbarState);
    editor.addEventListener('mouseup', updateToolbarState);
    editor.addEventListener('focus', updateToolbarState);
    
    // Simple keyboard shortcuts only
    editor.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + B for bold
        if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
            e.preventDefault();
            document.execCommand('bold', false, null);
            updateToolbarState();
        }
        
        // Ctrl/Cmd + I for italic
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
            e.preventDefault();
            document.execCommand('italic', false, null);
            updateToolbarState();
        }
        
        // Ctrl/Cmd + U for underline
        if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
            e.preventDefault();
            document.execCommand('underline', false, null);
            updateToolbarState();
        }
        
        // Ctrl/Cmd + Enter to save
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            saveShiftNote();
        }
        
        // Escape to close modal
        if (e.key === 'Escape') {
            e.preventDefault();
            closeModal('addShiftNoteModal');
        }
    });
    
    // Prevent form submission on Enter
    const form = document.getElementById('addShiftNoteForm');
    if (form) {
        form.onsubmit = function(e) {
            e.preventDefault();
            return false;
        };
    }
    
    // Initial toolbar state
    updateToolbarState();
}

// Update toolbar button states based on current selection
function updateToolbarState() {
    const toolbar = document.querySelector('#addShiftNoteModal .compose-toolbar');
    if (!toolbar) return;
    
    const commands = {
        'bold': 'bold',
        'italic': 'italic',
        'underline': 'underline',
        'insertUnorderedList': 'insertUnorderedList',
        'insertOrderedList': 'insertOrderedList'
    };
    
    Object.entries(commands).forEach(([command, queryCommand]) => {
        const btn = toolbar.querySelector(`[data-command="${command}"]`);
        if (btn) {
            const isActive = document.queryCommandState(queryCommand);
            if (isActive) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }
    });
}

// Modified save function to handle HTML content
async function saveShiftNote() {
    try {
        const participantId = document.getElementById('shiftNoteParticipant').value;
        const noteTypeValue = document.getElementById('shiftNoteType').value;
        const noteContent = document.getElementById('shiftNoteContent');
        
        if (!participantId) {
            showNotification('Please select a participant', 'error');
            return;
        }
        
        if (!noteContent) return;
        
        const htmlContent = noteContent.innerHTML.trim();
        
        if (!htmlContent || htmlContent === '<br>') {
            showNotification('Please enter a note', 'error');
            return;
        }

        // Map dropdown values to database values
        const typeMap = {
            'shift_note': 'Shift Note',
            'behaviour': 'Behaviour', 
            'health_medical': 'Health/Medical'
        };
        
        const noteType = typeMap[noteTypeValue] || 'Shift Note';

        // Insert into shift_notes table with correct label
        const { error } = await supabaseClient
            .from('shift_notes')
            .insert({
                staff_id: currentManagerStaff?.id || currentStaffData?.id,
                participant_id: participantId,
                note_type: noteType,  // Now saves as "Shift Note" instead of "shift_note"
                note: htmlContent,
                shift_id: null,
                created_at: new Date().toISOString()
            });

        if (error) throw error;

        showNotification('Shift note added successfully', 'success');
        closeModal('addShiftNoteModal');
        
        if (currentView === 'notes') {
            await renderNotes(1);
        }

    } catch (error) {
        console.error('Error saving shift note:', error);
        showNotification('Failed to save shift note: ' + error.message, 'error');
    }
}

async function updateShiftNote(noteId) {
    try {
        const participantId = document.getElementById('shiftNoteParticipant').value;
        const noteTypeValue = document.getElementById('shiftNoteType').value;
        const noteContent = document.getElementById('shiftNoteContent');
        
        if (!participantId) {
            showNotification('Please select a participant', 'error');
            return;
        }
        
        const htmlContent = noteContent.innerHTML.trim();
        
        if (!htmlContent || htmlContent === '<br>') {
            showNotification('Please enter a note', 'error');
            return;
        }

        // Map dropdown values to database values
        const typeMap = {
            'shift_note': 'Shift Note',
            'behaviour': 'Behaviour',
            'health_medical': 'Health/Medical'
        };
        
        const noteType = typeMap[noteTypeValue] || 'Shift Note';

        // Update existing note
        const { error } = await supabaseClient
            .from('shift_notes')
            .update({
                participant_id: participantId,
                note_type: noteType,  // Now saves as "Shift Note" instead of "shift_note"
                note: htmlContent,
                updated_at: new Date().toISOString()
            })
            .eq('id', noteId);

        if (error) throw error;

        showNotification('Shift note updated successfully', 'success');
        closeModal('addShiftNoteModal');
        window.editingNoteId = null;
        
        if (currentView === 'notes') {
            await renderNotes(currentNotesPage);
        }

    } catch (error) {
        console.error('Error updating shift note:', error);
        showNotification('Failed to update shift note: ' + error.message, 'error');
    }
}

// ========================================
// INITIALIZATION
// ========================================

document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('=== MC MANAGER STARTING ===');
        
        const addShiftDate = document.getElementById('shiftDate');
if (addShiftDate) {
    addShiftDate.addEventListener('change', function() {
        updateModalScheduleCards('add');
    });
}

const editShiftDate = document.getElementById('editShiftDate');
if (editShiftDate) {
    editShiftDate.addEventListener('change', function() {
        updateModalScheduleCards('edit');
    });
}
        // Check if templates view exists
        if (!document.getElementById('templatesView')) {
            const mainContent = document.querySelector('.main-content') || document.body;
            if (typeof rosterTemplatesHTML !== 'undefined') {
                mainContent.insertAdjacentHTML('beforeend', rosterTemplatesHTML);
            }
        }
        
        // Initialize the app
        await initializeApp();
        
        // Add staff switcher for admins/managers after initialization
        if (currentUserRole === 'admin' || currentUserRole === 'manager') {
            setTimeout(() => {
                if (typeof addStaffSwitcher === 'function') {
                    addStaffSwitcher();
                }
            }, 100);
        }
        
        console.log('=== MC MANAGER READY ===');
    } catch (error) {
        console.error('Initialization failed:', error);
        showNotification('Initialization failed. Please refresh the page.', 'error');
    }
});

// Auth state monitoring
supabaseClient.auth.onAuthStateChange((event, session) => {
    console.log('Auth state change:', event);
    if (event === 'SIGNED_OUT') {
        window.location.href = 'index.html';
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Alt+S to open staff switcher
    if (e.altKey && e.key === 's') {
        e.preventDefault();
        const select = document.getElementById('staffViewSelect');
        if (select) select.focus();
    }
    
    // Escape to exit test mode
    if (e.key === 'Escape' && window.originalStaffData) {
        if (typeof resetToOriginalStaff === 'function') {
            resetToOriginalStaff();
        }
    }
});

// Debug helper
window.mcDebug = {
    shifts: () => shifts,
    filtered: () => filteredShifts,
    staff: () => staff,
    calculateHours: (shiftId) => {
        const shift = shifts.find(s => s.id === shiftId);
        return shift ? calculateShiftHours(shift) : null;
    },
    testCalculation: () => {
        if (shifts.length > 0) {
            const testShift = shifts[0];
            console.log('Test calculation for first shift:', {
                shift: testShift,
                calculatedHours: calculateShiftHours(testShift),
                calculatedPay: calculateShiftPay(testShift, calculateShiftHours(testShift))
            });
        }
    }
};
    </script>
</body>
</html>
